VERSION 5.00
Object = "{C0A63B80-4B21-11D3-BD95-D426EF2C7949}#1.0#0"; "Vsflex7L.ocx"
Object = "{6B7E6392-850A-101B-AFC0-4210102A8DA7}#1.3#0"; "COMCTL32.OCX"
Object = "{00025600-0000-0000-C000-000000000046}#5.2#0"; "Crystl32.OCX"
Object = "{BC496AED-9B4E-11CE-A6D5-0000C0BE9395}#2.0#0"; "SSDATB32.OCX"
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "tabctl32.ocx"
Object = "{0BA686C6-F7D3-101A-993E-0000C0EF6F5E}#1.0#0"; "threed32.ocx"
Object = "{648A5603-2C6E-101B-82B6-000000000014}#1.1#0"; "MSCOMM32.OCX"
Begin VB.Form frmPunto_Venta 
   Caption         =   "Emisión de Documentos - Mercadería"
   ClientHeight    =   10350
   ClientLeft      =   165
   ClientTop       =   510
   ClientWidth     =   15165
   ClipControls    =   0   'False
   BeginProperty Font 
      Name            =   "MS Sans Serif"
      Size            =   9.75
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmPunto_Venta.frx":0000
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   PaletteMode     =   1  'UseZOrder
   ScaleHeight     =   10350
   ScaleWidth      =   15165
   Begin TabDlg.SSTab sstSecciones_Lineas 
      Height          =   3255
      Left            =   120
      TabIndex        =   159
      Top             =   2400
      Width           =   14895
      _ExtentX        =   26273
      _ExtentY        =   5741
      _Version        =   393216
      TabOrientation  =   3
      Tabs            =   2
      TabsPerRow      =   2
      TabHeight       =   520
      ForeColor       =   255
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Reference Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      TabCaption(0)   =   "LINEAS"
      TabPicture(0)   =   "frmPunto_Venta.frx":058A
      Tab(0).ControlEnabled=   -1  'True
      Tab(0).Control(0)=   "vsfLineas_Mercaderia"
      Tab(0).Control(0).Enabled=   0   'False
      Tab(0).Control(1)=   "dbgLineas_Servicios"
      Tab(0).Control(1).Enabled=   0   'False
      Tab(0).ControlCount=   2
      TabCaption(1)   =   "SERIES"
      TabPicture(1)   =   "frmPunto_Venta.frx":05A6
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "txtTotal_Lineas"
      Tab(1).Control(1)=   "txtTotal_Lineas_Sin_Impuestos"
      Tab(1).Control(2)=   "vsfSeries_Articulos"
      Tab(1).ControlCount=   3
      Begin SSDataWidgets_B.SSDBGrid dbgLineas_Servicios 
         Height          =   3015
         Left            =   120
         TabIndex        =   162
         Top             =   120
         Width           =   14370
         _Version        =   131078
         DataMode        =   2
         BeginProperty HeadFont {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Col.Count       =   23
         stylesets.count =   1
         stylesets(0).Name=   "resaltar"
         stylesets(0).BackColor=   12632256
         stylesets(0).Picture=   "frmPunto_Venta.frx":05C2
         AllowAddNew     =   -1  'True
         AllowDelete     =   -1  'True
         MultiLine       =   0   'False
         AllowRowSizing  =   0   'False
         AllowGroupSizing=   0   'False
         AllowColumnSizing=   0   'False
         AllowGroupMoving=   0   'False
         AllowGroupSwapping=   0   'False
         AllowGroupShrinking=   0   'False
         AllowColumnShrinking=   0   'False
         AllowDragDrop   =   0   'False
         ForeColorEven   =   0
         BackColorOdd    =   16777215
         RowHeight       =   423
         Columns.Count   =   23
         Columns(0).Width=   1058
         Columns(0).Caption=   "Unid."
         Columns(0).Name =   "unidades"
         Columns(0).Alignment=   1
         Columns(0).DataField=   "Column 0"
         Columns(0).DataType=   5
         Columns(0).NumberFormat=   "0.00"
         Columns(0).FieldLen=   256
         Columns(1).Width=   1376
         Columns(1).Caption=   "Código"
         Columns(1).Name =   "codigo"
         Columns(1).Alignment=   1
         Columns(1).DataField=   "Column 1"
         Columns(1).DataType=   3
         Columns(1).FieldLen=   256
         Columns(2).Width=   10054
         Columns(2).Caption=   "Descripción"
         Columns(2).Name =   "descripcion"
         Columns(2).DataField=   "Column 2"
         Columns(2).DataType=   8
         Columns(2).FieldLen=   256
         Columns(3).Width=   1138
         Columns(3).Caption=   "Secc.*"
         Columns(3).Name =   "seccion"
         Columns(3).Alignment=   2
         Columns(3).DataField=   "Column 3"
         Columns(3).DataType=   3
         Columns(3).FieldLen=   256
         Columns(4).Width=   2302
         Columns(4).Caption=   "Descripción"
         Columns(4).Name =   "desc_seccion"
         Columns(4).DataField=   "Column 4"
         Columns(4).DataType=   8
         Columns(4).FieldLen=   256
         Columns(4).Locked=   -1  'True
         Columns(5).Width=   3200
         Columns(5).Visible=   0   'False
         Columns(5).Caption=   "T.Cofis*"
         Columns(5).Name =   "TCofis"
         Columns(5).DataField=   "Column 5"
         Columns(5).DataType=   2
         Columns(5).FieldLen=   256
         Columns(6).Width=   3200
         Columns(6).Visible=   0   'False
         Columns(6).Caption=   "%"
         Columns(6).Name =   "cofis"
         Columns(6).Alignment=   2
         Columns(6).DataField=   "Column 6"
         Columns(6).DataType=   5
         Columns(6).NumberFormat=   "0.00"
         Columns(6).FieldLen=   256
         Columns(6).Locked=   -1  'True
         Columns(7).Width=   1244
         Columns(7).Caption=   "T.IVA *"
         Columns(7).Name =   "TIva"
         Columns(7).Alignment=   2
         Columns(7).DataField=   "Column 7"
         Columns(7).DataType=   8
         Columns(7).FieldLen=   256
         Columns(8).Width=   900
         Columns(8).Caption=   "%"
         Columns(8).Name =   "iva"
         Columns(8).Alignment=   2
         Columns(8).DataField=   "Column 8"
         Columns(8).DataType=   5
         Columns(8).NumberFormat=   "0.00"
         Columns(8).FieldLen=   256
         Columns(8).Locked=   -1  'True
         Columns(9).Width=   1773
         Columns(9).Caption=   "Sin IVA"
         Columns(9).Name =   "precio_siva"
         Columns(9).Alignment=   1
         Columns(9).DataField=   "Column 9"
         Columns(9).DataType=   5
         Columns(9).NumberFormat=   "0.00"
         Columns(9).FieldLen=   256
         Columns(10).Width=   1773
         Columns(10).Caption=   "P.Unitario"
         Columns(10).Name=   "precio"
         Columns(10).Alignment=   1
         Columns(10).DataField=   "Column 10"
         Columns(10).DataType=   5
         Columns(10).NumberFormat=   "0.00"
         Columns(10).FieldLen=   256
         Columns(11).Width=   1217
         Columns(11).Caption=   "Tasa %"
         Columns(11).Name=   "tasa_resguardo"
         Columns(11).Alignment=   1
         Columns(11).DataField=   "Column 11"
         Columns(11).DataType=   5
         Columns(11).FieldLen=   256
         Columns(12).Width=   1773
         Columns(12).Caption=   "Importe"
         Columns(12).Name=   "importe"
         Columns(12).Alignment=   1
         Columns(12).DataField=   "Column 12"
         Columns(12).DataType=   5
         Columns(12).NumberFormat=   "0.00"
         Columns(12).FieldLen=   256
         Columns(12).Locked=   -1  'True
         Columns(12).HasBackColor=   -1  'True
         Columns(12).BackColor=   65535
         Columns(13).Width=   3200
         Columns(13).Visible=   0   'False
         Columns(13).Caption=   "importe_sin_iva"
         Columns(13).Name=   "importe_sin_iva"
         Columns(13).Alignment=   1
         Columns(13).DataField=   "Column 13"
         Columns(13).DataType=   5
         Columns(13).FieldLen=   256
         Columns(14).Width=   3200
         Columns(14).Visible=   0   'False
         Columns(14).Caption=   "importe_cofis"
         Columns(14).Name=   "importe_cofis"
         Columns(14).DataField=   "Column 14"
         Columns(14).DataType=   5
         Columns(14).FieldLen=   256
         Columns(15).Width=   3200
         Columns(15).Visible=   0   'False
         Columns(15).Caption=   "importe_iva"
         Columns(15).Name=   "importe_iva"
         Columns(15).DataField=   "Column 15"
         Columns(15).DataType=   5
         Columns(15).FieldLen=   256
         Columns(16).Width=   3200
         Columns(16).Visible=   0   'False
         Columns(16).Caption=   "TCofis_Iva"
         Columns(16).Name=   "TCofis_Iva"
         Columns(16).DataField=   "Column 16"
         Columns(16).DataType=   3
         Columns(16).FieldLen=   256
         Columns(17).Width=   3200
         Columns(17).Visible=   0   'False
         Columns(17).Caption=   "Cofis_Iva"
         Columns(17).Name=   "Cofis_Iva"
         Columns(17).DataField=   "Column 17"
         Columns(17).DataType=   5
         Columns(17).FieldLen=   256
         Columns(18).Width=   3200
         Columns(18).Visible=   0   'False
         Columns(18).Caption=   "Eliminada"
         Columns(18).Name=   "Eliminada"
         Columns(18).DataField=   "Column 18"
         Columns(18).DataType=   11
         Columns(18).FieldLen=   256
         Columns(19).Width=   1773
         Columns(19).Caption=   "Ficha"
         Columns(19).Name=   "Ficha_Viaje"
         Columns(19).Alignment=   1
         Columns(19).DataField=   "Column 19"
         Columns(19).DataType=   3
         Columns(19).NumberFormat=   "0"
         Columns(19).FieldLen=   256
         Columns(19).Locked=   -1  'True
         Columns(20).Width=   3200
         Columns(20).Visible=   0   'False
         Columns(20).Caption=   "Ficha_Viaje_Linea"
         Columns(20).Name=   "Ficha_Viaje_Linea"
         Columns(20).Alignment=   1
         Columns(20).DataField=   "Column 20"
         Columns(20).DataType=   3
         Columns(20).FieldLen=   256
         Columns(21).Width=   3200
         Columns(21).Visible=   0   'False
         Columns(21).Caption=   "Cod. Doc"
         Columns(21).Name=   "cod_doc"
         Columns(21).Alignment=   1
         Columns(21).DataField=   "Column 21"
         Columns(21).DataType=   3
         Columns(21).FieldLen=   256
         Columns(22).Width=   3200
         Columns(22).Visible=   0   'False
         Columns(22).Caption=   "Nro. Doc"
         Columns(22).Name=   "nro_doc"
         Columns(22).Alignment=   1
         Columns(22).DataField=   "Column 22"
         Columns(22).DataType=   3
         Columns(22).FieldLen=   256
         _ExtentX        =   25347
         _ExtentY        =   5318
         _StockProps     =   79
         Caption         =   "Lineas del Documento"
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.TextBox txtTotal_Lineas 
         BackColor       =   &H00E0E0E0&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   -74880
         TabIndex        =   161
         Top             =   360
         Visible         =   0   'False
         Width           =   150
      End
      Begin VB.TextBox txtTotal_Lineas_Sin_Impuestos 
         Alignment       =   2  'Center
         BackColor       =   &H00E0E0E0&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   -75000
         TabIndex        =   160
         Top             =   0
         Visible         =   0   'False
         Width           =   150
      End
      Begin VSFlex7LCtl.VSFlexGrid vsfLineas_Mercaderia 
         Height          =   3015
         Left            =   120
         TabIndex        =   163
         Top             =   120
         Width           =   14415
         _cx             =   25426
         _cy             =   5318
         _ConvInfo       =   1
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   12640511
         ForeColorSel    =   0
         BackColorBkg    =   -2147483636
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   2
         HighLight       =   2
         AllowSelection  =   -1  'True
         AllowBigSelection=   -1  'True
         AllowUserResizing=   0
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   2
         GridLineWidth   =   1
         Rows            =   50
         Cols            =   16
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   0
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmPunto_Venta.frx":05DE
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   -1  'True
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
      End
      Begin VSFlex7LCtl.VSFlexGrid vsfSeries_Articulos 
         Height          =   2775
         Left            =   -74640
         TabIndex        =   164
         Top             =   240
         Width           =   13935
         _cx             =   24580
         _cy             =   4895
         _ConvInfo       =   1
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16761024
         ForeColorSel    =   0
         BackColorBkg    =   -2147483636
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   2
         AllowSelection  =   -1  'True
         AllowBigSelection=   -1  'True
         AllowUserResizing=   0
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   2
         GridLineWidth   =   1
         Rows            =   50
         Cols            =   16
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   0
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmPunto_Venta.frx":0735
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   -1  'True
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
      End
   End
   Begin TabDlg.SSTab sstSecciones 
      Height          =   2415
      Left            =   120
      TabIndex        =   105
      Top             =   0
      Width           =   14895
      _ExtentX        =   26273
      _ExtentY        =   4260
      _Version        =   393216
      TabOrientation  =   3
      Tabs            =   2
      TabsPerRow      =   2
      TabHeight       =   520
      ForeColor       =   12582912
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Reference Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      TabCaption(0)   =   "GENERAL"
      TabPicture(0)   =   "frmPunto_Venta.frx":088C
      Tab(0).ControlEnabled=   -1  'True
      Tab(0).Control(0)=   "Label6"
      Tab(0).Control(0).Enabled=   0   'False
      Tab(0).Control(1)=   "LabelCliente"
      Tab(0).Control(1).Enabled=   0   'False
      Tab(0).Control(2)=   "Label2"
      Tab(0).Control(2).Enabled=   0   'False
      Tab(0).Control(3)=   "Label1"
      Tab(0).Control(3).Enabled=   0   'False
      Tab(0).Control(4)=   "Label13"
      Tab(0).Control(4).Enabled=   0   'False
      Tab(0).Control(5)=   "Label16"
      Tab(0).Control(5).Enabled=   0   'False
      Tab(0).Control(6)=   "LblRut"
      Tab(0).Control(6).Enabled=   0   'False
      Tab(0).Control(7)=   "Label7"
      Tab(0).Control(7).Enabled=   0   'False
      Tab(0).Control(8)=   "Label25"
      Tab(0).Control(8).Enabled=   0   'False
      Tab(0).Control(9)=   "Label20"
      Tab(0).Control(9).Enabled=   0   'False
      Tab(0).Control(10)=   "Label22"
      Tab(0).Control(10).Enabled=   0   'False
      Tab(0).Control(11)=   "Label3"
      Tab(0).Control(11).Enabled=   0   'False
      Tab(0).Control(12)=   "Label24"
      Tab(0).Control(12).Enabled=   0   'False
      Tab(0).Control(13)=   "Label17"
      Tab(0).Control(13).Enabled=   0   'False
      Tab(0).Control(14)=   "labSaldo_Credito_Moneda"
      Tab(0).Control(14).Enabled=   0   'False
      Tab(0).Control(15)=   "labTope_Credito_Moneda"
      Tab(0).Control(15).Enabled=   0   'False
      Tab(0).Control(16)=   "Label31"
      Tab(0).Control(16).Enabled=   0   'False
      Tab(0).Control(17)=   "Label30"
      Tab(0).Control(17).Enabled=   0   'False
      Tab(0).Control(18)=   "labSaldo_Credito"
      Tab(0).Control(18).Enabled=   0   'False
      Tab(0).Control(19)=   "labTope_Credito"
      Tab(0).Control(19).Enabled=   0   'False
      Tab(0).Control(20)=   "lbDisplay"
      Tab(0).Control(20).Enabled=   0   'False
      Tab(0).Control(21)=   "LblOC"
      Tab(0).Control(21).Enabled=   0   'False
      Tab(0).Control(22)=   "labCod_Doc_Tarea"
      Tab(0).Control(22).Enabled=   0   'False
      Tab(0).Control(23)=   "labNro_Doc_Tarea"
      Tab(0).Control(23).Enabled=   0   'False
      Tab(0).Control(24)=   "lblTC_Linea"
      Tab(0).Control(24).Enabled=   0   'False
      Tab(0).Control(25)=   "labAcopio"
      Tab(0).Control(25).Enabled=   0   'False
      Tab(0).Control(26)=   "lblObs"
      Tab(0).Control(26).Enabled=   0   'False
      Tab(0).Control(27)=   "labCIPAUT"
      Tab(0).Control(27).Enabled=   0   'False
      Tab(0).Control(28)=   "sspDatos_Contrato"
      Tab(0).Control(28).Enabled=   0   'False
      Tab(0).Control(29)=   "SSPContrato_Externo"
      Tab(0).Control(29).Enabled=   0   'False
      Tab(0).Control(30)=   "sspCantidad_Lineas"
      Tab(0).Control(30).Enabled=   0   'False
      Tab(0).Control(31)=   "txtTipo_Doc_Identidad"
      Tab(0).Control(31).Enabled=   0   'False
      Tab(0).Control(32)=   "txtFec_Doc"
      Tab(0).Control(32).Enabled=   0   'False
      Tab(0).Control(33)=   "txtDoc"
      Tab(0).Control(33).Enabled=   0   'False
      Tab(0).Control(34)=   "txtCodDoc"
      Tab(0).Control(34).Enabled=   0   'False
      Tab(0).Control(35)=   "txtCodProv"
      Tab(0).Control(35).Enabled=   0   'False
      Tab(0).Control(36)=   "txtNomCli"
      Tab(0).Control(36).Enabled=   0   'False
      Tab(0).Control(37)=   "txtDes_Moneda"
      Tab(0).Control(37).Enabled=   0   'False
      Tab(0).Control(38)=   "txtMoneda"
      Tab(0).Control(38).Enabled=   0   'False
      Tab(0).Control(39)=   "txtTipo_Cambio"
      Tab(0).Control(39).Enabled=   0   'False
      Tab(0).Control(40)=   "TxtRuc"
      Tab(0).Control(40).Enabled=   0   'False
      Tab(0).Control(41)=   "txtDtoGlobal"
      Tab(0).Control(41).Enabled=   0   'False
      Tab(0).Control(42)=   "txtNomDoc_Mostrar"
      Tab(0).Control(42).Enabled=   0   'False
      Tab(0).Control(43)=   "txtEmpresa"
      Tab(0).Control(43).Enabled=   0   'False
      Tab(0).Control(44)=   "txtNom_Empresa"
      Tab(0).Control(44).Enabled=   0   'False
      Tab(0).Control(45)=   "TxtNomSuc"
      Tab(0).Control(45).Enabled=   0   'False
      Tab(0).Control(46)=   "txtNombre_Lista"
      Tab(0).Control(46).Enabled=   0   'False
      Tab(0).Control(47)=   "txtLista"
      Tab(0).Control(47).Enabled=   0   'False
      Tab(0).Control(48)=   "TxtCFinal"
      Tab(0).Control(48).Enabled=   0   'False
      Tab(0).Control(49)=   "txtCta_Madre"
      Tab(0).Control(49).Enabled=   0   'False
      Tab(0).Control(50)=   "txtDeposito"
      Tab(0).Control(50).Enabled=   0   'False
      Tab(0).Control(51)=   "txtDoc_Afectado"
      Tab(0).Control(51).Enabled=   0   'False
      Tab(0).Control(52)=   "txtNro_Doc_Afectado"
      Tab(0).Control(52).Enabled=   0   'False
      Tab(0).Control(53)=   "txtSerie_Contingencia"
      Tab(0).Control(53).Enabled=   0   'False
      Tab(0).Control(54)=   "TxtCodSuc"
      Tab(0).Control(54).Enabled=   0   'False
      Tab(0).Control(55)=   "FrameExportacion"
      Tab(0).Control(55).Enabled=   0   'False
      Tab(0).Control(56)=   "txtAutorizacion_Contingencia"
      Tab(0).Control(56).Enabled=   0   'False
      Tab(0).Control(57)=   "TxtTCofis"
      Tab(0).Control(57).Enabled=   0   'False
      Tab(0).Control(58)=   "FrameVendedorGuia"
      Tab(0).Control(58).Enabled=   0   'False
      Tab(0).Control(59)=   "txtSeccion"
      Tab(0).Control(59).Enabled=   0   'False
      Tab(0).Control(60)=   "PDF"
      Tab(0).Control(60).Enabled=   0   'False
      Tab(0).Control(61)=   "TxtNroIdCompra"
      Tab(0).Control(61).Enabled=   0   'False
      Tab(0).Control(62)=   "txtTarea_Numero"
      Tab(0).Control(62).Enabled=   0   'False
      Tab(0).Control(63)=   "txtTarea_Codigo_Documento"
      Tab(0).Control(63).Enabled=   0   'False
      Tab(0).Control(64)=   "sspDatos_Mercaderia"
      Tab(0).Control(64).Enabled=   0   'False
      Tab(0).Control(65)=   "txtAcopio"
      Tab(0).Control(65).Enabled=   0   'False
      Tab(0).Control(66)=   "txtDescripcion_Acopio"
      Tab(0).Control(66).Enabled=   0   'False
      Tab(0).Control(67)=   "txtObs"
      Tab(0).Control(67).Enabled=   0   'False
      Tab(0).Control(68)=   "sscObservacion_Extra"
      Tab(0).Control(68).Enabled=   0   'False
      Tab(0).Control(69)=   "txtCI_Persona_Autorizada"
      Tab(0).Control(69).Enabled=   0   'False
      Tab(0).ControlCount=   70
      TabCaption(1)   =   "D.CL"
      TabPicture(1)   =   "frmPunto_Venta.frx":08A8
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "txtCategoria_Descripcion"
      Tab(1).Control(1)=   "TxtComentario"
      Tab(1).Control(2)=   "vsfPersonas_Autorizadas"
      Tab(1).Control(3)=   "SSverFirmaDigitalizada"
      Tab(1).Control(4)=   "Label8"
      Tab(1).Control(5)=   "Label33"
      Tab(1).Control(6)=   "Label32"
      Tab(1).ControlCount=   7
      Begin VB.TextBox txtCI_Persona_Autorizada 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5350
         TabIndex        =   25
         Tag             =   "V"
         Top             =   1200
         Width           =   1030
      End
      Begin Threed.SSCommand sscObservacion_Extra 
         Height          =   285
         Left            =   5880
         TabIndex        =   37
         Top             =   1560
         Width           =   480
         _Version        =   65536
         _ExtentX        =   847
         _ExtentY        =   503
         _StockProps     =   78
         ForeColor       =   255
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   13.5
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         AutoSize        =   1
         Picture         =   "frmPunto_Venta.frx":08C4
      End
      Begin VB.TextBox txtObs 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   1080
         MaxLength       =   100
         TabIndex        =   36
         Tag             =   "V"
         Top             =   1560
         Width           =   4695
      End
      Begin VB.TextBox txtDescripcion_Acopio 
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   315
         Left            =   2160
         TabIndex        =   24
         Tag             =   "V"
         Top             =   1200
         Width           =   2415
      End
      Begin VB.TextBox txtAcopio 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   1080
         TabIndex        =   23
         Top             =   1200
         Width           =   975
      End
      Begin Threed.SSPanel sspDatos_Mercaderia 
         Height          =   495
         Left            =   120
         TabIndex        =   141
         Top             =   1800
         Width           =   6375
         _Version        =   65536
         _ExtentX        =   11245
         _ExtentY        =   873
         _StockProps     =   15
         ForeColor       =   65535
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   0
         Begin VB.CheckBox Chk_del_Cliente 
            Caption         =   "Articulos Cliente"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   120
            TabIndex        =   145
            Top             =   0
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.TextBox txtTotal_Unidades 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   285
            Left            =   240
            TabIndex        =   167
            Tag             =   "V"
            Top             =   120
            Visible         =   0   'False
            Width           =   1185
         End
         Begin VB.TextBox txtCajas 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   960
            MaxLength       =   7
            TabIndex        =   41
            Tag             =   "V"
            Top             =   120
            Visible         =   0   'False
            Width           =   470
         End
         Begin VB.TextBox TxtFactor 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   285
            Left            =   4965
            MaxLength       =   9
            TabIndex        =   42
            Tag             =   "V"
            Top             =   120
            Width           =   1260
         End
         Begin VB.TextBox TxtLector 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H000000FF&
            Height          =   285
            Left            =   2280
            TabIndex        =   43
            Tag             =   "V"
            Top             =   120
            Width           =   1800
         End
         Begin VB.Label labCajas 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Cajas"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   480
            TabIndex        =   144
            Top             =   240
            Visible         =   0   'False
            Width           =   495
         End
         Begin VB.Label labCodigo 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Codigo *"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   1545
            TabIndex        =   143
            Top             =   120
            Width           =   615
         End
         Begin VB.Label labUnidades 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Unidades"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   4200
            TabIndex        =   142
            Top             =   120
            Width           =   735
         End
      End
      Begin VB.TextBox txtTarea_Codigo_Documento 
         Alignment       =   2  'Center
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   9390
         TabIndex        =   26
         Tag             =   "V"
         Top             =   1140
         Width           =   870
      End
      Begin VB.TextBox txtTarea_Numero 
         Alignment       =   2  'Center
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11160
         TabIndex        =   27
         Tag             =   "V"
         Top             =   1140
         Width           =   990
      End
      Begin VB.TextBox TxtNroIdCompra 
         Alignment       =   2  'Center
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   12840
         TabIndex        =   22
         Tag             =   "V"
         Top             =   840
         Width           =   1710
      End
      Begin Threed.SSCommand PDF 
         Height          =   525
         Left            =   11280
         TabIndex        =   150
         ToolTipText     =   "Ver PDF"
         Top             =   1770
         Visible         =   0   'False
         Width           =   720
         _Version        =   65536
         _ExtentX        =   1270
         _ExtentY        =   926
         _StockProps     =   78
         ForeColor       =   255
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   13.5
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         AutoSize        =   1
         Picture         =   "frmPunto_Venta.frx":0BDE
      End
      Begin VB.TextBox txtCategoria_Descripcion 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   360
         Left            =   -73080
         Locked          =   -1  'True
         TabIndex        =   136
         Tag             =   "V"
         Top             =   120
         Width           =   5295
      End
      Begin VB.TextBox TxtComentario 
         BackColor       =   &H00FFFFFF&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   1440
         Left            =   -74760
         Locked          =   -1  'True
         MultiLine       =   -1  'True
         TabIndex        =   132
         Tag             =   "V"
         Top             =   480
         Width           =   6975
      End
      Begin VB.TextBox txtSeccion 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   840
         TabIndex        =   131
         Tag             =   "V"
         Top             =   840
         Visible         =   0   'False
         Width           =   150
      End
      Begin VB.Frame FrameVendedorGuia 
         BorderStyle     =   0  'None
         Caption         =   "Frame3"
         Height          =   255
         Left            =   6480
         TabIndex        =   127
         Top             =   1440
         Width           =   8055
         Begin VB.TextBox TxtVendedor 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   720
            TabIndex        =   38
            Top             =   0
            Width           =   795
         End
         Begin VB.TextBox TxtGuia 
            Alignment       =   2  'Center
            BackColor       =   &H00FFFFFF&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   4680
            TabIndex        =   40
            Tag             =   "V"
            Top             =   0
            Width           =   975
         End
         Begin VB.TextBox TxtNomVen 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   1560
            Locked          =   -1  'True
            TabIndex        =   39
            Top             =   0
            Width           =   2250
         End
         Begin VB.TextBox txtDoc_Remito 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   6360
            TabIndex        =   30
            Tag             =   "V"
            Top             =   0
            Width           =   495
         End
         Begin VB.TextBox txtRemito 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   6840
            TabIndex        =   31
            Tag             =   "V"
            Top             =   0
            Width           =   1215
         End
         Begin VB.Label labGuia 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Guía"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   3840
            TabIndex        =   130
            Top             =   0
            Width           =   735
         End
         Begin VB.Label Label19 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Vend. *"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   0
            TabIndex        =   129
            Top             =   0
            Width           =   615
         End
         Begin VB.Label Label27 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "P/R *"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   5760
            TabIndex        =   128
            Top             =   0
            Width           =   495
         End
      End
      Begin VB.TextBox TxtTCofis 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   12420
         MaxLength       =   1
         TabIndex        =   126
         Top             =   120
         Visible         =   0   'False
         Width           =   150
      End
      Begin VB.TextBox txtAutorizacion_Contingencia 
         Height          =   360
         Left            =   12220
         TabIndex        =   125
         Tag             =   "V"
         Top             =   120
         Visible         =   0   'False
         Width           =   210
      End
      Begin VB.Frame FrameExportacion 
         BorderStyle     =   0  'None
         Caption         =   "Frame3"
         Height          =   255
         Left            =   6480
         TabIndex        =   121
         Top             =   1440
         Width           =   8055
         Begin SSDataWidgets_B.SSDBCombo txtClauVta 
            Height          =   315
            Left            =   720
            TabIndex        =   44
            Top             =   0
            Width           =   1335
            DataFieldList   =   "Column 0"
            AllowInput      =   0   'False
            _Version        =   131078
            DataMode        =   2
            Row.Count       =   5
            Row(0)          =   "FOB"
            Row(1)          =   "CIF"
            Row(2)          =   "FCA"
            Row(3)          =   "CFR"
            Row(4)          =   "N/A"
            BevelColorShadow=   8421504
            BevelColorFace  =   12632256
            ForeColorEven   =   0
            BackColorOdd    =   16777215
            RowHeight       =   609
            Columns(0).Width=   7064
            Columns(0).Name =   "SiNo"
            Columns(0).DataField=   "Column 0"
            Columns(0).DataType=   8
            Columns(0).FieldLen=   256
            _ExtentX        =   2355
            _ExtentY        =   556
            _StockProps     =   93
            ForeColor       =   -2147483640
            BackColor       =   -2147483643
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
         Begin SSDataWidgets_B.SSDBCombo txtViaTransporte 
            Height          =   315
            Left            =   3600
            TabIndex        =   45
            Top             =   0
            Width           =   2055
            DataFieldList   =   "Column 0"
            AllowInput      =   0   'False
            _Version        =   131078
            DataMode        =   2
            Row.Count       =   5
            Row(0)          =   "1 - MARITIMO"
            Row(1)          =   "2 - AEREO"
            Row(2)          =   "3 - TERRESTRE"
            Row(3)          =   "8 - N/A"
            Row(4)          =   "9 - OTRO"
            BevelColorShadow=   8421504
            BevelColorFace  =   12632256
            ForeColorEven   =   0
            BackColorOdd    =   16777215
            RowHeight       =   609
            Columns(0).Width=   7064
            Columns(0).Name =   "SiNo"
            Columns(0).DataField=   "Column 0"
            Columns(0).DataType=   8
            Columns(0).FieldLen=   256
            _ExtentX        =   3625
            _ExtentY        =   556
            _StockProps     =   93
            ForeColor       =   -2147483640
            BackColor       =   -2147483643
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
         Begin SSDataWidgets_B.SSDBCombo txtPais 
            Height          =   315
            Left            =   6120
            TabIndex        =   46
            Top             =   0
            Width           =   1935
            DataFieldList   =   "Column 0"
            AllowInput      =   0   'False
            _Version        =   131078
            DataMode        =   2
            BevelColorShadow=   8421504
            BevelColorFace  =   12632256
            ForeColorEven   =   0
            BackColorOdd    =   16777215
            RowHeight       =   609
            Columns(0).Width=   7064
            Columns(0).Name =   "nombre"
            Columns(0).DataField=   "Column 0"
            Columns(0).DataType=   8
            Columns(0).FieldLen=   256
            _ExtentX        =   3413
            _ExtentY        =   556
            _StockProps     =   93
            ForeColor       =   -2147483640
            BackColor       =   -2147483643
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
         Begin VB.Label Label14 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Clau. Vta."
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   0
            TabIndex        =   124
            Top             =   0
            Width           =   735
         End
         Begin VB.Label Label18 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Via Transporte"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   2280
            TabIndex        =   123
            Top             =   0
            Width           =   1095
         End
         Begin VB.Label Label23 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Pais"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   5760
            TabIndex        =   122
            Top             =   0
            Width           =   375
         End
      End
      Begin VB.TextBox TxtCodSuc 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11160
         TabIndex        =   13
         Top             =   480
         Width           =   990
      End
      Begin VB.TextBox txtSerie_Contingencia 
         Height          =   360
         Left            =   9360
         TabIndex        =   5
         Tag             =   "V"
         Top             =   120
         Visible         =   0   'False
         Width           =   250
      End
      Begin VB.TextBox txtNro_Doc_Afectado 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   13320
         Locked          =   -1  'True
         TabIndex        =   29
         Tag             =   "V"
         Top             =   1140
         Width           =   1215
      End
      Begin VB.TextBox txtDoc_Afectado 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   12840
         Locked          =   -1  'True
         TabIndex        =   28
         Tag             =   "V"
         Top             =   1140
         Width           =   495
      End
      Begin VB.TextBox txtDeposito 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   13370
         MaxLength       =   10
         TabIndex        =   7
         Top             =   120
         Width           =   1170
      End
      Begin VB.TextBox txtCta_Madre 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5350
         Locked          =   -1  'True
         TabIndex        =   17
         Top             =   840
         Width           =   1030
      End
      Begin VB.TextBox TxtCFinal 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   9870
         MaxLength       =   1
         TabIndex        =   12
         Tag             =   "V"
         Top             =   480
         Width           =   375
      End
      Begin VB.TextBox txtLista 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   1080
         TabIndex        =   15
         Top             =   840
         Width           =   975
      End
      Begin VB.TextBox txtNombre_Lista 
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   315
         Left            =   2160
         TabIndex        =   16
         Top             =   840
         Width           =   2415
      End
      Begin VB.TextBox TxtNomSuc 
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   315
         Left            =   12240
         Locked          =   -1  'True
         TabIndex        =   14
         Tag             =   "V"
         Top             =   480
         Width           =   2295
      End
      Begin VB.TextBox txtNom_Empresa 
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   2160
         Locked          =   -1  'True
         TabIndex        =   1
         Top             =   120
         Width           =   2415
      End
      Begin VB.TextBox txtEmpresa 
         Alignment       =   2  'Center
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   1080
         TabIndex        =   0
         Top             =   120
         Width           =   975
      End
      Begin VB.TextBox txtNomDoc_Mostrar 
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   7995
         TabIndex        =   4
         Top             =   120
         Width           =   2250
      End
      Begin VB.TextBox txtDtoGlobal 
         Alignment       =   2  'Center
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11160
         TabIndex        =   21
         Top             =   840
         Width           =   990
      End
      Begin VB.TextBox TxtRuc 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   7995
         TabIndex        =   11
         Tag             =   "V"
         Top             =   480
         Width           =   1815
      End
      Begin VB.TextBox txtTipo_Cambio 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFFF&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   9390
         TabIndex        =   20
         Top             =   840
         Width           =   870
      End
      Begin VB.TextBox txtMoneda 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   7200
         TabIndex        =   18
         Top             =   840
         Width           =   795
      End
      Begin VB.TextBox txtDes_Moneda 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   315
         Left            =   7995
         Locked          =   -1  'True
         TabIndex        =   19
         Top             =   840
         Width           =   495
      End
      Begin VB.TextBox txtNomCli 
         BackColor       =   &H00FFFFFF&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00FF0000&
         Height          =   315
         Left            =   2160
         MaxLength       =   100
         TabIndex        =   9
         Top             =   480
         Width           =   4215
      End
      Begin VB.TextBox txtCodProv 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   1080
         TabIndex        =   8
         Top             =   480
         Width           =   975
      End
      Begin VB.TextBox txtCodDoc 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   7200
         TabIndex        =   3
         Top             =   120
         Width           =   795
      End
      Begin VB.TextBox txtDoc 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   11160
         MaxLength       =   9
         TabIndex        =   6
         Top             =   120
         Width           =   990
      End
      Begin VB.TextBox txtFec_Doc 
         Alignment       =   2  'Center
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   5350
         TabIndex        =   2
         Text            =   "12/12/2023"
         Top             =   120
         Width           =   1040
      End
      Begin SSDataWidgets_B.SSDBCombo txtTipo_Doc_Identidad 
         Height          =   315
         Left            =   7200
         TabIndex        =   10
         Top             =   480
         Width           =   795
         DataFieldList   =   "Column 0"
         AllowInput      =   0   'False
         _Version        =   131078
         DataMode        =   2
         Row.Count       =   8
         Col.Count       =   2
         Row(0).Col(0)   =   "2"
         Row(0).Col(1)   =   "RUT"
         Row(1).Col(0)   =   "3"
         Row(1).Col(1)   =   "C.I. Uruguaya"
         Row(2).Col(0)   =   "4"
         Row(2).Col(1)   =   "Otros"
         Row(3).Col(0)   =   "5"
         Row(3).Col(1)   =   "Pasaporte"
         Row(4).Col(0)   =   "6"
         Row(4).Col(1)   =   "AR - DNI"
         Row(5).Col(0)   =   "6"
         Row(5).Col(1)   =   "BR - DNI"
         Row(6).Col(0)   =   "6"
         Row(6).Col(1)   =   "CL - DNI"
         Row(7).Col(0)   =   "6"
         Row(7).Col(1)   =   "PY - DNI"
         BevelColorShadow=   8421504
         BevelColorFace  =   12632256
         ForeColorEven   =   0
         BackColorOdd    =   16777215
         RowHeight       =   423
         ExtraHeight     =   185
         Columns.Count   =   2
         Columns(0).Width=   1773
         Columns(0).Caption=   "Código"
         Columns(0).Name =   "codigo"
         Columns(0).Alignment=   1
         Columns(0).DataField=   "Column 0"
         Columns(0).DataType=   2
         Columns(0).FieldLen=   256
         Columns(1).Width=   5292
         Columns(1).Caption=   "Descripción"
         Columns(1).Name =   "Descripción"
         Columns(1).DataField=   "Column 1"
         Columns(1).DataType=   8
         Columns(1).FieldLen=   256
         _ExtentX        =   1402
         _ExtentY        =   556
         _StockProps     =   93
         ForeColor       =   0
         BackColor       =   -2147483643
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VSFlex7LCtl.VSFlexGrid vsfPersonas_Autorizadas 
         Height          =   1575
         Left            =   -67560
         TabIndex        =   133
         Top             =   360
         Width           =   6855
         _cx             =   12091
         _cy             =   2778
         _ConvInfo       =   1
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   -2147483635
         ForeColorSel    =   -2147483634
         BackColorBkg    =   -2147483636
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483633
         GridColorFixed  =   -2147483632
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483642
         FocusRect       =   1
         HighLight       =   2
         AllowSelection  =   -1  'True
         AllowBigSelection=   -1  'True
         AllowUserResizing=   0
         SelectionMode   =   0
         GridLines       =   1
         GridLinesFixed  =   2
         GridLineWidth   =   1
         Rows            =   50
         Cols            =   16
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   0
         RowHeightMax    =   0
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   ""
         ScrollTrack     =   0   'False
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   -1  'True
         AutoSizeMode    =   0
         AutoSearch      =   1
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   5
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   0
         Editable        =   0
         ShowComboButton =   -1  'True
         WordWrap        =   0   'False
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
      End
      Begin Threed.SSPanel sspCantidad_Lineas 
         Height          =   525
         Left            =   6480
         TabIndex        =   137
         Top             =   1770
         Width           =   735
         _Version        =   65536
         _ExtentX        =   1296
         _ExtentY        =   926
         _StockProps     =   15
         Caption         =   "0"
         ForeColor       =   255
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   12
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   0
         BevelInner      =   1
      End
      Begin Threed.SSCommand SSverFirmaDigitalizada 
         Height          =   285
         Left            =   -73080
         TabIndex        =   165
         Top             =   2040
         Width           =   600
         _Version        =   65536
         _ExtentX        =   1058
         _ExtentY        =   503
         _StockProps     =   78
         ForeColor       =   255
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   13.5
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         AutoSize        =   1
         Picture         =   "frmPunto_Venta.frx":11440
      End
      Begin Threed.SSPanel SSPContrato_Externo 
         Height          =   480
         Left            =   120
         TabIndex        =   151
         Top             =   1800
         Width           =   6135
         _Version        =   65536
         _ExtentX        =   10821
         _ExtentY        =   847
         _StockProps     =   15
         ForeColor       =   65535
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   0
         Alignment       =   1
         Begin VB.TextBox TxtContrato_Externo 
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   1080
            TabIndex        =   153
            Tag             =   "V"
            Top             =   120
            Width           =   4560
         End
         Begin VB.Label Label4 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Contrato Ext. *"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   375
            Left            =   0
            TabIndex        =   152
            Top             =   120
            Width           =   1215
         End
      End
      Begin Threed.SSPanel sspDatos_Contrato 
         Height          =   375
         Left            =   120
         TabIndex        =   146
         Top             =   1800
         Width           =   6375
         _Version        =   65536
         _ExtentX        =   11245
         _ExtentY        =   661
         _StockProps     =   15
         ForeColor       =   65535
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   9.74
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   0
         Begin VB.TextBox txtContrato 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   960
            TabIndex        =   148
            Tag             =   "V"
            Top             =   120
            Width           =   975
         End
         Begin VB.TextBox txtDescripcion_Contrato 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   2040
            TabIndex        =   147
            Tag             =   "V"
            Top             =   120
            Width           =   4215
         End
         Begin VB.Label Label28 
            BackColor       =   &H00E0E0E0&
            BackStyle       =   0  'Transparent
            Caption         =   "Contrato *"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   0
            TabIndex        =   149
            Top             =   120
            Width           =   735
         End
      End
      Begin VB.Label labCIPAUT 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "CI.P.Aut."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   4680
         TabIndex        =   171
         Top             =   1200
         Width           =   615
      End
      Begin VB.Label lblObs 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Observación"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   110
         Top             =   1560
         Width           =   975
      End
      Begin VB.Label labAcopio 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Acopio *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   170
         Top             =   1200
         Width           =   975
      End
      Begin VB.Label lblTC_Linea 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "T.C."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   6480
         TabIndex        =   168
         Top             =   1200
         Width           =   1935
      End
      Begin VB.Label Label8 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Firma Digitalizada"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   -74760
         TabIndex        =   166
         Top             =   2040
         Width           =   1575
      End
      Begin VB.Label labNro_Doc_Tarea 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Nro.Tarea"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   10320
         TabIndex        =   156
         Top             =   1140
         Width           =   735
      End
      Begin VB.Label labCod_Doc_Tarea 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Cod.Tarea"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   8520
         TabIndex        =   155
         Top             =   1140
         Width           =   855
      End
      Begin VB.Label LblOC 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "O.C."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   12240
         TabIndex        =   154
         Top             =   850
         Width           =   615
      End
      Begin VB.Label lbDisplay 
         Alignment       =   2  'Center
         BackColor       =   &H00808080&
         BorderStyle     =   1  'Fixed Single
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H0000FFFF&
         Height          =   525
         Left            =   7200
         TabIndex        =   140
         Top             =   1800
         Width           =   4815
         WordWrap        =   -1  'True
      End
      Begin VB.Label labTope_Credito 
         Alignment       =   1  'Right Justify
         BackColor       =   &H00FFFFFF&
         BorderStyle     =   1  'Fixed Single
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   285
         Left            =   13320
         TabIndex        =   33
         Top             =   1740
         Width           =   1215
         WordWrap        =   -1  'True
      End
      Begin VB.Label labSaldo_Credito 
         Alignment       =   1  'Right Justify
         BackColor       =   &H00FFFFFF&
         BorderStyle     =   1  'Fixed Single
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   285
         Left            =   13320
         TabIndex        =   35
         Top             =   2040
         Width           =   1215
         WordWrap        =   -1  'True
      End
      Begin VB.Label Label30 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "T.Crédito"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   12120
         TabIndex        =   139
         Top             =   1755
         Width           =   735
      End
      Begin VB.Label Label31 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "S.Crédito"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   12120
         TabIndex        =   138
         Top             =   2040
         Width           =   735
      End
      Begin VB.Label labTope_Credito_Moneda 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFFF&
         BorderStyle     =   1  'Fixed Single
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   285
         Left            =   12840
         TabIndex        =   32
         Top             =   1740
         Width           =   495
         WordWrap        =   -1  'True
      End
      Begin VB.Label labSaldo_Credito_Moneda 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFFF&
         BorderStyle     =   1  'Fixed Single
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   285
         Left            =   12840
         TabIndex        =   34
         Top             =   2040
         Width           =   495
         WordWrap        =   -1  'True
      End
      Begin VB.Label Label33 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Categoría Crédito"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   -74760
         TabIndex        =   135
         Top             =   120
         Width           =   1575
      End
      Begin VB.Label Label32 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Personas Autorizadas a Utilizar la Cuenta del Cliente"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   375
         Left            =   -67560
         TabIndex        =   134
         Top             =   120
         Width           =   5655
      End
      Begin VB.Label Label17 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "D/Af.*"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   12240
         TabIndex        =   120
         Top             =   1140
         Width           =   495
      End
      Begin VB.Label Label24 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Deposito*"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   12600
         TabIndex        =   119
         Top             =   120
         Width           =   735
      End
      Begin VB.Label Label3 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "C.Madre"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   4680
         TabIndex        =   118
         Top             =   840
         Width           =   615
      End
      Begin VB.Label Label22 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Lista *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   117
         Top             =   840
         Width           =   735
      End
      Begin VB.Label Label20 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Sucursal *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   10320
         TabIndex        =   116
         Top             =   480
         Width           =   735
      End
      Begin VB.Label Label25 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Empresa *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   115
         Top             =   120
         Width           =   975
      End
      Begin VB.Label Label7 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "% Dto.Glob"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   10320
         TabIndex        =   114
         Top             =   840
         Width           =   1095
      End
      Begin VB.Label LblRut 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "RUT/CI"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   6480
         TabIndex        =   113
         Top             =   480
         Width           =   855
      End
      Begin VB.Label Label16 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Mon. *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   6480
         TabIndex        =   112
         Top             =   840
         Width           =   615
      End
      Begin VB.Label Label13 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "T.Cambio"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   8520
         TabIndex        =   111
         Top             =   840
         Width           =   855
      End
      Begin VB.Label Label1 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "T.Doc.*"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   6480
         TabIndex        =   109
         Top             =   120
         Width           =   735
      End
      Begin VB.Label Label2 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Número *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   10320
         TabIndex        =   108
         Top             =   120
         Width           =   855
      End
      Begin VB.Label LabelCliente 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Cliente *"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   120
         TabIndex        =   107
         Top             =   480
         Width           =   975
      End
      Begin VB.Label Label6 
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Fecha"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   4680
         TabIndex        =   106
         Top             =   120
         Width           =   615
      End
   End
   Begin TabDlg.SSTab sstDetalle_Pagos 
      Height          =   2925
      Left            =   120
      TabIndex        =   63
      Top             =   5760
      Width           =   14925
      _ExtentX        =   26326
      _ExtentY        =   5159
      _Version        =   393216
      TabOrientation  =   3
      Tabs            =   2
      TabsPerRow      =   2
      TabHeight       =   520
      ForeColor       =   32768
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Arial"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      TabCaption(0)   =   "M.PAGOS"
      TabPicture(0)   =   "frmPunto_Venta.frx":1175A
      Tab(0).ControlEnabled=   -1  'True
      Tab(0).Control(0)=   "Label10"
      Tab(0).Control(0).Enabled=   0   'False
      Tab(0).Control(1)=   "fraEquivalencias_Stock"
      Tab(0).Control(1).Enabled=   0   'False
      Tab(0).Control(2)=   "cmdGuardar"
      Tab(0).Control(2).Enabled=   0   'False
      Tab(0).Control(3)=   "frameVencimientos_Cuotas"
      Tab(0).Control(3).Enabled=   0   'False
      Tab(0).Control(4)=   "Imagen_Producto"
      Tab(0).Control(4).Enabled=   0   'False
      Tab(0).Control(5)=   "Frame1"
      Tab(0).Control(5).Enabled=   0   'False
      Tab(0).Control(6)=   "frameIvas"
      Tab(0).Control(6).Enabled=   0   'False
      Tab(0).Control(7)=   "Frame2"
      Tab(0).Control(7).Enabled=   0   'False
      Tab(0).Control(8)=   "frameMedios_Pagos"
      Tab(0).Control(8).Enabled=   0   'False
      Tab(0).Control(9)=   "TxtSimbolo_SubTotal"
      Tab(0).Control(9).Enabled=   0   'False
      Tab(0).Control(10)=   "txtTotal_Calculado"
      Tab(0).Control(10).Enabled=   0   'False
      Tab(0).Control(11)=   "frameTot"
      Tab(0).Control(11).Enabled=   0   'False
      Tab(0).Control(12)=   "fraDescuento_x_Volumen"
      Tab(0).Control(12).Enabled=   0   'False
      Tab(0).ControlCount=   13
      TabCaption(1)   =   "TARJ/CHEQ/VAL"
      TabPicture(1)   =   "frmPunto_Venta.frx":11776
      Tab(1).ControlEnabled=   0   'False
      Tab(1).Control(0)=   "Frame5"
      Tab(1).Control(1)=   "Frame4"
      Tab(1).Control(2)=   "Frame3"
      Tab(1).ControlCount=   3
      Begin VB.Frame Frame5 
         Caption         =   "Detalle de Vales"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   1335
         Left            =   -67680
         TabIndex        =   157
         Top             =   1440
         Width           =   7095
         Begin VSFlex7LCtl.VSFlexGrid vsfVales 
            Height          =   975
            Left            =   120
            TabIndex        =   158
            Top             =   240
            Width           =   6855
            _cx             =   12091
            _cy             =   1720
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11792
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   5
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Frame fraDescuento_x_Volumen 
         Caption         =   "Descuento x Volumen"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   1935
         Left            =   3480
         TabIndex        =   72
         Top             =   840
         Visible         =   0   'False
         Width           =   3255
         Begin VSFlex7LCtl.VSFlexGrid vsfDescuentos_x_Volumen 
            Height          =   1575
            Left            =   120
            TabIndex        =   73
            Top             =   240
            Width           =   3015
            _cx             =   5318
            _cy             =   2778
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":118E9
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   5
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Frame Frame4 
         Caption         =   "Detalle de Cheques"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   2655
         Left            =   -74880
         TabIndex        =   103
         Top             =   120
         Width           =   7095
         Begin VSFlex7LCtl.VSFlexGrid vsfCheques 
            Height          =   2175
            Left            =   120
            TabIndex        =   104
            Top             =   240
            Width           =   6855
            _cx             =   12091
            _cy             =   3836
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   2
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   1
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11A40
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Frame Frame3 
         Caption         =   "Detalle de Tarjetas de Crédito"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   1335
         Left            =   -67680
         TabIndex        =   101
         Top             =   120
         Width           =   7095
         Begin VSFlex7LCtl.VSFlexGrid vsfTarjetas_Credito 
            Height          =   975
            Left            =   120
            TabIndex        =   102
            Top             =   240
            Width           =   6855
            _cx             =   12091
            _cy             =   1720
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11B97
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   5
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Frame frameTot 
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   1695
         Left            =   11895
         TabIndex        =   89
         Top             =   600
         Width           =   2490
         Begin VB.TextBox txtRedondeo 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   1200
            Locked          =   -1  'True
            MaxLength       =   10
            TabIndex        =   94
            Top             =   840
            Width           =   1185
         End
         Begin VB.TextBox txtImporte 
            Alignment       =   2  'Center
            BackColor       =   &H000000FF&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   12
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H0000FFFF&
            Height          =   435
            Left            =   720
            MaxLength       =   20
            TabIndex        =   93
            Top             =   240
            Width           =   1680
         End
         Begin VB.TextBox txtCambio 
            Alignment       =   2  'Center
            BackColor       =   &H0000FFFF&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   1200
            Locked          =   -1  'True
            TabIndex        =   92
            Top             =   1200
            Width           =   1185
         End
         Begin VB.TextBox TxtSimbolo_Cambio 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   720
            Locked          =   -1  'True
            TabIndex        =   91
            Top             =   1200
            Width           =   495
         End
         Begin VB.TextBox TxtSimbolo_Redondeo 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   720
            Locked          =   -1  'True
            TabIndex        =   90
            Top             =   840
            Width           =   495
         End
         Begin VB.Label Label12 
            Caption         =   "Redond."
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   60
            TabIndex        =   97
            Top             =   840
            Width           =   1095
         End
         Begin VB.Label Label11 
            Alignment       =   2  'Center
            Caption         =   "TOTAL"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   60
            TabIndex        =   96
            Top             =   360
            Width           =   615
         End
         Begin VB.Label Label9 
            Caption         =   "Cambio"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   60
            TabIndex        =   95
            Top             =   1200
            Width           =   1335
         End
      End
      Begin VB.TextBox txtTotal_Calculado 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   12915
         MaxLength       =   20
         TabIndex        =   87
         Top             =   240
         Width           =   1395
      End
      Begin VB.TextBox TxtSimbolo_SubTotal 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         Enabled         =   0   'False
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   315
         Left            =   12420
         Locked          =   -1  'True
         TabIndex        =   86
         Top             =   240
         Width           =   495
      End
      Begin VB.Frame frameMedios_Pagos 
         Caption         =   "Medios de Pago"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   2655
         Left            =   6720
         TabIndex        =   81
         Top             =   120
         Width           =   5100
         Begin VB.CheckBox ChkLink_pago 
            Alignment       =   1  'Right Justify
            Caption         =   "Enviar Link de Pago"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   435
            Left            =   120
            TabIndex        =   169
            Top             =   2170
            Visible         =   0   'False
            Width           =   1215
         End
         Begin VSFlex7LCtl.VSFlexGrid vsfMedios_Pagos 
            Height          =   1935
            Left            =   120
            TabIndex        =   84
            Top             =   240
            Width           =   4875
            _cx             =   8599
            _cy             =   3413
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   2
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   1
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11CEE
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
         Begin VB.TextBox TxtSimbolo_Medios_Pago 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   2760
            Locked          =   -1  'True
            TabIndex        =   82
            Top             =   2280
            Width           =   495
         End
         Begin VB.TextBox txtTotal_Medios_Pago 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   3255
            TabIndex        =   83
            Top             =   2280
            Width           =   1695
         End
         Begin VB.Label LabelMPago 
            Alignment       =   2  'Center
            Caption         =   "Total Medios Pago"
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   255
            Left            =   1320
            TabIndex        =   85
            Top             =   2280
            Width           =   1455
         End
      End
      Begin VB.Frame Frame2 
         Caption         =   "Tasa Bromatológica"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   735
         Left            =   3480
         TabIndex        =   76
         Top             =   2040
         Width           =   3255
         Begin VB.TextBox txtPorcentaje_TBromatologica 
            Alignment       =   2  'Center
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   840
            Locked          =   -1  'True
            TabIndex        =   80
            Top             =   240
            Width           =   1215
         End
         Begin VB.TextBox txtTasa_Bromatologica 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   120
            Locked          =   -1  'True
            TabIndex        =   79
            Top             =   240
            Width           =   615
         End
         Begin VB.TextBox txtImporte_TBromatologica 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   2160
            Locked          =   -1  'True
            TabIndex        =   78
            Top             =   240
            Width           =   975
         End
         Begin VB.TextBox txtTBromatologica_Importe_SIVA 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   2520
            TabIndex        =   77
            Tag             =   "V"
            Top             =   240
            Visible         =   0   'False
            Width           =   615
         End
      End
      Begin VB.Frame frameIvas 
         Caption         =   "Impuestos"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   1215
         Left            =   3480
         TabIndex        =   74
         Top             =   840
         Width           =   3255
         Begin VSFlex7LCtl.VSFlexGrid vsfImpuestos 
            Height          =   855
            Left            =   120
            TabIndex        =   75
            Top             =   240
            Width           =   3015
            _cx             =   5318
            _cy             =   1508
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483635
            ForeColorSel    =   -2147483634
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   2
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11E45
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Frame Frame1 
         Caption         =   "Forma de Pago / Vencimientos"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   735
         Left            =   3480
         TabIndex        =   68
         Top             =   120
         Width           =   3255
         Begin VB.TextBox txtForma_Pago 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   120
            TabIndex        =   71
            Top             =   240
            Width           =   615
         End
         Begin VB.TextBox txtDes_Forma_Pago 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H00000000&
            Height          =   315
            Left            =   840
            Locked          =   -1  'True
            TabIndex        =   70
            Top             =   240
            Width           =   1215
         End
         Begin VB.TextBox txtFec_Vencimiento 
            Alignment       =   2  'Center
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   315
            Left            =   2160
            TabIndex        =   69
            Top             =   240
            Width           =   975
         End
      End
      Begin VB.PictureBox Imagen_Producto 
         BackColor       =   &H00FFFFFF&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   2565
         Left            =   120
         ScaleHeight     =   2505
         ScaleWidth      =   3240
         TabIndex        =   66
         Top             =   120
         Width           =   3300
         Begin Threed.SSPanel sspTiene_Remitos_Pendientes 
            Height          =   375
            Left            =   0
            TabIndex        =   67
            Top             =   0
            Visible         =   0   'False
            Width           =   3255
            _Version        =   65536
            _ExtentX        =   5741
            _ExtentY        =   661
            _StockProps     =   15
            Caption         =   "REM / PED. PENDIENTES"
            ForeColor       =   255
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   9.74
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
         End
      End
      Begin VB.Frame frameVencimientos_Cuotas 
         Caption         =   "Vencimientos de Cuotas"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   2655
         Left            =   120
         TabIndex        =   64
         Top             =   120
         Visible         =   0   'False
         Width           =   3310
         Begin VSFlex7LCtl.VSFlexGrid vsfVencimientos_Cuotas 
            Height          =   2295
            Left            =   120
            TabIndex        =   65
            Top             =   240
            Width           =   3060
            _cx             =   5397
            _cy             =   4048
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   -2147483635
            ForeColorSel    =   -2147483634
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   2
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":11F9C
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin Threed.SSCommand cmdGuardar 
         Height          =   375
         Left            =   11880
         TabIndex        =   100
         Top             =   2400
         Width           =   2535
         _Version        =   65536
         _ExtentX        =   4471
         _ExtentY        =   661
         _StockProps     =   78
         Picture         =   "frmPunto_Venta.frx":120F3
      End
      Begin VB.Frame fraEquivalencias_Stock 
         Caption         =   "Equivalencias y Stock"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00004000&
         Height          =   2655
         Left            =   3480
         TabIndex        =   98
         Top             =   120
         Visible         =   0   'False
         Width           =   8295
         Begin VSFlex7LCtl.VSFlexGrid vsfEquivalencias_Stock 
            Height          =   2295
            Left            =   120
            TabIndex        =   99
            Top             =   240
            Width           =   8055
            _cx             =   14208
            _cy             =   4048
            _ConvInfo       =   1
            Appearance      =   1
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   12640511
            ForeColorSel    =   0
            BackColorBkg    =   -2147483636
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483633
            GridColorFixed  =   -2147483632
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483642
            FocusRect       =   1
            HighLight       =   1
            AllowSelection  =   -1  'True
            AllowBigSelection=   -1  'True
            AllowUserResizing=   0
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   50
            Cols            =   16
            FixedRows       =   1
            FixedCols       =   1
            RowHeightMin    =   0
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmPunto_Venta.frx":12ACD
            ScrollTrack     =   0   'False
            ScrollBars      =   3
            ScrollTips      =   0   'False
            MergeCells      =   0
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   5
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   0
            ShowComboButton =   -1  'True
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
         End
      End
      Begin VB.Label Label10 
         Caption         =   "STotal"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   11900
         TabIndex        =   88
         Top             =   240
         Width           =   735
      End
   End
   Begin MSCommLib.MSComm MSComm1 
      Left            =   0
      Top             =   2400
      _ExtentX        =   1005
      _ExtentY        =   1005
      _Version        =   393216
      DTREnable       =   -1  'True
   End
   Begin VB.Frame framePie 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00004000&
      Height          =   735
      Left            =   120
      TabIndex        =   54
      Top             =   8760
      Width           =   14895
      Begin VB.CommandButton cmdEntrega 
         Caption         =   "&Entrega"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   13440
         MaskColor       =   &H000000FF&
         TabIndex        =   62
         Top             =   240
         Width           =   1335
      End
      Begin VB.TextBox txtSerie_DGI 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   9000
         Locked          =   -1  'True
         TabIndex        =   61
         Tag             =   "V"
         Top             =   240
         Width           =   375
      End
      Begin VB.TextBox txtCaja 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   1200
         Locked          =   -1  'True
         TabIndex        =   59
         Tag             =   "V"
         Top             =   240
         Width           =   495
      End
      Begin VB.TextBox txtCancelada 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFC0&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   10800
         Locked          =   -1  'True
         TabIndex        =   52
         Top             =   240
         Width           =   2535
      End
      Begin VB.TextBox TxtAutorizado 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   6600
         Locked          =   -1  'True
         TabIndex        =   50
         Tag             =   "V"
         Top             =   240
         Width           =   1575
      End
      Begin VB.TextBox txtNro_Fanfold 
         Alignment       =   2  'Center
         BackColor       =   &H00FFFFFF&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H000000FF&
         Height          =   315
         Left            =   9360
         Locked          =   -1  'True
         TabIndex        =   51
         Tag             =   "V"
         Top             =   240
         Width           =   1335
      End
      Begin VB.TextBox TxtFecReg 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   2400
         Locked          =   -1  'True
         TabIndex        =   47
         Top             =   240
         Width           =   1095
      End
      Begin VB.TextBox txtUsuario 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   4920
         Locked          =   -1  'True
         TabIndex        =   49
         Top             =   240
         Width           =   1575
      End
      Begin VB.TextBox txtFec_Transferido 
         Alignment       =   2  'Center
         BackColor       =   &H8000000F&
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   315
         Left            =   3480
         TabIndex        =   48
         Tag             =   "V"
         Top             =   240
         Width           =   615
      End
      Begin Threed.SSPanel sspOperacion 
         Height          =   375
         Left            =   120
         TabIndex        =   55
         Top             =   240
         Width           =   495
         _Version        =   65536
         _ExtentX        =   873
         _ExtentY        =   661
         _StockProps     =   15
         ForeColor       =   65535
         BackColor       =   8421504
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Bookman Old Style"
            Size            =   15.74
            Charset         =   0
            Weight          =   600
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   1
      End
      Begin VB.Label Label15 
         Alignment       =   2  'Center
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Caja"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   720
         TabIndex        =   60
         Top             =   240
         Width           =   495
      End
      Begin VB.Label labDocumento_DGI 
         Alignment       =   1  'Right Justify
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "eFactura"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   8280
         TabIndex        =   58
         Top             =   240
         Width           =   615
      End
      Begin VB.Label Label5 
         Alignment       =   1  'Right Justify
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Fecha"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   1800
         TabIndex        =   57
         Top             =   240
         Width           =   495
      End
      Begin VB.Label Label26 
         Alignment       =   2  'Center
         BackColor       =   &H00E0E0E0&
         BackStyle       =   0  'Transparent
         Caption         =   "Usuario "
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   4200
         TabIndex        =   56
         Top             =   240
         Width           =   735
      End
   End
   Begin Crystal.CrystalReport CrystalReport1 
      Left            =   0
      Top             =   600
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   348160
      WindowControlBox=   -1  'True
      WindowMaxButton =   -1  'True
      WindowMinButton =   -1  'True
      WindowState     =   2
      PrintFileLinesPerPage=   60
      WindowShowSearchBtn=   -1  'True
      WindowShowPrintSetupBtn=   -1  'True
      WindowShowRefreshBtn=   -1  'True
   End
   Begin ComctlLib.StatusBar stbAyuda 
      Align           =   2  'Align Bottom
      Height          =   375
      Left            =   0
      TabIndex        =   53
      Top             =   9975
      Width           =   15165
      _ExtentX        =   26749
      _ExtentY        =   661
      SimpleText      =   ""
      _Version        =   327682
      BeginProperty Panels {0713E89E-850A-101B-AFC0-4210102A8DA7} 
         NumPanels       =   1
         BeginProperty Panel1 {0713E89F-850A-101B-AFC0-4210102A8DA7} 
            Alignment       =   1
            AutoSize        =   1
            Object.Width           =   26220
            Picture         =   "frmPunto_Venta.frx":12C24
            TextSave        =   ""
            Key             =   ""
            Object.Tag             =   ""
         EndProperty
      EndProperty
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
   End
   Begin Crystal.CrystalReport cryImpresion_Factura_Laser 
      Left            =   0
      Top             =   1080
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   348160
      WindowControlBox=   -1  'True
      WindowMaxButton =   -1  'True
      WindowMinButton =   -1  'True
      WindowState     =   2
      PrintFileLinesPerPage=   60
      WindowShowSearchBtn=   -1  'True
      WindowShowPrintSetupBtn=   -1  'True
      WindowShowRefreshBtn=   -1  'True
   End
   Begin Crystal.CrystalReport cryImpresion_Entrega_Mercaderia_Laser 
      Left            =   0
      Top             =   0
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   348160
      WindowControlBox=   -1  'True
      WindowMaxButton =   -1  'True
      WindowMinButton =   -1  'True
      WindowState     =   2
      PrintFileLinesPerPage=   60
      WindowShowSearchBtn=   -1  'True
      WindowShowPrintSetupBtn=   -1  'True
      WindowShowRefreshBtn=   -1  'True
   End
   Begin VB.Menu MAlta 
      Caption         =   "&Alta"
   End
   Begin VB.Menu MBaja 
      Caption         =   "&Baja"
      Begin VB.Menu MBaja_Opciones 
         Caption         =   "&Anular Documento"
         Index           =   0
      End
      Begin VB.Menu MBaja_Opciones 
         Caption         =   "&DesHacer Anulacion"
         Index           =   1
      End
   End
   Begin VB.Menu MConsulta 
      Caption         =   "&Consulta"
   End
   Begin VB.Menu MModificacion 
      Caption         =   "&Modificacion"
   End
   Begin VB.Menu MListar 
      Caption         =   "&Listar"
      Begin VB.Menu MListar_Opciones 
         Caption         =   "L&istar Cabezales"
         Index           =   0
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "L&istar Cabezales"
            Index           =   0
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con &Observaciones"
            Index           =   1
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con &Datos e-Factura y Medio de Pago"
            Index           =   2
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con &Contrato y Medio de Pago"
            Index           =   3
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales Agrupado x Contrato"
            Index           =   4
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con &Netos x IVA"
            Index           =   5
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con Ajuste INAC"
            Index           =   6
         End
         Begin VB.Menu MListar_Cabezales 
            Caption         =   "Listar Cabezales con RUT"
            Index           =   7
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   1
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar &Detalle x Documento"
         Index           =   2
         Begin VB.Menu MListar_Detallado 
            Caption         =   "Listar &Detalle x Documento"
            Index           =   0
         End
         Begin VB.Menu MListar_Detallado 
            Caption         =   "Listar Detalle Comparativo de Precio x Articulo "
            Index           =   1
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   3
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar Totales "
         Index           =   4
         Begin VB.Menu MListar_Totales 
            Caption         =   "Listar Totales x &Articulos"
            Index           =   0
         End
         Begin VB.Menu MListar_Totales 
            Caption         =   "Listar &Totales x Tipo de Documento"
            Index           =   1
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   5
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar &Pedidos"
         Index           =   6
         Begin VB.Menu MListar_Pedidos 
            Caption         =   "Listar &Pedidos"
            Index           =   0
         End
         Begin VB.Menu MListar_Pedidos 
            Caption         =   "Listar Pedidos &Resumido"
            Index           =   1
         End
         Begin VB.Menu MListar_Pedidos 
            Caption         =   "Listar Pedidos &Detallado"
            Index           =   2
         End
         Begin VB.Menu MListar_Pedidos 
            Caption         =   "Listar Pedidos - T&otales x Tipo de Documento"
            Index           =   3
         End
         Begin VB.Menu MListar_Pedidos 
            Caption         =   "Listar Pedidos Formato &Grilla"
            Index           =   4
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   7
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar &Resguardos"
         Index           =   8
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   9
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar A&nulados"
         Index           =   10
         Begin VB.Menu MListar_Anulados 
            Caption         =   "Listar A&nulados"
            Index           =   0
         End
         Begin VB.Menu MListar_Anulados 
            Caption         =   "Listar Anulados - Total&es x Tipo de Documento"
            Index           =   1
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   11
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar Detalle de Descuen&tos"
         Index           =   12
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   13
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar Documentos Pendientes"
         Index           =   14
         Begin VB.Menu MListar_Pendientes 
            Caption         =   "Listar Documentos Pendientes"
            Index           =   0
         End
         Begin VB.Menu MListar_Pendientes 
            Caption         =   "Listar Documentos Pendientes - Formato Grilla"
            Index           =   1
         End
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   15
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar Documentos x Seccion Detalle"
         Index           =   16
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "-"
         Index           =   17
      End
      Begin VB.Menu MListar_Opciones 
         Caption         =   "Listar Documentos de Uso Interno(<90)"
         Index           =   18
      End
   End
   Begin VB.Menu MCalculadora 
      Caption         =   "Calcula&dora"
   End
   Begin VB.Menu MApertura_Cajon 
      Caption         =   "A&pertura de Cajon"
   End
   Begin VB.Menu MReimpresion 
      Caption         =   "&Re-Impresion"
      Begin VB.Menu MReimpresion_Opciones 
         Caption         =   "Re-Impresión del &Documento"
         Index           =   0
      End
      Begin VB.Menu MReimpresion_Opciones 
         Caption         =   "-"
         Index           =   1
      End
      Begin VB.Menu MReimpresion_Opciones 
         Caption         =   "Re-Impresión x &Lote"
         Index           =   2
      End
      Begin VB.Menu MReimpresion_Opciones 
         Caption         =   "-"
         Index           =   3
      End
      Begin VB.Menu MReimpresion_Opciones 
         Caption         =   "Re-Impresión &Tickets de Entrega/Envios"
         Index           =   4
      End
   End
   Begin VB.Menu MAutorizar 
      Caption         =   "A&utorizar"
      Begin VB.Menu MAutorizar_Opciones 
         Caption         =   "A&utorizar"
         Index           =   1
      End
      Begin VB.Menu MAutorizar_Opciones 
         Caption         =   "Autorizar en &Lote"
         Index           =   2
      End
   End
   Begin VB.Menu MCambios 
      Caption         =   "Camb&ios"
      Begin VB.Menu MCambios_Acopio 
         Caption         =   "Cambio de &Acopio"
         Index           =   1
      End
      Begin VB.Menu MCambios_Cliente 
         Caption         =   "Cambio de &Cliente"
         Index           =   2
      End
      Begin VB.Menu MCambios_Forma_Pago 
         Caption         =   "Cambio de &Forma de Pago"
         Index           =   3
      End
      Begin VB.Menu MCambios_Medios_Pago 
         Caption         =   "Cambio de &Medios de Pago"
         Index           =   4
      End
      Begin VB.Menu MCambios_Observacion 
         Caption         =   "Cambio de &Observacion"
         Index           =   5
      End
      Begin VB.Menu MCambios_Tipo_Documento 
         Caption         =   "Cambio de &Tipo de Documento"
         Index           =   6
      End
      Begin VB.Menu MCambios_Tipo_Entrega_y_Deposito 
         Caption         =   "Cambio de Tipo de &Entrega y Deposito en las Lìneas"
         Index           =   7
      End
      Begin VB.Menu MCambios_Vendedor 
         Caption         =   "Cambio de &Vendedor"
         Index           =   8
      End
      Begin VB.Menu MCambio_Datos_de_Tarjeta 
         Caption         =   "Cambio Datos de Tarjeta de  &Credito"
         Index           =   9
      End
      Begin VB.Menu MCambio_Datos_Cheques 
         Caption         =   "Cambio Datos de Che&ques"
         Index           =   10
      End
   End
   Begin VB.Menu MVer_Documentos_Afectados 
      Caption         =   "Ver D&ocumentos Afectados"
   End
   Begin VB.Menu MVer_Asiento_Contable 
      Caption         =   "Ver A&siento"
   End
   Begin VB.Menu MVer_Verificacion 
      Caption         =   "Ver &Verificacion"
   End
   Begin VB.Menu MTipo_Entrega 
      Caption         =   "&Copiar Tipo de Entrega a Todos"
      Visible         =   0   'False
      Begin VB.Menu MTipo_Entrega_Copiar 
         Caption         =   "&Copiar Tipo de Entrega a Todos"
      End
   End
   Begin VB.Menu MDeposito 
      Caption         =   "&Copiar Deposito a Todos"
      Visible         =   0   'False
      Begin VB.Menu MDepositoCopiar 
         Caption         =   "&Copiar Deposito a Todos"
      End
   End
End
Attribute VB_Name = "frmPunto_Venta"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False

' =================================================================================

' Constantes de las Columnas de la Grilla de Mercaderia

Const CGL_CODIGO As Long = 1
Const CGL_CODIGO_SANTERIOR As Long = 2
Const CGL_DESCRIPCION As Long = 3
Const CGL_TIPO_ENTREGA As Long = 4
Const CGL_DEPOSITO As Long = 5              ' AIR 20171003
Const CGL_CAJAS As Long = 6
Const CGL_PROCEDENCIA As Long = 7
Const CGL_STOCK As Long = 8
Const CGL_TCOFIS As Long = 9
Const CGL_COFIS As Long = 10
Const CGL_TIVA As Long = 11
Const CGL_IVA As Long = 12
Const CGL_TCOFIS_IVA As Long = 13
Const CGL_COFIS_IVA As Long = 14
Const CGL_TIADIC As Long = 16
Const CGL_IADIC As Long = 15

Const CGL_UNIDADES As Long = 17

'jch 20220527 COLUMNAS NUEVAS PARA EL USO DE VENTA CON MGNITUDES
Const CGL_UNIDADES_MAGNITUD As Long = 18
Const CGL_MAGNITUD As Long = 19
Const CGL_NOMBRE_MAGNITUD As Long = 20
Const CGL_PUNITARIOSINIVA As Long = 21
Const CGL_PUNITARIO_MAGNITUD As Long = 22
Const CGL_PUNITARIO As Long = 23
Const CGL_PUNITARIOSIMP As Long = 24
Const CGL_DTO1 As Long = 25
Const CGL_DTO2 As Long = 26
Const CGL_DTO3 As Long = 27
Const CGL_PUNITARIO_CON_DTO As Long = 28
Const CGL_PUNITARIOSIMP_CON_DTO As Long = 29
Const CGL_IMPORTE_IADIC As Long = 30
Const CGL_IMPORTE As Long = 31
Const CGL_IMPORTE_SIN_IVA As Long = 32
Const CGL_IMPORTE_COFIS As Long = 33
Const CGL_IMPORTE_IVA As Long = 34
Const CGL_FORMA_PAGO As Long = 35
Const CGL_NRO_LINEA As Long = 36
Const CGL_COD_DOC_REF As Long = 37
Const CGL_NRO_DOC_REF As Long = 38
Const CGL_NRO_LINEA_REF As Long = 39
Const CGL_CANTIDAD_SALDO As Long = 40
Const CGL_CANTIDAD_ENTREGADA As Long = 41
Const CGL_PRECIO_ORIGINAL As Long = 42
Const CGL_PRECIO_MINIMO As Long = 43
Const CGL_DESCUENTO_MAXIMO As Long = 44
Const CGL_ES_MAILING As Long = 45

' =================================================================================

' Constantes de las Columnas de la Grilla de Servicio

Const CGS_UNIDADES As Long = 0
Const CGS_CODIGO As Long = 1
Const CGS_DESCRIPCION As Long = 2
Const CGS_SECCION As Long = 3
Const CGS_DESC_SECCION As Long = 4
Const CGS_TCOFIS As Long = 5
Const CGS_COFIS As Long = 6
Const CGS_TIVA As Long = 7
Const CGS_IVA As Long = 8
Const CGS_PUNITARIO_SIVA As Long = 9
Const CGS_PUNITARIO As Long = 10
Const CGS_TASA_RESGUARDO As Long = 11
Const CGS_IMPORTE As Long = 12
Const CGS_IMPORTE_SIN_IVA As Long = 13
Const CGS_IMPORTE_COFIS As Long = 14
Const CGS_IMPORTE_IVA As Long = 15
Const CGS_TCOFIS_IVA As Long = 16
Const CGS_COFIS_IVA As Long = 17

Const CGS_CODIGO_RETENCION As Long = 18

' =================================================================================

' Constante de las Columnas de la Grilla de Impuestos

Const CGI_PORCENTAJE_IVA As Long = 1
Const CGI_IMPORTE_SIN_IMPUESTOS As Long = 2
Const CGI_COFIS As Long = 3
Const CGI_IVA As Long = 4
Const CGI_CODIGO_IVA As Long = 5
Const CGI_PORCENTAJE_COFIS As Long = 6


' =================================================================================

' Constante de las Columnas de la Grilla de Medios de Pago

Const CGMP_MEDIO_PAGO As Long = 1
Const CGMP_DESCRIPCION As Long = 2
Const CGMP_CUOTAS As Long = 3
Const CGMP_MONEDA As Long = 4
Const CGMP_TC As Long = 5
Const CGMP_SIMBOLO As Long = 6
Const CGMP_IMPORTE As Long = 7
Const CGMP_REFERENCIA As Long = 8
Const CGMP_CODDOC As Long = 9
Const CGMP_NRODOC As Long = 10
Const CGMP_CODPROV As Long = 11
Const CGMP_TIPO_MPAGO As Long = 12
Const CGMP_TIPO_DEV_CAMBIO As Long = 13


' =================================================================================

' Constante de las Columnas de la Grilla de Cheques

Const CGCH_BANCO As Long = 1
Const CGCH_DESCRIPCION As Long = 2
Const CGCH_CUENTA As Long = 3
Const CGCH_DOCUMENTO As Long = 4
Const CGCH_SERIE As Long = 5
Const CGCH_NUMERO_CHEQUE As Long = 6
Const CGCH_MONEDA As Long = 7
Const CGCH_TC As Long = 8
Const CGCH_SIMBOLO As Long = 9
Const CGCH_IMPORTE As Long = 10
Const CGCH_IMPORTE_DEL_DOC As Long = 11
Const CGCH_FECHA_EMISION As Long = 12
Const CGCH_FECHA_VTO As Long = 13
Const CGCH_CUENTA_LIBRADOR As Long = 14
Const CGCH_TITULAR_LIBRADOR As Long = 15
Const CGCH_OBS As Long = 16
Const CGCH_ESTADO As Long = 17
Const CGCH_FEC_REG As Long = 18
Const CGCH_USUARIO As Long = 19
Const CGCH_COD_BANCO_EMI As Long = 20
Const CGCH_FEC_BANCO As Long = 21
Const CGCH_NRO_INT As Long = 22
Const CGCH_COD_DOCA_DEP As Long = 23
Const CGCH_NRO_DOCA_DEP As Long = 24




' =================================================================================

' Constante de las Columnas de la Grilla de Tarjetas de Credito

Const CGTA_MEDIO_PAGO As Long = 1
Const CGTA_DESCRIPCION As Long = 2
Const CGTA_NUMERO As Long = 3
Const CGTA_FECHA_VTO As Long = 4
Const CGTA_NOMBRE_TITULAR As Long = 5
Const CGTA_CODIGO_VERIFICACION As Long = 6
Const CGTA_CUOTAS As Long = 7
Const CGTA_AUTORIZACION As Long = 8
Const CGTA_LOTE As Long = 9
Const CGTA_MONEDA As Long = 10
Const CGTA_SIMBOLO As Long = 11
Const CGTA_IMPORTE As Long = 12


' =================================================================================

' Constante de las Columnas de la Grilla de Vencimientos de Cuotas

Const CGVC_NUMERO As Long = 1
Const CGVC_VENCIMIENTO As Long = 2
Const CGVC_IMPORTE As Long = 3


' =================================================================================

' Constante de las Columnas de la Grilla de Descuentos x Volumen

Const CGDV_CANTIDAD As Long = 1
Const CGDV_DTO As Long = 2
Const CGDV_PVENTA As Long = 3


' =================================================================================

' Constante de las Columnas de la Grilla de Equivalencias y Stock

Const CGES_CODIGO As Long = 1
Const CGES_CODIGO_SANTERIOR As Long = 2
Const CGES_DESCRIPCION As Long = 3
Const CGES_PVENTA As Long = 4
Const CGES_STOCK_1 As Long = 5
Const CGES_STOCK_2 As Long = 6
Const CGES_STOCK_3 As Long = 7

' =================================================================================

' Constantes de las Columnas de la Grilla de Personas Autorizadas

Const CGPA_CI As Long = 1
Const CGPA_DESCRIPCION As Long = 2


' =================================================================================

' Constante de las Columnas de la Grilla de Vales

Const CGVA_CODDOC As Long = 1
Const CGVA_NRODOC As Long = 2
Const CGVA_CODPROV As Long = 3
Const CGVA_DOCID As Long = 4
Const CGVA_MONEDA As Long = 5
Const CGVA_SIMBOLO As Long = 6
Const CGVA_IMPORTE As Long = 7
Const CGVA_FEC_VENC As Long = 8
Const CGVA_SALDO As Long = 9

' =================================================================================

' Constante de las Columnas de la Grilla de Series

Const CGSA_CODIGO_PROD As Long = 1
Const CGSA_CODIGO_PROD_ANTERIOR As Long = 2
Const CGSA_DESCRIPCION As Long = 3
Const CGSA_SERIE As Long = 4
Const CGSA_SERIE_SIN_CONTROL_COMPRA As Long = 5


' =================================================================================


Public plngCod_Programa As Long
Public pstrTipo_Ingreso_Documentos As String
Public pbolCargo_Desde_Movil As Boolean

Public plngCod_Emp As Long
Public plngCod_Doc As Long
Public plngNro_Doc As Long
Public plngCod_Prov As Long

Dim lNombre_Tabla_Lineas_Auxiliar_Temporal As String
Dim lNombre_Tabla_Temporal As String
Dim llngMaximo_Lineas As Long

Dim lstrFiltros As String
Dim lstrDescripcion_Filtros As String
Dim lbolCancelar_Listado As Boolean

Dim gcolImpuestos_Actuales As New colImpuestos

Dim lForma_Pago_Anterior As Long
Dim Busqueda As Boolean
Dim Importe As Double
Dim esTarjeta As Boolean
Dim sumaPuntos As Long
Dim gNumerar As Boolean
Dim desde_Pedido As Boolean
Dim lUltimo_Cod_Doc As Integer
Dim gGuardando_Documento As Boolean
Dim yaAutorizado As Boolean
Dim glngNro_Fanfold_Anterior As Long
Dim gNro_Caja As Integer
Dim llngNro_Guia As Long
Dim gstrUltimo_Nro_Autorizacion_Tarjeta As String
Dim pstrHoras_Factura As String
Dim nro_doc_Wis As String
Dim camion_Wis As String
Dim gbolCargo_Desde_WIS As Boolean
Dim gbolCargo_Desde_Preventa As Boolean
Dim lCfe As efCFE

'chile comenatado Dim lefCL As efCL
Dim gbolESC As Boolean
Dim gbolCambio_Tipo_Doc_Identificatorio As Boolean
Dim gdteFecha_Documento As Date
Dim lcolCampos As New colCampos_Ingreso_Programa
Dim lbolUtilizo_Configuracion_Campos As Boolean
Dim lbolPide_Dato_Manual As Boolean
Dim lbolCerrar_Documento_Sin_Preguntar As Boolean

Dim glngAnterior_Cod_Doc As Long
Dim glngAnterior_Cliente As Long
Dim gdblAnterior_Importe As Double
Dim glngAnterior_Caja As Long
Dim glngAnterior_Moneda As Long
Dim glngAnterior_Lista As Long

Dim glngCod_Doc_Preventa As Long
Dim glngNro_Doc_Preventa As Long
Dim glngCod_Cliente_Preventa As Long
Dim gstrTabla_Temporal_Preventa As String

Dim glngTipo_Documento_Identidad As Long
Dim gstrDocumento_Identidad As String
Dim gstrDireccion As String
Dim gstrTelefonos As String
Dim glngCod_Pais As Long
Dim glngCod_Departamento As Long
Dim glngCod_Ciudad As Long
Dim gstreMail As String
Dim glngCod_Grupo As Long
Dim ldblSaldo_Vale As Double
Dim gcolSeries_Articulos As New colSeries_Articulos
Dim gstrUnidades_x_Defecto As String

Dim gblnCancelar As Boolean
Public gbln_Cargo_Datos_Desde_F10 As Boolean
Dim gbln_Articulo_de_F10 As Boolean
Dim gstrTabla_Temporal_Lineas_Mercaderia As String

Dim ValorInicialDtoGlobal As String

Dim plngCliente_Anterior As Long
Dim plngNroLista_Anterior As Long
Dim plngMoneda_Anterior As Long

Dim DtoGeneralLista As Double
Dim plngListaOLD As Long
Dim plngCodProv As Long

Public gPtoVenta_Robot As Boolean
Public gNroProceso As Long
Public glngCantLinMaxima As Long
Public gBolTodosLosDescuentos As Boolean 'JCH 300123 si esta en si son aceptados todos los descuentos ingresados sin limite

Dim glngColor_x_Defecto_Fuente_Nombre As Long
Dim gTxtRuc_original As String

Dim gAutorizacionUnificada As Boolean

Dim gstrTabla_Temporal_Cotizaciones As String

Dim gBusqueda_Doc_Pendientes_Formato As String  'AIR 20250218



Private Function BuscoTipoDTECL(argTipoDoc) As String

    Dim T As Recordset

    SQL = "select * from ma_tipodte_cl where documento='" & Trim(argTipoDoc) & "'"
    
    Set T = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If T.EOF And T.BOF Then
        BuscoTipoDTECL = 0
    Else
        If Calcular_Monto_IVA <> 0 Then
            BuscoTipoDTECL = T!edte_con_iva
        Else
            BuscoTipoDTECL = T!edte_exento
        End If
        
    End If
    
    

End Function

''chile comenatado
'Public Sub Cargo_Clase_CFE_CL(D As Recordset, pstrId As String)
'
'    Dim DA As Recordset
'    Dim DE As Recordset
'    Dim C As Recordset
'    Dim e As Recordset
'    Dim A As Recordset
'    Dim M As Recordset
'    Dim RM As Recordset
'    Dim CB As Recordset
'    Dim MA As Recordset
'    Dim IM As Recordset
'    Dim lrstMagnitudes As Recordset
'    Dim lstrTipoDoc As String
'    Dim i, j As Integer
'    Dim llngMagnitud As Long
'    Dim ldigit_calculado As Integer
'    Dim lin As Integer
'    Dim limporte_iadic As Double
'    Dim matIAdic() As TotIAdic
'    Dim encontre As Boolean
'
'    On Error GoTo Errores
'
'    lstrTipoDoc = BuscoTipoDoc(D, Me.txtTipo_Doc_Identidad.text)
'
'    limporte_iadic = 0
'
'    'Cargo IdLog
'    lefCL.tipoDoc = Trim(lstrTipoDoc)
'
'    lefCL.IdDoc.TipoDte = BuscoTipoDTECL(lstrTipoDoc)
'    lefCL.IdDoc.fchEmis = CDate(txtFec_Doc.text)
'    lefCL.IdDoc.fchVenc = CDate(txtFec_Vencimiento.text)
'    lefCL.IdDoc.Folio = 0 'se va a ver omo es lo de folio
'    lefCL.IdDoc.TipoTranVenta = gDAdicFE.TpoTranVenta
'    lefCL.IdDoc.FmaPago = fFmaPagoCL(val(txtCodDoc.text))
'    lefCL.IdDoc.MtnBruto = fMntBrutoCL(CLng(txtEmpresa.text), val(txtTipo_Doc_Identidad.text))
'
'    If Trim(UCase(lstrTipoDoc)) = "BOLETA" Then
'        lefCL.IdDoc.IndServicio = gDAdicFE.IndServicio
'        lefCL.IdDoc.PeriodoDesde = DiaMES(CDate(txtFec_Doc.text), "I")
'        lefCL.IdDoc.PeriodoHasta = DiaMES(CDate(txtFec_Doc.text), "F")
'    End If
'
'    If Trim(UCase(lstrTipoDoc)) = "REMITO" Then
'        lefCL.IdDoc.IndTraslado = gDAdicFE.IndTraslado
'        lefCL.IdDoc.TipoDespacho = gDAdicFE.TipoDespacho
'    End If
'
'
'
'    If Buscar_Empresa(CLng(txtEmpresa.text), e) Then
'    End If
'
'
'    'Cargo Datos del Emisor
'    lefCL.emisor.rut = FormatoRUTCL(e!rut)
'    lefCL.emisor.RazonSocial = TamañoCadenaXML(e!razon_social, 100)
'    lefCL.emisor.direccion = TamañoCadenaXML(e!direccion, 70)
'
'    If Buscar_Empresa_Datos_Adicionales(e!codigo, DA) Then
'        lefCL.emisor.Giro = TamañoCadenaXML(DA!Giro, 80)
'        lefCL.emisor.Ciudad = TamañoCadenaXML(DA!Ciudad, 20)
'        lefCL.emisor.Comuna = TamañoCadenaXML(DA!Comuna, 20)
'        lefCL.emisor.sucursal = TamañoCadenaXML(DA!sucursal, 20)
'        lefCL.emisor.Acteco = DA!Acteco
'        lefCL.emisor.Vendedor = TamañoCadenaXML(Me.TxtNomVen.text, 60)
'    End If
'
'
'
'    'Cargo datos del Receptor
'    If Buscar_Cliente(txtCodProv.text, C) Then
'        lefCL.receptor.rut = FormatoRUTCL(Me.TxtRuc.text)
'        lefCL.receptor.RazonSocial = TamañoCadenaXML(C!rsocial_cli, 100)
'        lefCL.receptor.direccion = TamañoCadenaXML(C!direccion_fiscal, 70)
'
'        If Busco_Departamento(C!departamento_fiscal, DE) Then
'            lefCL.receptor.Comuna = TamañoCadenaXML(DE!nombre, 20)
'        Else
'            lefCL.receptor.Comuna = "No Asignado"
'        End If
'
'        If Busco_Ciudad(C!ciudad_fiscal, DE) Then
'            lefCL.receptor.Ciudad = TamañoCadenaXML(DE!nombre, 20)
'        Else
'            lefCL.receptor.Ciudad = "No Asignado"
'        End If
'
'        If Buscar_Giro_Cliente(C!cod_giro, DE) Then
'            lefCL.receptor.Giro = TamañoCadenaXML(DE!Descripcion, 40)
'        Else
'            lefCL.receptor.Giro = "No Asignado"
'        End If
'
'        lefCL.receptor.email = TamañoCadenaXML(C!email_cli, 80)
'        lefCL.receptor.Contacto = TamañoCadenaXML(C!datos_contacto, 80)
'
'        lefCL.receptor.cod_tit = TamañoCadenaXML(txtCodProv.text, 20)
'
'    End If
'
'    If gDAdicFE.RutMandante <> "" Then
'          lefCL.Mandante.rut = FormatoRUTCL(gDAdicFE.RutMandante)
'          lefCL.Mandante.iva = gDAdicFE.IVATerc
'    Else
'          lefCL.Mandante.rut = ""
'          lefCL.Mandante.iva = 0
'    End If
'
'
'
'
'
'    'cargo Detalle
'    If pstrTipo_Ingreso_Documentos = "M" Then
'        If Trim(gstrTabla_Temporal_Lineas_Mercaderia) <> "" Then
'            SQL = "SELECT * FROM " & gstrTabla_Temporal_Lineas_Mercaderia
'            SQL = SQL & " WHERE Id = " & CDbl(pstrId)
'            SQL = SQL & " AND cod_emp = " & val(txtEmpresa.text)
'            SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
'            SQL = SQL & " AND nro_doc = " & val(txtDoc.text)
'            SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
'            SQL = SQL & " ORDER BY linea "
'
'            Set M = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
'
'            If M.EOF Then
'                MsgBox "Error: No existe registros para las Lineas de Mercaderia", vbCritical, MsgTit
'                lefCL.IdDoc.Folio = "-1"
'                Exit Sub
'            End If
'        Else
'            MsgBox "Error: No existe archivo para las Lineas de Mercaderia", vbCritical, MsgTit
'            lefCL.IdDoc.Folio = "-1"
'            Exit Sub
'        End If
'
'        i = 0
'        While Not M.EOF
'
'            If i = 0 Then
'                ReDim lefCL.detalle(0)
'            Else
'                ReDim Preserve lefCL.detalle(i)
'            End If
'
'
'            lefCL.detalle(i).NroLinDet = i + 1
'
'           'lefCL.detalle(i).ImpAdicRet_CL() As ImpAdicRet_CL
'
'            If Buscar_Articulo(val(M!Cod_Prod), A) Then
'                lefCL.detalle(i).NroLinDet = i + 1
'                lefCL.detalle(i).TpoCodigo = "INT1"
'
'                If ConfPuntoVta_Imprime_EFactura_Codigo_Anterior Then
'                    lefCL.detalle(i).NmbItem = Trim(M!Descripcion)
'                    lefCL.detalle(i).VlrCodigo = Trim(M!codigo_santerior)
'                ElseIf ConfPuntoVta_Imprime_EFactura_Codigo_Art_Proveedor Then
'                    lefCL.detalle(i).NmbItem = Trim(M!Descripcion)
'                    If Trim(A!cod_art_proveedor) = "" Then
'                        lefCL.detalle(i).VlrCodigo = Trim(M!Cod_Prod)
'                    Else
'                        lefCL.detalle(i).VlrCodigo = Trim(A!cod_art_proveedor)
'                    End If
'                Else
'                    If ConfPuntoVta_Imprime_EFactura_Descripcion_Caja Then
'                        If A!generico = "S" Then
'                            lefCL.detalle(i).NmbItem = UCase(Trim(M!Descripcion))
'                        Else
'                            If A!desc_caja <> "" Then
'                                lefCL.detalle(i).NmbItem = Trim(A!desc_caja)
'                            Else
'                                lefCL.detalle(i).NmbItem = Trim(M!Descripcion)
'                            End If
'                        End If
'
'                        lefCL.detalle(i).VlrCodigo = Trim(M!Cod_Prod)
'                    Else
'                        lCfe.Items(i).nomItem = Trim(M!Descripcion)
'                        lefCL.detalle(i).VlrCodigo = Trim(M!Cod_Prod)
'                    End If
'                End If
'
'            End If
'            If Trim(lefCL.detalle(i).VlrCodigo) = "" Then
'                lefCL.detalle(i).VlrCodigo = Trim(M!Cod_Prod)
'                lefCL.detalle(i).TpoCodigo = "INT1"
'            End If
'
'
'            lefCL.detalle(i).UnmdItem = "UN"
'
'            If ConfPuntoVta_Imprime_EFactura_Unidad_Medida Then     'Se configura   SS 20180903
'                If Not confUsaEquivalenciaMagnitudes Then
'                    llngMagnitud = A!magnitud
'                Else
'                    llngMagnitud = M!magnitud
'                End If
'                If Buscar_Magnitud(llngMagnitud, RM) Then
'                    If IsNull(RM!simbolo) Then
'                        lefCL.detalle(i).UnmdItem = "UN"
'                    Else
'                        If RM!simbolo = "" Then
'                            lefCL.detalle(i).UnmdItem = "UN"
'                        Else
'                            lefCL.detalle(i).UnmdItem = Trim(RM!simbolo)
'                        End If
'                    End If
'                    If e!Asociado_ASU = "S" And RM!UniMed <> "" Then
'                        lefCL.detalle(i).UnmdItem = RM!UniMed
'                     End If
'                End If
'            Else
'                If confUsaEquivalenciaMagnitudes Then
'                   If Buscar_Magnitud(M!magnitud, RM) Then
'                       lCfe.Items(i).UniMed = IIf(IsNull(RM!UniMed), "UN", RM!UniMed)
'                   End If
'                End If
'
'            End If
'
'
'            If e!Asociado_ASU = "S" Then
'                SQL = "SELECT top 1 cod_barra,case when principal=1 then 1 else 0 end orden "
'                SQL = SQL & " FROM codbarra WHERE Cod_Prod = " & A!Cod_Prod & " and trans <> 'S' "
'                SQL = SQL & " ORDER BY 2 DESC"
'                Set CB = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
'
'                If Not CB.EOF Then
'                    If Len(Trim(CB!cod_barra)) > 7 And Len(Trim(CB!cod_barra)) < 15 Then
'                        If Calcular_Verificador_EAN_GTIN(Trim(CB!cod_barra), ldigit_calculado) Then
'                            lefCL.detalle(i).TpoCodigo = "EAN" & Len(Trim(CB!cod_barra))
'                            lefCL.detalle(i).VlrCodigo = CB!cod_barra
'                        End If
'                    End If
'                End If
'            End If
'
'
''            'Establece Indicador de Facturacion ------------------------------------------------------------------------------------------------------------
'            lefCL.detalle(i).QtyItem = val(M!unidades)
'
'
'            If val(lefCL.IdDoc.MtnBruto) = 0 Then
'                If Not ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then
'                     lefCL.detalle(i).PrcItem = val(M!Punitario)
'                Else
'                     porcentaje = 100 - (100 * ((100 - M!dto1) / 100) * ((100 - M!dto2) / 100) * ((100 - M!dto3) / 100))
'                     lefCL.detalle(i).PrcItem = val(M!Punitario) * (1 - (porcentaje / 100))
'                        'lefCL.detalle(i).PrcItem = val(M!Punitariosimp)
'                End If
'             End If
'             If val(lefCL.IdDoc.MtnBruto) = 1 Then
'                 If Not ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then
'                        lefCL.detalle(i).PrcItem = val(M!Punitario) / (1 + M!iva / 100)
'                 Else
'                        'lefCL.detalle(i).PrcItem = val(M!punitariosimp_con_dto)
'                        lefCL.detalle(i).PrcItem = M!Punitariosimp / (1 + M!iva / 100)
'                 End If
'
'            End If
'
'            'End If
'
'            'Establece Indicador de Facturacion ------------------------------------------------------------------------------------------------------------
'            'faltaba considerar la variable ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio que condiciona el parametro a pasar a la funcion
'            ' por eso se traslada la evaluacio del indicador de fact a luego de evaluar el precio unitario que se va a enviar
'
'            If Trim(D!exportacion) = "S" Then
'                lefCL.detalle(i).IndExe = 0
'            ElseIf M!Importe = 0 Then
'                lefCL.detalle(i).IndExe = 2
'            ElseIf M!iva <> 0 Then
'                lefCL.detalle(i).IndExe = 0
'            Else
'                lefCL.detalle(i).IndExe = 1
'            End If
'
'            ' Descuentos
'
'
'
'            lefCL.detalle(i).DescuentoPct = 0
'            lefCL.detalle(i).DescuentoMonto = 0
'
'            'If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
'                If Not ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then
'
'                    porcentaje = 100 - (100 * ((100 - M!dto1) / 100) * ((100 - M!dto2) / 100) * ((100 - M!dto3) / 100))
'
'                    lefCL.detalle(i).DescuentoPct = porcentaje
'                    lefCL.detalle(i).DescuentoMonto = Round((M!Punitario * M!unidades) * (porcentaje / 100), 2)
'                End If
'            'End If
'
'             lefCL.detalle(i).MontoItem = Round(lefCL.detalle(i).PrcItem * lefCL.detalle(i).QtyItem, 2) - lefCL.detalle(i).DescuentoMonto
'
'            lefCL.detalle(i).NmbItem = TamañoCadenaXML(lefCL.detalle(i).NmbItem, 80)
'            lefCL.detalle(i).TpoCodigo = TamañoCadenaXML(lefCL.detalle(i).TpoCodigo, 10)
'            lefCL.detalle(i).VlrCodigo = TamañoCadenaXML(lefCL.detalle(i).VlrCodigo, 35)
'            lefCL.detalle(i).UnmdItem = TamañoCadenaXML(lefCL.detalle(i).UnmdItem, 4)
'            lefCL.detalle(i).QtyItem = Format(lefCL.detalle(i).QtyItem, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(CLng(txtCodDoc.text)))
'            lefCL.detalle(i).PrcItem = Format(lefCL.detalle(i).PrcItem, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(CLng(txtCodDoc.text), CLng(txtMoneda.text)))
'            lefCL.detalle(i).DescuentoMonto = Round(lefCL.detalle(i).DescuentoMonto, 0)
'            lefCL.detalle(i).DescuentoPct = Format(lefCL.detalle(i).DescuentoPct, "0.00")
'
'
'            ReDim Preserve lefCL.detalle(i).ImpAdicRet_CL(0)
'            ReDim matIAdic(0)
'            If M!porc_iadic <> 0 Then
'                If Buscar_Impuesto("IAD", M!tasa_iadic, IM) Then
'                End If
'
'                lefCL.detalle(i).ImpAdicRet_CL(0).CodImpAdic = IM!codigo_efactura_uruguay
'                lefCL.detalle(i).ImpAdicRet_CL(0).PrcRef = M!importe_iadic
'                lefCL.detalle(i).ImpAdicRet_CL(0).TasaImp = M!porc_iadic
'                lefCL.detalle(i).ImpAdicRet_CL(0).TipoImp = IM!codigo_efactura_uruguay
'
'                If importe_iadic = 0 Then
'                    ReDim matIAdic(0)
'                Else
'                    ReDim Preserve matIAdic(UBound(matIAdic) + 1)
'                End If
'                importe_iadic = importe_iadic + M!importe_iadic
'                encontre = False
'                For j = 0 To UBound(matIAdic)
'                     If matIAdic(j).TipoImp = IM!codigo_efactura_uruguay Then
'                          matIAdic(j).TipoImp = matIAdic(j).TipoImp + IM!codigo_efactura_uruguay
'                          matIAdic(j).TasaImp = matIAdic(j).TasaImp + M!porc_iadic
'                          matIAdic(j).MontoImp = matIAdic(j).MontoImp + M!importe_iadic
'                          encontre = True
'                     End If
'                Next
'                If Not encontre Then
'                     matIAdic(UBound(matIAdic)).TipoImp = IM!codigo_efactura_uruguay
'                     matIAdic(UBound(matIAdic)).TasaImp = M!porc_iadic
'                     matIAdic(UBound(matIAdic)).MontoImp = M!importe_iadic
'                End If
'
'            Else
'                lefCL.detalle(i).ImpAdicRet_CL(0).CodImpAdic = 0
'                lefCL.detalle(i).ImpAdicRet_CL(0).PrcRef = 0
'                lefCL.detalle(i).ImpAdicRet_CL(0).TasaImp = 0
'            End If
'
'            M.MoveNext
'            i = i + 1
'
'        Wend
'
'    End If
'
'    If gDAdicFE.Aceptado Then
'        With gDAdicFE
'            If Trim(.Patente) <> "" And Trim(.RutTransportista) <> "" And Trim(.RutChofer) <> "" And Trim(.NombreChofer) <> "" And _
'               Trim(.DireccionDestino) <> "" And Trim(.ComunaDestino) <> "" And Trim(.CiudadDestino) <> "" Then
'                  lefCL.Transporte.Patente = TamañoCadenaXML(.Patente, 8)
'                  lefCL.Transporte.RutTrans = FormatoRUTCL(.RutTransportista)
'                  lefCL.Transporte.RutChofer = FormatoRUTCL(.RutChofer)
'                  lefCL.Transporte.nombre = TamañoCadenaXML(.NombreChofer, 30)
'                  lefCL.Transporte.direccion = TamañoCadenaXML(.DireccionDestino, 70)
'                  lefCL.Transporte.Comuna = TamañoCadenaXML(.ComunaDestino, 20)
'                  lefCL.Transporte.Ciudad = TamañoCadenaXML(.CiudadDestino, 20)
'            End If
'
'        End With
'
'    End If
'
'
'
'
'
'    'cargo Detalle
'    If pstrTipo_Ingreso_Documentos = "S" Then
'        dbgLineas_Servicios.MoveFirst
'
'        lcantlinserv = 0    'AIR 20180815 llevamos un contador de la cantidad de lineas de servicio para saber la cantidad real, porque la grilla de servicio no quita la fila eliminada
'
'        For i = 1 To dbgLineas_Servicios.Rows
'
'            If i = 1 Then
'                ReDim lefCL.detalle(i - 1)
'            Else
'                ReDim Preserve lefCL.detalle(i - 1)
'            End If
'
'            lefCL.detalle(i - 1).NroLinDet = i
'
'            lefCL.detalle(i - 1).TpoCodigo = "INT1"
'            lefCL.detalle(i - 1).VlrCodigo = IIf(Trim(dbgLineas_Servicios.Columns("codigo").text) = "", "1", Trim(dbgLineas_Servicios.Columns("codigo").text))
'
'            If Not dbgLineas_Servicios.Columns("eliminada").Value Then    ' linea eliminada en la grilla de lineas de servicio
'
'                lcantlinserv = lcantlinserv + 1   'AIR 20180815
'
'                lefCL.detalle(i - 1).IndExe = obtengoIndicadorIVACL(val(dbgLineas_Servicios.Columns("tiva").text), val(dbgLineas_Servicios.Columns("precio").text), CDate(txtFec_Doc.text))
'
'                If ConfPuntoVta_Concatenar_Seccion_Descripcion And val(dbgLineas_Servicios.Columns("seccion").text) <> 0 Then
'                    lefCL.detalle(i - 1).NmbItem = f_Ins_String_Sin_Menor_Mayor(Mid(Trim(UCase(Trim(dbgLineas_Servicios.Columns("desc_seccion").text))) & "-" & Trim(UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text))), 1, 80))
'                Else
'                    lefCL.detalle(i - 1).NmbItem = Trim(UCase(f_Ins_String_Sin_Menor_Mayor(dbgLineas_Servicios.Columns("descripcion").text)))
'                End If
'
'                lefCL.detalle(i - 1).QtyItem = val(dbgLineas_Servicios.Columns("unidades").text)
'                lefCL.detalle(i - 1).UnmdItem = "UN"
'
'                '  Se ajusta el Precio Unitario y Monto del Item que no estaba considerandolo correctamente
'                '  se agrega la posibilidad de enviar a E-factura el precio sin impuestos.
'                If lefCL.IdDoc.MtnBruto = 1 Then
'                     lefCL.detalle(i - 1).PrcItem = dbgLineas_Servicios.Columns("precio").text
'                Else
'                     lefCL.detalle(i - 1).PrcItem = dbgLineas_Servicios.Columns("precio_siva").text
'                End If
'                lefCL.detalle(i - 1).MontoItem = Round(val(lefCL.detalle(i - 1).PrcItem) * val(lefCL.detalle(i - 1).QtyItem), 2)
'
'                ' Descuentos
'                lefCL.detalle(i - 1).DescuentoMonto = 0
'                lefCL.detalle(i - 1).DescuentoPct = 0
'
'                lefCL.detalle(i - 1).QtyItem = Round(lefCL.detalle(i - 1).QtyItem, 6)
'                lefCL.detalle(i - 1).PrcItem = Round(lefCL.detalle(i - 1).PrcItem, 6)
'
'                If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
'                    If Not ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then
'                        If lefCL.IdDoc.MtnBruto = 1 Then
'                            lefCL.detalle(i - 1).DescuentoMonto = Round((lefCL.detalle(i - 1).QtyItem * lefCL.detalle(i - 1).PrcItem) - Round(val(dbgLineas_Servicios.Columns("importe").text), 2), 2) 'dbgLineas_Servicios.Columns("precio_siva")  SS 20180328
'                            lefCL.detalle(i - 1).DescuentoPct = lCfe.Items(i).DescuentoMonto / (lefCL.detalle(i - 1).QtyItem * lefCL.detalle(i - 1).PrcItem) * 100
'                        Else
'                            lefCL.detalle(i - 1).DescuentoMonto = Round((lefCL.detalle(i - 1).QtyItem * lefCL.detalle(i - 1).PrcItem) - val(dbgLineas_Servicios.Columns("importe_sin_iva").text), 2)
'                            lefCL.detalle(i - 1).DescuentoPct = lCfe.Items(i).DescuentoMonto / (lefCL.detalle(i - 1).QtyItem * lefCL.detalle(i - 1).PrcItem) * 100
'                        End If
'                    End If
'                End If
'            End If
'
'            lefCL.detalle(i - 1).NmbItem = TamañoCadenaXML(lefCL.detalle(i - 1).NmbItem, 80)
'            lefCL.detalle(i - 1).TpoCodigo = TamañoCadenaXML(lefCL.detalle(i - 1).TpoCodigo, 10)
'            lefCL.detalle(i - 1).VlrCodigo = TamañoCadenaXML(lefCL.detalle(i - 1).VlrCodigo, 35)
'            lefCL.detalle(i - 1).UnmdItem = TamañoCadenaXML(lefCL.detalle(i - 1).UnmdItem, 4)
'            lefCL.detalle(i - 1).QtyItem = Format(lefCL.detalle(i - 1).QtyItem, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(CLng(txtCodDoc.text)))
'            lefCL.detalle(i - 1).PrcItem = Format(lefCL.detalle(i - 1).PrcItem, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(CLng(txtCodDoc.text), CLng(txtMoneda.text)))
'            lefCL.detalle(i - 1).DescuentoMonto = Round(lefCL.detalle(i - 1).DescuentoMonto, 0)
'            lefCL.detalle(i - 1).DescuentoPct = Format(lefCL.detalle(i - 1).DescuentoPct, "0.00")
'
'
'            dbgLineas_Servicios.MoveNext
'        Next i
'
'
'    End If
'
'    'CargoTotales
'
'
'
'
'
'    lefCL.totales.MntExe = 0
'    lefCL.totales.MntNeto = 0
'    lefCL.totales.iva = 0
'    lefCL.totales.TasaIVA = 0
'    'lefCL.totales.ImpAdicRet = 0
'    lefCL.totales.montoNF = 0
'    lefCL.totales.mntTotal = 0
'    lefCL.totales.TotalPeriodo = 0
'    lefCL.totales.SaldoAnterior = 0
'    lefCL.totales.VlrPagar = 0
'
'
'
'
'    For i = 1 To vsfImpuestos.Rows - 1
'         If val(vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA)) <> 0 Then
'             lefCL.totales.MntNeto = lefCL.totales.MntNeto + (val(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS))) '* (1 - (val(txtDtoGlobal.text) / 100))
'             lefCL.totales.iva = lefCL.totales.iva + (val(vsfImpuestos.TextMatrix(i, CGI_IVA))) '* (1 - (val(txtDtoGlobal.text) / 100))
'             lefCL.totales.TasaIVA = vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA)
'         Else
'             lefCL.totales.MntExe = lefCL.totales.MntExe + (val(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS))) '* (1 - (val(txtDtoGlobal.text) / 100))
'         End If
'    Next
'
'
'    For i = 0 To UBound(matIAdic)
'         If i = 0 Then
'             ReDim lefCL.totales.ImpAdicRet(0)
'         Else
'             ReDim Preserve lefCL.totales.ImpAdicRet(i)
'         End If
'         lefCL.totales.ImpAdicRet(i).TasaImp = matIAdic(i).TasaImp
'         lefCL.totales.ImpAdicRet(i).MontoImp = matIAdic(i).MontoImp
'         lefCL.totales.ImpAdicRet(i).TipoImp = matIAdic(i).TipoImp
'    Next
'
'    lefCL.totales.mntTotal = lefCL.totales.MntNeto + lefCL.totales.MntExe + lefCL.totales.iva + Round(importe_iadic, 0)
'    lefCL.totales.TotalPeriodo = lefCL.totales.mntTotal + lefCL.totales.montoNF
'    lefCL.totales.VlrPagar = lefCL.totales.mntTotal + lefCL.totales.SaldoAnterior
'
'    'Descuento globales
'
'    lin = 0
'    If val(txtDtoGlobal.text) <> 0 Then
'          If lefCL.totales.MntNeto <> 0 Then
'              If lin = 0 Then
'                  ReDim lefCL.DscRsgGlobal(0)
'              Else
'                  ReDim Preserve lefCL.DscRsgGlobal(UBound(lefCL.DscRsgGlobal) + 1)
'              End If
'              lin = lin + 1
'
'              lefCL.DscRsgGlobal(lin - 1).linea = lin
'              lefCL.DscRsgGlobal(lin - 1).Glosa = "Descuento General"
'              lefCL.DscRsgGlobal(lin - 1).TpoMov = "D"
'              lefCL.DscRsgGlobal(lin - 1).TpoValor = "%"
'              lefCL.DscRsgGlobal(lin - 1).valor = Format(Me.txtDtoGlobal.text, "0.00")
'              lefCL.DscRsgGlobal(lin - 1).IndExeDR = 0
'          End If
'          If lefCL.totales.MntExe <> 0 Then
'              If lin = 0 Then
'                  ReDim lefCL.DscRsgGlobal(0)
'              Else
'                  ReDim Preserve lefCL.DscRsgGlobal(UBound(lefCL.DscRsgGlobal) + 1)
'              End If
'              lin = lin + 1
'
'              lefCL.DscRsgGlobal(lin - 1).linea = lin
'              lefCL.DscRsgGlobal(lin - 1).Glosa = "Descuento General"
'              lefCL.DscRsgGlobal(lin - 1).TpoMov = "D"
'              lefCL.DscRsgGlobal(lin - 1).TpoValor = "%"
'              lefCL.DscRsgGlobal(lin - 1).valor = Format(Me.txtDtoGlobal.text, "0.00")
'              lefCL.DscRsgGlobal(lin - 1).IndExeDR = 1
'
'          End If
'          If lefCL.totales.montoNF <> 0 Then
'              If lin = 0 Then
'                  ReDim lefCL.DscRsgGlobal(0)
'              Else
'                  ReDim Preserve lefCL.DscRsgGlobal(UBound(lefCL.DscRsgGlobal) + 1)
'              End If
'              lin = lin + 1
'
'              lefCL.DscRsgGlobal(lin - 1).linea = lin
'              lefCL.DscRsgGlobal(lin - 1).Glosa = "Descuento General"
'              lefCL.DscRsgGlobal(lin - 1).TpoMov = "D"
'              lefCL.DscRsgGlobal(lin - 1).TpoValor = "%"
'              lefCL.DscRsgGlobal(lin - 1).valor = Format(Me.txtDtoGlobal.text, "0.00")
'              lefCL.DscRsgGlobal(lin - 1).IndExeDR = 2
'          End If
'    Else
'        ReDim lefCL.DscRsgGlobal(0)
'        lefCL.DscRsgGlobal(0).valor = 0
'
'    End If
'
'
'    ReDim lefCL.Referencias(0)
'    'AIR 20210906 se agrega referencia para las notas de debito que Efactura exige se envie alguna referencia o de lo contrario referencia global
'    If D!signo = 1 Or Trim(lstrTipoDoc) = "NDEBITO" Then
'        SQL = "SELECT fe.*, f.fec_doc,f.importe FROM faccmpefactura fe, faccmp f WHERE fe.cod_emp=" & val(txtEmpresa.text)
'        SQL = SQL & " AND fe.cod_doc=" & val(txtDoc_Afectado.text)
'        SQL = SQL & " AND fe.nro_doc=" & val(txtNro_Doc_Afectado.text)
'        SQL = SQL & " AND fe.nro_doc=f.nro_doc AND fe.cod_doc = f.cod_doc AND fe.cod_emp=f.cod_emp AND fe.cod_prov=f.cod_prov "
'        Set RE = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
'        If Not RE.EOF Then
'            lefCL.Referencias(0).tipoDoc = Trim(RE!TipoCAE)
'            lefCL.Referencias(0).Folio = Trim(RE!numero)
'            lefCL.Referencias(0).Fecha = Format(RE!fec_doc, "dd/mm/yyyy")
'            lefCL.Referencias(0).CodRef = BuscoCodRefCL(RE!Importe, val(txtImporte.text), CLng(txtDoc_Afectado.text), lstrTipoDoc)
'
'            lefCL.Referencias(0).linea = 1
'            lefCL.Referencias(0).RazonRef = "Afectacion"
'        End If
'
'    End If
'
'
'
'
'    Exit Sub
'
'Errores:
'
'End Sub
'
'
'
'
Sub Cargo_Datos_Seña(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim lrstSeña As Recordset

    SQL = "SELECT * from faccmppagos "
    SQL = SQL & " WHERE faccmppagos.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND faccmppagos.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND faccmppagos.Nro_Doc = " & plngNro_Doc
    SQL = SQL & " AND faccmppagos.cod_prov = " & val(txtCodProv.text)
    
    Set lrstSeña = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If Not lrstSeña.EOF Then
         
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODDOC) = lrstSeña!cod_doc
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_NRODOC) = lrstSeña!nro_doc
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODPROV) = lrstSeña!Cod_Prov
    
    Else
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODDOC) = ""
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_NRODOC) = ""
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODPROV) = ""
    End If

End Sub

Sub Cargo_Tipo_Documento_Identidad(pTitular As Long)
On Error GoTo Errores
Dim R As Recordset

If Buscar_Cliente(pTitular, R) Then

        If Trim(R!ruc_cli) <> "" Then
            If (ConfFormato_Factura = "BARATILLO") And R!nro_cli < 1000 And frmPunto_Venta.pstrTipo_Ingreso_Documentos = "M" Then
                txtTipo_Doc_Identidad.text = "3"
                glngTipo_Documento_Identidad = 3
            Else
                txtTipo_Doc_Identidad.text = "2"
                glngTipo_Documento_Identidad = 2
                TxtRuc.text = Trim(R!ruc_cli)
            End If
        Else
            ' Veo si no se puede poner la CI
            If Trim(R!ci_contacto) <> "" Then
                txtTipo_Doc_Identidad.text = "3"
                glngTipo_Documento_Identidad = 3
                TxtRuc.text = Trim(R!ci_contacto)
            Else
                'Si queda en blanco y no tiene ci/rut, va 0tros
                If Trim(txtTipo_Doc_Identidad.text) = "" Then
                    txtTipo_Doc_Identidad.text = "4"
                    glngTipo_Documento_Identidad = 4
                    TxtRuc.text = Trim(R!otro_doc_identidad_cli)
                    
                End If
            End If
        End If
Else
    txtTipo_Doc_Identidad.text = "4"
    glngTipo_Documento_Identidad = 4
End If

Exit Sub
Errores:
    MsgBox "Error en el Tipo de Documento de Identidad, se Define el Valor Predeterminado 4"
    txtTipo_Doc_Identidad.text = "4"
    glngTipo_Documento_Identidad = 4
End Sub


Function ControlDescuentosGeneral(argCampo As String) As Boolean

      Dim pdblPrecioConDtos As Double
      Dim i As Long
      Dim pstrLista As String
      Dim ldblTotal_Descuentos As Double
      Dim ldblDtoMaximo As Double
    
      On Error GoTo Errores
      
      
      
      ControlDescuentosGeneral = True
      
      'If Me.txtDtoGlobal.text = 0 Then
      '    Exit Function
      'End If
          
      If gCargoDesdeF = True Then
            Exit Function
      End If
      
      
      For i = 1 To vsfLineas_Mercaderia.Rows - 1
      
         If (Trim(UCase(argCampo)) = Trim(UCase("txtLista")) Or Trim(UCase(argCampo)) = Trim(UCase("txtcodprov"))) Then
              lPrecioMinimo = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), val(Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))), val(txtCodProv.text), val(txtCodDoc.text), val(txtLista.text), txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ldblDtoMaximo)
          Else
              lPrecioMinimo = vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_MINIMO)
          End If
          
      
       
          pstrLista = Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1)) & ";"
          pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2)) & ";"
          pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3)) & ";"
          pstrLista = pstrLista & Trim(Me.txtDtoGlobal.text)
        
          ldblTotal_Descuentos = CalculoDtoTotal(pstrLista)
          
          If confUsaEquivalenciaMagnitudes Then
             pdblPrecioConDtos = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD)) * (1 - (ldblTotal_Descuentos / 100))
          Else
             pdblPrecioConDtos = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)) * (1 - (ldblTotal_Descuentos / 100))
          End If
            
          'jch 19092022 controlo que los descuentos no se vayan acumulando
          If pdblPrecioConDtos < lPrecioMinimo Then
               
               MsgBox "Los Descuentos a Aplicar, Superan el Descuento Maximo aceptado, en el articulo " & Trim(CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))), vbCritical + vbOKOnly
               ControlDescuentosGeneral = False
          End If
      Next
      
      If Not ControlDescuentosGeneral Then
          If Not YaAutorizadoDescuento() Then
              If Autorizacion_Supervision(6, 4, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                  Call UnificaAutorizacionDescuento
                  ControlDescuentosGeneral = True
              End If
          Else
              ControlDescuentosGeneral = True
          End If
      End If
      
      
      If Not ControlDescuentosGeneral Then
           If Trim(UCase(argCampo)) = Trim(UCase("txCodProv")) Then
                 txtCodProv.text = plngCliente_Anterior
           End If
           If Trim(UCase(argCampo)) = Trim(UCase("txtLista")) Then
                txtLista.text = plngNroLista_Anterior
           End If
      End If
       
      For i = 1 To vsfLineas_Mercaderia.Rows - 1
           If ControlDescuentosGeneral And (Trim(UCase(argCampo)) = Trim(UCase("txtLista")) Or Trim(UCase(argCampo)) = Trim(UCase("txtcodprov"))) Then
                lPrecioMinimo = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), val(Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))), val(txtCodProv.text), val(txtCodDoc.text), val(txtLista.text), val(txtMoneda.text), CDbl(txtTipo_Cambio.text), CDate(txtFec_Doc.text), ldblDtoMaximo)
                vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_MINIMO) = lPrecioMinimo
           End If
           Call Calcular_Importes_de_la_Linea_Mercaderia(i, False, True)
      Next
      If Not ControlDescuentosGeneral Then
          If Trim(UCase(argCampo)) = Trim(UCase("txCodProv")) Then
                Call txtCodProv_LostFocus
                 
           End If
           If Trim(UCase(argCampo)) = Trim(UCase("txtLista")) Then
                Call txtLista_LostFocus
           End If
      End If
      
      
       
        
      Exit Function
        
      
Errores:
      
      
End Function







Private Function ControlDtos(argRow As Long) As Boolean

   Dim porcentaje As Double
   Dim P As Recordset
   Dim L As Recordset
   Dim lrstMag As Recordset
   
   Dim dto1 As Double
   Dim dto2 As Double
   Dim dto3 As Double
   Dim DtoL As Double
   Dim lequivalencia As Double
   Dim lCantidad As Double
   Dim ubi As Integer
   Dim pstrLista As String
   Dim Precio As Double
   
   Dim lTipoDoc As Registro_Tipo_Documentos
   
   
   
   
   
   
   
   On Error GoTo Errores
   
        ControlDtos = True
        
        
        If gCargoDesdeF = True Then
            Exit Function
        End If
        
        
        lCantidad = 0
        
        If Trim(ConfPuntoVta_Controla_Dtos) <> "S" Or Trim(UCase(confSistemaControlDtos)) = Trim(SistemaControlDtos_General) Then
            Exit Function
        End If
        ubi = 0
        
        
        Precio = ObtenerPrecioBase(val(txtEmpresa.text), val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_CODIGO)), val(txtCodProv.text), val(txtCodDoc.text), val(txtLista.text), val(txtMoneda.text), val(txtTipo_Cambio.text), CDate(txtFec_Doc.text))
        
        If Busco_Tipo_Documento(val(txtCodDoc.text), lTipoDoc) Then
        End If
                
        
        
        If Buscar_Articulo(CLng(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_CODIGO)), P) Then
        End If
        
        
        If lTipoDoc.exportacion = "S" And confPuntoVta_Precio_Sin_Impuestos_Exportacion Then
             porcentaje = Porcentaje_Impuesto_Vigente("IVA", P!cod_iva, CDate(Me.txtFec_Doc.text))
             Precio = (Precio / (100 + porcentaje)) * 100
        End If
        
        
         
        
        If Buscar_Equivalencia(P!Cod_Prod, P!magnitud, vsfLineas_Mercaderia.TextMatrix(argRow, CGL_MAGNITUD), lrstMag) Then
            lequivalencia = lrstMag!val_equivalencia
        Else
            lequivalencia = 1
        End If
        If confUsaEquivalenciaMagnitudes Then
             Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, Precio)
        End If
        
        
        
        If confUsaEquivalenciaMagnitudes Then
            DtoL = Round((Precio - val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_PUNITARIO_MAGNITUD))) / Precio * 100, 2)
        Else
            DtoL = Round((Precio - val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_PUNITARIO))) / Precio * 100, 2)
        End If
        
        
        
        dto1 = CDbl(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO1))
        dto2 = CDbl(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO2))
        dto3 = CDbl(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO3))
        porcentaje = 0
        
        
        If vsfLineas_Mercaderia.EditText <> "" Then
            Select Case vsfLineas_Mercaderia.Col
               Case CGL_DTO1
                   dto1 = CDbl(vsfLineas_Mercaderia.EditText)
                   ubi = 1
               Case CGL_DTO2
                    dto2 = CDbl(vsfLineas_Mercaderia.EditText)
                    ubi = 2
               Case CGL_DTO3
                    dto3 = CDbl(vsfLineas_Mercaderia.EditText)
                    ubi = 3
        
            End Select
        End If
        
        
   
        pstrLista = Trim(DtoL) & ";"
        pstrLista = pstrLista & Trim(dto1) & ";"
        pstrLista = pstrLista & Trim(dto2) & ";"
        pstrLista = pstrLista & Trim(dto3) & ";"
        pstrLista = pstrLista & Trim(Me.txtDtoGlobal.text)
        
        porcentaje = CalculoDtoTotal(pstrLista)
        
        
       
        If porcentaje > val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DESCUENTO_MAXIMO)) And val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DESCUENTO_MAXIMO)) <> 0 Then
            
            MsgBox "Los descuentos acumulados supera el % maximo de descuento aceptado en el artíulo " & Trim(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_CODIGO)) & " que es " & Trim(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DESCUENTO_MAXIMO)) & "%", vbInformation, MsgTit
            
            If Autorizacion_Supervision(6, 4, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                 Exit Function
            Else
                 pstrLista = Trim(DtoL) & ";"
                 pstrLista = pstrLista & Trim(txtDtoGlobal.text) & ";"
                 pstrLista = pstrLista & Trim(IIf(ubi = 1, 0, dto1)) & ";"
                 pstrLista = pstrLista & Trim(IIf(ubi = 2, 0, dto2)) & ";"
                 pstrLista = pstrLista & Trim(IIf(ubi = 3, 0, dto3))
            
                 porcentaje = CalculoDtoFinal(val(vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DESCUENTO_MAXIMO)), CalculoDtoTotal(pstrLista))
                 If ubi <> 0 Then
                    vsfLineas_Mercaderia.EditText = porcentaje
                 End If
        
                 Select Case ubi
                     Case 1
                         vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO1) = Format(porcentaje, "0.00")
                     Case CGL_DTO2
                         vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO2) = Format(porcentaje, "0.00")
                     Case 3
                         vsfLineas_Mercaderia.TextMatrix(argRow, CGL_DTO3) = Format(porcentaje, "0.00")
                     Case 0
                         txtDtoGlobal.text = Format(porcentaje, "0.00")
                 End Select
            
                  
            End If
        
        End If
            
            'ControlDtos = True
            
        Exit Function
        
        
        
   
         
   
   
   Exit Function
   
   
Errores:
   




End Function


Public Sub EjecutarEventos(ByVal pstrNomObj As String, ByVal pstrNomEvento As String, Optional KeyCode As Integer = vbKeyReturn)


      Call Cargo_Logtrans("obj:" & Trim(pstrNomObj) & " even:" & Trim(pstrNomEvento) & " key:" & Trim(KeyCode))

      gbooErrorRobot = False
      
      If Trim(pstrNomObj) = "txtCodSuc" And Trim(pstrNomEvento) = "GotFocus" Then
          Call TxtCodSuc_GotFocus
      End If

      If Trim(pstrNomObj) = "txtCodSuc" And Trim(pstrNomEvento) = "KeyDown" Then
          Call TxtCodSuc_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtCodSuc" And Trim(pstrNomEvento) = "LostFocus" Then
          Call TxtCodSuc_LostFocus
      End If
      
      
      
      If Trim(pstrNomObj) = "txtDtoGlobal" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtDtoGlobal_GotFocus
      End If

      If Trim(pstrNomObj) = "txtDtoGlobal" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtDtoGlobal_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtDtoGlobal" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtDtoGlobal_LostFocus
      End If
      

      If Trim(pstrNomObj) = "txtCodDoc" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtCodDoc_GotFocus
      End If

      If Trim(pstrNomObj) = "txtCodDoc" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtCodDoc_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtCodDoc" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtCodDoc_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtDoc" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtDoc_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtDoc" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtDoc_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtDoc" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtCodDoc_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtRuc" And Trim(pstrNomEvento) = "GotFocus" Then
          Call TxtRuc_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtRuc" And Trim(pstrNomEvento) = "KeyDown" Then
          Call TxtRuc_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtRuc" And Trim(pstrNomEvento) = "LostFocus" Then
          Call TxtRuc_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtMoneda" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtMoneda_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtMoneda" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtMoneda_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtMoneda" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtMoneda_LostFocus
      End If
      
      If Trim(pstrNomObj) = "cmdGuardar" And Trim(pstrNomEvento) = "Click" Then
          Call cmdGuardar_Click
      End If

      If Trim(pstrNomObj) = "MAlta" And Trim(pstrNomEvento) = "Click" Then
          Call MAlta_Click
      End If
      
      
      If Trim(pstrNomObj) = "txtLista" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtLista_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtLista" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtLista_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtLista" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtLista_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtCodProv" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtCodProv_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtCodProv" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtCodProv_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtCodProv" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtCodProv_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtVendedor" And Trim(pstrNomEvento) = "GotFocus" Then
          Call TxtVendedor_GotFocus
         
      End If
      
      If Trim(pstrNomObj) = "txtVendedor" And Trim(pstrNomEvento) = "KeyDown" Then
          Call TxtVendedor_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtVendedor" And Trim(pstrNomEvento) = "LostFocus" Then
          Call TxtVendedor_LostFocus
      End If
      
      If Trim(pstrNomObj) = "txtForma_Pago" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtForma_Pago_GotFocus
         
      End If
      
      If Trim(pstrNomObj) = "txtForma_Pago" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtForma_Pago_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtForma_Pago" And Trim(pstrNomEvento) = "LostFocus" Then
          Call txtForma_Pago_LostFocus
      End If
     
      
      If Trim(pstrNomObj) = "txtFec_Vencimiento" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtFec_Vencimiento_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtFec_Vencimiento" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtFec_Vencimiento_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "txtLector" And Trim(pstrNomEvento) = "GotFocus" Then
          Call txtLector_GotFocus
      End If
      
      If Trim(pstrNomObj) = "txtLector" And Trim(pstrNomEvento) = "KeyDown" Then
          Call txtLector_KeyDown(KeyCode, 0)
      End If
      
      If Trim(pstrNomObj) = "vsfMedios_Pagos" And Trim(pstrNomEvento) = "GotFocus" Then
          Call vsfMedios_Pagos_GotFocus
      End If
      
      If gbooErrorRobot Then
          gbooErrorRobot = gbooErrorRobot
      End If
      

End Sub

Public Function Enviar_Documento_a_eFactura(pstrId As String) As Boolean

        Select Case Trim(UCase(confPais))
            Case "UY"
                Enviar_Documento_a_eFactura = Enviar_Documento_a_eFactura_UY(pstrId)
                
            Case "CL"
                Enviar_Documento_a_eFactura = Enviar_Documento_a_eFactura_CL(pstrId)
            
        End Select


End Function

Sub Ingreso_Datos_Adic_FE()
   
     Select Case LTrim(UCase(confPais))
         Case "CL"
              Load frmPunto_Venta_Datos_Adic_Fact
              If frmPunto_Venta_Datos_Adic_Fact.pbooAltas Then
                  frmPunto_Venta_Datos_Adic_Fact.Show vbModal
              Else
                  Unload frmPunto_Venta_Datos_Adic_Fact
              End If
         Case Else
              gDAdicFE.Aceptado = True
         
              
              
     End Select
     
     

End Sub

Sub Ingreso_Datos_Auxiliares_del_Resguardo(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, plngLinea As Long, pstrObservacion As String, pstrNombre_Tabla_Temporal As String)



    lstrSQL = "DELETE FROM " & Trim(pstrNombre_Tabla_Temporal)
    lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
    lstrSQL = lstrSQL & " AND cod_doc = " & plngCod_Doc
    lstrSQL = lstrSQL & " AND nro_doc = " & plngNro_Doc
    lstrSQL = lstrSQL & " AND cod_prov = " & plngCod_Prov
    lstrSQL = lstrSQL & " AND linea = " & plngLinea

    Dbs.Execute lstrSQL

    lstrSQL = "INSERT INTO " & Trim(pstrNombre_Tabla_Temporal)
    lstrSQL = lstrSQL & " VALUES ("
    lstrSQL = lstrSQL & plngCod_Emp & ","
    lstrSQL = lstrSQL & plngCod_Doc & ","
    lstrSQL = lstrSQL & plngNro_Doc & ","
    lstrSQL = lstrSQL & plngCod_Prov & ","
    lstrSQL = lstrSQL & plngLinea & ","                                                     ' linea de la faccmpservicios
    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ",'"               ' fecha vencim

    lstrSQL = lstrSQL & pstrObservacion & "',"                                         ' observacion
    lstrSQL = lstrSQL & "1" & ","                                                           ' linea
    lstrSQL = lstrSQL & "0" & ")"                                                           ' Unidades

    Dbs.Execute lstrSQL

End Sub

Public Sub Proceso_Alta()
On Error GoTo Errores
Dim e As Recordset
Dim R As Recordset

    gBolTodosLosDescuentos = False
    gGuardando_Documento = False
    yaAutorizado = False
    lNombre_Tabla_Temporal = ""
    gstrUltimo_Nro_Autorizacion_Tarjeta = ""
    gbolProceso_Tarjeta = False        'SS 20181224
    
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    glngTipo_Documento_Identidad = 2
    gstrDocumento_Identidad = ""
    gstrDireccion = ""
    gstrTelefonos = ""
    glngCod_Pais = 0
    glngCod_Departamento = 0
    glngCod_Ciudad = 0
    gstreMail = ""
    glngCod_Grupo = 0
    
    glngCod_Doc_Preventa = 0
    glngNro_Doc_Preventa = 0
    glngCod_Cliente_Preventa = 0
    gstrTabla_Temporal_Preventa = ""
    gstrTabla_Temporal_Cotizaciones = ""
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0

    sspCantidad_Lineas.Caption = "0"
            
    sspOperacion.visible = True
    
    Call Habilitar_Deshabilitar_Controles(Me, True)
    
    cmdEntrega.Enabled = False

    Call Limpiar_Controles(Me)
    sspOperacion.Caption = "A"

    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    

    labTope_Credito_Moneda.Caption = ""
    labTope_Credito.Caption = ""
    labSaldo_Credito_Moneda.Caption = ""
    labSaldo_Credito.Caption = ""
    
    labTope_Credito_Moneda.BackColor = &HE0E0E0
    labTope_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.BackColor = &HE0E0E0
    labSaldo_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.FontBold = False
    labSaldo_Credito.FontBold = False
    
    lbDisplay.Caption = ""
    
    txtFec_Doc.text = Format(date, "dd/mm/yyyy")
    
    If Trim(txtEmpresa.text) = "" Then
        If Buscar_Empresa(gCodigo_Empresa, e) Then
            txtEmpresa.text = gCodigo_Empresa
            txtNom_Empresa.text = Trim(e!Descripcion)
            Select Case Trim(UCase(e!mod_fecha_facturador))
                Case "S"
                    txtFec_Doc.Locked = False
                Case "N"
                    txtFec_Doc.Locked = True
                Case "C"
                    txtFec_Doc.Locked = False
                    txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
            End Select
            txtDeposito.text = Trim(e!Deposito)
            
        Else
            MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
            Call Limpiar_Controles(Me)
            lbDisplay.Caption = ""
        End If
    End If
    
    nro_doc_Wis = ""
    camion_Wis = ""
    gbolCargo_Desde_WIS = False
    gbolCargo_Desde_Preventa = False
    gbln_Cargo_Datos_Desde_F10 = False
    gbln_Articulo_de_F10 = False
    
    If pstrTipo_Ingreso_Documentos = "M" Then
        If ConfPuntoVta_Moneda_x_Defecto_DMercaderia <> 0 Then
            txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DMercaderia
            glngAnterior_Moneda = val(txtMoneda.text)
        End If
    End If
    
    If pstrTipo_Ingreso_Documentos = "S" Then
        If ConfPuntoVta_Moneda_x_Defecto_DServicio <> 0 Then
            txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DServicio
            glngAnterior_Moneda = val(txtMoneda.text)
        End If
    End If
    
    txtCta_Madre.text = "0"
    txtDtoGlobal.text = Format(ConfPuntoVta_Descuento_Global_x_Defecto, "0.00")
    
    txtCaja.text = ConfPuntoVta_Nro_Caja
    TxtFecReg.text = Format(date, "dd/mm/yyyy")
    txtUsuario.text = UCase(Trim(gUsuario))
    sspTiene_Remitos_Pendientes.visible = False
    frameVencimientos_Cuotas.visible = False
    Imagen_Producto.visible = True
    txtLista.Locked = False
    
    gAutorizacionUnificada = False

    If Inicializar_Valores_x_Campos_Programa_Empresa(gCodigo_Empresa, plngCod_Programa, 0, lcolCampos) Then
    End If
    
    Call Visualizar_Campos_Formulario
    
    Call Bloquear_Campos_Formulario

    Call Verifico_Documento_Cancelado
    
    Call Posiciono_en_Pantalla
        
  'AIR 20250218
    txtAcopio.text = 0
    txtDescripcion_Acopio = "SIN ACOPIO ASIGNADO"
    gBusqueda_Doc_Pendientes_Formato = ""
    
    cmdGuardar.Enabled = False
Exit Sub
Errores:
    Call FErrores

End Sub

Public Sub Proceso_Consulta(PLlamadoExterno As Boolean, pEmpresa As Long, pCodDoc As Long, pNroDoc As Long, pCodProv As Long)
'AIR 11/11/2015 se cambio el codigo del metodo mconsulta a este proceso para llamarlo externamente

Dim e As Recordset

    gBolTodosLosDescuentos = False
    nro_doc_Wis = ""
    camion_Wis = ""
    gGuardando_Documento = False
    yaAutorizado = False
    lNombre_Tabla_Temporal = ""
    gstrUltimo_Nro_Autorizacion_Tarjeta = ""
    gbolProceso_Tarjeta = False        'SS 20181224
    
    sspCantidad_Lineas.Caption = "0"
    gbolCargo_Desde_WIS = False
    gbolCargo_Desde_Preventa = False
    pbolCargo_Desde_Movil = False
    
    sspOperacion.visible = True
    sspOperacion.Caption = "C"
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    
    txtLista.Locked = False
    Call Habilitar_Deshabilitar_Controles(Me, True)
    
    cmdEntrega.Enabled = False
    
    Call Limpiar_Controles(Me)
    
    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    
    
    labTope_Credito_Moneda.Caption = ""
    labTope_Credito.Caption = ""
    labSaldo_Credito_Moneda.Caption = ""
    labSaldo_Credito.Caption = ""
    
    labTope_Credito_Moneda.BackColor = &HE0E0E0
    labTope_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.BackColor = &HE0E0E0
    labSaldo_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.FontBold = False
    labSaldo_Credito.FontBold = False
    
    lbDisplay.Caption = ""
    
    txtFec_Doc.text = Format(date, "dd/mm/yyyy")
    If Buscar_Empresa(gCodigo_Empresa, e) Then
        txtEmpresa.text = gCodigo_Empresa
        txtNom_Empresa.text = Trim(e!Descripcion)
        Select Case Trim(UCase(e!mod_fecha_facturador))
            Case "S"
                txtFec_Doc.Locked = False
            Case "N"
                txtFec_Doc.Locked = True
            Case "C"
                txtFec_Doc.Locked = False
                txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
        End Select
    Else
        MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
        Call Limpiar_Controles(Me)
        lbDisplay.Caption = ""
    End If
    
    ' AIR 20160620
    
    If Inicializar_Valores_x_Campos_Programa_Empresa(gCodigo_Empresa, plngCod_Programa, 0, lcolCampos) Then
    End If
    
    Call Visualizar_Campos_Formulario
    
    Call Bloquear_Campos_Formulario

    ' FIN AIR
    
    
    Call Posiciono_en_Pantalla
    
    If PLlamadoExterno Then
        txtEmpresa.text = pEmpresa
        txtCodDoc.text = pCodDoc
        txtDoc.text = pNroDoc
        txtCodProv.text = pCodProv
            
        Call txtCodDoc_GotFocus
        DoEvents
        Call txtCodDoc_LostFocus
        DoEvents
        Call txtDoc_GotFocus
        DoEvents
        Call txtDoc_LostFocus
        DoEvents
        Call txtCodProv_LostFocus
        DoEvents
        Call txtMoneda_LostFocus
        DoEvents
        Sendkeys "{ENTER}"
        
        DoEvents
        Call Lock_UnLock_Controles(Me, True)
        DoEvents
            
        MAlta.Enabled = False
        MBaja.Enabled = False
        MModificacion.Enabled = False
        MListar.Enabled = False
        MAutorizar.Enabled = False
        MConsulta.Enabled = False
        MReimpresion.Enabled = False
       'MControl_Costo.Enabled = False
        MCambios.Enabled = False
        MVer_Asiento_Contable.Enabled = False
        MCalculadora.Enabled = False
        
            
    End If
    
End Sub



'AIR 20191212 se pasa la funcion al modulo de Funciones
'Function sacoCodigoPaisDGI(pstrTexto As String) As String


Public Sub Busqueda_Documentos_Cuotas_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lTipo_Doc As String, lSigno As Integer, lGrilla As String, lMoneda As Long)
Dim lstrCod_Doc_Afectar As String

    lstrCod_Doc_Afectar = "Faccmp.autorizado='S' and Faccmp.cod_doc in (Select cod_doc From documentos "
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Where tipo_doc = '" & UCase(Trim(lTipo_Doc)) & "'"
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And signo = " & lSigno
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " and tipo_estado_cta='C' "
        
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " and cod_doc not in (" & ConfDoc_Ruptura & ",498))"
    
    frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
    frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
    frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
    frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
    frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
    frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
    frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
    frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
    frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
    frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
    
    'AIR 20200819
    frmBusqueda_Documentos_a_Afectar.pglngSucursal = 0
    frmBusqueda_Documentos_a_Afectar.Show vbModal

End Sub
Function controlarLineas(pCodDoc As Integer) As Boolean
controlarLineas = True
If pCodDoc <> 101 Then
    If ConfProceso_Productos_WIS = "CLON" And pCodDoc = ConfDoc_Ingreso_Pedido_Cli Then
        controlarLineas = False
    Else
        controlarLineas = True
    End If
Else
    controlarLineas = False
End If
End Function

Public Sub Cargo_Clase_CFE_UY(D As Recordset, pstrId As String)
On Error GoTo Errores
Dim lrstObservacion As Recordset
Dim A As Recordset
Dim C As Recordset
Dim e As Recordset
Dim F As Recordset
Dim M As Recordset
Dim R As Recordset
Dim V As Recordset
Dim TE As Recordset

Dim e1 As Recordset
Dim Z As Recordset
Dim FP As Recordset
Dim RE As Recordset
Dim RDESC As Recordset
Dim DOC As Recordset
Dim DOC_AUX As Recordset
Dim lrstSucursal As Recordset
Dim lrstInsServ As Recordset
Dim lrstRetenciones As Recordset
Dim lrstTotRet As Recordset
Dim lrstTotalDet As Recordset
Dim lrstClientes As Recordset
Dim lrstArticulos As Recordset
Dim lrstGarantias As Recordset
Dim FLinArtCod As Recordset
Dim lrstFuncionarios As Recordset
Dim lrstAgencias As Recordset
Dim lrstDocReferencia As Recordset
Dim lrstMagnitudes As Recordset
Dim lrstMonedas As Recordset
Dim lrstDocImpuestos As Recordset
Dim lrstTitular As Recordset
Dim lrstPais As Recordset
Dim lrstLinMercaderia As Recordset   ' AIR 20201015
Dim lrstProv As Recordset       ' AIR 20210406

Dim lintOrdenAdenda, ldigit_calculado As Integer
Dim lcantlinserv As Integer
Dim i As Integer
Dim sigo As Integer
Dim lstrMensaje_Dto_Contado As String
Dim ldblImporte_Con_Dto_Contado As Double
Dim lstrMensaje_Conforme_L1 As String
Dim lstrMensaje_Conforme_L2 As String
Dim lstrMensaje_Conforme_L3 As String
Dim lstrMensaje_Conforme_L4 As String
Dim lstrMensaje_Conforme_L5 As String
Dim lstrMensaje_Conforme_L6 As String
Dim lstrImporte_en_Letras As String
Dim lstrDecimales_en_Letras As String
Dim ldblPorcentaje_Compensatorio As Double
Dim ldblPorcentaje_Interes_Mora As Double
Dim lstrZona As String
Dim ldblImporte_Sin_Iva As Double
Dim llngAdministrador As Long
Dim lstrFuncionario As String
Dim llngCod_AgenciaEnvio  As Long
Dim lstrAgenciaEnvio As String
Dim lstrHorarioCliente As String
Dim lstrDsctos_Linea As String
Dim lstrNombre_Suc As String
Dim lstrTipoDoc As String

Dim ldblTotalNoGrv As Double
Dim ldblTotalNetoIvaTasaMin As Double
Dim ldblTotalIVATasaMin As Double
Dim ldblTotalNetoIvaTasaBasica As Double
Dim ldblTotalIVATasaBas As Double
Dim ldblTotalNetoIVAOtra As Double
Dim ldblTotalIVAOtra As Double
Dim ldblTotalIVASuspenso As Double
Dim ldblTotalImptoPercibido As Double
Dim ldblRedondeo As Double
Dim ldblSaldo_Estado_CuentaMonBase As Double
Dim ldblSaldo_Estado_CuentaMonRef As Double

Dim lstrSQL As String

Dim Filenum As Integer                      ' AIR 20190827
Dim lstrNombre_Archivo As String            ' AIR 20190827
Dim lstrRutaRepositorioFirmas  As String    ' AIR 20190827
Dim bArray() As Byte                        ' AIR 20180827
Dim lstrByte As String                      ' AIR 20190827

Dim lblnasignaGenerico As Boolean           ' AIR 20191212
Dim lstrDescripcion_Corta As String         ' AIR 20210617

Dim RM As Recordset                         'JCH 20220617
Dim RD As Recordset                         'JCH 20220617
Dim llngMagnitud As Long
Dim ldblsinimp1 As Double                   ' AIR 20220801
Dim ldblIVA1    As Double                   ' AIR 20220801

Dim lstrDocs As String                      'AIR 20230615

    'CAE        -----------------------------------------------------------------------------------------------------------------------
    
    ' AIR 20250307 se vuelve a cargar la variable de config -se dio en Cifer que al parecer este valor se revertia y no tomaba la config del tipo de documento.
    If IsNull(D!precios_impuestos_incluidos) Then
        If Buscar_Variable_Global("PuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos", V) Then
            ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = Trim(V!valor)
        End If
    Else
        ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = f_paso_S_N_a_Boolean(D!precios_impuestos_incluidos)
    End If
               
  
     If D!documento_eFactura = "S" Then
        If Trim(D!Autorizar) = "S" Then
            If Trim(UCase(sspOperacion.Caption)) <> "U" Then
                ' JE 20170703   /   Es un documento que hay que autorizar por lo tanto es de SIMULACION
                '                   No llamo a la rutina de obtengoCAE
            Else
                ' JE 20170703   /   Documento No Autorizado Previamente y esta en estado SIMULACION y ahora la operacion es de AUTORIZAR
                lCfe = obtengoCAE(fComprobanteTipo(val(txtCodDoc.text), Trim(txtTipo_Doc_Identidad.text)), val(txtEmpresa.text))
            End If
        Else
            ' JE 20170703   /   Documento ya autorizado
            lCfe = obtengoCAE(fComprobanteTipo(val(txtCodDoc.text), Trim(txtTipo_Doc_Identidad.text)), val(txtEmpresa.text))
        End If
    Else
        lCfe = envioCAEContingencia(fComprobanteTipo(val(txtCodDoc.text), Trim(txtTipo_Doc_Identidad.text)), val(txtEmpresa.text), Trim(txtSerie_Contingencia.text), val(txtDoc.text), Trim(txtAutorizacion_Contingencia.text)) ' SS 20160118
    End If
    
    If Trim(D!Autorizar) = "S" Then
        If Trim(UCase(sspOperacion.Caption)) <> "U" Then
            ' JE 20170703   /   Es un documento que hay que autorizar por lo tanto es de SIMULACION
            '                   No controlo que no tenga numero de Cae, porque justamente no se llamo para Solicitarlo
        Else
            ' JE 20170703   /   Es un documento que hay que autorizar por lo tanto es de SIMULACION
            '               /   Estoy en la Operacion de Autorizacion por lo tanto llame al ObtenerCAE y controlo que tenga el CAE asignado
            If lCfe.cae.numero = 0 Then
                Exit Sub
            End If
        End If
    Else
        If lCfe.cae.numero = 0 Then
            Exit Sub
        End If
    End If
    
    If Not Buscar_Empresa(gCodigo_Empresa, e) Then
        MsgBox "Error en la Configuracion de la Empresa", vbCritical, MsgTit
        lCfe.cae.numero = 0
        Exit Sub
    End If
     
    'Control del codigo de moneda para Facturacion Electronica  SS 20190515
    If Not Buscar_Moneda(val(txtMoneda.text), lrstMonedas) Then
        MsgBox "Error: No existe definida la Moneda", vbCritical, MsgTit
        lCfe.cae.numero = 0
        Exit Sub
    Else
        If lrstMonedas!codigo_DGI_eFactura = "" Then
            MsgBox "Error: No existe definido el Codigo para Facturacion Electronica de la Moneda del Documento", vbCritical, MsgTit
            lCfe.cae.numero = 0
            Exit Sub
        End If
    End If
        
    'Se define el tipo de documento     SS 20190411
    lstrTipoDoc = BuscoTipoDoc(D, "")

    
    'Los REMITOS no llevan importes y los RESGUARDOS no llevan redondeo
    If lstrTipoDoc = "REMITO" Or lstrTipoDoc = "ANULA REMITO" Or lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
        ldblRedondeo = 0
    Else
        ldblRedondeo = val(txtRedondeo.text)
    End If

    Call Cargo_Clase_CFE_UY_2(D, pstrId, e, lrstMonedas, lstrTipoDoc, ldblRedondeo)
    
    
    'TOTALES    -----------------------------------------------------------------------------------------------------------------------
    
    '  AIR 20201015
    If pstrTipo_Ingreso_Documentos <> "S" Then
        If Trim(gstrTabla_Temporal_Lineas_Mercaderia) <> "" Then
            SQL = "SELECT * FROM " & gstrTabla_Temporal_Lineas_Mercaderia
            SQL = SQL & " WHERE Id = " & CDbl(pstrId)
            SQL = SQL & " AND cod_emp = " & val(txtEmpresa.text)
            SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
            SQL = SQL & " AND nro_doc = " & val(txtDoc.text)
            SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
            SQL = SQL & " ORDER BY linea "
            'SQL = SQL & " ORDER BY cod_prod "
            
            Set lrstLinMercaderia = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            
            If lrstLinMercaderia.EOF Then
                MsgBox "Error: No existe registros para las Lineas de Mercaderia", vbCritical, MsgTit
                lCfe.cae.numero = 0
                Exit Sub
            End If
        Else
            MsgBox "Error: No existe archivo para las Lineas de Mercaderia", vbCritical, MsgTit
            lCfe.cae.numero = 0
            Exit Sub
        End If
    End If
    
    If pstrTipo_Ingreso_Documentos = "S" Then   ' SS 20160707
        If ldblRedondeo = 0 Then
            lCfe.totales.cantLinDet = dbgLineas_Servicios.Rows          ' NO suma por la linea de redondeo  SS 20190122
        Else
            lCfe.totales.cantLinDet = dbgLineas_Servicios.Rows + 1      ' suma 1 por la linea de redondeo
        End If
    Else
        If ldblRedondeo = 0 Then
            lCfe.totales.cantLinDet = lrstLinMercaderia.RecordCount  ' vsfLineas_Mercaderia.Rows - 1     ' resta 1 por la linea de redondeo
        Else
            lCfe.totales.cantLinDet = lrstLinMercaderia.RecordCount + 1 ' vsfLineas_Mercaderia.Rows         ' no suma porque ya incluye la linea de redondeo
        End If
    End If
        
    If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" And lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then
        
        'lCfe.totales.tpoMoneda = IIf(Val(txtMoneda.text) = 1, "UYU", "USD")
        lCfe.totales.TpoMoneda = Trim(lrstMonedas!codigo_DGI_eFactura)          'SS 20190515
        
        'Se busca los impuestos del documento en relacion con el codigo de Indicador de E Factura       'SS 20190524
        'El cod_impuesto es el codigo utilizado por SISNET / codigo_efactura_uruguay es el codigo en Facturacion Electronica (el Indicador)
        
        ldblTotalNoGrv = 0
        ldblTotalNetoIvaTasaMin = 0
        ldblTotalIVATasaMin = 0
        ldblTotalNetoIvaTasaBasica = 0
        ldblTotalIVATasaBas = 0
        ldblTotalNetoIVAOtra = 0
        ldblTotalIVAOtra = 0
        ldblTotalIVASuspenso = 0
        ldblTotalImptoPercibido = 0
        
        lstrSQL = "SELECT FaccmpImpuestos.cod_impuesto, Impuestos.codigo_efactura_uruguay "
        lstrSQL = lstrSQL & " FROM FaccmpImpuestos "
        lstrSQL = lstrSQL & " INNER JOIN Impuestos ON Impuestos.cod_tipo_impuesto = FaccmpImpuestos.cod_tipo_impuesto "
        lstrSQL = lstrSQL & " AND impuestos.cod_impuesto = FaccmpImpuestos.cod_impuesto "
        lstrSQL = lstrSQL & " WHERE FaccmpImpuestos.Cod_Emp = " & val(txtEmpresa.text)
        lstrSQL = lstrSQL & " AND   FaccmpImpuestos.cod_doc = " & val(txtCodDoc.text)
        lstrSQL = lstrSQL & " AND   FaccmpImpuestos.nro_doc = " & val(txtDoc.text)
        lstrSQL = lstrSQL & " AND   FaccmpImpuestos.Cod_Prov = " & val(txtCodProv.text)
        lstrSQL = lstrSQL & " AND   FaccmpImpuestos.cod_tipo_impuesto = 'IVA' AND impuestos.codigo_efactura_uruguay <> 0 "
        
        Set lrstDocImpuestos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        Do Until lrstDocImpuestos.EOF
            If lrstDocImpuestos!codigo_efactura_uruguay = 1 Or lrstDocImpuestos!codigo_efactura_uruguay = 16 Then    'Exento de IVA
                ldblTotalNoGrv = ldblTotalNoGrv + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
        
            If lrstDocImpuestos!codigo_efactura_uruguay = 2 Then    'Gravado a Tasa Mínima
                ldblTotalNetoIvaTasaMin = ldblTotalNetoIvaTasaMin + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
                ldblTotalIVATasaMin = ldblTotalIVATasaMin + Importe_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
        
            If lrstDocImpuestos!codigo_efactura_uruguay = 3 Then    'Gravado a Tasa Básica
                ldblTotalNetoIvaTasaBasica = ldblTotalNetoIvaTasaBasica + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
                ldblTotalIVATasaBas = ldblTotalIVATasaBas + Importe_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
        
            If lrstDocImpuestos!codigo_efactura_uruguay = 4 Then    'Gravado a Otra Tasa/IVA sobre fictos
                ldblTotalNetoIVAOtra = ldblTotalNetoIVAOtra + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
                ldblTotalIVAOtra = ldblTotalIVAOtra + Importe_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
            
        
            If lrstDocImpuestos!codigo_efactura_uruguay = 11 Then   'Impuesto percibido
                ldblTotalImptoPercibido = ldblTotalImptoPercibido + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
        
            If lrstDocImpuestos!codigo_efactura_uruguay = 12 Then   'IVA en suspenso
                ldblTotalIVASuspenso = ldblTotalIVASuspenso + Importe_Neto_X_Impuesto(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), "IVA", lrstDocImpuestos!cod_impuesto, "O")
            End If
            
            lrstDocImpuestos.MoveNext
        Loop
        
        lCfe.totales.mntNoGrv = Format(ldblTotalNoGrv, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        lCfe.totales.mntNetoIvaTasaMin = ldblTotalNetoIvaTasaMin
        lCfe.totales.mntIVATasaMin = Format(ldblTotalIVATasaMin, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        lCfe.totales.ivaTasaMin = "tasa_Minima"
        
        lCfe.totales.mntNetoIvaTasaBasica = ldblTotalNetoIvaTasaBasica
        lCfe.totales.mntIVATasaBas = Format(ldblTotalIVATasaBas, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        lCfe.totales.ivaTasaBas = "tasa_basica"
        
        lCfe.totales.mntNetoIVAOtra = ldblTotalNetoIVAOtra
        lCfe.totales.mntIVAOtra = Format(ldblTotalIVAOtra, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        lCfe.totales.mntIVASuspenso = Format(ldblTotalIVASuspenso, "0.00")
        
        lCfe.totales.mntImptoPercibido = Format(ldblTotalImptoPercibido, "0.00")
        
'        ' JE 20180829       / Se formatea ahora segun configuracion, porque los importes de IVA se estan dejando a 4 decimales para que realice el calculo correcto para eFactura
'        lCfe.totales.mntNoGrv = Importe_Neto_X_Impuesto(Val(txtEmpresa.text), Val(txtCodDoc.text), Val(txtDoc.text), Val(txtCodProv.text), "IVA", 1, "O")
'        lCfe.totales.mntNoGrv = Format(lCfe.totales.mntNoGrv, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
'
'        lCfe.totales.mntNetoIvaTasaMin = Importe_Neto_X_Impuesto(Val(txtEmpresa.text), Val(txtCodDoc.text), Val(txtDoc.text), Val(txtCodProv.text), "IVA", 2, "O")
'
'        ' JE 20180829       / Se formatea ahora segun configuracion, porque los importes de IVA se estan dejando a 4 decimales para que realice el calculo correcto para eFactura
'        lCfe.totales.mntIVATasaMin = Importe_X_Impuesto(Val(txtEmpresa.text), Val(txtCodDoc.text), Val(txtDoc.text), Val(txtCodProv.text), "IVA", 2, "O")
'        lCfe.totales.mntIVATasaMin = Format(lCfe.totales.mntIVATasaMin, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
'
'        lCfe.totales.mntNetoIvaTasaBasica = Importe_Neto_X_Impuesto(Val(txtEmpresa.text), Val(txtCodDoc.text), Val(txtDoc.text), Val(txtCodProv.text), "IVA", 3, "O")
'
'        ' JE 20180829       / Se formatea ahora segun configuracion, porque los importes de IVA se estan dejando a 4 decimales para que realice el calculo correcto para eFactura
'        lCfe.totales.mntIVATasaBas = Importe_X_Impuesto(Val(txtEmpresa.text), Val(txtCodDoc.text), Val(txtDoc.text), Val(txtCodProv.text), "IVA", 3, "O")
'        lCfe.totales.mntIVATasaBas = Format(lCfe.totales.mntIVATasaBas, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
'
'        lCfe.totales.ivaTasaMin = "tasa_Minima"
'        lCfe.totales.ivaTasaBas = "tasa_basica"
        
        lCfe.totales.mntTotal = val(lCfe.totales.mntNoGrv) + val(lCfe.totales.mntIVATasaMin) + val(lCfe.totales.mntIVATasaBas) + val(lCfe.totales.mntIVAOtra) + val(lCfe.totales.mntNetoIvaTasaMin) + val(lCfe.totales.mntNetoIvaTasaBasica) + val(lCfe.totales.mntNetoIVAOtra) + val(lCfe.totales.mntIVASuspenso) + val(lCfe.totales.mntImptoPercibido)
        lCfe.totales.montoNF = ldblRedondeo     'Val(txtRedondeo.text)
        lCfe.totales.mntPagar = val(lCfe.totales.mntTotal) + val(lCfe.totales.montoNF)
        
        lCfe.totales.TpoCambio = IIf(lCfe.totales.TpoMoneda <> "UYU", val(txtTipo_Cambio.text), "0")
        
        
        
        
        
        
        
    End If
    
            
    If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
    
        lCfe.totales.TpoMoneda = Trim(lrstMonedas!codigo_DGI_eFactura)          'SS 20190515
        lCfe.totales.TpoCambio = IIf(lCfe.totales.TpoMoneda <> "UYU", val(txtTipo_Cambio.text), "0")
        
        lCfe.totales.mntTotCredFisc = "0.00"
        lCfe.totales.mntTotRetenido = "0.00"

        ' Sumo para credito fiscal o retenciones
        ' Cambio: antes preguntaba por TipoTotal,  ahora por Nro_Form       SS 20181030
        SQL = "SELECT ma_Retenciones_Dgi.Nro_Form, (FaccmpServicios.importe * documentos.signo * -1) AS ImpteResg "
        SQL = SQL & " FROM FaccmpServicios"
        SQL = SQL & " INNER JOIN ma_Insumos_Servicios"
        SQL = SQL & " ON  ma_Insumos_Servicios.Codigo = FaccmpServicios.codigo"
        SQL = SQL & " INNER JOIN ma_Retenciones_Dgi"
        SQL = SQL & " ON ma_Retenciones_Dgi.Codigo = ma_Insumos_Servicios.codigo_retencion_dgi"
        SQL = SQL & " INNER JOIN documentos ON documentos.cod_doc = FaccmpServicios.cod_doc"
        SQL = SQL & " WHERE FaccmpServicios.cod_emp = " & val(txtEmpresa.text)
        SQL = SQL & " AND   FaccmpServicios.cod_doc = " & val(txtCodDoc.text)
        SQL = SQL & " AND   FaccmpServicios.nro_doc = " & val(txtDoc.text)
        SQL = SQL & " AND   FaccmpServicios.cod_prov = " & val(txtCodProv.text)
       
        Set lrstTotRet = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        
        Do Until lrstTotRet.EOF
        
            If lrstTotRet!Nro_Form = 2181 Then
                
                lCfe.totales.mntTotCredFisc = lCfe.totales.mntTotCredFisc + Round(lrstTotRet!impteresg, 2)
            Else
                lCfe.totales.mntTotRetenido = lCfe.totales.mntTotRetenido + Round(lrstTotRet!impteresg, 2)
            End If
            lrstTotRet.MoveNext
        Loop
        
        ' AIR 20210325 se aplica el redondeo porque aun cuando se esta redondeando cada cifra que se le va sumando al total cuando se el suman cifras negativas no toma como que son 2 decimales luego de la coma
        ' Ej. caso de Sabbatini que tenia que sumar esas 2 cantidades y devuuelve eso lleno de nueves:  8091.95 + (-7460.85) = 631.099999999999

        lCfe.totales.mntTotCredFisc = Round(lCfe.totales.mntTotCredFisc, 2)
        lCfe.totales.mntTotRetenido = Round(lCfe.totales.mntTotRetenido, 2)
        
        lrstTotRet.Close
    End If
              
    'Total Exportacion y asimiladas
    If Trim(D!exportacion) = "S" Then
        lCfe.totales.mntExpoyAsim = lCfe.totales.mntNoGrv
        lCfe.totales.mntNoGrv = "0"
        
        If lstrTipoDoc = "ANULA REMITO EXPORTACION" Then
             lCfe.totales.mntExpoyAsim = lCfe.totales.mntExpoyAsim * -1
             lCfe.totales.mntTotal = lCfe.totales.mntExpoyAsim
        End If
    Else
        lCfe.totales.mntExpoyAsim = "0"
    End If
              
    'ITEMS  -  SERVICIOS    -----------------------------------------------------------------------------------------------------------
    
    If pstrTipo_Ingreso_Documentos = "S" Then
        dbgLineas_Servicios.MoveFirst

        ReDim lCfe.Items(dbgLineas_Servicios.Rows + 1)
        lcantlinserv = 0    'AIR 20180815 llevamos un contador de la cantidad de lineas de servicio para saber la cantidad real, porque la grilla de servicio no quita la fila eliminada
        
        For i = 0 To UBound(lCfe.Items) - 2
            lCfe.Items(i).NroLinDet = i + 1
            
                       
            If dbgLineas_Servicios.Columns("eliminada").Value = False Then   'AIR 20180815 linea eliminada en la grilla de lineas de servicio
                
                lcantlinserv = lcantlinserv + 1   'AIR 20180815
                
                'Establece Indicador de Facturacion ------------------------------------------------------------------------------------------------------------
                
                If lstrTipoDoc = "RESGUARDO" Then
                    If val(dbgLineas_Servicios.Columns("importe").text) >= 0 Then
                        lCfe.Items(i).IndFact = 0
                    Else
                        lCfe.Items(i).IndFact = 9   'Lineas negativas en RESGUARDOS
                    End If
                End If
                If lstrTipoDoc = "ANULA RESGUARDO" Then
                    If val(dbgLineas_Servicios.Columns("importe").text) >= 0 Then
                        lCfe.Items(i).IndFact = 9
                    Else
                        lCfe.Items(i).IndFact = 0   'Lineas negativas en ANULA RESGUARDOS
                    End If
                End If
                    
                If lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then
                'lCfe.items(i).indFact = IIf(Trim(D!exportacion) <> "S", fIndFact(dbgLineas_Servicios.Columns("tiva").text, dbgLineas_Servicios.Columns("importe").text), IIf(Trim(UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text))) = "TARA", 5, 10))
                
                    If Trim(D!exportacion) = "S" Then
                        If Trim(UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text))) = "TARA" Or Trim(UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text))) = "BRUTO" Or val(dbgLineas_Servicios.Columns("importe").text) = 0 Then
                            lCfe.Items(i).IndFact = 5
                        Else
                            'lCfe.Items(i).IndFact = 10
                            'AIR 20240919 se detecto en Luma que no estaba correcto esto el indfac
                            If lstrTipoDoc = "REMITO EXPORTACION" Then
                                lCfe.Items(i).IndFact = 0
                            Else
                                If lstrTipoDoc = "ANULA REMITO EXPORTACION" Then
                                    lCfe.Items(i).IndFact = 8
                                Else                ' lstrTipoDoc = "FACTURA EXPORTACION"
                                    lCfe.Items(i).IndFact = 10
                                End If
                            End If
                            
                        End If
                    Else
                    
                        'lCfe.items(i).indFact = fIndFact(dbgLineas_Servicios.Columns("tiva").text, dbgLineas_Servicios.Columns("importe").text)
                        ' AIR 20210811 se cambia a pasar por parametro el precio que es quien determina el indicador de facturacion.
                        '              Si el total de la linea da 0 pero el precio es mayor a 0 se debe enviar el indicador de fact correspondiente a la tasa de iva.
                        '              Si el precio es 0 es cuando se envia indfact=5
                        'lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(Val(dbgLineas_Servicios.Columns("tiva").text), Val(dbgLineas_Servicios.Columns("importe").text))
                        lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(val(dbgLineas_Servicios.Columns("tiva").text), val(dbgLineas_Servicios.Columns("precio").text))
                        
                        If lCfe.Items(i).IndFact = 0 Then
                            MsgBox "Falta definir el Codigo EFactura para Codigo de IVA " & dbgLineas_Servicios.Columns("tiva").text, vbCritical, MsgTit
                            lCfe.cae.numero = 0
                            Exit Sub
                        End If
                    End If
                End If
                
                
                If ConfPuntoVta_Concatenar_Seccion_Descripcion And val(dbgLineas_Servicios.Columns("seccion").text) <> 0 Then
                    lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Mid(Trim(UCase(Trim(dbgLineas_Servicios.Columns("desc_seccion").text))) & "-" & Trim(UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text))), 1, 80))
                Else
                    lCfe.Items(i).nomItem = Trim(UCase(f_Ins_String_Sin_Menor_Mayor(dbgLineas_Servicios.Columns("descripcion").text)))
                End If
                
                SQL = "SELECT * FROM FaccmpLineas_Auxiliar"
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND   cod_doc= " & val(txtCodDoc.text)
                SQL = SQL & " AND   nro_doc = " & val(txtDoc.text)
                SQL = SQL & " AND   cod_prov = " & val(txtCodProv.text)
                SQL = SQL & " AND   linea = " & lCfe.Items(i).NroLinDet
                
                pstrHoras_Factura = ""
                
                Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                'If Not R.EOF Then
                    
                    'If Trim(D!tipo_doc) = "G" Or ConfFormato_Factura = "DENIREL" Or ConfFormato_Factura = "ROAD" Then   'Agrego los resguardos  SS 20181026
                        
                        While Not R.EOF
                            pstrHoras_Factura = pstrHoras_Factura & f_Ins_String_Sin_Menor_Mayor(Trim(f_Ins_String_Sin_TILDE_ENTER_PIPELINE_y_LINEFEED(R!observacion))) & Chr(13)
                            R.MoveNext
                        Wend
                    'End If
                'End If
                
                If pstrHoras_Factura <> "" Then
                    lCfe.Items(i).descAdicional = pstrHoras_Factura
                End If
                
                If lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then
                
                    lCfe.Items(i).cantidad = val(dbgLineas_Servicios.Columns("unidades").text)
                    lCfe.Items(i).UniMed = "N/A"
                    lCfe.Items(i).tipoLinEntSis = ""
                    
                    ' JE 20170704   /   Se ajusta el Precio Unitario y Monto del Item que no estaba considerandolo correctamente
                    
                    ' AIR 20200306 se agrega la posibilidad de enviar a E-factura el precio sin impuestos.
                    If e!imp_inc_facturador = "N" Or ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = False Then
                        lCfe.Items(i).preciounitario = dbgLineas_Servicios.Columns("precio_siva").text
                        lCfe.Items(i).MontoItem = Round(val(dbgLineas_Servicios.Columns("importe_sin_iva").text), 2)
                    Else
                        lCfe.Items(i).preciounitario = dbgLineas_Servicios.Columns("precio").text
                        lCfe.Items(i).MontoItem = Round(val(dbgLineas_Servicios.Columns("importe").text), 2)
                    End If
                    
                    ' AIR 20170525 no se estaba enviando el descuento de fact de servicios a fact electronica
                                        
                    'lCfe.items(i).descuentoMonto = "0"
                    'lCfe.items(i).descuentoPct = "0"
                    
                    ' Descuentos
                    ' AIR 20200306 se agrega la posibilidad de enviar a E-factura el precio sin impuestos.
                    If e!imp_inc_facturador = "N" Or ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = False Then
                        lCfe.Items(i).DescuentoMonto = Round((val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario)) - Round(val(dbgLineas_Servicios.Columns("importe_sin_iva").text), 2), 2) 'dbgLineas_Servicios.Columns("precio_siva")  SS 20180328
                        lCfe.Items(i).DescuentoPct = "0"
                    Else
                        lCfe.Items(i).DescuentoMonto = Round((val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario)) - val(dbgLineas_Servicios.Columns("importe").text), 2)
                        lCfe.Items(i).DescuentoPct = "0"
                    End If
                End If
                
                If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
                
                    If Not Busco_Insumo_Servicio(val(dbgLineas_Servicios.Columns("codigo").text), lrstInsServ) Then
                        MsgBox "Error en el codigo de servicio", vbCritical, MsgTit
                        lCfe.cae.numero = 0
                        Exit Sub
                    Else
                        If lrstInsServ!codigo_retencion_dgi = "" Then
                            MsgBox "Error el codigo de servicio NO tiene codigo de Retencion correspondiente", vbCritical, MsgTit
                            lCfe.cae.numero = 0
                            Exit Sub
                        Else
                            If Not Busco_Retencion_Dgi(lrstInsServ!codigo_retencion_dgi, lrstRetenciones) Then
                                MsgBox "Error NO existe Codigo de Retencion en tabla de Retenciones", vbCritical, MsgTit
                                lCfe.cae.numero = 0
                                Exit Sub
                            Else
                                lCfe.Items(i).CodRet = lrstRetenciones!codigo
                                lCfe.Items(i).mntSujetoaRet = Abs(val(dbgLineas_Servicios.Columns("precio_siva").text))
                                lCfe.Items(i).tasa = dbgLineas_Servicios.Columns("tasa_resguardo").text
                                lCfe.Items(i).ValRetPerc = Abs(val(dbgLineas_Servicios.Columns("importe").text))
                            End If
                        End If
                    End If
                    
                End If
            Else
                lCfe.Items(i).IndFact = -99  'AIR 20180815 marcamos la linea eliminada para que en el metodo EnvioCfe no sea considerada
            End If
            
            dbgLineas_Servicios.MoveNext
        Next i
        
        'AIR 20190104 se deja de enviar el redondeo cuando es igual a 0 por lo cual lo calificamos con -99 para que en el metodo de envioCfe descarte la linea
        
        'Redondeo en la ultima linea
        
        lCfe.Items(UBound(lCfe.Items) - 1).NroLinDet = UBound(lCfe.Items)
        lCfe.Items(UBound(lCfe.Items) - 1).IndFact = IIf(ldblRedondeo > 0, 6, IIf(ldblRedondeo = 0, -99, 7))
        lCfe.Items(UBound(lCfe.Items) - 1).nomItem = "REDONDEO"
        lCfe.Items(UBound(lCfe.Items) - 1).cantidad = 1      ' AIR 20191210 es erroneo enviar cifras en negativo en la cantidad IIf(ldblRedondeo >= 0, 1, -1)
        lCfe.Items(UBound(lCfe.Items) - 1).UniMed = "N/A"
        lCfe.Items(UBound(lCfe.Items) - 1).preciounitario = Abs(ldblRedondeo)
        lCfe.Items(UBound(lCfe.Items) - 1).MontoItem = Abs(Round(ldblRedondeo, 2))
        lCfe.Items(UBound(lCfe.Items) - 1).tipoLinEntSis = ""
        lCfe.Items(UBound(lCfe.Items) - 1).DescuentoMonto = "0"
        lCfe.Items(UBound(lCfe.Items) - 1).DescuentoPct = "0"
        
        If ldblRedondeo <> 0 Then      'suma si hay redondeo   SS 20190122
            lcantlinserv = lcantlinserv + 1
        End If
        
        lCfe.totales.cantLinDet = lcantlinserv     'AIR 20180815 inicializamos la cantidad real de lineas
                        
    Else
        'ITEMS  -  MERCADERIA   -------------------------------------------------------------------------------------------------------
    
        ReDim lCfe.Items(lrstLinMercaderia.RecordCount + 1)  ' lCfe.items(vsfLineas_Mercaderia.Rows)
        
        For i = 0 To UBound(lCfe.Items) - 2
            lCfe.Items(i).NroLinDet = i + 1
            
            If Busco_Producto(val(lrstLinMercaderia!Cod_Prod)) Then
            
                 If i = 6 Then
                     i = i
                 End If
            
            
            
                
                lCfe.Items(i).codtipo = "INT1"      'SS 20190122
                
                'ATU 20170917, se deja configuracion IDENTICA en Justicia a Aparicio - Pedido por Virginia Gonzalez.
                'If (ConfFormato_Factura = "CASINO" And ConfProceso_Productos_WIS = "CLON") Or ConfFormato_Factura = "CASINO-POS" Then
                If ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "CASINO-POS" Then
                    ' JE 20180430   /    Se maneja ahora con la Descripcion Auxiliar si esta en S
                    If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                        lCfe.Items(i).nomItem = Trim(lrstLinMercaderia!Descripcion)
                    Else
                        sqlProd = "select * from productos_casino where codigo= " & val(lrstLinMercaderia!Cod_Prod)
                        Set RDESC = Dbs.OpenRecordset(sqlProd, dbOpenSnapshot)
                        If Not RDESC.EOF Then
                            If Not IsNull(RDESC!Descripcion) Then
                                lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(RDESC!Descripcion))
                            Else
                                lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                            End If
                        Else
                            lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                        End If
                    End If
                    
                    'ATU  22/09/2015 Pedido de Eduardo Silva, mandar siempre codigo de SISNET
                    'If Busco_CodBarra(Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_CODIGO))) Then
                    '    lCfe.items(i).cod = Right(rstcBarra!cod_barra, 6) & "-" & Mid(Trim(rstProd!cod_art_proveedor), 1, 6)
                    'Else
                    If ConfFormato_Factura = "CASINO-POS" Then      'para casino justicia
                        lCfe.Items(i).Cod = Trim(lrstLinMercaderia!Cod_Prod)
                    Else                                            'para aparicio
                        lCfe.Items(i).Cod = val(lrstLinMercaderia!Cod_Prod) & "-" & Mid(Trim(rstProd!cod_art_proveedor), 1, 6)
                    End If
                    'End If
                Else
                    If ConfPuntoVta_Imprime_EFactura_Codigo_Anterior Then ' AIR 20180214 se pasa a una variable global la condicion.
                        lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                        lCfe.Items(i).Cod = Trim(lrstLinMercaderia!codigo_santerior)
                    ElseIf ConfPuntoVta_Imprime_EFactura_Codigo_Art_Proveedor Then 'JCH 20230731 se imprime el codigo del art del proveedor
                        lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                        If Trim(rstProd!cod_art_proveedor) = "" Then
                            lCfe.Items(i).Cod = Trim(lrstLinMercaderia!Cod_Prod)
                        Else
                            lCfe.Items(i).Cod = Trim(rstProd!cod_art_proveedor)
                        End If
                    Else
                        If ConfPuntoVta_Imprime_EFactura_Descripcion_Caja Then  ' AIR 20180214 se pasa a una variable global la condicion.
                        'If ConfFormato_Factura = "GOMAS" Then   ' Imprime la descripcion de la caja         SS 20170103
                            If Buscar_Articulo(Trim(lrstLinMercaderia!Cod_Prod), lrstArticulos) Then
                                If lrstArticulos!generico = "S" Then    'Imprime la descripcion ingresada   SS 20170202
                                    lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(UCase(Trim(lrstLinMercaderia!Descripcion)))
                                Else
                                    If lrstArticulos!desc_caja <> "" Then
                                        lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstArticulos!desc_caja))
                                    Else
                                        lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                                    End If
                                End If
                            Else
                                lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                            End If
                            lCfe.Items(i).Cod = Trim(lrstLinMercaderia!Cod_Prod)
                            
                        Else
                            lCfe.Items(i).nomItem = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Descripcion))
                            lCfe.Items(i).Cod = f_Ins_String_Sin_Menor_Mayor(Trim(lrstLinMercaderia!Cod_Prod))
                        End If
                    End If
                End If
                         
                pstrHoras_Factura = ""
                
                If ConfFormato_Factura = "PUNTOUNION" Then
                
                    'AIR 20210617 faltaba consultar la descripcion para enviar en la descripcion
                    If Busco_Tipo_Entrega_Mercaderia(lrstLinMercaderia!tipo_entrega, TE) Then
                        lstrDescripcion_Corta = Trim(UCase(TE!descripcion_corta))
                    Else
                        lstrDescripcion_Corta = ""
                    End If

                    'Agrego en desc adicional el tipo de entrega y el deposito  SS 20171023
                    'pstrHoras_Factura = Chr(9) & Chr(9) & Chr(9) & Chr(9) & Trim(lrstLinMercaderia!tipo_entrega) & "  Deposito: " & Trim(lrstLinMercaderia!deposito) & Chr(13)      'SS 20171018
                    pstrHoras_Factura = Chr(9) & Chr(9) & Chr(9) & Chr(9) & Trim(lstrDescripcion_Corta) & "  Deposito: " & Trim(lrstLinMercaderia!Deposito) & Chr(13)      'SS 20171018
                End If
                
                ' AIR 20230615 se agrega condicional por tipo de documento para la impresion de las garantias
                If ConfPuntoVta_Imprime_EFactura_Garantia Then      ' SS 20171222
                    'Agrego la garantia del producto    SS 20171025
                    lstrDocs = Trim(Documentos_para_Listar_Reportes(11))
                    If lstrDocs = "" Or InStr(lstrDocs, val(txtCodDoc.text)) Then
                        If NullToZero(rstProd!cod_tipo_garantia) <> 0 Then
                            SQL = "SELECT * FROM ma_Tipos_Garantia WHERE codigo = " & rstProd!cod_tipo_garantia
                            Set lrstGarantias = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                            If Not lrstGarantias.EOF Then
                                If lrstGarantias!Descripcion <> "" Then
                                    'AIR 20230615
                                    If Trim(pstrHoras_Factura) = "" Then
                                        pstrHoras_Factura = Chr(9) & Chr(9) & Chr(9) & Chr(9) & "Garantía --> " & f_Ins_String_Sin_Menor_Mayor(Trim(lrstGarantias!Descripcion)) & Chr(13)      'SS 20171018
                                    Else
                                        pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & Chr(9) & "Garantía --> " & f_Ins_String_Sin_Menor_Mayor(Trim(lrstGarantias!Descripcion)) & Chr(13)      'SS 20171018
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
                
                SQL = "SELECT *  FROM FaccmpLineas_Auxiliar"
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND   cod_doc= " & val(txtCodDoc.text)
                SQL = SQL & " AND   nro_doc = " & val(txtDoc.text)
                SQL = SQL & " AND   cod_prov = " & val(txtCodProv.text)
                SQL = SQL & " AND   linea = " & lCfe.Items(i).NroLinDet
                
                Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                If Not R.EOF Then
                
                    If ConfFormato_Factura = "DENIREL" Or ConfFormato_Factura = "ROAD" Then
                        
                        'pstrHoras_Factura = Space(45) & "Horas:" & Space(10) & "N de Boleta:" & Chr(13)
                        ' AIR 20170526
                        pstrHoras_Factura = Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & "Horas:" & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & "N de Boleta:" & Chr(13)
                        
                        While Not R.EOF
                            'AIR
                            'pstrHoras_Factura = pstrHoras_Factura & Space(47) & Format(R!Unidades, "0.00") & Space(17) & R!observacion & Chr(13)
                            pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Format(R!unidades, "0.00") & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_TILDE_ENTER_PIPELINE_y_LINEFEED(R!observacion)) & Chr(13)
                                   
                            R.MoveNext
                        Wend
                        'lCfe.items(i).descAdicional = pstrHoras_Factura
                    Else
                        While Not R.EOF
                            ' AIR 20170526
                            'pstrHoras_Factura = pstrHoras_Factura & Space(47) & R!Unidades & Space(17) & Chr(13)
                            pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Format(R!unidades, "#.##") & Chr(9) & Chr(9) & f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_TILDE_ENTER_PIPELINE_y_LINEFEED(R!observacion)) & Chr(13)   'SS 20171018
                                
                            R.MoveNext
                        Wend
                        
                        'lCfe.items(i).descAdicional = pstrHoras_Factura
                    End If
                End If
                
                If ConfPuntoVta_Imprime_EFactura_Desc_Detallada_Articulo Then   'SS 20171222
                    'lCfe.items(i).descAdicional = Trim(rstProd!descripcion_detallada)
                    If rstProd!descripcion_detallada <> "" Then
                        pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(rstProd!descripcion_detallada))) & Chr(13)
                    End If
                End If
           
                'AIR 20201029 Se agrega a pedido de Lanyvel que se imprima la serie en la DescAdicional
                If ConfPuntoVta_Imprime_EFactura_Serie_Producto_en_descAdicional Then
                    SQL = "SELECT *  FROM FaccmpLineas_Series"
                    SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                    SQL = SQL & " AND   cod_doc= " & val(txtCodDoc.text)
                    SQL = SQL & " AND   nro_doc = " & val(txtDoc.text)
                    SQL = SQL & " AND   cod_prov = " & val(txtCodProv.text)
                    SQL = SQL & " AND   nro_linea = " & lCfe.Items(i).NroLinDet
                    
                    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    lblntitulo = True
                    
                    While Not R.EOF
                        If lblntitulo = True Then
                            pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & "No.Serie: " & Format(R!serie, "#.##") & Chr(9) & Chr(9) & Chr(13)   'AIR 20201029
                            lblntitulo = False
                        Else
                            pstrHoras_Factura = pstrHoras_Factura & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Chr(9) & Format(R!serie, "#.##") & Chr(9) & Chr(9) & Chr(13)   'AIR 20201029
                        End If
                        R.MoveNext
                    Wend
                End If
                
                If pstrHoras_Factura <> "" Then
                    lCfe.Items(i).descAdicional = pstrHoras_Factura
                End If
                
                lCfe.Items(i).UniMed = "N/A"
                
                If ConfPuntoVta_Imprime_EFactura_Unidad_Medida Then     'Se configura   SS 20180903
                    If Not confUsaEquivalenciaMagnitudes Then
                        llngMagnitud = rstProd!magnitud
                    Else
                        llngMagnitud = lrstLinMercaderia!magnitud
                    End If
                    If Buscar_Magnitud(llngMagnitud, lrstMagnitudes) Then
                        'Solo lo activo para DALKAN / FALERO / GOMAS / DALSITEX  por ahora
                          'lCfe.items(i).uniMed = IIf(ConfFormato_Factura = "DALKAN" Or ConfFormato_Factura = "FALERO" Or ConfFormato_Factura = "GOMAS" Or ConfFormato_Factura = "DALSITEX", IIf(IsNull(rstMagnitudes!simbolo), "N/A", Trim(rstMagnitudes!simbolo)), "N/A")
                         If IsNull(lrstMagnitudes!simbolo) Then
                              lCfe.Items(i).UniMed = "N/A"
                         Else
                             If lrstMagnitudes!simbolo = "" Then
                                 lCfe.Items(i).UniMed = "N/A"
                              Else
                                 lCfe.Items(i).UniMed = Trim(lrstMagnitudes!simbolo)
                              End If
                         End If
                        
                          ' Codigo de unidad de medida de ASU     AIR 20171124
                         If e!Asociado_ASU = "S" And lrstMagnitudes!UniMed <> "" Then
                              lCfe.Items(i).UniMed = lrstMagnitudes!UniMed
                         End If
                    End If
                Else
                    'JCH se corrige el error de que la unimed este vacio
                    If confUsaEquivalenciaMagnitudes Then
                         If Buscar_Magnitud(lrstLinMercaderia!magnitud, RM) Then
                             lCfe.Items(i).UniMed = IIf(IsNull(RM!UniMed), "N/A", RM!UniMed)
                         End If
                    End If
                    
                End If
                j = 0
                j = 0       ' AIR 20241220 falto inicializar
                ' AIR 20171124   **** Inicio codificacion ASU
                If e!Asociado_ASU = "S" Then
                    
                    If rstProd!packing <> 0 Then
                        lCfe.Items(i).descAdicional = lCfe.Items(i).descAdicional & " [" & Format(Trim(str(rstProd!packing)), "000") & "CS]"
                    End If
                    
                    SQL = "SELECT * FROM ma_Articulos_Codificacion"
                    SQL = SQL & " WHERE Cod_Prod = " & rstProd!Cod_Prod
                    
                    Set FLinArtCod = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
                    If Not FLinArtCod.EOF Then
                        ReDim lCfe.Items(i).itemsCod(FLinArtCod.RecordCount)
                        j = 0
                        While Not FLinArtCod.EOF

                            lCfe.Items(i).itemsCod(j).nroLinCod = j + 1
                            'lCfe.items(i).itemsCod(j).listaCod = Trim(FLinArtCod!codTipo)
                            'lCfe.items(i).itemsCod(j).listaCodTipo = Trim(FLinArtCod!codItem)
                            lCfe.Items(i).itemsCod(j).listaCod = Trim(FLinArtCod!codItem)       'se corrige envio   SS 20181120
                            ' AIR 20241223 se exige el largo del codigo GTIN (es EAN)
                            'lCfe.Items(i).itemsCod(j).listaCodTipo = Trim(FLinArtCod!codtipo)
                            lCfe.Items(i).itemsCod(j).listaCodTipo = Trim(FLinArtCod!codtipo) & Trim(Len(Trim(FLinArtCod!codItem)))
                                          
                            j = j + 1
            
                            FLinArtCod.MoveNext
                        Wend
                    End If
                End If

                ' FIN codificacion ASU  *************************************************
                
                If j = 0 Then
                ' AIR 20221121 Se agrega el envio del codigo de barra por exigencia de DGI
        
                    SQL = "SELECT top 1 * FROM codbarra WHERE Cod_Prod = " & rstProd!Cod_Prod & " AND Principal = 1 and trans <> 'S'"
                    Set FLinArtCod = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
                    
                    If Not FLinArtCod.EOF Then
                        ReDim lCfe.Items(i).itemsCod(1)
                        j = 0
                        If Len(Trim(FLinArtCod!cod_barra)) > 7 And Len(Trim(FLinArtCod!cod_barra)) < 15 And Len(getChar(Trim(FLinArtCod!cod_barra))) = 0 Then ' AIR 20250929 se agrega funcion GetChar para no enviar codigos de barra que tienen caracteres
                            ' SI Código Válido
                            If Calcular_Verificador_EAN_GTIN(Trim(FLinArtCod!cod_barra), ldigit_calculado) Then
                                
                                lCfe.Items(i).itemsCod(j).nroLinCod = j + 1

                                lCfe.Items(i).itemsCod(j).listaCod = Trim(FLinArtCod!cod_barra)
                                lCfe.Items(i).itemsCod(j).listaCodTipo = "GTIN" & Trim(Len(Trim(FLinArtCod!cod_barra)))
                                j = j + 1
                            End If
                        End If
                    Else
                        ReDim lCfe.Items(i).itemsCod(0)
                        j = 0
                    End If
                    ' se envia el codigo interno tambien
                    lCfe.Items(i).itemsCod(j).nroLinCod = j + 1
                    lCfe.Items(i).itemsCod(j).listaCod = Trim(str(rstProd!Cod_Prod))
                    lCfe.Items(i).itemsCod(j).listaCodTipo = "INT1"
                End If
                
                'FIN envio codigos de barra
                
            Else
                lCfe.Items(i).descAdicional = ""
                lCfe.Items(i).UniMed = "N/A"
                lCfe.Items(i).nomItem = ""
                lCfe.Items(i).Cod = ""
                lCfe.Items(i).codtipo = ""      'SS 20190122
            End If
            
            
'            'Establece Indicador de Facturacion ------------------------------------------------------------------------------------------------------------
'
'            If lstrTipoDoc = "REMITO" Then
'                lCfe.Items(i).IndFact = 0
'            End If
'            If lstrTipoDoc = "ANULA REMITO" Then
'                lCfe.Items(i).IndFact = 8
'            End If
'
'            If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
'            'lCfe.items(i).indFact = IIf(Trim(D!exportacion) <> "S", fIndFact(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_TIVA), vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_IMPORTE)), IIf(Trim(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DESCRIPCION)) = "TARA" Or Trim(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DESCRIPCION)) = "BRUTO", 5, 10))
'                If Trim(D!exportacion) = "S" Then
'                    If Trim(lrstLinMercaderia!descripcion) = "TARA" Or Trim(lrstLinMercaderia!descripcion) = "BRUTO" Or val(lrstLinMercaderia!Importe) = 0 Then
'                        lCfe.Items(i).IndFact = 5
'                    Else
'                        lCfe.Items(i).IndFact = 10
'                    End If
'                Else
'                    'lCfe.items(i).indFact = fIndFact(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_TIVA), vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_IMPORTE))
'                    ' AIR 20210811 se cambia a pasar por parametro el precio que es quien determina el indicador de facturacion.
'                    '              Si el total de la linea da 0 pero el precio es mayor a 0 se debe enviar el indicador de fact correspondiente a la tasa de iva.
'                    '              Si el precio es 0 es cuando se envia indfact=5
'                    ' lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(lrstLinMercaderia!tiva, lrstLinMercaderia!importe)
'                    lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(lrstLinMercaderia!tiva, lrstLinMercaderia!Punitario)
'
'                    If lCfe.Items(i).IndFact = 0 Then
'                        MsgBox "Falta definir el Codigo EFactura para Codigo de IVA " & lrstLinMercaderia!tiva, vbCritical, MsgTit
'                        lCfe.cae.numero = 0
'                        Exit Sub
'                    End If
'                End If
'            End If
'
'           lCfe.items(i).cantidad = Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_CAJAS)) * Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_UNIDADES))
'           JE 20190326     /   No se multiplica por las cajas, porque no se estan tomando asi en el calculo de unidades de la linea en la grilla.
            lCfe.Items(i).cantidad = val(lrstLinMercaderia!unidades)
                               
            'Precio unitario e importe de la linea
            If lstrTipoDoc = "REMITO" Or lstrTipoDoc = "ANULA REMITO" Then
                lCfe.Items(i).preciounitario = 0
                lCfe.Items(i).MontoItem = 0
            Else
                
                If e!imp_inc_facturador = "N" Then
                    If (ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio = False Or ConfFormato_Factura = "CONAPLUS" Or ConfFormato_Factura = "GOMAS" Or ConfFormato_Factura = "MANTA" Or ConfFormato_Factura = "PUNTOUNION" Or ConfFormato_Factura = "TECNOLAND" Or ConfFormato_Factura = "HILCA" Or ConfFormato_Factura = "VIASULYTOP") Then 'Se agrega configuracion general SS 20190401
                        lCfe.Items(i).preciounitario = val(lrstLinMercaderia!Punitario) 'unitario s/iva s/dtos
                    Else
                        lCfe.Items(i).preciounitario = val(lrstLinMercaderia!Punitariosimp)
                    End If
                    
                    lCfe.Items(i).MontoItem = Round(val(lrstLinMercaderia!importe_sin_iva), 2)
                Else
                    ' AIR 20200306 se agrega la posibilidad de enviar a E-factura el precio sin impuestos para las empresas que menejan imp-incluidos
                    If ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = False Then
                        If ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio = False Then
                            'lCfe.Items(i).preciounitario = Round(val(lrstLinMercaderia!Punitario) / (1 + lrstLinMercaderia!iva / 100), 2)
                            lCfe.Items(i).preciounitario = Format(val(lrstLinMercaderia!Punitario) / (1 + lrstLinMercaderia!iva / 100), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            'lCfe.Items(i).MontoItem = Round(lCfe.Items(i).preciounitario * lCfe.Items(i).cantidad, 2)
                        Else
                            lCfe.Items(i).preciounitario = val(lrstLinMercaderia!punitariosimp_con_dto)
                            lCfe.Items(i).preciounitario = Format(lrstLinMercaderia!punitariosimp_con_dto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            'lCfe.Items(i).MontoItem = Round(lCfe.Items(i).preciounitario * lCfe.Items(i).cantidad, 2)
                        End If
                        lCfe.Items(i).MontoItem = Round(val(lrstLinMercaderia!importe_sin_iva), 2)
                         
                    Else
                        'If ConfFormato_Factura = "DTODASPARTES_SALINAS" Or ConfFormato_Factura = "DTODASPARTES_RIVERA" Then    ' SS 20160425
                        If ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then      ' SS 20180618
                            'lCfe.Items(i).preciounitario = val(lrstLinMercaderia!punitarios_con_dto)
                            
                            'AIR 20230803 esta equivocado el nombre del campo - error al copiar y agregar la mascara
                            'lCfe.Items(i).preciounitario = Format(val(lrstLinMercaderia!punitariosimp_con_dto), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            lCfe.Items(i).preciounitario = Format(val(lrstLinMercaderia!punitarios_con_dto), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        Else
                            ' lCfe.items(i).preciounitario = Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_PUNITARIO_CON_DTO))
                            'lCfe.Items(i).preciounitario = val(lrstLinMercaderia!Punitario) 'AIR 20180315 se revirtio la modificacion porque no estaba bien enviar con el descuento incluido.
                            lCfe.Items(i).preciounitario = Format(lrstLinMercaderia!Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                        lCfe.Items(i).MontoItem = Round(val(lrstLinMercaderia!Importe), 2)
                    End If
                End If
            End If
          
            'Establece Indicador de Facturacion ------------------------------------------------------------------------------------------------------------
            'AIR 20221103 faltaba considerar la variable ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio que condiciona el parametro a pasar a la funcion
            ' por eso se traslada la evaluacio del indicador de fact a luego de evaluar el precio unitario que se va a enviar
                       
            If lstrTipoDoc = "REMITO" Then
                lCfe.Items(i).IndFact = 0
            End If
            If lstrTipoDoc = "ANULA REMITO" Then
                lCfe.Items(i).IndFact = 8
            End If
            
            If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
            'lCfe.items(i).indFact = IIf(Trim(D!exportacion) <> "S", fIndFact(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_TIVA), vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_IMPORTE)), IIf(Trim(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DESCRIPCION)) = "TARA" Or Trim(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DESCRIPCION)) = "BRUTO", 5, 10))
                If Trim(D!exportacion) = "S" Then
                
                    If Trim(lrstLinMercaderia!Descripcion) = "TARA" Or Trim(lrstLinMercaderia!Descripcion) = "BRUTO" Or val(lrstLinMercaderia!Importe) = 0 Then
                        lCfe.Items(i).IndFact = 5
                    Else
                        'pcfe.Items(i).IndFact = 10
                        'AIR 20240919 se detecto en Luma que no estaba correcto esto el indfac
                        If lstrTipoDoc = "REMITO EXPORTACION" Then
                            lCfe.Items(i).IndFact = 0
                        Else
                            If lstrTipoDoc = "ANULA REMITO EXPORTACION" Then
                                lCfe.Items(i).IndFact = 8
                            Else                ' lstrTipoDoc = "FACTURA EXPORTACION"
                                lCfe.Items(i).IndFact = 10
                            End If
                        End If
                        
                    End If
                Else
                    'lCfe.items(i).indFact = fIndFact(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_TIVA), vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_IMPORTE))
                    ' AIR 20210811 se cambia a pasar por parametro el precio que es quien determina el indicador de facturacion.
                    '              Si el total de la linea da 0 pero el precio es mayor a 0 se debe enviar el indicador de fact correspondiente a la tasa de iva.
                    '              Si el precio es 0 es cuando se envia indfact=5
                    ' lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(lrstLinMercaderia!tiva, lrstLinMercaderia!importe)
                    
                    'lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(lrstLinMercaderia!tiva, lrstLinMercaderia!Punitario)
                    lCfe.Items(i).IndFact = obtengoIndicadorImpuesto(lrstLinMercaderia!tiva, CDbl(lCfe.Items(i).preciounitario))
                    
                    If lCfe.Items(i).IndFact = 0 Then
                        MsgBox "Falta definir el Codigo EFactura para Codigo de IVA " & lrstLinMercaderia!tiva, vbCritical, MsgTit
                        lCfe.cae.numero = 0
                        Exit Sub
                    End If
                End If
            End If
            
            
            'Indicamos el tipo de linea para la impresion. Sobre todo aplica a la exportacion.
            Select Case Trim(lrstLinMercaderia!Descripcion)
                Case "TARA"
                    lCfe.Items(i).tipoLinEntSis = "T"
                Case "BRUTO"
                    lCfe.Items(i).tipoLinEntSis = "B"
                Case Else
                    If rstProd!cod_aso <> 0 Then
                        lCfe.Items(i).tipoLinEntSis = "N"
                    Else
                        lCfe.Items(i).tipoLinEntSis = ""
                    End If
            End Select
            
            
            ' Descuentos
            If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
               'jch 28102022 se incluye el deposito en la impresion de las lineas del documento como columna
                If confPuntoVta_Imprime_Tipo_Entrega_En_Lineas Then
                    If Busco_Tipo_Entrega_Mercaderia(lrstLinMercaderia!tipo_entrega, TE) Then
                        lCfe.Items(i).descAdicional = Trim(TE!descripcion_corta) & "##"
                    End If
                End If
                   ' AIR 20200306
                If e!imp_inc_facturador = "N" Or ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = False Then
                    'jch 20230630 se pone 0 porque el redondeo minimo es de 0.01
                    
                    lCfe.Items(i).DescuentoMonto = Round((val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario)) - Round(val(lrstLinMercaderia!importe_sin_iva), 3), 2)
                    If lCfe.Items(i).DescuentoMonto < confTolerancia_Redondeo_en_Linea_FE And val(NullToZero(lCfe.Items(i).DescuentoPct)) = 0 Then
                        lCfe.Items(i).DescuentoMonto = 0
                    End If
                    
                    ' SS 20171026
                    'If ConfFormato_Factura = "MANTA" Then   ' Enviamos el porcentaje descuento y la impresion del % SS 20171026
                    If ConfPuntoVta_Imprime_EFactura_Porcentaje_Descuento_Formato1 Then ' Enviamos el porcentaje descuento y la impresion del %   SS 20180905                             If (Val(txtDtoGlobal.text) + Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DTO1)) + Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DTO2)) + Val(vsfLineas_Mercaderia.TextMatrix(lCfe.items(i).nroLinDet, CGL_DTO3))) <> 0 Then
                        If (val(txtDtoGlobal.text) + val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) <> 0 Then
                            If val(txtDtoGlobal.text) <> 0 And (val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) = 0 Then
                                lCfe.Items(i).DescuentoPct = val(txtDtoGlobal.text)
                                lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                            Else
                                If val(lrstLinMercaderia!dto1) <> 0 And (val(txtDtoGlobal.text) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) = 0 Then
                                    lCfe.Items(i).DescuentoPct = val(lrstLinMercaderia!dto1)
                                    lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                                Else
                                    lCfe.Items(i).DescuentoPct = Round((val(lCfe.Items(i).DescuentoMonto) / (val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario))) * 100, 2)
                                    lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                                End If
                            End If
                        End If
                    Else
                        ' AIR 20201104 se cambia el hardcodeo de Hilca a una variable global
                        'If ConfFormato_Factura = "HILCA" Then
                        If ConfPuntoVta_Imprime_EFactura_Porcentaje_Descuento_Formato2 Then
                            'Para el porcentaje del dscto toma en cuenta solo los dsctos x linea
                            If val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3) <> 0 Then
                                lCfe.Items(i).DescuentoPct = Round((val(lCfe.Items(i).DescuentoMonto) / (val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario))) * 100, 2)
                                
                                lstrDsctos_Linea = ""
                                
                                If val(lrstLinMercaderia!dto1) <> 0 Then
                                    lstrDsctos_Linea = Format(vsfLineas_Mercaderia.TextMatrix(lCfe.Items(i).NroLinDet, CGL_DTO1), "0")
                                End If
                                If val(lrstLinMercaderia!dto2) <> 0 Then
                                    If lstrDsctos_Linea = "" Then
                                        lstrDsctos_Linea = Format(lrstLinMercaderia!dto2, "0")
                                    Else
                                        lstrDsctos_Linea = lstrDsctos_Linea & "+" & Format(lrstLinMercaderia!dto2, "0")
                                    End If
                                End If
                                If val(lrstLinMercaderia!dto3) <> 0 Then
                                    If lstrDsctos_Linea = "" Then
                                        lstrDsctos_Linea = Format(lrstLinMercaderia!dto3, "0")
                                    Else
                                        lstrDsctos_Linea = lstrDsctos_Linea & "+" & Format(lrstLinMercaderia!dto3, "0")
                                    End If
                                End If
                                If lstrDsctos_Linea <> "" Then
                                    lCfe.Items(i).descAdicional = lstrDsctos_Linea & "%@@"
                                End If
                            End If
                        Else
                            If ConfFormato_Factura = "CONAPLUS" Or ConfFormato_Factura = "GOMAS" Or ConfFormato_Factura = "PUNTOUNION" Then ' Enviamos el porcentaje descuento  SS 20170103
                                If val(lCfe.Items(i).cantidad) = 0 Or val(lCfe.Items(i).preciounitario) = 0 Then   ' AIR 20171214 se evita que divida por 0
                                    lCfe.Items(i).DescuentoPct = 0
                                Else
                                
                                    lCfe.Items(i).DescuentoPct = Round((val(lCfe.Items(i).DescuentoMonto) / (val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario))) * 100, 2)
                                End If
                            Else
                                lCfe.Items(i).DescuentoPct = "0"
                            End If
                        End If
                    End If
                Else
                    'If ConfFormato_Factura = "DTODASPARTES_SALINAS" Or ConfFormato_Factura = "DTODASPARTES_RIVERA" Then    ' SS 20160425
                    If ConfPuntoVta_Imprime_EFactura_Dscto_Incluido_en_Precio Then      ' SS 20180618
                        lCfe.Items(i).DescuentoMonto = "0"
                        lCfe.Items(i).DescuentoPct = "0"
                    Else
                        lCfe.Items(i).DescuentoMonto = Round((val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario)) - val(lrstLinMercaderia!Importe), 2)
                        
                        'If ConfFormato_Factura = "MANTA" Or ConfFormato_Factura = "MILY" Then   ' Enviamos el porcentaje descuento y la impresion del % SS 20170810
                        If ConfPuntoVta_Imprime_EFactura_Porcentaje_Descuento_Formato1 Then ' Enviamos el porcentaje descuento y la impresion del % SS 20180905
                            If (val(txtDtoGlobal.text) + val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) <> 0 Then
                                If val(txtDtoGlobal.text) <> 0 And (val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) = 0 Then
                                    lCfe.Items(i).DescuentoPct = val(txtDtoGlobal.text)
                                    lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                                Else
                                    If val(lrstLinMercaderia!dto1) <> 0 And (val(txtDtoGlobal.text) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3)) = 0 Then
                                        lCfe.Items(i).DescuentoPct = val(lrstLinMercaderia!dto1)
                                        lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                                    Else
                                        lCfe.Items(i).DescuentoPct = Round((((val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario)) - val(lrstLinMercaderia!Importe)) / (val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario))) * 100, 2)
                                        lCfe.Items(i).descAdicional = lCfe.Items(i).DescuentoPct & "%@@"
                                    End If
                                End If
                            End If
                         
                            'AIR 20201104 se agrega la posibilidad de elegir imprimir todos los procentajes de dscto de la lineas
                            ' en al factura al igual que se hace para el caso de e!imp_inc_facturador = "N"
                        Else
                            If ConfPuntoVta_Imprime_EFactura_Porcentaje_Descuento_Formato2 Then
                              'Para el porcentaje del dscto toma en cuenta solo los dsctos x linea
                                If val(lrstLinMercaderia!dto1) + val(lrstLinMercaderia!dto2) + val(lrstLinMercaderia!dto3) <> 0 Then
                                    lCfe.Items(i).DescuentoPct = Round((val(lCfe.Items(i).DescuentoMonto) / (val(lCfe.Items(i).cantidad) * val(lCfe.Items(i).preciounitario))) * 100, 2)
                                    
                                    lstrDsctos_Linea = ""
                                    
                                    If val(lrstLinMercaderia!dto1) <> 0 Then
                                        lstrDsctos_Linea = Format(vsfLineas_Mercaderia.TextMatrix(lCfe.Items(i).NroLinDet, CGL_DTO1), "0")
                                    End If
                                    If val(lrstLinMercaderia!dto2) <> 0 Then
                                        If lstrDsctos_Linea = "" Then
                                            lstrDsctos_Linea = Format(lrstLinMercaderia!dto2, "0")
                                        Else
                                            lstrDsctos_Linea = lstrDsctos_Linea & "+" & Format(lrstLinMercaderia!dto2, "0")
                                        End If
                                    End If
                                    If val(lrstLinMercaderia!dto3) <> 0 Then
                                        If lstrDsctos_Linea = "" Then
                                            lstrDsctos_Linea = Format(lrstLinMercaderia!dto3, "0")
                                        Else
                                            lstrDsctos_Linea = lstrDsctos_Linea & "+" & Format(lrstLinMercaderia!dto3, "0")
                                        End If
                                    End If
                                    If lstrDsctos_Linea <> "" Then
                                        lCfe.Items(i).descAdicional = lstrDsctos_Linea & "%@@"
                                    End If
                                End If
                            Else
                                lCfe.Items(i).DescuentoPct = "0"
                            End If
                        End If
                    End If
                End If
               ' lCfe.Items(i).MontoItem = Round(lCfe.Items(i).preciounitario * lCfe.Items(i).cantidad, 2) - Round(lCfe.Items(i).DescuentoMonto, 2)
            End If
            
            
            lrstLinMercaderia.MoveNext
            If lrstLinMercaderia.EOF Then
                Exit For
            End If
        Next i
        
        ' AIR 20190104 se deja de enviar la linea de redondeo cuando es igual a 0 por lo cual lo calificamos con -99 para que en el metodo de envioCfe lo identifique y lo descarte
        'Redondeo en la ultima linea
        
        lCfe.Items(UBound(lCfe.Items) - 1).NroLinDet = UBound(lCfe.Items)
        lCfe.Items(UBound(lCfe.Items) - 1).IndFact = IIf(ldblRedondeo > 0, 6, IIf(ldblRedondeo = 0, -99, 7))
        lCfe.Items(UBound(lCfe.Items) - 1).nomItem = "REDONDEO"
        lCfe.Items(UBound(lCfe.Items) - 1).cantidad = 1      ' AIR 20191210 es erroneo enviar cifras en negativo en la cantidad IIf(ldblRedondeo >= 0, 1, -1)
        lCfe.Items(UBound(lCfe.Items) - 1).UniMed = "N/A"
        lCfe.Items(UBound(lCfe.Items) - 1).preciounitario = Abs(ldblRedondeo)
        lCfe.Items(UBound(lCfe.Items) - 1).MontoItem = Abs(Round(ldblRedondeo, 2))
        lCfe.Items(UBound(lCfe.Items) - 1).tipoLinEntSis = ""
        lCfe.Items(UBound(lCfe.Items) - 1).DescuentoMonto = "0"
        lCfe.Items(UBound(lCfe.Items) - 1).DescuentoPct = "0"
        
        If e!Asociado_ASU = "S" Then    'Se agrega codigo para redondeo     SS 20190122
            lCfe.Items(UBound(lCfe.Items) - 1).Cod = "RED"
            lCfe.Items(UBound(lCfe.Items) - 1).codtipo = "INT1"
        End If
    End If
              
    'REFRENCIA, solo para devoluciones  -----------------------------------------------------------------------------------------------
    
    ReDim lCfe.Referencias(1)
    'AIR 20210906 se agrega referencia para las notas de debito que Efactura exige se envie alguna referencia o de lo contrario referencia global
    If D!signo = 1 Or D!clase = "NDEBITO" Then
        For i = 0 To UBound(lCfe.Referencias) - 1
            lCfe.Referencias(i).nroLinRef = i + 1
            SQL = "SELECT fe.*, f.fec_doc FROM faccmpefactura fe, faccmp f WHERE fe.cod_emp=" & val(txtEmpresa.text)
            SQL = SQL & " AND fe.cod_doc=" & val(txtDoc_Afectado.text)
            SQL = SQL & " AND fe.nro_doc=" & val(txtNro_Doc_Afectado.text)
            SQL = SQL & " AND fe.nro_doc=f.nro_doc AND fe.cod_doc = f.cod_doc AND fe.cod_emp=f.cod_emp AND fe.cod_prov=f.cod_prov "
            Set RE = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            If Not RE.EOF Then
                lCfe.Referencias(i).tpoDocRef = Trim(RE!TipoCAE) 'obtengoCodificacionDGITipoCFE(Trim(RE!tipoCAE))
                lCfe.Referencias(i).serie = Trim(RE!serie)
                lCfe.Referencias(i).nroCFERef = Trim(RE!numero)
                lCfe.Referencias(i).FechaCFEref = Format(RE!fec_doc, "dd/mm/yyyy")
                lCfe.Referencias(i).indicadorReferenciaGlobal = ""
                lCfe.Referencias(i).razonReferencia = ""
            Else
                'ATU, si no se encuentra la referencia se manda algo generico para que valide.
                lCfe.Referencias(i).tpoDocRef = ""
                lCfe.Referencias(i).serie = ""
                lCfe.Referencias(i).nroCFERef = ""
                lCfe.Referencias(i).FechaCFEref = ""
                lCfe.Referencias(i).indicadorReferenciaGlobal = "1"
                lCfe.Referencias(i).razonReferencia = "Documento " & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text
            End If
        Next i
    Else
        'ATU, por ahora para los documentos de venta no mandamos referencia alguna.
        For i = 0 To UBound(lCfe.Referencias) - 1
            lCfe.Referencias(i).nroLinRef = i + 1
            lCfe.Referencias(i).tpoDocRef = "SINREF"
        Next i

    End If
      
    'MEDIOS DE PAGO -------------------------------------------------------------------------------------------------------------------
    
    If lstrTipoDoc <> "REMITO" And lstrTipoDoc <> "ANULA REMITO" Then
    
        SQL = "SELECT count(*) as cantidad FROM Faccmpmpagos WHERE cod_emp = " & val(txtEmpresa.text) & " AND cod_doc = " & val(txtCodDoc.text) & " AND nro_doc = " & val(txtDoc.text) & " AND cod_prov = " & val(txtCodProv.text)
        Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If Not R.EOF Then
            If Not IsNull(R!cantidad) Then
                ReDim lCfe.mediosPago(R!cantidad)
                SQL = "SELECT * FROM Faccmpmpagos LEFT JOIN monedas on faccmpmpagos.moneda = monedas.codigo "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text) & " AND cod_doc = " & val(txtCodDoc.text) & " AND nro_doc = " & val(txtDoc.text) & " AND cod_prov = " & val(txtCodProv.text) & " order by cod_mpago"
                Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                i = 0
                Do While Not R.EOF
                    lCfe.mediosPago(i).nroLinMP = i + 1
                    lCfe.mediosPago(i).codMP = R!cod_mpago
                    lCfe.mediosPago(i).glosaMP = IIf(Busco_Medios_Pago(R!cod_mpago, M), f_Ins_String_Sin_Menor_Mayor(Trim(M!Descripcion)), "")
                    
                    lCfe.mediosPago(i).ordenMP = i + 1
                    ' AIR 20250506
                    'lCfe.mediosPago(i).valorPago = Round(R!Importe, 2)
                    If R!moneda = R!moneda_rec Then
                        lCfe.mediosPago(i).valorPago = Round(R!Importe, 2)
                    Else
                        lCfe.mediosPago(i).valorPago = Round(R!importe_rec, 2)
                    End If
                    i = i + 1
                    R.MoveNext
                Loop
            End If
        End If
    End If
    
    'ADENDAS    -----------------------------------------------------------------------------------------------------------------------
    
    'Se comenta para que en exportacion, tambien se puedan imprimir las adendas configurables   SS 20190705
    
'    If D!exportacion = "S" Or ConfFormato_Factura = "DALKAN" Or ConfFormato_Factura = "ROAD" Then
'          SQL = "SELECT count(*) as cantidad FROM Faccmp_Observaciones WHERE cod_emp = " & Val(txtEmpresa.text) & " AND cod_doc = " & Val(txtCodDoc.text) & " AND nro_doc = " & Val(txtDoc.text) & " AND cod_prov = " & Val(txtCodProv.text)
'          Set lrstObservacion = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
'          If Not lrstObservacion.EOF Then
'              If Not IsNull(lrstObservacion!cantidad) Then
'                  ReDim lCfe.adendas(lrstObservacion!cantidad + 2)
'              End If
'          End If
'    Else
          Select Case Formato_Factura_Auxiliar
              Case "BSGIMENEZ"
                  ReDim lCfe.adendas(11)
              Case "CASINO"
                  ReDim lCfe.adendas(5)   ' AIR 20200722 se aumenta 1 para imprimir la direccion completa
              Case "CASINO-POS"
                  ReDim lCfe.adendas(3)
              Case "EL_PALENQUE"
                  ReDim lCfe.adendas(5)
              Case "NACAR"
                  ReDim lCfe.adendas(6)
              Case "TECNILAN"
                  ReDim lCfe.adendas(4)
              Case "ZAIL"
                  ReDim lCfe.adendas(3)
              Case "ALMADU"
                  ReDim lCfe.adendas(3)
              Case "DUNIVER"
                  ReDim lCfe.adendas(4)
              Case "HIDRAL"
                  ReDim lCfe.adendas(10)
              Case "DISCARVI"
                  ReDim lCfe.adendas(5)
              Case "MANTA"
                  ReDim lCfe.adendas(3)
                  
      ' AIR 20200108 se pasa a Punto Union para adendas configurables
'              Case "PUNTOUNION"
'                  ReDim lCfe.adendas(4)  ' AIR se agrega el vendedor
                  
              Case "NUEVASG"
                  ReDim lCfe.adendas(3)  ' SS se agrega el vendedor
              Case Else
                  
                  ReDim lCfe.adendas(100) ' SS 20180302  para cargar las adendas que se indiquen en la configuracion
          End Select
'    End If
      
      
      
      
    
    Select Case Formato_Factura_Auxiliar
    
        Case "BSGIMENEZ"
        
            lstrMensaje_Dto_Contado = ""
            ldblImporte_Con_Dto_Contado = 0
            
            If Buscar_Moneda(val(txtMoneda.text), M) Then
            End If
            
            If Buscar_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), DOC) Then
                If Buscar_Forma_Pago(DOC!forma_pago, FP) Then
                    If FP!dias_a_sumar = 30 Then
                        ldblImporte_Con_Dto_Contado = DOC!Importe / 1.1
                        lstrMensaje_Dto_Contado = "Si paga antes de " & DateAdd("d", 8, DOC!fec_doc) & " abonará " & Trim(UCase(M!simbolo)) & " " & Format(ldblImporte_Con_Dto_Contado, "0.00")
                    End If
                End If
            End If
            
            If Buscar_Documento_Cabezal_Auxiliar(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), DOC_AUX) Then
            End If

            lstrMensaje_Conforme_L1 = ""
            lstrMensaje_Conforme_L2 = ""
            
            If Trim(UCase(D!clase)) = "CREDITO" Then
            
                If M!codigo = 1 Then
                    If DOC_AUX!tipo_doc_identidad <> 2 Then
                        ldblPorcentaje_Compensatorio = e!interes_comp_persona_mbase
                        ldblPorcentaje_Interes_Mora = e!interes_mora_persona_mbase
                    Else
                        ldblPorcentaje_Compensatorio = e!interes_comp_empresa_mbase
                        ldblPorcentaje_Interes_Mora = e!interes_mora_empresa_mbase
                    End If
                Else
                    If DOC_AUX!tipo_doc_identidad <> 2 Then
                        ldblPorcentaje_Compensatorio = e!interes_comp_persona_mreferencia
                        ldblPorcentaje_Interes_Mora = e!interes_mora_persona_mreferencia
                    Else
                        ldblPorcentaje_Compensatorio = e!interes_comp_empresa_mreferencia
                        ldblPorcentaje_Interes_Mora = e!interes_mora_empresa_mreferencia
                    End If
                End If
                
                If Buscar_Empresa(val(txtEmpresa.text), e1) Then
                End If
                
                
                lstrDecimales_en_Letras = ""
                lstrImporte_en_Letras = f_Importe_En_Letras(str(DOC!Importe), lstrDecimales_en_Letras)
                lstrImporte_en_Letras = Trim(lstrImporte_en_Letras) & " " & Trim(lstrDecimales_en_Letras)
                lstrImporte_en_Letras = Trim(lstrImporte_en_Letras) & String(3, "*")
                
                lstrMensaje_Conforme_L1 = UCase(lstrImporte_en_Letras)
                lstrMensaje_Conforme_L1 = Trim(lstrMensaje_Conforme_L1) & ". Que debemos y pagaremos a " & Trim(e1!razon_social) & " o a su orden el dia " & Format(txtFec_Vencimiento.text, "dd/mm/yyyy") & "."
                
                lstrMensaje_Conforme_L2 = ""
                If ldblPorcentaje_Compensatorio <> 0 Then
                    lstrMensaje_Conforme_L2 = "El No pago en la fecha estipulada generará un interés compensatorio del " & Format(ldblPorcentaje_Compensatorio, "0.00") & "%. "
                End If
                If ldblPorcentaje_Interes_Mora <> 0 Then
                    lstrMensaje_Conforme_L2 = Trim(lstrMensaje_Conforme_L2) & "La mora ocurrirá por el solo vencimiento del plazo estipulado y se castigará con un interés del " & Format(ldblPorcentaje_Interes_Mora, "0.00") & "% Anual."
                End If
            End If
            
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = Trim(txtCodDoc.text & " / " & txtDoc.text)
                
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "OBSERVACION"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " OBSERVACION : " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            End If
            
            lCfe.adendas(2).orden = 3
            lCfe.adendas(2).etiqueta = "Vendedor"
            lCfe.adendas(2).valor = Trim(TxtNomVen.text)
            lCfe.adendas(3).orden = 4
            lCfe.adendas(3).etiqueta = "FormaPago"
            lCfe.adendas(3).valor = Medios_Pago_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
            lCfe.adendas(4).orden = 5
            lCfe.adendas(4).etiqueta = "Hora"
            lCfe.adendas(4).valor = Format(time, "hh:mm:ss")
            lCfe.adendas(5).orden = 6
            lCfe.adendas(5).etiqueta = "CODIGOBARRASA"
            lCfe.adendas(5).valor = Trim(str(ConfPrefijo_Ticket_POSTVENTA)) & Format(val(txtCodDoc.text), "0000") & Format(val(txtDoc.text), "000000000") & Format(val(txtCodProv.text), "000000000") & Format("0", "000")
            lCfe.adendas(6).orden = 7
            lCfe.adendas(6).etiqueta = "OBSERVACIONES"
            lCfe.adendas(6).valor = f_Ins_String_Sin_Menor_Mayor(Left(Trim(txtObs.text), 100))
            lCfe.adendas(7).orden = 8
            lCfe.adendas(7).etiqueta = "ADENDA2"
            lCfe.adendas(7).valor = lstrMensaje_Dto_Contado
            lCfe.adendas(8).orden = 9
            lCfe.adendas(8).etiqueta = "ADENDA1"
            lCfe.adendas(8).valor = f_Ins_String_Sin_Menor_Mayor(Left(lstrMensaje_Conforme_L1, 250))
            lCfe.adendas(9).orden = 10
            lCfe.adendas(9).etiqueta = "ADENDA3"
            lCfe.adendas(9).valor = f_Ins_String_Sin_Menor_Mayor(Left(lstrMensaje_Conforme_L2, 250))
              
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                lCfe.adendas(10).orden = 11
                lCfe.adendas(10).etiqueta = "ADENDA4"
                lCfe.adendas(10).valor = Trim(UCase(D!nom_doc))
            Else
                lCfe.adendas(10).orden = 11
                lCfe.adendas(10).etiqueta = "ADENDA4"
                lCfe.adendas(10).valor = ""
            End If
          
        
        Case "CASINO-POS"
        
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = "NUMERO INTERNO : " & Trim(txtCodDoc.text & " / " & txtDoc.text)
            
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "Observaciones"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            End If
            
            If val(txtCodDoc.text) = 106 Then
                lCfe.adendas(2).orden = 3
                lCfe.adendas(2).etiqueta = "RECIBO "
                lCfe.adendas(2).valor = "ESTA FACTURA ADQUIERE VALOR DE RECIBO"
            Else
                lCfe.adendas(2).orden = 3
                lCfe.adendas(2).etiqueta = "RECIBO "
                lCfe.adendas(2).valor = " "
            End If
          
        Case "CASINO"
              
              lCfe.adendas(0).orden = 1
              lCfe.adendas(0).etiqueta = "DocumentoInterno"
              lCfe.adendas(0).valor = Trim(txtCodDoc.text & "/" & txtDoc.text)
              
              lCfe.adendas(1).orden = 2
              lCfe.adendas(1).etiqueta = "Observaciones"
              If D!signo = 1 Then
                  lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              Else
                  lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              End If
              
              lCfe.adendas(2).orden = 3
              lCfe.adendas(2).etiqueta = "Vendedor"
              lCfe.adendas(2).valor = Trim(txtVendedor.text)
              lCfe.adendas(3).orden = 4
              lCfe.adendas(3).etiqueta = "Descuento"
              lCfe.adendas(3).valor = Trim(txtDtoGlobal.text)
                
              'AIR 20200722
              lCfe.adendas(4).orden = 5
              lCfe.adendas(4).etiqueta = "Direccion:"
              lCfe.adendas(4).valor = f_Ins_String_Sin_Menor_Mayor(f_Direccion_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), gstrDireccion))
        
        
'        Case "EL_PALENQUE"
'
'              lCfe.adendas(0).orden = 1
'              lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
'              lCfe.adendas(0).valor = "NUMERO INTERNO : " & Trim(txtCodDoc.text & " / " & txtDoc.text)
'
'              lCfe.adendas(1).orden = 2
'              lCfe.adendas(1).etiqueta = "Observaciones"
'              If D!signo = 1 Then
'                  lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
'              Else
'                  lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
'              End If
'
'              lCfe.adendas(2).orden = 3
'              lCfe.adendas(2).etiqueta = "Vendedor"
'              lCfe.adendas(2).valor = Trim(TxtNomVen.text)
'              lCfe.adendas(3).orden = 4
'              lCfe.adendas(3).etiqueta = "FormaPago"
'              lCfe.adendas(3).valor = Medios_Pago_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
'              lCfe.adendas(4).orden = 5
'              lCfe.adendas(4).etiqueta = "Hora"
'              lCfe.adendas(4).valor = Format(time, "hh:mm:ss")
          
        
        Case "NACAR"
              
            lstrZona = ""
            If Buscar_Cliente(val(txtCodProv.text), C) Then
                If Buscar_Zona(C!nro_zon, Z) Then
                      lstrZona = Trim(UCase(Z!nom_zon))
                End If
            End If
            
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = "NUMERO INTERNO : " & Trim(txtCodDoc.text & " / " & f_Ins_String_Sin_Menor_Mayor(txtDoc.text))
              
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "Vendedor"
            lCfe.adendas(1).valor = "VENDEDOR : " & f_Ins_String_Sin_Menor_Mayor(Trim(TxtNomVen.text))
             
            lCfe.adendas(2).orden = 3
            lCfe.adendas(2).etiqueta = "ZONA"
            lCfe.adendas(2).valor = "ZONA/RUTA : " & f_Ins_String_Sin_Menor_Mayor(Trim(UCase(lstrZona)))
            
            lCfe.adendas(3).orden = 4
            lCfe.adendas(3).etiqueta = "Observaciones"
            If D!signo = 1 Then
                lCfe.adendas(3).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(3).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            End If
            
            lCfe.adendas(4).orden = 5
            lCfe.adendas(4).etiqueta = "CODIGOBARRASA"
            lCfe.adendas(4).valor = Trim(str(ConfPrefijo_Ticket_POSTVENTA)) & Format(val(txtCodDoc.text), "0000") & Format(val(txtDoc.text), "000000000") & Format(val(txtCodProv.text), "000000000") & Format("0", "000")
             
            lCfe.adendas(5).orden = 6
            lCfe.adendas(5).etiqueta = "HORA COBRO"
            lCfe.adendas(5).valor = Trim(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(C!horario_cobro))
              
          
        Case "TECNILAN"
              
              lCfe.adendas(0).orden = 1
              lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
              lCfe.adendas(0).valor = "NUMERO INTERNO : " & Trim(txtCodDoc.text & " / " & txtDoc.text)
              
              lCfe.adendas(1).orden = 2
              lCfe.adendas(1).etiqueta = "Observaciones"
              If D!signo = 1 Then
                  lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              Else
                  lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              End If
              
              lCfe.adendas(2).orden = 3
              lCfe.adendas(2).etiqueta = "Vendedor"
              lCfe.adendas(2).valor = Trim(TxtNomVen.text)
              lCfe.adendas(3).orden = 4
              lCfe.adendas(3).etiqueta = "FormaPago"
              lCfe.adendas(3).valor = Medios_Pago_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
        
          
        Case "ZAIL"
              
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = Trim(txtCodDoc.text & "/" & txtDoc.text)
              
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "OBSERVACION"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " OBSERVACION : " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = Trim(txtObs.text)
            End If
            
            If val(txtDtoGlobal.text) <> 0 Then
                lCfe.adendas(2).orden = 3
                lCfe.adendas(2).etiqueta = "Descuento"
                lCfe.adendas(2).valor = Trim(txtDtoGlobal.text) & " %"
            End If
        
        Case "DUNIVER"
              
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = Trim(txtCodDoc.text & "/" & txtDoc.text)
              
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "OBSERVACION"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " OBSERVACION : " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = Trim(txtObs.text)
            End If
            
            lCfe.adendas(2).orden = 3
            lCfe.adendas(2).etiqueta = "ADENDA1"
            If Buscar_Forma_Pago(val(txtForma_Pago.text), F) Then
                lCfe.adendas(2).valor = Trim(F!Descripcion)
            Else
                lCfe.adendas(2).valor = ""
            End If
                        
            lCfe.adendas(3).orden = 4
            lCfe.adendas(3).etiqueta = "ADENDA2"
            lCfe.adendas(3).valor = Trim(txtVendedor.text)
                        
        Case "HIDRAL"
              
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = Trim(txtCodDoc.text & "/" & txtDoc.text)
              
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "OBSERVACIONES"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " OBSERVACION : " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            End If
            
            lCfe.adendas(2).orden = 3
            lCfe.adendas(2).etiqueta = "ADENDA1"
            If Buscar_Forma_Pago(val(txtForma_Pago.text), F) Then
                lCfe.adendas(2).valor = Trim(F!Descripcion)
            Else
                lCfe.adendas(2).valor = ""
            End If
                        
            llngAdministrador = 0
            
            If val(TxtCodSuc.text) <> 0 Then
                ' Buscar Sucursal
                If Buscar_Sucursal(txtCodProv.text, TxtCodSuc.text, lrstSucursal) Then
                    If lrstSucursal!administrador <> 0 Then
                        llngAdministrador = lrstSucursal!administrador
                    End If
                End If
            Else
                If Buscar_Cliente(val(txtCodProv.text), C) Then
                    llngAdministrador = C!nro_cli_padre
                End If
            End If
            
            If llngAdministrador <> 0 Then
                If Buscar_Cliente(llngAdministrador, A) Then
                    lCfe.adendas(3).orden = 4
                    lCfe.adendas(3).etiqueta = "ADENDA2"
                    lCfe.adendas(3).valor = Trim(UCase(A!rsocial_cli))
                                
                    lCfe.adendas(4).orden = 5
                    lCfe.adendas(4).etiqueta = "ADENDA3"
                    lCfe.adendas(4).valor = Trim(A!dir_cli)
                
                    lCfe.adendas(5).orden = 6
                    lCfe.adendas(5).etiqueta = "ADENDA4"
                    lCfe.adendas(5).valor = f_Telefonos_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text))
                
                    lCfe.adendas(6).orden = 7
                    lCfe.adendas(6).etiqueta = "ADENDA5"
                    lCfe.adendas(6).valor = Trim(A!dia_cobro)
                
                    lCfe.adendas(7).orden = 8
                    lCfe.adendas(7).etiqueta = "ADENDA6"
                    lCfe.adendas(7).valor = Trim(A!horario_cobro)
                
                Else
                    lCfe.adendas(3).orden = 4
                    lCfe.adendas(3).etiqueta = "ADENDA2"
                    lCfe.adendas(3).valor = ""
                                
                    lCfe.adendas(4).orden = 5
                    lCfe.adendas(4).etiqueta = "ADENDA3"
                    lCfe.adendas(4).valor = ""
                
                    lCfe.adendas(5).orden = 6
                    lCfe.adendas(5).etiqueta = "ADENDA4"
                    lCfe.adendas(5).valor = ""
                
                    lCfe.adendas(6).orden = 7
                    lCfe.adendas(6).etiqueta = "ADENDA5"
                    lCfe.adendas(6).valor = ""
                
                    lCfe.adendas(7).orden = 8
                    lCfe.adendas(7).etiqueta = "ADENDA6"
                    lCfe.adendas(7).valor = ""
                End If
            Else
                lCfe.adendas(3).orden = 4
                lCfe.adendas(3).etiqueta = "ADENDA2"
                lCfe.adendas(3).valor = ""
                            
                lCfe.adendas(4).orden = 5
                lCfe.adendas(4).etiqueta = "ADENDA3"
                lCfe.adendas(4).valor = ""
            
                lCfe.adendas(5).orden = 6
                lCfe.adendas(5).etiqueta = "ADENDA4"
                lCfe.adendas(5).valor = ""
            
                lCfe.adendas(6).orden = 7
                lCfe.adendas(6).etiqueta = "ADENDA5"
                lCfe.adendas(6).valor = ""
            
                lCfe.adendas(7).orden = 8
                lCfe.adendas(7).etiqueta = "ADENDA6"
                lCfe.adendas(7).valor = ""
            End If
            
        If Buscar_Vendedor(val(txtVendedor.text), V) Then
            lCfe.adendas(8).orden = 9
            lCfe.adendas(8).etiqueta = "ADENDA7"
            lCfe.adendas(8).valor = Trim(V!nom_ven) & " " & Trim(V!ape_ven)
        Else
            lCfe.adendas(8).orden = 9
            lCfe.adendas(8).etiqueta = "ADENDA7"
            lCfe.adendas(8).valor = ""
        End If
            
        If Trim(D!observacion_fija_imprimir) <> "" Then
            lCfe.adendas(9).orden = 10
            lCfe.adendas(9).etiqueta = "ADENDA8"
            lCfe.adendas(9).valor = Trim(D!observacion_fija_imprimir)
        Else
            lCfe.adendas(9).orden = 9
            lCfe.adendas(9).etiqueta = "ADENDA8"
            lCfe.adendas(9).valor = ""
        End If
            
            
        Case "MANTA"
              
              lCfe.adendas(0).orden = 1
              lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
              lCfe.adendas(0).valor = Trim(txtCodDoc.text & " / " & txtDoc.text)
              
              lCfe.adendas(1).orden = 2
              lCfe.adendas(1).etiqueta = "OBSERVACION"
              If D!signo = 1 Then
                  lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              Else
                  lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              End If
              
              lCfe.adendas(2).orden = 3
              lCfe.adendas(2).etiqueta = "FormaPago"
              lCfe.adendas(2).valor = Medios_Pago_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
        
      ' AIR 20200108 se pasa a Punto Union para adendas configurables
        
'        Case "PUNTOUNION"

     
        Case "NUEVASG"
              
              lCfe.adendas(0).orden = 1
              lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
              lCfe.adendas(0).valor = Trim(txtCodDoc.text & " / " & f_Ins_String_Sin_Menor_Mayor(txtDoc.text))
              
              lCfe.adendas(1).orden = 2
              lCfe.adendas(1).etiqueta = "OBSERVACION"
              If D!signo = 1 Then
                  lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              Else
                  lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
              End If
              
              lCfe.adendas(2).orden = 3
              lCfe.adendas(2).etiqueta = "Vendedor"
              lCfe.adendas(2).valor = Trim(txtVendedor.text) & " - " & Trim(TxtNomVen.text)
                  
        Case Else
        
            lCfe.adendas(0).orden = 1
            lCfe.adendas(0).etiqueta = "TIPOYNUMERO"
            lCfe.adendas(0).valor = Trim(txtCodDoc.text & " / " & txtDoc.text)
                
            lCfe.adendas(1).orden = 2
            lCfe.adendas(1).etiqueta = "OBSERVACIONES"
            If D!signo = 1 Then
                lCfe.adendas(1).valor = "REF:" & txtDoc_Afectado.text & "/" & txtNro_Doc_Afectado.text & " OBSERVACIONES : " & f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))
            Else
                lCfe.adendas(1).valor = f_Ins_String_Sin_Menor_Mayor(Trim(txtObs.text))           ' repetia OBSERVACION   SS 20160524
            End If
            
            'AIR 20250716 si afecta Acopio se envia el nro en el Acopio.
'            If Trim(txtAcopio.text) <> "" Then
'                lCfe.adendas(1).valor = lCfe.adendas(1).valor & " - ACOPIO NRO.: " & Trim(txtAcopio.text)
'            End If
                        
            ' JE 20250708   /   cambio el trim por val porque viene un 0 y entraba aqui cuando no debe hacerlo
            If val(txtAcopio.text) <> 0 Then
                lCfe.adendas(1).valor = lCfe.adendas(1).valor & " - ACOPIO NRO.: " & val(txtAcopio.text)
            End If
            
            If ConfPuntoVta_Imprime_EFactura_Lista_Precio Then      ' AIR 20180216
                lCfe.adendas(2).orden = 3
                lCfe.adendas(2).etiqueta = "Lista Precio"
                lCfe.adendas(2).valor = Trim(txtLista.text) & " - " & Trim(txtNombre_Lista.text)
            End If
            
            'Agregamos todo el detalle de exportacion, las observaciones extendidas
            
            'AIR 20220811 se agrega a NOETAR en el if
            'AIR 20240606 se agrega a FARACOR en el if
            'AIR 20240607 se pasa a adenda configurable la impresion de las observaciones Extendidas
            
            If D!exportacion = "S" Or ConfFormato_Factura = "DALKAN" Or ConfFormato_Factura = "ROAD" Or ConfFormato_Factura = "NOETAR" Or ConfFormato_Factura = "FARACOR" _
            Or ConfPuntoVta_Imprime_EFactura_Observacion_Extendida Then
            
                SQL = "SELECT * FROM Faccmp_Observaciones WHERE cod_emp = " & val(txtEmpresa.text) & " AND cod_doc = " & val(txtCodDoc.text) & " AND nro_doc = " & val(txtDoc.text) & " AND cod_prov = " & val(txtCodProv.text) & " ORDER BY linea "
                Set lrstObservacion = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                Do While Not lrstObservacion.EOF
                  
                    lCfe.adendas(lrstObservacion!linea + 1).orden = lrstObservacion!linea + 2

                    
                    Select Case ConfFormato_Factura
                    Case "ROAD"
                        lCfe.adendas(lrstObservacion!linea + 1).etiqueta = " "
                        If lrstObservacion!linea = 1 Then
                            lCfe.adendas(lrstObservacion!linea + 1).valor = "            " & Left(Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 241) ' AIR 18/11/2015  agregue el left
                        Else
                            lCfe.adendas(lrstObservacion!linea + 1).valor = "            " & Left(Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 241)  ' AIR 18/11/2015 agregue el left
                        End If
                        
                    Case "NOETAR"
                    
                        Select Case lrstObservacion!linea
                        Case 1
                            lCfe.adendas(lrstObservacion!linea + 1).etiqueta = "Your Ref "
                        Case 2
                            lCfe.adendas(lrstObservacion!linea + 1).etiqueta = "Our Ref "
                        Case Else
                            lCfe.adendas(lrstObservacion!linea + 1).etiqueta = "         "
                        End Select
                        
                        lCfe.adendas(lrstObservacion!linea + 1).valor = "   " & Left(Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 241) ' AIR 18/11/2015  agregue el left
                    
                     Case "FARACOR"
                            lCfe.adendas(lrstObservacion!linea + 1).etiqueta = ""
                            lCfe.adendas(lrstObservacion!linea + 1).valor = Left("" & Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 255)    ' AIR 18/11/2015 agregue el left

                    Case Else
                    
                        lCfe.adendas(lrstObservacion!linea + 1).etiqueta = "REFERENCE"
                        If lrstObservacion!linea = 1 Then
                            lCfe.adendas(lrstObservacion!linea + 1).valor = "REFERENCE : " & Left(Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 241) ' AIR 18/11/2015  agregue el left
                        Else
                            lCfe.adendas(lrstObservacion!linea + 1).valor = "            " & Left(Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Sin_Ampersand(lrstObservacion!observacion))), 241)  ' AIR 18/11/2015 agregue el left
                        End If
                        
                    End Select
                    
                    lrstObservacion.MoveNext
                Loop
            
            'Else   'Para el caso de exportaciones y DALKAN y ROAD, se agrega las adendas configurables     SS 20190725
            End If
            
            Call Cargo_Clase_CFE_Adendas_Configurables(D, lrstClientes, lrstFuncionarios, lrstAgencias)
            

    End Select
              
    'TOTALES POR RETENCION - RESGUARDOS     SS 20160331 -------------------------------------------------------------------------------
      
    If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
        SQL = "SELECT codigo FROM FaccmpServicios"
        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
        SQL = SQL & " AND   cod_doc = " & val(txtCodDoc.text)
        SQL = SQL & " AND   nro_doc = " & val(txtDoc.text)
        SQL = SQL & " AND   cod_prov = " & val(txtCodProv.text)
        SQL = SQL & " GROUP BY codigo"
        Set lrstTotRet = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If Not lrstTotRet.EOF Then
            i = 0
            Do While Not lrstTotRet.EOF
                i = i + 1
                lrstTotRet.MoveNext
            Loop
                
            ReDim lCfe.retenciones(i)
                
            SQL = "SELECT ma_Insumos_Servicios.codigo_retencion_dgi, sum(FaccmpServicios.importe * documentos.signo * -1) AS TotImp"
            SQL = SQL & " FROM FaccmpServicios"
            SQL = SQL & " INNER JOIN ma_Insumos_Servicios"
            SQL = SQL & " ON  ma_Insumos_Servicios.Codigo = FaccmpServicios.codigo"
            SQL = SQL & " INNER JOIN documentos ON documentos.cod_doc = FaccmpServicios.cod_doc"
            SQL = SQL & " WHERE FaccmpServicios.cod_emp = " & val(txtEmpresa.text)
            SQL = SQL & " AND   FaccmpServicios.cod_doc = " & val(txtCodDoc.text)
            SQL = SQL & " AND   FaccmpServicios.nro_doc = " & val(txtDoc.text)
            SQL = SQL & " AND   FaccmpServicios.cod_prov = " & val(txtCodProv.text)
            SQL = SQL & " GROUP BY ma_Insumos_Servicios.codigo_retencion_dgi"
            Set lrstTotRet = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            i = 0
            Do While Not lrstTotRet.EOF
                lCfe.retenciones(i).CodRet = lrstTotRet!codigo_retencion_dgi
                lCfe.retenciones(i).ValRetPerc = Round(lrstTotRet!TotImp, 2)
                i = i + 1
                lrstTotRet.MoveNext
            Loop
        End If
    End If

    'IMPRESION  -----------------------------------------------------------------------------------------------------------------------
        
    If Trim(UCase(D!eFactura_Imprimir_Local)) = "S" Then
        
        ' Impresion en Impresora Local
        
        lCfe.imprimirFactura = "N"
        lCfe.impresora = D!impresora
        lCfe.vias = D!cantidad_vias
        
        If Trim(D!Autorizar) = "S" And (sspOperacion.Caption = "A" Or sspOperacion.Caption = "M") Then
          lCfe.formatoFactura = f_Ins_String_Sin_Menor_Mayor(D!formato_simulacion)
          lCfe.simular = 10
        Else
          lCfe.formatoFactura = f_Ins_String_Sin_Menor_Mayor(D!formato_impresion)
          lCfe.simular = 0
        End If
        
    Else
    
        If Trim(UCase(D!se_Imprime)) = "C" Then
           sigo = MsgBox("Desea Imprimir el Documento?", vbYesNo + vbInformation, MsgTit)
           If sigo = vbNo Then
               lCfe.imprimirFactura = "N"
           Else
               lCfe.imprimirFactura = "S"
           End If
        Else
        
            ' Impresion desde Impresora del Servidor de eFactura
            'If Trim(UCase(D!se_Imprime)) = "N" Then ' AIR 20221209 Se agrega opcion que solo es para eFactura valor P(PDF) - obtiene PDF
            If Trim(UCase(D!se_Imprime)) = "N" Or Trim(UCase(D!se_Imprime)) = "P" Then
                lCfe.imprimirFactura = "N"
                lCfe.impresora = ""
                lCfe.formatoFactura = ""
                lCfe.vias = 0
            Else
                lCfe.imprimirFactura = "S"
            End If
        End If

        lCfe.impresora = D!impresora
        lCfe.vias = D!cantidad_vias
        If Trim(D!Autorizar) = "S" And (sspOperacion.Caption = "A" Or sspOperacion.Caption = "M") Then
          lCfe.formatoFactura = f_Ins_String_Sin_Menor_Mayor(D!formato_simulacion)
          lCfe.simular = 10
        Else
          lCfe.formatoFactura = f_Ins_String_Sin_Menor_Mayor(D!formato_impresion)
          lCfe.simular = 0
        End If
    
    End If
               
    'ENVIO DE MAIL  -------------------------------------------------------------------------------------------------------------------
    Call EnvioMail(lstrTipoDoc, e)
    

     
Exit Sub
Errores:
 
    MsgBox "Error al Cargar la CLASE CFE. Error : " & Err.number & " " & Err.Description, vbCritical, MsgTit
    lCfe.cae.numero = 0
    
Exit Sub
    Resume

End Sub






Public Sub Cargo_Clase_CFE_UY_2(D As Recordset, ByRef pstrId As String, ByRef e As Recordset, ByRef lrstMoneda As Recordset, ByRef lstrTipoDoc As String, ByRef ldblRedondeo As Double)
On Error GoTo Errores
Dim lrstObservacion As Recordset
Dim A As Recordset
Dim C As Recordset
Dim F As Recordset
Dim M As Recordset
Dim R As Recordset
Dim V As Recordset
Dim TE As Recordset

Dim e1 As Recordset
Dim Z As Recordset
Dim FP As Recordset
Dim RE As Recordset
Dim RDESC As Recordset
Dim DOC As Recordset
Dim DOC_AUX As Recordset
Dim lrstSucursal As Recordset
Dim lrstInsServ As Recordset
Dim lrstRetenciones As Recordset
Dim lrstTotRet As Recordset
Dim lrstTotalDet As Recordset
Dim lrstClientes As Recordset
Dim lrstArticulos As Recordset
Dim lrstGarantias As Recordset
Dim FLinArtCod As Recordset
Dim lrstFuncionarios As Recordset
Dim lrstAgencias As Recordset
Dim lrstDocReferencia As Recordset
Dim lrstMagnitudes As Recordset
Dim lrstDocImpuestos As Recordset
Dim lrstTitular As Recordset
Dim lrstPais As Recordset
Dim lrstLinMercaderia As Recordset   ' AIR 20201015
Dim lrstProv As Recordset       ' AIR 20210406

Dim lintOrdenAdenda As Integer
Dim lcantlinserv As Integer
Dim i As Integer
Dim sigo As Integer
Dim lstrMensaje_Dto_Contado As String
Dim ldblImporte_Con_Dto_Contado As Double
Dim lstrMensaje_Conforme_L1 As String
Dim lstrMensaje_Conforme_L2 As String
Dim lstrMensaje_Conforme_L3 As String
Dim lstrMensaje_Conforme_L4 As String
Dim lstrMensaje_Conforme_L5 As String
Dim lstrMensaje_Conforme_L6 As String
Dim lstrImporte_en_Letras As String
Dim lstrDecimales_en_Letras As String
Dim ldblPorcentaje_Compensatorio As Double
Dim ldblPorcentaje_Interes_Mora As Double
Dim lstrZona As String
Dim ldblImporte_Sin_Iva As Double
Dim llngAdministrador As Long
Dim lstrFuncionario As String
Dim llngCod_AgenciaEnvio  As Long
Dim lstrAgenciaEnvio As String
Dim lstrHorarioCliente As String
Dim lstrDsctos_Linea As String
Dim lstrNombre_Suc As String

Dim ldblTotalNoGrv As Double
Dim ldblTotalNetoIvaTasaMin As Double
Dim ldblTotalIVATasaMin As Double
Dim ldblTotalNetoIvaTasaBasica As Double
Dim ldblTotalIVATasaBas As Double
Dim ldblTotalNetoIVAOtra As Double
Dim ldblTotalIVAOtra As Double
Dim ldblTotalIVASuspenso As Double
Dim ldblTotalImptoPercibido As Double
Dim ldblSaldo_Estado_CuentaMonBase As Double
Dim ldblSaldo_Estado_CuentaMonRef As Double

Dim lstrSQL As String

Dim Filenum As Integer                      ' AIR 20190827
Dim lstrNombre_Archivo As String            ' AIR 20190827
Dim lstrRutaRepositorioFirmas  As String    ' AIR 20190827
Dim bArray() As Byte                        ' AIR 20180827
Dim lstrByte As String                      ' AIR 20190827

Dim lblnasignaGenerico As Boolean           ' AIR 20191212
Dim lstrDescripcion_Corta As String         ' AIR 20210617

Dim RM As Recordset                         'JCH 20220617
Dim RD As Recordset                         'JCH 20220617


    'VARIOS     -----------------------------------------------------------------------------------------------------------------------
      
    lCfe.varios.comprobanteTipo = fComprobanteTipo(val(txtCodDoc.text), Trim(txtTipo_Doc_Identidad.text))
    lCfe.varios.fchEmis = Format(txtFec_Doc.text, "dd/mm/yyyy")
    lCfe.varios.fchVenc = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
    lCfe.varios.FmaPago = fFmaPago(val(txtCodDoc.text))
    'Aca va 0 si es exportacion
    'AIR 20200310 si se elige enviar los precios sin iva incluido el indicador es 0
    'jch se elimino este if porque se paso la function fmntbruto 16.01.2025
    'If ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = False And e!imp_inc_facturador = "S" Then
    '    lCfe.varios.mntBruto = 0
    'Else
        lCfe.varios.mntBruto = fMntBruto(val(txtEmpresa.text))
    'End If
    
    lCfe.varios.Nro = lCfe.cae.numero
    lCfe.varios.nroReferencia = lCfe.cae.numeroAutorizacion
    lCfe.varios.serie = lCfe.cae.serie
    
    ' AIR 20231218
    If Trim((ConfPuntoVta_Efactura_Info_Adicional_del_Doc)) <> "" And ConfPuntoVta_Cliente_Turista_No_Residente = txtCodProv.text And txtTipo_Doc_Identidad.text <> 2 Then
        lCfe.varios.infoAdicionalDoc = Trim((ConfPuntoVta_Efactura_Info_Adicional_del_Doc))
    Else
        lCfe.varios.infoAdicionalDoc = ""
    End If
        
    If Trim(D!exportacion) = "S" Then       'Exportacion
        'String sin validacion maximo largo 3, puede ser FOB, CIF, etc.
        lCfe.varios.clauVenta = Trim(UCase(txtClauVta.text))

        
        '1 - Régimen General, 2 - Consignación, 3 - Precio Revisable ,4 - Bienes propios a exclaves aduaneros, 90 Régimen generalexportación de servicios, 99- Otras transacciones
        lCfe.varios.modVenta = "1"
        
        '1 - Marítimo, 2 - Aéreo, 3 - Terrestre, 8 - N/A, 9 - Otro (si no va hay que mandar 8)
        lCfe.varios.viaTransp = Trim(Mid(txtViaTransporte.text, 1, 1))
    End If
    
    If lstrTipoDoc = "REMITO" Or lstrTipoDoc = "ANULA REMITO" Or Trim(D!exportacion) = "S" Then
        '1 Venta /2 Traslados internos (solo va en remito o remito exportacion)
        If D!tipo_traslado_remito <> 0 Then
            lCfe.varios.tipoTraslado = D!tipo_traslado_remito
        Else
            lCfe.varios.tipoTraslado = "1"
        End If
    End If
    
    'Envio de imagen
    'AIR 20190827 se agrega para el envio de Imagen en CFE como ByteArray
    If ConfPuntoVta_Envia_Imagen_En_Adenda = True Then
    
        lstrRutaRepositorioFirmas = "\\" & confEQUIPO_SERVIDOR_ARCHIVOS & ConfDirectorio_Firmas_Digitales
        lstrNombre_Archivo = lstrRutaRepositorioFirmas & txtEmpresa.text & txtCodDoc.text & txtDoc.text & txtCodProv.text & ".bmp"
        
        If Dir(lstrNombre_Archivo, vbArchive) <> "" Then
        
            Filenum = FreeFile
            Open lstrNombre_Archivo For Binary As Filenum
            ReDim bArray(LOF(Filenum) - 1)
            Get Filenum, , bArray
            Close Filenum
        
            lstrByte = GetBase64String(bArray)
            lCfe.varios.datosExtras = lstrByte
        End If
    Else
        lCfe.varios.datosExtras = ""
    End If
    
    
    'RECEPTOR   -----------------------------------------------------------------------------------------------------------------------
      
    If ConfFormato_Factura = "BSGIMENEZ" Then
        If val(txtTipo_Doc_Identidad.text) = 4 And Trim(TxtRuc.text) = "" Then
            TxtRuc.text = "-"
        End If
    End If
      
      
    lCfe.receptor.tipoDocRecep = fTipoDocRecep(Trim(txtTipo_Doc_Identidad.text), Trim(TxtRuc.text), Trim(lCfe.cae.Tipo), val(txtCodProv.text))
     
    ' AIR 20191212 se agrega el analisis de el pais del Clientes o Proveedor para enviar el pais a E-Factura
'    If Trim(D!exportacion) <> "S" Then
'        If lCfe.receptor.tipoDocRecep = "6" Then
'            lCfe.receptor.codPaisRecep = Mid(txtTipo_Doc_Identidad.Columns(1).text, 1, 2)
'        Else
'            lCfe.receptor.codPaisRecep = "UY"
'        End If
'    Else
'        lCfe.receptor.codPaisRecep = sacoCodigoPaisDGI(Trim(TxtPais.text))
'    End If
          
    lblnasignaGenerico = False
    If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
        Call Buscar_Proveedor(txtCodProv.text, lrstTitular)
    Else
        Call Buscar_Cliente(txtCodProv.text, lrstTitular)
    End If
    
    If lrstTitular.EOF Or Trim(D!exportacion) = "S" Then
        lblnasignaGenerico = True
    Else
        If lrstTitular!generico = "S" Then
            lblnasignaGenerico = True
        Else
            If Busco_Pais(lrstTitular!pais, lrstPais) Then
                If Trim(lrstPais!codigo_pais_DGI) <> "" Then
                    lCfe.receptor.CodPaisRecep = Trim(lrstPais!codigo_pais_DGI)
                Else
                    ' AIR 20191212 se deja para compatibilidad con version anterior de la codificacion
                    If Trim(D!exportacion) = "S" Then
                        lCfe.receptor.CodPaisRecep = sacoCodigoPaisDGI(Trim(txtPais.text))
                    Else
                        lblnasignaGenerico = True
                    End If
                
                End If
            Else
                lblnasignaGenerico = True
            End If
         End If
    End If
    
    If lblnasignaGenerico = True Then
        If Trim(D!exportacion) <> "S" Then
            If lCfe.receptor.tipoDocRecep = "6" Then
                lCfe.receptor.CodPaisRecep = Mid(txtTipo_Doc_Identidad.Columns(1).text, 1, 2)
            Else
                lCfe.receptor.CodPaisRecep = "UY"
            End If
        Else
            lCfe.receptor.CodPaisRecep = sacoCodigoPaisDGI(Trim(txtPais.text))
        End If
    End If
  
    lCfe.receptor.docRecep = IIf(Trim(TxtRuc.text) = "", "0", Trim(TxtRuc.text))
    
    'Establece Nombre Sucursal
    If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
        lstrNombre_Suc = ""
    Else
        lstrNombre_Suc = TxtNomSuc.text
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), lrstSucursal) Then
            If lrstSucursal!nombre <> "" Then
                lstrNombre_Suc = f_Ins_String_Sin_Menor_Mayor(Trim(lrstSucursal!nombre))
            End If
        End If
    End If
    
    'Establece Razon Social
    If ConfFormato_Factura = "DISCARVI" Then            ' SS 20170523
        lCfe.receptor.RznSocRecep = "(" & Trim(txtCodProv.text) & ") - " & Trim(UCase(txtNomCli.text))
    Else
        If val(txtCodProv.text) = 0 Then
                
            'lCfe.receptor.rznSocRecep = Trim(UCase(txtNomCli.text))
            ' AIR 20190415
            lCfe.receptor.RznSocRecep = IIf(Trim(UCase(txtNomCli.text)) = "", "-", f_Ins_String_Sin_Menor_Mayor(Trim(UCase(txtNomCli.text))))
        Else
            If ConfPuntoVta_Imprime_Efactura_Codigo_Cliente Then                ' SS 20190129
                If ConfPuntoVta_Imprime_EFactura_Nombre_Sucursal_Primero Then   ' SS 20180227
                    lCfe.receptor.RznSocRecep = "(" & Trim(txtCodProv.text) & IIf(val(TxtCodSuc.text) <> 0, ") " & Trim(TxtCodSuc.text) & " - " & (lstrNombre_Suc) & " /", ")") & " " & f_Ins_String_Sin_Menor_Mayor(Trim(UCase(txtNomCli.text)))
                Else
                    lCfe.receptor.RznSocRecep = "(" & Trim(txtCodProv.text) & ") " & Trim(UCase(txtNomCli.text)) & IIf(val(TxtCodSuc.text) <> 0, " / " & Trim(TxtCodSuc.text) & " - " & lstrNombre_Suc, " ")
                End If
            Else
                If ConfPuntoVta_Imprime_EFactura_Nombre_Sucursal_Primero Then
                    lCfe.receptor.RznSocRecep = IIf(val(TxtCodSuc.text) <> 0, lstrNombre_Suc & " / ", "") & Trim(UCase(txtNomCli.text))
                Else
                    lCfe.receptor.RznSocRecep = Trim(UCase(txtNomCli.text)) & IIf(val(TxtCodSuc.text) <> 0, " / " & lstrNombre_Suc, " ")
                End If
            End If
        End If
    End If
    
    'Establece Direccion        ATU 20171110, se incorpora la direccion en los resguardos
     
     'AIR 20200713 efactura solo acepta 70 caracteres en la direccion
    If lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO" Then
        lCfe.receptor.dirRecep = Mid(f_Direccion_Proveedor(val(txtCodProv.text), gstrDireccion), 1, 70)
        If lCfe.receptor.dirRecep = "" Then
            lCfe.receptor.dirRecep = "-"
        End If
        lCfe.receptor.ciudadRecep = "-"
        lCfe.receptor.deptoRecep = "-"
    Else
       
        lCfe.receptor.dirRecep = Mid(f_Ins_String_Sin_Menor_Mayor(f_Direccion_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), gstrDireccion)), 1, 70)
        lCfe.receptor.ciudadRecep = f_Ins_String_Sin_Menor_Mayor(f_Ciudad_Cliente_Sucursal(txtCodProv.text, TxtCodSuc.text, glngCod_Ciudad))
        lCfe.receptor.deptoRecep = f_Ins_String_Sin_Menor_Mayor(f_Departamento_Cliente_Sucursal(txtCodProv.text, TxtCodSuc.text, glngCod_Departamento))
    End If
    
    'Informacion Adicional en el Cabezal, NO apto para RESGUARDOS
    If lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then

        If ConfFormato_Factura = "DISCARVI" Then            ' Sucursal  SS 20170623
            If val(TxtCodSuc.text) <> 0 Then
                lCfe.receptor.InfoAdicional = Trim(TxtCodSuc.text) & "  -  " & f_Ins_String_Sin_Menor_Mayor(lstrNombre_Suc)
            End If
        Else
            If ConfFormato_Factura = "ROAD" Then            ' Telefonos SS 20170515
                lCfe.receptor.InfoAdicional = f_Ins_String_Sin_Menor_Mayor(f_Telefonos_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text)))
            Else
                If ConfFormato_Factura = "PUNTOUNION" Then  ' Telefonos SS 20170515
                    lCfe.receptor.InfoAdicional = f_Ins_String_Sin_Menor_Mayor(f_Telefonos_Cliente_Sucursal_con_Generico(val(txtCodProv.text), val(TxtCodSuc.text), gstrTelefonos))
                Else
                    If ConfFormato_Factura = "25MAYO" Then  ' Nombre comercial  SS 20170717
                        If val(txtCodProv.text) <> 0 Then
                            If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
                                lCfe.receptor.InfoAdicional = f_Ins_String_Sin_Menor_Mayor(Trim(lrstClientes!nombre_fantasia))
                            End If
                        End If
                    Else
                        If ConfPuntoVta_Imprime_EFactura_Observacion_Cliente Then   ' SS 20180705
                            lCfe.receptor.InfoAdicional = f_Ins_String_Sin_Menor_Mayor(f_Observa_Factura_Cliente_Sucursal(txtCodProv.text, TxtCodSuc.text))
                        End If
                    End If
                End If
            End If
        End If
    
        If ConfPuntoVta_Imprime_EFactura_Nombre_Fantasia Then   'Se agrega en la infoAdicional  SS 20171222
                If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
                    If lrstClientes!generico = "N" Then
                        If Trim(lCfe.receptor.InfoAdicional) <> "" Then
                            lCfe.receptor.InfoAdicional = lCfe.receptor.InfoAdicional & " / " & f_Ins_String_Sin_Menor_Mayor(Trim(lrstClientes!nombre_fantasia))
                        Else
                            lCfe.receptor.InfoAdicional = f_Ins_String_Sin_Menor_Mayor(Trim(lrstClientes!nombre_fantasia))
                        End If
                    End If
                End If
        End If
               
        If ConfPuntoVta_Imprime_EFactura_Telefono Then          'Se agrega Telefono en la infoAdicional  SS 20180607
                If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
                    If lrstClientes!generico = "N" Then
                        If Trim(lCfe.receptor.InfoAdicional) <> "" Then
                            lCfe.receptor.InfoAdicional = lCfe.receptor.InfoAdicional & " / Tel " & f_Ins_String_Sin_Menor_Mayor(f_Telefonos_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text)))
                        Else
                            lCfe.receptor.InfoAdicional = "Tel " & f_Ins_String_Sin_Menor_Mayor(f_Telefonos_Cliente_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text)))
                        End If
                    End If
                End If
        End If
        
        'Establece Lugar Destino Entrega Recepcion      AIR 20171124
        If Buscar_Sucursal(txtCodProv.text, TxtCodSuc.text, lrstSucursal) Then
            lCfe.receptor.LugarDestEntRecep = f_Ins_String_Sin_Menor_Mayor(Trim(lrstSucursal!LugarDestEntRecep))
        End If
        'Establece Orden de Compra                      AIR 20171124
        If (TxtNroIdCompra.text) <> "" Then
            lCfe.receptor.NroIdCompra = TxtNroIdCompra.text
        End If
    End If
    
    Exit Sub
    
Errores:


End Sub

Sub EnvioMail(lstrTipoDoc As String, ByRef e As Recordset)

Dim lrstSucursal As Recordset
Dim lrsteMails_x_TDoc As Recordset
Dim lrstProv As Recordset
Dim lrstCli As Recordset    'AIR 20240513

    'ENVIO DE MAIL  -------------------------------------------------------------------------------------------------------------------
        
    If (lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO") Then   'Documentos no pueden ser resguardo
        ReDim lCfe.emailEnvioPdf(1)
        
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), lrstSucursal) Then    ' SS 20160223
            ' JE 20240614   / Reviso si hay un email especifico para el Tipo de Documento sino se toma el generico
            If Buscar_eMails_para_Enviar_Cliente_Sucursal_x_Tipo_Documento(val(txtCodProv.text), val(TxtCodSuc.text), val(txtCodDoc.text), lrsteMails_x_TDoc) Then
                lCfe.emailEnvioPdf(0) = f_Ins_String_Sin_Menor_Mayor(lrsteMails_x_TDoc!email)
            Else
                If Trim(lrstSucursal!EmailEnvioFact) <> "" Then
                    lCfe.emailEnvioPdf(0) = f_Ins_String_Sin_Menor_Mayor(lrstSucursal!EmailEnvioFact)
                Else
                    lCfe.emailEnvioPdf(0) = ""
                End If
            End If
            
            If Trim(lrstSucursal!TextoEMailEnvio) <> "" Then                                ' SS 20190129
                lCfe.emailCuerpo = f_Ins_String_Sin_Menor_Mayor(Trim(lrstSucursal!TextoEMailEnvio))
                    
                'AIR 20240513
                If ConfInf_Estado_Cuenta_Imprime_Whatsapp = True Then
                    If Buscar_Cliente(val(txtCodProv.text), lrstCli) Then
                        lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + Chr(13) + "REFERENCIA: " + lrstCli!rsocial_cli
                        lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + "GRUPO: " + str(lrstCli!grupo)                  ' AIR 20250910
                        lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + "WHATSAPP: " + lrstCli!celular + Chr(13)
                    End If
                End If
                                
            Else
                If Trim(e!eMail_texto_generico_envio_factura) <> "" Then   ' AIR 20210504
                    lCfe.emailCuerpo = f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(f_Ins_String_Sin_Menor_Mayor(Trim(e!eMail_texto_generico_envio_factura)))
                    
                    'AIR 20240513
                    If ConfInf_Estado_Cuenta_Imprime_Whatsapp = True Then
                        If Buscar_Cliente(val(txtCodProv.text), lrstCli) Then
                            lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + Chr(13) + "REFERENCIA: " + lrstCli!rsocial_cli
                            lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + "GRUPO: " + str(lrstCli!grupo)                      ' AIR 20250910
                            lCfe.emailCuerpo = lCfe.emailCuerpo + Chr(13) + "WHATSAPP: " + lrstCli!celular + Chr(13)
                        End If
                    End If
                Else
                    lCfe.emailCuerpo = ""
                End If
            End If
        Else
            lCfe.emailEnvioPdf(0) = ""
            lCfe.emailCuerpo = ""
        End If
    Else
        ReDim lCfe.emailEnvioPdf(1)
        lCfe.emailEnvioPdf(0) = ""
        lCfe.emailCuerpo = ""
    End If
    
    ' AIR 20210406 se agrega la posibilidad de enviar mail con el resguardo generado.
    If (lstrTipoDoc = "RESGUARDO" Or lstrTipoDoc = "ANULA RESGUARDO") And e!Enviar_EMail_a_Proveedor = "S" Then
        ReDim lCfe.emailEnvioPdf(1)
        
        If Buscar_Proveedor(txtCodProv.text, lrstProv) Then
            lCfe.emailEnvioPdf(0) = f_Ins_String_Sin_Menor_Mayor(lrstProv!email)
            If Trim(e!eMails_proveedor_texto_generico) <> "" Then
                lCfe.emailCuerpo = f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(f_Ins_String_Sin_Menor_Mayor(Trim(e!eMails_proveedor_texto_generico)))
            Else
                lCfe.emailCuerpo = ""
            End If
        Else
            lCfe.emailEnvioPdf(0) = ""
            lCfe.emailCuerpo = ""
        End If
    End If
     
    lCfe.emailCuerpo = QuitarCaracteresReservadosXML(lCfe.emailCuerpo)
End Sub

Function Listar_Pedidos_Detallado(pstrTitulo As String)

' Seteo los Campos para los Filtros
Call Limpio_Vectores_Filtros_Orden

gfiltros_nombre_campo(1) = "Nro. Pedido"
gfiltros_nombre_campo(2) = "Cliente"
gfiltros_nombre_campo(3) = "Fecha Entrega"
gfiltros_nombre_campo(4) = "Fecha Registro"
gfiltros_nombre_campo(5) = "Observacion"
gfiltros_nombre_campo(6) = "Codigo"
gfiltros_nombre_campo(7) = "Descripcion"


gfiltros_campo(1) = "Faccmp.nro_doc"
gfiltros_campo(2) = "Faccmp.cod_prov"
gfiltros_campo(3) = "Faccmp.fec_doc"
gfiltros_campo(4) = "Faccmp.fec_reg"
gfiltros_campo(5) = "Faccmp.observa"
gfiltros_campo(6) = "Faccmplineas.cod_prod"
gfiltros_campo(7) = "Faccmplineas.nom_prod_aux"


gfiltros_tipo_campo(1) = "N"
gfiltros_tipo_campo(2) = "N"
gfiltros_tipo_campo(3) = "F"
gfiltros_tipo_campo(4) = "F"
gfiltros_tipo_campo(5) = "C"
gfiltros_tipo_campo(6) = "N"
gfiltros_tipo_campo(7) = "C"

frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
frmFiltros_de_campos_para_Listar.Show (1)

lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado

DoEvents

If lbolCancelar_Listado Then
    Exit Function
End If



Call f_esperar(2)

Call Inicializo_Control_Crystal(CrystalReport1)

' Tabla Temporal del Reporte
gNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
Call Borra_Tabla_Temporal(gNombre_Tabla_Temporal)

SQL = "select faccmp.nro_doc as nro_ped, faccmp.cod_prov, faccmp.fec_doc as fec_entrega, faccmp.fec_reg, faccmp.observa,faccmplineas.cod_prod ,faccmplineas.cant_prod*faccmplineas.cajas as cantidad, faccmplineas.precio as precio " & _
        " into " & gNombre_Tabla_Temporal & " from faccmp , faccmplineas where faccmp.nro_doc=faccmplineas.nro_doc and faccmp.cod_emp=faccmplineas.cod_emp and faccmp.cod_emp = " & gCodigo_Empresa & " and faccmp.cod_doc = faccmplineas.cod_doc and faccmp.cod_doc=" & ConfDoc_Ingreso_Pedido_Cli & _
        " and " & Trim(lstrFiltros)

Dbs.Execute SQL

CrystalReport1.sqlQuery = " SELECT productos.nom_prod,zT_Informe_Pedidos_Cli.nro_ped, zT_Informe_Pedidos_Cli.fec_entrega, zT_Informe_Pedidos_Cli.fec_reg, zT_Informe_Pedidos_Cli.observa, zT_Informe_Pedidos_Cli.cod_prod, zT_Informe_Pedidos_Cli.cantidad, zT_Informe_Pedidos_Cli.precio, " & _
                    " clientes.rsocial_cli From (" & f_Ruta_Base(Conf_Motor_Base) & "productos productos INNER JOIN " & f_Ruta_Base(Conf_Motor_Base) & "" & gNombre_Tabla_Temporal & " zT_Informe_Pedidos_Cli ON productos.cod_prod = zT_Informe_Pedidos_Cli.cod_prod) INNER JOIN " & f_Ruta_Base(Conf_Motor_Base) & "clientes clientes ON " & _
                    " zT_Informe_Pedidos_Cli.cod_prov = clientes.nro_cli Order By zT_Informe_Pedidos_Cli.nro_ped ASC "

If Busco_Empresa(gCodigo_Empresa) Then
    lParametro = "parEmpresa;" & Trim(rstEmpresas!Descripcion) & " - " & Trim(UCase(confNombre)) & ";TRUE"
Else
    lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
End If
CrystalReport1.ParameterFields(0) = lParametro

lParametro = "parUsuario;" & gUsuario & ";TRUE"
CrystalReport1.ParameterFields(1) = lParametro


lParametro = "parTitulo;" & "PEDIDOS DE CLIENTES" & ";TRUE"
CrystalReport1.ParameterFields(2) = lParametro

CrystalReport1.ReportFileName = ConfCamarchReportes & "Pedidos_Clientes.rpt"
CrystalReport1.Destination = 0
lresult = CrystalReport1.PrintReport

Unload frmMensaje_Esperar
End Function

Function Listar_Pedidos_Resumido(pstrTitulo As String)

    Dim lParametro As String
    Dim lrst_cab As Recordset
    Dim lrst_lin As Recordset
    Dim lrst_Pagos As Recordset
    Dim lrst_Ajuste_INAC As Recordset
    Dim lLineas As Integer
    Dim lLineas_Mercaderia As Integer
    Dim lLineas_Servicios As Integer
    Dim lCofis1, lCofis2, lCofis3 As Double
    Dim RM As Recordset
    Dim ldblSaldo As Double
    Dim ldblAjuste_INAC As Double
    Dim ldblDtos_Total As Double
    Dim ldblDto_Global  As Double
    Dim ldblPrecio As Double
    Dim ldblPrecio_Con_Dto As Double
    Dim ldblSubTotal As Double

Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Sucursal"
    gfiltros_nombre_campo(3) = "Documento"
    gfiltros_nombre_campo(4) = "Tipo Documento (M-ercadería  S-ervicio)"
    gfiltros_nombre_campo(5) = "Número"
    gfiltros_nombre_campo(6) = "Cliente"
    gfiltros_nombre_campo(7) = "RUT"
    gfiltros_nombre_campo(8) = "Fecha Documento"
    gfiltros_nombre_campo(9) = "Fecha Valor"
    gfiltros_nombre_campo(10) = "Fecha Entrega"
    gfiltros_nombre_campo(11) = "Autorizados"
    gfiltros_nombre_campo(12) = "Forma de Pago"
    gfiltros_nombre_campo(13) = "Moneda"
    gfiltros_nombre_campo(14) = "Caja/Pos"
    gfiltros_nombre_campo(15) = "Vendedor"
    gfiltros_nombre_campo(16) = "Remito"
    gfiltros_nombre_campo(17) = "Guia INAC"
    gfiltros_nombre_campo(18) = "Fecha Registro"
    gfiltros_nombre_campo(19) = "Usuario"
    gfiltros_nombre_campo(20) = "Vendedor en Cliente"
    gfiltros_nombre_campo(21) = "Lista de Precios"
    gfiltros_nombre_campo(22) = "Importe"
    gfiltros_nombre_campo(23) = "Observacion"
    gfiltros_nombre_campo(24) = "Nombre Cliente"
    gfiltros_nombre_campo(25) = "Fecha Vencimiento"
    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_suc"
    gfiltros_campo(3) = "Faccmp.cod_doc"
    gfiltros_campo(4) = "Documentos.mueve_merca_serv"
    gfiltros_campo(5) = "Faccmp.nro_doc"
    gfiltros_campo(6) = "Faccmp.cod_prov"
    gfiltros_campo(7) = "Faccmp.ruc"
    gfiltros_campo(8) = "Faccmp.fec_doc"
    gfiltros_campo(9) = "Faccmp.fec_valor"
    gfiltros_campo(10) = "Faccmp.fec_ent"
    gfiltros_campo(11) = "Faccmp.autorizado"
    gfiltros_campo(12) = "Faccmp.forma_pago"
    gfiltros_campo(13) = "Faccmp.moneda"
    gfiltros_campo(14) = "Faccmp.caja"
    gfiltros_campo(15) = "Faccmp.nro_ven"
    gfiltros_campo(16) = "Faccmp.cofismin"
    gfiltros_campo(17) = "Faccmp.cofisexento"
    gfiltros_campo(18) = "Faccmp.fec_reg"
    gfiltros_campo(19) = "Faccmp.usuario"
    gfiltros_campo(20) = "clientes.nro_ven"
    gfiltros_campo(21) = "Faccmp.nro_rollo"
    gfiltros_campo(22) = "Faccmp.importe"
    gfiltros_campo(23) = "Faccmp.observa"
    gfiltros_campo(24) = "Faccmp.nom_cli"
    gfiltros_campo(25) = "Faccmp.fec_venc"
    
    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "C"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "N"
    gfiltros_tipo_campo(7) = "C"
    gfiltros_tipo_campo(8) = "F"
    gfiltros_tipo_campo(9) = "F"
    gfiltros_tipo_campo(10) = "F"
    gfiltros_tipo_campo(11) = "C"
    gfiltros_tipo_campo(12) = "N"
    gfiltros_tipo_campo(13) = "N"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "N"
    gfiltros_tipo_campo(16) = "N"
    gfiltros_tipo_campo(17) = "N"
    gfiltros_tipo_campo(18) = "F"
    gfiltros_tipo_campo(19) = "C"
    gfiltros_tipo_campo(20) = "N"
    gfiltros_tipo_campo(21) = "N"
    gfiltros_tipo_campo(22) = "N"
    gfiltros_tipo_campo(23) = "C"
    gfiltros_tipo_campo(24) = "C"
    gfiltros_tipo_campo(25) = "F"
    
    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    ' Seteo los Defectos del Orden a Listar
    gelejir_orden_descripcion(1) = "Empresa"
    gelejir_orden_descripcion(2) = "Moneda"
    gelejir_orden_descripcion(3) = "Documento"
    gelejir_orden_descripcion(4) = "Número"
    gelejir_orden_descripcion(5) = "Cliente"
    gelejir_orden_descripcion(6) = "Fecha Documento"
    gelejir_orden_descripcion(7) = "Fecha Valor"
    gelejir_orden_descripcion(8) = "Fecha Entrega"
    gelejir_orden_descripcion(9) = "Forma Pago"
    gelejir_orden_descripcion(10) = "Vendedor"
    gelejir_orden_descripcion(11) = "Fecha Registro"
    gelejir_orden_descripcion(12) = "Usuario"
    gelejir_orden_descripcion(13) = "Importe"
    
    gelejir_orden_descripcion(14) = "Observaciones"
    
    gelejir_orden_campo(1) = "zT_Inf_Docs_Digitados_R.cod_emp"
    gelejir_orden_campo(2) = "zT_Inf_Docs_Digitados_R.moneda"
    gelejir_orden_campo(3) = "zT_Inf_Docs_Digitados_R.cod_doc"
    gelejir_orden_campo(4) = "zT_Inf_Docs_Digitados_R.nro_doc"
    gelejir_orden_campo(5) = "zT_Inf_Docs_Digitados_R.cod_prov"
    gelejir_orden_campo(6) = "zT_Inf_Docs_Digitados_R.fec_doc"
    gelejir_orden_campo(7) = "zT_Inf_Docs_Digitados_R.fec_asiento"
    gelejir_orden_campo(8) = "zT_Inf_Docs_Digitados_R.fec_ent"
    gelejir_orden_campo(9) = "zT_Inf_Docs_Digitados_R.forma_pago"
    gelejir_orden_campo(10) = "zT_Inf_Docs_Digitados_R.nro_ven"
    gelejir_orden_campo(11) = "zT_Inf_Docs_Digitados_R.fec_reg"
    gelejir_orden_campo(12) = "zT_Inf_Docs_Digitados_R.usuario"
    gelejir_orden_campo(13) = "zT_Inf_Docs_Digitados_R.importe"
    gelejir_orden_campo(14) = "zT_Inf_Docs_Digitados_R.observa"
    
            
            gelejir_orden_orden(2) = 1
                
            gelejir_orden_tipo(2) = "A"
        
    frmElejir_Orden_para_Listar.Show (1)
    lbolCancelar_Listado = frmElejir_Orden_para_Listar.pbolCancelar_Listado
    
    DoEvents
            
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    If Elejir_Tipo_Moneda_del_Reporte("O") Then
        Exit Function
    End If
    
    
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    Call Genero_Temporal
    
    Call esperar_segundos(4)
    
    
    Call Inicializo_Control_Crystal(CrystalReport1)
     
    CrystalReport1.sqlQuery = "SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.nro_doc, zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.lineas, zT_Inf_Docs_Digitados_R.fec_doc, zT_Inf_Docs_Digitados_R.importe, zT_Inf_Docs_Digitados_R.moneda, zT_Inf_Docs_Digitados_R.saldo,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Empresas.descripcion,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " clientes.nro_cli,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Monedas.descripcion, Monedas.simbolo,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Faccmp.autorizado, Faccmp.NomCli"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FROM (((" & gNombre_Tabla_Temporal & " zT_Inf_Docs_Digitados_R INNER JOIN clientes clientes ON "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " zT_Inf_Docs_Digitados_R.cod_prov = clientes.nro_cli)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Monedas ON zT_Inf_Docs_Digitados_R.moneda = Monedas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Faccmp Faccmp ON zT_Inf_Docs_Digitados_R.cod_emp = Faccmp.cod_emp"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND zT_Inf_Docs_Digitados_R.cod_doc = Faccmp.cod_doc"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND zT_Inf_Docs_Digitados_R.nro_doc = Faccmp.nro_doc"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND zT_Inf_Docs_Digitados_R.cod_prov = Faccmp.cod_prov)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ORDER BY zT_Inf_Docs_Digitados_R.cod_emp ASC,zT_Inf_Docs_Digitados_R.moneda ASC"
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro
    
    lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro
    
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Pedidos.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
   Unload frmMensaje_Esperar
    
End Function

Public Function Controlo_Descuento_Global_X_Articulo(llngRow As Long) As Boolean
On Error GoTo Errores
Dim lLista_Minimo As Long
Dim L As Recordset
Dim lPrecioUnitConDto As Double
Dim lPrecio_Minimo As Double
Dim lDescuento_Maximo As Double

Controlo_Descuento_Global_X_Articulo = True

If Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_CODIGO)) <> "" Then

        If UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" Then
            ' Se controla que el Precio final no sea menor al Precio de la lista Minima
        
            If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
                'Sacamos la lista que controla a la que estamos facturando
                lLista_Minimo = L!lista_precio_minimo
            End If
        Else
            Controlo_Descuento_Global_X_Articulo = True
            Exit Function
        End If
        
        lPrecioUnitConDto = CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO))
    
        '-----------------------------------  DESCUENTO  GLOBAL  -----------------------------------------
        
        If Trim(txtDtoGlobal.text) <> "" Then
            If IsNumeric(txtDtoGlobal.text) Then
                lPrecioUnitConDto = lPrecioUnitConDto * (1 - (txtDtoGlobal.text) / 100)
            End If
        End If
        
        'If UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" Then
            If Not Control_Precio_Minimo(lLista_Minimo, CDbl(txtDtoGlobal.text), llngRow, lPrecioUnitConDto, lPrecio_Minimo, lDescuento_Maximo) Then
                Controlo_Descuento_Global_X_Articulo = False
            End If
        'End If
End If
Exit Function
Errores:
        Call FErrores
        'Resume
End Function


Sub Imprimir_Pedido(pstrTipo_Impresion As String, plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, pstrFec_Doc As String, pstrFecha_Vencimiento As String, plngMoneda As Long, plngSucursal As Long, plngCod_Forma_Pago As Long, plngCod_Vendedor As Long, pstrGuia As String, pstrObservacion As String, plngNro_Fanfold As Long, plngCuenta_Madre As Long, ByRef pobjCrystalReport As CrystalReport)
Dim D As Recordset

    'ATU 20170322 - Se llama al metodo de inicializar para setear la clave de la BD
    Call Inicializo_Control_Crystal(pobjCrystalReport)
    
    Select Case ConfFormato_Factura
        
        Case "CASINO", "CASINO-POS", "DALTIRO"
            Call Imp_Formato_Pedido_CASINO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, pstrFecha_Vencimiento, plngMoneda, plngSucursal, plngCod_Vendedor, plngCod_Forma_Pago, pstrObservacion, plngNro_Fanfold)
        Case "MBERRUTTI"
            Call Imp_Formato_DISTRIBUIDORA_MBERRUTTI_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        'Case "GARCIALOPEZ"
        '    Call Imp_Formato_GARCIALOPEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "STAUDINGER"
            Call Imp_Formato_STAUDINGER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "JAGUILAR"
            Call Imp_Formato_JAGUILAR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "AMANECER"
            Call Imp_Formato_AMANECER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "ELECTRONACHO"
            Call Imp_Formato_ELECTRONACHO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "BARATILLO"
            Call Imp_Formato_BARATILLO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "MMARTINEZ"
            Call Imp_Formato_MMARTINEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "TATOREPRESENTACIONES"
            Call Imp_Formato_TATOREPRESENTACIONES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "ENET"
            Call Imp_Formato_ENET_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
'        Case "EL_PALENQUE"
           ' Call Imp_Formato_DISTRIBUIDORA_EL_PALENQUE_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "MERCADO"              ' SS 20151127
            Call Imp_Formato_MERCADO_DEL_ESTE_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "CENTROSUR"
            Call Imp_Formato_CENTROSUR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
        Case Else
        
            If Buscar_Tipo_Documento(plngCod_Doc, D) Then
                'Para los que tengan definido el reporte en tabla documentos
                If D!archivo_rpt_reporte_asociado <> "" And D!cantidad_vias > 0 Then
                    Call Imp_Formato_PEDIDO_CLIENTES_GENERICO(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
                Else
                    MsgBox "No existe Formato de Pedido Definido o Falta Configurarlo", vbExclamation, MsgTit
                End If
           End If
    End Select

End Sub


Sub Imprimir_PreVenta(pstrTipo_Impresion As String, plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, pstrFec_Doc As String, pstrFecha_Vencimiento As String, plngMoneda As Long, plngSucursal As Long, plngCod_Forma_Pago As Long, plngCod_Vendedor As Long, pstrGuia As String, pstrObservacion As String, plngNro_Fanfold As Long, plngCuenta_Madre As Long, ByRef pobjCrystalReport As CrystalReport)
Dim D As Recordset

    'ATU 20170322 - Se llama al metodo de inicializar para setear la clave de la BD
    Call Inicializo_Control_Crystal(pobjCrystalReport)
    
    ' Veo si tiene un RPT asociado para enviarlo por la impresion Generica
    
    If Not Buscar_Tipo_Documento(plngCod_Doc, D) Then
        MsgBox "ERROR: No esta definido el Documento " & plngCod_Doc & " en el Sistema. Verifique por favor...", vbCritical + vbOKOnly
        Exit Sub
    End If
    
    If Trim(D!archivo_rpt_reporte_asociado) <> "" Then
        Call Imp_PREVENTA_GENERICO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pobjCrystalReport)
    Else
        Select Case ConfFormato_Factura
            Case "CASINO", "CASINO-POS", "DALTIRO"
                Call Imp_Formato_PreVenta_CASINO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, pstrFecha_Vencimiento, plngMoneda, plngSucursal, plngCod_Vendedor, plngCod_Forma_Pago, pstrObservacion, plngNro_Fanfold)
'            Case "EL_PALENQUE"
'                Call Imp_Formato_DISTRIBUIDORA_EL_PALENQUE_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        End Select
    End If
    
End Sub

Sub Imprimir_Ruptura(pstrTipo_Impresion As String, plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, pstrFec_Doc As String, pstrFecha_Vencimiento As String, plngMoneda As Long, plngSucursal As Long, plngCod_Forma_Pago As Long, plngCod_Vendedor As Long, pstrGuia As String, pstrObservacion As String, plngNro_Fanfold As Long, plngCuenta_Madre As Long, ByRef pobjCrystalReport As CrystalReport)
    'ATU 20170322 - Se llama al metodo de inicializar para setear la clave de la BD
    Call Inicializo_Control_Crystal(pobjCrystalReport)
    
    Select Case ConfFormato_Factura
        Case "CASINO", "CASINO-POS", "DALTIRO"
            Call Imp_Formato_Ruptura_CASINO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, pstrFecha_Vencimiento, plngMoneda, plngSucursal, plngCod_Vendedor, plngCod_Forma_Pago, pstrObservacion, plngNro_Fanfold)
        Case "GARCIALOPEZ"
            Call Imp_Formato_GARCIALOPEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "STAUDINGER"
            Call Imp_Formato_STAUDINGER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "JAGUILAR"
            Call Imp_Formato_JAGUILAR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "AMANECER"
            Call Imp_Formato_AMANECER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "ELECTRONACHO"
            Call Imp_Formato_ELECTRONACHO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "BARATILLO"
            Call Imp_Formato_BARATILLO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "MMARTINEZ"
            Call Imp_Formato_MMARTINEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "TATOREPRESENTACIONES"
            Call Imp_Formato_TATOREPRESENTACIONES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "ENET"
            Call Imp_Formato_ENET_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        Case "CENTROSUR"
            Call Imp_Formato_CENTROSUR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    End Select
End Sub

Function campos_Ingresados(lCampo As String) As Boolean
campos_Ingresados = True
If txtEmpresa.text = "" Then
    lCampo = "Empresa"
    campos_Ingresados = False
    Exit Function
End If
If txtFec_Doc.text = "" Then
    lCampo = "Fecha"
    campos_Ingresados = False
    Exit Function
End If
If txtCodDoc.text = "" Then
    lCampo = "Cod. Documento"
    campos_Ingresados = False
    Exit Function
End If
If txtDoc.text = "" Then
    lCampo = "Numero"
    campos_Ingresados = False
    Exit Function
End If
If txtCodProv.text = "" Then
    lCampo = "Cliente"
    campos_Ingresados = False
    Exit Function
End If
If TxtCodSuc.text = "" Then
    lCampo = "Sucursal"
    campos_Ingresados = False
    Exit Function
End If
If txtLista.text = "" Then
    lCampo = "Lista"
    campos_Ingresados = False
    Exit Function
End If
If txtMoneda.text = "" Then
    lCampo = "Moneda"
    campos_Ingresados = False
    Exit Function
End If
If txtTipo_Cambio.text = "" Then
    lCampo = "T. Cambio"
    campos_Ingresados = False
    Exit Function
End If
If txtDtoGlobal.text = "" Then
    lCampo = "Dto. Global"
    campos_Ingresados = False
    Exit Function
End If

End Function


Sub Cargar_Desde_Pedido(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long, lPreventa As Boolean)
Dim lCont As Integer
Dim SQL As String
Dim SQLObservacion As String
Dim A As Recordset
Dim D As Recordset
Dim e As Recordset
Dim R As Recordset
Dim S As Recordset
Dim SE As Recordset
Dim ldblPrecio_Unitario As Double
Dim lstrClave_Colecccion_Series As String
Dim lblnCancelar As Boolean

Dim lCantidad As Double   'JCH 20220602
Dim lPrecio As Double
Dim lMagnitud As Long
Dim MD As Recordset
Dim ML As Recordset
    

If Not Buscar_Empresa(lcod_emp, e) Then
    Exit Sub
End If

If Not Buscar_Tipo_Documento(lCod_Doc, D) Then
    Exit Sub
End If

cmdGuardar.Enabled = False
gNombre_Tabla_Temporal = ""
lblnCancelar = False

If lPreventa Then
    Call Busqueda_Documentos_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "P", "P", D!signo, "preventa_clientes", txtMoneda.text)
Else
    If D!signo = -1 Then
        Call Busqueda_Documentos_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "P", "P", D!signo, "pedidos_clientes", txtMoneda.text)
    Else
        Call Busqueda_Documentos_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "P", "P", D!signo, "pedidos_clientes_devolucion", txtMoneda.text)
    End If
End If

If Trim(gNombre_Tabla_Temporal) = "" Then
    cmdGuardar.Enabled = True
    Exit Sub
    'Salimos porque no hay pedido seleccionadp
Else
    'Trabajo las Lineas directamente porque hay varios cabezales
    '###################
    
    If ConfWIS_INTERFASE_PEDIDOS And Not lPreventa Then
        SQL = "SELECT fl.cod_doc,fl.nro_doc,f.cod_suc,w.precio_uni as precio,w.dto_global,f.observa,f.nro_ven,w.nro_linea,w.cod_prod, w.dto_1 as descuento1, w.dto_2 as descuento2, w.dto_3 as descuento3,"
        SQL = SQL & " p.cod_art_proveedor, f.con_sin_iva, 0 as tipo_entrega, 1 as cajas, 0 as seccion, SUM(w.cantidad) as cant_prod,fl.cod_prov"
        SQL = SQL & " FROM faccmp f, FaccmpLineas fl, " & gNombre_Tabla_Temporal & " g , productos p "
        SQL = SQL & " , wis_pedidos_clientes w"
    Else
        SQL = "SELECT fl.cod_doc,fl.nro_doc,f.cod_suc,fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3,"
        SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, f.con_sin_iva, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod,fl.cod_prov"
        SQL = SQL & " FROM faccmp f, FaccmpLineas fl, " & gNombre_Tabla_Temporal & " g , productos p "
    End If
        
    SQL = SQL & " WHERE p.cod_prod = fl.cod_prod "
    SQL = SQL & " AND fl.cod_emp = " & lcod_emp
    SQL = SQL & " AND fl.cod_doc = G.cod_doc"
    SQL = SQL & " AND fl.nro_doc=g.nro_doc"
    SQL = SQL & " AND fl.cod_prov=" & lCod_Prov
    SQL = SQL & " AND f.cod_emp=fl.cod_emp"
    SQL = SQL & " AND f.cod_doc=fl.cod_doc"
    SQL = SQL & " AND f.nro_doc=fl.nro_doc"
    SQL = SQL & " AND f.cod_prov=fl.cod_prov"
    
    If ConfWIS_INTERFASE_PEDIDOS And Not lPreventa Then
        'AIR 20231010 se cambia esta condicion porque la nueva interface de Wis no nos envia los nros de lineas originales del pedido enviado a Wis.
        'SQL = SQL & " AND fl.nro_linea = w.nro_linea "
        SQL = SQL & " AND fl.cod_prod = w.cod_prod "
        'AIR 20230725
        'SQL = SQL & " AND fl.cod_doc = " & ConfDoc_Ingreso_Pedido_Cli
        SQL = SQL & " AND fl.cod_doc IN( " & ConfDoc_Ingreso_Pedido_Cli & "," & ConfDoc_Ingreso_Pedido_Cli_Web & ")"
        
        SQL = SQL & " AND fl.nro_doc = w.nro_doc "
        SQL = SQL & " AND fl.cod_prov = w.cod_prov "
        SQL = SQL & " AND w.usuarioa is null "
        SQL = SQL & " AND w.fec_rega is null "
        'AIR 20230516
        'SQL = SQL & " GROUP BY f.cod_suc, w.precio_uni, w.dto_global, f.observa,f.nro_ven,w.nro_linea, w.cod_prod, w.dto_1, w.dto_2, w.dto_3, p.cod_art_proveedor, f.con_sin_iva,fl.cod_prov"
        SQL = SQL & " GROUP BY fl.cod_doc,fl.nro_doc,f.cod_suc, w.precio_uni, w.dto_global, f.observa,f.nro_ven,w.nro_linea, w.cod_prod, w.dto_1, w.dto_2, w.dto_3, p.cod_art_proveedor, f.con_sin_iva,fl.cod_prov"
        SQL = SQL & " ORDER BY w.nro_linea, w.cod_prod "
    Else
        SQL = SQL & " GROUP BY fl.cod_doc,fl.nro_doc,f.cod_suc, fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod,fl.descuento1, fl.descuento2, fl.descuento3,p.cod_art_proveedor,fl.tipo_entrega, f.con_sin_iva,fl.cod_prov"
        SQL = SQL & " ORDER BY fl.nro_linea ,fl.cod_prod "
    End If

    
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If

'Muestro en la grilla
MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > 1 Then
    If MsgBox("Documento ya con Lineas Ingresadas." & Chr(10) & "Vaciar Grilla Antes de Cargar?", vbQuestion + vbYesNo + vbDefaultButton1) = vbYes Then
        vsfLineas_Mercaderia.Rows = 1
        lCont = vsfLineas_Mercaderia.Rows
    End If
End If

' AIR 20210218 se limita el control de la cantidad de lineas a solo documentos de tipo facturacion que es donde no se puede superar la cantidad de lineas max
              'ViaSulytop necesitaba copiar un pedido de mas del limite de lineas en otro y esto se lo impedia.
'If lCont > llngMaximo_Lineas Then
If lCont > llngMaximo_Lineas And D!tipo_doc = "E" Then

    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If


Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not rstlineas_documentos.EOF Then
    txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
    txtObs.text = Trim(rstlineas_documentos!observa)
    txtVendedor.text = rstlineas_documentos!nro_ven
    If Buscar_Vendedor(txtVendedor.text, R) Then
        TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
    End If
    TxtCodSuc.text = rstlineas_documentos!cod_suc
    If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), S) Then
        TxtNomSuc.text = Trim(S!nombre)
    End If
End If

Do While Not rstlineas_documentos.EOF

    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PEDIDO: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)

    TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod
    
    ' JE 20160823   /   Asumo que el precio que viene tiene IVA Includio (desde los Pedidos) y aqui acomodo el precio Unitario para que pase bien al facturador si usa precios SIN IVA
'    If UCase(Trim(e!imp_inc_facturador)) = "N" Then
'        If Buscar_Articulo(rstlineas_documentos!Cod_Prod, A) Then
'            ldblPrecio_Unitario = Importe_Sin_Impuestos_Vigente(rstlineas_documentos!Precio, A!cod_iva)
'        Else
'            ldblPrecio_Unitario = rstlineas_documentos!Precio
'        End If
'    Else
'        ldblPrecio_Unitario = rstlineas_documentos!Precio
'    End If
    
    ' SS 20200226 CAMBIO: Vemos si el documento a facturar tiene (o no) IVA incluido
    
    ldblPrecio_Unitario = rstlineas_documentos!Precio
    
    If rstlineas_documentos!con_Sin_iva = "S" And UCase(Trim(e!imp_inc_facturador)) = "N" Then  'viene CON iva incluido pero la empresa factura SIN iva incluido
        If Buscar_Articulo(rstlineas_documentos!Cod_Prod, A) Then
            ldblPrecio_Unitario = Importe_Sin_Impuestos_Vigente(rstlineas_documentos!Precio, A!cod_iva) 'resta el IVA
        End If
    End If
    
    If rstlineas_documentos!con_Sin_iva = "N" And UCase(Trim(e!imp_inc_facturador)) = "S" Then  'viene SIN iva incluido pero la empresa factura CON iva incluido
        If Buscar_Articulo(rstlineas_documentos!Cod_Prod, A) Then
            ldblPrecio_Unitario = rstlineas_documentos!Precio * (1 + (Porcentaje_Impuesto_Vigente("IVA", A!cod_iva, Format(date, "dd/mm/yyyy")) / 100)) 'agrega el IVA
        End If
    End If
    
    'JCH 20220602 se agrego este codigo por el manejo de magnitudes
    lCantidad = rstlineas_documentos!Cant_Prod
    lPrecio = rstlineas_documentos!Precio
    lMagnitud = -1
    If Buscar_Datos_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, lCod_Prov, rstlineas_documentos!nro_linea, MD) Then
    End If
    
    If confUsaEquivalenciaMagnitudes Then
          If Not (MD.EOF And MD.BOF) Then
              If Buscar_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, lCod_Prov, rstlineas_documentos!nro_linea, ML) Then
                  If ML!Cant_Prod = rstlineas_documentos!Cant_Prod Then
                      lCantidad = MD!cant_prod_magnitud
                  Else
                      lCantidad = lCantidad * MD!cant_prod_magnitud / ML!Cant_Prod
                  End If
                  lPrecio = MD!precio_magnitud
                  lMagnitud = MD!magnitud
                  TxtFactor.text = lCantidad   'muestra los saldos de los pendientes
              End If
          End If
    End If
    
    If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, lPrecio, rstlineas_documentos!tipo_entrega, IIf(MD.EOF And MD.BOF, txtDeposito.text, MD!Deposito), True, "", False, rstlineas_documentos!cod_doc, 0, rstlineas_documentos!Cod_Prov, 0, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!nro_linea, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, lMagnitud) Then
        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
        
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    End If
    
    rstlineas_documentos.MoveNext
    lCont = lCont + 1
    
    'AIR 20220816 faltaba aqui
    'If lCont > llngMaximo_Lineas Then
    If lCont > llngMaximo_Lineas And D!tipo_doc = "E" Then
        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop
TxtFactor.text = ""
MousePointer = 1
cmdGuardar.Enabled = True
End Sub

Sub Cargar_Desde_Pedido_Movil(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long)
Dim lCont As Integer
Dim SQL As String
Dim SQLObservacion As String
Dim R As Recordset
Dim RP As Recordset
Dim lblnCancelar As Boolean

lblnCancelar = False
cmdGuardar.Enabled = False
gNombre_Tabla_Temporal = ""

'Si no existe, la creamos
lNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal

Call Borra_Tabla_Temporal(lNombre_Tabla_Temporal)
Call creo_Temporal_Remitos(lNombre_Tabla_Temporal)

SQL = "SELECT * FROM Faccmp"
SQL = SQL & " WHERE cod_emp=" & lcod_emp
SQL = SQL & " AND   cod_doc = " & lCod_Doc
SQL = SQL & " AND   nro_doc = " & lNro_Doc
SQL = SQL & " AND   cod_prov = " & lCod_Prov
SQL = SQL & " ORDER BY cod_doc, nro_doc"

Set RP = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
lLinea = 0
Do While Not RP.EOF
    SQL = "INSERT INTO " & lNombre_Tabla_Temporal
    SQL = SQL & " VALUES(" & RP!cod_doc & ","
    SQL = SQL & RP!nro_doc & ","
    SQL = SQL & f_Fecha_Base(RP!fec_doc, Conf_Motor_Base) & ","
    SQL = SQL & f_Fecha_Base(RP!fec_venc, Conf_Motor_Base) & ","
    SQL = SQL & "0" & ")"
    
    Dbs.Execute SQL
                            
    RP.MoveNext
Loop
RP.Close
    

SQL = "SELECT f.cod_suc,fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3,"
SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod "
SQL = SQL & " FROM faccmp f, FaccmpLineas fl , productos p "
SQL = SQL & " WHERE p.cod_prod = fl.cod_prod "
SQL = SQL & " AND fl.cod_emp = " & lcod_emp
SQL = SQL & " AND fl.cod_doc = " & lCod_Doc
SQL = SQL & " AND fl.nro_doc= " & lNro_Doc
SQL = SQL & " AND fl.cod_prov=" & lCod_Prov
SQL = SQL & " AND f.cod_emp=fl.cod_emp"
SQL = SQL & " AND f.cod_doc=fl.cod_doc"
SQL = SQL & " AND f.nro_doc=fl.nro_doc"
SQL = SQL & " AND f.cod_prov=fl.cod_prov"
SQL = SQL & " GROUP BY f.cod_suc, fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod,fl.descuento1, fl.descuento2, fl.descuento3,p.cod_art_proveedor,fl.tipo_entrega"
SQL = SQL & " ORDER BY fl.nro_linea ,fl.cod_prod "

'Muestro en la grilla
MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > llngMaximo_Lineas Then
    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If

Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not rstlineas_documentos.EOF Then
    txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
    txtObs.text = Trim(rstlineas_documentos!observa)
    txtVendedor.text = rstlineas_documentos!nro_ven
    TxtCodSuc.text = rstlineas_documentos!cod_suc
    If Buscar_Vendedor(txtVendedor.text, R) Then
        TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
    End If
End If

Do While Not rstlineas_documentos.EOF
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PEDIDO: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)

    TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod
    If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, rstlineas_documentos!Precio, rstlineas_documentos!tipo_entrega, txtDeposito.text, True, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    End If
    rstlineas_documentos.MoveNext
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop
TxtFactor.text = ""
MousePointer = 1
cmdGuardar.Enabled = True
'TxtLector.SetFocus

End Sub
Sub Control_Error_Desde_Pedido_Movil(pbolOpcion As Boolean)
gbolESC = pbolOpcion
End Sub

Sub Cargar_Desde_Pedido_Proveedor(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long, lPreventa As Boolean)
Dim lCont As Integer
Dim SQL As String
Dim SQLObservacion As String
Dim R As Recordset
Dim C As Recordset
Dim lblnCancelar As Boolean

gNombre_Tabla_Temporal = ""
cmdGuardar.Enabled = False
lblnCancelar = False
On Error GoTo Errores

If Buscar_Cliente(txtCodProv.text, C) Then
    Call Busqueda_Documentos_a_Afectar(C!cod_prov_aso, lCod_Prov, "P", "P", 1, "pedidos", txtMoneda.text)
End If

If Trim(gNombre_Tabla_Temporal) = "" Then
    cmdGuardar.Enabled = True
    Exit Sub
    'Salimos porque no hay pedido seleccionadp
Else
    'Trabajo las Lineas directamente porque hay varios cabezales
    '###################
    

    '20230526 agrego que se levante el nro del pedido original
    SQL = "SELECT f.cod_suc,f.cod_doc,f.nro_doc,fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3,"
    SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod "
    SQL = SQL & " FROM faccmp f, FaccmpLineas fl, " & gNombre_Tabla_Temporal & " g , productos p "

    
    SQL = SQL & " WHERE p.cod_prod = fl.cod_prod "
    SQL = SQL & " AND fl.cod_emp = " & C!cod_prov_aso
    SQL = SQL & " AND fl.cod_doc = G.cod_doc"
    SQL = SQL & " AND fl.nro_doc=g.nro_doc"
    SQL = SQL & " AND fl.cod_prov=" & lCod_Prov
    SQL = SQL & " AND f.cod_emp=fl.cod_emp"
    SQL = SQL & " AND f.cod_doc=fl.cod_doc"
    SQL = SQL & " AND f.nro_doc=fl.nro_doc"
    SQL = SQL & " AND f.cod_prov=fl.cod_prov"
    

    SQL = SQL & " GROUP BY f.cod_suc,f.cod_doc,f.nro_doc, fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod,fl.descuento1, fl.descuento2, fl.descuento3,p.cod_art_proveedor,fl.tipo_entrega"
    SQL = SQL & " ORDER BY fl.nro_linea ,fl.cod_prod "


    
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If

'Muestro en la grilla
MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > llngMaximo_Lineas Then
    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If


Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not rstlineas_documentos.EOF Then
    txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
    ' AIR 20230317 se agrega WREPO como indicador que es un pedido de los locales.
    ' AIR 20230526 se agrega en la observacion el nro original del pedido del local
    txtObs.text = "WREPO" & "-" & str(rstlineas_documentos!cod_doc) & "/" & str(rstlineas_documentos!nro_doc) & " " & Trim(rstlineas_documentos!observa)
    txtVendedor.text = rstlineas_documentos!nro_ven
    TxtCodSuc.text = rstlineas_documentos!cod_suc
    If Buscar_Vendedor(txtVendedor.text, R) Then
        TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
    End If
End If

Do While Not rstlineas_documentos.EOF
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PEDIDO DE LOCAL: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI/LOC : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)

    TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod
    If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, rstlineas_documentos!Precio, rstlineas_documentos!tipo_entrega, txtDeposito.text, True, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    End If
    rstlineas_documentos.MoveNext
    'lCont = lCont + 1
    'If lCont > llngMaximo_Lineas Then
    '    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    '    MousePointer = 1
    '    Exit Sub
    'End If
Loop
TxtFactor.text = ""
MousePointer = 1
cmdGuardar.Enabled = True
Exit Sub

Errores:
    Call FErrores

End Sub

Sub Cargar_Desde_Preventas_Pendientes(plngCod_Emp As Long, plngCod_Cliente As Long, pbolLlamado_Desde_Cod_Doc As Boolean)
Dim lCont As Integer
Dim SQL As String
Dim SQLObservacion As String
Dim R As Recordset
Dim S As Recordset
Dim C As Recordset
Dim L As Recordset
Dim e As Recordset
Dim D As Recordset
Dim Rs As Recordset
Dim llngCod_Prov As Long
Dim llngMoneda As Long
Dim ldblTipo_Cambio As Double
Dim lEmpresa As Long
Dim lbolPedidoFactura As Boolean
Dim lstrNombre_Temporal As String
Dim lblnCancelar As Boolean

Dim lCantidad As Double   'JCH 20220602
Dim lPrecio As Double
Dim lMagnitud As Long
Dim MD As Recordset
Dim ML As Recordset
    


gNombre_Tabla_Temporal = ""
cmdGuardar.Enabled = False
lblnCancelar = False

llngCod_Prov = plngCod_Cliente
glngCod_Doc_Preventa = 0
glngNro_Doc_Preventa = 0
glngCod_Cliente_Preventa = plngCod_Cliente

' gstrTabla_Temporal_Preventa = ""     AIR 20191108 se comenta para que si ingresan y salen sin seleccionar documentos no perder la informacion del pedido anterior seleccionado

Call Busqueda_Preventa_a_Afectar(val(txtEmpresa.text), "P", -1, "preventa_clientes_pendientes", llngCod_Prov, llngMoneda, Trim(txtDeposito.text), pbolLlamado_Desde_Cod_Doc, lstrNombre_Temporal)

If Trim(lstrNombre_Temporal) = "" Then
    cmdGuardar.Enabled = True
    Exit Sub
    'Salimos porque no hay Preventas Seleccionadas
Else

    SQL = "SELECT f.cod_doc, f.nro_doc, f.cod_suc, f.nom_cli, f.ruc, fl.precio, f.dto_global, f.observa, f.nro_ven, f.forma_pago,"
    SQL = SQL & " f.cod_prov, fl.nro_linea, fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3,"
    'SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod "
    SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod , nro_rollo " ' AIR 20241105 se agrega el nrolista para MATPAU
    SQL = SQL & " FROM faccmp f, FaccmpLineas fl, " & lstrNombre_Temporal & " g , productos p "
    
    SQL = SQL & " WHERE p.cod_prod = fl.cod_prod "
    SQL = SQL & " AND fl.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND fl.cod_doc = G.cod_doc"
    SQL = SQL & " AND fl.nro_doc=g.nro_doc"
    SQL = SQL & " AND fl.cod_prov=" & llngCod_Prov
    SQL = SQL & " AND f.moneda=" & llngMoneda
    SQL = SQL & " AND f.cod_emp=fl.cod_emp"
    SQL = SQL & " AND f.cod_doc=fl.cod_doc"
    SQL = SQL & " AND f.nro_doc=fl.nro_doc"
    SQL = SQL & " AND f.cod_prov=fl.cod_prov"
    
   ' SQL = SQL & " GROUP BY f.cod_doc, f.nro_doc, f.cod_suc, f.nom_cli, f.ruc, fl.precio, f.dto_global, f.observa, f.nro_ven, f.forma_pago,"
    SQL = SQL & " GROUP BY f.cod_doc, f.nro_doc, f.cod_suc, f.nro_rollo , f.nom_cli, f.ruc, fl.precio, f.dto_global, f.observa, f.nro_ven, f.forma_pago," ' AIR 20241105 se agrega el nrolista para MATPAU

    SQL = SQL & " f.cod_prov, fl.nro_linea, fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, p.cod_art_proveedor, fl.tipo_entrega"
    SQL = SQL & " ORDER BY fl.nro_linea ,fl.cod_prod "
    
End If

'Muestro en la grilla
MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > 1 Then
    If MsgBox("Documento ya con Lineas Ingresadas." & Chr(10) & "Vaciar Grilla Antes de Cargar?", vbQuestion + vbYesNo + vbDefaultButton1) = vbYes Then
        vsfLineas_Mercaderia.Rows = 1
        lCont = vsfLineas_Mercaderia.Rows
    End If
End If

If lCont > llngMaximo_Lineas Then
    MsgBox "La Cantidad de Lineas de la PREVENTA Seleccionada Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If


Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not rstlineas_documentos.EOF Then
    
    'AIR 20191108 se blanquea la variable aqui.
    gstrTabla_Temporal_Preventa = ""
    
    gbolCargo_Desde_Preventa = True
    
    glngCod_Doc_Preventa = rstlineas_documentos!cod_doc
    glngNro_Doc_Preventa = rstlineas_documentos!nro_doc
    glngCod_Cliente_Preventa = rstlineas_documentos!Cod_Prov
    gstrTabla_Temporal_Preventa = lstrNombre_Temporal
    
    If pbolLlamado_Desde_Cod_Doc Then
    
        ' JE20160107  / Si es la Barraca cambio de Documento segun sea la preventa Credito o Contado
        
        If ConfFormato_Factura = "BSGIMENEZ" Then
            If rstlineas_documentos!cod_doc = 303 Then
                txtCodDoc.text = 103
            Else
                txtCodDoc.text = 102
            End If
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            
                If D!signo = -1 Then
                    txtNomDoc_Mostrar.ForeColor = &H0&
                Else
                    txtNomDoc_Mostrar.ForeColor = &HFF&
                End If
                txtNomDoc_Mostrar.text = D!nom_doc_mostrar
                
                If D!ndor_doc <> 0 Then
                    If gNumerar = True Then
                        txtDoc.Locked = True
                        If ConfElegirEmpresa = True And ConfPuntoVta_Numerador_Empresa_Madre > 0 Then
                            lEmpresa = ConfPuntoVta_Numerador_Empresa_Madre
                        Else
                            lEmpresa = val(txtEmpresa.text)
                        End If
                        
                        txtDoc.text = Tomo_Nuevo_Numero_Contador_Documentos(lEmpresa, D!ndor_doc, "D", False)
                        Sendkeys "{ENTER}"
                        DoEvents
                    Else
                        txtDoc.text = ""
                        stbAyuda.Panels(1).text = "Ingrese el Nro. de Documento"
                        Call Color_Control_Seleccionado(Me, txtDoc)
                        Call MarcarTexto(txtDoc)
                    End If
                End If
            End If
        End If
    End If
    
    txtCodProv.text = llngCod_Prov
    txtDoc_Remito.text = rstlineas_documentos!cod_doc
    txtRemito.text = rstlineas_documentos!nro_doc
    
    If rstlineas_documentos!cod_doc = ConfDoc_Ingreso_Pedido_Cli_Web Then   'Levantando los medios de pago de pedidos WEB   SS 20191231
    
        If Not Cargo_Grilla_Medios_Pago_PedidoWEB(val(txtEmpresa.text), ConfDoc_Ingreso_Pedido_Cli_Web, rstlineas_documentos!nro_doc) Then
            MsgBox "Error al cargar los medios de pago del Pedido WEB " & ConfDoc_Ingreso_Pedido_Cli_Web & "/" & rstlineas_documentos!nro_doc & " Se Cancela la Carga", vbExclamation, MsgTit
            Call Inicializo_Grilla_Lineas_Medios_Pago
            MousePointer = 1
            cmdGuardar.Enabled = True
            Exit Sub
        End If
    Else
        Call Cargo_Grilla_Medios_Pago_Cliente   'Carga los medios de pago segun doc/clte    SS 20180808
    End If
    
    Call Cargar_Datos_Cabezal_Auxiliar(val(txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc)
    
    If Buscar_Cliente(txtCodProv.text, C) Then
        If Trim(UCase(C!generico)) = "S" Then
            txtNomCli.text = Trim(UCase(rstlineas_documentos!nom_cli))
            
            TxtRuc.text = ""
            If Trim(rstlineas_documentos!ruc) <> "" Then
                If Right(rstlineas_documentos!ruc, 1) = "X" Then    'Si es consumo final    SS 20180820
                    TxtCFinal.text = "X"
                    TxtRuc.text = Mid(Trim(rstlineas_documentos!ruc), 1, Len(Trim(rstlineas_documentos!ruc)) - 1)
                Else
                    TxtRuc.text = Trim(rstlineas_documentos!ruc)
                End If
            End If
            
            txtTipo_Doc_Identidad.text = "4"
            
            ' JE 20170407   Si es un RUT Valido / Coloco txtTipo_Doc_Identidad.txt = 2
            If Validar_RUT(TxtRuc.text) Then
                txtTipo_Doc_Identidad.text = 2
            End If
        
            ' JE 20170407   Si es una CI Valido / Coloco txtTipo_Doc_Identidad.txt = 3
            If Validar_CI_Uruguay(TxtRuc.text) Then
                txtTipo_Doc_Identidad.text = 3
            End If
        Else
            txtNomCli.text = Trim(UCase(C!rsocial_cli))
            
            If Trim(C!ruc_cli) <> "" Then
                TxtRuc.text = Trim(C!ruc_cli)
                txtTipo_Doc_Identidad.text = "2"
            Else
                ' Veo si no se puede poner la CI
                If Trim(C!ci_contacto) <> "" Then
                    TxtRuc.text = Trim(C!ci_contacto)
                    txtTipo_Doc_Identidad.text = "3"
                Else
                    TxtRuc.text = Trim(C!otro_doc_identidad_cli)
                    txtTipo_Doc_Identidad.text = "4"
                End If
            End If
        End If
                
        glngTipo_Documento_Identidad = val(txtTipo_Doc_Identidad.text)
        gstrDocumento_Identidad = Trim(TxtRuc.text)

        ' Agrego por control de NO vacio    SS 20180820
        TxtTCofis.text = "N"
        ldblPorcentaje_TBromatologica = 0
        txtTasa_Bromatologica.text = "0"
        txtImporte_TBromatologica.text = Format(0, "0.00")
        txtPorcentaje_TBromatologica.text = "0.00"
        
        TxtCodSuc.text = "0"
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        End If
        
        ' JE20160107  / Si es la Barraca la Lista es 1 Contado / 2 Credito
        If ConfFormato_Factura = "BSGIMENEZ" Then
            txtLista.text = D!lista_x_defecto
        Else
            If ConfFormato_Factura = "MATPAU" Then      ' AIR 20241105 a pedido de Matpau que levante la lista de la preventa.
                txtLista.text = rstlineas_documentos!nro_rollo
            Else
                txtLista.text = C!nro_lista
                If val(txtLista.text) = 0 Then
                    If Buscar_Empresa(val(txtEmpresa.text), e) Then
                        txtLista.text = e!nro_lista
                    End If
                End If
            End If
        End If
               
        If Not Busco_Lista_Precio(txtLista.text, "V", L) Then
            MsgBox "Lista del Cliente INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
            txtCodProv.SetFocus
            cmdGuardar.Enabled = True
            Exit Sub
        Else
            txtNombre_Lista.text = L!Descripcion
        End If
    Else
        MsgBox "ERROR: Cliente de la PREVENTA INEXISTENTE. Verifique por favor...", vbCritical
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
    
    glngAnterior_Lista = val(txtLista.text)
    
    txtMoneda.text = llngMoneda
    glngAnterior_Moneda = val(txtMoneda.text)
    
    If Busco_Moneda(txtMoneda.text) Then
        txtDes_Moneda.text = Trim(rstMonedas!simbolo)
        txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
        TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
        txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
        TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
    Else
        MsgBox "Moneda de la PREVENTA INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
    
    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
    
    'AIR 20221111 se cambia a pedido de Ricardo porque esta mal esto debe ir el Interbancario
    'AIR 20180326 si la factura es en DOLARES toma el manual comprador
'    If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'    End If
    
    If ldblTipo_Cambio <> 0 Then
        txtTipo_Cambio.text = Format(ldblTipo_Cambio, "###0.000")
    End If
        
    txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
    
    If Trim(rstlineas_documentos!observa) = "" Then
        txtObs.text = Documentos_Seleccionados(gstrTabla_Temporal_Preventa)
    Else
        txtObs.text = Trim(rstlineas_documentos!observa) & Documentos_Seleccionados(gstrTabla_Temporal_Preventa)
    End If
    
    txtVendedor.text = rstlineas_documentos!nro_ven
    If Buscar_Vendedor(txtVendedor.text, R) Then
        TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
    End If
    
    TxtCodSuc.text = rstlineas_documentos!cod_suc
    If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), S) Then
        TxtNomSuc.text = Trim(S!nombre)
    End If
                                
    txtForma_Pago.text = rstlineas_documentos!forma_pago
    If Busco_Forma_Pago(txtForma_Pago.text) Then
        txtDes_Forma_Pago.text = rstFormas_Pago!Descripcion
    
        If IsNumeric(rstFormas_Pago!dias_a_sumar) Then
            txtFec_Vencimiento.text = Calculo_Vencimiento_Forma_Pago_Cliente(val(txtForma_Pago.text), CDate(txtFec_Doc.text))
            txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
        Else
            txtFec_Vencimiento.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
        End If
    
    End If
    rstFormas_Pago.Close
    
    'AIR 20230616 se agrega que levante los datos auxiliares ingresados en la Preventa (Ferr.Arocena)
    Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!Cod_Prov)
    'AIR 20230620 se agrega que actualice los datos del doc sino cuando se consulta con F12 en al linea no muestra nada
    If Trim(lNombre_Tabla_Lineas_Auxiliar_Temporal) <> "" Then
            
            lstrSQL = "DELETE FROM " & Trim(lNombre_Tabla_Lineas_Auxiliar_Temporal)
            lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
            lstrSQL = lstrSQL & " AND cod_doc = " & rstlineas_documentos!cod_doc
            lstrSQL = lstrSQL & " AND nro_doc = " & rstlineas_documentos!nro_doc
            lstrSQL = lstrSQL & " AND cod_prov = " & rstlineas_documentos!Cod_Prov
            Dbs.Execute lstrSQL
            
            lstrSQL = "INSERT INTO " & Trim(lNombre_Tabla_Lineas_Auxiliar_Temporal)
            lstrSQL = lstrSQL & " SELECT * FROM FaccmpLineas_Auxiliar"
            lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
            lstrSQL = lstrSQL & " AND cod_doc = " & rstlineas_documentos!cod_doc
            lstrSQL = lstrSQL & " AND nro_doc = " & rstlineas_documentos!nro_doc
            lstrSQL = lstrSQL & " AND cod_prov = " & rstlineas_documentos!Cod_Prov
            Dbs.Execute lstrSQL
            
            lstrSQL = "UPDATE " & Trim(lNombre_Tabla_Lineas_Auxiliar_Temporal)
            lstrSQL = lstrSQL & " SET nro_doc = " & val(txtDoc.text)
            lstrSQL = lstrSQL & " , cod_doc = " & val(txtCodDoc.text)
            lstrSQL = lstrSQL & " WHERE nro_doc = " & rstlineas_documentos!nro_doc
            lstrSQL = lstrSQL & " AND COD_doc = " & rstlineas_documentos!cod_doc
            
            Dbs.Execute lstrSQL
    End If
End If

Do While Not rstlineas_documentos.EOF
    gbolCargo_Desde_Preventa = True
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PEDIDO: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)


    TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod
    txtCajas.text = rstlineas_documentos!cajas
    
    If ConfFormato_Factura = "BSGIMENEZ" Then
        lbolPedidoFactura = False
    Else
        lbolPedidoFactura = True
    End If
    
    lCantidad = rstlineas_documentos!Cant_Prod
    lPrecio = rstlineas_documentos!Precio
    lMagnitud = -1
    If Buscar_Datos_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, llngCod_Prov, rstlineas_documentos!nro_linea, MD) Then
    End If
    If confUsaEquivalenciaMagnitudes Then
          If Not (MD.EOF And MD.BOF) Then
              If Buscar_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, llngCod_Prov, rstlineas_documentos!nro_linea, ML) Then
                  If ML!Cant_Prod = rstlineas_documentos!Cant_Prod Then
                      lCantidad = MD!cant_prod_magnitud
                  Else
                      lCantidad = lCantidad * MD!cant_prod_magnitud / ML!Cant_Prod
                  End If
                  lPrecio = MD!precio_magnitud
                  lMagnitud = MD!magnitud
                  TxtFactor.text = lCantidad   'muestra los saldos de los pendientes
              End If
          End If
    End If
    
    If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, lPrecio, rstlineas_documentos!tipo_entrega, IIf(MD.BOF And MD.EOF, txtDeposito.text, MD!Deposito), lbolPedidoFactura, "", False, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!Cod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!nro_linea, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, lMagnitud) Then
        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    Else
        ' JE20230628    / Se cargan las Series que vienen desde la PreVenta
        If Buscar_Serie_Articulo_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!Cod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!Cod_Prod, Rs) Then
            While Not Rs.EOF
        
                lstrClave_Colecccion_Series = Trim(str(Rs!nro_linea)) & "-" & Trim(str(Rs!Cod_Prod)) & "-" & Trim(Rs!serie)
                gcolSeries_Articulos.Add Rs!nro_linea, Rs!Cod_Prod, Trim(Rs!serie), Trim(Rs!serie_sin_control_compra), Trim(lstrClave_Colecccion_Series)
    
                Rs.MoveNext
            Wend
            
            Call Cargo_Grilla_Series
            
        End If
    End If
    
    rstlineas_documentos.MoveNext
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop


TxtFactor.text = ""
TxtLector.SetFocus
MousePointer = 1
cmdGuardar.Enabled = True

End Sub

Sub Cargar_Desde_Remito(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long)
Dim lCont As Integer
Dim LD As Recordset
Dim RD As Recordset
Dim MD As Recordset
Dim ML As Recordset
Dim lPrecio As Double
Dim lMagnitud As Long


Dim rstObserva As Recordset
Dim lstrAfecta_Stock As String
Dim lstrDeposito As String

Dim SE As Recordset
Dim ldblPrecio_Unitario As Double
Dim lstrClave_Colecccion_Series As String
Dim lblnCancelar As Boolean

lblnCancelar = False
gNombre_Tabla_Temporal = ""
cmdGuardar.Enabled = False
If Buscar_Tipo_Documento(lCod_Doc, RD) Then
    If RD!stock Then
        ' El Documento Afecta Stock, asi que selecciono los Remitos que No Afecten Stock
        lstrAfecta_Stock = "N"
    Else
        lstrAfecta_Stock = "S"
    End If
Else
    MsgBox "El Documento " & lCod_Doc & " No Esta Definido en el Sistema. Verique...", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If

Call Busqueda_Documentos_Remitos_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", -1, lstrAfecta_Stock, "remitos_clientes", txtMoneda.text, "M")

If Trim(gNombre_Tabla_Temporal) = "" Then
    Exit Sub
    'Salimos porque no hay pedido seleccionadp
Else
    'Trabajo las Lineas directamente porque hay varios cabezales
   ' SQL = "Select fl.precio,f.dto_global,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, p.cod_art_proveedor,"
   ' SQL = SQL & "fl.tipo_entrega, 1 as cajas, 0 as seccion, sum(fl.cant_prod*fl.cajas) as cant_prod "
    
    SQL = "SELECT fl.cod_doc,fl.nro_doc,f.cod_suc,fl.precio,f.dto_global,f.observa,f.nro_ven,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3,"
    SQL = SQL & " p.cod_art_proveedor, fl.tipo_entrega, f.con_sin_iva, 1 as cajas, 0 as seccion, SUM(fl.cant_prod*fl.cajas) as cant_prod,fl.cod_prov"
    SQL = SQL & " FROM faccmp f, FaccmpLineas fl, " & gNombre_Tabla_Temporal & " g , productos p "
    SQL = SQL & " Where p.cod_prod = fl.cod_prod "
    SQL = SQL & " and fl.cod_emp = " & lcod_emp
    SQL = SQL & " and fl.cod_doc = g.cod_doc"
    SQL = SQL & " and fl.nro_doc=g.nro_doc"
    SQL = SQL & " and fl.cod_prov=" & lCod_Prov
    SQL = SQL & " and f.cod_emp=fl.cod_emp"
    SQL = SQL & " and f.cod_doc=fl.cod_doc"
    SQL = SQL & " and f.nro_doc=fl.nro_doc"
    SQL = SQL & " and f.cod_prov=fl.cod_prov"
    SQL = SQL & " group by fl.cod_doc,fl.nro_doc,f.cod_suc,f.observa,f.nro_ven,fl.precio,f.dto_global,fl.nro_linea,fl.cod_prod,fl.descuento1, fl.descuento2, fl.descuento3,"
    SQL = SQL & " p.cod_art_proveedor,fl.tipo_entrega,F.con_Sin_iva , fl.Cod_Prov"
    SQL = SQL & " order by fl.nro_linea,fl.cod_prod "
    
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If
'Muestro en la grilla
MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > llngMaximo_Lineas Then
    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If

Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

If Not rstlineas_documentos.EOF Then
    txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
End If
Do While Not rstlineas_documentos.EOF
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PEDIDO: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)
       
    'JCH 20220602 se agrego este codigo por el manejo de magnitudes
    lCantidad = rstlineas_documentos!Cant_Prod
    lPrecio = rstlineas_documentos!Precio
    lMagnitud = -1
    If Buscar_Datos_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, lCod_Prov, rstlineas_documentos!nro_linea, MD) Then
    End If
       
    '-----------------
     If confUsaEquivalenciaMagnitudes Then
          If Not (MD.EOF And MD.BOF) Then
             lCantidad = MD!cant_prod_magnitud
              
             lPrecio = MD!precio_magnitud
             lMagnitud = MD!magnitud
             TxtFactor.text = lCantidad   'muestra los saldos de los pendientes
              
          End If
    End If
    
   
    
    '---------------fin
      
       
       
     
     If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, lPrecio, rstlineas_documentos!tipo_entrega, IIf(MD.EOF And MD.BOF, txtDeposito.text, MD!Deposito), True, "", False, rstlineas_documentos!cod_doc, 0, rstlineas_documentos!Cod_Prov, 0, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!nro_linea, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, lMagnitud) Then
   
    'If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, rstlineas_documentos!Precio, rstlineas_documentos!tipo_entrega, lstrDeposito, True, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar) Then
        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    
    End If
    
    rstlineas_documentos.MoveNext
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop

' Cargo las observaciones desde el remito
SQL = "SELECT fec_reg, linea, observacion FROM Faccmp_Observaciones, " & lNombre_Tabla_Temporal & " REMITO"
SQL = SQL & " WHERE Faccmp_Observaciones.cod_emp = " & lcod_emp
SQL = SQL & " AND Faccmp_Observaciones.cod_doc = REMITO.cod_doc"
SQL = SQL & " AND Faccmp_Observaciones.nro_doc = REMITO.nro_doc"
SQL = SQL & " AND Faccmp_Observaciones.cod_prov = " & lCod_Prov
Set rstObserva = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

If Not rstObserva.EOF Then
    SQL = "DELETE FROM Faccmp_Observaciones "
    SQL = SQL & " WHERE cod_emp = " & lcod_emp & " AND cod_doc = " & lCod_Doc
    SQL = SQL & " AND nro_doc = " & lNro_Doc & " AND cod_prov = " & lCod_Prov

    Dbs.Execute SQL

End If

Do Until rstObserva.EOF

    SQL = "INSERT INTO Faccmp_Observaciones "
    SQL = SQL & " VALUES ("
    SQL = SQL & lcod_emp & ","                                          ' cod_emp
    SQL = SQL & lCod_Doc & ","                                          ' cod_doc
    SQL = SQL & lNro_Doc & ","                                          ' nro_doc
    SQL = SQL & lCod_Prov & ","                                         ' cod_prov
    SQL = SQL & f_Fecha_Base(rstObserva!fec_reg, Conf_Motor_Base) & "," ' fec_reg
    SQL = SQL & rstObserva!linea & ",'"                                 ' linea
    SQL = SQL & f_Ins_String(Trim(rstObserva!observacion)) & "','"      ' observacion
    SQL = SQL & Trim(UCase(gUsuario)) & "')"                            ' usuario

    Dbs.Execute SQL

    rstObserva.MoveNext
Loop
rstObserva.Close
Call Ajustar_Boton_Observaciones_Extras(str(lcod_emp), str(lCod_Doc), str(lNro_Doc), str(lCod_Prov), sscObservacion_Extra)
 
TxtFactor.text = ""
MousePointer = 1
cmdGuardar.Enabled = True

End Sub

Sub Cargar_Desde_Remito_Grilla_Servicios(llngCod_Emp As Long, llngCod_Doc As Long, llngNro_Doc As Long, llngCod_Prov As Long, llngMoneda As Long, ldteFecha As Date)
Dim lrstDocumento As Recordset
Dim lrstCabezales As Recordset
Dim lrstServicio As Recordset
Dim lrstSeccion As Recordset

Dim lblnCancelar As Boolean
Dim lstrAfecta_Stock As String
Dim lbolPrimera_Linea As Boolean

    lblnCancelar = False
    gNombre_Tabla_Temporal = ""
    cmdGuardar.Enabled = False
    
    If Buscar_Tipo_Documento(llngCod_Doc, lrstDocumento) Then
        If lrstDocumento!stock Then
            ' El Documento Afecta Stock, asi que selecciono los Remitos que No Afecten Stock
            lstrAfecta_Stock = "N"
        Else
            lstrAfecta_Stock = "S"
        End If
    Else
        MsgBox "El Documento " & llngCod_Doc & " No Esta Definido en el Sistema. Verique...", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
    
    Call Busqueda_Documentos_Remitos_a_Afectar(llngCod_Emp, llngCod_Prov, "E", -1, lstrAfecta_Stock, "remitos_clientes", llngMoneda, "S")
    
    If Trim(gNombre_Tabla_Temporal) = "" Then
        Exit Sub
        'Salimos porque no hay pedido seleccionadp
    Else
        
        SQL = "SELECT Faccmp.cod_emp,Faccmp.cod_doc,Faccmp.nro_doc,Faccmp.cod_prov,Faccmp.fec_doc,"
        SQL = SQL & " FaccmpEfactura.TipoCAE , FaccmpEfactura.serie, FaccmpEfactura.numero,FaccmpImpuestos.cod_impuesto,"
        SQL = SQL & " SUM(FaccmpImpuestos.imp_sin_impuestos) AS Importe_SImpuestos, "
        SQL = SQL & " SUM(FaccmpImpuestos.imp_sin_impuestos+FaccmpImpuestos.importe) AS Importe_CImpuestos, "
        SQL = SQL & " SUM(Faccmp.importe) AS Importe "
        SQL = SQL & " FROM Faccmp, FaccmpEfactura, FaccmpImpuestos, " & gNombre_Tabla_Temporal & " t"
        SQL = SQL & " WHERE Faccmp.Cod_Emp = " & llngCod_Emp
        SQL = SQL & " AND t.cod_doc = Faccmp.cod_doc"
        SQL = SQL & " AND t.nro_doc = Faccmp.nro_doc"
        SQL = SQL & " AND Faccmp.cod_prov = " & llngCod_Prov
        SQL = SQL & " AND Faccmp.cod_emp = FaccmpEfactura.cod_emp"
        SQL = SQL & " AND Faccmp.cod_doc = FaccmpEfactura.cod_doc"
        SQL = SQL & " AND Faccmp.nro_doc = FaccmpEfactura.nro_doc"
        SQL = SQL & " AND Faccmp.cod_prov = FaccmpEfactura.cod_prov"
        SQL = SQL & " AND Faccmp.cod_emp = FaccmpImpuestos.cod_emp"
        SQL = SQL & " AND Faccmp.cod_doc = FaccmpImpuestos.cod_doc"
        SQL = SQL & " AND Faccmp.nro_doc = FaccmpImpuestos.nro_doc"
        SQL = SQL & " AND Faccmp.cod_prov = FaccmpImpuestos.cod_prov"
        SQL = SQL & " AND FaccmpImpuestos.cod_tipo_impuesto = 'IVA'"
    
        SQL = SQL & " GROUP BY Faccmp.cod_emp,Faccmp.cod_doc,Faccmp.nro_doc,Faccmp.cod_prov,Faccmp.fec_doc, FaccmpEfactura.tipoCAE,FaccmpEfactura.serie,FaccmpEfactura.numero,FaccmpImpuestos.cod_impuesto"
    
        SQL = SQL & " ORDER BY Faccmp.cod_emp,FaccmpEfactura.tipoCAE,FaccmpEfactura.serie,FaccmpEfactura.numero"
        
        'Paso el nombre de la tabla global a una variable local del formulario
        lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
    
    End If
    
'    'Muestro en la grilla
'    MousePointer = 11
'    lCont = vsfLineas_Mercaderia.Rows
'
'    If lCont > llngMaximo_Lineas Then
'        MsgBox "Los Remitos Seleccionados Superan el Máximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
'        MousePointer = 1
'        cmdGuardar.Enabled = True
'        Exit Sub
'    End If
    
    Set lrstCabezales = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

    dbgLineas_Servicios.removeAll
    dbgLineas_Servicios.MoveFirst
    lbolPrimera_Linea = True
    
    Do While Not lrstCabezales.EOF
        
        If lbolPrimera_Linea Then
            lbolPrimera_Linea = False
            
            dbgLineas_Servicios.Columns("unidades").text = 1
            dbgLineas_Servicios.Columns("codigo").text = 0
            
            dbgLineas_Servicios.Columns("descripcion").text = "REMITOS AFECTADOS:"
            
            dbgLineas_Servicios.Columns("seccion").text = 0
            If Buscar_Seccion(val(dbgLineas_Servicios.Columns("seccion").text), lrstSeccion) Then
                dbgLineas_Servicios.Columns("desc_seccion").text = Trim(lrstSeccion!Descripcion)
            End If
            
            dbgLineas_Servicios.Columns("tcofis").text = 0
            dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, ldteFecha), "#0.00")
            
            dbgLineas_Servicios.Columns("tiva").text = 0
            dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, ldteFecha), "#0.00")
            
            dbgLineas_Servicios.Columns("tcofis_iva").text = 0
            If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
                dbgLineas_Servicios.Columns("cofis_iva").text = 0
            Else
                dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, ldteFecha), "#0.00")
            End If
            
            dbgLineas_Servicios.Columns("precio_siva").text = Format(0, "0.00")
            dbgLineas_Servicios.Columns("precio").text = Format(0, "0.00")
            
            Call Calcular_Importes_de_la_Linea_Servicios(True, "", False)
        
            dbgLineas_Servicios.MoveNext
        
        End If
        
        dbgLineas_Servicios.Columns("unidades").text = 1
        dbgLineas_Servicios.Columns("codigo").text = confPuntoVta_Cod_Servicio_x_Defecto_Remitos_Afectados
        
        If Busco_Insumo_Servicio(confPuntoVta_Cod_Servicio_x_Defecto_Remitos_Afectados, lrstServicio) Then
            dbgLineas_Servicios.Columns("descripcion").text = Trim(lrstCabezales!TipoCAE) & " " & Trim(lrstCabezales!serie) & "/" & Trim(lrstCabezales!numero) & " - Tasa IVA " & Format(Porcentaje_Impuesto_Vigente("IVA", lrstCabezales!cod_impuesto, ldteFecha), "#0.00")
        End If
        
        dbgLineas_Servicios.Columns("seccion").text = 0
        If Buscar_Seccion(val(dbgLineas_Servicios.Columns("seccion").text), lrstSeccion) Then
            dbgLineas_Servicios.Columns("desc_seccion").text = Trim(lrstSeccion!Descripcion)
        End If
        
        dbgLineas_Servicios.Columns("tcofis").text = 0
        dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, ldteFecha), "#0.00")
        
        dbgLineas_Servicios.Columns("tiva").text = lrstCabezales!cod_impuesto
        dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, ldteFecha), "#0.00")
        
        dbgLineas_Servicios.Columns("tcofis_iva").text = lrstCabezales!cod_impuesto
        If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
            dbgLineas_Servicios.Columns("cofis_iva").text = 0
        Else
            dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, ldteFecha), "#0.00")
        End If
        
        If Int(lrstCabezales!Importe_CImpuestos) = Int(lrstCabezales!Importe) Then
            dbgLineas_Servicios.Columns("precio_siva").text = Format(lrstCabezales!Importe_SImpuestos, "0.00")
            dbgLineas_Servicios.Columns("precio").text = Format(lrstCabezales!Importe, "0.00")
        Else
            dbgLineas_Servicios.Columns("precio_siva").text = Format(lrstCabezales!Importe_SImpuestos, "0.00")
            dbgLineas_Servicios.Columns("precio").text = Format(lrstCabezales!Importe_CImpuestos, "0.00")
        End If
        
        Call Calcular_Importes_de_la_Linea_Servicios(True, "", False)
    
        lrstCabezales.MoveNext
        dbgLineas_Servicios.MoveNext
    Loop
    lrstCabezales.Close
       
    If dbgLineas_Servicios.visible Then
        dbgLineas_Servicios.Enabled = True
        dbgLineas_Servicios.SetFocus
        dbgLineas_Servicios.Col = 0
    End If

    MousePointer = 1
    cmdGuardar.Enabled = True

End Sub

Sub Cargar_Desde_Doc_Pendientes_Definidos(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long, lCod_Suc As Long, lMoneda As Long)
Dim lrstDocumentos As Recordset
Dim lrstEntregas As Recordset
Dim rstObserva As Recordset
Dim lrstFormasPago As Recordset
Dim lrstDocsPend As Recordset
Dim lrstObserv_documentos As Recordset
Dim SE As Recordset
Dim R As Recordset

Dim lCont As Integer
Dim lstrAfecta_Stock As String
Dim lstrDocActual As String
Dim ldblCantidadEntregada As Double

Dim lstrCod_Doc_Afectar As String
Dim lstrDocumentos_Pendientes_Validos As String
Dim lstrSQL As String
Dim llngLinea As Long
Dim lblnCancelar As Boolean
Dim lstrNombre_Tabla_Temporal As String

Dim lbln_Cargo_Datos_Desde_F10_local As Boolean

Dim lCantidad As Double
Dim lPrecio As Double
Dim lMagnitud As Long
Dim MD As Recordset
Dim ML As Recordset

Dim lstrNomCli As String
Dim lstrRuc As String
Dim pbooModificado As Boolean

        
    lbln_Cargo_Datos_Desde_F10_local = False
    gbln_Articulo_de_F10 = False
    
    lstrDocActual = Trim(str(lCod_Doc)) & Trim(str(lNro_Doc))   ' se usa para las modificaciones, para excluir en la SELECT el documento que se esta modificando
    
    lstrNombre_Tabla_Temporal = ""
    gNombre_Tabla_Temporal = ""
    
    lblnCancelar = False
    
    cmdGuardar.Enabled = False
    If Buscar_Tipo_Documento(lCod_Doc, lrstDocumentos) Then
        If lrstDocumentos!stock Then
            lstrAfecta_Stock = "N"
        Else
            lstrAfecta_Stock = "S"
        End If
    Else
        MsgBox "El Documento " & lCod_Doc & " No Esta Definido en el Sistema. Verique...", vbExclamation, MsgTit
        MousePointer = 1
        cmdGuardar.Enabled = True
        Exit Sub
    End If
    gBusqueda_Doc_Pendientes_Formato = ""
    'AIR 20250218/20250321
    
    If f_InStr_Split(Trim(ConfDocs_Validos_Acopio), Trim(txtCodDoc.text)) Then
        gBusqueda_Doc_Pendientes_Formato = "V4"
        
        lstrCod_Doc_Afectar = ""
        
        frmBusqueda_Documentos_a_Afectar_V4.pstrTabla_Temporal = ""   'AIR 20250407
        Call Busqueda_Documentos_Definidos_a_Afectar(lcod_emp, lCod_Prov, lCod_Doc, lNro_Doc, lrstDocumentos!signo, lstrAfecta_Stock, "PENDIENTES_DEFINIDOS", lMoneda)
        
        gNombre_Tabla_Temporal = frmBusqueda_Documentos_a_Afectar_V4.pstrTabla_Temporal
        If Trim(gNombre_Tabla_Temporal) = "" Then
        'If Trim(gNombre_Tabla_Temporal) = "" Then
            lstrNombre_Tabla_Temporal = ""
            Exit Sub    'Salimos porque no hay documentos seleccionados
        End If
        
        
        If Not confUsaEquivalenciaMagnitudes Then
             lstrSQL = "SELECT fl.precio,f.dto_global,fp.cod_doca, fp.nro_doca,fp.nro_lineaa as nro_linea,fp.cod_proda as cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
             lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion, sum(fp.cant_prod) as cantidad_prod, (g.cant_sel) as cant_prod, p.ubicacion,f.nom_cli,f.ruc "
             lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
             lstrSQL = lstrSQL & " INNER JOIN faccmp f "
             lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
             lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
             lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
             lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
             lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
             lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc AND g.nro_linea = fl.nro_linea  "
             lstrSQL = lstrSQL & " INNER JOIN productos p "
             lstrSQL = lstrSQL & " ON p.cod_prod = fl.cod_prod "
             lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
             lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
             lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
             lstrSQL = lstrSQL & " AND   f.autorizado = 'S' AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
             lstrSQL = lstrSQL & " GROUP BY fl.precio, f.dto_global, fp.cod_doca, fp.nro_doca, fp.nro_lineaa, fp.cod_proda, g.cant_sel, fl.descuento1, fl.descuento2, fl.descuento3, "
             lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, p.ubicacion, f.nom_cli,f.ruc "
             lstrSQL = lstrSQL & " HAVING sum(fp.cant_prod) <> 0 "
     
        Else
             lstrSQL = "SELECT fl.precio,f.dto_global,fp.cod_doca, fp.nro_doca,fp.nro_lineaa as nro_linea,fp.cod_proda as cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
             lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion,"
             lstrSQL = lstrSQL & " sum(rfd.cant_prod_magnitud*(fp.cant_prod/abs(fp.cant_prod))) as cantidad_prod, (g.cant_sel) as cant_prod"
             
             lstrSQL = lstrSQL & " ,p.ubicacion,f.nom_cli,f.ruc "
             lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
             
             lstrSQL = lstrSQL & " INNER JOIN faccmp f "
             lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
             lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
             lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
             lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
             
             lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Datos rfd  ON  fp.cod_emp=rfd.cod_emp AND fp.cod_doc=rfd.cod_doc AND fp.nro_doc=rfd.nro_doc AND fp.cod_prov=fp.cod_prov"
             lstrSQL = lstrSQL & " AND fp.cod_prov=rfd.cod_prov AND fp.nro_linea=rfd.nro_linea"

             lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
             lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc AND g.nro_linea = fl.nro_linea  "
             lstrSQL = lstrSQL & " INNER JOIN productos p "
             lstrSQL = lstrSQL & " ON p.cod_prod = fl.cod_prod "
             
             lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
             lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
             lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
             lstrSQL = lstrSQL & " AND   f.autorizado = 'S' "
             lstrSQL = lstrSQL & " AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
             lstrSQL = lstrSQL & " AND   fp.cant_prod <> 0 and g.cant_sel <> 0 "    ' JE 20240819   /   Se agrego esta condicion porque en el SELECT se divide por ese campo y puede venir en 0
             
             lstrSQL = lstrSQL & " GROUP BY fl.precio, f.dto_global, fp.cod_doca, fp.nro_doca, fp.nro_lineaa, fp.cod_proda, fl.descuento1, fl.descuento2, fl.descuento3, "
             lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, p.ubicacion, f.nom_cli,f.ruc "
             
             lstrSQL = lstrSQL & " HAVING sum (rfd.cant_prod_magnitud * (FP.cant_prod / Abs(FP.cant_prod))) > 0"
             
        End If
        lstrSQL = lstrSQL & " ORDER BY fp.nro_lineaa, fp.cod_proda"
        
'        'Paso el nombre de la tabla global a una variable local del formulario
        lstrNombre_Tabla_Temporal = gNombre_Tabla_Temporal

       
        'Cargo datos para el cabezal
        Set rstlineas_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
        If Not rstlineas_documentos.EOF Then
            txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
            ' AIR 20200603 se agrega la condicion de que si la forma de pago que viene en el doc original es 0 no le pase por arriba a la definida en el documento a generar
            If val(txtForma_Pago.text) = 0 Or NullToZero(rstlineas_documentos!forma_pago <> 0) Then
                txtForma_Pago.text = rstlineas_documentos!forma_pago            'Se pasa la forma de pago del doc original  SS 20160419
                If Buscar_Forma_Pago(txtForma_Pago.text, lrstFormasPago) Then
                    txtDes_Forma_Pago.text = lrstFormasPago!Descripcion
                    txtFec_Vencimiento.text = CDate(txtFec_Doc.text) + lrstFormasPago!dias_a_sumar
                    txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                End If
        
            End If
        End If
        
        If confPuntoVta_Actualiza_Datos_Cliente_F10 Then
            lstrNomCli = ""
            lstrRuc = ""
            pbooModificado = False
            If Not (rstlineas_documentos.EOF And rstlineas_documentos.BOF) Then
                 Do While Not rstlineas_documentos.EOF
                     If Trim(lstrNomCli) <> Trim(rstlineas_documentos!nom_cli) Or Trim(lstrRuc) <> Trim(rstlineas_documentos!ruc) Then
                         If Not pbooModificado Then
                             lstrNomCli = Trim(rstlineas_documentos!nom_cli)
                             lstrRuc = Trim(rstlineas_documentos!ruc)
                             pbooModificado = True
                         Else
                             pbooModificado = False
                             Exit Do
                         End If
                     End If
                     rstlineas_documentos.MoveNext
                Loop
                If pbooModificado Then
                    Me.txtNomCli.text = lstrNomCli
                    Me.TxtRuc.text = lstrRuc
                    Me.txtTipo_Doc_Identidad.text = f_Tipo_documento_DGI(lstrRuc)
                End If
                rstlineas_documentos.MoveFirst
            End If
        End If
        
        'Cargo datos para las lineas
        Do While Not rstlineas_documentos.EOF
            
            'Log para identificar si un articulo es llamado y no es cargado.
            Call Cargo_Logtrans("ALTA LINEA DESDE PENDIENTE: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)
        'AIR 20250328
            'TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!cant_prod    'muestra los saldos de los pendientes
           TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod    'muestra los saldos de los pendientes
           
            If val(TxtFactor.text) <> 0 Then
                gbln_Articulo_de_F10 = True
                'lCantidad = rstlineas_documentos!cant_prod
                lCantidad = rstlineas_documentos!Cant_Prod
                lPrecio = rstlineas_documentos!Precio
                lMagnitud = -1
                If Buscar_Datos_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, MD) Then
                End If
                
                If confUsaEquivalenciaMagnitudes Then
                    If Not (MD.EOF And MD.BOF) Then
                       If Buscar_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, ML) Then
                    '       If ML!Cant_Prod = rstlineas_documentos!Cant_Prod Then
                    '           lCantidad = MD!cant_prod_magnitud
                    '       Else
                    '           lCantidad = lCantidad * MD!cant_prod_magnitud / ML!Cant_Prod
                    '       End If
                           lPrecio = MD!precio_magnitud
                           lMagnitud = MD!magnitud
                           TxtFactor.text = rstlineas_documentos!cajas * lCantidad   'muestra los saldos de los pendientes
                       End If
                    End If
                End If
                
                
                If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, lPrecio, rstlineas_documentos!tipo_entrega, IIf(MD.BOF And MD.EOF, txtDeposito.text, MD!Deposito), True, "", False, rstlineas_documentos!cod_doca, 0, lCod_Prov, 0, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, rstlineas_documentos!nro_linea, lCantidad, ldblCantidadEntregada, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, lMagnitud) Then
                    MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
                    
                    'AIR 20190909
                    gbln_Articulo_de_F10 = False
                    If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                        gbln_Cargo_Datos_Desde_F10 = True
                    End If
                    If lblnCancelar Then
                        Exit Do
                    End If
                End If
                gbln_Articulo_de_F10 = False
                ' JE 20180629   /   Cargo Coleccion de Serie por si fueron ingresadas en el Pedido
                If Buscar_Serie_Articulo_Linea_Documento(lcod_emp, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!Cod_Prod, SE) Then
                
                    While Not SE.EOF
                
                        lstrClave_Colecccion_Series = Trim(str(SE!nro_linea)) & "-" & Trim(str(SE!Cod_Prod)) & "-" & Trim(SE!serie)
                        gcolSeries_Articulos.Add SE!nro_linea, SE!Cod_Prod, Trim(SE!serie), Trim(SE!serie_sin_control_compra), Trim(lstrClave_Colecccion_Series)
            
                        SE.MoveNext
                    Wend
                        
                End If
                
                'AIR 20190909
                lbln_Cargo_Datos_Desde_F10_local = True
                
                lCont = lCont + 1
                If lCont > glngCantLinMaxima Then 'ConfCantidad_Maxima_Lineas_Facturador Then
                    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
                    
                    lstrNombre_Tabla_Temporal = ""
                    'AIR 20190909
                    If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                        gbln_Cargo_Datos_Desde_F10 = lbln_Cargo_Datos_Desde_F10_local
                    End If
                    vsfLineas_Mercaderia.RemoveItem vsfLineas_Mercaderia.Rows - 1
                    MousePointer = 1
                    cmdGuardar.Enabled = True
                    Exit Do
                End If
            End If
            
            rstlineas_documentos.MoveNext
        Loop
        
        'Cargo la observaciones de los doc originales elegidos      SS 20180202
        If ConfPuntoVta_Trae_Observacion_Cabezal_Documento_Origen Then   'segun parametro    SS 20190227
        
            lstrSQL = "SELECT fp.cod_doca, fp.nro_doca, f.observa"
            lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
            lstrSQL = lstrSQL & " INNER JOIN faccmp f "
            lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
            lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
            lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
            lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
            lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
            lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc "
            lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
            lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
            lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
            lstrSQL = lstrSQL & " AND   f.autorizado = 'S' AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
            lstrSQL = lstrSQL & " GROUP BY fp.cod_doca, fp.nro_doca, f.observa "
            lstrSQL = lstrSQL & " HAVING sum(fp.cant_prod) <> 0 "
            lstrSQL = lstrSQL & " ORDER BY fp.cod_doca, fp.nro_doca"
            
            txtObs.text = ""
            
            Set lrstObserv_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            Do Until lrstObserv_documentos.EOF
                If txtObs.text = "" Then            'Este campo tiene definido MaxLength de 100
                    txtObs.text = Trim(lrstObserv_documentos!observa)
                Else
                    txtObs.text = txtObs.text & " / " & Trim(lrstObserv_documentos!observa)
                End If
                
                lrstObserv_documentos.MoveNext
            Loop
            lrstObserv_documentos.Close
        End If
        
        ' Cargo las observaciones extendidas de los doc originales elegidos
        If ConfPuntoVta_Trae_Observacion_Extendida_Documento_Origen Then   'segun parametro    SS 20190227
        
            lstrSQL = "DELETE FROM Faccmp_Observaciones "
            lstrSQL = lstrSQL & " WHERE cod_emp = " & lcod_emp & " AND cod_doc = " & lCod_Doc
            lstrSQL = lstrSQL & " AND   nro_doc = " & lNro_Doc & " AND cod_prov = " & lCod_Prov
            Dbs.Execute lstrSQL
            
            llngLinea = 0
                
            lstrSQL = "SELECT fec_reg, linea, observacion FROM Faccmp_Observaciones, " & lstrNombre_Tabla_Temporal & " REMITO"
            lstrSQL = lstrSQL & " WHERE Faccmp_Observaciones.cod_emp = " & lcod_emp
            lstrSQL = lstrSQL & " AND Faccmp_Observaciones.cod_doc = REMITO.cod_doc"
            lstrSQL = lstrSQL & " AND Faccmp_Observaciones.nro_doc = REMITO.nro_doc"
            lstrSQL = lstrSQL & " AND Faccmp_Observaciones.cod_prov = " & lCod_Prov
            lstrSQL = lstrSQL & " ORDER BY  Faccmp_Observaciones.cod_doc, Faccmp_Observaciones.nro_doc, Faccmp_Observaciones.linea"
            
            Set rstObserva = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            Do Until rstObserva.EOF
            
                ' Numero por si se trae más de 1 documento con observaciones    SS 20190227
                llngLinea = llngLinea + 1
                
                lstrSQL = "INSERT INTO Faccmp_Observaciones "
                lstrSQL = lstrSQL & " VALUES ("
                lstrSQL = lstrSQL & lcod_emp & ","                                          ' cod_emp
                lstrSQL = lstrSQL & lCod_Doc & ","                                          ' cod_doc
                lstrSQL = lstrSQL & lNro_Doc & ","                                          ' nro_doc
                lstrSQL = lstrSQL & lCod_Prov & ","                                         ' cod_prov
                lstrSQL = lstrSQL & f_Fecha_Base(rstObserva!fec_reg, Conf_Motor_Base) & "," ' fec_reg
                'lstrSQL = lstrSQL & rstObserva!linea & ",'"                                ' linea
                lstrSQL = lstrSQL & llngLinea & ",'"                                        ' linea
                lstrSQL = lstrSQL & f_Ins_String(Trim(rstObserva!observacion)) & "','"      ' observacion
                lstrSQL = lstrSQL & Trim(UCase(gUsuario)) & "')"                            ' usuario
            
                Dbs.Execute lstrSQL
            
                rstObserva.MoveNext
            Loop
            rstObserva.Close
            
            Call Ajustar_Boton_Observaciones_Extras(str(lcod_emp), str(lCod_Doc), str(lNro_Doc), str(lCod_Prov), sscObservacion_Extra)
        End If
        
    Else
        If ConfBusqueda_Doc_Pendientes_Formato = "V3" Then
            
            lstrCod_Doc_Afectar = ""
            lstrDocActual = Trim(str(lCod_Doc)) & Trim(str(lNro_Doc))   ' se usa para las modificaciones, para excluir en la SELECT el documento que se esta modificando
            
            lstrDocumentos_Pendientes_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento_Control(lCod_Doc)
        
            If Trim(lstrDocumentos_Pendientes_Validos) = "" Then
                MsgBox "ERROR: Documento Sin Configuración de Documentos Pendientes Válidos." & Chr(13) & "Verifique por favor...", vbCritical
                
                Exit Sub
            Else
                lstrCod_Doc_Afectar = "Faccmp.cod_doc in (" & lstrDocumentos_Pendientes_Validos & ") "
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND Faccmp.autorizado = 'S' "     'NO anulados    SS 20180126
                
                'AIR 20220901 se agrega comillas a la query porque estaba comparando un string contra un int y daba desbordamiento
                'lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', '') <> " & lstrDocActual
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND ltrim(rtrim(REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', ''))) <> '" & lstrDocActual & "'"
    
                frmBusqueda_Documentos_a_Afectar_V3.pglngCod_Emp_Afectar = lcod_emp
                frmBusqueda_Documentos_a_Afectar_V3.pglngCod_Prov_Afectar = lCod_Prov
                frmBusqueda_Documentos_a_Afectar_V3.pglngCod_Suc_Afectar = lCod_Suc
                frmBusqueda_Documentos_a_Afectar_V3.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
                frmBusqueda_Documentos_a_Afectar_V3.pstrTabla_Temporal = ""
                
                frmBusqueda_Documentos_a_Afectar_V3.Show vbModal
                
                If Trim(frmBusqueda_Documentos_a_Afectar_V3.pstrTabla_Temporal) <> "" Then
                    
                    'Paso el nombre de la tabla global a una variable local del formulario
                               
                    lstrSQL = "SELECT fl.precio,f.dto_global,fp.cod_doca, fp.nro_doca,fp.nro_lineaa as nro_linea,fp.cod_proda as cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
                    lstrSQL = lstrSQL & " p.cod_art_proveedor, p.cod_prod_sistema_ant, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion, sum(fp.cant_prod) as cant_prod "
                    lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
                    
                    lstrSQL = lstrSQL & " INNER JOIN faccmp f ON f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
                    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
                    lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
                    lstrSQL = lstrSQL & " INNER JOIN " & Trim(frmBusqueda_Documentos_a_Afectar_V3.pstrTabla_Temporal) & " g " & " ON g.cod_emp = fl.cod_emp AND g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc AND g.cod_prov = fl.cod_prov AND g.cod_prod = fl.cod_prod AND g.nro_linea = fl.nro_linea "
                    lstrSQL = lstrSQL & " INNER JOIN productos p ON p.cod_prod = fl.cod_prod "
                    
                    lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
                    lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
                    lstrSQL = lstrSQL & " AND  ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
                    lstrSQL = lstrSQL & " AND   f.autorizado = 'S'"
                    lstrSQL = lstrSQL & " AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
                    
                    lstrSQL = lstrSQL & " GROUP BY fl.precio, f.dto_global, fp.cod_doca, fp.nro_doca, fp.nro_lineaa, fp.cod_proda, fl.descuento1, fl.descuento2, fl.descuento3, "
                    lstrSQL = lstrSQL & " p.cod_art_proveedor, p.cod_prod_sistema_ant, fl.tipo_entrega, f.forma_pago "
                    
                    lstrSQL = lstrSQL & " HAVING sum(fp.cant_prod) > 0 "
                    'solo se van a selecionar los saldos positivos los saldos negativos no porque significa que afecto mas unidades del ingreso
                    'eso es por el cambio de magnitudes entre el origen y la afectiacion JCH 270123
                    
    '
                    lstrSQL = lstrSQL & " ORDER BY p.cod_prod_sistema_ant, p.cod_prod"
      
                    Set rstlineas_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                    
                    lCont = vsfLineas_Mercaderia.Rows
                    
                    'Cargo datos para las lineas
                    Do While Not rstlineas_documentos.EOF
                        
                        'Log para identificar si un articulo es llamado y no es cargado.
                        Call Cargo_Logtrans("ALTA LINEA DESDE PENDIENTE: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!Cant_Prod)
                    
                        TxtFactor.text = rstlineas_documentos!Cant_Prod   'muestra los saldos de los pendientes
                       
                        If val(TxtFactor.text) <> 0 Then
                            gbln_Articulo_de_F10 = True   ' AIR variable para que en proceso codigo sepa que debe buscar la descripcion del documento referencia en FaccmpDescripciones
                            If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, 0, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, rstlineas_documentos!Precio, rstlineas_documentos!tipo_entrega, txtDeposito.text, True, "", False, 0, 0, lCod_Prov, 0, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, rstlineas_documentos!nro_linea, rstlineas_documentos!Cant_Prod, ldblCantidadEntregada, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                                MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
                                gbln_Articulo_de_F10 = False
                                If lblnCancelar Then
                                    Exit Do
                                End If
                            End If
                            
                            ' AIR 20190909
                            gbln_Articulo_de_F10 = False
                            lbln_Cargo_Datos_Desde_F10_local = True
                            ' JE 20180629   /   Cargo Coleccion de Serie por si fueron ingresadas en el Pedido
                            If Buscar_Serie_Articulo_Linea_Documento(lcod_emp, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!Cod_Prod, SE) Then
                                While Not SE.EOF
                            
                                    lstrClave_Colecccion_Series = Trim(str(SE!nro_linea)) & "-" & Trim(str(SE!Cod_Prod)) & "-" & Trim(SE!serie)
                                    gcolSeries_Articulos.Add SE!nro_linea, SE!Cod_Prod, Trim(SE!serie), Trim(SE!serie_sin_control_compra), Trim(lstrClave_Colecccion_Series)
                        
                                    SE.MoveNext
                                Wend
                                    
                            End If
                            
                            lCont = lCont + 1
                            If lCont > glngCantLinMaxima Then 'ConfCantidad_Maxima_Lineas_Facturador Then
                                MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
                                MousePointer = 1
                                
                                ' AIR 20190909
                                If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                                    gbln_Cargo_Datos_Desde_F10 = lbln_Cargo_Datos_Desde_F10_local
                                End If
                            
                                cmdGuardar.Enabled = True
                                Exit Sub
                            End If
                        End If
                        
                        rstlineas_documentos.MoveNext
                    Loop
                    'AIR 20190909 si la var global esta en false y se cargaron datos aqui se pone en true sino queda con el valor anterior al ingresar a este proceso
                    If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                        gbln_Cargo_Datos_Desde_F10 = lbln_Cargo_Datos_Desde_F10_local
                    End If
                Else
                    Exit Sub    'Salimos porque no hay documentos seleccionados
                End If
            End If
            
        Else
    
            Call Busqueda_Documentos_Definidos_a_Afectar(lcod_emp, lCod_Prov, lCod_Doc, lNro_Doc, lrstDocumentos!signo, lstrAfecta_Stock, "PENDIENTES_DEFINIDOS", lMoneda)
            
            If Trim(gNombre_Tabla_Temporal) = "" Then
                lstrNombre_Tabla_Temporal = ""
                Exit Sub    'Salimos porque no hay documentos seleccionados
            End If
            
            If Not confUsaEquivalenciaMagnitudes Then
                 lstrSQL = "SELECT fl.precio,f.dto_global,fp.cod_doca, fp.nro_doca,fp.nro_lineaa as nro_linea,fp.cod_proda as cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
                 lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion, sum(fp.cant_prod) as cant_prod,p.ubicacion,f.nom_cli,f.ruc "
                 lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
                 lstrSQL = lstrSQL & " INNER JOIN faccmp f "
                 lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
                 lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
                 lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
                 lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
                 lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
                 lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc "
                 lstrSQL = lstrSQL & " INNER JOIN productos p "
                 lstrSQL = lstrSQL & " ON p.cod_prod = fl.cod_prod "
                 lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
                 lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
                 lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
                 lstrSQL = lstrSQL & " AND   f.autorizado = 'S' AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
                 lstrSQL = lstrSQL & " GROUP BY fl.precio, f.dto_global, fp.cod_doca, fp.nro_doca, fp.nro_lineaa, fp.cod_proda, fl.descuento1, fl.descuento2, fl.descuento3, "
                 lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, p.ubicacion, f.nom_cli,f.ruc "
                 lstrSQL = lstrSQL & " HAVING sum(fp.cant_prod) <> 0 "
                 'lstrSQL = lstrSQL & " ORDER BY fp.nro_lineaa, fp.cod_proda"
            Else
                 lstrSQL = "SELECT fl.precio,f.dto_global,fp.cod_doca, fp.nro_doca,fp.nro_lineaa as nro_linea,fp.cod_proda as cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
                 
                 'AIR 20250205 correccion en la query estaban mal la tabla utilizada para el SUM
                 'lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion, sum(fl.cant_prod*(fp.cant_prod/abs(fp.cant_prod))) as cant_prod,p.ubicacion,f.nom_cli,f.ruc "
                 lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, 1 as cajas, 0 as seccion,"
                 lstrSQL = lstrSQL & " sum(rfl.cant_prod_magnitud*(fp.cant_prod/abs(fp.cant_prod)))  as cant_prod"
                 
                 lstrSQL = lstrSQL & " ,p.ubicacion,f.nom_cli,f.ruc "
                 lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
                 
                 lstrSQL = lstrSQL & " INNER JOIN faccmp f "
                 lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
                 lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
                 lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
                 lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
                 
                 'AIR 20250205 correccion en la query estaban mal la tabla utilizada para el SUM, se agrega esta tabla
                 lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Datos rfl  ON  fp.cod_emp=rfl.cod_emp AND fp.cod_doc=rfl.cod_doc AND fp.nro_doc=rfl.nro_doc AND fp.cod_prov=fp.cod_prov"
                 lstrSQL = lstrSQL & " AND fp.cod_prov=rfl.cod_prov AND fp.nro_linea=rfl.nro_linea"
    
                 lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
                 lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc "
                 lstrSQL = lstrSQL & " INNER JOIN productos p "
                 lstrSQL = lstrSQL & " ON p.cod_prod = fl.cod_prod "
                 
                 lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
                 lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
                 lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
                 lstrSQL = lstrSQL & " AND   f.autorizado = 'S' "
                 lstrSQL = lstrSQL & " AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
                 lstrSQL = lstrSQL & " AND   fp.cant_prod <> 0 "        ' JE 20240819   /   Se agrego esta condicion porque en el SELECT se divide por ese campo y puede venir en 0
                 
                 lstrSQL = lstrSQL & " GROUP BY fl.precio, f.dto_global, fp.cod_doca, fp.nro_doca, fp.nro_lineaa, fp.cod_proda, fl.descuento1, fl.descuento2, fl.descuento3, "
                 lstrSQL = lstrSQL & " p.cod_art_proveedor, fl.tipo_entrega, f.forma_pago, p.ubicacion, f.nom_cli,f.ruc "
                 
                 'AIR 20250205 correccion en la query estaban mal la tabla utilizada para el SUM,
                 'lstrSQL = lstrSQL & " HAVING sum(fl.cant_prod*(fp.cant_prod/abs(fp.cant_prod))) > 0 "
                 lstrSQL = lstrSQL & " HAVING sum (rfl.cant_prod_magnitud * (FP.cant_prod / Abs(FP.cant_prod))) > 0"
            
            End If
            
        
            'AIR 20201029 Rabufer quiere ordenar por la ubicacion los productos en la factura
            If ConfFormato_Factura = "RABUFER" Then
                 lstrSQL = lstrSQL & " ORDER BY p.ubicacion, fp.nro_lineaa, fp.cod_proda"
            Else
                lstrSQL = lstrSQL & " ORDER BY fp.nro_lineaa, fp.cod_proda"
            End If
            
    '        'Paso el nombre de la tabla global a una variable local del formulario
            lstrNombre_Tabla_Temporal = gNombre_Tabla_Temporal
    
            'Muestro en la grilla
            MousePointer = 11
            lCont = vsfLineas_Mercaderia.Rows
            
            If lCont > glngCantLinMaxima Then 'ConfCantidad_Maxima_Lineas_Facturador Then
                MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
                lstrNombre_Tabla_Temporal = ""
                MousePointer = 1
                cmdGuardar.Enabled = True
                Exit Sub
            End If
            
            'Cargo datos para el cabezal
            Set rstlineas_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            
            If Not rstlineas_documentos.EOF Then
                txtDtoGlobal.text = Format(rstlineas_documentos!dto_global, "0.00")
                If Buscar_Cliente(CLng(txtCodProv.text), R) Then
                     If Trim(UCase(R!generico)) = "S" Then
                         Me.txtNomCli.text = rstlineas_documentos!nom_cli
                     End If
                End If
                
                     
                
                
                
                ' AIR 20200603 se agrega la condicion de que si la forma de pago que viene en el doc original es 0 no le pase por arriba a la definida en el documento a generar
                If val(txtForma_Pago.text) = 0 Or NullToZero(rstlineas_documentos!forma_pago <> 0) Then
                    txtForma_Pago.text = rstlineas_documentos!forma_pago            'Se pasa la forma de pago del doc original  SS 20160419
                    If Buscar_Forma_Pago(txtForma_Pago.text, lrstFormasPago) Then
                        txtDes_Forma_Pago.text = lrstFormasPago!Descripcion
                        txtFec_Vencimiento.text = CDate(txtFec_Doc.text) + lrstFormasPago!dias_a_sumar
                        txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                    End If
            
                End If
            End If
            
            If confPuntoVta_Actualiza_Datos_Cliente_F10 Then
                lstrNomCli = ""
                lstrRuc = ""
                pbooModificado = False
                If Not (rstlineas_documentos.EOF And rstlineas_documentos.BOF) Then
                     Do While Not rstlineas_documentos.EOF
                         If Trim(lstrNomCli) <> Trim(rstlineas_documentos!nom_cli) Or Trim(lstrRuc) <> Trim(rstlineas_documentos!ruc) Then
                             If Not pbooModificado Then
                                 lstrNomCli = Trim(rstlineas_documentos!nom_cli)
                                 lstrRuc = Trim(rstlineas_documentos!ruc)
                                 pbooModificado = True
                             Else
                                 pbooModificado = False
                                 Exit Do
                             End If
                         End If
                         rstlineas_documentos.MoveNext
                    Loop
                    If pbooModificado Then
                        Me.txtNomCli.text = lstrNomCli
                        Me.TxtRuc.text = lstrRuc
                        Me.txtTipo_Doc_Identidad.text = f_Tipo_documento_DGI(lstrRuc)
                    End If
                    rstlineas_documentos.MoveFirst
                End If
            End If
            
            'Cargo datos para las lineas
            Do While Not rstlineas_documentos.EOF
                
                'Log para identificar si un articulo es llamado y no es cargado.
                Call Cargo_Logtrans("ALTA LINEA DESDE PENDIENTE: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!Cod_Prod & " CANT : " & rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod)
            
                TxtFactor.text = rstlineas_documentos!cajas * rstlineas_documentos!Cant_Prod    'muestra los saldos de los pendientes
               
                If val(TxtFactor.text) <> 0 Then
                    gbln_Articulo_de_F10 = True
                    lCantidad = rstlineas_documentos!Cant_Prod
                    lPrecio = rstlineas_documentos!Precio
                    lMagnitud = -1
                    If Buscar_Datos_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, MD) Then
                    End If
                    
                    If confUsaEquivalenciaMagnitudes Then
                        If Not (MD.EOF And MD.BOF) Then
                           If Buscar_Linea_Documento(val(Me.txtEmpresa.text), rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, ML) Then
                        '       If ML!Cant_Prod = rstlineas_documentos!Cant_Prod Then
                        '           lCantidad = MD!cant_prod_magnitud
                        '       Else
                        '           lCantidad = lCantidad * MD!cant_prod_magnitud / ML!Cant_Prod
                        '       End If
                               lPrecio = MD!precio_magnitud
                               lMagnitud = MD!magnitud
                               TxtFactor.text = rstlineas_documentos!cajas * lCantidad   'muestra los saldos de los pendientes
                           End If
                        End If
                    End If
                    
                    
                    If Not Proceso_Codigo(rstlineas_documentos!Cod_Prod, rstlineas_documentos!descuento1, rstlineas_documentos!descuento2, rstlineas_documentos!descuento3, lPrecio, rstlineas_documentos!tipo_entrega, IIf(MD.BOF And MD.EOF, txtDeposito.text, MD!Deposito), True, "", False, rstlineas_documentos!cod_doca, 0, lCod_Prov, 0, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, rstlineas_documentos!nro_linea, lCantidad, ldblCantidadEntregada, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, lMagnitud) Then
                        MsgBox "Error en el Codigo " & rstlineas_documentos!Cod_Prod, vbCritical, MsgTit
                        
                        'AIR 20190909
                        gbln_Articulo_de_F10 = False
                        If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                            gbln_Cargo_Datos_Desde_F10 = True
                        End If
                        If lblnCancelar Then
                            Exit Do
                        End If
                    End If
                    gbln_Articulo_de_F10 = False
                    ' JE 20180629   /   Cargo Coleccion de Serie por si fueron ingresadas en el Pedido
                    If Buscar_Serie_Articulo_Linea_Documento(lcod_emp, rstlineas_documentos!cod_doca, rstlineas_documentos!nro_doca, lCod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!Cod_Prod, SE) Then
                    
                        While Not SE.EOF
                    
                            lstrClave_Colecccion_Series = Trim(str(SE!nro_linea)) & "-" & Trim(str(SE!Cod_Prod)) & "-" & Trim(SE!serie)
                            gcolSeries_Articulos.Add SE!nro_linea, SE!Cod_Prod, Trim(SE!serie), Trim(SE!serie_sin_control_compra), Trim(lstrClave_Colecccion_Series)
                
                            SE.MoveNext
                        Wend
                            
                    End If
                    
                    'AIR 20190909
                    lbln_Cargo_Datos_Desde_F10_local = True
                    
                    lCont = lCont + 1
                    If lCont > glngCantLinMaxima Then 'ConfCantidad_Maxima_Lineas_Facturador Then
                        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
                        
                        lstrNombre_Tabla_Temporal = ""
                        'AIR 20190909
                        If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
                            gbln_Cargo_Datos_Desde_F10 = lbln_Cargo_Datos_Desde_F10_local
                        End If
                        vsfLineas_Mercaderia.RemoveItem vsfLineas_Mercaderia.Rows - 1
                        MousePointer = 1
                        cmdGuardar.Enabled = True
                        Exit Do
                    End If
                End If
                
                rstlineas_documentos.MoveNext
            Loop
            
            'Cargo la observaciones de los doc originales elegidos      SS 20180202
            If ConfPuntoVta_Trae_Observacion_Cabezal_Documento_Origen Then   'segun parametro    SS 20190227
            
                lstrSQL = "SELECT fp.cod_doca, fp.nro_doca, f.observa"
                lstrSQL = lstrSQL & " FROM  FaccmpLineas fl "
                lstrSQL = lstrSQL & " INNER JOIN faccmp f "
                lstrSQL = lstrSQL & " ON  f.cod_emp=fl.cod_emp AND f.cod_doc=fl.cod_doc AND f.nro_doc=fl.nro_doc AND f.cod_prov=fl.cod_prov "
                lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas_Pendientes fp "
                lstrSQL = lstrSQL & " ON  fp.cod_emp=fl.cod_emp AND fp.cod_doca=fl.cod_doc AND fp.nro_doca=fl.nro_doc AND fp.cod_prova=fl.cod_prov AND fp.nro_lineaa=fl.nro_linea AND fp.cod_proda=fl.cod_prod "
                lstrSQL = lstrSQL & " INNER JOIN faccmp ref  ON  ref.cod_emp=fp.cod_emp AND ref.cod_doc=fp.cod_doc AND ref.nro_doc=fp.nro_doc AND ref.cod_prov=fp.cod_prov "
                lstrSQL = lstrSQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
                lstrSQL = lstrSQL & " ON  g.cod_doc = fl.cod_doc AND g.nro_doc= fl.nro_doc "
                lstrSQL = lstrSQL & " WHERE fl.cod_emp = " & lcod_emp
                lstrSQL = lstrSQL & " AND   fl.Cod_Prov =" & lCod_Prov
                lstrSQL = lstrSQL & " AND   ltrim(rtrim(convert(char(20),REPLACE(STR(fp.cod_doc),' ', '') + REPLACE(STR(fp.nro_doc), ' ', '')))) <> '" & Trim(lstrDocActual) & "'"
                lstrSQL = lstrSQL & " AND   f.autorizado = 'S' AND   ref.autorizado = 'S'  "    'control de todos los documentos que participan NO anulados     SS 20180126
                lstrSQL = lstrSQL & " GROUP BY fp.cod_doca, fp.nro_doca, f.observa "
                lstrSQL = lstrSQL & " HAVING sum(fp.cant_prod) <> 0 "
                lstrSQL = lstrSQL & " ORDER BY fp.cod_doca, fp.nro_doca"
                
                txtObs.text = ""
                
                Set lrstObserv_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                Do Until lrstObserv_documentos.EOF
                    If txtObs.text = "" Then            'Este campo tiene definido MaxLength de 100
                        txtObs.text = Trim(lrstObserv_documentos!observa)
                    Else
                        txtObs.text = txtObs.text & " / " & Trim(lrstObserv_documentos!observa)
                    End If
                    
                    lrstObserv_documentos.MoveNext
                Loop
                lrstObserv_documentos.Close
            End If
            
            ' Cargo las observaciones extendidas de los doc originales elegidos
            If ConfPuntoVta_Trae_Observacion_Extendida_Documento_Origen Then   'segun parametro    SS 20190227
            
                lstrSQL = "DELETE FROM Faccmp_Observaciones "
                lstrSQL = lstrSQL & " WHERE cod_emp = " & lcod_emp & " AND cod_doc = " & lCod_Doc
                lstrSQL = lstrSQL & " AND   nro_doc = " & lNro_Doc & " AND cod_prov = " & lCod_Prov
                Dbs.Execute lstrSQL
                
                llngLinea = 0
                    
                lstrSQL = "SELECT fec_reg, linea, observacion FROM Faccmp_Observaciones, " & lstrNombre_Tabla_Temporal & " REMITO"
                lstrSQL = lstrSQL & " WHERE Faccmp_Observaciones.cod_emp = " & lcod_emp
                lstrSQL = lstrSQL & " AND Faccmp_Observaciones.cod_doc = REMITO.cod_doc"
                lstrSQL = lstrSQL & " AND Faccmp_Observaciones.nro_doc = REMITO.nro_doc"
                lstrSQL = lstrSQL & " AND Faccmp_Observaciones.cod_prov = " & lCod_Prov
                lstrSQL = lstrSQL & " ORDER BY  Faccmp_Observaciones.cod_doc, Faccmp_Observaciones.nro_doc, Faccmp_Observaciones.linea"
                
                Set rstObserva = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                Do Until rstObserva.EOF
                
                    ' Numero por si se trae más de 1 documento con observaciones    SS 20190227
                    llngLinea = llngLinea + 1
                    
                    lstrSQL = "INSERT INTO Faccmp_Observaciones "
                    lstrSQL = lstrSQL & " VALUES ("
                    lstrSQL = lstrSQL & lcod_emp & ","                                          ' cod_emp
                    lstrSQL = lstrSQL & lCod_Doc & ","                                          ' cod_doc
                    lstrSQL = lstrSQL & lNro_Doc & ","                                          ' nro_doc
                    lstrSQL = lstrSQL & lCod_Prov & ","                                         ' cod_prov
                    lstrSQL = lstrSQL & f_Fecha_Base(rstObserva!fec_reg, Conf_Motor_Base) & "," ' fec_reg
                    'lstrSQL = lstrSQL & rstObserva!linea & ",'"                                ' linea
                    lstrSQL = lstrSQL & llngLinea & ",'"                                        ' linea
                    lstrSQL = lstrSQL & f_Ins_String(Trim(rstObserva!observacion)) & "','"      ' observacion
                    lstrSQL = lstrSQL & Trim(UCase(gUsuario)) & "')"                            ' usuario
                
                    Dbs.Execute lstrSQL
                
                    rstObserva.MoveNext
                Loop
                rstObserva.Close
                
                Call Ajustar_Boton_Observaciones_Extras(str(lcod_emp), str(lCod_Doc), str(lNro_Doc), str(lCod_Prov), sscObservacion_Extra)
            End If
        End If
    
    End If
    
    'AIR 20190909
    If gbln_Cargo_Datos_Desde_F10 = False And lbln_Cargo_Datos_Desde_F10_local = True Then
        gbln_Cargo_Datos_Desde_F10 = True
    End If

    TxtFactor.text = ""
    MousePointer = 1
    cmdGuardar.Enabled = True
    
End Sub




Sub Cargar_Desde_Ficha_Viaje(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long, lMoneda As Long)
Dim lCont As Integer
Dim lstrAfecta_Stock As String
Dim lstrDocActual As String

lstrDocActual = Trim(str(lCod_Doc)) & Trim(str(lNro_Doc))   ' se usa para las modificaciones, para excluir en la SELECT el documento que se esta modificando

gNombre_Tabla_Temporal = ""
lNombre_Tabla_Temporal = ""
lstrAfecta_Stock = "N"

cmdGuardar.Enabled = False
Call Busqueda_Fichas_Viaje_a_Afectar(lcod_emp, lCod_Prov, lCod_Doc, lNro_Doc, 1, lstrAfecta_Stock, "FICHAS_VIAJE", lMoneda)

If Trim(gNombre_Tabla_Temporal) = "" Then
    Exit Sub    'Salimos porque no hay documentos seleccionados
Else
    SQL = "SELECT F.numero, F.linea, F.cod_servicio, F.servicio, ma_Insumos_Servicios.cod_iva, F.importe FROM ma_Fichas_Viaje_Doc_Clientes F "
    SQL = SQL & " INNER JOIN ma_Insumos_Servicios ON ma_Insumos_Servicios.codigo = F.cod_servicio "
    SQL = SQL & " INNER JOIN " & gNombre_Tabla_Temporal & " g "
    SQL = SQL & " ON  g.nro_doc = F.numero AND g.cod_doc = F.linea "
    SQL = SQL & " WHERE F.Cod_Emp = " & val(txtEmpresa.text)
    
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If

'Cargo en la grilla

Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

'dbgLineas_Servicios.visible = False
cmdGuardar.Enabled = False
MousePointer = 11
lCont = 1

dbgLineas_Servicios.visible = False
dbgLineas_Servicios.removeAll
dbgLineas_Servicios.MoveFirst

Do While Not rstlineas_documentos.EOF
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DESDE PENDIENTE: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " SERVICIO : " & rstlineas_documentos!cod_servicio & " PRECIO : " & rstlineas_documentos!Importe)

    dbgLineas_Servicios.Columns("unidades").text = 1
    dbgLineas_Servicios.Columns("codigo").text = rstlineas_documentos!cod_servicio
    dbgLineas_Servicios.Columns("descripcion").text = rstlineas_documentos!Servicio
    
    dbgLineas_Servicios.Columns("seccion").text = 0
    If Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
        dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
    End If
    
    dbgLineas_Servicios.Columns("tcofis").text = 0
    dbgLineas_Servicios.Columns("cofis").text = 0
    
    dbgLineas_Servicios.Columns("tiva").text = rstlineas_documentos!cod_iva
    dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
    
    dbgLineas_Servicios.Columns("tcofis_iva").text = 0
    dbgLineas_Servicios.Columns("cofis_iva").text = 0
    
    dbgLineas_Servicios.Columns("precio").text = Format(rstlineas_documentos!Importe, "0.00")
    dbgLineas_Servicios.Columns("precio_siva").text = "0"
    
    dbgLineas_Servicios.Columns("eliminada").Value = False
    dbgLineas_Servicios.Columns("ficha_viaje").text = rstlineas_documentos!numero
    dbgLineas_Servicios.Columns("ficha_viaje_linea").text = rstlineas_documentos!linea
    
    Call Calcular_Importes_de_la_Linea_Servicios(True, "", False)
    
    dbgLineas_Servicios.MoveNext
      
    rstlineas_documentos.MoveNext
    lCont = lCont + 1
Loop

dbgLineas_Servicios.visible = True
dbgLineas_Servicios.Enabled = True
dbgLineas_Servicios.SetFocus
dbgLineas_Servicios.Col = 0

MousePointer = 1
cmdGuardar.Enabled = True

End Sub
Sub Cargar_Documentos_Mercaderia_para_Resguardo(pcod_Emp As Long, pCod_Doc As Long, pNro_Doc As Long, pCod_Prov As Long, pMoneda As Long)

'AIR 20200827
Dim lrstServicio As Recordset

Dim rstlineas_documentos As Recordset
Dim D As Recordset
Dim lstrDocActual As String
Dim llngServicio As Long
Dim llngSeccion As Long
Dim ldblImporte As Double
Dim lstrTextoAuxiliar As String   ' AIR 20200831
Dim llngLinea As Long             ' AIR 20221121

lstrDocActual = Trim(str(pCod_Doc)) & Trim(str(pNro_Doc))   ' se usa para las modificaciones, para excluir en la SELECT el documento que se esta modificando

gNombre_Tabla_Temporal = ""
lNombre_Tabla_Temporal = ""

cmdGuardar.Enabled = False
Call Busqueda_Documentos_a_Afectar(pcod_Emp, pCod_Prov, "F", "", 0, "DOCUMENTOS_PARA_RESGUARDO", pMoneda)

If Trim(gNombre_Tabla_Temporal) = "" Then
    Exit Sub    'Salimos porque no hay documentos seleccionados
Else
    SQL = "SELECT I.cod_emp, g.cod_doc,g.nro_doc, I.cod_prov, I.cod_impuesto, sum(I.importe) AS importe, D.signo, ISNULL(M.porcentaje_retencion_dgi, 0)  as porcentaje_retencion_dgi "
    SQL = SQL & " FROM " & gNombre_Tabla_Temporal & " g "
    SQL = SQL & ", FACCMPIMPUESTOS I , documentos D, IMPUESTOS S "
    SQL = SQL & " LEFT JOIN ma_insumos_servicios M ON "
        SQL = SQL & " S.codigo_insumo = M.codigo "
        SQL = SQL & " AND S.codigo_insumo <> 0  "

    SQL = SQL & " WHERE I.Cod_Emp = " & val(txtEmpresa.text)
    SQL = SQL & " AND I.cod_prov = " & val(txtCodProv.text)
    SQL = SQL & " AND D.cod_doc = I.cod_doc "
    SQL = SQL & " AND g.cod_doc = I.cod_doc "
    SQL = SQL & " AND g.nro_doc = I.nro_doc "
    SQL = SQL & " AND I.cod_tipo_impuesto = 'IVA' "
    SQL = SQL & " AND I.cod_tipo_impuesto = S.cod_tipo_impuesto"
    SQL = SQL & " AND I.cod_impuesto = S.cod_impuesto "
    
    SQL = SQL & " GROUP BY I.cod_emp, g.cod_doc, D.signo, g.nro_doc, I.cod_prov, I.cod_impuesto, M.porcentaje_retencion_dgi"

    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If

Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

llngSeccion = 0
llngServicio = 0

If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
    llngServicio = NullToZero(D!servicio_x_defecto)
    If Busco_Insumo_Servicio(D!servicio_x_defecto, lrstServicio) Then
        llngSeccion = NullToZero(lrstServicio!seccion_x_defecto_facturar)
    End If
End If

cmdGuardar.Enabled = False
MousePointer = 11

Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(val(txtEmpresa.text), val(txtCodDoc.text), txtDoc.text, txtCodProv.text)

'Cargo en la grilla
llngLinea = 0
dbgLineas_Servicios.visible = False
dbgLineas_Servicios.removeAll
dbgLineas_Servicios.MoveFirst

Do While Not rstlineas_documentos.EOF
    'Log para identificar si un articulo es llamado y no es cargado.
    Call Cargo_Logtrans("ALTA LINEA DOCUMENTO RESGUARDO: " & txtCodDoc.text & " NUM : " & txtDoc.text & " PROV : " & txtCodProv.text & " SERVICIO : " & llngServicio & " PRECIO : " & rstlineas_documentos!Importe)
    
    'AIR 20221121 no se realizan retenciones sobre la tasa del 10%
    If NullToZero(rstlineas_documentos!porcentaje_retencion_dgi) <> 0 Or (NullToZero(rstlineas_documentos!porcentaje_retencion_dgi) = 0 And rstlineas_documentos!cod_impuesto = 3) Then
        dbgLineas_Servicios.Columns("unidades").text = 1
        dbgLineas_Servicios.Columns("codigo").text = llngServicio
        dbgLineas_Servicios.Columns("descripcion").text = lrstServicio!Descripcion
        
        dbgLineas_Servicios.Columns("seccion").text = llngSeccion
        If Busco_Seccion(llngSeccion) Then
            dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
        End If
        
        dbgLineas_Servicios.Columns("tcofis").text = 0
        dbgLineas_Servicios.Columns("cofis").text = 0
        
        dbgLineas_Servicios.Columns("tiva").text = lrstServicio!cod_iva
        dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
        
        dbgLineas_Servicios.Columns("tcofis_iva").text = 0
        dbgLineas_Servicios.Columns("cofis_iva").text = 0
        ldblImporte = (rstlineas_documentos!Importe * rstlineas_documentos!signo)
        
        dbgLineas_Servicios.Columns("precio").text = Format(ldblImporte, "0.00")
        dbgLineas_Servicios.Columns("precio_siva").text = Format(ldblImporte, "0.00")
        
        dbgLineas_Servicios.Columns("eliminada").Value = False
        
        'AIR 20200902
        If NullToZero(rstlineas_documentos!porcentaje_retencion_dgi) <> 0 Then
            dbgLineas_Servicios.Columns("tasa_resguardo").text = NullToZero(rstlineas_documentos!porcentaje_retencion_dgi)
        Else
            dbgLineas_Servicios.Columns("tasa_resguardo").text = 0
        End If
        
        ' AIR 20200828 guardar el codigo de tipo de documento y numero de facturas/n.credito levantadas
        dbgLineas_Servicios.Columns("nro_doc").text = rstlineas_documentos!nro_doc
        dbgLineas_Servicios.Columns("cod_doc").text = rstlineas_documentos!cod_doc
        llngLinea = llngLinea + 1
        'AIR 20200828 crea las lineas auxiliares para ser utilizadas en los reglones del documento electronico
        If Trim(dbgLineas_Servicios.Columns("unidades").text) <> "" And Not dbgLineas_Servicios.Columns("eliminada").Value Then
            'AIR 20200831
            If rstlineas_documentos!signo = 1 Then
                lstrTextoAuxiliar = "Factura: " & str(rstlineas_documentos!nro_doc)
            Else
                lstrTextoAuxiliar = "N.Devolución: " & str(rstlineas_documentos!nro_doc)
            End If
            
            ' AIR 20221121 no funciona tomar la row de la grilla porque solo aumenta hasta la cantidad de filas que se estan mostrando en pantalla, por lo cual solo contaba hasta 10 y las demas lineas no quedaban registradas en la tabla temporal
            'Call Ingreso_Datos_Auxiliares_del_Resguardo(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text, (dbgLineas_Servicios.Row + 1), lstrTextoAuxiliar, lNombre_Tabla_Lineas_Auxiliar_Temporal)
            Call Ingreso_Datos_Auxiliares_del_Resguardo(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, llngLinea, lstrTextoAuxiliar, lNombre_Tabla_Lineas_Auxiliar_Temporal)
        
        End If
        
        Call Calcular_Importes_de_la_Linea_Servicios(True, "N", True)
    End If
    
    dbgLineas_Servicios.MoveNext
    rstlineas_documentos.MoveNext
 
Loop

dbgLineas_Servicios.visible = True
dbgLineas_Servicios.Enabled = True
dbgLineas_Servicios.SetFocus
dbgLineas_Servicios.Col = 0

MousePointer = 1
cmdGuardar.Enabled = True


End Sub
Sub Cargar_Desde_WIS(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long)
Dim lrstCabezalPedido As Recordset
Dim lrstCabezalPedidoWEB As Recordset
Dim lrstCabAuxPedidoWEB As Recordset
Dim lrstLineasPedidoWEB As Recordset
Dim lrstDocumento As Recordset 'AIR 20230301

Dim lbolPedidoWEB As Boolean
Dim lCont As Integer
Dim sqlNombre_Archivo As String
Dim lblnCancelar As Boolean
Dim llngNroPedido As Long
Dim lblnPedidoFactura As Boolean    'AIR 20230301
Dim lintposicion As Integer         'AIR 20240820

gNombre_Tabla_Temporal = ""
lblnCancelar = False

Call Busqueda_Documentos_WIS_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", -1, "WIS_FACTURACIONES", txtMoneda.text)
cmdGuardar.Enabled = False
If Trim(gNombre_Tabla_Temporal) = "" Then
    Exit Sub
    'Salimos porque no hay pedido seleccionado
Else
    'Trabajo las Lineas directamente porque hay varios cabezales
    '###################
    
    sqlNombre_Archvio = ""
    If gCodigo_Empresa = 9 Then
        sqlNombre_Archivo = " AND w.nombre_archivo LIKE '%.PED%'"
    End If
    If gCodigo_Empresa = 10 Then
        sqlNombre_Archivo = " AND w.nombre_archivo LIKE '%.CPD%'"
    End If
    
    'AIR 20230526 se agrega que no levante las lineas del pedido ya facturadas
'    SQL = "Select w.* From wis_facturaciones w," & gNombre_Tabla_Temporal & _
'            " g  Where g.nro_doc = w.nro_pedido and g.camion = w.camion " & sqlNombre_Archivo & " order by w.nro_linea"

    SQL = "Select w.* From wis_facturaciones w," & gNombre_Tabla_Temporal & _
            " g  Where g.nro_doc = w.nro_pedido and g.camion = w.camion "
    SQL = SQL & " and w.cod_doca = 0 And w.nro_doca = 0 And w.cod_prova = 0"
    SQL = SQL & " and w.fec_procesado = g.fec_doc"
    SQL = SQL & sqlNombre_Archivo
    SQL = SQL & " order by w.nro_linea"
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
End If


MousePointer = 11
lCont = vsfLineas_Mercaderia.Rows

If lCont > llngMaximo_Lineas Then
    MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End If

Set rstlineas_documentos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not rstlineas_documentos.EOF Then

    nro_doc_Wis = rstlineas_documentos!nro_pedido
    camion_Wis = rstlineas_documentos!camion
    
    'Se asume que los registros con origen W, son ingresados en WIS                     SS 20191126
    If rstlineas_documentos!origen = "W" Then
        lbolPedidoWEB = False
    Else
        
        'AIR 20240820 se modifica porque llegaron pedidos con 3 digitos
        
        'Los pedidos que vienen con guion bajo, se les saca el guion y el ultimo digito
        'ATU 20200428, se agrega manejo de 2 digitos en el sufijo.
'        If Len(Trim(rstlineas_documentos!nro_pedido)) > 8 Then
'            llngNroPedido = IIf(Not IsNumeric(rstlineas_documentos!nro_pedido), Mid(getNumeric(rstlineas_documentos!nro_pedido), 1, Len(getNumeric(rstlineas_documentos!nro_pedido)) - 2), rstlineas_documentos!nro_pedido)
'        Else
'            llngNroPedido = IIf(Not IsNumeric(rstlineas_documentos!nro_pedido), Mid(getNumeric(rstlineas_documentos!nro_pedido), 1, Len(getNumeric(rstlineas_documentos!nro_pedido)) - 1), rstlineas_documentos!nro_pedido)
'        End If
'
        
        'AIR 20240820 se modifica porque llegaron pedidos con 3 digitos en el subfijo
        lintposicion = InStr(rstlineas_documentos!nro_pedido, "_")
        If lintposicion = 0 Then
            llngNroPedido = rstlineas_documentos!nro_pedido
        Else
            llngNroPedido = IIf(Not IsNumeric(rstlineas_documentos!nro_pedido), Mid((rstlineas_documentos!nro_pedido), 1, lintposicion - 1), rstlineas_documentos!nro_pedido)
        End If
        
        If llngNroPedido >= 1000000 Then    'mayor a 1 millon, es un Pedido 304 WEB     SS 20191126
            lbolPedidoWEB = True
        Else
            lbolPedidoWEB = False
        End If
    End If
    
    
    txtDtoGlobal.text = Format(0, "0.00")
    
    If lbolPedidoWEB = True Then
        
        If Buscar_Documento(val(txtEmpresa.text), ConfDoc_Ingreso_Pedido_Cli_Web, llngNroPedido, rstlineas_documentos!Cod_Prov, lrstCabezalPedidoWEB) Then
        
            'Cargamos los datos del pedido 304 original
            If Buscar_Documento_Cabezal_Auxiliar(val(txtEmpresa.text), ConfDoc_Ingreso_Pedido_Cli_Web, llngNroPedido, rstlineas_documentos!Cod_Prov, lrstCabAuxPedidoWEB) Then
            
                'AIR 20230301
                If Buscar_Tipo_Documento(ConfDoc_Ingreso_Pedido_Cli_Web, lrstDocumento) Then
                End If
            
                txtNomCli.text = lrstCabezalPedidoWEB!nom_cli
                txtTipo_Doc_Identidad.text = lrstCabAuxPedidoWEB!tipo_doc_identidad
                glngTipo_Documento_Identidad = lrstCabAuxPedidoWEB!tipo_doc_identidad
                TxtRuc.text = lrstCabezalPedidoWEB!ruc
                txtDtoGlobal.text = Format(lrstCabezalPedidoWEB!dto_global, "0.00")
                txtLista.text = lrstCabezalPedidoWEB!nro_rollo
                txtObs.text = lrstCabezalPedidoWEB!observa
                gbolCargo_Desde_WIS = True  'Bloqueamos el ingreso
                
                If Not Cargo_Grilla_Medios_Pago_PedidoWEB(val(txtEmpresa.text), ConfDoc_Ingreso_Pedido_Cli_Web, llngNroPedido) Then
                    MsgBox "Error al cargar los medios de pago del Pedido WEB " & ConfDoc_Ingreso_Pedido_Cli_Web & "/" & llngNroPedido & " Se Cancela la Carga", vbExclamation, MsgTit
                    Call Inicializo_Grilla_Lineas_Medios_Pago
                    MousePointer = 1
                    cmdGuardar.Enabled = True
                    Exit Sub
                End If
                
                SQL = "SELECT * FROM FaccmpLineas "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND   cod_doc = " & ConfDoc_Ingreso_Pedido_Cli_Web
                SQL = SQL & " AND   nro_doc = " & llngNroPedido
                SQL = SQL & " AND   cod_prov = " & rstlineas_documentos!Cod_Prov
                
                Set lrstLineasPedidoWEB = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                Do While Not lrstLineasPedidoWEB.EOF
                    
                    Call Cargo_Logtrans("ALTA LINEA PEDIDO WEB DESDE WIS: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & lrstLineasPedidoWEB!Cod_Prod & " CANT : " & lrstLineasPedidoWEB!Cant_Prod)
                
                    TxtFactor.text = lrstLineasPedidoWEB!Cant_Prod
                    
                    'AIR 20230301 se cambia la condicion para que ser respete el precio que viene desde la web si asi esta configurado el documento EL CLON
                    lblnPedidoFactura = False
                    If Trim(lrstDocumento!tipo_precio) = "M" Then
                        lblnPedidoFactura = True
                    End If
                    
                    'If Not Proceso_Codigo(lrstLineasPedidoWEB!Cod_Prod, 0, 0, 0, lrstLineasPedidoWEB!Precio, 0, "", False, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar) Then
                    If Not Proceso_Codigo(lrstLineasPedidoWEB!Cod_Prod, 0, 0, 0, lrstLineasPedidoWEB!Precio, 0, "", lblnPedidoFactura, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                        MsgBox "Error en el Codigo " & lrstLineasPedidoWEB!Cant_Prod, vbCritical, MsgTit
                        Call Inicializo_Grilla_Lineas_Medios_Pago
                        MousePointer = 1
                        cmdGuardar.Enabled = True
                        Exit Sub
                    End If
                    lrstLineasPedidoWEB.MoveNext
                    
                    lCont = lCont + 1
                    If lCont > llngMaximo_Lineas Then
                        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & " Se Cancela la Carga", vbExclamation, MsgTit
                        Call Inicializo_Grilla_Lineas_Medios_Pago
                        MousePointer = 1
                        cmdGuardar.Enabled = True
                        Exit Sub
                    End If
                Loop
                
            Else
                MsgBox "El Pedido WEB seleccionado no encuentra el Cabezal Auxiliar del PEDIDO " & ConfDoc_Ingreso_Pedido_Cli_Web & "/" & llngNroPedido & " Se Cancela la Carga", vbExclamation, MsgTit
                MousePointer = 1
                cmdGuardar.Enabled = True
                Exit Sub
            End If
        Else
            MsgBox "El Pedido WEB seleccionado no encuentra el Cabezal del PEDIDO " & ConfDoc_Ingreso_Pedido_Cli_Web & "/" & llngNroPedido & " Se Cancela la Carga", vbExclamation, MsgTit
            MousePointer = 1
            cmdGuardar.Enabled = True
            Exit Sub
        End If
    Else
        
        If rstlineas_documentos!origen <> "W" Then  'Los pedidos ingresados en WIS no traen el descuento
            'Buscamos para traer el descuento
            If Buscar_Documento(9, ConfDoc_Ingreso_Pedido_Cli, IIf(Not IsNumeric(rstlineas_documentos!nro_pedido), Mid(getNumeric(rstlineas_documentos!nro_pedido), 1, Len(getNumeric(rstlineas_documentos!nro_pedido)) - 1), rstlineas_documentos!nro_pedido), rstlineas_documentos!Cod_Prov, lrstCabezalPedido) Then
                txtDtoGlobal.text = Format(lrstCabezalPedido!dto_global, "0.00")
                'ATU cargamos la lista del pedido y bloqueamos el ingreso.
                txtLista.text = lrstCabezalPedido!nro_rollo
                gbolCargo_Desde_WIS = True
            End If
        End If
        
        Do While Not rstlineas_documentos.EOF
            'Log para identificar si un articulo es llamado y no es cargado.
            Call Cargo_Logtrans("ALTA LINEA DESDE WIS: " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lCont & " ART : " & rstlineas_documentos!cod_barra & " CANT : " & rstlineas_documentos!cantidad)
        
            TxtFactor.text = rstlineas_documentos!cantidad
            If Not Proceso_Codigo(val(rstlineas_documentos!cod_barra), 0, 0, 0, 0, 0, "", False, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                MsgBox "Error en el Codigo " & rstlineas_documentos!cod_barra, vbCritical, MsgTit
                'AIR 20190605
                If lblnCancelar Then
                    Exit Do
                End If
            
            End If
            rstlineas_documentos.MoveNext
            lCont = lCont + 1
            If lCont > llngMaximo_Lineas Then
                MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura" & Chr(13) & "Se Cancela la Carga", vbExclamation, MsgTit
                MousePointer = 1
                cmdGuardar.Enabled = True
                Exit Sub
            End If
        Loop
    End If
End If

TxtFactor.text = ""
MousePointer = 1
cmdGuardar.Enabled = True
End Sub

Public Function Cargo_Grilla_Medios_Pago_PedidoWEB(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
On Error GoTo Errores
Dim SQL As String
Dim C As Recordset

    Cargo_Grilla_Medios_Pago_PedidoWEB = False
    
    vsfMedios_Pagos.Rows = 1
    
    SQL = "SELECT FaccmpMpagos.*, Medios_Pago.descripcion, Medios_Pago.tipo_medio_pago, Medios_Pago.tipo_dev_cambio, Monedas.simbolo "
    SQL = SQL & " FROM FaccmpMpagos "
    SQL = SQL & " INNER JOIN Medios_Pago ON Medios_Pago.codigo = FaccmpMpagos.cod_mpago"
    SQL = SQL & " INNER JOIN Monedas ON Monedas.codigo = FaccmpMpagos.moneda"
    SQL = SQL & " WHERE FaccmpMpagos.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND   FaccmpMpagos.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND   FaccmpMpagos.nro_doc = " & plngNro_Doc
    SQL = SQL & " ORDER BY FaccmpMpagos.cod_mpago"
    
    Set C = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not C.EOF
        vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows + 1
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = C!moneda_rec
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = Format(C!importe_digitado, "0.00")
        
        If C!moneda_rec <> C!moneda Or C!moneda_rec <> gMoneda_Base Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(C!Tipo_Cambio_Rec, "###0.000")
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = ""
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MEDIO_PAGO) = C!cod_mpago
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_MPAGO) = Trim(C!tipo_medio_pago)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_DESCRIPCION) = Trim(C!Descripcion)

        If IsNumeric(C!referencia) Then
            If C!referencia <> 0 Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_REFERENCIA) = C!referencia
            End If
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_SIMBOLO) = Trim(C!simbolo)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_DEV_CAMBIO) = Trim(C!tipo_dev_cambio)

        C.MoveNext
    Wend
    C.Close
    
    Cargo_Grilla_Medios_Pago_PedidoWEB = True
    
Exit Function
Errores:
    MsgBox "Error al Cargar los Medios de Pago, Verifique por Favor", vbInformation, MsgTit
End Function



Sub Cargar_Desde_Factura(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lCod_Prov As Long)
Dim lCont As Integer
Dim D As Recordset
Dim L As Recordset
Dim R As Recordset
Dim MP As Recordset
Dim lblnCancelar As Boolean

Dim lstrClase As String
Dim lstrDeposito As String

gNombre_Tabla_Temporal = ""
lblnCancelar = False

If Busco_Tipo_Documento_CRSet(lCod_Doc, D) Then
    lstrClase = Trim(UCase(D!clase))
Else
    lstrClase = "OTROS"
End If

Call Busqueda_Documentos_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", lstrClase, -1, "devoluciones_clientes", 1)

If Trim(gNombre_Tabla_Temporal) = "" Then
    Exit Sub
    'Salimos porque no hay pedido seleccionadp
Else
    
    'Paso el nombre de la tabla global a una variable local del formulario
    lNombre_Tabla_Temporal = gNombre_Tabla_Temporal
    
    
    'Trabajo las Lineas directamente porque hay varios cabezales
    '###################
    
    SQL = "SELECT fl.precio,f.dto_global,fl.nro_linea,fl.cod_prod, fl.descuento1, fl.descuento2, fl.descuento3, "
    SQL = SQL & " p.cod_art_proveedor,fl.tipo_entrega, 1 as cajas, 0 as seccion, sum(fl.cant_prod*fl.cajas) as cant_prod, fa.deposito, ld.deposito as deposito_linea"
    SQL = SQL & " FROM faccmp f "

    ' AIR 20171009 si tiene deposito por linea se debe tomar ese dato
    SQL = SQL & " LEFT JOIN Faccmp_Cabezal_Auxiliar fa ON "
    SQL = SQL & " fa.cod_emp=f.cod_emp"
    SQL = SQL & " AND fa.cod_doc=f.cod_doc"
    SQL = SQL & " AND fa.nro_doc=f.nro_doc"
    SQL = SQL & " AND fa.cod_prov=f.cod_prov, "
    SQL = SQL & " FaccmpLineas fl "
    SQL = SQL & " LEFT JOIN faccmplineas_Datos ld ON "
    SQL = SQL & " ld.cod_emp=fl.cod_emp"
    SQL = SQL & " AND ld.cod_doc=fl.cod_doc"
    SQL = SQL & " AND ld.nro_doc=fl.nro_doc"
    SQL = SQL & " AND ld.cod_prov=fl.cod_prov"
    SQL = SQL & " AND ld.nro_linea=fl.nro_linea, "
    SQL = SQL & lNombre_Tabla_Temporal & " g , productos p "
    SQL = SQL & " WHERE p.cod_prod = fl.cod_prod"
    SQL = SQL & " AND fl.cod_emp = " & lcod_emp
    SQL = SQL & " AND fl.cod_doc = g.cod_doc"
    SQL = SQL & " AND fl.nro_doc=g.nro_doc"
    SQL = SQL & " AND fl.cod_prov=" & lCod_Prov
    SQL = SQL & " AND f.cod_emp=fl.cod_emp"
    SQL = SQL & " AND f.cod_doc=fl.cod_doc"
    SQL = SQL & " AND f.nro_doc=fl.nro_doc"
    SQL = SQL & " AND f.cod_prov=fl.cod_prov"
    SQL = SQL & " GROUP BY fl.precio,f.dto_global,fl.nro_linea,fl.cod_prod,fl.descuento1, fl.descuento2, fl.descuento3,p.cod_art_proveedor,fl.tipo_entrega,fa.deposito,ld.deposito"
    SQL = SQL & " ORDER BY fl.nro_linea,fl.cod_prod "
    
End If

'Muestro en la grilla
MousePointer = 11
lCont = 1

Set L = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not L.EOF Then
    txtDtoGlobal.text = Format(L!dto_global, "0.00")
End If

Do While Not L.EOF
    TxtFactor.text = L!cajas * L!Cant_Prod
    'AIR 20171009
    If IsNull(L!deposito_linea) Then
        lstrDeposito = L!Deposito
    Else
        lstrDeposito = L!deposito_linea
    End If
    
    If Not Proceso_Codigo(L!Cod_Prod, L!descuento1, L!descuento2, L!descuento3, L!Precio, L!tipo_entrega, lstrDeposito, True, "", False, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
        MsgBox "Error en el Codigo " & L!Cod_Prod, vbCritical, MsgTit
        'AIR 20190605
        If lblnCancelar Then
            Exit Do
        End If
    End If
    L.MoveNext
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Los Pedidos Seleccionados Superan el Maximo de Lineas de la Factura", vbExclamation, MsgTit
        Exit Sub
    End If
Loop
TxtFactor.text = ""

' Veo Si Puedo Cargar los Medios de Pago del Docuemento. Esto solo lo puedo hacer si se cargo solo 1 documento...

SQL = "SELECT count(DISTINCT(cod_doc)) AS cant_doc,count(DISTINCT(nro_doc)) AS cant_nro"
SQL = SQL & " FROM " & lNombre_Tabla_Temporal

Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

If R!cant_doc = 1 Then
    
    If R!cant_nro = 1 Then
        
        ' Se selecciono Solo Un Documento, asi que busco los Medios de Pago de Este Documento
                
        SQL = "SELECT * FROM FaccmpMpagos"
        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
        SQL = SQL & " AND cod_doc = (SELECT MAX(cod_doc) FROM " & lNombre_Tabla_Temporal & ")"
        SQL = SQL & " AND nro_doc = (SELECT MAX(nro_doc) FROM " & lNombre_Tabla_Temporal & ")"
        SQL = SQL & " AND cod_prov = " & txtCodProv.text
         SQL = SQL & " ORDER BY cod_mpago"
        
        Set MP = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        
        If Not MP.EOF Then
            Call Cargo_Grilla_Medios_Pago(MP!Cod_Emp, MP!cod_doc, MP!nro_doc, 0)
        End If
        
    End If
End If

MousePointer = 1

End Sub

Sub Cargar_Desde_Otro_Documento_Mercaderia(pstrFiltros As String)
On Error GoTo Errores
Dim lCont As Integer
Dim lstrSQL As String
Dim R As Recordset
Dim C As Recordset
Dim LD As Recordset  ' AIR 20171009
Dim lrstCabezal As Recordset
Dim lblnCancelar As Boolean
Dim lPrecio As Double
Dim magnitud As Long

Dim lstrDeposito As String
Dim afec As Long

If ConfPuntoVta_Consulta_Cargar_Datos_Doc_Afectado = "S" Then
    If MsgBox("DESEA CARGAR DATOS DE LA LINEAS DEL DOCUMENTO AFECTADO?", vbQuestion + vbYesNo + vbDefaultButton1) = vbNo Then
        Exit Sub
    End If
End If
lblnCancelar = False
cmdGuardar.Enabled = False
'Muestro en la grilla
MousePointer = 11
lCont = 1

'Busco el descuento global del documento original   SS 20180328
lstrSQL = "SELECT * FROM Faccmp fl "
lstrSQL = lstrSQL & " WHERE " & Trim(pstrFiltros)

Set lrstCabezal = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)

If Not lrstCabezal.EOF Then
    txtDtoGlobal.text = NullToZero(lrstCabezal!dto_global)
End If
 
'Busco las observaciones adicionales del documento original

If confUsaEquivalenciaMagnitudes Then
   ' pstrfiltro1 = "fl." & " and " & Trim(Replace(Replace(Trim(pstrFiltros), " AND ", "|"), "|", " and fl."))
    lstrSQL = "SELECT fl.*,fa.cant_prod_magnitud,fa.precio_magnitud,fa.magnitud FROM faccmplineas fl,faccmplineas_datos  fa"
    lstrSQL = lstrSQL & " WHERE fl.cod_emp=fa.cod_emp and fl.cod_doc=fa.cod_doc and fl.nro_doc=fa.nro_doc "
    lstrSQL = lstrSQL & " and fa.cod_prov=fa.cod_prov and fl.nro_linea=fa.nro_linea and " & Trim(pstrFiltros)
    lstrSQL = lstrSQL & " ORDER BY fl.nro_linea"
Else
    lstrSQL = "SELECT * FROM faccmplineas fl"
    lstrSQL = lstrSQL & " WHERE " & Trim(pstrFiltros)
    lstrSQL = lstrSQL & " ORDER BY fl.nro_linea"
End If

Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)

If Not R.EOF Then

    lstrSQL = "DELETE FROM Faccmp_Observaciones"
    lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
    lstrSQL = lstrSQL & " AND cod_doc = " & val(txtCodDoc.text)
    lstrSQL = lstrSQL & " AND nro_doc = " & val(txtDoc.text)
    lstrSQL = lstrSQL & " AND cod_prov = " & txtCodProv.text
    
    Dbs.Execute lstrSQL

    lstrSQL = "SELECT * FROM Faccmp_Observaciones"
    lstrSQL = lstrSQL & " WHERE cod_emp = " & R!Cod_Emp
    lstrSQL = lstrSQL & " AND cod_doc = " & R!cod_doc
    lstrSQL = lstrSQL & " AND nro_doc = " & R!nro_doc
    lstrSQL = lstrSQL & " AND cod_prov = " & R!Cod_Prov
    lstrSQL = lstrSQL & " ORDER BY linea"
    
    Set C = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    Do While Not C.EOF
            
        lstrSQL = "INSERT INTO Faccmp_Observaciones "
        lstrSQL = lstrSQL & " VALUES ("
        lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
        lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
        lstrSQL = lstrSQL & val(txtDoc.text) & ","
        lstrSQL = lstrSQL & txtCodProv.text & ","
        lstrSQL = lstrSQL & f_Fecha_Base(date, Conf_Motor_Base) & ","
        lstrSQL = lstrSQL & C!linea & ",'"
        lstrSQL = lstrSQL & f_Ins_String(Trim(C!observacion)) & "','"
        lstrSQL = lstrSQL & Trim(UCase(gUsuario)) & "')"
    
        Dbs.Execute lstrSQL
        C.MoveNext
    Loop

End If

Do While Not R.EOF
    
    ' AIR 20171009 si tiene deposito por linea se debe tomar ese dato
    If Buscar_Documento_Lineas_Datos(R!Cod_Emp, R!cod_doc, R!nro_doc, R!Cod_Prov, R!nro_linea, LD) Then
        lstrDeposito = LD!Deposito
    Else
        lstrDeposito = txtDeposito.text
    End If
    
    If confUsaEquivalenciaMagnitudes Then
         TxtFactor.text = R!cajas * IIf(IsNull(R!cant_prod_magnitud), R!Cant_Prod, R!cant_prod_magnitud)
    Else
         TxtFactor.text = R!cajas * R!Cant_Prod
    End If
    
    txtCajas.text = ""
    
   
    If Busco_Producto(R!Cod_Prod) Then
        If Trim(rstProd!nom_prod) <> "TARA" And Trim(rstProd!nom_prod) <> "BRUTO" Then
            'AIR 20200304 se agrega que se pase por parametro los datos del documento de referencia para que pueda levantar la descripcion personalizada de la linea
            If Trim(Me.txtDoc_Afectado.text) = "" Then
                afec = R!nro_doc
            Else
                afec = CLng(Me.txtDoc_Afectado.text)
            End If
            If confUsaEquivalenciaMagnitudes Then
                lPrecio = R!precio_magnitud
                magnitud = R!magnitud
            Else
                lPrecio = R!Precio
                magnitud = 0
            End If
            'AIR 20230706 se vuelve atras esta llamada a como estaba en la 5.40. con el paramentro en TRUE, no se sabe xq cambio pero esta cambiando la logica que tenia de que al levantar documentos se respeten los valores de precios del documento original que se esta levantando.
            'If Not Proceso_Codigo(R!Cod_Prod, R!descuento1, R!descuento2, R!descuento3, lPrecio, R!tipo_entrega, lstrDeposito, False, "", False, afec, R!nro_doc, R!Cod_Prov, R!nro_linea, R!cod_doc, R!nro_doc, R!nro_linea, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, magnitud) Then
            If Not Proceso_Codigo(R!Cod_Prod, R!descuento1, R!descuento2, R!descuento3, lPrecio, R!tipo_entrega, lstrDeposito, True, "", False, afec, R!nro_doc, R!Cod_Prov, R!nro_linea, R!cod_doc, R!nro_doc, R!nro_linea, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre, magnitud) Then
                MsgBox "Error en el Codigo " & R!Cod_Prod, vbCritical, MsgTit
                'AIR 20190605
                If lblnCancelar Then
                    Exit Do
                End If
            End If
        End If
    End If
    R.MoveNext
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Las Lineas del Documento Seleccionado Superan el Maximo de Lineas de la Factura", vbExclamation, MsgTit
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop

TxtFactor.text = ""

MousePointer = 1
cmdGuardar.Enabled = True

Exit Sub
Errores:
    cmdGuardar.Enabled = True
Exit Sub
End Sub

Sub Cargar_Desde_Otro_Documento_Servicio(pstrFiltros As String)
On Error GoTo Errores
Dim lCont As Integer
Dim lstrSQL As String
Dim R As Recordset
Dim lrstLinea As Recordset
Dim lrstDocumentos As Recordset

cmdGuardar.Enabled = False
'Muestro en la grilla
MousePointer = 11
lCont = 1


' AIR 20200901
 Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text)
 
lstrSQL = "SELECT FaccmpServicios.* "
lstrSQL = lstrSQL & " FROM FaccmpServicios,Faccmp"
lstrSQL = lstrSQL & " WHERE Faccmp.cod_emp = FaccmpServicios.cod_emp"
lstrSQL = lstrSQL & " AND Faccmp.cod_doc = FaccmpServicios.cod_doc"
lstrSQL = lstrSQL & " AND Faccmp.nro_doc = FaccmpServicios.nro_doc"
lstrSQL = lstrSQL & " AND Faccmp.cod_prov = FaccmpServicios.cod_prov"
lstrSQL = lstrSQL & " AND " & Trim(pstrFiltros)
lstrSQL = lstrSQL & " ORDER BY FaccmpServicios.nro_linea"

Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)

Do While Not R.EOF
        
    dbgLineas_Servicios.Columns("unidades").text = R!unidades
    dbgLineas_Servicios.Columns("codigo").text = R!codigo
    dbgLineas_Servicios.Columns("descripcion").text = R!Descripcion
    
    dbgLineas_Servicios.Columns("seccion").text = R!seccion
    If Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
        dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
    End If
    
    dbgLineas_Servicios.Columns("tcofis").text = R!tcofis
    dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
    
    dbgLineas_Servicios.Columns("tiva").text = R!tiva
    dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
    
    dbgLineas_Servicios.Columns("tcofis_iva").text = R!tiva
    If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
        dbgLineas_Servicios.Columns("cofis_iva").text = 0
    Else
        dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
    End If
    
    dbgLineas_Servicios.Columns("precio").text = Format(R!Precio, "0.00")
    dbgLineas_Servicios.Columns("precio_siva").text = "0"
    
    dbgLineas_Servicios.Columns("eliminada").Value = False
    
    If Buscar_Tipo_Documento(R!cod_doc, lrstDocumentos) Then
        If lrstDocumentos!tipo_doc = "G" Then
            dbgLineas_Servicios.Columns("tasa_resguardo").text = Format(R!tasa_resguardo, "0.00")
           
            'AIR 20200831 agrego que cargue el precio sin iva tambien para que cargue los montos del documento original de resguardo
            dbgLineas_Servicios.Columns("precio_siva").text = Format(R!Precio, "0.00")
            ' AIR 20200901
            If Buscar_Documento_Lineas_Auxiliar(R!Cod_Emp, R!cod_doc, R!nro_doc, R!Cod_Prov, (dbgLineas_Servicios.Row + 1), lrstLinea) Then
                Call Ingreso_Datos_Auxiliares_del_Resguardo(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, (dbgLineas_Servicios.Row + 1), lrstLinea!observacion, lNombre_Tabla_Lineas_Auxiliar_Temporal)
            End If
            Call Calcular_Importes_de_la_Linea_Servicios(True, "N", True)
        Else
            Call Calcular_Importes_de_la_Linea_Servicios(True, "", False)
        End If
    End If
    
    R.MoveNext
    dbgLineas_Servicios.MoveNext
    
    lCont = lCont + 1
    If lCont > llngMaximo_Lineas Then
        MsgBox "Las Lineas del Documento Seleccionado Superan el Maximo de Lineas de la Factura", vbExclamation, MsgTit
        cmdGuardar.Enabled = True
        Exit Sub
    End If
Loop



MousePointer = 1
cmdGuardar.Enabled = True
Exit Sub
Errores:
    MousePointer = 1
    cmdGuardar.Enabled = True
    Exit Sub
End Sub

Public Sub Busqueda_Documentos_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lTipo_Doc As String, lClase As String, lSigno As Integer, lGrilla As String, lMoneda As Long)

Dim lrstFecha As Recordset

Dim lstrCod_Doc_Afectar As String
Dim lIndice As Integer
Dim lstrDocActual As String
Dim lstrDocumentos_Validos As String
Dim lstrSQL As String


    lstrCod_Doc_Afectar = ""
    lstrDocumentos_Validos = ""

    
    'Clon toma pedidos de proveedor para generar de cliente
    If UCase(lGrilla) = "PEDIDOS" Then
        lstrCod_Doc_Afectar = "Faccmp.cod_doc IN (301) AND faccmp.fec_doc>= " & f_Fecha_Base(date - 15, Conf_Motor_Base)
    Else
        'AIR 20181129 gestion de señas
        If UCase(lGrilla) = "MEDIOS_PAGOS" Then
            lIndice = vsfMedios_Pagos.Row
            lstrCod_Doc_Afectar = "Faccmp.ruc = '" & Trim(TxtRuc.text) & "'"
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.cod_doc in (Select cod_doc From documentos "
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Where tipo_doc = '" & UCase(Trim(lTipo_Doc)) & "'"
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And signo = " & lSigno & ")"
        Else
        
            lstrCod_Doc_Afectar = "Faccmp.cod_doc in (Select cod_doc From documentos "
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Where tipo_doc = '" & UCase(Trim(lTipo_Doc)) & "'"
            If lTipo_Doc = "E" Then
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And clase = '" & UCase(Trim(lClase)) & "'"
            End If
            
            ' AIR 20200827 se agrega para los resguardos
            If UCase(lGrilla) = "DOCUMENTOS_PARA_RESGUARDO" Then
                 
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.nro_doc NOT IN  "
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " (Select nro_doca From faccmpResguardos "
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Where Faccmp.cod_emp = faccmpResguardos.cod_emp"
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.cod_doc = faccmpResguardos.cod_doca"
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.nro_doc = faccmpResguardos.nro_doca"
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.cod_prov = faccmpResguardos.cod_prova)"
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " )"
                
                ' AIR agrego los documentos Validos asociados
                lstrDocumentos_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento(val(txtCodDoc.text))
                If Trim(lstrDocumentos_Validos) <> "" Then
                    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND Faccmp.cod_doc in (" & lstrDocumentos_Validos & ") "
                    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND Faccmp.autorizado = 'S' "
                End If
                
'                'AIR 20220722 se agrega filtro por fecha desde para tomar todos los documentos posteriores a la fecha indicada
'                ' primero se controla que tabla exista ya la "Instrucciones_De_Actualizacion" automatica va a ir recien en la proxima version
'
'                lstrSQL = "SELECT * "
'                lstrSQL = lstrSQL & " From INFORMATION_SCHEMA.Tables "
'                lstrSQL = lstrSQL & " WHERE TABLE_SCHEMA = 'dbo'"
'                lstrSQL = lstrSQL & " AND TABLE_NAME = 'ma_FecDoc_Desde_Afectar'"
'
'                Set lrstfecha = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                
'                If Not lrstfecha.EOF Then
                    'AIR 20220722 se agrega filtro por fecha desde para tomar todos los documentos posteriores a la fecha indicada
                    lstrSQL = "SELECT * "
                    lstrSQL = lstrSQL & " From ma_FecDoc_Desde_Afectar "
                    lstrSQL = lstrSQL & " WHERE proceso = '" & "DOCUMENTOS_PARA_RESGUARDO" & "'"
                    Set lrstFecha = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                    
                    If Not lrstFecha.EOF Then
                        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And Faccmp.fec_doc >=  " & f_Fecha_Base(Format(lrstFecha!FechaDesde, "dd/mm/yyyy"), Conf_Motor_Base)
                    End If
'                End If
                
            Else
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And signo = " & lSigno & ")"
            End If
        End If
    End If
    
    If Trim(gstrCodBarraIngresadoPuntoVta) <> "" Then
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " and faccmp.cod_doc=" & Mid(Trim(gstrCodBarraIngresadoPuntoVta), 3, 3) & " and faccmp.nro_doc=" & val(Mid(Trim(gstrCodBarraIngresadoPuntoVta), 6, 7))
    End If

    frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
    frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
    frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
    
    If UCase(lGrilla) = "PEDIDOS" Then
        frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "P"
    Else
        ' AIR 20200827 se agrega para los resguardos
        If UCase(lGrilla) = "DOCUMENTOS_PARA_RESGUARDO" Then
            frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "P"
        Else
            frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
        End If
    End If
    
    frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
    frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
    frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
    frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
    frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
    frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
    frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
    
    'AIR 20200819 se agrega la posibilidad de filtrar por la sucursal
    frmBusqueda_Documentos_a_Afectar.pglngSucursal = val(TxtCodSuc.text)
            
    frmBusqueda_Documentos_a_Afectar.Show vbModal
    
    ' AIR 20181204 agregado para el manejo de Señas

    vsfMedios_Pagos.TextMatrix(lIndice, CGMP_CODDOC) = frmBusqueda_Documentos_a_Afectar.plngCod_Doc_Seleccionado
    vsfMedios_Pagos.TextMatrix(lIndice, CGMP_NRODOC) = frmBusqueda_Documentos_a_Afectar.plngNro_Doc_Seleccionado
    vsfMedios_Pagos.TextMatrix(lIndice, CGMP_CODPROV) = frmBusqueda_Documentos_a_Afectar.plngCod_Prov_Seleccionado


End Sub

Public Sub Busqueda_Preventa_a_Afectar(lcod_emp As Long, lTipo_Doc As String, lSigno As Integer, lGrilla As String, ByRef lCod_Prov As Long, ByRef llngMoneda As Long, lDeposito As String, pbolLlamado_Desde_Cod_Doc As Boolean, ByRef pgstrNombre_Temporal As String)
Dim lstrCod_Doc_Afectar As String

    If ConfFormato_Factura = "BSGIMENEZ" Then
        lstrCod_Doc_Afectar = "Faccmp.cod_doc IN (303,304)"
    Else
        lstrCod_Doc_Afectar = "Faccmp.cod_doc IN (" & ConfDoc_Ingreso_Pedido_Cli & "," & ConfDoc_Ingreso_PreVenta_Cli & "," & ConfDoc_Ingreso_Pedido_Cli_Web & "," & ConfDoc_Ingreso_Pedido_Cli_Desde_Mercado_Libre & "," & ConfDoc_Ingreso_Pedido_Cli_API & ")"  'AIR 20250725 se agrega api  'Agrega docs WEB    SS 20190910
    End If
    If Trim(gstrCodBarraIngresadoPuntoVta) <> "" Then
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " and faccmp.cod_doc=" & Mid(Trim(gstrCodBarraIngresadoPuntoVta), 3, 3) & " and faccmp.nro_doc=" & val(Mid(Trim(gstrCodBarraIngresadoPuntoVta), 6, 7))
        
    End If
    
    
    pgstrNombre_Temporal = ""
    
    If ConfFormato_Factura = "BSGIMENEZ" Then
    
        frmBusqueda_Documentos_a_Afectar_V2.pglngCod_Emp_Afectar = lcod_emp
        frmBusqueda_Documentos_a_Afectar_V2.pglngCod_Prov_Afectar = lCod_Prov
        frmBusqueda_Documentos_a_Afectar_V2.pgstrTipo_Titular_Afectar = "C"
        frmBusqueda_Documentos_a_Afectar_V2.pglngSigno_Afectar = lSigno
        frmBusqueda_Documentos_a_Afectar_V2.pglngMoneda = 0
        frmBusqueda_Documentos_a_Afectar_V2.pgstrForm = Me.Name
        frmBusqueda_Documentos_a_Afectar_V2.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
        frmBusqueda_Documentos_a_Afectar_V2.pgbolVer_Datos_eFactura = False
        frmBusqueda_Documentos_a_Afectar_V2.pgstrTitulo_Grilla = "DOCUMENTOS PENDIENTES DE LOS MOVILES PARA PROCESAR"
        
        If Trim(UCase(sspOperacion.Caption)) = "B" Then
            ' Se van a anular documentos
            frmBusqueda_Documentos_a_Afectar_V2.pbolAnular_Documentos = True
        Else
            frmBusqueda_Documentos_a_Afectar_V2.pbolAnular_Documentos = False
        End If
        
        frmBusqueda_Documentos_a_Afectar_V2.plngCod_Prov_Seleccionado = 0
        frmBusqueda_Documentos_a_Afectar_V2.plngMoneda_Seleccionada = 1
        frmBusqueda_Documentos_a_Afectar_V2.pgstrNombre_Temporal = ""
        
        frmBusqueda_Documentos_a_Afectar_V2.Show vbModal
        
        lCod_Prov = frmBusqueda_Documentos_a_Afectar_V2.plngCod_Prov_Seleccionado
        llngMoneda = frmBusqueda_Documentos_a_Afectar_V2.plngMoneda_Seleccionada
        pgstrNombre_Temporal = frmBusqueda_Documentos_a_Afectar_V2.pgstrNombre_Temporal
        
    Else
        frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
        frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
        frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
        frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
        frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
        frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
        frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
        frmBusqueda_Documentos_a_Afectar.pglngMoneda = 0
        frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
        frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
        frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
        frmBusqueda_Documentos_a_Afectar.pgstrDeposito = lDeposito
        frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
        
        'AIR 20200819
        frmBusqueda_Documentos_a_Afectar.pglngSucursal = 0
            
        frmBusqueda_Documentos_a_Afectar.Show vbModal
        
        lCod_Prov = frmBusqueda_Documentos_a_Afectar.plngCod_Prov_Seleccionado
        llngMoneda = frmBusqueda_Documentos_a_Afectar.plngMoneda_Seleccionada
        
        pgstrNombre_Temporal = gNombre_Tabla_Temporal

    End If
    
End Sub

Public Sub Busqueda_Documentos_Remitos_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lTipo_Doc As String, lSigno As Integer, lAfecta_Stock As String, lGrilla As String, lMoneda As Long, lOrigen As String)
Dim lstrCod_Doc_Afectar As String

    lstrCod_Doc_Afectar = "Faccmp.cod_doc in (Select cod_doc From documentos "
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Where tipo_doc = '" & UCase(Trim(lTipo_Doc)) & "'"
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And signo = " & lSigno
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And stock = " & f_paso_S_N_a_0_1(lAfecta_Stock)
    lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " And tipo_estado_cta = 'R')"
    
    'AIR 20251112
    If lOrigen = "S" Then
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND faccmp.nro_doc NOT IN "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " (select nro_doca from FaccmpLineas_Pendientes P "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " where faccmp.cod_emp = p.cod_emp "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND faccmp.cod_doc = p.cod_doca "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND faccmp.nro_doc = p.nro_doca"
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND faccmp.cod_prov = p.cod_prova "
        'lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND p.cod_doc <> p.cod_doca "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " group by cod_emp,cod_doca,nro_doca,cod_prova,nro_lineaa,cod_proda "
        lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " Having Sum(Cant_Prod) = 0 )"
        '2a opcion , controlar saldos
'        select cod_emp,cod_doca,nro_doca,cod_prova,nro_lineaa,cod_proda,sum(cant_prod) cantidad,
'        MAX (cod_doc), min(cod_doc)
'        From faccmplineas_pendientes
'        Where cod_doca = 125
'        group by cod_emp,cod_doca,nro_doca,cod_prova,nro_lineaa,cod_proda
'        Having Sum(Cant_Prod) <> 0
'
        '1a opcion controlar solo afectados
        'cod_doc=125 and cod_emp=2 and nro_doc not in (select nro_doca from  faccmplineas_pendientes where cod_emp=2 and cod_doc<>cod_doca and cod_doca=faccmp.cod_doc)
        
    End If
    
    frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
    frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
    frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
    frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
    frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
    frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
    frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
    frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
    frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
    frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
    
    'AIR 20200819
    frmBusqueda_Documentos_a_Afectar.pglngSucursal = 0
        
    frmBusqueda_Documentos_a_Afectar.Show vbModal

End Sub

Public Sub Busqueda_Documentos_Definidos_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lCod_Doc As Long, lNro_Doc As Long, _
                        lSigno As Integer, lAfecta_Stock As String, lGrilla As String, lMoneda As Long)
                        
Dim lstrCod_Doc_Afectar As String
Dim lstrDocumentos_Pendientes_Validos As String
Dim lstrDocActual As String

    lstrCod_Doc_Afectar = ""
    lstrDocActual = Trim(str(lCod_Doc)) & Trim(str(lNro_Doc))   ' se usa para las modificaciones, para excluir en la SELECT el documento que se esta modificando
    
    lstrDocumentos_Pendientes_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento_Control(lCod_Doc)

    If Trim(gBusqueda_Doc_Pendientes_Formato) <> "V4" Then
    
        If Trim(lstrDocumentos_Pendientes_Validos) <> "" Then
            lstrCod_Doc_Afectar = "Faccmp.cod_doc in (" & lstrDocumentos_Pendientes_Validos & ") "
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND Faccmp.autorizado = 'S' "     'NO anulados    SS 20180126
            
            'lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', '') <> " & lstrDocActual
            'AIR 20220901 se agrega comillas a la query porque estaba comparando un string contra un int y daba desbordamiento
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND ltrim(rtrim(REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', ''))) <> '" & lstrDocActual & "'"
            
            frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
            frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
            frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
            frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
            frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
            frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
            frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
            frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
            frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
            frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
            frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
            frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
            
            'AIR 20200819 se agrega la posibilidad de filtrar por la sucursal
            frmBusqueda_Documentos_a_Afectar.pglngSucursal = val(TxtCodSuc.text)
            frmBusqueda_Documentos_a_Afectar.Show vbModal
            
        Else
            MsgBox "No Hay Documentos Pendientes Validos Para el Tipo Documento " & lCod_Doc, vbExclamation, MsgTit
        End If
        
    Else
        If Trim(lstrDocumentos_Pendientes_Validos) <> "" Then
            lstrCod_Doc_Afectar = "Faccmp.cod_doc in (" & lstrDocumentos_Pendientes_Validos & ") "
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND Faccmp.autorizado = 'S' "     'NO anulados    SS 20180126
            lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND ltrim(rtrim(REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', ''))) <> '" & lstrDocActual & "'"
            
        
            frmBusqueda_Documentos_a_Afectar_V4.pglngCod_Emp_Afectar = lcod_emp
            frmBusqueda_Documentos_a_Afectar_V4.pglngCod_Prov_Afectar = lCod_Prov

            frmBusqueda_Documentos_a_Afectar_V4.pglngCod_Suc_Afectar = val(TxtCodSuc.text)
            frmBusqueda_Documentos_a_Afectar_V4.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
            frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
            frmBusqueda_Documentos_a_Afectar_V4.pglngMoneda = lMoneda
            frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
            frmBusqueda_Documentos_a_Afectar_V4.pstrTabla_Temporal = ""
        
            frmBusqueda_Documentos_a_Afectar_V4.Show vbModal
            
        Else
            MsgBox "No Hay Documentos Pendientes Validos Para el Tipo Documento " & lCod_Doc, vbExclamation, MsgTit
        End If
    
    
    End If
End Sub

Public Sub Busqueda_Fichas_Viaje_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lCod_Doc As Long, lNro_Doc As Long, _
                        lSigno As Integer, lAfecta_Stock As String, lGrilla As String, lMoneda As Long)
                        
Dim lstrCod_Doc_Afectar As String
Dim lstrDocumentos_Pendientes_Validos As String
Dim lstrDocActual As String

    lstrCod_Doc_Afectar = ""
    
    frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
    frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
    frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = ""
    frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
    frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
    frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
    frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
    frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = lstrCod_Doc_Afectar
    frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
    frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
    
    'AIR 20200819
    frmBusqueda_Documentos_a_Afectar.pglngSucursal = 0
    frmBusqueda_Documentos_a_Afectar.Show vbModal

End Sub

Public Sub Busqueda_Documentos_WIS_a_Afectar(lcod_emp As Long, lCod_Prov As Long, lTipo_Doc As String, lSigno As Integer, lGrilla As String, lMoneda As Long)
    
    frmBusqueda_Documentos_a_Afectar.pglngCod_Emp_Afectar = lcod_emp
    frmBusqueda_Documentos_a_Afectar.pglngCod_Prov_Afectar = lCod_Prov
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Doc_Afectar = lTipo_Doc
    frmBusqueda_Documentos_a_Afectar.pdteFecha_Documento_Origen = CDate(txtFec_Doc.text)
    frmBusqueda_Documentos_a_Afectar.pgstrTipo_Titular_Afectar = "C"
    frmBusqueda_Documentos_a_Afectar.pglngSigno_Afectar = lSigno
    frmBusqueda_Documentos_a_Afectar.pgstrGrilla = lGrilla
    frmBusqueda_Documentos_a_Afectar.pglngMoneda = lMoneda
    frmBusqueda_Documentos_a_Afectar.pgstrForm = Me.Name
    frmBusqueda_Documentos_a_Afectar.pgstrCod_Doc_Afectar = txtCodDoc.text
    frmBusqueda_Documentos_a_Afectar.pglngCod_Ruta = 0
    frmBusqueda_Documentos_a_Afectar.pgbolVer_Datos_eFactura = False
    
    frmBusqueda_Documentos_a_Afectar.DbgLineas.SelectTypeRow = ssSelectionTypeSingleSelect
    
    'AIR 20200819
    frmBusqueda_Documentos_a_Afectar.pglngSucursal = 0
    frmBusqueda_Documentos_a_Afectar.Show vbModal
    frmBusqueda_Documentos_a_Afectar.DbgLineas.SelectTypeRow = ssSelectionTypeMultiSelect

End Sub

Sub Activar_Documento(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, lTitular As Long)
Dim Coment As String
Dim lSigno As Long
Dim D As Recordset

If Not Buscar_Tipo_Documento(lCod_Doc, D) Then
    Exit Sub
End If

lSigno = D!signo

'Se arregla el stock
If D!stock = True Then
    Call ArregloStock(lcod_emp, lCod_Doc, lNro_Doc, lTitular, lSigno)
End If

Coment = "ACTIVADO - " & Trim(gUsuario) & " Fecha: " & Format(date, "dd/mm/yyyy") & " Hora: " & Format(time, "HH:MM:SS")
SQL = "update faccmp set autorizado='S' , fec_reg=" & f_Fecha_Base(date, Conf_Motor_Base) & " , observa='" & Coment & "' " & _
            "where cod_emp = " & lcod_emp & " and cod_doc=" & lCod_Doc & _
    " and nro_doc=" & lNro_Doc
Dbs.Execute SQL

End Sub


Public Sub Inicializar_Remota_plngMoneda_Anterior(ByVal argMoneda As Long)
   plngMoneda_Anterior = argMoneda
End Sub

Function Centrar(lLinea As String, lTexto As String, lLargo As Integer) As String
Dim pos As Integer
pos = ((lLargo - Len(lTexto)) / 2)
Centrar = Mid(lLinea, 1, Int(pos)) & lTexto
End Function

Sub Imprimir_Ticket(esCredito As Boolean)
'ATU 20170326 , se suprime
'''On Error GoTo errores

End Sub

Sub Imprimir_Factura(pstrTipo_Impresion As String, plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, pstrFec_Doc As String, pstrFecha_Vencimiento As String, plngMoneda As Long, plngSucursal As Long, plngCod_Forma_Pago As Long, plngCod_Vendedor As Long, pstrGuia As String, pstrObservacion As String, plngNro_Fanfold As Long, plngCuenta_Madre As Long, ByRef pobjCrystalReport As CrystalReport)
Dim D As Recordset
Dim sigo As Integer

If Trim(UCase(pstrTipo_Impresion)) = "D" Then
    ' Si la Impresion es por Documento, verifico si esta configurado para que se Imprima. Si es por lote no chequeo esto
    If Buscar_Tipo_Documento(plngCod_Doc, D) Then
        If Trim(UCase(D!se_Imprime)) = "N" Then
            Exit Sub
        End If
        If Trim(UCase(D!se_Imprime)) = "C" Then
            sigo = MsgBox("Desea Imprimir el Documento?", vbYesNo + vbInformation, MsgTit)
            If sigo = vbNo Then
                Exit Sub
            End If
        End If
    End If
    
Else
    If Not Buscar_Tipo_Documento(plngCod_Doc, D) Then 'AIR 20190423 Si es por LOTE hay que consultar el documento, estaba dando error cuando salia por el Else del Case porque no se habia consultado la tabla de Documentos
        MsgBox "No existe Formato de Factura Definido o Falta Configurarlo", vbExclamation, MsgTit
        Exit Sub
    End If
End If


Select Case ConfFormato_Factura
    
    Case "RONDACROM-POS-W98_EPSONFX1050"
        Call Imp_Formato_Rondacrom_Pos_W98_EPSONFX1050(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngCod_Forma_Pago, pstrGuia, pstrObservacion)
    
    Case "RONDACROM-POS-W98_EPSONFX890"
        Call Imp_Formato_Rondacrom_Pos_W98_EPSONFX890(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngCod_Forma_Pago, pstrGuia, pstrObservacion)
    
    'Case "RONDACROM-POS"
    '    Call Imp_Formato_Rondacrom_Pos(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngCod_Forma_Pago, pstrGuia, pstrObservacion)
    
    Case "RONDACROM-DIS"
        Call Imp_Formato_Rondacrom_Distribuidora(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngCod_Forma_Pago, plngCod_Vendedor, pstrGuia, pstrObservacion)
        
'    Case "DFLODUR"
'        Call Imp_Formato_DISTRIBUIDORA_FLODUR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, plngNro_Fanfold, pobjCrystalReport)
        
    Case "MONTEVIDEOFOODS"
        Call Imp_Formato_DISTRIBUIDORA_MONTEVIDEOFOODS_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "MBERRUTTI"
        Call Imp_Formato_DISTRIBUIDORA_MBERRUTTI_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
                    
    'AIR 20230323 se quita esta linea porque pasa a impresion Laser con RPT
'    Case "LCP-LACAMPANA"
'        Call Imp_Formato_LCP_CAMPANA(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, pstrObservacion, plngNro_Fanfold, plngCuenta_Madre)
            
    Case "DIBERACO"
        If plngCod_Emp = "1" Then
            Call Imp_Formato_DIBERACO_FACTURA_PAPEL_BLANCO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, pstrObservacion)
        End If
        If plngCod_Emp = "2" Then
            Call Imp_Formato_DIBERACO_FACTURA(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, pstrObservacion)
        End If
        
    Case "LORIANO"
            If plngCod_Emp = "2" Then
                Call Imp_Formato_LORIANO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngSucursal, plngCod_Vendedor, pstrObservacion, plngNro_Fanfold)
            End If
            If plngCod_Emp = "3" Then
                Call Imp_Formato_UNISIGLO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, plngMoneda, plngSucursal, plngCod_Vendedor, pstrObservacion, plngNro_Fanfold)
            End If
    
    Case "CASINO", "DALTIRO"
        Call Imp_Formato_CASINO(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, pstrFecha_Vencimiento, plngMoneda, plngSucursal, plngCod_Vendedor, plngCod_Forma_Pago, pstrObservacion, plngNro_Fanfold, D!mueve_merca_serv)
    
    Case "CASINO-POS"
        Call Imp_Formato_CASINO_POS(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pstrFec_Doc, pstrFecha_Vencimiento, plngMoneda, plngSucursal, plngCod_Vendedor, plngCod_Forma_Pago, pstrObservacion, plngNro_Fanfold)
    
    Case "PLUS_RENT_A_CAR"
        Call Imp_Formato_PLUS_RENT_A_CAR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    ' Se comenta para que se use el RPT configurado en el documento
    'Case "POLAR_CENTER"
    '    Call Imp_Formato_POLAR_CENTER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "ENVASES_DESCARTABLES"
        Call Imp_Formato_ENVASES_DESCARTABLES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "ELECTRONACHO"
        Call Imp_Formato_ELECTRONACHO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "CHACICARNES"          ' SS 20160720
        Call Imp_Formato_CHACICARNES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
    Case "CASABALLE"            ' SS 20160720
        Call Imp_Formato_CASABALLE_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
    Case "ELUTCHANZ"            ' SS 20160720
        Call Imp_Formato_ELUTCHANZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
'    Case "MGIPARAGUAY"          'LC 20170304
'         Call Imp_Formato_MGIPARAGUAY_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
         
    Case "RGDISTRIBUCIONES"     'LC 20170224
        Call Imp_Formato_RGDISTRIBUCIONES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
'    Case "RAYUELA"              ' SS 20170615
'        Call Imp_Formato_RAYUELA_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
         
    Case "BARATILLO"
        Call Imp_Formato_BARATILLO_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "MMARTINEZ"
        Call Imp_Formato_MMARTINEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "GARCIALOPEZ"
        Call Imp_Formato_GARCIALOPEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "STAUDINGER"
        Call Imp_Formato_STAUDINGER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "JAGUILAR"
        Call Imp_Formato_JAGUILAR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "AMANECER"
        Call Imp_Formato_AMANECER_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "TATOREPRESENTACIONES"
        Call Imp_Formato_TATOREPRESENTACIONES_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "ENET"
        Call Imp_Formato_ENET_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "BAZAR_LOS_3"
        Call Imp_Formato_BAZAR_LOS_3_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "METALIC"
        Call Imp_Formato_METALIC_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
'    Case "PHARMAZONA"
'        Call Imp_Formato_PHARMAZONA_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "MAVIM"        ' SS 20150929
        Call Imp_Formato_MAVIM_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)

    Case "CARLITOS"     ' SS 20151110
        Call Imp_Formato_CARLITOS_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)

    Case "NACAR"
        Call Imp_Formato_NACAR_REMITOS(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngNro_Fanfold)

    Case "ALBERTA"     ' SS 20160831
        Call Imp_Formato_ALBERTA_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)

    Case "BSGIMENEZ"     ' JE 20160915
        Call Imp_Formato_BSGIMENEZ_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
'    Case "FERRETERIATOK"    'SS 20171207
'        Call Imp_Formato_FERRETERIATOK_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
    Case "PUNTOUNION"       'SS 20171213
        Call Imp_Formato_PUNTOUNION_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
'    Case "AMICONE"          'SS 20171221
'        Call Imp_Formato_AMICONE_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
        
    Case "CENTROSUR"
        Call Imp_Formato_CENTROSUR_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, pobjCrystalReport)
    
    Case Else
    
        'Para los que tengan definido el reporte en tabla documentos
        If D!formato_impresion <> "" And D!archivo_rpt_reporte_asociado <> "" And D!cantidad_vias > 0 Then
            Call Imp_Formato_GENERAL_LASER(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, pobjCrystalReport)
        Else
            MsgBox "No existe Formato de Factura Definido o Falta Configurarlo", vbExclamation, MsgTit
        End If

End Select

End Sub

Function Listar_Cabezales(pTipo As String, pbolSolo_Totales As Boolean, pbolCon_Netos As Boolean, pbolObservaciones As Boolean, pbolDatos_eFactura As Boolean, pbolContrato As Boolean, pbolagrupado As Boolean, pstrTitulo As String, Optional pbolMuestraRUT As Boolean = False)
On Error GoTo Errores

    Dim lParametro As String
    Dim lrst_cab As Recordset
    Dim lrst_lin As Recordset
    Dim lrst_Pagos As Recordset
    Dim lrst_Ajuste_INAC As Recordset
    Dim lrst_Doc As Recordset
    Dim lLineas As Integer
    Dim lLineas_Mercaderia As Integer
    Dim lLineas_Servicios As Integer
    Dim lCofis1, lCofis2, lCofis3 As Double
    Dim RM As Recordset
    Dim ldblSaldo As Double
    Dim ldblAjuste_INAC As Double
    Dim ldblDtos_Total As Double
    Dim ldblDto_Global  As Double
    Dim ldblPrecio As Double
    Dim ldblPrecio_Con_Dto As Double
    Dim ldblSubTotal As Double
    Dim lstrTitulo As String
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Sucursal"
    gfiltros_nombre_campo(3) = "Documento"
    gfiltros_nombre_campo(4) = "Tipo Documento (M-ercadería  S-ervicio)"
    gfiltros_nombre_campo(5) = "Número"
    gfiltros_nombre_campo(6) = "Cliente"
    gfiltros_nombre_campo(7) = "RUT"
    gfiltros_nombre_campo(8) = "Fecha Documento"
    gfiltros_nombre_campo(9) = "Fecha Valor"
    gfiltros_nombre_campo(10) = "Fecha Entrega"
    gfiltros_nombre_campo(11) = "Validos"
    gfiltros_nombre_campo(12) = "Forma de Pago"
    gfiltros_nombre_campo(13) = "Medio de Pago"
    gfiltros_nombre_campo(14) = "Moneda"
    gfiltros_nombre_campo(15) = "Caja/Pos"
    gfiltros_nombre_campo(16) = "Vendedor"
    gfiltros_nombre_campo(17) = "Remito"
    gfiltros_nombre_campo(18) = "Guia INAC"
    gfiltros_nombre_campo(19) = "Fecha Registro"
    gfiltros_nombre_campo(20) = "Usuario"
    gfiltros_nombre_campo(21) = "Vendedor en Cliente"
    gfiltros_nombre_campo(22) = "Lista de Precios"
    gfiltros_nombre_campo(23) = "Importe"
    If pbolContrato Then
        gfiltros_nombre_campo(15) = "Contrato"
        gfiltros_nombre_campo(24) = "Caja/Pos"
    Else
        gfiltros_nombre_campo(24) = "Observacion"
    End If
    gfiltros_nombre_campo(25) = "Nombre Cliente"
    gfiltros_nombre_campo(26) = "Fecha Vencimiento"
    gfiltros_nombre_campo(27) = "Grupo de Cliente"
    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_suc"
    gfiltros_campo(3) = "Faccmp.cod_doc"
    gfiltros_campo(4) = "Documentos.mueve_merca_serv"
    gfiltros_campo(5) = "Faccmp.nro_doc"
    gfiltros_campo(6) = "Faccmp.cod_prov"
    gfiltros_campo(7) = "Faccmp.ruc"
    gfiltros_campo(8) = "Faccmp.fec_doc"
    gfiltros_campo(9) = "Faccmp.fec_valor"
    gfiltros_campo(10) = "Faccmp.fec_ent"
    gfiltros_campo(11) = "Faccmp.autorizado"
    gfiltros_campo(12) = "Faccmp.forma_pago"
    gfiltros_campo(13) = "Faccmpmpagos.cod_mpago"
    gfiltros_campo(14) = "Faccmp.moneda"
    gfiltros_campo(15) = "Faccmp.caja"
    gfiltros_campo(16) = "Faccmp.nro_ven"
    gfiltros_campo(17) = "Faccmp.cofismin"
    gfiltros_campo(18) = "Faccmp.cofisexento"
    gfiltros_campo(19) = "Faccmp.fec_reg"
    gfiltros_campo(20) = "Faccmp.usuario"
    gfiltros_campo(21) = "clientes.nro_ven"
    gfiltros_campo(22) = "Faccmp.nro_rollo"
    gfiltros_campo(23) = "Faccmp.importe"


    If pbolContrato Then
        gfiltros_campo(15) = "Faccmp_Cabezal_Auxiliar.contrato"
        gfiltros_campo(24) = "Faccmp.caja"
    Else
        gfiltros_campo(24) = "Faccmp.observa"
    End If
    gfiltros_campo(25) = "Faccmp.nom_cli"
    gfiltros_campo(26) = "Faccmp.fec_venc"
    gfiltros_campo(27) = "clientes.grupo"
    
    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "C"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "N"
    gfiltros_tipo_campo(7) = "C"
    gfiltros_tipo_campo(8) = "F"
    gfiltros_tipo_campo(9) = "F"
    gfiltros_tipo_campo(10) = "F"
    gfiltros_tipo_campo(11) = "C"
    gfiltros_tipo_campo(12) = "N"
    gfiltros_tipo_campo(13) = "N"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "N"
    gfiltros_tipo_campo(16) = "N"
    gfiltros_tipo_campo(17) = "N"
    gfiltros_tipo_campo(18) = "N"
    gfiltros_tipo_campo(19) = "F"
    gfiltros_tipo_campo(20) = "C"
    gfiltros_tipo_campo(21) = "N"
    gfiltros_tipo_campo(22) = "N"
    gfiltros_tipo_campo(23) = "N"
    gfiltros_tipo_campo(24) = "C"
    gfiltros_tipo_campo(25) = "C"
    gfiltros_tipo_campo(26) = "F"
    gfiltros_tipo_campo(27) = "N"
    
    If pbolContrato Then
        gfiltros_tipo_campo(24) = "N"
        gfiltros_tipo_campo(15) = "C"
    End If
        
    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
        
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
    If pbolagrupado Then
        ' Seteo los Defectos del Orden a Listar
        gelejir_orden_descripcion(1) = "Empresa"
        gelejir_orden_descripcion(2) = "Moneda"
        gelejir_orden_descripcion(3) = "Documento"
        gelejir_orden_descripcion(4) = "Número"
        gelejir_orden_descripcion(5) = "Cliente"
        gelejir_orden_descripcion(6) = "Fecha Documento"
        gelejir_orden_descripcion(7) = "Fecha Valor"
        gelejir_orden_descripcion(8) = "Fecha Entrega"
        gelejir_orden_descripcion(9) = "Forma Pago"
        gelejir_orden_descripcion(10) = "Vendedor"
        gelejir_orden_descripcion(11) = "Fecha Registro"
        gelejir_orden_descripcion(12) = "Usuario"
        gelejir_orden_descripcion(13) = "Importe"
        If pbolContrato Then
            gelejir_orden_descripcion(14) = "Contrato"
        Else
            gelejir_orden_descripcion(14) = "Observaciones"
        End If
    
        gelejir_orden_campo(1) = "zT_Inf_Docs_Digitados_R.cod_emp"
        gelejir_orden_campo(2) = "zT_Inf_Docs_Digitados_R.moneda"
        gelejir_orden_campo(3) = "zT_Inf_Docs_Digitados_R.cod_doc"
        gelejir_orden_campo(4) = "zT_Inf_Docs_Digitados_R.nro_doc"
        gelejir_orden_campo(5) = "zT_Inf_Docs_Digitados_R.cod_prov"
        gelejir_orden_campo(6) = "zT_Inf_Docs_Digitados_R.fec_doc"
        gelejir_orden_campo(7) = "zT_Inf_Docs_Digitados_R.fec_asiento"
        gelejir_orden_campo(8) = "zT_Inf_Docs_Digitados_R.fec_ent"
        gelejir_orden_campo(9) = "zT_Inf_Docs_Digitados_R.forma_pago"
        gelejir_orden_campo(10) = "zT_Inf_Docs_Digitados_R.nro_ven"
        gelejir_orden_campo(11) = "zT_Inf_Docs_Digitados_R.fec_reg"
        gelejir_orden_campo(12) = "zT_Inf_Docs_Digitados_R.usuario"
        gelejir_orden_campo(13) = "zT_Inf_Docs_Digitados_R.importe"
    
        If pbolContrato Then
            gelejir_orden_campo(14) = "faccmp_cabezal_auxiliar.contrato"
        Else
            gelejir_orden_campo(14) = "zT_Inf_Docs_Digitados_R.observa"
        End If
    
        If pTipo = "F" And pbolSolo_Totales Then
            gelejir_orden_orden(1) = 1
            gelejir_orden_orden(2) = 2
            gelejir_orden_orden(3) = 3
            gelejir_orden_orden(4) = 4
        
            gelejir_orden_tipo(1) = "A"
            gelejir_orden_tipo(2) = "A"
            gelejir_orden_tipo(3) = "A"
            gelejir_orden_tipo(4) = "A"
    
        Else
            If pbolDatos_eFactura Or pbolContrato Then
                gelejir_orden_orden(14) = 1
                
                gelejir_orden_tipo(14) = "A"
            Else
            
                gelejir_orden_orden(2) = 1
                
                gelejir_orden_tipo(2) = "A"
            End If
        End If
        
        frmElejir_Orden_para_Listar.Show (1)
        lbolCancelar_Listado = frmElejir_Orden_para_Listar.pbolCancelar_Listado
    
        DoEvents
            
        If lbolCancelar_Listado Then
            Exit Function
        End If
    End If
    
    If Elejir_Tipo_Moneda_del_Reporte("O") Then
        Exit Function
    End If
    
    
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    ' Tabla Temporal del Reporte
    gNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
    
    Call Borra_Tabla_Temporal(gNombre_Tabla_Temporal)
       
    ' Creo Tabla Temporal Base
    SQL = "Select * Into " & Trim(gNombre_Tabla_Temporal) & " From zT_Inf_Docs_Digitados_R"
    Dbs.Execute SQL
 
    SQL = "Create index id1" & Trim(gNombre_Tabla_Temporal) & " on " & Trim(gNombre_Tabla_Temporal) & " (cod_emp,cod_doc,nro_doc,cod_prov)"
    Dbs.Execute SQL
        
    Select Case pTipo
        Case "F"
            SQL = "SELECT DISTINCT faccmp.*,documentos.signo "
            SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos,clientes"
            If pbolContrato Then
                SQL = SQL & ", Faccmp_Cabezal_Auxiliar "
            End If
            SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
            SQL = SQL & " AND tipo_doc='E'"
            'SQL = SQL & " AND autorizado='S'" Se tienen que mostrar tambien los No autorizados
            SQL = SQL & " AND faccmp.cod_doc >= 90 "
            SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
            SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
            SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
            SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
            If pbolContrato Then
                SQL = SQL & " AND faccmp.cod_emp= Faccmp_Cabezal_Auxiliar.cod_emp"
                SQL = SQL & " AND faccmp.cod_doc=Faccmp_Cabezal_Auxiliar.cod_doc"
                SQL = SQL & " AND faccmp.nro_doc=Faccmp_Cabezal_Auxiliar.nro_doc"
                SQL = SQL & " AND faccmp.cod_prov=Faccmp_Cabezal_Auxiliar.cod_prov "
            End If
            
        Case "V"
            SQL = "SELECT DISTINCT faccmp.*,documentos.signo "
            SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos,clientes"
            SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
            SQL = SQL & " AND tipo_doc='E'"
            SQL = SQL & " AND autorizado='S'"
            SQL = SQL & " AND faccmp.cod_doc < 90 "
            SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
            SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
            SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
            SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
        
        Case "I"
            SQL = "SELECT DISTINCT faccmp.*,documentos.signo"
            SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos, clientes"
            SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
            SQL = SQL & " AND tipo_doc='E'"
            SQL = SQL & " AND autorizado='S'"
            SQL = SQL & " AND faccmp.cod_doc > 90 "
            SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
            SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
            SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
            SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
            
        Case "P"
            SQL = "SELECT DISTINCT faccmp.*,documentos.signo"
            SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos, clientes"
            SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
            SQL = SQL & " AND documentos.cod_doc in( " & ConfDoc_Ingreso_Pedido_Cli & "," & ConfDoc_Ingreso_PreVenta_Cli & "," & ConfDoc_Ingreso_Presupuesto_Cli & "," & ConfDoc_Ingreso_Pedido_Cli_API & " )"  ' AIR 20250725
            SQL = SQL & " AND autorizado='S'"
            SQL = SQL & " AND faccmp.cod_doc > 90 "
            SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
            SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
            SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
            SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
            
        Case "A"
            SQL = "SELECT DISTINCT faccmp.*,documentos.signo"
            SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos, clientes"
            SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
            SQL = SQL & " AND tipo_doc IN ('E','P')"
            SQL = SQL & " AND autorizado='N'"
            SQL = SQL & " AND faccmp.cod_doc > 90 "
            SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
            SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
            SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
            SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
            
    End Select
    
    If pbolDatos_eFactura Then 'AIR 09/03/2016
        SQL = Trim(SQL) & " AND " & "(Documentos.documento_eFactura = 'S' OR Documento_eFactura = 'C')"
    End If
    
    If Trim(lstrFiltros) <> "" Then
        SQL = Trim(SQL) & " and " & Trim(lstrFiltros)
    End If
    

    Set lrst_cab = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not lrst_cab.EOF
        DoEvents
        'Si esta marcado que no lleva cofis, no lo mostramos
        lCofis1 = 0
        lCofis2 = 0
        lCofis3 = 0
        If Trim(lrst_cab!lleva_Cofis) = "S" Then
            lCofis1 = Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "COFIS_TIVA", 1, gTipo_Moneda)
            lCofis2 = Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "COFIS_TIVA", 2, gTipo_Moneda)
            lCofis3 = Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "COFIS_TIVA", 3, gTipo_Moneda)
        End If
        
        ' Busco las lineas de Mercaderia del Documento
        SQL = "SELECT count(*) as lineas "
        SQL = SQL & " FROM FaccmpLineas "
        SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
        SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
        SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
        SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
        SQL = SQL & " Group by cod_emp,cod_doc,nro_doc,cod_prov"
        
        Set lrst_lin = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If lrst_lin.EOF Then
            lLineas_Mercaderia = 0
        Else
            lLineas_Mercaderia = IIf(IsNull(lrst_lin!Lineas), 0, lrst_lin!Lineas)
        End If
        
        
        ' Busco las lineas de Servicio del Documento
        SQL = "SELECT count(*) as lineas "
        SQL = SQL & " FROM FaccmpServicios "
        SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
        SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
        SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
        SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
        SQL = SQL & " Group by cod_emp,cod_doc,nro_doc,cod_prov"
        
        Set lrst_lin = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If lrst_lin.EOF Then
            lLineas_Servicios = 0
        Else
            lLineas_Servicios = IIf(IsNull(lrst_lin!Lineas), 0, lrst_lin!Lineas)
        End If
        
        lLineas = lLineas_Mercaderia + lLineas_Servicios
        
        ldblSaldo = 0
        ldblAjuste_INAC = 0
        
        If pTipo = "I" Then
        
            ' Busco el codigo de Articulo que tiene el Ajuste por Variacion Semanal de Precios de INAC
                    
            SQL = "SELECT sum(precio*cant_prod) as importe "
            SQL = SQL & " FROM FaccmpLineas "
            SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
            SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
            SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
            SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
            SQL = SQL & " AND cod_prod = " & ConfCodigo_Ajuste_INAC
            
            Set lrst_Ajuste_INAC = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
            If Not lrst_Ajuste_INAC.EOF Then
                If IsNumeric(lrst_Ajuste_INAC!Importe) Then
                    ldblAjuste_INAC = lrst_Ajuste_INAC!Importe
                End If
            End If
                    
        Else
            If Buscar_Tipo_Documento(lrst_cab!cod_doc, lrst_Doc) Then
            End If
            If lrst_cab!Autorizado = "N" And lrst_Doc!autorizar_doc_generado = "N" Then
                ldblSaldo = 0
            Else
                ' Busco el Saldo Sin Cancelar del Documento
            
                SQL = "SELECT sum(importe) as importe "
                SQL = SQL & " FROM FaccmpPagos "
                SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
                SQL = SQL & " AND cod_doca = " & lrst_cab!cod_doc
                SQL = SQL & " AND nro_doca = " & lrst_cab!nro_doc
                SQL = SQL & " AND cod_prova = " & lrst_cab!Cod_Prov
            
                Set lrst_Pagos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            
                If lrst_Pagos.EOF Then
                    ldblSaldo = lrst_cab!Importe
                Else
                    If IsNull(lrst_Pagos!Importe) Then
                        ldblSaldo = lrst_cab!Importe
                    Else
                        If lrst_Pagos!Importe >= lrst_cab!Importe Then
                            ldblSaldo = 0
                        Else
                            ldblSaldo = lrst_cab!Importe - lrst_Pagos!Importe
                        End If
                    End If
                End If
            End If
        End If
                        
        ldblDtos_Total = 0
        ldblSubTotal = 0
        If pTipo = "F" Then
            ' Recorro las lineas de Documento para calcular los descuentos realizados
            SQL = "SELECT * "
            SQL = SQL & " FROM FaccmpLineas "
            SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
            SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
            SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
            SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
            
            Set lrst_lin = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            Do Until lrst_lin.EOF
                ldblPrecio = lrst_lin!Precio    'Precio original
                'Aplico descuento 1
                ldblPrecio_Con_Dto = ldblPrecio * (1 - (lrst_lin!descuento1 / 100))
                'Aplico descuento 2 incremental
                ldblPrecio_Con_Dto = ldblPrecio_Con_Dto * (1 - (lrst_lin!descuento2 / 100))
                'Aplico descuento 3 incremental a los anteriores
                ldblPrecio_Con_Dto = ldblPrecio_Con_Dto * (1 - (lrst_lin!descuento3 / 100))
                
                ldblDtos_Total = ldblDtos_Total + Round(((ldblPrecio - ldblPrecio_Con_Dto) * lrst_lin!Cant_Prod * lrst_lin!cajas), 2)
                ldblSubTotal = ldblSubTotal + (ldblPrecio_Con_Dto * lrst_lin!Cant_Prod * lrst_lin!cajas)
                lrst_lin.MoveNext
            Loop
            ldblDto_Global = Round(ldblSubTotal * (lrst_cab!dto_global / 100), 2)
            ldblDtos_Total = ldblDtos_Total + ldblDto_Global
        End If
        
        SQL = "Insert into " & gNombre_Tabla_Temporal & " values ("
        SQL = SQL & lrst_cab!Cod_Emp & ","
        SQL = SQL & lrst_cab!cod_doc & ","
        SQL = SQL & lrst_cab!nro_doc & ","
        SQL = SQL & lrst_cab!Cod_Prov & ","
        SQL = SQL & lLineas & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_doc, Conf_Motor_Base) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_valor, Conf_Motor_Base) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_ent, Conf_Motor_Base) & ","
        
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 1, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 2, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 2, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 3, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 3, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
                
        SQL = SQL & lCofis1 * (lrst_cab!signo * -1) & ","
        SQL = SQL & lCofis2 * (lrst_cab!signo * -1) & ","
        SQL = SQL & lCofis3 * (lrst_cab!signo * -1) & ","
        SQL = SQL & IIf(IsNull(lrst_cab!dto_global), 0, lrst_cab!dto_global) & ","
        
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & lrst_cab!redondeo_base & ","
            Case "R"
                SQL = SQL & lrst_cab!redondeo_ref & ","
            Case "O"
                SQL = SQL & lrst_cab!redondeo & ","
        End Select
        
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & lrst_cab!Importe_Base * (lrst_cab!signo * -1) & ","
            Case "R"
                SQL = SQL & lrst_cab!importe_ref * (lrst_cab!signo * -1) & ","
            Case "O"
                SQL = SQL & lrst_cab!Importe * (lrst_cab!signo * -1) & ","
        End Select
        
        SQL = SQL & IIf(IsNull(lrst_cab!forma_pago), 0, lrst_cab!forma_pago) & ","
        SQL = SQL & IIf(IsNull(lrst_cab!seccion), 0, lrst_cab!seccion) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_reg, Conf_Motor_Base) & ",'"
        SQL = SQL & lrst_cab!usuario & "',"
        
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 5, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 5, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
                
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & gMoneda_Base & ","
            Case "R"
                SQL = SQL & gMoneda_Referencia & ","
            Case "O"
                SQL = SQL & lrst_cab!moneda & ","
        End Select
        
        SQL = SQL & lrst_cab!cod_suc & ","
        SQL = SQL & "'" & Mid(Trim(lrst_cab!observa), 1, 100) & "',"
        SQL = SQL & ldblSaldo * (lrst_cab!signo * -1) & ","
        SQL = SQL & ldblAjuste_INAC & ",'"
        SQL = SQL & lrst_cab!nom_cli & "',"
        SQL = SQL & ldblDtos_Total & ",'"                ' se agrega campo para dsctos en tabla de reporte    SS 20150730
        SQL = SQL & lrst_cab!Autorizado & "')"           ' se agrega campo autorizados para el reporte        LC 20170123
       
        Dbs.Execute SQL
                
        lrst_lin.Close
        
        lrst_cab.MoveNext
    Wend
    
    lrst_cab.Close
    
    Call esperar_segundos(4)
                                             
    Call Inicializo_Control_Crystal(CrystalReport1)
                                             
    If gTipo_Moneda = "B" Or gTipo_Moneda = "R" Then
    
        If Not pbolSolo_Totales Then
            CrystalReport1.sqlQuery = "SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.nro_doc,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.lineas, zT_Inf_Docs_Digitados_R.fec_doc,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.iva_min, zT_Inf_Docs_Digitados_R.iva_bas, zT_Inf_Docs_Digitados_R.dto_global,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe, zT_Inf_Docs_Digitados_R.iva_vac, "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.moneda,Empresas.descripcion,clientes.rsocial_cli,ma_sucursales_clientes.cod_suc,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "ma_sucursales_clientes.nombre,Moneda_Base.descripcion, Moneda_Base.simbolo,Moneda_Referencia.descripcion,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Moneda_Referencia.simbolo, zT_Inf_Docs_Digitados_R.ajuste_inac,clientes.ruc_cli,clientes.ci_contacto "
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ,FaccmpEfactura.serie, FaccmpEfactura.numero, FaccmpEfactura.tipocae " 'AIR 09/03/2016
            End If
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ,faccmp_cabezal_auxiliar.contrato "
            End If
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From (((("
            
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "(("         'AIR 09/03/2016
            End If
            
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "("        'AIR 28/06/2016
            End If
            
             CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R "
             
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN FaccmpEfactura FaccmpEfactura ON zT_Inf_Docs_Digitados_R.cod_emp = FaccmpEfactura.cod_emp AND"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " zT_Inf_Docs_Digitados_R.cod_doc = FaccmpEfactura.cod_doc AND zT_Inf_Docs_Digitados_R.nro_doc = FaccmpEfactura.nro_doc AND"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " zT_Inf_Docs_Digitados_R.cod_prov = FaccmpEfactura.cod_prov) "
                'AIR 20240515
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN faccmp faccmp ON zT_Inf_Docs_Digitados_R.cod_doc = faccmp.cod_doc and zT_Inf_Docs_Digitados_R.cod_emp = faccmp.cod_emp and zT_Inf_Docs_Digitados_R.nro_doc = faccmp.nro_doc and zT_Inf_Docs_Digitados_R.cod_prov = faccmp.cod_prov)"
            
            End If
            
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN faccmp_cabezal_auxiliar faccmp_cabezal_auxiliar ON zT_Inf_Docs_Digitados_R.cod_emp = faccmp_cabezal_auxiliar.cod_emp AND zT_Inf_Docs_Digitados_R.cod_doc = faccmp_cabezal_auxiliar.cod_doc AND zT_Inf_Docs_Digitados_R.nro_doc = faccmp_cabezal_auxiliar.nro_doc AND zT_Inf_Docs_Digitados_R.cod_prov = faccmp_cabezal_auxiliar.cod_prov)"
            End If
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN clientes clientes ON zT_Inf_Docs_Digitados_R.cod_prov = clientes.nro_cli)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN ma_sucursales_clientes ma_sucursales_clientes ON zT_Inf_Docs_Digitados_R.cod_prov = ma_sucursales_clientes.nro_cli AND zT_Inf_Docs_Digitados_R.cod_suc = ma_sucursales_clientes.cod_suc)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Referencia ON Empresas.moneda_referencia = Moneda_Referencia.codigo)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Base ON Empresas.moneda = Moneda_Base.codigo"
            
            If Not pbolDatos_eFactura Then 'AIR 09/03/2016
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By zT_Inf_Docs_Digitados_R.cod_emp ASC"
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & "," & Trim(gString_Orden)
                End If
            Else
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Order By " & Trim(gString_Orden)
                End If
            
            End If
        Else
        
            CrystalReport1.sqlQuery = "SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.neto_exento, zT_Inf_Docs_Digitados_R.neto_iva_min, zT_Inf_Docs_Digitados_R.iva_min,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.neto_iva_bas, zT_Inf_Docs_Digitados_R.iva_bas, zT_Inf_Docs_Digitados_R.dto_global, zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.neto_iva_vac, zT_Inf_Docs_Digitados_R.iva_vac,documentos.nom_doc_mostrar,Empresas.descripcion, zT_Inf_Docs_Digitados_R.ajuste_inac "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From  (((" & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN documentos ON zT_Inf_Docs_Digitados_R.cod_doc = documentos.cod_doc)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Referencia ON Empresas.moneda_referencia = Moneda_Referencia.codigo)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Base ON Empresas.moneda = Moneda_Base.codigo"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By "
        
            If pbolagrupado Then
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " " & Trim(gString_Orden)
                End If
            Else
                CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Faccmp_Cabezal_Auxiliar.contrato ASC"
            End If
        End If
        
        lParametro = "parUsuario;" & gUsuario & ";TRUE"
        CrystalReport1.ParameterFields(0) = lParametro
    
        If pTipo = "A" Then
            lParametro = "parFiltros; (ANULADOS) " & lstrDescripcion_Filtros & ";TRUE"
        Else
            lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
        End If
        CrystalReport1.ParameterFields(1) = lParametro
    
        lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
        CrystalReport1.ParameterFields(2) = lParametro
        
        lParametro = "parMoneda;" & Trim(gTipo_Moneda) & ";TRUE"
        CrystalReport1.ParameterFields(3) = lParametro
                
        If pTipo = "I" Then
            CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Con_Columna_Ajuste.rpt"
        Else
            If pbolSolo_Totales Then
                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_STotales.rpt"
            Else
                If pbolCon_Netos Then
                    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Con_Netos.rpt"
                Else
                    ' AIR 09/03/2016
                    If pbolDatos_eFactura Then
                        CrystalReport1.ParameterFields(4) = lParametro
                        CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Datos_eFactura_Resumido.rpt"
                    Else
                        If pbolContrato Then
                            CrystalReport1.ParameterFields(4) = lParametro
                            If pbolagrupado Then
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Contrato_MedioPago_Resumido.rpt"
                            Else
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Contrato_MedioPago_Agrupado_x_Contrato_Resumido.rpt"
                            End If
                        Else
                        
                           If pbolObservaciones Then
                               lParametro = "parObserva;" & "S" & ";TRUE"
                               CrystalReport1.ParameterFields(4) = lParametro
                               CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Con_Observacion.rpt" 'SS 20180712
                           Else
                               lParametro = "parObserva;" & "N" & ";TRUE"
                               CrystalReport1.ParameterFields(4) = lParametro
                               If Not pbolMuestraRUT Then
                                   CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido.rpt"
                               Else
                                   CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_ResumidoRUT.rpt"
                               End If
                           End If
                           
                        End If
                    End If
                End If
            End If
        End If
        
        CrystalReport1.Destination = 0
        lresult = CrystalReport1.PrintReport
    
    End If
    
    
    If gTipo_Moneda = "O" Then
    
        If Not pbolSolo_Totales Then
            CrystalReport1.sqlQuery = "SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.nro_doc, "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.lineas, zT_Inf_Docs_Digitados_R.fec_doc, "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.iva_min, zT_Inf_Docs_Digitados_R.iva_bas, zT_Inf_Docs_Digitados_R.cofis_exento,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cofis_min, zT_Inf_Docs_Digitados_R.cofis_bas, zT_Inf_Docs_Digitados_R.dto_global,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe, zT_Inf_Docs_Digitados_R.iva_vac,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.moneda,Empresas.descripcion,clientes.rsocial_cli,Monedas.descripcion,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "ma_sucursales_clientes.cod_suc, ma_sucursales_clientes.nombre, zT_Inf_Docs_Digitados_R.ajuste_inac "
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " , FaccmpEfactura.serie, FaccmpEfactura.numero, FaccmpEfactura.tipocae " 'AIR 09/03/2016
            End If
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " faccmp_cabezal_auxiliar.contrato "
            End If
            
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "From ((("
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "(("
            End If
            
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "("
            End If
            
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R "
            
            If pbolDatos_eFactura Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN FaccmpEfactura FaccmpEfactura ON zT_Inf_Docs_Digitados_R.cod_emp = FaccmpEfactura.cod_emp AND zT_Inf_Docs_Digitados_R.cod_doc = FaccmpEfactura.cod_doc AND zT_Inf_Docs_Digitados_R.nro_doc = FaccmpEfactura.nro_doc) "
                'AIR 20240515
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN faccmp faccmp ON zT_Inf_Docs_Digitados_R.cod_doc = faccmp.cod_doc and zT_Inf_Docs_Digitados_R.cod_emp = faccmp.cod_emp and zT_Inf_Docs_Digitados_R.nro_doc = faccmp.nro_doc and zT_Inf_Docs_Digitados_R.cod_prov = faccmp.cod_prov)"
            End If
            
            If pbolContrato Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN faccmp_cabezal_auxiliar faccmp_cabezal_auxiliar ON zT_Inf_Docs_Digitados_R.cod_emp = faccmp_cabezal_auxiliar.cod_emp AND zT_Inf_Docs_Digitados_R.cod_doc = faccmp_cabezal_auxiliar.cod_doc AND zT_Inf_Docs_Digitados_R.nro_doc = faccmp_cabezal_auxiliar.nro_doc AND zT_Inf_Docs_Digitados_R.cod_prov = faccmp_cabezal_auxiliar.cod_prov)"
            End If

            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN clientes clientes ON "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cod_prov = clientes.nro_cli) LEFT JOIN Monedas Monedas ON "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.moneda = Monedas.codigo) INNER JOIN Empresas Empresas ON "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo) LEFT OUTER JOIN ma_sucursales_clientes ma_sucursales_clientes ON "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cod_prov = ma_sucursales_clientes.nro_cli AND zT_Inf_Docs_Digitados_R.cod_suc = ma_sucursales_clientes.cod_suc "
        
            If Not pbolDatos_eFactura Then
                If pbolagrupado Then
                    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Order By zT_Inf_Docs_Digitados_R.cod_emp ASC, zT_Inf_Docs_Digitados_R.moneda"
                    gString_Orden = Replace(gString_Orden, "zT_Inf_Docs_Digitados_R.moneda ASC", "") ' AIR 20200826 agregue que se quite la moneda porque ya esta considerada antes
                    
                    If Trim(gString_Orden) <> "" Then
                        CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & "," & Trim(gString_Orden)
                    End If
                Else
                    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Order By zT_Inf_Docs_Digitados_R.cod_emp ASC, zT_Inf_Docs_Digitados_R.moneda ASC, Faccmp_Cabezal_Auxiliar.contrato ASC"
                End If
            Else
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Order By zT_Inf_Docs_Digitados_R.moneda ASC"
                gString_Orden = Replace(gString_Orden, "zT_Inf_Docs_Digitados_R.moneda ASC", "") ' AIR 20200826 agregue que se quite la moneda porque ya esta considerada antes
                
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & ", " & Trim(gString_Orden)
                End If
            End If
        Else
            
            CrystalReport1.sqlQuery = "SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc,zT_Inf_Docs_Digitados_R.cod_prov, "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.iva_min, zT_Inf_Docs_Digitados_R.iva_bas, zT_Inf_Docs_Digitados_R.dto_global,"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe, zT_Inf_Docs_Digitados_R.iva_vac, "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "documentos.nom_doc_mostrar,Empresas.descripcion,Monedas.descripcion, zT_Inf_Docs_Digitados_R.ajuste_inac "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From  ((" & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R "
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN documentos documentos ON zT_Inf_Docs_Digitados_R.cod_doc = documentos.cod_doc)"
            CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT JOIN Monedas Monedas ON zT_Inf_Docs_Digitados_R.moneda = Monedas.codigo"
            
            gString_Orden = Replace(gString_Orden, ",zT_Inf_Docs_Digitados_R.moneda ASC", "") ' AIR 20201126 agregue que se quite la moneda porque ya esta considerada antes
            gString_Orden = Replace(gString_Orden, "zT_Inf_Docs_Digitados_R.moneda ASC,", "")
        
            If Trim(gString_Orden) = "" Then
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By zT_Inf_Docs_Digitados_R.cod_emp ASC,zT_Inf_Docs_Digitados_R.moneda ASC,zT_Inf_Docs_Digitados_R.cod_doc ASC,zT_Inf_Docs_Digitados_R.nro_doc ASC"
            Else
                CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Order By zT_Inf_Docs_Digitados_R.moneda," & Trim(gString_Orden)
            End If
            
        End If
        
        lParametro = "parUsuario;" & gUsuario & ";TRUE"
        CrystalReport1.ParameterFields(0) = lParametro
    
        If pTipo = "A" Then
            lParametro = "parFiltros; (ANULADOS) " & lstrDescripcion_Filtros & ";TRUE"
        Else
            lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
        End If
        CrystalReport1.ParameterFields(1) = lParametro
    
        lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
        CrystalReport1.ParameterFields(2) = lParametro
        
        If pTipo = "I" Then
            CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Con_Columna_Ajuste_MO.rpt"
        Else
            If pbolSolo_Totales Then
                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_STotales_MO.rpt"
            Else
                If pbolCon_Netos Then
                    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_MO_Con_Netos.rpt"
                Else
                    ' AIR 09/03/2016
                    If pbolDatos_eFactura Then
                        CrystalReport1.ParameterFields(4) = lParametro
                        CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Datos_eFactura_Resumido_MO.rpt"
                    Else
                        If pbolContrato Then
                            CrystalReport1.ParameterFields(4) = lParametro
                            If pbolagrupado Then
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Contrato_MedioPago_Resumido_MO.rpt"
                            Else
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_con_Contrato_MedioPago_Agrupado_x_Contrato_Resumido_MO.rpt"
                            End If
                        Else
                        
                            If pbolObservaciones Then
                                lParametro = "parObserva;" & "S" & ";TRUE"
                                CrystalReport1.ParameterFields(4) = lParametro
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_Con_Observacion_MO.rpt" 'SS 20180712
                            Else
                                lParametro = "parObserva;" & "N" & ";TRUE"
                                CrystalReport1.ParameterFields(4) = lParametro
                                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Resumido_MO.rpt"
                            End If
                        End If
                    End If
                End If
            End If
        End If
        CrystalReport1.Destination = 0
        lresuct = CrystalReport1.PrintReport
    End If
    
    Unload frmMensaje_Esperar

Exit Function
Errores:
    Call FErrores
    'Resume
End Function

Function Listar_Detalle_Descuento(pstrTitulo As String)
On Error GoTo Errores
    
    Dim lParametro As String
    Dim lrst_cab As Recordset
    Dim lrst_lin As Recordset
    Dim lLineas As Integer
    Dim pSigno_Documento As Integer
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Fecha Documento"
    gfiltros_nombre_campo(3) = "Documento"
    gfiltros_nombre_campo(4) = "Número"
    gfiltros_nombre_campo(5) = "Código Cliente"
    gfiltros_nombre_campo(6) = "Moneda"
    gfiltros_nombre_campo(7) = "Código Artículo"
    gfiltros_nombre_campo(8) = "Código Artículo Anterior"
    gfiltros_nombre_campo(9) = "Descripción Artículo"
    gfiltros_nombre_campo(10) = "Código Proveedor"
    gfiltros_nombre_campo(11) = "Código Dpto.Venta"
    gfiltros_nombre_campo(12) = "Código Marca"
    gfiltros_nombre_campo(13) = "Fecha Registro"
    gfiltros_nombre_campo(14) = "Usuario"
    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.fec_doc"
    gfiltros_campo(3) = "Faccmp.cod_doc"
    gfiltros_campo(4) = "Faccmp.nro_doc"
    gfiltros_campo(5) = "Faccmp.cod_prov"
    gfiltros_campo(6) = "Faccmp.moneda"
    gfiltros_campo(7) = "FaccmpLineas.cod_prod"
    gfiltros_campo(8) = "productos.cod_prod_sistema_ant"
    gfiltros_campo(9) = "productos.nom_prod"
    gfiltros_campo(10) = "productos.cod_prov"
    gfiltros_campo(11) = "productos.dpto"
    gfiltros_campo(12) = "productos.marca"
    gfiltros_campo(13) = "Faccmp.fec_reg"
    gfiltros_campo(14) = "Faccmp.usuario"

    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "F"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "N"
    gfiltros_tipo_campo(7) = "N"
    gfiltros_tipo_campo(8) = "C"
    gfiltros_tipo_campo(9) = "C"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "N"
    gfiltros_tipo_campo(12) = "C"
    gfiltros_tipo_campo(13) = "F"
    gfiltros_tipo_campo(14) = "C"

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    ' Seteo los Defectos del Orden a Listar
    
    gelejir_orden_descripcion(1) = "Fecha Documento"
    gelejir_orden_descripcion(2) = "Documento"
    gelejir_orden_descripcion(3) = "Número"
    gelejir_orden_descripcion(4) = "Cliente"
    gelejir_orden_descripcion(5) = "Fecha Registro"
    gelejir_orden_descripcion(6) = "Usuario"

    gelejir_orden_campo(1) = "Faccmp.fec_doc"
    gelejir_orden_campo(2) = "Faccmp.cod_doc"
    gelejir_orden_campo(3) = "Faccmp.nro_doc"
    gelejir_orden_campo(4) = "Faccmp.cod_prov"
    gelejir_orden_campo(5) = "Faccmp.fec_reg"
    gelejir_orden_campo(6) = "Faccmp.usuario"
    
    gelejir_orden_orden(1) = 1
    gelejir_orden_orden(2) = 2
    gelejir_orden_orden(3) = 3
    
    gelejir_orden_tipo(1) = "A"
    gelejir_orden_tipo(2) = "A"
    gelejir_orden_tipo(3) = "A"
    
    'frmElejir_Orden_para_Listar.Show (1)
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
    'Emision de detalle de descuentos por periodo       SS 20150727 ---------------------------------------------------

    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
    
    CrystalReport1.sqlQuery = "SELECT Faccmp.cod_emp, Faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Faccmp.fec_reg, Faccmp.fec_doc, Faccmp.fec_valor, Faccmp.fec_ent,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Faccmp.importe, Faccmp.dto_global, Faccmp.usuario, Faccmp.con_sin_iva, Faccmp.cod_suc, Faccmp.observa, Faccmp.autorizado,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Faccmp.seccion,FaccmpLineas.nro_linea, FaccmpLineas.cod_prod, FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.descuento1,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "FaccmpLineas.descuento2, FaccmpLineas.cajas, FaccmpLineas.descuento3,Secciones.descripcion, documentos.nom_doc, documentos.signo,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "documentos.tipo_doc,vista_titulares.tipo,ma_sucursales_clientes.nombre, ma_sucursales_clientes.direccion, ma_sucursales_clientes.telefonos,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Monedas.simbolo,productos.nom_prod,Proveedores.dir_prov, Proveedores.rsocial_prov,clientes.rsocial_cli, clientes.dir_cli,ma_Ciudades_Sucursales.nombre,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "ma_Departamentos_Sucursales.nombre,ma_Ciudades_Clientes.nombre,ma_Departamentos_Clientes.nombre,tel_clientes.tel_cli,tel_proveedores.tel_prov,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Faccmp.nro_ven,vendedores.nom_ven, vendedores.ape_ven "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "From (((((((((((((((Faccmp "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN Secciones ON Faccmp.seccion = Secciones.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "INNER JOIN documentos ON Faccmp.cod_doc = documentos.cod_doc) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "INNER JOIN vista_titulares ON Faccmp.cod_prov = vista_titulares.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "INNER JOIN FaccmpLineas ON Faccmp.cod_emp = FaccmpLineas.cod_emp AND Faccmp.cod_doc = FaccmpLineas.cod_doc AND Faccmp.nro_doc = FaccmpLineas.nro_doc AND Faccmp.cod_prov = FaccmpLineas.cod_prov) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "INNER JOIN Monedas ON Faccmp.moneda = Monedas.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN ma_sucursales_clientes ON Faccmp.cod_prov = ma_sucursales_clientes.nro_cli AND Faccmp.cod_suc = ma_sucursales_clientes.cod_suc) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "INNER JOIN productos ON FaccmpLineas.cod_prod = productos.cod_prod) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN clientes ON vista_titulares.codigo = clientes.nro_cli) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN ma_Ciudades ma_Ciudades_Sucursales ON ma_sucursales_clientes.ciudad = ma_Ciudades_Sucursales.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN ma_Departamentos ma_Departamentos_Sucursales ON ma_sucursales_clientes.departamento = ma_Departamentos_Sucursales.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN Proveedores ON vista_titulares.codigo = Proveedores.nro_prov) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN ma_Departamentos ma_Departamentos_Clientes ON clientes.departamento = ma_Departamentos_Clientes.codigo) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN tel_clientes ON clientes.nro_cli = tel_clientes.nro_cli) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN tel_proveedores ON Proveedores.nro_prov = tel_proveedores.nro_prov) "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN ma_Ciudades ma_Ciudades_Clientes ON clientes.ciudad = ma_Ciudades_Clientes.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "LEFT OUTER JOIN vendedores ON Faccmp.nro_ven = vendedores.nro_ven "

    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "WHERE (documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1)) and vista_titulares.tipo='C' "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "AND   (Faccmp.dto_global <> 0 OR FaccmpLineas.descuento1 <> 0 OR FaccmpLineas.descuento2 <> 0 OR FaccmpLineas.descuento3 <> 0) "

    If Trim(lstrFiltros) <> "" Then
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "  AND " & Trim(lstrFiltros)
    End If

    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " ORDER BY Faccmp.cod_emp ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Faccmp.fec_doc ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Faccmp.cod_doc ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " Faccmp.nro_doc ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " FaccmpLineas.nro_linea ASC"
    
    If Busco_Empresa(gCodigo_Empresa) Then
        lParametro = "parEmpresa;" & Trim(rstEmpresas!Descripcion) & " - " & Trim(UCase(confNombre)) & ";TRUE"
    Else
        lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
    End If
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro

    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro

    lParametro = "parTitulo;DOCUMENTOS INGRESADOS - Detalle;TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Digitados_Detallado_Descuentos.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
    'Resume

End Function




Function Listar_Documentos_Pendientes_Grilla(pstrTitulo As String)
On Error GoTo Errores
    
    Dim lParametro As String
    Dim lstrSQL As String
    Dim lstrNombre_Tabla_Temporal As String
    
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Fecha Documento"
    gfiltros_nombre_campo(3) = "Documento Origen"
    gfiltros_nombre_campo(4) = "Número Origen"
    gfiltros_nombre_campo(5) = "Cliente"
    gfiltros_nombre_campo(6) = "Articulo"
    gfiltros_nombre_campo(7) = "Código Sistema Anterior"
    gfiltros_nombre_campo(8) = "Código Familia"
    gfiltros_nombre_campo(9) = "Código Sub-Familia"
    gfiltros_nombre_campo(10) = "Fecha Registro"
    gfiltros_nombre_campo(11) = "Usuario"
    gfiltros_nombre_campo(12) = "Solo Saldos Positivos (S/N)"    ' AIR 20190409 Viasulytop - permite filtrar los saldos pendientes negativos.
    gfiltros_nombre_campo(13) = "Cliente Activo (S/N)"
    gfiltros_nombre_campo(14) = "Código Sucursal"
    gfiltros_nombre_campo(15) = "Sucursal Activa (S/N)"
    gfiltros_nombre_campo(16) = "Depto. de Venta"       'AIR 20201124
          
    gfiltros_campo(1) = "FaccmpLineas_Pendientes.cod_emp"
    gfiltros_campo(2) = "ORIG.fec_doc"
    gfiltros_campo(3) = "FaccmpLineas_Pendientes.cod_doca"
    gfiltros_campo(4) = "FaccmpLineas_Pendientes.nro_doca"
    gfiltros_campo(5) = "FaccmpLineas_Pendientes.cod_prova"
    gfiltros_campo(6) = "FaccmpLineas_Pendientes.cod_proda"
    gfiltros_campo(7) = "Productos.cod_prod_sistema_ant"
    gfiltros_campo(8) = "Productos.codigo_Familia"
    gfiltros_campo(9) = "Productos.codigo_SB_Familia"
    gfiltros_campo(10) = "FaccmpLineas_Pendientes.fec_reg"
    gfiltros_campo(11) = "ORIG.usuario"
    gfiltros_campo(12) = "Tabla_Temporal.cant_prod"
    gfiltros_campo(13) = "clientes.activo"
    gfiltros_campo(14) = "ORIG.cod_suc"
    gfiltros_campo(15) = "ma_sucursales_clientes.activo"
    gfiltros_campo(16) = "Productos.dpto"        'AIR 20201124
    
    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "F"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "N"
    gfiltros_tipo_campo(7) = "C"
    gfiltros_tipo_campo(8) = "C"
    gfiltros_tipo_campo(9) = "C"
    gfiltros_tipo_campo(10) = "F"
    gfiltros_tipo_campo(11) = "C"
    gfiltros_tipo_campo(12) = "C"
    gfiltros_tipo_campo(13) = "C"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "C"
    gfiltros_tipo_campo(16) = "N"       'AIR 20201124

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
    ReDim ListaFormatoImpresion(2)
    ListaFormatoImpresion(0) = "Informe Documentos Pendientes "
    ListaFormatoImpresion(1) = "Informe Documentos Pendientes para Excel "
    ListaFormatoImpresion(2) = "Informe Documentos Pendientes Generado a Archivo CSV "
    FrmSalidaImpresion.Show vbModal

    If FormatoImpresionSeleccionado < 0 Then
        Exit Function
    End If
    
    
    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
    
    lstrNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
    Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal)

    lstrSQL = "SELECT Empresas.codigo AS cod_emp, clientes.nro_cli, ma_sucursales_clientes.cod_suc, productos.cod_prod,"
    lstrSQL = lstrSQL & "SUM(FaccmpLineas_Pendientes.cant_prod) AS cant_prod, productos.codigo_talle, productos.codigo_color, productos.codigo_SB_Familia"
    lstrSQL = lstrSQL & " INTO " & Trim(lstrNombre_Tabla_Temporal)
    lstrSQL = lstrSQL & " FROM ((((((((((FaccmpLineas_Pendientes "
    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas ON FaccmpLineas_Pendientes.cod_emp = FaccmpLineas.cod_emp AND FaccmpLineas_Pendientes.cod_doc = FaccmpLineas.cod_doc AND FaccmpLineas_Pendientes.nro_doc = FaccmpLineas.nro_doc AND FaccmpLineas_Pendientes.cod_prov = FaccmpLineas.cod_prov AND FaccmpLineas_Pendientes.nro_linea = FaccmpLineas.nro_linea)"
    lstrSQL = lstrSQL & " INNER JOIN Faccmp REF ON FaccmpLineas_Pendientes.cod_emp = REF.cod_emp AND FaccmpLineas_Pendientes.cod_doc = REF.cod_doc AND FaccmpLineas_Pendientes.nro_doc = REF.nro_doc AND FaccmpLineas_Pendientes.cod_prov = REF.cod_prov)"
    lstrSQL = lstrSQL & " INNER JOIN Faccmp ORIG ON FaccmpLineas_Pendientes.cod_emp = ORIG.cod_emp AND FaccmpLineas_Pendientes.cod_doca = ORIG.cod_doc AND FaccmpLineas_Pendientes.nro_doca = ORIG.nro_doc AND FaccmpLineas_Pendientes.cod_prova = ORIG.cod_prov)"
    lstrSQL = lstrSQL & " INNER JOIN Empresas ON REF.cod_emp = Empresas.codigo)"
    lstrSQL = lstrSQL & " INNER JOIN ma_sucursales_clientes ON REF.cod_prov = ma_sucursales_clientes.nro_cli AND REF.cod_suc = ma_sucursales_clientes.cod_suc)"
    lstrSQL = lstrSQL & " INNER JOIN productos ON FaccmpLineas.cod_prod = productos.cod_prod)"
    lstrSQL = lstrSQL & " INNER JOIN clientes ON FaccmpLineas.cod_prov = clientes.nro_cli)"
    lstrSQL = lstrSQL & " RIGHT JOIN ma_talles ON productos.codigo_talle = ma_talles.codigo_talle)"
    lstrSQL = lstrSQL & " INNER JOIN ma_colores ON productos.codigo_color = ma_colores.codigo_color)"
    lstrSQL = lstrSQL & " INNER JOIN documentos ON documentos.cod_doc = FaccmpLineas_Pendientes.cod_doca)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_SB_Familias ON productos.codigo_SP_Familia = ma_SB_Familias.codigo_SP_Familia AND productos.codigo_Familia = ma_SB_Familias.codigo_Familia AND productos.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia"

    lstrSQL = lstrSQL & " WHERE ORIG.autorizado = 'S' "
    lstrSQL = lstrSQL & " AND   REF.autorizado = 'S' "
    lstrSQL = lstrSQL & " AND   (documentos.tipo_doc in('E') Or (documentos.tipo_doc = 'P' And documentos.signo = -1))" 'emision y pedidos      SS 20180222

    If lstrFiltros Like "*AND Tabla_Temporal.cant_prod = 'S'*" Then
        
        lstrFiltros = Replace(lstrFiltros, "AND Tabla_Temporal.cant_prod = 'S'", "")
            
        If Trim(lstrFiltros) <> "" Then
            lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
        End If

        lstrSQL = lstrSQL & " GROUP BY Empresas.codigo, clientes.nro_cli, ma_sucursales_clientes.cod_suc, productos.cod_prod,productos.codigo_talle,productos.codigo_color,productos.codigo_SB_Familia"

        lstrSQL = lstrSQL & " HAVING SUM(FaccmpLineas_Pendientes.cant_prod) > 0"
    
    Else
    
        lstrFiltros = Replace(lstrFiltros, "AND Tabla_Temporal.cant_prod = 'N'", "")

        If Trim(lstrFiltros) <> "" Then
            lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
        End If

        lstrSQL = lstrSQL & " GROUP BY Empresas.codigo, clientes.nro_cli, ma_sucursales_clientes.cod_suc, productos.cod_prod, productos.codigo_talle, productos.codigo_color, productos.codigo_SB_Familia"

        lstrSQL = lstrSQL & " HAVING SUM(FaccmpLineas_Pendientes.cant_prod) <> 0"
    End If

    Dbs.Execute lstrSQL
            
    'AIR 20200916 se busca y agregan los talles faltantes por Empresa/Cliente/Sucursal/SubFamilia
    ' creo tabla temporal con todas las Empresa/Cliente/Sucursal/SubFamilia con entregas pendientes
    lstrNombre_Tabla_Temporal_A = f_Nombre_Tabla_Temporal
    lstrNombre_Tabla_Temporal_A = lstrNombre_Tabla_Temporal_A & "_A"
    Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal_A)
    
    lstrSQL = " SELECT cod_emp, nro_cli, cod_suc, codigo_SB_Familia "
    lstrSQL = lstrSQL & " INTO  " & lstrNombre_Tabla_Temporal_A
    lstrSQL = lstrSQL & " FROM " & lstrNombre_Tabla_Temporal
    lstrSQL = lstrSQL & " GROUP by cod_emp, nro_cli, cod_suc, codigo_SB_Familia "
    
    Dbs.Execute lstrSQL
    
    ' AIR se inserta en la tabla temporal los articulo/talle que no estan pendientes de entrega para las tuplas Empresa/Cliente/Sucursal
    ' para que se vean esos talle con cantidad 0  y queden alineados los talles en las columnas del Excel
    lstrSQL = " INSERT into " & lstrNombre_Tabla_Temporal & " (cod_emp, nro_cli, cod_suc, cod_prod , cant_prod , codigo_SB_Familia, codigo_talle, codigo_color) "
    lstrSQL = lstrSQL & " ("
    lstrSQL = lstrSQL & " SELECT cod_emp, nro_cli, cod_suc, cod_prod , 0 as cant_prod , codigo_SB_Familia, codigo_talle, codigo_color"
    lstrSQL = lstrSQL & " FROM "
    lstrSQL = lstrSQL & " (select dd.cod_emp, dd.nro_cli, dd.cod_suc, productos.cod_prod , dd.codigo_SB_Familia, productos.codigo_talle,productos.codigo_color"
    lstrSQL = lstrSQL & " From " & lstrNombre_Tabla_Temporal_A & " dd, productos"
    lstrSQL = lstrSQL & " Where dd.codigo_SB_Familia = productos.codigo_SB_Familia And productos.Cod_Prod"
    lstrSQL = lstrSQL & " NOT IN "
    lstrSQL = lstrSQL & " (select a.cod_prod"
    lstrSQL = lstrSQL & " FROM " & lstrNombre_Tabla_Temporal & " a "
    lstrSQL = lstrSQL & " Where  dd.cod_emp= a.cod_emp and dd.nro_cli = a.nro_cli and dd.cod_suc=a.cod_suc )  )"
    lstrSQL = lstrSQL & " as Pendientes )"
    
    Dbs.Execute lstrSQL
    
    ' AIR 20201009 luego de agregados todos los talles se borran los registros por empresa/clientes/sucursal/familia/ color todos aquellos talles que el total es 0
    
    lstrSQL = " DELETE FROM " & lstrNombre_Tabla_Temporal
    lstrSQL = lstrSQL & " WHERE  codigo_color IN   "  ' --nro_cli=1005 and cod_suc=0 and"
    lstrSQL = lstrSQL & " (   select  codigo_color"
    lstrSQL = lstrSQL & " from " & lstrNombre_Tabla_Temporal & " aa"
    lstrSQL = lstrSQL & " Where aa.cod_suc = " & lstrNombre_Tabla_Temporal & ".cod_suc "
    lstrSQL = lstrSQL & " And aa.nro_cli = " & lstrNombre_Tabla_Temporal & ".nro_cli "
    lstrSQL = lstrSQL & " And aa.Cod_Emp =  " & lstrNombre_Tabla_Temporal & ".Cod_Emp And  " & lstrNombre_Tabla_Temporal & ".codigo_sb_familia = aa.codigo_sb_familia"
    lstrSQL = lstrSQL & " GROUP BY cod_emp,nro_cli, cod_suc, codigo_SB_Familia, codigo_color"
    lstrSQL = lstrSQL & " HAVING Sum(cant_prod) = 0 ) "
    
    Dbs.Execute lstrSQL
    
    CrystalReport1.sqlQuery = "SELECT zT_Informe_Pedidos_Pendientes_x_Articulo.cant_prod,clientes.nro_cli, clientes.rsocial_cli, clientes.nombre_fantasia,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "productos.codigo_talle,Empresas.descripcion,ma_sucursales_clientes.cod_suc, ma_sucursales_clientes.nombre,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "ma_colores.ref_color, ma_colores.descripcion,ma_SB_Familias.codigo_SB_Familia, ma_SB_Familias.descripcion,ma_talles.descripcion"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From ((((((" & Trim(lstrNombre_Tabla_Temporal) & " zT_Informe_Pedidos_Pendientes_x_Articulo "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN productos ON zT_Informe_Pedidos_Pendientes_x_Articulo.cod_prod = productos.cod_prod)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas ON zT_Informe_Pedidos_Pendientes_x_Articulo.cod_emp = Empresas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_sucursales_clientes ON zT_Informe_Pedidos_Pendientes_x_Articulo.nro_cli = ma_sucursales_clientes.nro_cli AND zT_Informe_Pedidos_Pendientes_x_Articulo.cod_suc = ma_sucursales_clientes.cod_suc)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN clientes ON zT_Informe_Pedidos_Pendientes_x_Articulo.nro_cli = clientes.nro_cli)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_colores ON productos.codigo_color = ma_colores.codigo_color)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_talles ON productos.codigo_talle = ma_talles.codigo_talle)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN ma_SB_Familias ON productos.codigo_SP_Familia = ma_SB_Familias.codigo_SP_Familia AND productos.codigo_Familia = ma_SB_Familias.codigo_Familia AND productos.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By ma_SB_Familias.codigo_SB_Familia ASC,clientes.nro_cli ASC,ma_sucursales_clientes.cod_suc Asc"
    
    
    lParametro = "parTitulo;" & "REPORTE ARTICULOS PENDIENTES POR CLIENTE" & ";TRUE"
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro

    lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro
        
    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    Select Case FormatoImpresionSeleccionado
        Case 0
            CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Pendientes_Detallado_Familia.rpt"
        Case 1
            CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Pendientes_Detallado_Familia_Grilla.rpt"
        Case 2
            Call Generar_Archivo(lstrNombre_Tabla_Temporal, lstrDescripcion_Filtros)
    End Select
    If FormatoImpresionSeleccionado <> 2 Then
        CrystalReport1.Destination = 0
        lresult = CrystalReport1.PrintReport
    End If

    
    Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal)
    Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal_A)
    
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
'Resume
End Function



'Function Listar_Documentos_Pendientes_Detallado()
'On Error GoTo Errores
'
'
'    Dim lParametro As String
'    Dim lrst_cab As Recordset
'    Dim lrst_lin As Recordset
'    Dim lLineas As Integer
'    Dim pSigno_Documento As Integer
'    Dim lstrNombre_Tabla_Temporal As String
'    Dim lstrSQL As String
'
'    ' Seteo los Campos para los Filtros
'    Call Limpio_Vectores_Filtros_Orden
'
'    gfiltros_nombre_campo(1) = "Empresa"
'    gfiltros_nombre_campo(2) = "Fecha Documento"
'    gfiltros_nombre_campo(3) = "Documento Original"
'    gfiltros_nombre_campo(4) = "Número Original"
'    gfiltros_nombre_campo(5) = "Cliente"
'    'AIR 20221128
'    gfiltros_nombre_campo(6) = "Deposito"
'    gfiltros_nombre_campo(7) = "Articulo"
'    gfiltros_nombre_campo(8) = "Código Sistema Anterior"
'    gfiltros_nombre_campo(9) = "Código Familia"
'    gfiltros_nombre_campo(10) = "Código Sub-Familia"
'    'AIR 20200724
'    gfiltros_nombre_campo(11) = "Código Sucursal"
'    gfiltros_nombre_campo(12) = "Sucursal Activa (S/N)"
'
'    gfiltros_nombre_campo(13) = "Fecha Registro"
'    gfiltros_nombre_campo(14) = "Usuario"
'
'    gfiltros_campo(1) = "FaccmpLineas_Pendientes.cod_emp"
'    gfiltros_campo(2) = "ORIG.fec_doc"
'    gfiltros_campo(3) = "FaccmpLineas_Pendientes.cod_doca"
'    gfiltros_campo(4) = "FaccmpLineas_Pendientes.nro_doca"
'    gfiltros_campo(5) = "FaccmpLineas_Pendientes.cod_prova"
'    'AIR 20221128
'    gfiltros_campo(6) = "Faccmp_cabezal_auxiliar.deposito"
'    gfiltros_campo(7) = "FaccmpLineas_Pendientes.cod_proda"
'    gfiltros_campo(8) = "Productos.cod_prod_sistema_ant"
'    gfiltros_campo(9) = "Productos.codigo_Familia"
'    gfiltros_campo(10) = "Productos.codigo_SB_Familia"
'
'    'AIR 20200724
'    gfiltros_campo(11) = "ORIG.cod_suc"
'    gfiltros_campo(12) = "ma_sucursales_clientes.activo"
'
'    gfiltros_campo(13) = "FaccmpLineas_Pendientes.fec_reg"
'    gfiltros_campo(14) = "Faccmp.usuario"
'
'    gfiltros_tipo_campo(1) = "N"
'    gfiltros_tipo_campo(2) = "F"
'    gfiltros_tipo_campo(3) = "N"
'    gfiltros_tipo_campo(4) = "N"
'    gfiltros_tipo_campo(5) = "N"
'    gfiltros_tipo_campo(6) = "C"
'    gfiltros_tipo_campo(7) = "N"
'    gfiltros_tipo_campo(8) = "C"
'    gfiltros_tipo_campo(9) = "C"
'    gfiltros_tipo_campo(10) = "C"
'
'    gfiltros_tipo_campo(11) = "N"
'    gfiltros_tipo_campo(12) = "C"
'
'    gfiltros_tipo_campo(13) = "F"
'    gfiltros_tipo_campo(14) = "C"
'
'    frmFiltros_de_campos_para_Listar.Show (1)
'
'    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
'    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
'    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
'
'    DoEvents
'
'    If lbolCancelar_Listado Then
'        Exit Function
'    End If
'
'
'    Call f_esperar(2)
'
'    Call Inicializo_Control_Crystal(CrystalReport1)
'
'    lstrSQL = "SELECT FaccmpLineas_Pendientes.cod_emp, cod_prova, ORIG.fec_doc, FaccmpLineas_Pendientes.cod_doc, "
'    lstrSQL = lstrSQL & " FaccmpLineas_Pendientes.nro_doc, FaccmpLineas_Pendientes.cod_prod, "
'    lstrSQL = lstrSQL & " FaccmpLineas_Pendientes.cant_prod,  "
'
'    lstrSQL = lstrSQL & " Faccmp_cabezal_auxiliar.deposito "   'AIR 20221128
'    lstrSQL = lstrSQL & " FROM (((((((((FaccmpLineas_Pendientes "
'    lstrSQL = lstrSQL & " INNER JOIN Faccmp ORIG ON ORIG.cod_emp = FaccmpLineas_Pendientes.cod_emp "
'    lstrSQL = lstrSQL & " AND ORIG.cod_doc = FaccmpLineas_Pendientes.cod_doca "
'    lstrSQL = lstrSQL & " AND ORIG.nro_doc = FaccmpLineas_Pendientes.nro_doca "
'    lstrSQL = lstrSQL & " AND ORIG.cod_prov = FaccmpLineas_Pendientes.cod_prova)"
'    lstrSQL = lstrSQL & " INNER JOIN Faccmp REF ON REF.cod_emp = FaccmpLineas_Pendientes.cod_emp "
'    lstrSQL = lstrSQL & " AND REF.cod_doc = FaccmpLineas_Pendientes.cod_doc "
'    lstrSQL = lstrSQL & " AND REF.nro_doc = FaccmpLineas_Pendientes.nro_doc "
'    lstrSQL = lstrSQL & " AND REF.cod_prov = FaccmpLineas_Pendientes.cod_prov)"
'
'    'AIR 20221128 se agrega el deposito a Pedido de Lanyvel
'    lstrSQL = lstrSQL & " LEFT JOIN Faccmp_cabezal_auxiliar ON Faccmp_cabezal_auxiliar.cod_emp = FaccmpLineas_Pendientes.cod_emp "
'    lstrSQL = lstrSQL & " AND Faccmp_cabezal_auxiliar.cod_doc = FaccmpLineas_Pendientes.cod_doca "
'    lstrSQL = lstrSQL & " AND Faccmp_cabezal_auxiliar.nro_doc = FaccmpLineas_Pendientes.nro_doca "
'    lstrSQL = lstrSQL & " AND Faccmp_cabezal_auxiliar.cod_prov = FaccmpLineas_Pendientes.cod_prova)"
'
'    'AIR 20200724 se agrega la sucursal a pedido de MENASOL
'    lstrSQL = lstrSQL & " INNER JOIN Empresas ON REF.cod_emp = Empresas.codigo)"
'    lstrSQL = lstrSQL & " LEFT JOIN ma_sucursales_clientes ON REF.cod_prov = ma_sucursales_clientes.nro_cli AND REF.cod_suc = ma_sucursales_clientes.cod_suc)"
'
'    lstrSQL = lstrSQL & " INNER JOIN documentos ON documentos.cod_doc = FaccmpLineas_Pendientes.cod_doc)"
'    lstrSQL = lstrSQL & " LEFT JOIN clientes ON clientes.nro_cli = FaccmpLineas_Pendientes.cod_prov)"
'    lstrSQL = lstrSQL & " LEFT JOIN proveedores ON proveedores.nro_prov = FaccmpLineas_Pendientes.cod_prov)"
'    lstrSQL = lstrSQL & " INNER JOIN productos ON productos.cod_prod = FaccmpLineas_Pendientes.cod_prod)"
'    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas ON FaccmpLineas_Pendientes.cod_emp = FaccmpLineas.cod_emp "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.cod_doc = FaccmpLineas.cod_doc "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.nro_doc = FaccmpLineas.nro_doc "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.cod_prov = FaccmpLineas.cod_prov "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.nro_linea = FaccmpLineas.nro_linea"
'
'    lstrSQL = lstrSQL & " WHERE ORIG.autorizado = 'S' "
'    lstrSQL = lstrSQL & " AND   REF.autorizado = 'S' "
'    lstrSQL = lstrSQL & " AND   (documentos.tipo_doc in('E') Or (documentos.tipo_doc = 'P' And documentos.signo = -1))"
'
'    If Trim(lstrFiltros) <> "" Then
'        lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
'    End If
'
'    lstrSQL = lstrSQL & " ORDER BY FaccmpLineas_Pendientes.cod_emp, FaccmpLineas_Pendientes.cod_prov, "
'    lstrSQL = lstrSQL & " ORIG.fec_doc, FaccmpLineas_Pendientes.cod_doca, FaccmpLineas_Pendientes.nro_doca, "
'    lstrSQL = lstrSQL & " FaccmpLineas_Pendientes.cod_prod, FaccmpLineas_Pendientes.cant_prod DESC"
'
'    CrystalReport1.sqlQuery = lstrSQL
'
'    If Busco_Empresa(gCodigo_Empresa) Then
'        lParametro = "parEmpresa;" & Trim(rstEmpresas!descripcion) & ";TRUE"
'    Else
'        lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
'    End If
'    CrystalReport1.ParameterFields(0) = lParametro
'
'    lParametro = "parUsuario;" & gUsuario & ";TRUE"
'    CrystalReport1.ParameterFields(1) = lParametro
'
'    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
'    CrystalReport1.ParameterFields(2) = lParametro
'
'    lParametro = "parTitulo;DOCUMENTOS PENDIENTES - Detallado;TRUE"
'    CrystalReport1.ParameterFields(3) = lParametro
'
'    lParametro = "parTipoTitular;" & "CLIENTE" & ";TRUE"
'    CrystalReport1.ParameterFields(4) = lParametro
'
'    CrystalReport1.ReportFileName = confCamarchReportes & "Inf_Documentos_Pendientes_Detallado_x_Documento.rpt"
'    CrystalReport1.Destination = 0
'    lresult = CrystalReport1.PrintReport
'
'
'    Unload frmMensaje_Esperar
'
'Exit Function
'
'Errores:
'    Call FErrores
'
'End Function

'Function Listar_Documentos_Pendientes_Agrupado_por_Articulo()
'On Error GoTo Errores
'
'   Dim lParametro As String
'    Dim lrst_cab As Recordset
'    Dim lrst_lin As Recordset
'    Dim lLineas As Integer
'    Dim pSigno_Documento As Integer
'    Dim lstrNombre_Tabla_Temporal As String
'    Dim lstrSQL As String
'
'    ' Seteo los Campos para los Filtros
'    Call Limpio_Vectores_Filtros_Orden
'
'    gfiltros_nombre_campo(1) = "Empresa"
'    gfiltros_nombre_campo(2) = "Fecha Documento"
'    gfiltros_nombre_campo(3) = "Documento Origen"
'    gfiltros_nombre_campo(4) = "Número Origen"
'    gfiltros_nombre_campo(5) = "Cliente"
'    gfiltros_nombre_campo(6) = "Articulo"
'    gfiltros_nombre_campo(7) = "Código Sistema Anterior"
'    gfiltros_nombre_campo(8) = "Código Familia"
'    gfiltros_nombre_campo(9) = "Código Sub-Familia"
'
'    gfiltros_nombre_campo(10) = "Fecha Registro"
'    gfiltros_nombre_campo(11) = "Usuario"
'
'    If pbolFormato_Grilla Then      'Agrega filtros     SS 20190308
'        gfiltros_nombre_campo(12) = "Solo Saldos Positivos (S/N)"    ' AIR 20190409 Viasulytop - permite filtrar los saldos pendientes negativos.
'        gfiltros_nombre_campo(13) = "Cliente Activo (S/N)"
'        gfiltros_nombre_campo(14) = "Código Sucursal"
'        gfiltros_nombre_campo(15) = "Sucursal Activa (S/N)"
'    Else 'AIR 20200724
'        gfiltros_nombre_campo(12) = "Código Sucursal"
'        gfiltros_nombre_campo(13) = "Sucursal Activa (S/N)"
'
'    End If
'
'    gfiltros_campo(1) = "FaccmpLineas_Pendientes.cod_emp"
'    gfiltros_campo(2) = "ORIG.fec_doc"
'    gfiltros_campo(3) = "FaccmpLineas_Pendientes.cod_doca"
'    gfiltros_campo(4) = "FaccmpLineas_Pendientes.nro_doca"
'    gfiltros_campo(5) = "FaccmpLineas_Pendientes.cod_prova"
'    gfiltros_campo(6) = "FaccmpLineas_Pendientes.cod_proda"
'    gfiltros_campo(7) = "Productos.cod_prod_sistema_ant"
'    gfiltros_campo(8) = "Productos.codigo_Familia"
'    gfiltros_campo(9) = "Productos.codigo_SB_Familia"
'    gfiltros_campo(10) = "FaccmpLineas_Pendientes.fec_reg"
'    gfiltros_campo(11) = "ORIG.usuario"
'
'    If pbolFormato_Grilla Then
'        gfiltros_campo(12) = "Tabla_Temporal.cant_prod"
'        gfiltros_campo(13) = "clientes.activo"
'        gfiltros_campo(14) = "ORIG.cod_suc"
'        gfiltros_campo(15) = "ma_sucursales_clientes.activo"
'    Else 'AIR 20200724
'        gfiltros_campo(12) = "ORIG.cod_suc"
'        gfiltros_campo(13) = "ma_sucursales_clientes.activo"
'
'    End If
'
'    gfiltros_tipo_campo(1) = "N"
'    gfiltros_tipo_campo(2) = "F"
'    gfiltros_tipo_campo(3) = "N"
'    gfiltros_tipo_campo(4) = "N"
'    gfiltros_tipo_campo(5) = "N"
'    gfiltros_tipo_campo(6) = "N"
'    gfiltros_tipo_campo(7) = "C"
'    gfiltros_tipo_campo(8) = "C"
'    gfiltros_tipo_campo(9) = "C"
'    gfiltros_tipo_campo(10) = "F"
'    gfiltros_tipo_campo(11) = "C"
'
'    If pbolFormato_Grilla Then
'        gfiltros_tipo_campo(12) = "C"
'        gfiltros_tipo_campo(13) = "C"
'        gfiltros_tipo_campo(14) = "N"
'        gfiltros_tipo_campo(15) = "C"
'    Else 'AIR 20200724
'        gfiltros_tipo_campo(12) = "N"
'        gfiltros_tipo_campo(13) = "C"
'    End If
'
'    frmFiltros_de_campos_para_Listar.Show (1)
'
'    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
'    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
'    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
'
'    DoEvents
'
'    If lbolCancelar_Listado Then
'        Exit Function
'    End If
'
'    ' Seteo los Defectos del Orden a Listar
'
'    gelejir_orden_descripcion(1) = "Fecha Documento"
'    gelejir_orden_descripcion(2) = "Documento"
'    gelejir_orden_descripcion(3) = "Número"
'    gelejir_orden_descripcion(4) = "Cliente"
'    gelejir_orden_descripcion(5) = "Familia"
'    gelejir_orden_descripcion(6) = "Sub-Familia"
'    gelejir_orden_descripcion(7) = "Fecha Registro"
'    gelejir_orden_descripcion(8) = "Usuario"
'
'    gelejir_orden_campo(1) = "ORIG.fec_doc"
'    gelejir_orden_campo(2) = "FaccmpLineas_Pendientes.cod_doca"
'    gelejir_orden_campo(3) = "FaccmpLineas_Pendientes.nro_doca"
'    gelejir_orden_campo(4) = "FaccmpLineas_Pendientes.cod_prova"
'    gelejir_orden_campo(5) = "Productos.codigo_Familia"
'    gelejir_orden_campo(6) = "Productos.codigo_SB_Familia"
'    gelejir_orden_campo(7) = "FaccmpLineas_Pendientes.fec_reg"
'    gelejir_orden_campo(8) = "ORIG.usuario"
'
'    gelejir_orden_orden(1) = 1
'    gelejir_orden_orden(2) = 2
'    gelejir_orden_orden(3) = 3
'
'    gelejir_orden_tipo(1) = "A"
'    gelejir_orden_tipo(2) = "A"
'    gelejir_orden_tipo(3) = "A"
'
'    DoEvents
'
'    If lbolCancelar_Listado Then
'        Exit Function
'    End If
'
'
'    'Emision de detalle de descuentos por periodo       SS 20160210 ---------------------------------------------------
'
'    Call f_esperar(2)
'
'    Call Inicializo_Control_Crystal(CrystalReport1)
'
'    lstrSQL = "SELECT FaccmpLineas_Pendientes.cod_emp, cod_prova, ORIG.fec_doc, FaccmpLineas_Pendientes.cod_doca, "
'    lstrSQL = lstrSQL & " FaccmpLineas_Pendientes.nro_doca, FaccmpLineas_Pendientes.cod_proda, "
'    lstrSQL = lstrSQL & " FaccmpLineas_Pendientes.cant_prod , ORIG.cod_suc "
'    lstrSQL = lstrSQL & " FROM ((((((((FaccmpLineas_Pendientes "
'    lstrSQL = lstrSQL & " INNER JOIN Faccmp ORIG ON ORIG.cod_emp = FaccmpLineas_Pendientes.cod_emp "
'    lstrSQL = lstrSQL & " AND ORIG.cod_doc = FaccmpLineas_Pendientes.cod_doca "
'    lstrSQL = lstrSQL & " AND ORIG.nro_doc = FaccmpLineas_Pendientes.nro_doca "
'    lstrSQL = lstrSQL & " AND ORIG.cod_prov = FaccmpLineas_Pendientes.cod_prova)"
'    lstrSQL = lstrSQL & " INNER JOIN Faccmp REF ON REF.cod_emp = FaccmpLineas_Pendientes.cod_emp "
'    lstrSQL = lstrSQL & " AND REF.cod_doc = FaccmpLineas_Pendientes.cod_doc "
'    lstrSQL = lstrSQL & " AND REF.nro_doc = FaccmpLineas_Pendientes.nro_doc "
'    lstrSQL = lstrSQL & " AND REF.cod_prov = FaccmpLineas_Pendientes.cod_prov)"
'
'    'AIR 20200724 se agrga la sucursal a pedido de MENASOL
'    lstrSQL = lstrSQL & " INNER JOIN Empresas ON REF.cod_emp = Empresas.codigo)"
'    lstrSQL = lstrSQL & " INNER JOIN ma_sucursales_clientes ON REF.cod_prov = ma_sucursales_clientes.nro_cli AND REF.cod_suc = ma_sucursales_clientes.cod_suc)"
'
'    lstrSQL = lstrSQL & " INNER JOIN documentos ON documentos.cod_doc = FaccmpLineas_Pendientes.cod_doca)"
'    lstrSQL = lstrSQL & " LEFT JOIN clientes ON clientes.nro_cli = FaccmpLineas_Pendientes.cod_prova)"
'    lstrSQL = lstrSQL & " LEFT JOIN proveedores ON proveedores.nro_prov = FaccmpLineas_Pendientes.cod_prova)"
'    lstrSQL = lstrSQL & " INNER JOIN productos ON productos.cod_prod = FaccmpLineas_Pendientes.cod_proda)"
'    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas ON FaccmpLineas_Pendientes.cod_emp = FaccmpLineas.cod_emp "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.cod_doc = FaccmpLineas.cod_doc "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.nro_doc = FaccmpLineas.nro_doc "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.cod_prov = FaccmpLineas.cod_prov "
'    lstrSQL = lstrSQL & " AND FaccmpLineas_Pendientes.nro_linea = FaccmpLineas.nro_linea"
'
'    lstrSQL = lstrSQL & " WHERE ORIG.autorizado = 'S' "
'    lstrSQL = lstrSQL & " AND   REF.autorizado = 'S' "
'    lstrSQL = lstrSQL & " AND   (documentos.tipo_doc in('E') Or (documentos.tipo_doc = 'P' And documentos.signo = -1))"
'
'    If Trim(lstrFiltros) <> "" Then
'        lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
'    End If
'
'    lstrSQL = lstrSQL & " ORDER BY FaccmpLineas_Pendientes.cod_emp ASC, cod_prova ASC, "
'    lstrSQL = lstrSQL & " ORIG.fec_doc ASC, cod_doca ASC, nro_doca ASC, nro_lineaa ASC"
'
'    CrystalReport1.sqlQuery = lstrSQL
'
'    If Busco_Empresa(gCodigo_Empresa) Then
'        lParametro = "parEmpresa;" & Trim(rstEmpresas!descripcion) & ";TRUE"
'    Else
'        lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
'    End If
'    CrystalReport1.ParameterFields(0) = lParametro
'
'    lParametro = "parUsuario;" & gUsuario & ";TRUE"
'    CrystalReport1.ParameterFields(1) = lParametro
'
'    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
'    CrystalReport1.ParameterFields(2) = lParametro
'
'    lParametro = "parTitulo;DOCUMENTOS PENDIENTES - Saldo;TRUE"
'    CrystalReport1.ParameterFields(3) = lParametro
'
'    lParametro = "parTipoTitular;" & "CLIENTE" & ";TRUE"
'    CrystalReport1.ParameterFields(4) = lParametro
'
'    CrystalReport1.ReportFileName = confCamarchReportes & "Inf_Documentos_Pendientes_Detallado.rpt"
'    CrystalReport1.Destination = 0
'    lresult = CrystalReport1.PrintReport
'
'
'    Unload frmMensaje_Esperar
'
'Exit Function
'
'Errores:
'    Call FErrores
'
'End Function


Function Listar_Resguardos_Resumen(pstrTitulo As String)
On Error GoTo Errores
    
Dim lParametro As String
Dim lrst_cab As Recordset
Dim lrst_lin As Recordset
Dim lLineas As Integer
Dim pSigno_Documento As Integer
Dim lstrNombre_Tabla_Temporal As String
Dim lstrSQL As String
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Fecha Documento"
    gfiltros_nombre_campo(3) = "Documento"
    gfiltros_nombre_campo(4) = "Número"
    gfiltros_nombre_campo(5) = "Proveedor"
    gfiltros_nombre_campo(6) = "Moneda"
    gfiltros_nombre_campo(7) = "Fecha Registro"
    gfiltros_nombre_campo(8) = "Usuario"
          
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.fec_doc"
    gfiltros_campo(3) = "Faccmp.cod_doc"
    gfiltros_campo(4) = "Faccmp.nro_doc"
    gfiltros_campo(5) = "Faccmp.cod_prov"
    gfiltros_campo(6) = "Faccmp.moneda"
    gfiltros_campo(7) = "Faccmp.fec_reg"
    gfiltros_campo(8) = "Faccmp.usuario"
    
    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "F"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "N"
    gfiltros_tipo_campo(7) = "F"
    gfiltros_tipo_campo(8) = "C"

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    ' Seteo los Defectos del Orden a Listar
    
    gelejir_orden_descripcion(1) = "Fecha Documento"
    gelejir_orden_descripcion(2) = "Documento"
    gelejir_orden_descripcion(3) = "Número"
    gelejir_orden_descripcion(4) = "Proveedor"
    gelejir_orden_descripcion(5) = "Fecha Registro"
    gelejir_orden_descripcion(6) = "Usuario"
    
    gelejir_orden_campo(1) = "Faccmp.fec_doc"
    gelejir_orden_campo(2) = "Faccmp.cod_doc"
    gelejir_orden_campo(3) = "Faccmp.nro_doc"
    gelejir_orden_campo(4) = "Faccmp.cod_prov"
    gelejir_orden_campo(5) = "Faccmp.fec_reg"
    gelejir_orden_campo(6) = "Faccmp.usuario"
    
    gelejir_orden_orden(1) = 1
    gelejir_orden_orden(2) = 2
    gelejir_orden_orden(3) = 3
    
    gelejir_orden_tipo(1) = "A"
    gelejir_orden_tipo(2) = "A"
    gelejir_orden_tipo(3) = "A"
    
    frmElejir_Orden_para_Listar.Show (1)
    lbolCancelar_Listado = frmElejir_Orden_para_Listar.pbolCancelar_Listado
    
    DoEvents
        
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
    'Emision de Resguardos                  SS 20190510 ---------------------------------------------------

    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
        
    lstrSQL = "SELECT Faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Faccmp.fec_doc, Faccmp.moneda, Faccmp.importe, Faccmp.usuario, "
    lstrSQL = lstrSQL & "Faccmp.observa, documentos.nom_doc, documentos.signo, Monedas.simbolo, Proveedores.rsocial_prov "
    lstrSQL = lstrSQL & " FROM Faccmp "
    lstrSQL = lstrSQL & " INNER JOIN documentos documentos ON documentos.cod_doc = Faccmp.cod_doc "
    lstrSQL = lstrSQL & " INNER JOIN proveedores ON proveedores.nro_prov = Faccmp.cod_prov "
    lstrSQL = lstrSQL & " INNER JOIN Monedas ON Monedas.codigo = Faccmp.moneda "
    lstrSQL = lstrSQL & " LEFT OUTER JOIN FaccmpEfactura ON FaccmpEfactura.cod_emp = Faccmp.cod_emp AND FaccmpEfactura.cod_doc = Faccmp.cod_doc "
    lstrSQL = lstrSQL & " AND FaccmpEfactura.nro_doc = Faccmp.nro_doc AND FaccmpEfactura.cod_prov = Faccmp.cod_prov "
    
    lstrSQL = lstrSQL & " WHERE documentos.tipo_doc = 'G'"

    If Trim(lstrFiltros) <> "" Then
        lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
    End If
    
    lstrSQL = lstrSQL & " ORDER BY Faccmp.cod_emp ASC, Faccmp.moneda ASC "
    
    If Trim(gString_Orden) <> "" Then
        lstrSQL = lstrSQL & "," & gString_Orden
    End If
    
    CrystalReport1.sqlQuery = Trim(lstrSQL)
        
    If Busco_Empresa(gCodigo_Empresa) Then
        lParametro = "parEmpresa;" & Trim(rstEmpresas!Descripcion) & ";TRUE"
    Else
        lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
    End If
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parTitulo;RESGUARDOS EMITIDOS;TRUE"
    CrystalReport1.ParameterFields(1) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro

    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(3) = lParametro

    lParametro = "parMoneda;" & "O" & ";TRUE"       'envio siempre en moneda origen
    CrystalReport1.ParameterFields(5) = lParametro
            
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Resguardos_Resumen.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores

End Function


Function Listar_Detalle_x_Documento(pstrTitulo As String)
On Error GoTo Errores
    
Dim lstrSQL As String
Dim lParametro As String
Dim lrst_cab As Recordset
Dim lrst_lin As Recordset
Dim lLineas As Integer
Dim pSigno_Documento As Integer
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Documento"
    gfiltros_nombre_campo(3) = "Número"
    gfiltros_nombre_campo(4) = "Cliente"
    gfiltros_nombre_campo(5) = "Fecha Documento"
    gfiltros_nombre_campo(6) = "Fecha Valor"
    gfiltros_nombre_campo(7) = "Fecha Entrega"
    gfiltros_nombre_campo(8) = "Sección"
    gfiltros_nombre_campo(9) = "Forma de Pago"
    gfiltros_nombre_campo(10) = "Vendedor"
    gfiltros_nombre_campo(11) = "Moneda"
    gfiltros_nombre_campo(12) = "Remito"
    gfiltros_nombre_campo(13) = "Guia INAC"
    gfiltros_nombre_campo(14) = "Fecha Registro"
    gfiltros_nombre_campo(15) = "Usuario"

    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_doc"
    gfiltros_campo(3) = "Faccmp.nro_doc"
    gfiltros_campo(4) = "Faccmp.cod_prov"
    gfiltros_campo(5) = "Faccmp.fec_doc"
    gfiltros_campo(6) = "Faccmp.fec_valor"
    gfiltros_campo(7) = "Faccmp.fec_ent"
    gfiltros_campo(8) = "Faccmp.seccion"
    gfiltros_campo(9) = "Faccmp.forma_pago"
    gfiltros_campo(10) = "Faccmp.nro_ven"
    gfiltros_campo(11) = "Faccmp.moneda"
    gfiltros_campo(12) = "Faccmp.cofismin"
    gfiltros_campo(13) = "Faccmp.cofisexento"
    gfiltros_campo(14) = "Faccmp.fec_reg"
    gfiltros_campo(15) = "Faccmp.usuario"


    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "F"
    gfiltros_tipo_campo(6) = "F"
    gfiltros_tipo_campo(7) = "F"
    gfiltros_tipo_campo(8) = "N"
    gfiltros_tipo_campo(9) = "N"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "N"
    gfiltros_tipo_campo(12) = "N"
    gfiltros_tipo_campo(13) = "N"
    gfiltros_tipo_campo(14) = "F"
    gfiltros_tipo_campo(15) = "C"


    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    ' Seteo los Defectos del Orden a Listar
    
    gelejir_orden_descripcion(1) = "Documento"
    gelejir_orden_descripcion(2) = "Número"
    gelejir_orden_descripcion(3) = "Cliente"
    gelejir_orden_descripcion(4) = "Fecha Documento"
    gelejir_orden_descripcion(5) = "Fecha Valor"
    gelejir_orden_descripcion(6) = "Fecha Entrega"
    gelejir_orden_descripcion(7) = "Sección"
    gelejir_orden_descripcion(8) = "Forma Pago"
    gelejir_orden_descripcion(9) = "Vendedor"
    gelejir_orden_descripcion(10) = "Fecha Registro"
    gelejir_orden_descripcion(11) = "Usuario"
    
    gelejir_orden_campo(1) = "Faccmp.cod_doc"
    gelejir_orden_campo(2) = "Faccmp.nro_doc"
    gelejir_orden_campo(3) = "Faccmp.cod_prov"
    gelejir_orden_campo(4) = "Faccmp.fec_doc"
    gelejir_orden_campo(5) = "Faccmp.fec_valor"
    gelejir_orden_campo(6) = "Faccmp.fec_ent"
    gelejir_orden_campo(7) = "Faccmp.seccion"
    gelejir_orden_campo(8) = "Faccmp.forma_pago"
    gelejir_orden_campo(9) = "Faccmp.nro_ven"
    gelejir_orden_campo(10) = "Faccmp.fec_reg"
    gelejir_orden_campo(11) = "Faccmp.usuario"
    
    gelejir_orden_orden(1) = 1
    gelejir_orden_orden(2) = 2
    gelejir_orden_orden(3) = 3
    
    gelejir_orden_tipo(1) = "A"
    gelejir_orden_tipo(2) = "A"
    gelejir_orden_tipo(3) = "A"
    
    frmElejir_Orden_para_Listar.Show (1)
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
    
    lstrSQL = "SELECT Faccmp.cod_emp, Faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Faccmp.fec_reg, Faccmp.fec_doc, Faccmp.fec_valor, "
    lstrSQL = lstrSQL & "Faccmp.fec_ent, Faccmp.importe, Faccmp.dto_global, Faccmp.usuario, Faccmp.con_sin_iva, "
    lstrSQL = lstrSQL & "Faccmp.cod_suc, Faccmp.observa, Faccmp.autorizado, Faccmp.seccion,FaccmpLineas.nro_linea, "
    lstrSQL = lstrSQL & "FaccmpLineas.cod_prod, FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.descuento1,"
    lstrSQL = lstrSQL & "FaccmpLineas.descuento2, FaccmpLineas.cajas, FaccmpLineas.descuento3, documentos.nom_doc, "
    lstrSQL = lstrSQL & "documentos.signo, documentos.tipo_doc,vista_titulares.tipo, Monedas.simbolo, "
    lstrSQL = lstrSQL & "productos.nom_prod,Proveedores.dir_prov, Proveedores.rsocial_prov,clientes.rsocial_cli, "
    lstrSQL = lstrSQL & "clientes.dir_cli, FaccmpDescripciones.descripcion "
    
    lstrSQL = lstrSQL & " FROM ((((((((((((((((((((Faccmp "
    lstrSQL = lstrSQL & " INNER JOIN Secciones Secciones ON Faccmp.seccion = Secciones.codigo) "
    lstrSQL = lstrSQL & " INNER JOIN documentos documentos ON Faccmp.cod_doc = documentos.cod_doc)"
    lstrSQL = lstrSQL & " INNER JOIN vista_titulares ON Faccmp.cod_prov = vista_titulares.codigo)"
    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas ON Faccmp.cod_emp = FaccmpLineas.cod_emp"
    lstrSQL = lstrSQL & " AND Faccmp.cod_doc = FaccmpLineas.cod_doc"
    lstrSQL = lstrSQL & " AND Faccmp.nro_doc = FaccmpLineas.nro_doc"
    lstrSQL = lstrSQL & " AND Faccmp.cod_prov = FaccmpLineas.cod_prov)"
    ' AIR 20190422
    lstrSQL = lstrSQL & " LEFT OUTER JOIN FaccmpDescripciones ON FaccmpLineas.cod_emp = FaccmpDescripciones.cod_emp AND FaccmpLineas.cod_doc = FaccmpDescripciones.cod_doc AND FaccmpLineas.nro_doc = FaccmpDescripciones.nro_doc AND FaccmpLineas.cod_prov = FaccmpDescripciones.cod_prov AND FaccmpDescripciones.nro_linea = FaccmpLineas.nro_linea) "
    ' AIR 20230222
    lstrSQL = lstrSQL & " LEFT JOIN " & "FaccmpLineas_datos FaccmpLineas_datos ON FaccmpLineas_datos.cod_emp = FaccmpLineas.cod_emp and FaccmpLineas_datos.nro_linea=FaccmpLineas.nro_linea "
    lstrSQL = lstrSQL & " AND FaccmpLineas_datos.cod_doc = FaccmpLineas.cod_doc AND FaccmpLineas_datos.nro_doc = FaccmpLineas.nro_doc AND FaccmpLineas_datos.cod_prov = FaccmpLineas.cod_prov) "
    
    lstrSQL = lstrSQL & " INNER JOIN Faccmp_Cabezal_Auxiliar ON  Faccmp.cod_emp = Faccmp_Cabezal_Auxiliar.cod_emp"
    lstrSQL = lstrSQL & " AND Faccmp.cod_doc = Faccmp_Cabezal_Auxiliar.cod_doc"
    lstrSQL = lstrSQL & " AND Faccmp.nro_doc = Faccmp_Cabezal_Auxiliar.nro_doc"
    lstrSQL = lstrSQL & " AND Faccmp.cod_prov = Faccmp_Cabezal_Auxiliar.cod_prov)"
    lstrSQL = lstrSQL & " INNER JOIN Monedas ON Faccmp.moneda = Monedas.codigo)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN FaccmpEfactura ON FaccmpEfactura.cod_emp = Faccmp.cod_emp AND FaccmpEfactura.cod_doc = Faccmp.cod_doc AND FaccmpEfactura.nro_doc = Faccmp.nro_doc AND FaccmpEfactura.cod_prov = Faccmp.cod_prov) "
    lstrSQL = lstrSQL & " LEFT OUTER JOIN vendedores ON Faccmp.nro_ven = vendedores.nro_ven)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_sucursales_clientes ON Faccmp.cod_prov = ma_sucursales_clientes.nro_cli"
    lstrSQL = lstrSQL & " AND Faccmp.cod_suc = ma_sucursales_clientes.cod_suc)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_Ciudades ma_Ciudades_Sucursales ON ma_sucursales_clientes.ciudad = ma_Ciudades_Sucursales.codigo)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_Departamentos ma_Departamentos_Sucursales ON ma_sucursales_clientes.departamento = ma_Departamentos_Sucursales.codigo)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN clientes ON vista_titulares.codigo = clientes.nro_cli)"
    lstrSQL = lstrSQL & " INNER JOIN productos ON FaccmpLineas.cod_prod = productos.cod_prod)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN Proveedores ON vista_titulares.codigo = Proveedores.nro_prov)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN tel_proveedores ON Proveedores.nro_prov = tel_proveedores.nro_prov)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_Ciudades ma_Ciudades_Clientes ON clientes.ciudad = ma_Ciudades_Clientes.codigo)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_Departamentos ma_Departamentos_Clientes ON clientes.departamento = ma_Departamentos_Clientes.codigo)"
    lstrSQL = lstrSQL & " LEFT OUTER JOIN tel_clientes ON clientes.nro_cli = tel_clientes.nro_cli)"
    
    ' JE 20250516   /   Se agrego esta linea para
    lstrSQL = lstrSQL & " INNER JOIN vista_Impuestos_Vigentes zt_Impuestos_Porcentaje ON Faccmplineas.nom_prod_aux=zt_Impuestos_Porcentaje.cod_impuesto AND zt_Impuestos_Porcentaje.cod_tipo_impuesto = 'IVA'"
    
    lstrSQL = lstrSQL & " WHERE (documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1)) and vista_titulares.tipo='C'"

    If Trim(lstrFiltros) <> "" Then
        lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
    End If
    
    lstrSQL = lstrSQL & " ORDER BY Faccmp.cod_emp ASC,"
    lstrSQL = lstrSQL & " Faccmp.cod_doc ASC,"
    lstrSQL = lstrSQL & " Faccmp.nro_doc ASC,"
    lstrSQL = lstrSQL & " Faccmp.cod_prov ASC,"
    lstrSQL = lstrSQL & " FaccmpLineas.nro_linea ASC"
    
    CrystalReport1.sqlQuery = Trim(lstrSQL)
    
    If Busco_Empresa(gCodigo_Empresa) Then
        lParametro = "parEmpresa;" & Trim(rstEmpresas!Descripcion) & " - " & Trim(UCase(confNombre)) & ";TRUE"
    Else
        lParametro = "parEmpresa;" & Trim(confNombre) & ";TRUE"
    End If
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro

    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro

    lParametro = "parTitulo;DOCUMENTOS INGRESADOS - Detalle;TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    If ConfReporte_Con_Codigo_Articulo_Anterior Then
        lParametro = "parArticuloAnterior;S;TRUE"
    Else
        lParametro = "parArticuloAnterior;N;TRUE"
    End If
    CrystalReport1.ParameterFields(4) = lParametro
    
    'AIR 20230222 nuevo parametro agregado al rpt
    If confUsaEquivalenciaMagnitudes Then
        lParametro = "parEquivalencia;S;TRUE"
    Else
        lParametro = "parEquivalencia;N;TRUE"
    End If
    CrystalReport1.ParameterFields(5) = lParametro
    
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Digitados_Detallado_NEW.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
   ' Resume


End Function


Function Listar_Totales_x_Articulo(pstrTitulo As String)
On Error GoTo Errores
    
    Dim lParametro As String
    Dim lrst_cab As Recordset
    Dim lrst_lin As Recordset
    Dim lLineas As Integer
    Dim pSigno_Documento As Integer
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Documento"
    gfiltros_nombre_campo(3) = "Número"
    gfiltros_nombre_campo(4) = "Cliente"
    gfiltros_nombre_campo(5) = "Fecha Documento"
    gfiltros_nombre_campo(6) = "Fecha Cble."
    gfiltros_nombre_campo(7) = "Fecha Entrega"
    gfiltros_nombre_campo(8) = "Código Artículo"
    gfiltros_nombre_campo(9) = "Nombre Artículo"
    gfiltros_nombre_campo(10) = "Proveedor"
    gfiltros_nombre_campo(11) = "Sección"
    gfiltros_nombre_campo(12) = "Vendedor"
    gfiltros_nombre_campo(13) = "Moneda"
    gfiltros_nombre_campo(14) = "Remito"
    gfiltros_nombre_campo(15) = "Guia INAC"
    gfiltros_nombre_campo(16) = "Fecha Registro"
    gfiltros_nombre_campo(17) = "Usuario"
    gfiltros_nombre_campo(18) = "Sucursal"

    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_doc"
    gfiltros_campo(3) = "Faccmp.nro_doc"
    gfiltros_campo(4) = "Faccmp.cod_prov"
    gfiltros_campo(5) = "Faccmp.fec_doc"
    gfiltros_campo(6) = "Faccmp.fec_valor"
    gfiltros_campo(7) = "Faccmp.fec_ent"
    gfiltros_campo(8) = "productos.cod_prod"
    gfiltros_campo(9) = "productos.nom_prod"
    gfiltros_campo(10) = "productos.cod_prov"
    gfiltros_campo(11) = "Faccmp.seccion"
    gfiltros_campo(12) = "Faccmp.nro_ven"
    gfiltros_campo(13) = "Faccmp.moneda"
    gfiltros_campo(14) = "Faccmp.cofismin"
    gfiltros_campo(15) = "Faccmp.cofisexento"
    gfiltros_campo(16) = "Faccmp.fec_reg"
    gfiltros_campo(17) = "Faccmp.usuario"
    gfiltros_campo(18) = "Faccmp.cod_suc"

    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "F"
    gfiltros_tipo_campo(6) = "F"
    gfiltros_tipo_campo(7) = "F"
    gfiltros_tipo_campo(8) = "N"
    gfiltros_tipo_campo(9) = "C"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "N"
    gfiltros_tipo_campo(12) = "N"
    gfiltros_tipo_campo(13) = "N"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "N"
    gfiltros_tipo_campo(16) = "F"
    gfiltros_tipo_campo(17) = "C"
    gfiltros_tipo_campo(18) = "N"

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
        
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
    
    CrystalReport1.sqlQuery = "SELECT Faccmp.cod_emp,FaccmpLineas.cod_prod, FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.descuento1, FaccmpLineas.descuento2, FaccmpLineas.cajas,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "FaccmpLineas.descuento3, FaccmpLineas.moneda,Monedas.descripcion, Monedas.simbolo,Empresas.descripcion,productos.nom_prod"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From (((((Faccmp "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas ON Faccmp.moneda = Monedas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas ON Faccmp.cod_emp = Empresas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN FaccmpLineas ON Faccmp.cod_emp = FaccmpLineas.cod_emp AND Faccmp.cod_doc = FaccmpLineas.cod_doc AND Faccmp.nro_doc = FaccmpLineas.nro_doc AND Faccmp.cod_prov = FaccmpLineas.cod_prov)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN documentos ON Faccmp.cod_doc = documentos.cod_doc)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN vista_titulares ON Faccmp.cod_prov = vista_titulares.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN productos ON FaccmpLineas.cod_prod = productos.cod_prod "

    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " WHERE (documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1)) and vista_titulares.tipo='C' "
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND faccmp.autorizado = 'S' "
'    CrystalReport1.SQLQuery = CrystalReport1.SQLQuery & "WHERE ((documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1) and vista_titulares.tipo='C') "
'    CrystalReport1.SQLQuery = CrystalReport1.SQLQuery & "OR (NOT(documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1)) and vista_titulares.tipo='P'))"

    If Trim(lstrFiltros) <> "" Then
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "  AND " & Trim(lstrFiltros)
    End If

    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " ORDER BY Faccmp.cod_emp ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " FaccmpLineas.moneda ASC,"
    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & " FaccmpLineas.cod_prod ASC"
    
    If Busco_Empresa(gCodigo_Empresa) Then
        lParametro = "parEmpresa;" & Trim(UCase(rstEmpresas!Descripcion)) & ";TRUE"
    Else
        lParametro = "parEmpresa;" & Trim(UCase(confNombre)) & ";TRUE"
    End If
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro

    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro

    lParametro = "parTitulo;EMISION DOCUMENTOS - Totales x Artículos;TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Emitidos_Totales_x_Articulos.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
   ' Resume

End Function


Function Listar_Comparativo_Precio_x_Articulo(pstrTitulo As String)
On Error GoTo Errores
    
    Dim lParametro As String
    Dim lrstF As Recordset
    Dim lrstDoc As Recordset
    Dim PV As Recordset
    
    Dim lstrSQL As String
    Dim SQL As String
    Dim pSigno_Documento As Integer
    Dim lstrNombre_Tabla_Temporal As String
    Dim ldblPrecio As Double
    Dim llngCodLista As Long
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Documento"
    gfiltros_nombre_campo(3) = "Número"
    gfiltros_nombre_campo(4) = "Cliente"
    gfiltros_nombre_campo(5) = "Fecha Documento"
    gfiltros_nombre_campo(6) = "Fecha Cble."
    gfiltros_nombre_campo(7) = "Fecha Entrega"
    gfiltros_nombre_campo(8) = "Código Artículo"
    gfiltros_nombre_campo(9) = "Nombre Artículo"
    gfiltros_nombre_campo(10) = "Proveedor"
    gfiltros_nombre_campo(11) = "Sección"
    gfiltros_nombre_campo(12) = "Vendedor"
    gfiltros_nombre_campo(13) = "Moneda"
    gfiltros_nombre_campo(14) = "Remito"
    gfiltros_nombre_campo(15) = "Guia INAC"
    gfiltros_nombre_campo(16) = "Fecha Registro"
    gfiltros_nombre_campo(17) = "Usuario"
    gfiltros_nombre_campo(18) = "Sucursal"

    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_doc"
    gfiltros_campo(3) = "Faccmp.nro_doc"
    gfiltros_campo(4) = "Faccmp.cod_prov"
    gfiltros_campo(5) = "Faccmp.fec_doc"
    gfiltros_campo(6) = "Faccmp.fec_valor"
    gfiltros_campo(7) = "Faccmp.fec_ent"
    gfiltros_campo(8) = "productos.cod_prod"
    gfiltros_campo(9) = "productos.nom_prod"
    gfiltros_campo(10) = "productos.cod_prov"
    gfiltros_campo(11) = "Faccmp.seccion"
    gfiltros_campo(12) = "Faccmp.nro_ven"
    gfiltros_campo(13) = "Faccmp.moneda"
    gfiltros_campo(14) = "Faccmp.cofismin"
    gfiltros_campo(15) = "Faccmp.cofisexento"
    gfiltros_campo(16) = "Faccmp.fec_reg"
    gfiltros_campo(17) = "Faccmp.usuario"
    gfiltros_campo(18) = "Faccmp.cod_suc"

    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "F"
    gfiltros_tipo_campo(6) = "F"
    gfiltros_tipo_campo(7) = "F"
    gfiltros_tipo_campo(8) = "N"
    gfiltros_tipo_campo(9) = "C"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "N"
    gfiltros_tipo_campo(12) = "N"
    gfiltros_tipo_campo(13) = "N"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "N"
    gfiltros_tipo_campo(16) = "F"
    gfiltros_tipo_campo(17) = "C"
    gfiltros_tipo_campo(18) = "N"

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
        
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
   
    lstrNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
    Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal)
    
    SQL = "SELECT * Into " & Trim(lstrNombre_Tabla_Temporal) & " FROM Zt_Inf_Comparativo_Precio_Ventas where 1=0"
    Dbs.Execute SQL
    
    lstrSQL = "SELECT Faccmp.cod_emp,Faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Faccmp.Tipo_Cambio, Faccmp.Fec_Doc, "
    lstrSQL = lstrSQL & " FaccmpLineas.cod_prod, FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.nro_linea, Empresas.imp_inc_facturador, "
    lstrSQL = lstrSQL & " Faccmp.moneda,Monedas.descripcion, Monedas.simbolo,Empresas.descripcion,productos.nom_prod, faccmplineas.nom_prod_aux, "
    lstrSQL = lstrSQL & " documentos.mueve_merca_serv, documentos.lista_x_defecto, documentos.tipo_lista_x_defecto, clientes.nro_lista, Empresas.nro_lista as nro_listaE "
    lstrSQL = lstrSQL & " From (((((Faccmp "
    lstrSQL = lstrSQL & " INNER JOIN Monedas ON Faccmp.moneda = Monedas.codigo)"
    lstrSQL = lstrSQL & " INNER JOIN Empresas ON Faccmp.cod_emp = Empresas.codigo)"
    lstrSQL = lstrSQL & " INNER JOIN FaccmpLineas ON Faccmp.cod_emp = FaccmpLineas.cod_emp AND Faccmp.cod_doc = FaccmpLineas.cod_doc AND Faccmp.nro_doc = FaccmpLineas.nro_doc AND Faccmp.cod_prov = FaccmpLineas.cod_prov)"
    lstrSQL = lstrSQL & " INNER JOIN documentos ON Faccmp.cod_doc = documentos.cod_doc)"
    lstrSQL = lstrSQL & " INNER JOIN clientes ON Faccmp.cod_prov = clientes.nro_cli)"
    lstrSQL = lstrSQL & " INNER JOIN productos ON FaccmpLineas.cod_prod = productos.cod_prod "
    lstrSQL = lstrSQL & " WHERE (documentos.tipo_doc = 'E' Or (documentos.tipo_doc = 'P' And documentos.signo = -1))  "
    lstrSQL = lstrSQL & " AND faccmp.autorizado = 'S' "
    
    If Trim(lstrFiltros) <> "" Then
        lstrSQL = lstrSQL & "  AND " & Trim(lstrFiltros)
    End If

    lstrSQL = Trim(lstrSQL) & " ORDER BY Faccmp.cod_emp ASC,"
    lstrSQL = Trim(lstrSQL) & " FaccmpLineas.moneda ASC"
    
    Set lrstF = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    
    Do While Not lrstF.EOF
        If lrstF!mueve_merca_serv = "M" Then
            llngCodLista = 0
            If lrstF!lista_x_defecto <> 0 And lrstF!tipo_lista_x_defecto = "V" Then
                llngCodLista = lrstF!lista_x_defecto
            Else
                If lrstF!nro_lista <> 0 Then
                    llngCodLista = lrstF!nro_lista
                End If
            End If
            If llngCodLista = 0 Then
                llngCodLista = lrstF!nro_listaE
            End If
            
        End If

        ldblPrecio = Busco_Precio_Emision(lrstF!Cod_Emp, lrstF!Cod_Prod, lrstF!Cod_Prov, lrstF!cod_doc, llngCodLista, lrstF!moneda, lrstF!Tipo_Cambio, lrstF!fec_doc, ConfPuntoVta_Controla_PMinimo, PV)
        
        'AIR 20171228
        
        If Trim(UCase(lrstF!imp_inc_facturador)) <> "S" Then
          ldblPrecio = Importe_Sin_Impuestos_Vigente(ldblPrecio, lrstF!nom_prod_aux)
        End If
        
        If Round(ldblPrecio, 2) <> Round(lrstF!Precio, 2) Then
        
                SQL = "INSERT INTO " & lstrNombre_Tabla_Temporal
                SQL = SQL & " VALUES(" & lrstF!Cod_Emp & ","
                SQL = SQL & lrstF!cod_doc & ","
                SQL = SQL & lrstF!nro_doc & ","
                SQL = SQL & lrstF!Cod_Prov & ","
                SQL = SQL & f_Fecha_Base(lrstF!fec_doc, Conf_Motor_Base) & ","
                SQL = SQL & lrstF!moneda & ","
                SQL = SQL & lrstF!Tipo_Cambio & ","
                SQL = SQL & llngCodLista & ","
                SQL = SQL & lrstF!nro_linea & ","
                SQL = SQL & lrstF!Cod_Prod & ","
                SQL = SQL & ldblPrecio & ","
                SQL = SQL & lrstF!Precio & ")"
                Dbs.Execute SQL
        Else
        
        End If
        
        lrstF.MoveNext
    Loop

    CrystalReport1.sqlQuery = "SELECT * FROM ((((" & lstrNombre_Tabla_Temporal & "  Zt_Inf_Comparativo_Precio_Ventas"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas ON Zt_Inf_Comparativo_Precio_Ventas.moneda = Monedas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas ON Zt_Inf_Comparativo_Precio_Ventas.cod_emp = Empresas.codigo)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Productos ON Zt_Inf_Comparativo_Precio_Ventas.cod_prod = Productos.cod_prod)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Clientes ON Zt_Inf_Comparativo_Precio_Ventas.cod_prov = Clientes.nro_cli)"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ORDER BY Zt_Inf_Comparativo_Precio_Ventas.cod_emp ASC,Zt_Inf_Comparativo_Precio_Ventas.moneda ASC,"
    CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Zt_Inf_Comparativo_Precio_Ventas.fec_doc,Zt_Inf_Comparativo_Precio_Ventas.cod_doc,Zt_Inf_Comparativo_Precio_Ventas.nro_doc"

    If Busco_Empresa(gCodigo_Empresa) Then
        lParametro = "parEmpresa;" & Trim(UCase(rstEmpresas!Descripcion)) & ";TRUE"
    Else
        lParametro = "parEmpresa;" & Trim(UCase(confNombre)) & ";TRUE"
    End If
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro

    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro

    lParametro = "parTitulo;COMPARATIVO DE PRECIOS DE VENTA - PRECIOS DE LISTA;TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Comparativo_Precios_x_Articulos.rpt"
    CrystalReport1.Destination = 0
    lresult = CrystalReport1.PrintReport
    
    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
   ' Resume

End Function

Sub Marcar_Col(ssdGrilla As SSDBGrid)
    ssdGrilla.ActiveCell.SelStart = 0
    ssdGrilla.ActiveCell.SelLength = Len(ssdGrilla.ActiveCell.text)
End Sub

Function Codigo_Proveedor(CodProd As Long, CodProv As Long) As Boolean
Dim R As Recordset
Codigo_Proveedor = False
SQL = "select * from prodprovee where cod_prod=" & CodProd & " and cod_prov=" & CodProv
Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
If Not R.EOF Then
    Codigo_Proveedor = True
Else
    SQL = "select * from prodprovee where cod_prod=" & CodProd & " and cod_prov=0"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    If Not R.EOF Then
        Codigo_Proveedor = True
    End If
End If
End Function

Public Sub Cargar_Lineas_Factura(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long)
Dim D As Recordset

    If Not Buscar_Tipo_Documento(lCod_Doc, D) Then
        Exit Sub
    End If
    
    If Trim(D!mueve_merca_serv) = "M" Then
        'En los documentos con muchas lineas a cargar, no permitimos tocar los puntos del menu  SS 20200207
        MousePointer = 11
        
        MAlta.visible = False
        MBaja.visible = False
        MConsulta.visible = False
        MModificacion.visible = False
        MListar.visible = False
        MApertura_Cajon.visible = False
        MReimpresion.visible = False
        MAutorizar.visible = False
        MCambios.visible = False
        MVer_Documentos_Afectados.visible = False
        MVer_Asiento_Contable.visible = False
        
        Call Cargar_Lineas_Mercaderia(lcod_emp, lCod_Doc, lNro_Doc, True)
        
        MAlta.visible = True
        MBaja.visible = True
        MConsulta.visible = True
        MModificacion.visible = True
        MListar.visible = True
        MApertura_Cajon.visible = True
        MReimpresion.visible = True
        MAutorizar.visible = True
        MCambios.visible = True
        MVer_Documentos_Afectados.visible = True
        MVer_Asiento_Contable.visible = True

        MousePointer = 1
        
     End If
    
    If Trim(D!mueve_merca_serv) = "S" Then
        Call Cargar_Lineas_Servicios(lcod_emp, lCod_Doc, lNro_Doc, True)
    End If
    
    Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(lcod_emp, lCod_Doc, lNro_Doc, val(txtCodProv.text))
    
End Sub

Public Sub Cargar_Lineas_Mercaderia(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, pbolHabilitar_Boton_Guardar As Boolean)
On Error GoTo Errores

Dim lrstLineas_Descripciones As Recordset
Dim lstrCliente_Aplica_IVA As String
Dim lstrSQL As String
Dim CLI As Recordset
Dim SUC As Recordset
Dim P As Recordset
Dim e As Recordset
Dim TE As Recordset
Dim DE As Recordset
Dim lrstDocum As Recordset

Dim llngCodDocRef As Long
Dim llngNroDocRef As Long
Dim llngNroLineaRef As Long
Dim ldblCantidadSaldo As Double
Dim ldblCantidadEntregada As Double
Dim lstrDeposito As String
Dim llngTotal_Registros As Long
Dim lstrDoc_Aplica_IVA As String
Dim linttiva As Integer
Dim rstDatos As Recordset
Dim M As Recordset
Dim ldblDtoMaximo As Double
Dim lrstMag As Recordset
Dim lequivalencia As Double
Dim lCantidad As Double
Dim lPrecioMinimo As Double



    lstrCliente_Aplica_IVA = "S"

    If Not Buscar_Cliente(txtCodProv.text, CLI) Then
        MsgBox "ERROR: Cliente " & txtCodProv.text & " No Definido en el Sistema. Verifique por favor...", vbCritical
        Exit Sub
    Else
        lstrCliente_Aplica_IVA = Trim(UCase(CLI!aplica_IVA_Ventas))
    End If
    
    If val(TxtCodSuc.text) > 0 Then
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc), SUC) Then
            lstrCliente_Aplica_IVA = Trim(UCase(SUC!aplica_IVA_Ventas))
        End If
    End If
    
    If Not Buscar_Empresa(lcod_emp, e) Then
        MsgBox "ERROR: Empresa " & lcod_emp & " No Definida en el Sistema. Verifique por favor...", vbCritical
        Exit Sub
    End If
    ' AIR 20210719 se pasa a contemplar en la Venta si el documento aplica IVA o no para el caso de zona franca
    lstrDoc_Aplica_IVA = "S"
    If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocum) Then
        If lrstDocum!aplica_iva = "N" Then
            lstrDoc_Aplica_IVA = "N"
        End If
    End If
    
    
    ' AIR 20171008 se agrega la informacion del deposito si tiene por linea
    
    lstrSQL = "SELECT * , D.deposito as deposito_lin FROM FaccmpLineas F "
    lstrSQL = lstrSQL & " LEFT JOIN faccmplineas_Datos D ON "
    lstrSQL = lstrSQL & " F.cod_emp = D.cod_emp "
    lstrSQL = lstrSQL & " AND F.cod_doc =  D.cod_doc "
    lstrSQL = lstrSQL & " AND F.nro_doc =  D.nro_doc "
    lstrSQL = lstrSQL & " AND F.cod_prov = D.cod_prov "
    lstrSQL = lstrSQL & " AND F.nro_linea = D.nro_linea "
    lstrSQL = lstrSQL & " WHERE F.cod_emp = " & lcod_emp
    lstrSQL = lstrSQL & " AND  F.cod_doc = " & lCod_Doc
    lstrSQL = lstrSQL & " AND   F.nro_doc = " & lNro_Doc
    lstrSQL = lstrSQL & " ORDER BY F.nro_linea ASC"
            
    Set rstlineas_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    llngTotal_Registros = rstlineas_documentos.RecordCount
    
    vsfLineas_Mercaderia.Rows = 1
    
    Do While Not rstlineas_documentos.EOF
        
        If Buscar_Articulo(rstlineas_documentos!Cod_Prod, P) Then
            
            vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
            
            vsfLineas_Mercaderia.RowData(vsfLineas_Mercaderia.Rows - 1) = CLng(rstlineas_documentos!Cod_Prod)
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO) = str(rstlineas_documentos!Cod_Prod)
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO_SANTERIOR) = UCase(Trim(P!cod_prod_sistema_ant))
            vsfLineas_Mercaderia.Cell(flexcpBackColor, vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO_SANTERIOR) = &HFFFF&
            
            'Verificamos que la descripcion no haya sido modificada al facturar para casos especiales.
            lDescripcion = f_Busco_Descripcion_Especial(lcod_emp, lCod_Doc, lNro_Doc, rstlineas_documentos!Cod_Prov, rstlineas_documentos!nro_linea, UCase(P!nom_prod))
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DESCRIPCION) = UCase(lDescripcion)
            
            ' AIR 20171008 si la linea tiene deposito se pasa por parametro dicho deposito
            lstrDeposito = IIf(Not IsNull(rstlineas_documentos!deposito_lin), rstlineas_documentos!deposito_lin, txtDeposito.text)
            ' vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = Format(Stock_Linea(lcod_emp, Trim(txtDeposito.Text), CLng(rstlineas_documentos!Cod_Prod), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = Format(Stock_Linea(lcod_emp, Trim(UCase(lstrDeposito)), CLng(rstlineas_documentos!Cod_Prod), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")
            
            If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_STOCK)) <= 0 Then
                vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = &HFF&
                vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = True
            Else
                vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = &H0&
                vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Rows - 1, CGL_STOCK) = False
            End If
            
            ' AIR 20220202 se modifica para que se levante el codigo de iva grabado en el documento, si es valido y no el asociado en el articulo ya que puede haber cambiado y
            ' estaria mostrando un iva que no es el registrado en la factura enviada a DGI.
            If IsNumeric(rstlineas_documentos!nom_prod_aux) Then
            
                linttiva = val(rstlineas_documentos!nom_prod_aux)
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA) = linttiva
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS_IVA) = linttiva
                            

                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS) = Format(0, "#0.00")
          
                                
                If Busco_Impuesto("IVA", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA)) Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(Porcentaje_Impuesto_Vigente("IVA", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA), date), "#0.00")
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(0, "#0.00")
                End If
                
             
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS_IVA) = 0

            
            Else
                If Trim(UCase(lstrCliente_Aplica_IVA)) = "S" Then
                    If lstrDoc_Aplica_IVA = "S" Then
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS) = P!cod_cofis
                        
                        If txtTipo_Doc_Identidad.text = 2 Then      'Aplica el codigo IVA segun condicion de RUT    SS 20190527
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA) = P!cod_iva_ventas_con_rut
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS_IVA) = P!cod_iva_ventas_con_rut
                        Else
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA) = P!cod_iva
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS_IVA) = P!cod_iva
                        End If
                        
                        If Busco_Impuesto("COFIS", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS)) Then
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS) = Format(Porcentaje_Impuesto_Vigente("COFIS", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS), date), "#0.00")
                        Else
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS) = Format(0, "#0.00")
                        End If
                                        
                        If Busco_Impuesto("IVA", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA)) Then
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(Porcentaje_Impuesto_Vigente("IVA", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA), date), "#0.00")
                        Else
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(0, "#0.00")
                        End If
                        
                        If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS)) = 0 Then
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS_IVA) = 0
                        Else
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS_IVA) = Format(Porcentaje_Impuesto_Vigente("COFIS", vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS), date), "#0.00")
                        End If
                    Else
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS) = 1
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA) = 1
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS_IVA) = 1
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS) = Format(0, "#0.00")
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(0, "#0.00")
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS_IVA) = 0
                    End If
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS) = 1
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA) = 1
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TCOFIS_IVA) = 1
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS) = Format(0, "#0.00")
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IVA) = Format(0, "#0.00")
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COFIS_IVA) = 0
                End If
            End If
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES) = Format(rstlineas_documentos!Cant_Prod, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES) = True
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CAJAS) = rstlineas_documentos!cajas
            
            
                        
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES_MAGNITUD) = Format(rstlineas_documentos!Cant_Prod, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES_MAGNITUD) = True
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_MAGNITUD) = P!magnitud
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIO_MAGNITUD) = Format(rstlineas_documentos!Precio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
           
           
            lequivalencia = 1
            If confUsaEquivalenciaMagnitudes Then
                If Buscar_Datos_Linea_Documento(rstlineas_documentos!Cod_Emp, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, rstlineas_documentos!Cod_Prov, rstlineas_documentos!nro_linea, rstDatos) Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES_MAGNITUD) = Format(rstDatos!cant_prod_magnitud, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Rows - 1, CGL_UNIDADES_MAGNITUD) = True
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_MAGNITUD) = rstDatos!magnitud
                    If Buscar_Magnitud(rstDatos!magnitud, M) Then
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_NOMBRE_MAGNITUD) = M!UniMed
                    Else
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_NOMBRE_MAGNITUD) = ""
                    End If
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIO_MAGNITUD) = Format(rstDatos!precio_magnitud, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
               End If
            End If
               
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIO) = Format(rstlineas_documentos!Precio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(lrstDocum!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIO_MAGNITUD), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PUNITARIO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
                
            End If
            
         
            lPrecioMinimo = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ldblDtoMaximo)
            
            lequivalencia = 1
            If confUsaEquivalenciaMagnitudes Then
                If Buscar_Equivalencia(rstlineas_documentos!Cod_Prod, P!magnitud, vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_MAGNITUD), lrstMag) Then
                   lequivalencia = lrstMag!val_equivalencia
                End If
            
               Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, lPrecioMinimo)
            End If
            
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PRECIO_MINIMO) = Format(lPrecioMinimo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DESCUENTO_MAXIMO) = Format(ldblDtoMaximo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            
            
            
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DTO1) = Format(rstlineas_documentos!descuento1, "0.00")
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DTO2) = Format(rstlineas_documentos!descuento2, "0.00")
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DTO3) = Format(rstlineas_documentos!descuento3, "0.00")
                            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_NRO_LINEA) = rstlineas_documentos!nro_linea
            
            ' Veo si hay datos de la Caja y Procedencia en la Tabla FaccmpDescripciones
            
            lstrSQL = "SELECT * FROM FaccmpDescripciones"
            lstrSQL = lstrSQL & " WHERE cod_emp = " & rstlineas_documentos!Cod_Emp
            lstrSQL = lstrSQL & " AND cod_doc = " & rstlineas_documentos!cod_doc
            lstrSQL = lstrSQL & " AND nro_doc = " & rstlineas_documentos!nro_doc
            lstrSQL = lstrSQL & " AND cod_prov = " & rstlineas_documentos!Cod_Prov
            lstrSQL = lstrSQL & " AND nro_linea = " & rstlineas_documentos!nro_linea
        
            Set lrstLineas_Descripciones = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
            If Not lrstLineas_Descripciones.EOF Then
                
                If Not IsNull(lrstLineas_Descripciones!cantidad_cajas) Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CAJAS) = Format(lrstLineas_Descripciones!cantidad_cajas, "0")
                End If
                
                If Not IsNull(lrstLineas_Descripciones!procedencia) Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_PROCEDENCIA) = Trim(UCase(lrstLineas_Descripciones!procedencia))
                End If
                
            End If
        
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_FORMA_PAGO) = rstlineas_documentos!forma_pago
            
            If Busco_Tipo_Entrega_Mercaderia(rstlineas_documentos!tipo_entrega, TE) Then
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIPO_ENTREGA) = Trim(UCase(TE!descripcion_corta))
            Else
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIPO_ENTREGA) = ""
            End If
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_DEPOSITO) = Trim(UCase(lstrDeposito))
            
            ' Busca y carga
            llngCodDocRef = 0
            llngNroDocRef = 0
            llngNroLineaRef = 0
            ldblCantidadSaldo = 0
            ldblCantidadEntregada = 0
            
            Call Buscar_Lineas_Pendientes(rstlineas_documentos!Cod_Emp, rstlineas_documentos!cod_doc, rstlineas_documentos!nro_doc, _
                    rstlineas_documentos!Cod_Prov, rstlineas_documentos!nro_linea, rstlineas_documentos!Cod_Prod, _
                    llngCodDocRef, llngNroDocRef, llngNroLineaRef, ldblCantidadSaldo, ldblCantidadEntregada)
                    
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_COD_DOC_REF) = llngCodDocRef
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_NRO_DOC_REF) = llngNroDocRef
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_NRO_LINEA_REF) = llngNroLineaRef
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CANTIDAD_SALDO) = ldblCantidadSaldo
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CANTIDAD_ENTREGADA) = ldblCantidadEntregada
            
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_TIADIC) = IIf(IsNull(rstlineas_documentos!porc_iadic), 0, rstlineas_documentos!porc_iadic)
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IADIC) = IIf(IsNull(rstlineas_documentos!cod_iadic), 0, rstlineas_documentos!cod_iadic)
            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_IMPORTE_IADIC) = IIf(IsNull(rstlineas_documentos!importe_iadic), 0, rstlineas_documentos!importe_iadic)
            
            Call Calcular_Importes_de_la_Linea_Mercaderia(vsfLineas_Mercaderia.Rows - 1, True, pbolHabilitar_Boton_Guardar)
        End If
        
       
    
        rstlineas_documentos.MoveNext
    Loop
    rstlineas_documentos.Close
    
    Call Total_Unidades
    
    Call Cargo_Grilla_Series
Exit Sub

Errores:
    Call FErrores
    
    Exit Sub
    
End Sub

Function Codigo_Valido(CodProd As Long, txtCodProv As String, txtCodDoc As String) As Boolean
Dim CodProv As Long
Dim Coddoc As Integer
Dim rec As Recordset
Dim Tipo As Integer


If val(txtCodDoc) = 252 Then
    Tipo = Busco_Tipo(CodProd)
    If Tipo <> 80 Then
        MsgBox "Solo se Admiten Articulos con Tipo de Producto 80 (Gastos Externos)", vbExclamation, MsgTit
        Codigo_Valido = False
    Else
        Codigo_Valido = True
    End If
Else
    Codigo_Valido = True
End If

End Function

Sub Muestro_Direccion_Ciudad_Telefono(nro_cli As Long, cod_suc As Long)
On Error GoTo Errores
Dim lstrCiudad As String
Dim lstrTelefonos As String
Dim lstrDireccion As String
Dim R As Recordset

    lbDisplay.Caption = ""
        
    lstrDireccion = f_Direccion_Cliente_Sucursal(nro_cli, cod_suc, gstrDireccion)
    
    lstrTelefonos = f_Telefonos_Cliente_Sucursal(nro_cli, cod_suc)
    
    lstrCiudad = f_Ciudad_Cliente_Sucursal(nro_cli, cod_suc, glngCod_Ciudad)
    
    lbDisplay.Caption = Trim(lstrDireccion) & " - " & Trim(lstrCiudad) & " - " & Trim(lstrTelefonos)
     
    If Buscar_Cliente(nro_cli, R) Then
        If UCase(Trim(R!aplica_IVA_Ventas)) = "N" Then
            lbDisplay.Caption = "CLIENTE NO APLICA IVA VENTAS - " & Trim(lbDisplay.Caption)
        End If
    End If
    
    lbDisplay.Refresh

Exit Sub
Errores:
    Exit Sub

End Sub


Sub Posiciono_en_Pantalla()
Dim RD As Recordset
On Error Resume Next

    If Inicializar_Valores_x_Campos_Programa_Empresa(val(txtEmpresa.text), plngCod_Programa, 0, lcolCampos) Then
        lbolUtilizo_Configuracion_Campos = True
        txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
        If pstrTipo_Ingreso_Documentos = "M" Then
            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
        End If
        If pstrTipo_Ingreso_Documentos = "S" Then
            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
        End If
        If frmPunto_Venta.visible = True Then
            txtCodDoc.SetFocus
        End If
    Else
        lbolUtilizo_Configuracion_Campos = False
        Select Case ConfFormato_Factura
            Case "RONDACROM-POS", "RONDACROM-POS-W98_EPSONFX1050", "RONDACROM-POS-W98_EPSONFX890"
                If ConfElegirEmpresa = True Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                    txtEmpresa.SetFocus
                Else
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                    txtEmpresa.Locked = True
                    txtCodDoc.SetFocus
                End If
            
            Case "RONDACROM-DIS"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                If sspOperacion.Caption = "A" Then
                    Sendkeys "{ENTER}"
                End If
            
            Case "DFLODUR"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
            
            Case "MONTEVIDEOFOODS"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
            
            Case "MBERRUTTI"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                Select Case gCodigo_Empresa
                    Case 1
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    Case 2
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            txtCodDoc.text = ConfDoc_Ingreso_Remito_Cli
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    Case 3
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                End Select
                
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
            
            Case "LCP-LACAMPANA"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "DIBERACO"
                If txtEmpresa.text = "1" Then
                    If lUltimo_Cod_Doc = 0 Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    End If
                End If
                If txtEmpresa.text = "2" Then
                    If lUltimo_Cod_Doc = 0 Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                    
            Case "LORIANO"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
            
            Case "CASINO", "CASINO-POS", "DALTIRO"
                If ConfFormato_Factura = "DALTIRO" Then
                    If lUltimo_Cod_Doc = 0 Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    End If
                Else
                    If ConfFormato_Factura = "CASINO-POS" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        If pstrTipo_Ingreso_Documentos = "M" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                        End If
                        If pstrTipo_Ingreso_Documentos = "S" Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                        End If
                    End If
                    If ConfFormato_Factura = "CASINO" Then
                        If lUltimo_Cod_Doc = 0 Then
                            lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                            If pstrTipo_Ingreso_Documentos = "M" Then
                                lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                            End If
                            If pstrTipo_Ingreso_Documentos = "S" Then
                                lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                            End If
                        End If
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                TxtTCofis.text = "S"
                TxtTCofis.visible = False
                txtEmpresa.Locked = True
                txtFec_Doc.Locked = True
                txtCodDoc.SetFocus
        
            Case "DTODASPARTES_RIVERA", "VILDOX"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "TECNILAN"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "ENVASES_DESCARTABLES"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "HIDRAL"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "PLUS_RENT_A_CAR"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "POLAR_CENTER"
                txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                If pstrTipo_Ingreso_Documentos = "M" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                End If
                If pstrTipo_Ingreso_Documentos = "S" Then
                    txtCodDoc.text = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                End If
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                
            Case "ELECTRONACHO", "DIMAR", "VEICUER", "GARCIALOPEZ", "BARATILLO", "DALKAN", "DUBER", "TATOREPRESENTACIONES", "ENET", "MMARTINEZ", "STAUDINGER", "JAGUILAR", "MILY", "MAVIM", "CARLITOS", "COPISER", "HERTZ", "MERCADO", "AMANECER"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                'Garcia Lopez saca siempre el documento x defecto.
                If ConfFormato_Factura = "DALKAN" Or ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER" Or ConfFormato_Factura = "JAGUILAR" _
                    Or ConfFormato_Factura = "TATOREPRESENTACIONES" Or ConfFormato_Factura = "ENET" _
                    Or ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "ELECTRONACHO" Or ConfFormato_Factura = "DIMAR" Or ConfFormato_Factura = "VEICUER" Or ConfFormato_Factura = "AMANECER" _
                    Or ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ" Or ConfFormato_Factura = "MILY" _
                    Or ConfFormato_Factura = "MAVIM" Or ConfFormato_Factura = "CARLITOS" _
                    Or ConfFormato_Factura = "COPISER" Or ConfFormato_Factura = "HERTZ" Or ConfFormato_Factura = "MERCADO" Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                If ConfElegirEmpresa = True Then
                    txtEmpresa.Locked = False
                    txtEmpresa.SetFocus
                Else
                    txtEmpresa.Locked = True
                    txtCodDoc.SetFocus
                End If
            
            Case "DTODASPARTES_SALINAS"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
                'txtEmpresa.SetFocus
        
            Case "SISNET_ADMINISTRACION"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
        
            Case "BAZAR_LOS_3"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
        
            Case "METALIC"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
        
            Case "PHARMAZONA"
                If lUltimo_Cod_Doc = 0 Then
                    lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    If pstrTipo_Ingreso_Documentos = "M" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Mercaderia_x_Defecto
                    End If
                    If pstrTipo_Ingreso_Documentos = "S" Then
                        lUltimo_Cod_Doc = ConfPuntoVta_Cod_Doc_Servicio_x_Defecto
                    End If
                End If
                txtCodDoc.text = lUltimo_Cod_Doc
                txtEmpresa.Locked = True
                txtCodDoc.SetFocus
        
        End Select
    
    End If
    
    If IsNumeric(txtCodDoc.text) Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), RD) Then
            txtNomDoc_Mostrar.text = RD!nom_doc_mostrar         ' SS 20150917
        End If
    End If
    
End Sub

Function Proceso_Codigo(Dato As String, ByVal pDto1, ByVal pDto2, ByVal pDto3, pPrecio As Double, pTipo_Entrega_Mercaderia As Long, pDeposito As String, pPedidoFactura As Boolean, _
        pCampo As String, pBuscar_x_Codigo_SAnterior As Boolean, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, plngLinea As Long, pCodDocRef As Long, _
        pNroDocRef As Long, pNroLineaRef As Long, pCantidadSaldo As Double, pCantidadEntregada As Double, ByRef pcancelar As Boolean, pdblFactor_Multiplicacion_Unidades As Double, _
        plngColor_Nombre As Long, Optional lMagnitud As Long = -1, Optional pstrNombre_Articulo_Actualizado As String) As Boolean

On Error GoTo Errores

Dim lCod As Long
Dim lstrCodigo As String
Dim lEstado As Integer
Dim lImporte As Double
Dim lPrecio As Double
Dim lPrecio1 As Double
Dim lPrecio_Normal  As Double
Dim lCantidad As Double
Dim lrow As Long
Dim lbolLinea_Nueva As Boolean
Dim lMoneda As Integer
Dim lPrecio_Base As Double
Dim lcosto_base As Double
Dim sigo As Integer
Dim ldblStock_Actual As Double
Dim ldblUnidades_a_Vender As Double
Dim ldblPrecio_Venta As Double
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim ldteFec_Doc_Ultima_Venta As Date
Dim ldblUnidades_Ultima_Venta As Double
Dim ldblPrecio_Ultima_Venta As Double
Dim ldblDescuento1 As Double
Dim ldblDescuento2 As Double
Dim ldblDescuento3 As Double
Dim lhay_equivalencia As Boolean

Dim D As Recordset
Dim e As Recordset
Dim R As Recordset
Dim M As Recordset
Dim CB As Recordset
Dim CLI As Recordset
Dim SUC As Recordset
Dim L As Recordset
Dim TE As Recordset
Dim lrstArticulo As Recordset
Dim lrstFaccmpDescrip As Recordset
Dim PV As Recordset
Dim P As Recordset
Dim RP As Recordset
Dim DE As Recordset
Dim PDV As Recordset
Dim lrstUsuario As Recordset
Dim RST_COD_ANT As Recordset
Dim lrstDocum As Recordset
Dim lrstEstructura As Recordset
Dim lPrecioStock As Double

Dim llngsigno As Long

Dim lbolHay_Imagen As Boolean
Dim lNombreProd As String
Dim sqlProd As String
Dim RDESC As Recordset
Dim lFactorTmp As Double
Dim lstrCliente_Aplica_IVA As String
Dim ldblDescuento_x_Volumen As Double
Dim lstrSQL As String
Dim ldblUnidades_Doc_Afectado As Double
Dim ldblDto_Especial As Double
Dim ldblTotal_Documento_Actual As Double
Dim ldblSaldo_Estado_Cuenta As Double
Dim ldblSaldo_Estado_Cuenta_Con_Importe_Documento As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Lineas As Double
Dim ldblLimite_Credito_MBase As Double
Dim llngLista_Seleccionada As Long
Dim SQL As String
Dim lstrDocumentos_Pendientes_Validos As String
Dim lstrCod_Doc_Afectar As String
Dim lstrDeposito As String                      ' AIR 20171009
Dim llngLin_repetida As Long

Dim lStockReal As Double                        ' AIR 20200213
Dim lstrDoc_Aplica_IVA As String                ' AIR 20210719

Dim lrstMag As Recordset                        'JCH 20220528
Dim lprecioMGM As Double
Dim MA As Recordset
Dim rstMailing As Recordset
Dim cantSugerido As Double
Dim lequivalencia As Double
Dim lPrecioMinimo As Double
Dim ldblDtoMaximo As Double
Dim lMgmArt As Long

Dim pbooNoPermiteDtos As Boolean
Dim prstPrecMailing As Recordset

   
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Or Trim(Dato) = "" Then
        Exit Function
    End If

    lstrCliente_Aplica_IVA = "N"
    lstrDoc_Aplica_IVA = "S"
    
    Proceso_Codigo = True
    lEstado = 0
        
    If Buscar_Cliente(txtCodProv.text, CLI) Then
        lstrCliente_Aplica_IVA = Trim(UCase(CLI!aplica_IVA_Ventas))
    Else
        MsgBox "Error en el Codigo Ingresado", vbCritical, MsgTit
        Proceso_Codigo = False
        Exit Function
    End If
    
'AIR 2021011 se habia agregado este if , se comenta porque no es correcto
'    If Trim(TxtLector) = "" Then
'        Exit Function
'    End If
'
    If val(TxtCodSuc.text) > 0 Then
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc), SUC) Then
            lstrCliente_Aplica_IVA = Trim(UCase(SUC!aplica_IVA_Ventas))
        End If
    End If
    
    
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
    End If
    
    
    gHayDescuentoMailing = False

    llngLista_Seleccionada = val(txtLista.text)
    
    If Not Busco_Lista_Precio(llngLista_Seleccionada, "V", L) Then
        MsgBox "Error: Lista No Existente en el Sistema. Verifique....", vbCritical, MsgTit
        Proceso_Codigo = False
        Exit Function
    Else
        If Trim(UCase(L!se_puede_usar_en_facturador)) = "N" Then
            MsgBox "Error: La Lista NO se puede usar en el Facturador. Verifique....", vbCritical, MsgTit
            Proceso_Codigo = False
            Exit Function
        End If
    End If
    
   
    
    ' Documentos parciales: Control de ingreso de lineas nuevas, se permite si el documento lo acepta           SS 20160209
    If ConfControla_Saldo_Cantidad_Por_Documento Then
      '  If lNombre_Tabla_Temporal <> "" Then  AIR 20190906 comentado porque se puso una flag para el F10                  ' se trajeron lineas de documentos pendientes
        
        If gbln_Cargo_Datos_Desde_F10 = True Then
            If Not pPedidoFactura And pCampo <> "" Then         ' el ingreso de este articulo es manual, no viene de un doc pendiente
                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                    If D!permite_agregar_lineas_detalle = "N" Then
                        MsgBox "Error: El Documento NO admite agregar Nuevos Articulos. Verifique por favor....", vbCritical, MsgTit
                        Proceso_Codigo = False
                        Exit Function
                    End If
                End If
            End If
        End If
    End If
    
          
    If ConfPuntoVta_Ingresa_Codigo_SAnterior And pBuscar_x_Codigo_SAnterior Then
        'Busqueda por codigo de sistema anterior
        If Busco_Producto_x_Codigo_Sistema_Anterior(f_Ins_String(Dato), RST_COD_ANT) Then
            Dato = RST_COD_ANT!Cod_Prod
            
        Else
            ' Reviso si lo ingresado es un codigo de Barras
            If Buscar_Codigo_Barra(Trim(Dato), CB) Then
                Dato = CB!Cod_Prod
            Else
                If Len(Dato) <= 10 Then   ' AIR 20180316 se agrega control porque estaba dando error al ingresar un codigo de barra de largo mayor que no esta registrado en el sistema como tal.
                    If Buscar_Articulo(val(Dato), P) Then
                        Dato = P!Cod_Prod
                    Else
                        MsgBox "Código de Articulo No Existe en el Sistema. Verifique por favor....", vbCritical, MsgTit
                        Proceso_Codigo = False
                        Exit Function
                    End If
                Else
                    MsgBox "Código de Articulo No Existe en el Sistema. Verifique por favor....", vbCritical, MsgTit
                    Proceso_Codigo = False
                    Exit Function
                End If
            End If
        End If
    Else
        'Busqueda por codigo de sistema anterior
        If Trim(Dato) <> "" Then
            If UCase(Mid(Dato, Len(Dato), Len(Dato))) = UCase("+") Then
                Dato = Mid(Dato, 1, Len(Dato) - 1)
                If Busco_Producto_x_Codigo_Sistema_Anterior(f_Ins_String(Dato), RST_COD_ANT) Then
                    Dato = RST_COD_ANT!Cod_Prod
                End If
            End If
        End If
    End If
    
    If Not IsNumeric(Trim(Dato)) Then
        MsgBox "Error en el Codigo Ingresado", vbCritical, MsgTit
        Proceso_Codigo = False
        Exit Function
    Else
        If Mid(Dato, 1, 2) = ConfMan_Articulos_Prefijo_Balanza And Len(Trim(Dato)) >= 6 Then
        
            ' 20170925  JE  / Se agrega estas instrucciones para el manejo de la configuracion del Codigo dentro del Codigo de barra de la Balanza
        
            ' ARTICULO DE BALANZA  - Codigo
            
            Select Case ConfBalanza_Tipo_Codigo
                Case "PPCCCCC"
                    ' 2 Prefijo y 5 Codigo Interno
                    lCod = val(Mid(Dato, 3, 5))
                Case "PPCCCC"
                    ' 2 Prefijo y 4 Codigo Interno
                    lCod = val(Mid(Dato, 3, 4))
                Case Else
                    ' ESTA MAL DEFINIDO EL PARAMETRO
                    MsgBox "Parámetro del Tipo de Código para la Balanza 'BALANZA_TIPO_CODIGO' Mal Configurado. Verifique por Favor....", vbInformation, MsgTit
                    Proceso_Codigo = False
                    Exit Function
            End Select
                
            If Not Busco_Producto(lCod) Then
                MsgBox "Artículo Inexistente. Verifique", vbInformation, MsgTit
                MousePointer = 1
                Proceso_Codigo = False
                Exit Function
            End If
            lEstado = rstProd!estado
            

            ' JE 20171221   /   Se agrega la funcionalidad en base a la varaible ConfBalanza_Precio_Cantidad para configurar si en el codigo de barras
            '                   viene el Precio o la cantidad/unidades
            
            If ConfBalanza_Precio_Cantidad = "P" Then

                ' 20170925  JE  / Se agrega estas instrucciones para el manejo de la configuracion del Importe dentro del Codigo de barra de la Balanza
                
                ' ARTICULO DE BALANZA  - Importe
                
                Select Case ConfBalanza_Tipo_Importe
                    Case "3E2D"
                        ' 3 ENTEROS Y 2 DECIMALES
                        lImporte = val(Mid(Dato, 8, 5)) / 100
                    Case "4E1D"
                        ' 4 ENTEROS Y 1 DECIMALES
                        lImporte = val(Mid(Dato, 8, 5)) / 10
                    Case "4E2D"
                        ' 4 ENTEROS Y 2 DECIMALES
                        lImporte = val(Mid(Dato, 7, 6)) / 100
                    Case Else
                        ' ESTA MAL DEFINIDO EL PARAMETRO
                        MsgBox "Parámetro del Tipo de Importe para la Balanza 'BALANZA_TIPO_IMPORTE' Mal Configurado. Verifique por Favor....", vbInformation, MsgTit
                        Proceso_Codigo = False
                        Exit Function
                End Select
    
                'Tomo el precio normal(que es el que se envia a balanzas) para sacar la cantidad
                If Busco_Precio(lCod, Format(date, "dd/mm/yyyy")) Then
                    lPrecio_Normal = rstPrec!precio_vta
                Else
                    lPrecio_Normal = 0
                End If
                
                'Calculamos la cantidad
                If lPrecio_Normal <> 0 Then
                    lCantidad = (lImporte / lPrecio_Normal) * val(TxtFactor.text)
                Else
                    lCantidad = 1
                End If
                            
                If (confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura Then
                    lPrecio = pPrecio
                Else
                    lPrecio = Busco_Precio_Emision(val(txtEmpresa.text), lCod, val(txtCodProv.text), val(txtCodDoc.text), llngLista_Seleccionada, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                End If
                'AIR 20190604 se agrega para controlar los articulos que tienen moneda en el precio de lista diferente al facturador y no esta permitido para el documento
                If lPrecio = -1 Then
                    MsgBox "El Documento NO Permite Articulos con Lista de Precio en Diferente Moneda al Facturador", vbInformation + vbOKOnly
                    Proceso_Codigo = False
                    pcancelar = True
                    Exit Function
                End If
            End If
            
            If ConfBalanza_Precio_Cantidad = "C" Then
                                 
                ' ARTICULO DE BALANZA  - Cantidad
                                 
                If Not Buscar_Articulo(lCod, lrstArticulo) Then
                    MsgBox "Articulo " & lCod & " No Definido en el Sistema. Verifique por Favor....", vbInformation, MsgTit
                    Proceso_Codigo = False
                    Exit Function
                End If
                
                If Trim(lrstArticulo!modo_bal) = "1" Then
                    ' JE 20180426   /   Si el articulo esta definido con magnitud Gramos no divido entre 1000
                    '                   si viene 0 o cualquier otra magnitud si divide entre cero. (Generalmente se entiende que el precio es en kilos cuando viene de la balanza)
                    If lrstArticulo!magnitud = 3 Then
                        lCantidad = CDbl(Mid(Dato, 8, 5))
                    Else
                        lCantidad = CDbl(Mid(Dato, 8, 5)) / 1000
                    End If
                Else
                    lCantidad = CDbl(Mid(Dato, 8, 5))
                End If
                
                lCantidad = Round(lCantidad, 3)
                

                If (confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura Then
                    lPrecio = pPrecio
                Else
                    lPrecio = Busco_Precio_Emision(val(txtEmpresa.text), lCod, val(txtCodProv.text), val(txtCodDoc.text), llngLista_Seleccionada, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                End If
                'AIR 20190604 se agrega para controlar los articulos que tienen moneda en el precio de lista diferente al facturador y no esta permitido para el documento
                If lPrecio = -1 Then
                    MsgBox "El Documento NO Permite Articulos con Lista de Precio en Diferente Moneda al Facturador", vbInformation + vbOKOnly
                    Proceso_Codigo = False
                    pcancelar = True
                    Exit Function
                End If
                
                lImporte = lPrecio * lCantidad
                                                                                        
            End If
        
        Else
            If Len(Trim(Dato)) > 6 Then
                SQL = "SELECT c.cod_barra, p.* FROM codbarra c, productos p "
                SQL = SQL & " WHERE c.cod_barra ='" & f_Cod_Barra(Trim(Dato)) & "'"
                SQL = SQL & " AND   c.trans <>'S' AND c.cod_prod = p.cod_prod "
                                '"and p.estado<>" & ConfMan_Articulos_Estado_Producto_Eliminado 'se controla mas adelante
                Set B = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                If Not B.EOF Then
                    If Not Busco_Producto(B!Cod_Prod) Then
                        MsgBox "Artículo Inexistente. Verifique", vbInformation, MsgTit
                        MousePointer = 1
                        Proceso_Codigo = False
                        Exit Function
                    Else
                        lCod = rstProd!Cod_Prod
                        lEstado = rstProd!estado
                    End If
                Else
                    MsgBox "Codigo Barra del Artículo Inexistente", vbInformation, MsgTit
                    MousePointer = 1
                    Proceso_Codigo = False
                    Exit Function
                End If
                B.Close
            Else
                If Not Busco_Producto(Trim(Dato)) Then
                    MsgBox "Artículo Inexistente. Verifique", vbInformation, MsgTit
                    MousePointer = 1
                    Proceso_Codigo = False
                    Exit Function
                Else
                    lCod = rstProd!Cod_Prod
                    lEstado = rstProd!estado
                End If
            End If
            
            
            If Not IsNull(rstProd!Deposito) And Not gCargoDesdeF Then
                If Busco_Stk_Deposito(rstProd!Deposito, TE) And confPuntoVta_Inicializar_Deposito_X_Articulo Then
                    pDeposito = rstProd!Deposito
                End If
            End If
                                  
            'Buscar Deposito del articulo

            If (confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura Then
                lPrecio = pPrecio
            Else
                lPrecio = Busco_Precio_Emision(val(txtEmpresa.text), lCod, val(txtCodProv.text), val(txtCodDoc.text), llngLista_Seleccionada, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
            End If
            
            'AIR 20190604 se agrega para controlar los articulos que tienen moneda en el precio de lista diferente al facturador y no esta permitido para el documento
            If lPrecio = -1 Then
                MsgBox "El Documento NO Permite Articulos con Lista de Precio en Diferente Moneda al Facturador", vbInformation + vbOKOnly
                Proceso_Codigo = False
                pcancelar = True
                Exit Function
            End If
            
             'aca va el control mailing
            pbooNoPermiteDtos = True
            If Not confPuntoVta_Realiza_Dtos_Automat_Prec_Mailing Then
                ' JE 20260126   /   Paso Lista del Cabezal para que de el precio de Mailing de la lista
                If Busco_Precio_Mailing(lCod, txtFec_Doc.text, val(txtLista.text), prstPrecMailing) Then
                    If prstPrecMailing!precio_vta = lPrecio Then
                        pbooNoPermiteDtos = False
                    End If
                End If
            End If

            
            
            
            'AIR 20211224 calculo nuevo de cajas por packing
            If Not gCargoDesdeF And rstProd!packing <> 0 And ConfPuntoVta_Ver_Columna_Cajas And ConfPuntoVta_Calcula_Cajas_x_Packing And ConfPuntoVta_Pide_Codigo_Despues_Unidades = True And Not rstProd.EOF And Trim(txtCajas.text) <> "" Then
                If TxtFactor.text <> CDbl(NullToZero(txtCajas.text)) * rstProd!packing And Trim(TxtFactor.text) <> "" Then
                    MsgBox "NO se tomara en cuenta la cantidad de unidades ingresadas , se tomara la cantidad de cajas x la cantidad del packing ", vbInformation + vbOKOnly
                
                End If
                TxtFactor.text = CDbl(NullToZero(txtCajas.text)) * rstProd!packing
                lCantidad = IIf(Trim(TxtFactor.text) = "", 1, val(TxtFactor.text))
            Else
                ' JE 20240718   /   Se controla si viene vacio el campo TxtFactor.text
                lCantidad = IIf(Trim(TxtFactor.text) = "", 1, val(TxtFactor.text))
            End If
            lcantidad_magnitud = lCantidad
            lImporte = lPrecio * lCantidad
        
        End If
        
        If Not gCargoDesdeF And ((Not ConfPuntoVta_Pide_Codigo_Despues_Unidades And Trim(UCase(pCampo)) = "TXTLECTOR") Or (ConfPuntoVta_Pide_Codigo_Despues_Unidades And Trim(UCase(pCampo)) = "TXTFACTOR")) Then
        
            If lCantidad > ConfPuntoVta_Unidades_Maxima_Ingresadas Then
                MsgBox "Error - SE esta superando la cantidad maxima aceptada de unidades por linea  ", vbInformation + vbSystemModal, MsgTit
                Proceso_Codigo = False
                 pcancelar = True
                Exit Function
            End If
        End If
        
        
        ' JE20230629    /   Multiplico la Cantidad hasta aqui por el valor de Multiplicacion (esto por las estructuras que generan lineas en el facturador)
        lCantidad = lCantidad * pdblFactor_Multiplicacion_Unidades
        
        
         'AIR 20210629
        ldblStock_Actual = Stock_Linea(txtEmpresa.text, Trim(pDeposito), lCod, ConfPuntoVta_Recalcula_Stock_On_Line)
        
        If lMagnitud = -1 Then
            lMagnitud = MagnitudVentaxDefecto(lCod)
        End If
        
        
        'ATU 20170419, se controla para VEICUER con una ALERTA si el articulo esta en Documento Pendiente
        If ConfFormato_Factura = "VEICUER" And pCodDocRef = 0 And pNroDocRef = 0 Then

            lstrDocumentos_Pendientes_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento(val(txtCodDoc.text))
        
            If Trim(lstrDocumentos_Pendientes_Validos) <> "" Then
                lstrCod_Doc_Afectar = "Faccmp.cod_doc in (" & lstrDocumentos_Pendientes_Validos & ") "
                'lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', '') <> " & txtCodDoc.text
                'AIR 20220901 se agrega comillas a la query porque estaba comparando un string contra un int y daba desbordamiento
                lstrCod_Doc_Afectar = lstrCod_Doc_Afectar & " AND ltrim(rtrim(REPLACE(STR(FaccmpLineas_Pendientes.cod_doc),' ', '') + REPLACE(STR(FaccmpLineas_Pendientes.nro_doc), ' ', ''))) <> '" & txtCodDoc.text & "'"
        
            Else
                lstrCod_Doc_Afectar = "Faccmp.cod_doc IN ( select cod_doc_valido from ma_Tipos_Docs_Pendientes_Validos where cod_doc IN( select cod_doc from documentos WHERE  tipo_doc = 'E' AND tipo_estado_cta = 'C' AND activo = 'S') AND cod_doc_valido IN( select cod_doc from documentos WHERE  clase='REMITO' AND tipo_doc = 'E' AND activo = 'S')  ) "
            End If
            SQL = "SELECT Faccmp.cod_emp, faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov AS cod_titular, "
            SQL = SQL & " MIN(Faccmp.fec_doc) AS fec_doc, MIN(Faccmp.fec_venc) AS fec_venc, MIN(faccmp.observa) AS observa, "
            SQL = SQL & " MIN(faccmp.dto_global) AS dto_global, MIN(faccmp.importe) AS importe, Documentos.nom_doc as nom_doc, "
            SQL = SQL & " Clientes.rsocial_cli as nom_tit, sum(FaccmpLineas_Pendientes.cant_prod) AS CantArticulos, 0 AS CantLineas "
            SQL = SQL & " FROM Faccmp "
            SQL = SQL & " INNER JOIN Documentos ON documentos.cod_doc = Faccmp.cod_doc "
            SQL = SQL & " INNER JOIN Clientes   ON clientes.nro_cli = Faccmp.cod_prov "
            SQL = SQL & " INNER JOIN FaccmpLineas_Pendientes "
            SQL = SQL & " ON Faccmp.cod_emp = FaccmpLineas_Pendientes.cod_emp AND Faccmp.cod_doc = FaccmpLineas_Pendientes.cod_doca "
            SQL = SQL & " AND Faccmp.nro_doc = FaccmpLineas_Pendientes.nro_doca AND Faccmp.cod_prov = FaccmpLineas_Pendientes.cod_prova "
            SQL = SQL & " WHERE Faccmp.cod_emp = " & val(txtEmpresa.text)
            SQL = SQL & " AND   Faccmp.cod_prov = " & val(txtCodProv.text)
            SQL = SQL & " AND   Faccmp.autorizado = 'S' "
            SQL = SQL & " AND   Faccmp.moneda = " & val(txtMoneda.text)
            SQL = SQL & " AND   FaccmpLineas_Pendientes.cod_prod = " & lCod
            SQL = SQL & " AND   " & lstrCod_Doc_Afectar

            SQL = SQL & " GROUP BY Faccmp.cod_emp, faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Documentos.nom_doc, Clientes.rsocial_cli "
            'SQL = SQL & " HAVING Sum(FaccmpLineas_Pendientes.cant_prod) <> 0  "
            SQL = SQL & " HAVING Sum(FaccmpLineas_Pendientes.cant_prod) >= 0.001 Or Sum(FaccmpLineas_Pendientes.cant_prod) <= -0.001" 'Se cambia porque venia un -0    SS 20191029
            
            'AIR 20200708 se cambia la sintaxis del order by porque daba error en el sql2019
            'SQL = SQL & " ORDER BY Faccmp.fec_doc DESC"
            SQL = SQL & " ORDER BY fec_doc DESC"
            
            'ATU 20170425, si el documento NO tiene documentos referenciados se alerta.
            'Si tiene, se pregunta si se desea seleccionar pero no se agrega manualmente.
            Set RP = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            If Not RP.EOF Then
                If Trim(lstrDocumentos_Pendientes_Validos) <> "" Then
                    sigo = MsgBox("Código de Articulo Pendiente En REMITO " & RP!cod_doc & " / " & RP!nro_doc & ". Desea Seleccionar?", vbYesNo + vbExclamation + vbDefaultButton2, MsgTit)
                    If sigo = vbYes Then
                        If ConfControla_Saldo_Cantidad_Por_Documento = True Then
                            ' Utiliza definicion de doc.pend.definidos en ma_Tipos_Docs_Pendientes_Validos
                            'Call Inicializo_Grilla_Lineas_Mercaderia
                            Call Cargar_Desde_Doc_Pendientes_Definidos(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(TxtCodSuc.text), val(txtMoneda.text))
                        End If
                        MousePointer = 1
                        Proceso_Codigo = False
                        Exit Function
                    Else
                        MousePointer = 1
                        Proceso_Codigo = False
                        Exit Function
                    End If
                Else
                    sigo = MsgBox("Código de Articulo Pendiente En REMITO " & RP!cod_doc & " / " & RP!nro_doc & ". Debe Utilizar el Documento Correspondiente, Desea Continuar?", vbYesNo + vbExclamation + vbDefaultButton2, MsgTit)
                    If sigo = vbNo Then
                        MousePointer = 1
                        Proceso_Codigo = False
                        Exit Function
                    End If
                End If
            End If

        End If
        
        If ConfPuntoVta_Pide_Codigo_Despues_Unidades And Trim(UCase(pCampo)) = "TXTLECTOR" And UCase(GForm) <> "MULTISELECCION" Then
            
            If ConfPuntoVta_Ingresa_Codigo_SAnterior Then
                lstrCodigo = rstProd!cod_prod_sistema_ant
            Else
                lstrCodigo = str(rstProd!Cod_Prod)
            End If
            
            If Buscar_Moneda(val(txtMoneda.text), M) Then
                lbDisplay.Caption = Trim(UCase(lstrCodigo)) & " - " & Trim(rstProd!nom_prod) & " - " & Trim(M!simbolo) & " " & Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            End If
            
            If fraDescuento_x_Volumen.visible Then
                Call Cargo_Grilla_Descuentos_x_Volumen(lCod, CDate(txtFec_Doc.text), val(txtLista.text), lPrecio)       ' JE 20250708   /   parametro nuevo
            End If
        
            If fraEquivalencias_Stock.visible Then
                Cargo_Grilla_Equivalencias_Stock (lCod)
            End If
            
            If lEstado = ConfMan_Articulos_Estado_Producto_Eliminado Then
                MsgBox "El Articulo " & lCod & " Esta INACTIVO y no es Posible Facturarlo", vbInformation, MsgTit
                MousePointer = 1
                Proceso_Codigo = False
                Exit Function
            End If
            
            If Chk_del_Cliente.Value = vbChecked Then
                If Not f_Articulo_del_Cliente(val(lCod), val(txtCodProv.text)) Then
                    MsgBox "El Articulo " & lCod & " no Tiene Lista en el Cliente " & txtCodProv.text, vbInformation, MsgTit
                    MousePointer = 1
                    Proceso_Codigo = False
                    Exit Function
                End If
            End If
            ''''''
            
            'AIR 20230616
            If NullToZero(rstProd!cod_tipo_garantia) <> 0 Then
                SQL = "SELECT * FROM ma_Tipos_Garantia WHERE codigo = " & rstProd!cod_tipo_garantia
                Set lrstGarantias = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                If Not lrstGarantias.EOF Then
                    If lrstGarantias!Descripcion <> "" Then
                        lbDisplay.Caption = "Gtia:" & Trim(lrstGarantias!Descripcion) & " " & lbDisplay.Caption
                    End If
                End If
            End If
                    
            Proceso_Codigo = True
            Exit Function
        End If
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If D!tipo_precio = "0" Then
                ' El Precio Unitario se Inicializa en 0 (cero)
                lPrecio = 0
            End If
        End If
        
        ' JE 20240819   /   Ver si el Precio a colocar es Precio Sin IVA - Tipo Precio en el Documento S
        If D!tipo_precio = "S" Then
            lPrecio = Precio_Venta_SIN_IVA(rstProd!Cod_Prod, lPrecio)
        End If
        
        
        ' Controlar si el Documento Esta configurado para que Controle las lineas ingresas estan en el Documento Afectado
        ' Esto es para las notas de credito que las lineas esten en el documento afectado (factura)
        
        If Trim(UCase(D!controlar_lineas_doc_afectado)) = "S" Then
            
            If Not Controlar_Unidades_Afectadas(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), lCod, lCantidad, vsfLineas_Mercaderia, CGL_UNIDADES, ldblUnidades_Doc_Afectado) Then
                MsgBox "Unidades del Documento Afectado -- " & ldblUnidades_Doc_Afectado & " -- Menor a las Unidades Ingresadas", vbInformation, MsgTit
                MousePointer = 1
                Proceso_Codigo = False
                Exit Function
            End If
        End If
        
        
        'Controlamos el stock
         
        ' AIR 20230713 se pasa la consulta afuera del if
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            llngsigno = D!signo
        Else
            llngsigno = 0
        End If
        
        'Controlamos el stock
        If D!Permite_movimientos_stock_Negativo = "S" Then          ' AIR 20230713
           ' se pasa a utilizar este parametro que existia en el documento y estaba siendo utilizado - Lanyvel
        
        Else
            If (Not pPedidoFactura And ConfPuntoVta_Controla_Stock_Negativo) Or (pPedidoFactura And ConfPuntoVta_Controla_Stock_Negativo_En_Facturacion_Preventas) Then ' SS 20180829
                
                ' Los Articulos Genericos no se controla
                If rstProd!generico <> "S" Then
                
                    ' Los Articulos de Envase los dejo por fuera del control, por ahora... porque generalmente estan en Negativo
                    If rstProd!tipo_prod <> 90 Then
                    
                        'AIR 20171005  pasa por parametro el deposito porque puede tener la linea deposito diferente al cabezal
                        
                        'ldblStock_Actual = Stock_Linea(txtEmpresa.Text, Trim(txtDeposito.Text), lCod, ConfPuntoVta_Recalcula_Stock_On_Line)
                        
                        'AIR 20210629 pasa el calculo de stock a fuera del if
                        'ldblStock_Actual = Stock_Linea(txtEmpresa.text, Trim(pdeposito), lCod, ConfPuntoVta_Recalcula_Stock_On_Line)
                        
                        ' AIR 20230713
'                        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
'                            llngsigno = D!signo
'                        Else
'                            llngsigno = 0
'                        End If
                        
                        If llngsigno < 0 Then
                        
                            ' Documento de Venta
                            
                            ldblUnidades_a_Vender = Calculo_Unidades_Ingresadas_x_Articulo(lCod, 0) + lCantidad
                            
                            If (ldblStock_Actual - ldblUnidades_a_Vender) < 0 Then
                            
                                If ConfPuntoVta_Permite_Venta_Stock_Negativo Then
                                    sigo = MsgBox("ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "Se Esta Vendiendo por Debajo del Stock Actual. " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00") & Chr(13) & "Desea continuar?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                                    If sigo = vbNo Then
                                        MousePointer = 1
                                        Proceso_Codigo = False
                                        Exit Function
                                    Else
                                        ' Chequeo si necesita autorizacion para Vender con Stock Negativo
                                        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                            If Not Autorizacion_Supervision(24, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                MousePointer = 1
                                                Proceso_Codigo = False
                                                Exit Function
                                            End If
                                        End If
                                    End If
                                Else
                                    ' Chequeo ahora si el Deposito Me esta configurado para que se pueda vender con Stock Negativo
                                    'If Not Busco_Stk_Deposito(Trim(txtDeposito.Text), DE) Then
                                    If Not Busco_Stk_Deposito(Trim(pDeposito), DE) Then
                                        MsgBox "ERROR: Deposito No definido en el Sistema. Verifique por favor....", vbCritical + vbOKOnly
                                        MousePointer = 1
                                        Proceso_Codigo = False
                                        Exit Function
                                    End If
                                    
                                    If Trim(UCase(DE!permite_vender_stock_negativo)) <> "S" Then
                                        MsgBox "ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "No Tiene Stock para la Venta " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00"), vbCritical + vbOKOnly, MsgTit
                                        MousePointer = 1
                                        Proceso_Codigo = False
                                        Exit Function
                                    Else
                                        sigo = MsgBox("ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "Se Esta Vendiendo por Debajo del Stock Actual. " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00") & Chr(13) & "Desea continuar?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                                        If sigo = vbNo Then
                                            MousePointer = 1
                                            Proceso_Codigo = False
                                            Exit Function
                                        Else
                                            ' Chequeo si necesita autorizacion para Vender con Stock Negativo
                                            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                                If Not Autorizacion_Supervision(24, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                    MousePointer = 1
                                                    Proceso_Codigo = False
                                                    Exit Function
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
       
        'Controlamos precio debajo del costo
        
        If ConfPuntoVta_Controla_Venta_Menor_PCosto Then
            
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                If D!tipo_precio <> "0" Then
                    ' El Precio Unitario No se Inicializa en 0 (cero)
                
                    If Busco_Costo(lCod, txtFec_Doc.text) Then
                        lcosto_base = Importe_Base(rstPrec!moneda, txtTipo_Cambio.text, txtFec_Doc.text, rstPrec!precio_cto)
                        lPrecio_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, lPrecio)
                        
                        If lPrecio_Base < lcosto_base Then
                            
                            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                If Not Autorizacion_Supervision(23, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                    MsgBox "El Precio de Venta del Artículo es MENOR al COSTO del Sistema. No se Permite el Ingreso...", vbCritical, MsgTit
                                    MousePointer = 1
                                    Proceso_Codigo = False
                                    Exit Function
                                Else
                                    MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR AL DEL COSTO ACTUAL DEL SISTEMA... ", vbCritical, MsgTit
                                End If
                            Else
                                If Busco_Usuario(CStr(gNro_Usuario), lrstUsuario) Then
                                    If lrstUsuario!nivel >= gNivel_Supervisor Then
                                        MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR AL DEL COSTO ACTUAL DEL SISTEMA... ", vbCritical, MsgTit
                                    Else
                                        MsgBox "El Precio de Venta del Artículo es MENOR al COSTO del Sistema. No se Permite el Ingreso...", vbCritical, MsgTit
                                        MousePointer = 1
                                        Proceso_Codigo = False
                                        Exit Function
                                    End If
                                Else
                                    MsgBox "El Precio de Venta del Artículo es MENOR al COSTO del Sistema. No se Permite el Ingreso...", vbCritical, MsgTit
                                    MousePointer = 1
                                    Proceso_Codigo = False
                                    Exit Function
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
        
        If ConfPuntoVta_Controla_Devolucion_Mercaderia_x_Doc Then
            ' Verifico que el Documento Actual sea Nota de Credito/Debito
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                If D!signo > 0 Then
                    ' Documento de Devolucion
                    ' Busco la ultima venta de este articulo. Si fue en un Documento que no puede Devolver doy Error.
                    If Buscar_Datos_Ultima_Venta_del_Articulo(val(txtEmpresa.text), txtCodProv.text, TxtCodSuc.text, lCod, llngCod_Doc, llngNro_Doc, ldteFec_Doc_Ultima_Venta, ldblUnidades_Ultima_Venta, ldblPrecio_Ultima_Venta) Then
                        If Buscar_Tipo_Documento(llngCod_Doc, D) Then
                            If Trim(UCase(D!permite_devolucion_mercaderia)) = "N" Then
                                MsgBox "La Ultima Venta del Articulo Fue con un Documento que No Acepta Devoluciones. Documento  --> " & llngCod_Doc & "/" & llngNro_Doc & " De Fecha " & Format(ldteFec_Doc_Ultima_Venta, "dd/mm/yyyy"), vbInformation, MsgTit
                                MousePointer = 1
                                Proceso_Codigo = False
                                Exit Function
                            End If
                        End If
                    End If
                End If
            End If
        End If
        
        If lEstado = ConfMan_Articulos_Estado_Producto_Eliminado Then
            MsgBox "El Articulo " & lCod & " Esta INACTIVO y no es Posible Facturarlo", vbInformation, MsgTit
            MousePointer = 1
            Proceso_Codigo = False
            Exit Function
        End If
        
        If Chk_del_Cliente.Value = vbChecked Then
            If Not f_Articulo_del_Cliente(val(lCod), val(txtCodProv.text)) Then
                MsgBox "El Articulo " & lCod & " no Tiene Lista en el Cliente " & txtCodProv.text, vbInformation, MsgTit
                MousePointer = 1
                Proceso_Codigo = False
                Exit Function
            End If
        End If
        ''''''
        'ATU 20170917, se deja configuracion IDENTICA en Justicia a Aparicio - Pedido por Virginia Gonzalez.
        'If ConfFormato_Factura = "CASINO" And ConfProceso_Productos_WIS = "CLON" Then
        If ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "CASINO-POS" Then
            If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
            Else
                sqlProd = "select * from productos_casino where codigo= " & rstProd!Cod_Prod
                Set RDESC = Dbs.OpenRecordset(sqlProd, dbOpenSnapshot)
                If Not RDESC.EOF Then
                    lNombreProd = RDESC!Descripcion
                Else
                    If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                        lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
                    Else
                        lNombreProd = rstProd!nom_prod
                    End If
                End If
            End If
        Else
            
            ' Busco la descripcion del articulo
            If ConfControla_Saldo_Cantidad_Por_Documento Then
                If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                    lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
                Else
                    lNombreProd = rstProd!nom_prod
                    'AIR 20200228 se agrego que se consulte si se estan levantando el articulo de otro documento para que se manenga la descripcion del Doc. original
                    If pPedidoFactura Then
                        ' Busco la descripcion en FaccmpDescripciones, sino, tomo la del producto       ' SS 20150901
                        SQL = "SELECT * FROM FaccmpDescripciones"
                        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                        SQL = SQL & " AND   cod_doc = " & pCodDocRef
                        SQL = SQL & " AND   nro_doc = " & pNroDocRef
                        SQL = SQL & " AND   cod_prov = " & plngCod_Prov
                        SQL = SQL & " AND   nro_linea = " & pNroLineaRef
                    Else
                        SQL = "SELECT * FROM FaccmpDescripciones"
                        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                        SQL = SQL & " AND   cod_doc = " & plngCod_Doc
                        SQL = SQL & " AND   nro_doc = " & plngNro_Doc
                        SQL = SQL & " AND   cod_prov = " & plngCod_Prov
                        SQL = SQL & " AND   nro_linea = " & plngLinea
                    
                    End If
                    Set lrstFaccmpDescrip = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

                    If Not lrstFaccmpDescrip.EOF Then
                        lNombreProd = Trim(lrstFaccmpDescrip!Descripcion)
                    End If
                End If
                ' AIR 20190906 comentado porque se puso una flag para el F10 en vez de utilizar la variable
                ' If lNombre_Tabla_Temporal <> "" Then                                    ' se trajeron lineas de documentos pendientes
                If gbln_Articulo_de_F10 Then
                    If pCodDocRef <> 0 And pNroDocRef <> 0 And pNroLineaRef <> 0 Then   ' Linea que viene de un doc pendiente
                         
                        ' Busco la descripcion en FaccmpDescripciones                   ' SS 20160609
                        SQL = "SELECT * FROM FaccmpDescripciones"
                        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                        SQL = SQL & " AND   cod_doc = " & pCodDocRef
                        SQL = SQL & " AND   nro_doc = " & pNroDocRef
                        SQL = SQL & " AND   cod_prov = " & plngCod_Prov
                        SQL = SQL & " AND   nro_linea = " & pNroLineaRef
                        Set lrstFaccmpDescrip = Dbs.OpenRecordset(SQL, dbOpenSnapshot)

                        If lrstFaccmpDescrip.EOF Then
                            If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                                lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
                            Else
                                lNombreProd = rstProd!nom_prod
                            End If
                        Else
                            lNombreProd = Trim(lrstFaccmpDescrip!Descripcion)
                        End If
                        lrstFaccmpDescrip.Close
                    End If
                End If
            Else
                'If plngCod_Doc = 0 And plngNro_Doc = 0 And plngCod_Prov = 0 And plngLinea = 0 Then
                If plngCod_Doc = 0 And plngNro_Doc = 0 And plngLinea = 0 Then
                    If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                        lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
                    Else
                        lNombreProd = rstProd!nom_prod
                        'AIR 20200228 se agrego que se consulte si se estan levantando el articulo de otro documento para que se mantenga la descripcion del Doc. original
                        If pPedidoFactura Then
                            ' Busco la descripcion en FaccmpDescripciones, sino, tomo la del producto       ' SS 20150901
                            SQL = "SELECT * FROM FaccmpDescripciones"
                            SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                            SQL = SQL & " AND   cod_doc = " & pCodDocRef
                            SQL = SQL & " AND   nro_doc = " & pNroDocRef
                            SQL = SQL & " AND   cod_prov = " & plngCod_Prov
                            SQL = SQL & " AND   nro_linea = " & pNroLineaRef
                            Set lrstFaccmpDescrip = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
                            If Not lrstFaccmpDescrip.EOF Then
                                lNombreProd = Trim(lrstFaccmpDescrip!Descripcion)
                            End If
                        End If
                    End If
                Else
                    ' Busco la descripcion en FaccmpDescripciones, sino, tomo la del producto       ' SS 20150901
                    SQL = "SELECT * FROM FaccmpDescripciones"
                    SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                    SQL = SQL & " AND   cod_doc = " & plngCod_Doc
                    SQL = SQL & " AND   nro_doc = " & plngNro_Doc
                    SQL = SQL & " AND   cod_prov = " & plngCod_Prov
                    SQL = SQL & " AND   nro_linea = " & plngLinea
                    Set lrstFaccmpDescrip = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
                    If lrstFaccmpDescrip.EOF Then
                        If Trim(UCase(ConfPuntoVta_Utilizar_Descripcion_Auxiliar_Caja)) = "S" Then
                            lNombreProd = Trim(UCase(rstProd!descripcion_auxiliar_caja))
                        Else
                            lNombreProd = rstProd!nom_prod
                        End If
                    Else
                        lNombreProd = Trim(lrstFaccmpDescrip!Descripcion)
                    End If
                    lrstFaccmpDescrip.Close
                End If
            End If
        End If
                
        If ConfPuntoVta_Pide_Codigo_Despues_Unidades And Trim(UCase(pCampo)) = "TXTLECTOR" Then
        
            If ConfPuntoVta_Ingresa_Codigo_SAnterior Then
                lstrCodigo = rstProd!cod_prod_sistema_ant
            Else
                lstrCodigo = str(rstProd!Cod_Prod)
            End If
            
            If Buscar_Moneda(val(txtMoneda.text), M) Then
                lbDisplay.Caption = Trim(UCase(lstrCodigo)) & " - " & Trim(rstProd!nom_prod) & " - " & Trim(M!simbolo) & " " & Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            End If
        
        Else
            If ConfPuntoVta_Ingresa_Codigo_SAnterior Then
                lstrCodigo = rstProd!cod_prod_sistema_ant
            Else
                lstrCodigo = str(rstProd!Cod_Prod)
            End If
            
            If Busco_Moneda(txtMoneda.text) Then
                lbDisplay.Caption = Trim(UCase(lstrCodigo)) & " - " & Mid(Trim(lNombreProd), 1, 25) & " - " & Trim(rstMonedas!simbolo) & " " & Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            End If
        End If
            
        ' Verifico si el documento pide lista de precios por cada Articulo
        If Trim(UCase(D!seleccionar_lista_x_articulo)) = "S" And Not pPedidoFactura Then
            frmPunto_Venta_Precios_Venta_x_Articulo.plngEmpresa = val(txtEmpresa.text)
            frmPunto_Venta_Precios_Venta_x_Articulo.plngCod_Prod = lCod
            frmPunto_Venta_Precios_Venta_x_Articulo.plngMoneda_Documento = val(txtMoneda.text)
            frmPunto_Venta_Precios_Venta_x_Articulo.pdblTCambio = val(txtTipo_Cambio.text)
            frmPunto_Venta_Precios_Venta_x_Articulo.pstrPrecios_Venta_CON_IVA = Trim(UCase(e!imp_inc_facturador))
            frmPunto_Venta_Precios_Venta_x_Articulo.pdblStock = ldblStock_Actual
            frmPunto_Venta_Precios_Venta_x_Articulo.Show vbModal
            
            llngLista_Seleccionada = frmPunto_Venta_Precios_Venta_x_Articulo.plngLista_Seleccionada
        
            sspCantidad_Lineas.Refresh
            DoEvents
        
            If llngLista_Seleccionada <> 0 Then
                       
                If (confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura Then
                    lPrecio = pPrecio
                Else
                    lPrecio = Busco_Precio_Emision(val(txtEmpresa.text), lCod, val(txtCodProv.text), val(txtCodDoc.text), llngLista_Seleccionada, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                End If
                'AIR 20190604 se agrega para controlar los articulos que tienen moneda en el precio de lista diferente al facturador y no esta permitido para el documento
                If lPrecio = -1 Then
                    Proceso_Codigo = False
                    pcancelar = True
                    Exit Function
                End If
            End If
        End If
        
        
        If ConfFormato_Factura = "ELECTRONACHO" Then
            lbDisplay.Caption = lbDisplay.Caption & " --> " & rstProd!ubicacion
        End If
        
        Call Visualizar_Imagen_Producto(lCod, Imagen_Producto, "C", lbolHay_Imagen)
        
        If Trim(UCase(ConfPuntoVta_Permite_Venta_Precio_Cero)) = "N" Then
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                If D!tipo_precio = "0" Then
                    ' El documento esta configurado para que el precio se inicialize en 0 (cero)
                Else
                    If lPrecio <= 0 Then
                        ' Solo avisamos y controlamos de nuevo al grabar el documento y no dejamos guardar si hay precios en cero
                        MsgBox "El Articulo " & lCod & " no Tiene Precio en la Lista ", vbCritical + vbOKOnly
                    End If
                    If val(TxtFactor.text) <= 0 Then
                        ' Solo avisamos y controlamos de nuevo al grabar el documento y no dejamos guardar si hay precios en cero
                        MsgBox "El Articulo " & lCod & " no se Puede Facturar con Cantidad Menor o Igual a 0 ", vbCritical + vbOKOnly
                    End If
                End If
            End If
        End If
        
        If ConfPuntoVta_Tope_Maximo_Importe_Doc_En_Pesos > 0 Then
        
            If pPedidoFactura Then
                ldblTotal_Documento_Actual = val(txtImporte.text) + (lCantidad * pPrecio)
            Else
                ldblTotal_Documento_Actual = val(txtImporte.text) + (lCantidad * lPrecio)
            End If
            
            ldblTotal_Documento_Actual = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblTotal_Documento_Actual)
        
            If ldblTotal_Documento_Actual > ConfPuntoVta_Tope_Maximo_Importe_Doc_En_Pesos Then
                MsgBox "Se ha alcanzado el Tope Definido (" & ConfPuntoVta_Tope_Maximo_Importe_Doc_En_Pesos & ") del Documento. Cierre el Actual y comienze uno nuevo.", vbCritical + vbOKOnly
                MousePointer = 1
                Proceso_Codigo = False
                Exit Function
            End If
        End If
        
        If ConfPuntoVta_Controla_Limite_Credito Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Then
        
            If CLI!cre_cli <> 0 Then
            
                ' Controlo el Limite de Credito.. Si en el Cliente esta Definido el TOPE
                
                If pPedidoFactura Then
                    ldblTotal_Documento_Actual = val(txtImporte.text) + (lCantidad * pPrecio)
                Else
                    ldblTotal_Documento_Actual = val(txtImporte.text) + (lCantidad * lPrecio)
                End If
                
                'If Not Buscar_Limite_Credito(Val(txtEmpresa.text), Val(txtCodDoc.text), txtCodProv.text, Val(txtMoneda.text), CDate(txtFec_Doc.text), ldblTotal_Documento_Actual, Val(txtTipo_Cambio.text), True) Then
                If Not Buscar_Limite_Credito(val(txtEmpresa.text), val(txtCodDoc.text), txtCodProv.text, val(txtMoneda.text), CDate(txtFec_Doc.text), ldblTotal_Documento_Actual, val(txtTipo_Cambio.text), False) Then     'No pide autorizacion linea a linea SS 20180801
                    MousePointer = 1
                    Proceso_Codigo = False
                    Exit Function
                End If
                
            End If
        End If
                                        
        llngLin_repetida = 0
        lrow = vsfLineas_Mercaderia.FindRow(lCod)
        If lrow >= 0 Then
            llngLin_repetida = lrow
        End If
        
        If Trim(UCase(ConfPuntoVta_Articulo_Repite_Linea)) = "S" Then
            vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
            lrow = vsfLineas_Mercaderia.Rows - 1
            lbolLinea_Nueva = True
        Else
            ' NO repite lineas, pero en el caso de articulo generico, se deja repetir           SS 20150828
            'If Buscar_Articulo(Val(Trim(lstrCodigo)), lrstArticulo) Then
            ' Se corrige el parametro                                           AIR  20200617
            If Buscar_Articulo(lCod, lrstArticulo) Then
                If lrstArticulo!generico = "S" Then
                    vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
                    lrow = vsfLineas_Mercaderia.Rows - 1
                    lbolLinea_Nueva = True
                Else
                    ' Verifico si existe el Articulo ya en la Factura
                    lrow = vsfLineas_Mercaderia.FindRow(lCod)
                    
                    lbolLinea_Nueva = False
                    
                    If lrow < 0 Then
                        ' No existe el Articulo. Agrego una linea a la Grilla
                        vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
                        lrow = vsfLineas_Mercaderia.Rows - 1
                        lbolLinea_Nueva = True
                    
                    Else
                        If ConfPuntoVta_Mostrar_Aviso_Linea_Repetida = "S" Then
                            MsgBox "Artículo ya Existente en la Factura - Linea --> " & lrow & " - Se Suma a la Cantidad Anterior --> " & vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES), vbInformation + vbOKOnly
                        End If
                    End If
                End If
            Else
                ' Verifico si existe el Articulo ya en la Factura
                lrow = vsfLineas_Mercaderia.FindRow(lCod)
                
                lbolLinea_Nueva = False
                
                If lrow < 0 Then
                    ' No existe el Articulo. Agrego una linea a la Grilla
                    vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
                    lrow = vsfLineas_Mercaderia.Rows - 1
                    lbolLinea_Nueva = True
                Else
                    If ConfPuntoVta_Mostrar_Aviso_Linea_Repetida = "S" Then
                        MsgBox "Artículo ya Existente en la Factura - Linea --> " & lrow & " - Se Suma a la Cantidad Anterior --> " & vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES), vbInformation + vbOKOnly
                    End If
                End If
            End If
        End If
        

        If Buscar_Articulo(lCod, lrstArticulo) Then
        End If
        
        'AIR 20200828 No es compatible el control de Lineas Pendientes con agrupar Articulos por Linea X ahora hasta tanto no se cambie la logica de control del F10
        If gbln_Articulo_de_F10 = True And lbolLinea_Nueva = False Then
           ' MsgBox "No es compatible el control de Lineas Pendientes con agrupar Articulos por Linea - Se repite el Articulo --> " & llngLin_repetida & " - Debe ingresarlo en una sola Linea para que se aplique el Dscto. x Volumen --> " & vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES), vbInformation + vbOKOnly
            vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows + 1
            lrow = vsfLineas_Mercaderia.Rows - 1
            lbolLinea_Nueva = True
        End If
        
        If lbolLinea_Nueva Then
        
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IADIC) = 0
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIADIC) = 0
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IMPORTE_IADIC) = 0
            
            If Trim(UCase(confPais)) = "CL" And Buscar_Configuracion_Variables_Documento_B(val(txtCodDoc.text), "PUNTOVENTA_INGRESA_IMPUESTOS_ADICIONALES") Then
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IADIC) = rstProd!impuesto_adicional
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIADIC) = Format(Porcentaje_Impuesto_Vigente("IAD", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IADIC), date), "#0.00")
            End If
            
        
        
            vsfLineas_Mercaderia.RowData(lrow) = lCod
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CODIGO) = str(lCod)
            
            
            vsfLineas_Mercaderia.ColComboList(CGL_NOMBRE_MAGNITUD) = String_Magnituides_para_Combo(lCod)
    
            
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CODIGO_SANTERIOR) = UCase(Trim(rstProd!cod_prod_sistema_ant))
            vsfLineas_Mercaderia.Cell(flexcpBackColor, lrow, CGL_CODIGO_SANTERIOR) = &HFFFF&
            
            'juliojulio
                    
            ' JE 20240819   /   Si pstrNombre_Articulo_Actualizado viene inicializado con un valor tomo este
            If Trim(pstrNombre_Articulo_Actualizado) <> "" Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DESCRIPCION) = UCase(pstrNombre_Articulo_Actualizado)
            Else
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DESCRIPCION) = UCase(lNombreProd)
            End If
'            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DESCRIPCION) = UCase(lNombreProd)
            
            vsfLineas_Mercaderia.Cell(flexcpForeColor, lrow, CGL_DESCRIPCION) = plngColor_Nombre
            
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_FORMA_PAGO) = 0
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COD_DOC_REF) = pCodDocRef     ' tratamiento doc parciales SS 20160205
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NRO_DOC_REF) = pNroDocRef
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NRO_LINEA_REF) = pNroLineaRef
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CANTIDAD_SALDO) = pCantidadSaldo
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CANTIDAD_ENTREGADA) = pCantidadEntregada
            
            
             'Buscar tipo de entrega primero el tipo del producto y luego el del documento
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIPO_ENTREGA) = ""
            If gCargoDesdeF Then
                If Busco_Tipo_Entrega_Mercaderia(pTipo_Entrega_Mercaderia, TE) Then
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIPO_ENTREGA) = Trim(UCase(TE!descripcion_corta))
                End If
            Else
                ' AIR 202240320 se agrega la condicion rstProd!tipo_entrega <> 0  ya que se agrego aqui nueva logica pero no se contemplo que la mayoria de los clientes
                ' que utilizan la configuracion x tipo de entrega, tienen muchos de sus productos con valor 0 en el tipo de entrega para aqui levante x defecto  el tipo de entrega definido en el documento por defecto .
                If Not IsNull(rstProd!tipo_entrega) And rstProd!tipo_entrega <> 0 Then
                    If Busco_Tipo_Entrega_Mercaderia(rstProd!tipo_entrega, TE) Then
                        pTipo_Entrega_Mercaderia = rstProd!tipo_entrega
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIPO_ENTREGA) = Trim(UCase(TE!descripcion_corta))
                    Else
                        pTipo_Entrega_Mercaderia = -1
                    End If
                Else
                    pTipo_Entrega_Mercaderia = -1
                End If
                If pTipo_Entrega_Mercaderia = -1 And Not IsNull(D!tipo_entrega_mercaderia_x_defecto) Then
                    If Busco_Tipo_Entrega_Mercaderia(D!tipo_entrega_mercaderia_x_defecto, TE) Then
                        pTipo_Entrega_Mercaderia = D!tipo_entrega_mercaderia_x_defecto
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIPO_ENTREGA) = Trim(UCase(TE!descripcion_corta))
                    End If
                End If
            End If
            
            
            ' AIR 20171009
            If Busco_Stk_Deposito(Trim(pDeposito), DE) Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DEPOSITO) = Trim(UCase(DE!codigo))
            Else
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DEPOSITO) = ""
            End If
                        
            If Trim(txtCajas.text) = "" Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CAJAS) = "1"
            Else
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CAJAS) = Format(val(txtCajas.text), "0")
            End If
                'AIR 20171009
            'vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK) = Format(Stock_Linea(txtEmpresa.text, Trim(pdeposito), vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CODIGO), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")
             'AIR 20210629 se comenta porque ya fue calculado arriba en esta variable
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK) = Format(ldblStock_Actual, "0.00")
            
            If val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK)) <= 0 Then
                vsfLineas_Mercaderia.Cell(flexcpForeColor, lrow, CGL_STOCK) = &HFF&
                vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_STOCK) = True
            Else
                vsfLineas_Mercaderia.Cell(flexcpForeColor, lrow, CGL_STOCK) = &H0&
                vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_STOCK) = False
            End If
            
            
            ' AIR 20210719 se pasa a contemplar en la Venta si el documento aplica IVA o no para el caso de zona franca
            lstrDoc_Aplica_IVA = "S"
            If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocum) Then
                If lrstDocum!aplica_iva = "N" Then
                    lstrDoc_Aplica_IVA = "N"
                End If
            End If
            
            If (Trim(UCase(lstrCliente_Aplica_IVA)) = "S" And lstrDoc_Aplica_IVA = "S") Or (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
       
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS) = rstProd!cod_cofis
                  
                 If Trim(txtTipo_Doc_Identidad.text) = "2" Then      'Aplico codigo IVA segun condicion de RUT   SS 20190527
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA) = rstProd!cod_iva_ventas_con_rut
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS_IVA) = rstProd!cod_iva_ventas_con_rut
                 Else
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA) = rstProd!cod_iva
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS_IVA) = rstProd!cod_iva
                 End If
                    
                 If Busco_Impuesto("COFIS", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS)) Then
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS) = Format(Porcentaje_Impuesto_Vigente("COFIS", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS), date), "#0.00")
                 Else
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS) = Format(0, "#0.00")
                 End If
                                    
                 If Busco_Impuesto("IVA", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)) Then
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IVA) = Format(Porcentaje_Impuesto_Vigente("IVA", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA), date), "#0.00")
                 Else
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IVA) = Format(0, "#0.00")
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA) = 1
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS_IVA) = 1
                 End If
                    
                 If val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS)) = 0 Then
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS_IVA) = 0
                 Else
                     vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS_IVA) = Format(Porcentaje_Impuesto_Vigente("COFIS", vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS), date), "#0.00")
                 End If
            Else
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS) = 1
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA) = 1
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS_IVA) = 1
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS) = Format(0, "#0.00")
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IVA) = Format(0, "#0.00")
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS_IVA) = 0
            End If
            
            If Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") <> 0 And Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") < CDbl(lCantidad) Then
                 MsgBox "La cantidad supera la cantidad maxima permitidad en el documento", vbCritical, MsgTit
                 Proceso_Codigo = False
                 vsfLineas_Mercaderia.RemoveItem lrow
                 Exit Function
            End If
            
            
            
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_UNIDADES) = True
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD) = Format(lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_UNIDADES_MAGNITUD) = True
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_MAGNITUD) = lrstArticulo!magnitud
            If Buscar_Magnitud(lrstArticulo!magnitud, MA) Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD) = MA!UniMed
            Else
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD) = ""
            End If
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
            lprecioMGM = lPrecio
            lequivalencia = 1
            lhay_equivalencia = False
            If confUsaEquivalenciaMagnitudes Then
               
                If lMagnitud = -1 Then
                   If Buscar_Equivalencia_Principal(lrstArticulo!Cod_Prod, lrstArticulo!magnitud, "V", lrstMag) Then
                      lhay_equivalencia = True
                   End If
                Else
                  If Buscar_Equivalencia(lrstArticulo!Cod_Prod, lrstArticulo!magnitud, lMagnitud, lrstMag) Then
                      lhay_equivalencia = True
                  End If
                End If
                If lhay_equivalencia = True Then
                    lequivalencia = lrstMag!val_equivalencia
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_MAGNITUD) = lrstMag!magnitud
                    If Buscar_Magnitud(lrstMag!magnitud, MA) Then
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD) = MA!UniMed
                    Else
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD) = ""
                    End If
                    Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, lprecioMGM)
                End If
                
                'modificar aca julio 030724
                ldblStock_Actual = vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK)
                lPrecioStock = 0
                Call CalcularCantidadyPrecioEquivalenteStock(lequivalencia, ldblStock_Actual, lPrecioStock)
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK) = Format(ldblStock_Actual, "0.00")
            
                If val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_STOCK)) <= 0 Then
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, lrow, CGL_STOCK) = &HFF&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_STOCK) = True
                Else
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, lrow, CGL_STOCK) = &H0&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_STOCK) = False
                End If
                
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                               
                If (confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura Then
                    lprecioMGM = val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD)) * val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD)) / val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES))
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(lprecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
                
                
                vsfLineas_Mercaderia.Cell(flexcpFontBold, lrow, CGL_UNIDADES) = True
            End If
            
            lCantidad = vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES)
            If Not IsNull(lrstArticulo!unid_min_venta) Then
               If lrstArticulo!unid_min_venta > RedondeoUnidMinVenta(lCantidad, lrstArticulo!unid_min_venta) And lrstArticulo!unid_min_venta > 0 Then
                   cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD), lrstArticulo)
                   vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                   Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio1)
                   vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                   lCantidad = vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES)
                   'MsgBox "Error-no se pude vender menos de " & lrstArticulo!unid_min_venta & " unidades de stock ", vbInformation + vbSystemModal, MsgTit
                   'Proceso_Codigo = False
                   'vsfLineas_Mercaderia.RemoveItem lrow
                   'Exit Function
               End If
            End If
            
            If Not IsNull(lrstArticulo!Multiplo_unid_min_vta) Then
               If lrstArticulo!Multiplo_unid_min_vta = "S" Then
                   If Not esMultiplo(lCantidad, lrstArticulo!unid_min_venta) Then
                       cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NOMBRE_MAGNITUD), lrstArticulo)
                       vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio1)
                       vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                        
                   End If
               End If
            End If
            
            If Not ControlStock(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), lCod, pDeposito, lCantidad, ldblStock_Actual) Then
                Proceso_Codigo = False
                vsfLineas_Mercaderia.RemoveItem lrow
                Exit Function
             End If

            If Not ((confPuntoVta_Conservar_Pventa_Seleccion And ((pPrecio <> 0 And plngCod_Doc <> val(Me.txtCodDoc.text) And plngCod_Doc <> 0) Or gbln_Cargo_Datos_Desde_F10)) Or pPedidoFactura) Then
                If pPedidoFactura = True Then
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(lPrecio, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD) = Format(lprecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PRECIO_ORIGINAL) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
          
                Else
                    If (Trim(UCase(e!imp_inc_facturador)) = "S" And lstrDoc_Aplica_IVA = "S") Or (Not confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(lPrecio, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD) = Format(lprecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PRECIO_ORIGINAL) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                    If (Trim(UCase(e!imp_inc_facturador)) = "N" And lstrDoc_Aplica_IVA = "S") Or (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO) = Format(Importe_Sin_Impuestos_Vigente(lPrecio, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(lPrecio, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD) = Format(Importe_Sin_Impuestos_Vigente(lprecioMGM, vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PRECIO_ORIGINAL) = Format(val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                End If
            End If
            If (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS) = 1
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA) = 1
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TCOFIS_IVA) = 1
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS) = Format(0, "#0.00")
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_IVA) = Format(0, "#0.00")
                 vsfLineas_Mercaderia.TextMatrix(lrow, CGL_COFIS_IVA) = 0
            End If
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO_MAGNITUD)), vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PUNITARIO)), vsfLineas_Mercaderia.TextMatrix(lrow, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
            lPrecioMinimo = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), lCod, val(txtCodProv.text), val(txtCodDoc.text), llngLista_Seleccionada, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ldblDtoMaximo)
            
            Dim lCantidad1 As Double
            lCantidad1 = 0
            If confUsaEquivalenciaMagnitudes Then
               Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad1, lPrecioMinimo)
            End If
            
            'aqui
            
            If Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), lCod, val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD)), lMagnitud, ldblDescuento_x_Volumen) Then
                'AIR 20230215 eliminado por Julio en la 5.41.121 se cambio la categoria del parametro a ByVal para que no devuelva el % que estaba quedando en la variable global y lo arrastra a otros productos el valor
                       
                'AIR 20241016 faltaba la condicion de la variable de usa descuento
                'AIR 20241021 faltaba considerar que cuando se esta copiando desde otro documento, hay que conservar los datos que vienen
                If pDto1 = 0 And ConfPuntoVta_Usar_Descuentos_x_Volumen And Not pPedidoFactura Then
                    pDto1 = ldblDescuento_x_Volumen
                End If
                
                'AIR  20200828
                If llngLin_repetida > 0 And ConfPuntoVta_Usar_Descuentos_x_Volumen And lrstArticulo!generico <> "S" And gbln_Articulo_de_F10 = True Then
                    MsgBox "No es compatible el control de Lineas Pendientes con Aplicar Dscto por Volumen - Linea --> " & llngLin_repetida, vbInformation + vbOKOnly
                    vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows - 1
                    llngLin_repetida = 0
                    Proceso_Codigo = False
                    Exit Function
                End If
                                
                If llngLin_repetida > 0 And ConfPuntoVta_Usar_Descuentos_x_Volumen And lrstArticulo!generico <> "S" Then
                    MsgBox "Artículo ya Existente en la Factura - Linea --> " & llngLin_repetida & " - Debe ingresarlo en una sola Linea para que se aplique el Dscto. x Volumen --> " & vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES), vbInformation + vbOKOnly
                    'JCH 170823 se elimina el ultimo registro de la grilla si esta vacia
                   ' If Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO)) = "" Then
                         vsfLineas_Mercaderia.RemoveItem vsfLineas_Mercaderia.Rows - 1
                   ' End If
                    
                    llngLin_repetida = 0
                    Proceso_Codigo = False
                    Exit Function
                End If
            Else
                'AIR 20200826 se comenta porque ya viene cargada de arriba la variable
               ' lbolLinea_Nueva = True
            End If
            
            
            
            
            
            
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PRECIO_MINIMO) = Format(lPrecioMinimo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DESCUENTO_MAXIMO) = Format(ldblDtoMaximo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1, "0.00")
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
            
            
            
            If pPedidoFactura = True Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1, "0.00")
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
            Else
                If IsNumeric(rstProd!dto_especial) And rstProd!dto_especial <> 0 And val(txtVendedor.text) <> 0 Then
                    ' Sumo al Dto 1 el Porcentaje que viene aqui de la Ficha del Articulo
                    ' Sumo al Dto 1 el Porcentaje que viene aqui de la Ficha del Articulo
                    Select Case val(txtVendedor.text)
                        Case 20, 21, 101, 104, 96, 102, 106
                            ldblDto_Especial = rstProd!dto_especial
                            If val(txtDtoGlobal.text) + ldblDto_Especial > 30 Then
                                ldblDto_Especial = 0
                            End If
                        Case Else
                            ldblDto_Especial = 0
                    End Select
                Else
                    ldblDto_Especial = 0
                End If
            
                ' Busco si Hay Descuentos Definidos para el Cliente por Articulo
                
              
                If (plngCod_Doc = 0) Then '6
                    If UCase(Trim(L!aplica_valores_mailing_vigente)) = "S" Then
                        If Busco_Descuento_Mailing(CLng(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Rows - 1, CGL_CODIGO)), val(txtLista.text), CDate(txtFec_Doc.text), rstMailing) Then   ' JE 20250807
                           vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(rstMailing!descuento1, "00.00")
                           vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(rstMailing!descuento2, "00.00")
                           vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(rstMailing!descuento3, "00.00")
                        Else
                            GoTo Descuentos
                        End If
                    Else
                        GoTo Descuentos
                    End If
                Else
Descuentos:
                         If plngCod_Doc = val(Me.txtCodDoc.text) Or plngCod_Doc = 0 Then '4
                            If Busco_Descuento_Cliente_Articulo_Vigentes("F", txtCodProv.text, TxtCodSuc.text, txtFec_Doc.text, lCod, ldblDescuento1, ldblDescuento2, ldblDescuento3, D) Then '3
                                If ConfPuntoVta_Utilizar_Todos_Descuentos_Clte_Art_Vigentes Then    'Toma todos los descuentos vigentes (hasta 3)   SS 20190326
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(ldblDescuento1, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(ldblDescuento2, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(ldblDescuento3, "0.00")
                                Else                                                                'Toma el descuento vigente mas reciente
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(D!descuento1, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(D!descuento2, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(D!descuento3, "0.00")
                                End If
                            Else
                                ' Busco si Hay Descuentos x Grupo Definidos para el Cliente
                                If Busco_Descuento_x_Grupo_para_Cliente(txtCodProv.text, lCod, D) Then '2
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(D!descuento1 + ldblDto_Especial, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(D!descuento2, "0.00")
                                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(D!descuento3, "0.00")
                                Else
                                    If ConfPuntoVta_Usar_Descuentos_x_Volumen Then '1
                                        '    Busco si Hay Descuentos x Volumen de Venta
                                        If Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), lCod, val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD)), lMagnitud, ldblDescuento_x_Volumen) Then
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(ldblDescuento_x_Volumen + ldblDto_Especial, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
                                        Else
                                            ' JE 20180319   /  Busco si Hay Descuentos Definidos para el Departamento de Venta
                                            If Porcentaje_Descuento_x_Dpto_Venta_a_una_Fecha(rstProd!Dpto, txtFec_Doc.text, PDV) Then
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(PDV!porcentaje, "0.00")
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(0, "0.00")
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(0, "0.00")
                                            Else
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1 + ldblDto_Especial, "0.00")
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
                                                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
                                            End If
                                        End If
                                    Else
                                        ' JE 20180319   /  Busco si Hay Descuentos Definidos para el Departamento de Venta
                                        If Porcentaje_Descuento_x_Dpto_Venta_a_una_Fecha(rstProd!Dpto, txtFec_Doc.text, PDV) Then
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(PDV!porcentaje, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(0, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(0, "0.00")
                                        Else
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1 + ldblDto_Especial, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
                                            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
                                        End If
                                    End If '1
                                End If '2
                            End If '3
                         End If '4
                    ' End If '5
                End If '6
            End If '7
          
          '  vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DEPOSITO) = txtDeposito.text
          
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_NRO_LINEA) = lrow
            Call Cargo_Logtrans("ALTA LINEA DOC : " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lrow & " ART : " & lCod & " CANT : " & lCantidad)
        
                           
            
        
        Else  ' lbolLinea_Nueva = False
        
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) + lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            'AIR 20231010 faltaba sumar en unidades magnitud
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD) = Format(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD) + lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       
            'AIR 20230224  no esta bien esta linea que se agrego porque cuando se esta vendiendo por unidades no se aumenta el nro de cajas
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CAJAS) = Format(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_CAJAS) + val(txtCajas.text), 0)
            
            ' AIR 20190729
            If ConfPuntoVta_Usar_Descuentos_x_Volumen Then
                ' Busco si Hay Descuentos x Volumen de Venta
                If Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), lCod, val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES_MAGNITUD)), lMagnitud, ldblDescuento_x_Volumen) Then
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(ldblDescuento_x_Volumen + ldblDto_Especial, "0.00")
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
                Else
                    
                    'AIR 20190729 se comenta porque si ingresaron a mano un descuento cuando se ingreso la primera vez el articulo le esta pasando por arriba.SAMALUZ
                    ' JE 20180319   /  Busco si Hay Descuentos Definidos para el Departamento de Venta
'                    If Porcentaje_Descuento_x_Dpto_Venta_a_una_Fecha(rstProd!Dpto, txtFec_Doc.text, PDV) Then
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(PDV!porcentaje, "0.00")
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(0, "0.00")
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(0, "0.00")
'                    Else
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1 + ldblDto_Especial, "0.00")
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
'                        vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
'                    End If
                End If
            Else
            
                'AIR 20190729 se comenta porque si ingresaron a mano un descuento ingreso la primera vez el articulo, le esta pasando por arriba. SAMALUZ
                
'                ' JE 20180319   /  Busco si Hay Descuentos Definidos para el Departamento de Venta
'                If Porcentaje_Descuento_x_Dpto_Venta_a_una_Fecha(rstProd!Dpto, txtFec_Doc.text, PDV) Then
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(PDV!porcentaje, "0.00")
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(0, "0.00")
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(0, "0.00")
'                Else
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(pDto1 + ldblDto_Especial, "0.00")
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(pDto2, "0.00")
'                    vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(pDto3, "0.00")
'                End If
            End If

            Call Cargo_Logtrans("SUMA LINEA  DOC : " & txtCodDoc.text & " NUM : " & txtDoc.text & " CLI : " & txtCodProv.text & " LINEA : " & lrow & " ART : " & lCod & " CANT : " & lCantidad)
        End If
        
        
        If Not pbooNoPermiteDtos Then
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO1) = Format(0, "0.00")
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO2) = Format(0, "0.00")
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DTO3) = Format(0, "0.00")
        End If
        Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True, pbooNoPermiteDtos)
        
        
        'Si no se controlan, sale en TRUE por lo que no entra aca, solo Casino x ahora
'        If Controlo_Descuento_Global() = False Then
'            MousePointer = 1
'            'Eliminamos la linea que estamos agregando antes de ordenarla
'            vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows - 1
'            Proceso_Codigo = False
'            Exit Function
'        End If

        'AIR 20220826 se agrega parametro a la rutina
        'AIR 20220831 agrego otro parametro lrow
        If Controlo_Descuento_Global(False, lrow) = False Then
            MousePointer = 1
            'AIR 20220901 se corrige porque si se esta sumando la linea a otra anterios, hay que restar lo que se sumo arriba
            If lbolLinea_Nueva = True Then
                vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) = Format(vsfLineas_Mercaderia.TextMatrix(lrow, CGL_UNIDADES) - lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))

            Else
                'Eliminamos la linea que estamos agregando antes de ordenarla
                vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.Rows - 1
            End If
            Proceso_Codigo = False
            Exit Function
        End If
        
        
        'PARA ORDENAR LA GRILLA DEL ULTIMO ITEM AL PRIMERO
        If (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "DALTIRO") And Not pPedidoFactura Then
            vsfLineas_Mercaderia.Select 1, 0, 1, vsfLineas_Mercaderia.Cols - 1
            vsfLineas_Mercaderia.Sort = flexSortUseColSort
        Else
            If Trim(UCase(ConfPuntoVta_Ordenar_Grilla_Mercaderia_Ultimo_Ingreso)) = "S" And Not pPedidoFactura Then
                vsfLineas_Mercaderia.Select 1, 0, 1, vsfLineas_Mercaderia.Cols - 1
                vsfLineas_Mercaderia.Sort = flexSortUseColSort
            End If
        End If
        
        
        If Not pPedidoFactura Then
            ' JE 20180629   /   Chequeo si el Documento esta configurado para que Solicite Datos de las Series del Articulo
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                If Trim(UCase(D!pide_serie_x_articulo)) = "S" Then
                    Call Pido_Serie_x_Articulo(lCod, lrow, lrstArticulo!pide_ingreso_serie_obligatoria)
                Else
                    ' JE 20230621   /   Chequeo si el Articulo tiene configurado que se ingrese obligatoriamente la Serie
                    If Trim(UCase(rstProd!pide_ingreso_serie_obligatoria)) = "S" Then
                        Call Pido_Serie_x_Articulo(lCod, lrow, lrstArticulo!pide_ingreso_serie_obligatoria)
                    End If
                End If
            End If
        End If
        

        'Para el caso que el cliente requiera desglosar el envase o taras de exportacion
        '########################################################
        If rstProd!cod_aso <> 0 Then
            If rstProd!tipo_prod = Tipo_Desglosa_Envase Then
                If ConfFormato_Factura = "DALKAN" Then
                    lFactorTmp = TxtFactor.text
                    TxtFactor.text = Round(val(TxtFactor.text) * (rstProd!porcentaje_calculo_tara / 100), 0)
                    pPrecio = 0
                End If
                'Dim lcod_aso As String
                'lcod_aso = Trim(rstProd!cod_aso)
                
                'AIR 20230620 se agrega porque si estan levantando desde una preventa, el envase se duplica
                If pPedidoFactura = False Then
                    If Not Proceso_Codigo(Trim(rstProd!cod_aso), pDto1, pDto2, pDto3, pPrecio, pTipo_Entrega_Mercaderia, pDeposito, pPedidoFactura, pCampo, False, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                        TxtFactor.text = lFactorTmp
                        Call txtLector_GotFocus
                    End If
                End If
                'Agregamos una linea con el BRUTO para la impresion
                If ConfFormato_Factura = "DALKAN" Then
                    TxtFactor.text = Round(lFactorTmp + TxtFactor.text, 0)
                    If Not Proceso_Codigo(Trim(rstProd!cod_aso), pDto1, pDto2, pDto3, pPrecio, pTipo_Entrega_Mercaderia, pDeposito, pPedidoFactura, pCampo, False, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                        TxtFactor.text = lFactorTmp
                        Call txtLector_GotFocus
                    End If
                End If
                
            Else
                'AIR 20230620 se agrega porque si estan levantando desde una preventa, el envase se duplica
                If pPedidoFactura = False Then
                    If Buscar_Cliente(txtCodProv.text, CLI) = True Then
                        If Trim(CLI!desglosa_envase) = "S" Then
                            If Not Proceso_Codigo(Trim(rstProd!cod_aso), pDto1, pDto2, pDto3, pPrecio, pTipo_Entrega_Mercaderia, pDeposito, pPedidoFactura, pCampo, False, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                                Call txtLector_GotFocus
                            End If
                        End If
                    End If
                End If
            End If
        End If
    
        If pPedidoFactura = False Then
    
            ' JE20230629    /   Si hay Componentes de la Estrucutura que estan configurados para que agregue lineas al facturador los pasamos
            '########################################################
    
            lstrSQL = "SELECT * FROM Estructuras"
            lstrSQL = lstrSQL & " WHERE tipo = 'P'"
            lstrSQL = lstrSQL & " AND padre = " & lCod
            lstrSQL = lstrSQL & " AND agrega_componentes_en_facturador = 'S'"
    
            Set lrstEstructura = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
            While Not lrstEstructura.EOF
                If Not Proceso_Codigo(lrstEstructura!hijo, 0, 0, 0, pPrecio, pTipo_Entrega_Mercaderia, pDeposito, pPedidoFactura, pCampo, False, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, lrstEstructura!cantidad, RGB(0, 0, 255)) Then
                    Call txtLector_GotFocus
                End If
                lrstEstructura.MoveNext
            Wend
        
        End If
    
        
        If fraDescuento_x_Volumen.visible Then
            Call Cargo_Grilla_Descuentos_x_Volumen(lCod, CDate(txtFec_Doc.text), val(txtLista.text), lPrecio)       ' JE 20250708   /   parametro nuevo
        End If
    
        If fraEquivalencias_Stock.visible Then
            Cargo_Grilla_Equivalencias_Stock (lCod)
        End If
    
        
        
         If Not ControlDescuentosRegistro(lrow) Then
             Proceso_Codigo = False
             vsfLineas_Mercaderia.RemoveItem lrow
             Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
             'Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True)
         End If
        
        'AIR 20230616
        If NullToZero(lrstArticulo!cod_tipo_garantia) <> 0 Then
            SQL = "SELECT * FROM ma_Tipos_Garantia WHERE codigo = " & lrstArticulo!cod_tipo_garantia
            Set lrstGarantias = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            If Not lrstGarantias.EOF Then
                If lrstGarantias!Descripcion <> "" Then
                    lbDisplay.Caption = "Gtia:" & Trim(lrstGarantias!Descripcion) & " " & lbDisplay.Caption
                End If
            End If
        End If
        
        Call Total_Unidades

        TxtLector.text = ""
    
    End If
    
    
    

Exit Function

Errores:
   
    MsgBox "Ha Ocurrido un Error en el Articulo Actual, Reintente", vbExclamation, MsgTit
    
    TxtLector.text = ""
    TxtFactor.text = ""
    If vsfLineas_Mercaderia.Row > 1 Then
        vsfLineas_Mercaderia.RemoveItem (vsfLineas_Mercaderia.Row)
    End If
Exit Function
    Resume
End Function


Private Function MagnitudVentaxDefecto(argArticulo As Long) As Long
    Dim lrstMag As Recordset
    Dim lrstArticulo As Recordset
    
    If Buscar_Articulo(argArticulo, lrstArticulo) Then
    End If

    If confUsaEquivalenciaMagnitudes Then
       If Buscar_Equivalencia_Principal(argArticulo, lrstArticulo!magnitud, "V", lrstMag) Then
            lMagnitud = lrstMag!magnitud
        Else
            lMagnitud = lrstArticulo!magnitud
        End If
    Else
        lMagnitud = lrstArticulo!magnitud
    End If
    MagnitudVentaxDefecto = lMagnitud
    

End Function





 
 Function Supera_Saldo_Cheques(pEstado As String, pCliente As Long, pLimite As Double, pEstado_Cheque) As Boolean
 On Error GoTo Errores
 Dim SQL As String
 Dim R As Recordset
 Dim C As Recordset
 
 
 Supera_Saldo_Cheques = False
 SQL = "select sum(importe_base) as monto from mov_bancarios where cod_doc in(730,735) and cod_prova=" & pCliente & _
 " and estado='" & pEstado_Cheque & "'"
 
 Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
 If Not R.EOF Then
    If Not IsNull(R!monto) Then
        If R!monto > pLimite And pLimite <> 0 Then
            Supera_Saldo_Cheques = True
        End If
    End If
 End If
 R.Close
 
 
 Exit Function
Errores:
 Call FErrores
 'Resume
 End Function


Public Function Total_IVA() As Double
    
   Dim totalIVA As Double
   
   totalIVA = 0


     For i = 1 To vsfImpuestos.Rows - 1
         If val(vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA)) <> 0 Then
             totalIVA = totalIVA + (val(vsfImpuestos.TextMatrix(i, CGI_IVA)))
         End If
         
    Next
    
    Total_IVA = totalIVA
    
End Function

Private Sub UnificaAutorizacionDescuento()
     If Not confPuntoVta_Unifica_Autorizacion_Descuento Then
          gAutorizacionUnificada = False
     Else
          gAutorizacionUnificada = True
     End If
End Sub

Public Function Valido_Redondeo() As Boolean
Dim lredondeo As Double

    If Trim(txtTotal_Calculado.text) = "" Then
        txtTotal_Calculado.text = Format(0, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    End If
    
    lredondeo = CDbl(Format(txtImporte.text, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))) - CDbl(Format(txtTotal_Calculado.text, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text))))
    
    If Abs(lredondeo) > confRedondeo_Tope Then
        If MsgBox("ATENCIÓN!!!! El Redondeo Supera el Valor Máximo Definido (" & str(Trim(confRedondeo_Tope)) & " Pesos)" & Chr(13) & "¿Desea Continuar? ", vbYesNo + vbExclamation + vbDefaultButton2, MsgTit) = vbYes Then
            txtRedondeo.text = Format(lredondeo, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            Valido_Redondeo = True
        Else
            txtRedondeo.text = ""
            Valido_Redondeo = False
        End If
    Else
        txtRedondeo.text = Format(lredondeo, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
         Valido_Redondeo = True
    End If

End Function


Private Function YaAutorizadoDescuento() As Boolean
     
     If Not confPuntoVta_Unifica_Autorizacion_Descuento Then
          YaAutorizadoDescuento = False
     Else
          YaAutorizadoDescuento = gAutorizacionUnificada
     End If
 
End Function



Private Sub cmdEntrega_Click()

    If txtEmpresa.text <> "" And txtCodDoc.text <> "" And txtDoc.text <> "" And txtCodProv.text <> "" Then

        frmPunto_Venta_Datos_de_Entrega.Cambio_gbolESC          ' para que cargue los datos en el validate de txtDoc    SS 20171020
        frmPunto_Venta_Datos_de_Entrega.plngCod_Emp = val(txtEmpresa.text)
        frmPunto_Venta_Datos_de_Entrega.plngCod_Doc = val(txtCodDoc.text)
        frmPunto_Venta_Datos_de_Entrega.plngNro_Doc = val(txtDoc.text)
        frmPunto_Venta_Datos_de_Entrega.plngCliente = val(txtCodProv.text)
        frmPunto_Venta_Datos_de_Entrega.plngTipo_Entrega = 0
        frmPunto_Venta_Datos_de_Entrega.pstrNombre_Cliente = Trim(txtNomCli.text)
        frmPunto_Venta_Datos_de_Entrega.pstrRUC = Trim(TxtRuc.text)
        frmPunto_Venta_Datos_de_Entrega.pstrOperacion = Trim(sspOperacion.Caption)
        frmPunto_Venta_Datos_de_Entrega.pstrFormulario_Origen = Me.Name
        
        ' Si es documentos electronico, aunque entre por consulta, le dejamos que modifique el envio    SS 20171025
        If Trim(sspOperacion.Caption) = "C" Then
            If esEFactura(val(txtCodDoc.text)) Then
                frmPunto_Venta_Datos_de_Entrega.pstrOperacion = "M"
            End If
        End If
        
        frmPunto_Venta_Datos_de_Entrega.Show
    End If
    
End Sub

Public Function Actualizar_Datos_Baucher_Tarjeta(plstrDocIni As String) As Boolean
Dim lrstTarjeta As Recordset

Dim lstrSQL As String
Dim llngNro_Doc_Provisorio As Long

On Error GoTo Errores

    Actualizar_Datos_Baucher_Tarjeta = True
    
    'llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_Caja * ConfMultiplo_caja) + val(plstrDocIni)     ' para evitar concurrencia  SS 20181214
    ' AIR 20250505
    llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_SubCaja * ConfMultiplo_caja) + val(plstrDocIni)
    

    'If Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) <> "" Then
    
    'Busco si hay registros ingresados de tarjetas con el POS  (F9)
    
    If Existe_Tarjeta_para_Documento(val(txtEmpresa.text), val(txtCodDoc.text), llngNro_Doc_Provisorio, val(txtCodProv.text), lrstTarjeta) Then
    
        lstrSQL = "UPDATE Faccmp_Baucher_TCredito SET nro_doc = " & val(txtDoc.text)
        lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
        lstrSQL = lstrSQL & " AND   cod_doc = " & val(txtCodDoc.text)
        lstrSQL = lstrSQL & " AND   nro_doc = " & llngNro_Doc_Provisorio
        lstrSQL = lstrSQL & " AND   cod_prov = " & val(txtCodProv.text)
        
        ' lstrSQL = lstrSQL & " AND autorizacion = '" & Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) & "'"
        
        Dbs.Execute lstrSQL
     
        Call Cargo_Logtrans("UPDATE Faccmp_Baucher_TCredito " & Trim(txtCodDoc.text) & "-" & llngNro_Doc_Provisorio & "-" & Trim(txtCodProv.text) & " Autoriz." & Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) & " - Nro.Doc.Definitivo:" & Trim(txtDoc.text) & "-" & Trim(txtUsuario.text))
    End If
        
    'End If

Exit Function

Errores:
    Call FErrores
    Actualizar_Datos_Baucher_Tarjeta = False
   
End Function

Private Sub cmdGuardar_Click()
Dim SQL As String
Dim lLinea As Integer
Dim Autorizado As String
Dim ldblCofis As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim ldblRedondeo_Base As Double
Dim ldblRedondeo_Referencia As Double
Dim ldblPrecio_Base As Double
Dim ldblPrecio_Referencia As Double
Dim ldblTipo_Cambio_Rec As Double
Dim RP As Recordset
Dim RD As Recordset
Dim DS As Recordset
Dim lcoddoc_ant As Long
Dim sigo As Integer
Dim lEmpresa As Long
Dim llngNumero_Pedido As Long
Dim ldblImporte_X_Medio As Double
Dim ldblImporte_X_Medio_Rec As Double
Dim ldblImporte_Base_Rec As Double
Dim ldblImporte_Referencia_Rec As Double
Dim ldblCambio As Double
Dim ldblPrecio_Linea As Double
Dim i As Long
Dim j As Long
Dim ldblSaldo_a_Cancelar As Double
Dim lbolEncontre As Boolean
Dim lrstMoneda As Recordset
Dim lstrNombre_PC As String
Dim lstrContrato As String
Dim ldteFecVto As Date

Dim R As Recordset
Dim B As Recordset
Dim C As Recordset
Dim ch As Recordset
Dim D As Recordset
Dim e As Recordset
Dim FP As Recordset
Dim M As Recordset
Dim L As Recordset
Dim TE As Recordset
Dim MAX As Recordset
Dim lrstDocsPend As Recordset
Dim lrstEstructura As Recordset
Dim lrstLinMercaderia As Recordset
Dim lrstLinMercaderia_Con_Tipos_Entrega_Pide_Datos_Entrega As Recordset
Dim lrstConfiguracion_Doc_Tipo_Entrega As Recordset
Dim lrstTipos_Entrega_Pide_Datos_Entrega As Recordset

Dim llngNro_Doc_Estructura As Long
Dim lEstructura As Boolean
Dim lLinea_Estructura As Integer
Dim ldblPorcentaje_TBromatologica As Double
Dim llngCodIva As Long
Dim llngSumar_Dias As Long
Dim llngSumar_Mes As Long
Dim ldteFecha_Vencimiento As Date
Dim ldblImporte_Cuota As Double
Dim llngMovil As Long
Dim llngNro_Doc As Long
Dim lbolImprimir As Boolean
Dim llngCod_Doc_Estructura As Long
Dim ldblUnidades_Estructura As Double
Dim lrstObservacion As Recordset
Dim localCFE As efCFE
Dim lClauVta As String
Dim lViaTransporte As String
Dim lPais As Integer

Dim llngCod_Emp As Long
Dim llngCod_Doc As Long
Dim llngCod_Prov As Long
Dim lrstTarjeta As Recordset
Dim lstrSimbolo_Moneda As String
Dim lstrHora_Recepcion As String
Dim lstrHora_Entrega As String
Dim ldblCambioOriginal As Double
Dim ldblCambioCalculado As Double
Dim llngTipo_Entrega As Long
Dim lbolHay_Mercaderia_con_Tipo_Entrega_para_Imprimir As Boolean
Dim ldblTotal_Documento_Actual As Double
Dim lstrDocIni As String
Dim lstrId As String
Dim lstrTipoPedido As String            ' AIR 20230317
Dim llngCod_Doc_Preventa As Long        ' JE 20240608   -   variable local del codigo documento de la Preventa
Dim llngNro_Doc_Preventa As Long        ' JE 20240608   -   variable local del nro documento de la Preventa
Dim lstrNombre_Cliente As String
Dim lstrRUT As String
Dim lblnYaImpri_x_Form_Pide_Datos_Entrega As Boolean      '  AIR 20241118

On Error GoTo Errores

    gBolTodosLosDescuentos = False
    
    If Not Documento_Habilitado_x_Empresa(val(txtEmpresa.text), val(txtCodDoc.text)) Then
        MsgBox "Documento no aceptado para la empresa ingresada ", vbExclamation + vbOKOnly, MsgTit
        gbooErrorRobot = True
        Exit Sub
    End If
    
    ' JE 202505  /   Si el documento es de Acopio, chequeo que se haya ingresado un acopio asociado
    If f_InStr_Split(Trim(ConfDocs_Validos_Acopio), Trim(txtCodDoc.text)) Then
        If val(txtAcopio.text) = 0 Then
            MsgBox "Documento Configurado como de ACOPIO." & Chr(13) & "Debe ingresar un Código de Acopio Válido", vbExclamation + vbOKOnly, MsgTit
            gbooErrorRobot = True
            Exit Sub
        End If
    End If
    

    If ConfPuntoVta_Pide_Confirmacion_Al_Guardar And Not gPtoVenta_Robot Then   'SS 20180611
        If UCase(Trim(sspOperacion.Caption)) = "A" Or UCase(Trim(sspOperacion.Caption)) = "M" Or UCase(Trim(sspOperacion.Caption)) = "U" Then
            If Trim(UCase(ConfPuntoVta_Pide_Confirmacion_Al_Guardar_Valor_x_Defecto)) = "S" Then
                sigo = MsgBox("Desea Guardar ?", vbYesNo + vbInformation + vbDefaultButton1, MsgTit)
            Else
                sigo = MsgBox("Desea Guardar ?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
            End If
            If sigo = vbNo Then
                Exit Sub
            End If
        End If
    End If
    
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Exit Sub
    End If
    
    'AIR 20211215 se cambia de lugar esta funcion porque se estaba consultando por el tipo de documento en la tabla Documentos
            ' pero dentro de esta rutina cuando se habilita la PREVENTA el codigo de documeto cambia y no se estaba consultando nuevamente en la tabla
    
    ' Se creo esta funcion porque quedo muy largo este proceso y da error al compilar
    If Not Controlar_Datos_Ingresados_Antes_de_Guardar(False) Then
        gbooErrorRobot = True
        Exit Sub
    End If
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        gGuardando_Documento = False
        gbooErrorRobot = True
        Exit Sub
    End If
    
'    AIR 20210811 se comenta porque esta dando error el control.
    If Not Control_Interface_Tarjetas Then
        gGuardando_Documento = False
        gbooErrorRobot = True
        Exit Sub
    End If
'

    'ATU 20180814, se implementa manejo de digitalizador de firmas.
    'If ConfFormato_Factura = "VEICUER" Then
    
   ' AIR 20191127 se agrega que este habilitada la firma en el equipo en que corre
    
    If UCase(Trim(sspOperacion.Caption)) = "A" And D!pide_firma_digital = "S" And ConfFirma_Digital_Habilitado = "S" Then  'Se agrega que sea en ALTA  SS 20191114
        frmFirmaDigitalizada.pstrCodEmp = txtEmpresa.text
        frmFirmaDigitalizada.pstrCodDoc = txtCodDoc.text
        frmFirmaDigitalizada.pstrNroDoc = txtDoc.text
        frmFirmaDigitalizada.pstrCodProv = txtCodProv.text
        frmFirmaDigitalizada.Show 1
    End If

    DoEvents
    cmdGuardar.Enabled = False
    cmdGuardar.Refresh
    DoEvents
    
'    ' Se creo esta funcion porque quedo muy largo este proceso y da error al compilar
'
'    If Not Controlar_Datos_Ingresados_Antes_de_Guardar(False) Then
'        Exit Sub
'    End If
'
    ldblCambioOriginal = CDbl(txtCambio.text)   'guardo el Cambio original                 SS 20151009
    Call Calculo_Total_Medios_Pago(False)              'aca vuelve a calcula el txtCambio
    
    If ldblCambioOriginal <> CDbl(txtCambio.text) Then
        'el txtCambio original se volvio a calcular y cambio, se controla
        
        'ldblCambioCalculado = Importe_Base(txtMoneda.Text, txtTipo_Cambio.Text, txtFec_Doc.Text, txtCambio.Text)
        
        'If Abs(ldblCambioCalculado) > confRedondeo_Tope Then 'si el cambio es mayor a la tolerancia del redondeo, no cae en error    SS 20151013
    
            MsgBox "ATENCION: El TOTAL del Documento NO coincide con el Total Medios Pago, complete la secuencia con ENTER desde el Codigo", vbCritical
            gGuardando_Documento = False
            gbooErrorRobot = True
            TxtComentario.SetFocus
            Exit Sub
        'End If
    End If
       
    ' Se creo esta funcion porque quedo muy largo este proceso y da error al compilar
    'If Not Controlar_Datos_Ingresados_Antes_de_Guardar(False) Then
    '    Exit Sub
    'End If
    
    If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then  'para resgurados NO son clientes    SS 20161107
        glngTipo_Documento_Identidad = val(txtTipo_Doc_Identidad.text)
    Else
        If Not Buscar_Cliente(val(txtCodProv.text), C) Then
            gbooErrorRobot = True
            Exit Sub
        End If
    End If
    
    j = 0
    MousePointer = 11
    DoEvents
   
   lUltimo_Cod_Doc = txtCodDoc.text
   llngNro_Guia = val(txtGuia.text)
   lstrId = ""
   
   Select Case UCase(Trim(sspOperacion.Caption))
      Case "A"
            stbAyuda.Panels(1).text = "Dando Alta al Documento"
            
            Call Ingreso_Datos_Adic_FE
            If Not gDAdicFE.Aceptado Then
                MousePointer = 0
                gGuardando_Documento = False
                Exit Sub
            End If
     
      Case "R"
            MousePointer = 1
            sigo = MsgBox("Desea Re-Imprimir?", vbYesNo + vbInformation, MsgTit)
            If sigo = vbYes Then
                stbAyuda.Panels(1).text = "Re-Imprimiendo el Documento"
                
                Call Cargo_Logtrans("REIMPRESION DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & " " & Trim(txtCodProv.text))
                                
                If esEFactura(val(txtCodDoc.text)) Then
                    Call Imp_Formato_eFACTURA(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(txtMoneda.text), cryImpresion_Factura_Laser)
                Else
                    Select Case val(txtCodDoc.text)
                        Case ConfDoc_Ingreso_Pedido_Cli, ConfDoc_Ingreso_Presupuesto_Cli
                            Call Imprimir_Pedido("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                        Case ConfDoc_Ingreso_PreVenta_Cli
                            Call Imprimir_PreVenta("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                        Case ConfDoc_Ruptura
                            Call Imprimir_Ruptura("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                        Case Else
                            Call Imprimir_Factura("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                    End Select
                End If
                
                ' Impresion si corresponde de VALE  SS 20180312
                If Existe_Vale_para_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text)) Then
                    Call Imp_Formato_Vale_LASER(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), cryImpresion_Factura_Laser)
                End If
                
                gGuardando_Documento = False
                
            Else
                gGuardando_Documento = False
                
            End If
           
             Call MReimpresion_Opciones_Click(0)
             Exit Sub
            
      Case "M"
            MousePointer = 1
            'Si es un remito permitimos modificarlo , si es un pedido tambien, si es una boleta pedimos autorizacion
            If D!tipo_estado_cta <> "R" Then
                If val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And _
                   val(txtCodDoc.text) <> ConfDoc_Ingreso_Presupuesto_Cli Then
                    sigo = MsgBox("Desea Modificar el Documento?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                    If sigo = vbYes Then
                        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                            If Not Autorizacion_Supervision(14, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                gGuardando_Documento = False
                                Exit Sub
                            Else
                                stbAyuda.Panels(1).text = "Modificando el Documento"
                            End If
                        End If
                    Else
                        gGuardando_Documento = False
                        Exit Sub
                    End If
                Else
                    stbAyuda.Panels(1).text = "Modificando el Documento"
                End If
            Else
                stbAyuda.Panels(1).text = "Modificando el Documento"
            End If
            
        Case "U"
            MousePointer = 1
            'Si es un remito permitimos modificarlo , si es un pedido tambien, si es una boleta pedimos autorizacion
            If D!tipo_estado_cta <> "R" Then
                If val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Presupuesto_Cli Then
                    sigo = MsgBox("Desea Modificar y Autorizar el Documento?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                    If sigo = vbYes Then
                        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                            If Not Autorizacion_Supervision(14, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                gGuardando_Documento = False
                                Exit Sub
                            Else
                                stbAyuda.Panels(1).text = "Autorizando el Documento"
                            End If
                        End If
                    Else
                        gGuardando_Documento = False
                        Exit Sub
                    End If
                Else
                    stbAyuda.Panels(1).text = "Autorizando el Documento"
                End If
            Else
                stbAyuda.Panels(1).text = "Autorizando el Documento"
            End If
            
        Case "C"
            MousePointer = 1
            gGuardando_Documento = False
            Exit Sub
            
  End Select
  
'Si el documento no es de exportacion, controlamos ingreso de CI
    If D!exportacion <> "S" Then
        ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtImporte.text)
        If ldblImporte_Base >= 10000 And (ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "CASINO-POS") And ConfProceso_Productos_WIS <> "CLON" Then
            If Trim(TxtCFinal.text) = "X" And Not Validar_CI_Uruguay(TxtRuc.text) Then
                MsgBox "La Factura Supera $10000 Debe Ingresar la CI del Cliente en el Campo RUT" & Chr(13) & "Ingrese sin puntos ni guiones Ej. 20504260 " & Chr(13) & _
                    "El Documento NO SE GRABO AUN", vbInformation, MsgTit
                MousePointer = 1
                gGuardando_Documento = False
                gbooErrorRobot = True
                TxtRuc.SetFocus
                Exit Sub
            End If
        End If
        ldblImporte_Base = 0
    End If

    If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then      ' resguardos        SS 20180723
    Else
        If Trim(UCase(sspOperacion.Caption)) = "A" Or Trim(UCase(sspOperacion.Caption)) = "M" Then
            If ConfPuntoVta_Controla_Limite_Credito Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "G" Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Then
        
                ' JE 2016128    /   con la Opcion de Controlar_Saldo_Cliente_Facturador = G que se controle cuando se va a grabar el docuemnto no en cada linea
                
                If Not Controlar_Saldo_Cliente_al_Guardar(val(txtEmpresa.text), val(txtCodProv.text), val(txtCodDoc.text), txtFec_Doc.text, val(txtMoneda.text), val(txtTipo_Cambio.text), CDbl(NullToZero(txtImporte.text))) Then
                    MousePointer = 1
                    gGuardando_Documento = False
                    gbooErrorRobot = True
                    txtCodProv.SetFocus
                    Exit Sub
                End If
            End If
        End If
    End If
    
    'LC 20170131
    If Not Control_Necesita_Documento_Asociado Then
        MousePointer = 1
        gGuardando_Documento = False
        gbooErrorRobot = True
        txtCodProv.SetFocus
        Exit Sub
    End If
    
    If ConfPuntoVta_Controla_Venta_Menor_PCosto_Boton_Guardar Then
        If Not Controlar_Precio_Venta_Menor_Costo Then
            MousePointer = 1
            gGuardando_Documento = False
            gbooErrorRobot = True
            TxtFactor.SetFocus
            Exit Sub
        End If
    End If

    ' Si se utilizo Tarjeta con Transact - F9, se controla y espera que se haya producido el alta en tabla Faccmp_Baucher_TCredito
    If gbolProceso_Tarjeta Then
        Call Controla_y_Espera_Datos_Baucher_Tarjeta(txtDoc.text)   ' SS 20181224
    End If
          
          
 ' ========================================================================================
    ' AIR 20201113 asigno identificador unico con la  usuario + fecha + hhmmss  =============================================================================
    ' AIR 20201117 se agrega la IP para asegurar mas la unicidad -- Ip + usuario + fecha + hhmmss
    
    'lstrId = (gNro_Usuario & Format(date, "yymmdd") & Format(Time, "hhmmss"))
    lstrId = frmMenu_Principal.Winsock.LocalIP
    lstrId = Replace(lstrId, ".", "") & gNro_Usuario & Format(date, "yyyymmdd") & Format(time, "hhmmss")
    
    gstrTabla_Temporal_Lineas_Mercaderia = "FaccmpLineas_EFactura"
    
    SQL = "SELECT * FROM " & gstrTabla_Temporal_Lineas_Mercaderia
    SQL = SQL & " WHERE Id = " & CDbl(lstrId)
    SQL = SQL & " AND cod_emp = " & val(txtEmpresa.text)
    SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
    SQL = SQL & " AND nro_doc = " & val(txtDoc.text)
    SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
    
    Set lrstLinMercaderia = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If Not lrstLinMercaderia.EOF Then
        Call Borrar_Lineas_Temporal(lstrId)
    End If
    
  ' ========================================================================================


  ' -------------------------------------------------------------------------------------------------------
  ' ========================   COMIENZA LA TRANSACCION DEL DOCUMENTO   ====================================
    
    Call f_Transaccion(Wks, "BEGIN")
  
  ' ---------------------------------------------------------------------------------------
  ' ====================================   NUMERADOR   ====================================
    
    lstrDocIni = txtDoc.text
    If D!ndor_doc <> 0 And UCase(Trim(sspOperacion.Caption)) = "A" And gNumerar = True Then
      ' Pido Nuevamente un nuevo numero por si otro usuario ya lo tomo
        If ConfElegirEmpresa = True And ConfPuntoVta_Numerador_Empresa_Madre > 0 Then
            lEmpresa = ConfPuntoVta_Numerador_Empresa_Madre
        Else
            lEmpresa = txtEmpresa.text
        End If
               
        txtDoc.text = Tomo_Nuevo_Numero_Contador_Documentos(lEmpresa, D!ndor_doc, "D", True)
    End If

    ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtImporte.text)
    'AIR 20240527 esta mal el calculo cuando la moneda es diferente a dolares y pesos, se cambia la rutina
    'ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtImporte.text)
    ldblImporte_Referencia = Importe_Referencia_Segun_Tipo_Cotizacion_Empresa(lEmpresa, txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtImporte.text, "F")
    
    ldblRedondeo_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtRedondeo.text)
    'AIR 20240527 esta mal el calculo cuando la moneda es diferente a dolares y pesos, se cambia la rutina
    'ldblRedondeo_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtRedondeo.text)
    ldblRedondeo_Referencia = Importe_Referencia_Segun_Tipo_Cotizacion_Empresa(lEmpresa, txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtRedondeo.text, "F")

  ' ----------------------------------------------------------------------------------------------------------------------------------------------------
  ' ========================    CARGAMOS TEMPORAL CUANDO ES MODIFICACION/AUTORIZACION PARA ELIMINAR EL DOCUMENTO Y DAR DE ALTA TODO   ==================

    'Call Alta_Temporal_Datos_Pedidos
    
    
    If Not Alta_Temporal_Datos_Pedidos() Then
        gbooErrorRobot = True
        Call MsgBox("ERROR Al procesar Relacion con Pedidos, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
  ' --------------------------------------------------------------------------------------------------------------------------------------
  ' ========================    AFECTAMOS LOS PEDIDOS/PREVENTA QUE SE SELECCIONARON   ===================================================
    
    'Call Alta_Pedidos(llngNumero_Pedido)
    If Not Alta_Pedidos(llngNumero_Pedido) Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Afectar los Pedidos/Preventas Relacionados, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
  
  ' ----------------------------------------------------------------------------
  ' ========================    CABEZAL DEL DOCUMENTO   ========================
    
    If Not Alta_Cabezal_Documento(llngNumero_Pedido, ldblImporte_Base, ldblImporte_Referencia, ldblRedondeo_Base, ldblRedondeo_Referencia) Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Grabar Cabezal del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
  
  ' ----------------------------------------------------------------------------
  ' ========================    CABEZAL AUXILIAR   =============================

    'Call Alta_Cabezal_Auxiliar
    If Not Alta_Cabezal_Auxiliar() Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Grabar Cabezal Auxiliar del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
  ' -----------------------------------------------------------------------------
  ' ========================    CUENTA MADRE   ==================================
  
    'Call Alta_Cuenta_Madre(ldblImporte_Base, ldblImporte_Referencia, ldblRedondeo_Base, ldblRedondeo_Referencia)
    If Not Alta_Cuenta_Madre(ldblImporte_Base, ldblImporte_Referencia, ldblRedondeo_Base, ldblRedondeo_Referencia) Then
        Call MsgBox("ERROR al Grabar Cuenta Madre del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If

 ' ----------------------------------------------------------------------------
  ' ========================    ACOPIOS   =============================

    If Not Alta_Acopio() Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Grabar el Acopio del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If

  ' -----------------------------------------------------------------------------
  ' ========================    PUNTOS DE FIDELIZACION   ========================
  
    'Call Alta_Puntos_Fidelizacion(ldblImporte_Base)
    If Not Alta_Puntos_Fidelizacion(ldblImporte_Base) Then
        Call MsgBox("ERROR al Grabar los Puntos de Fidelizacion del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
  ' -----------------------------------------------------------------------------
  ' ===============================    IMPUESTOS   ==============================

    'Call Alta_Impuestos
    If Not Alta_Impuestos() Then
        Call MsgBox("ERROR al Grabar los Impuestos del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
        
  ' -----------------------------------------------------------------------------
  ' ==========================    MEDIOS DE PAGO   ==============================

    'Call Alta_Medios_Pago
    
    If Not Alta_Medios_Pago_T4(val(lstrDocIni)) Then
        Call MsgBox("ERROR al Grabar los Medios de Pago del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
   
    

 ' ---------------------------------------------------------------------------------------------------------------------------------------------
 ' ==========================    ACTUALIZO EL NRO. DE DOCUMENTO DEFINITIVO EN LA TABLA  Faccmp_Baucher_TCredito   ==============================

    'Call Actualizar_Datos_Baucher_Tarjeta(lstrDocIni)
    If Not Actualizar_Datos_Baucher_Tarjeta(lstrDocIni) Then
        Call MsgBox("ERROR al Grabar los Datos del Voucher de la Tarjeta, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
   
 ' ------------------------------------------------------------------------------------
 ' ==========================    LINEAS DE MERCADERIA    ==============================

    'Call Alta_Lineas_de_Mercaderia
    If Not Alta_Lineas_de_Mercaderia(lstrId) Then
        Call MsgBox("ERROR al Grabar las Lineas de Mercaderia del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
 
 ' ------------------------------------------------------------------------------------------------------
 ' ==========================    LINEAS DE MERCADERIA  - DATOS AUXILIARES  ==============================
 
    'Call Alta_Lineas_Datos_Auxiliares_x_Linea(lNombre_Tabla_Lineas_Auxiliar_Temporal, lstrDocIni)
    If Not Alta_Lineas_Datos_Auxiliares_x_Linea(lNombre_Tabla_Lineas_Auxiliar_Temporal, lstrDocIni) Then
        Call MsgBox("ERROR al Grabar las Lineas Auxiliares del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
 ' ------------------------------------------------------------------------------------------------------
 ' ==========================    LINEAS DE MERCADERIA  - DATOS COTIZACIONES  ==============================
 
    If Not Alta_Lineas_Datos_Cotizaciones_x_Linea(gstrTabla_Temporal_Cotizaciones, val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text)) Then
        Call MsgBox("ERROR al Grabar las Lineas de Cotizaciones del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
    
 ' ----------------------------------------------------------------------------
  ' ========================    ALTA ACOPIOS RELACIONADOS  =============================
    'AIR 20250414
    If Not Guardar_Acopio_Relacionado And D!signo = 1 Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Grabar el Acopio Relacionado por Devolucion, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
  
        

  ' ------------------------------------------------------------------------------------------------------------------------------------------------------------
  ' ========================    CABEZAL DEL DOCUMENTO PRESUPUESTOS (para poder hacer un seguimiento si el documento es tipo_doc ='A' ========================
    
    If Not Alta_Cabezal_Documento_Datos_Presupuesto() Then
        gbooErrorRobot = True
        Call MsgBox("ERROR al Grabar Cabezal del Documento de Datos de Presupuesto de Clientes, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If

 ' ------------------------------------------------------------------------------------
 ' ==========================    LINEAS DE LAS SERIES    ==============================
   
    'Call Alta_Series_Articulos
    If Not Alta_Series_Articulos() Then
        Call MsgBox("ERROR al Grabar las Series de los Articulos del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
 ' -------------------------------------------------------------------------------------
 ' ==========================    LINEAS DE SERVICIOS    ================================

    'Call Alta_Lineas_de_Servicios
    If Not Alta_Lineas_de_Servicios() Then
        Call MsgBox("ERROR al Grabar las Lineas del Documento de Servicio, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
 ' -------------------------------------------------------------------------------------
 ' =========================    ACTUALIZAR PEDIDOS PENDIENTES DEL MOVIL (F10)  =========
 
    If Not Actualizar_Pedidos_F10_en_Moviles() Then
        Call MsgBox("ERROR al Cerrar Pedidos Pendientes del Movil(F10), Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
   
       
  ' ------------------------------------------------------------------------------------
  ' =============================    CHEQUES RECIBIDOS    ==============================
 
    'Call Alta_Cheques_Ingresados
    If Not Alta_Cheques_Ingresados() Then
        Call MsgBox("ERROR al Grabar los Cheques del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
 
 ' -------------------------------------------------------------------------------------
 ' =============================    TARJETAS RECIBIDAS    ==============================
 
    'Call Alta_Tarjetas_Ingresadas
    If Not Alta_Tarjetas_Ingresadas() Then
        Call MsgBox("ERROR al Grabar los Datos del Voucher de la Tarjeta, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
 
 ' -------------------------------------------------------------------------------------
 ' =============================    VALES DE PAGO RECIBIDOS    =========================
 
    'Call Alta_Vales_Ingresados
    If Not Alta_Vales_Ingresados() Then
        Call MsgBox("ERROR al Grabar los Vales del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
 
  ' ------------------------------------------------------------------------------------
  ' ============================    CANCELAR DOCUMENTOS AFECTADOS    ===================
 
    'Call Cancelar_Documentos_Afectados
    If Not Cancelar_Documentos_Afectados() Then
        Call MsgBox("ERROR al Cancelar los Documentos Afectados, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If


  ' ------------------------------------------------------------------------------------
  ' ===============    ACTUALIZACION DE PRECIOS (SI CORRESPONDE)    ====================
    
   ' Call Actualizar_Precios_Venta
    If Not Actualizar_Precios_Venta() Then
        Call MsgBox("ERROR al Actualizar Precios Venta, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If

  ' ------------------------------------------------------------------------------------
  ' ==========================    ACTUALIZACION TABLAS WIS   ===========================

    'Call Alta_Tablas_WIS
    If Not Alta_Tablas_WIS() Then
        Call MsgBox("ERROR al Actualizar Datos en WIS, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
    '----------------------------------------------------------------------------------
    ' ==========================    INGRESAR DOCUMENTO DE ENTREGA A CUENTA POR SESION DE PAGO  ==============================
   
    If Not Alta_Entrega_Cuenta() Then
        Call MsgBox("ERROR al Grabar las Series de los Articulos del Documento, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If
    
  
 
  ' ------------------------------------------------------------------------------------
  ' ===============    ACTUALIZACION DE FICHA VIAJE (SI CORRESPONDE)    ================
   
    'Call Alta_Ficha_Viaje
    If Not Alta_Ficha_Viaje() Then
        Call MsgBox("ERROR al Grabar en Ficha Viaje, Verifique...", (vbExclamation + vbOKOnly))
        Call MarchaAtras
        Exit Sub
    End If


Select Case UCase(Trim(sspOperacion.Caption))

    Case "A"
          
        ' ------------------------------------------------------------------------------------------------
        ' =============================    CANCELAR PEDIDOS AFECTADOS    ==============================
          
        'Call Cancelar_Pedidos_Afectados
        If Not Cancelar_Pedidos_Afectados() Then
            Call MsgBox("ERROR al Cancelar los Pedidos Afectados, Verifique...", (vbExclamation + vbOKOnly))
            Call MarchaAtras
            Exit Sub
        End If
          
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    DAR DE ALTA DOCUMENTO DE STOCK EN OTRO DEPOSITO EN FORMA AUTOMATICA    ==============================
          
        ' AIR 20171005 si la linea tiene deposito diferente al del cabezal generamos el documento de transferencia de stock del deposito de la linea al deposito del cabezal
        If D!Facturador_Ver_Columna_Deposito = "S" And D!stock Then
            If Buscar_Tipo_Documento(val(ConfDoc_Transferencia_Stock), DS) And val(ConfDoc_Transferencia_Stock) <> 0 Then
                If Not Alta_Documento_Transferencia_Stock(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(UCase(txtDeposito.text)), sspOperacion.Caption) Then
                    Call MsgBox("ERROR al Grabar el Movimiento de Stock en el Deposito Origen, Verifique...", (vbExclamation + vbOKOnly))
                    Call MarchaAtras
                    Exit Sub
                End If
            End If
        End If
          
        ' --------------------------------------------------------------------------------------------------------------------------------
        ' =============================    SE GENERA INTERFACE WIS JUSTICIA    ===========================================================
        ' AIR 20230725
        
        If ConfProceso_Productos_WIS = "CASINO" And ConfProceso_Datos_WIS_x_WebService = True And D!tipo_doc = "E" And val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Presupuesto_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli_Web Then
            
             If Not WIS_Generar_Venta_Salon_Justicia_WebService(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text)) Then
                Call MsgBox("Ocurrio un Error en la Interface WIS, el Documento NO fue enviado, Verifique...", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                Exit Sub
        
            End If
        End If
                    
          
        ' ------------------------------------------------------------------------------------------------------------------
        ' =============================    GENERAR ASIENTO CONTABLE   ======================================================
        
        If Not Generar_Asiento_x_Documento("V", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, 0, True) And ConfContabilidad_Controla_Generacion_Asiento_Ventas = "TRUE" Then
            Call MsgBox("No fue posible Generar el Asiento Contable, el Documento NO se registra, Verifique...", (vbExclamation + vbOKOnly))
            Call MarchaAtras
            Exit Sub
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ENVIAR DOCUMENTO A EFACTURA (Si Corresponde)   ======================================================
        
        If esEFactura(val(txtCodDoc.text)) Then
            
            lCfe = localCFE ' Para inicializar
            
            'Call Enviar_Documento_a_eFactura
            If Not Enviar_Documento_a_eFactura(lstrId) Then
                Call MsgBox("ERROR al enviar documento a EFactura", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                
                Call Borrar_Lineas_Temporal(lstrId)
                Exit Sub
            End If
            Call Borrar_Lineas_Temporal(lstrId)
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ALTA DOCUMENTOS POR TIPO DE ENTREGA - AUTOMATICO   ==================================================
        ' JE 20240603   -   Se agrega aqui esta nueva funcion de alta de los documentos que se generar automaticamenta segun los tipos de entrega
        '                   y que no son generados desde el formulario donde pide los datos de entrega
        
        If Alta_Documento_Automatico_Desde_Otro_x_Tipo_Entrega(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(TxtCodSuc.text), Trim(txtNomCli.text), Trim(TxtRuc.text)) Then
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    BAJA DOCUMENTOS POR TIPO DE ENTREGA - AUTOMATICO (Si es una nota de Credito y/o Debito) =============
        ' JE 20240614   -   Se agrega aqui esta nueva funcion de alta de los documentos que se generar automaticamenta segun los tipos de entrega
        '                   y que no son generados desde el formulario donde pide los datos de entrega
        
        If Anular_Documento_Generado_Automaticamente_Con_Datos_Entrega(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text)) Then
        End If
        
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    CERRAR TRANSACCION DEL DOCUMENTO BASE    ===========================================================
                  
        Call Cargo_Logtrans("ALTA DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & " " & Trim(txtCodProv.text))
        Call f_Transaccion(Wks, "COMMIT")
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' --------------------------------------------------------------------------------------------------------------------------------------
        
        
        
        
        
        
        
        
        If esEFactura(val(txtCodDoc.text)) Then
            ' ----------------------------------------------------------------------------------------------------------------------------------
            ' =============================    IMPRESION EFACTURA  =============================================================================
        
            Call Impresion_eFactura
        
        Else
            ' ----------------------------------------------------------------------------------------------------------------------------------
            ' =============================    IMPRESION TRADICIONAL  ==========================================================================
            
            Call Impresion_Tradicional_Segun_Configuracion
        
        End If
        
        
        'If Trim(ConfFormatoVoucherTarjetaRpt) = "S" Then
        '     If Imprimir_Voucher_Tarjeta(Me.txtEmpresa.text, Me.txtCodDoc.text, Me.txtDoc.text, Me.txtCodProv.text, Me.txtCaja.text, Me.CrystalReport1) Then
        '     End If
        'End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ACTUALIZAR TABLAS MOVILES - FACTURAS PENDIENTES   ===================================================
        
        Call Actualizar_Tabla_MOVIL_Facturas_Pendientes_x_Documento(val(txtEmpresa.text), val(txtCodProv.text), val(txtCodDoc.text), val(txtDoc.text), "N")
                
        If ConfMovil_Procesa_Calculo_Saldo_Credito = True Then
            Call Actualizar_Tabla_MOVIL_Clientes(val(txtCodProv.text), "N", "M", 0, True)       'SS 20190716
        End If
                
     Case "M"
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    DAR DE ALTA DOCUMENTO DE STOCK EN OTRO DEPOSITO EN FORMA AUTOMATICA    ==============================
        
        ' AIR 20171005 si la linea tiene deposito diferente al del cabezal generamos el documento de transferencia de stock del deposito de la linea al deposito del cabezal
        If D!Facturador_Ver_Columna_Deposito = "S" And D!stock = 1 Then
            If Buscar_Tipo_Documento(val(ConfDoc_Transferencia_Stock), DS) And val(ConfDoc_Transferencia_Stock) <> 0 Then
            
                If Not Alta_Documento_Transferencia_Stock(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(UCase(txtDeposito.text)), sspOperacion.Caption) Then
                    Call MsgBox("ERROR al Grabar el Movimiento de Stock en el Deposito Origen, Verifique...", (vbExclamation + vbOKOnly))
                    Call MarchaAtras
                    Exit Sub
                End If
            End If
        End If
        
        ' ------------------------------------------------------------------------------------------------------------------
        ' =============================    GENERAR ASIENTO CONTABLE   ======================================================
        
        If Not Generar_Asiento_x_Documento("V", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, 0, True) And ConfContabilidad_Controla_Generacion_Asiento_Ventas = "TRUE" Then
            Call MsgBox("No fue posible Generar el Asiento Contable, el Documento NO se Modifica, Verifique...", (vbExclamation + vbOKOnly))
            Call MarchaAtras
            Exit Sub
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ENVIAR DOCUMENTO A EFACTURA (Si Corresponde)   ======================================================
        
        If esEFactura(val(txtCodDoc.text)) Then
                
            lCfe = localCFE ' Para inicializar
            
            If Not Enviar_Documento_a_eFactura(lstrId) Then
                Call MsgBox("ERROR al enviar documento a EFactura", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                Exit Sub
            End If
        End If
        
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    CERRAR TRANSACCION DEL DOCUMENTO BASE    ===========================================================
        
        Call Cargo_Logtrans("MODIFICACION DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & " " & Trim(txtCodProv.text))
        Call f_Transaccion(Wks, "COMMIT")

        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' --------------------------------------------------------------------------------------------------------------------------------------
        
        
        If esEFactura(val(txtCodDoc.text)) Then
            ' ----------------------------------------------------------------------------------------------------------------------------------
            ' =============================    IMPRESION EFACTURA  =============================================================================
        
            Call Impresion_eFactura
        
        Else
            ' ----------------------------------------------------------------------------------------------------------------------------------
            ' =============================    IMPRESION TRADICIONAL  ==========================================================================
            
            Call Impresion_Tradicional_Segun_Configuracion
        
        End If
        
        

        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ACTUALIZAR TABLAS MOVILES - FACTURAS PENDIENTES   ===================================================
        
        Call Actualizar_Tabla_MOVIL_Facturas_Pendientes_x_Documento(val(txtEmpresa.text), val(txtCodProv.text), val(txtCodDoc.text), val(txtDoc.text), "N")
     
        If ConfMovil_Procesa_Calculo_Saldo_Credito = True Then
            Call Actualizar_Tabla_MOVIL_Clientes(val(txtCodProv.text), "N", "M", 0, True)       'SS 20190716
        End If
     
     Case "U"
        
        ' --------------------------------------------------------------------------------------------------------------------------------
        ' =============================    SE GENERA INTERFACE WIS JUSTICIA    ===========================================================
'
'        If ConfProceso_Productos_WIS = "CASINO" Then
'            'Call interface_WIS_Pedidos_Clientes(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text)
'            If Not interface_WIS_Pedidos_Clientes(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
'                Call MsgBox("Ocurrio un Error en la Interface WIS, el Documento NO se Modifica, Verifique...", (vbExclamation + vbOKOnly))
'                Call MarchaAtras
'                Exit Sub
'            End If
'        End If
        
        If ConfProceso_Productos_WIS = "CASINO" Then
            'Call interface_WIS_Pedidos_Clientes(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text)
           'AIR 20230725
            
            lstrTipoPedido = "NORM"
            If val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli_Web Or InStr(txtObs.text, "WWEB") Then
                lstrTipoPedido = "WEB"
                txtObs.text = "WEB -" & Trim(txtObs.text)
            Else
                txtObs.text = "NORM -" & Trim(txtObs.text)
            End If
            
            If Not interface_WIS_Pedidos_Clientes(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lstrTipoPedido) Then
                Call MsgBox("Ocurrio un Error en la Interface WIS, el Documento NO se Modifica, Verifique...", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                Exit Sub
            End If
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------
        ' =============================    SE GENERA INTERFACE WIS APARICIO    ===========================================================
        
        If ConfProceso_Productos_WIS = "CLON" Then
            'Call interface_WIS_Pedidos_Clientes_Aparicio(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text)
            ' AIR 20230317
            lstrTipoPedido = "PROG"
            If InStr(txtObs.text, "WREPO") Then
                lstrTipoPedido = "REPO"
            End If
            
            If InStr(txtObs.text, "WWEB") Then
                lstrTipoPedido = "WEB"
            End If
            
            If Not interface_WIS_Pedidos_Clientes_Aparicio(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lstrTipoPedido) Then
                Call MsgBox("Ocurrio un Error en la Interface WIS, el Documento NO se Modifica, Verifique...", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                Exit Sub
            End If
        End If
        
        ' ------------------------------------------------------------------------------------------------------------------
        ' =============================    GENERAR ASIENTO CONTABLE   ======================================================
        
        If Not Generar_Asiento_x_Documento("V", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, 0, True) And ConfContabilidad_Controla_Generacion_Asiento_Ventas = "TRUE" Then
            Call MsgBox("No fue posible Generar el Asiento Contable, el Documento NO se Autoriza, Verifique...", (vbExclamation + vbOKOnly))
            Call MarchaAtras
            Exit Sub
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    ENVIAR DOCUMENTO A EFACTURA (Si Corresponde)   ======================================================
        
        If esEFactura(val(txtCodDoc.text)) Then
            'EFACTURA, para los que fueron simulados sin autorizar y se autorizan y generan un CFE
                
            lCfe = localCFE ' Para inicializar
            
            If Not Enviar_Documento_a_eFactura(lstrId) Then
                Call MsgBox("ERROR al enviar documento a EFactura", (vbExclamation + vbOKOnly))
                Call MarchaAtras
                Exit Sub
            End If
              
        End If
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =============================    CERRAR TRANSACCION DEL DOCUMENTO BASE    ===========================================================
        
        Call Cargo_Logtrans("AUTORIZACION DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & " " & Trim(txtCodProv.text))
        Call f_Transaccion(Wks, "COMMIT")
        
        ' --------------------------------------------------------------------------------------------------------------------------------------
        ' =================   ACTUALIZAR TABLAS MOVILES - FACTURAS PENDIENTES y SALDO DEL CREDITO   ============================================
        
        Call Actualizar_Tabla_MOVIL_Facturas_Pendientes_x_Documento(val(txtEmpresa.text), val(txtCodProv.text), val(txtCodDoc.text), val(txtDoc.text), "N")
        
        If ConfMovil_Procesa_Calculo_Saldo_Credito = True Then
            Call Actualizar_Tabla_MOVIL_Clientes(val(txtCodProv.text), "N", "M", 0, True)       'SS 20190716
        End If
        
End Select
 
 
' ----------------------------------------------------------------------------------------------------------------------------
' =============================    GUARDAR ULTIMO DOCUMENTO INGRESADO   ======================================================
 
Call Guardo_Ultimo_Documento_Dado_Alta_o_Modificado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text)


' ' ------------------------------------------------------------------------------------------------------------------
' ' =============================    GENERAR ASIENTO CONTABLE   ======================================================
' AIR 20180730 se traslada la llamada al case antes de la llamada del envio a fact electronica, sino no se puede hacer rollback si ya se d la Efactura
' If Generar_Asiento_x_Documento("V", txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text, 0, true) Then
' End If
'


 ' ------------------------------------------------------------------------------------------------------------------
 ' =============================    SE EJECUTAN LOS PROCESOS POS GUARDAR / DATOS ENTREGA   ==========================

 
 llngCod_Emp = val(txtEmpresa.text)
 llngCod_Doc = val(txtCodDoc.text)
 llngNro_Doc = val(txtDoc.text)
 llngCod_Prov = val(txtCodProv.text)
 gdteFecha_Documento = CDate(txtFec_Doc.text)

 Select Case UCase(Trim(sspOperacion.Caption))
 
    Case "A"
    
        
    
        ' Impresion si corresponde de VALE  SS 20180312
        If Existe_Vale_para_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text)) Then
            Call Imp_Formato_Vale_LASER(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), cryImpresion_Factura_Laser)
        End If
        
        If Buscar_Tipo_Documento(llngCod_Doc, RD) Then
            If Trim(UCase(RD!pide_datos_entrega)) = "S" Then
                If Hay_Lineas_Con_Tipo_Entrega_Que_Solicita_Datos_Entrega(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, lrstTipos_Entrega_Pide_Datos_Entrega) Then
                    Call Cambio_gbolESC     ' Para que no ejecute el lost focus en txtCodDoc, en MAlta_Click para cuando hay ENVIOS     SS 20171212
                End If
            End If
        End If
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            ' JE 20200824   /   Se borran las lineas de Mercaderia para que no se ejecute el control en el Alta.
            vsfLineas_Mercaderia.Rows = 1
        End If
        
        llngCod_Doc_Preventa = glngCod_Doc_Preventa
        llngNro_Doc_Preventa = glngNro_Doc_Preventa
        lstrNombre_Cliente = Trim(txtNomCli.text)
        lstrRUT = Trim(TxtRuc.text)
        
        Call MAlta_Click
        DoEvents
        
'        AIR 20241118
        lblnYaImpri_x_Form_Pide_Datos_Entrega = False
        ' 20240613  /   Se pasa esta Consulta que devuelve ahora un Recordset con los Tipos de Entrega que Piden Datos
        '               (por ahora se toma el primero que encuentra porque la tabla faccmp_Entrega_Mercaderia_Cabezal no contempla varias Tipo de Entrega
        'AIR 20241122
        If Hay_Lineas_Con_Tipo_Entrega_Que_Solicita_Datos_Entrega(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, lrstTipos_Entrega_Pide_Datos_Entrega) Then
            
            lblnYaImpri_x_Form_Pide_Datos_Entrega = True
            
            ' JE 20230905   /   Se baja el formulario por si quedo abierto para que se puedan llamar nuevamente con parametros nuevos
            Unload frmPunto_Venta_Datos_de_Entrega

            frmPunto_Venta_Datos_de_Entrega.plngCod_Emp = llngCod_Emp
            frmPunto_Venta_Datos_de_Entrega.plngCod_Doc = llngCod_Doc
            frmPunto_Venta_Datos_de_Entrega.plngNro_Doc = llngNro_Doc
            frmPunto_Venta_Datos_de_Entrega.plngCliente = llngCod_Prov
            frmPunto_Venta_Datos_de_Entrega.plngTipo_Entrega = lrstTipos_Entrega_Pide_Datos_Entrega!codigo_tipo_entrega
            frmPunto_Venta_Datos_de_Entrega.Cambio_gbolESC      ' para que cargue los datos en el validate de txtDoc    SS 20171020
            frmPunto_Venta_Datos_de_Entrega.plngCod_Doc_Preventa = llngCod_Doc_Preventa
            frmPunto_Venta_Datos_de_Entrega.plngNro_Doc_Preventa = llngNro_Doc_Preventa
            
            frmPunto_Venta_Datos_de_Entrega.pstrNombre_Cliente = lstrNombre_Cliente
            frmPunto_Venta_Datos_de_Entrega.pstrRUC = lstrRUT
            frmPunto_Venta_Datos_de_Entrega.pstrFormulario_Origen = Me.Name
            
            frmPunto_Venta_Datos_de_Entrega.pstrOperacion = "A"

            frmPunto_Venta_Datos_de_Entrega.Show
            
            DoEvents
            glngCod_Doc_Preventa = 0
            glngNro_Doc_Preventa = 0

        End If
       
        'AIR 20241118 se agrega que verifique si hay tipo de entrega que no solicitan datos pero imprime
       ' If Hay_Lineas_Con_Tipo_Entrega_Que_NO_Solicita_Datos_Entrega_Solo_Impresion(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov) Then
               
        If (Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) <> "N" And lblnYaImpri_x_Form_Pide_Datos_Entrega = False) _
           Or (Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) <> "N" And ConfPuntoVta_Datos_Entrega_Formato_Imp_Tipo_Entrega = 4) Then   ' And lblnYaImpri_x_Form_Pide_Datos_Entrega = True
    
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "S" Then
                ' JE 20180313   /   Conservo este parametro con S para la Impresion por eFactura
                Call Imprimir_Ticket_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov)
            End If
    
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "L" Then
                ' JE 20180313   /  Para Imprimir en Impresora Local con un RPT Configurado
                ' JE 20240603   /   internamente en la funcion filtro por los tipos de mercaderia que tienen codigo de documento
                Call Imprimir_Laser_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, RD!imprimir_ticket_x_tipo_entrega, cryImpresion_Factura_Laser)
            End If
        
        End If
                
        'AIR 20241118 se cambia nombre funcion para mas claridad ya que son las lineas pide_datos_entrega <> 'S'las que se toman y que tienen documento asociado
        'If Hay_Lineas_Con_Tipo_Entrega_Que_Solicita_Datos_Entrega_Solo_Impresion(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, lrstLinMercaderia_Con_Tipos_Entrega_Pide_Datos_Entrega) Then
        If Hay_Lineas_Con_Tipo_Entrega_Doc_Asociado_Solo_Impresion(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, lrstLinMercaderia_Con_Tipos_Entrega_Pide_Datos_Entrega) Then
            ' JE 20230905   /   Rutina Generica de Impresion de Remitos de Entrega
            Call Imp_Formato_Entrega_Mercaderia_GENERICO_LASER(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, llngCod_Doc, Me.cryImpresion_Factura_Laser, SAL_IMPRESORA)
       End If
       
       
     Case "M"
        
        If Buscar_Tipo_Documento(llngCod_Doc, RD) Then
        End If
        
        ' JE 20240607   -    Incluyo aqui ademas de chequear si el Docuemnto tiene configurado que Imprime (independiente del tipo de entrega)
        If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) <> "N" And Trim(UCase(RD!se_Imprime)) = "S" Then
        
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "S" Then
                ' JE 20180313   /   Conservo este parametro con S para la Impresion por eFactura
                Call Imprimir_Ticket_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov)
            End If
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "L" Then
                ' JE 20180313   /  Para Imprimir en Impresora Local con un RPT Configurado
                Call Imprimir_Laser_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, RD!imprimir_ticket_x_tipo_entrega, cryImpresion_Factura_Laser)
            End If
        
        End If
        
        Call MModificacion_Click
     
     Case "U"
     
        If Buscar_Tipo_Documento(llngCod_Doc, RD) Then
        End If
        
        If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) <> "N" And Trim(UCase(RD!se_Imprime)) <> "N" Then
            
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "S" Then
                ' JE 20180313   /   Conservo este parametro con S para la Impresion por eFactura
                Call Imprimir_Ticket_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov)
            End If
            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "A" Or Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "L" Then
                ' JE 20180313   /  Para Imprimir en Impresora Local con un RPT Configurado
                Call Imprimir_Laser_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, RD!imprimir_ticket_x_tipo_entrega, cryImpresion_Factura_Laser)
            End If
        
        End If
        
        
        Call Impresion_Tradicional_Segun_Configuracion
        
        Call MAutorizar_Opciones_Click(1)
        
 End Select
    
    ' AIR 20250307 se vuleve la variable a su valor original
    If Buscar_Variable_Global("PuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos", R) Then
        ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = Trim(R!valor)
    End If
    
    MousePointer = 1
    lNombre_Tabla_Temporal = ""
    
Exit Sub

Errores:

    Call FErrores
    Call Mensaje_Error_Guardar(Me)
    Call Borrar_Lineas_Temporal(lstrId)

    gGuardando_Documento = False
    Exit Sub
    Resume
End Sub



Private Sub MarchaAtras()
    gbooErrorRobot = True
    Call f_Transaccion(Wks, "ROLLBACK")
    gGuardando_Documento = False
    MousePointer = 1
    cmdGuardar.Enabled = True

End Sub

Private Sub cmdGuardar_GotFocus()
    stbAyuda.Panels(1).text = "Presione <ENTER> para Ingresar/Modificar el Documento"
End Sub

Private Sub dbgLineas_Servicios_AfterDelete(RtnDispErrMsg As Integer)
    
    Call Calculo_Total_Lineas_Servicios(dbgLineas_Servicios, True)
    
End Sub


Private Sub dbgLineas_Servicios_GotFocus()

    stbAyuda.Panels(1).text = "<F3> Copiar Lineas Otro Documento - <F6> Seleccionar Ficha de Viaje - <F8> Seleccionar Documento a Retener - <F10> Seleccionar Remitos/Solo Cabezal - <F12> Ingreso D.Auxiliares"

End Sub

Private Sub dbgLineas_Servicios_KeyDown(KeyCode As Integer, Shift As Integer)
Dim aux As Integer
Dim i As Integer
Dim R As Recordset
Dim PV As Recordset
Dim lrstDocumentos As Recordset
Dim lbolResguardo As Boolean
Dim lbolHabilitar_Boton_Guardar As Boolean
Dim C As Recordset

On Error GoTo Errores
    
    If KeyCode = vbKeyReturn Then
        
        'Controlo el Tope
        If Trim(dbgLineas_Servicios.Columns("unidades").text) = "" Then
            sstDetalle_Pagos.Tab = 0
            txtForma_Pago.SetFocus
            Exit Sub
        End If
        
        If dbgLineas_Servicios.Rows >= llngMaximo_Lineas Then
            MsgBox "Llegó al Tope de Lineas Permitido", vbExclamation, MsgTit
            sstDetalle_Pagos.Tab = 0
            txtForma_Pago.SetFocus
            Exit Sub
        End If
        
        lbolResguardo = False
        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumentos) Then
            If lrstDocumentos!tipo_doc = "G" Then
                lbolResguardo = True
            End If
        End If
        
        Select Case dbgLineas_Servicios.Col
            
            Case CGS_UNIDADES   ' UNIDADES
                If Trim(dbgLineas_Servicios.Columns("unidades").text) = "" Then
                    dbgLineas_Servicios.MovePrevious
                    Call Calcular_Importes_de_la_Linea_Servicios(True, "", lbolResguardo)
                    Call Color_Control_Seleccionado(Me, txtForma_Pago)
                    Call MarcarTexto(txtForma_Pago)
                Else
                    If Trim(dbgLineas_Servicios.Columns("unidades").text) = "0" Then
                        MsgBox "La cantidad de Unidades No puede ser Nulo", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_UNIDADES
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_UNIDADES
                    Else
                        If Not IsNumeric(dbgLineas_Servicios.Columns("unidades").text) Then
                            MsgBox "La cantidad de Unidades debe ser un Número Válido", vbCritical, MsgTit
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                        Else
                            dbgLineas_Servicios.Col = CGS_CODIGO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_CODIGO

                        End If
                    End If
                End If
                
                       
            
            Case CGS_CODIGO   ' CODIGO
                If Trim(dbgLineas_Servicios.Columns("codigo").text) = "" Then
                    MsgBox "El Código del Insumo y/o Servicio No puede ser Nulo", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_CODIGO
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_CODIGO

                Else
                    If Not IsNumeric(dbgLineas_Servicios.Columns("codigo").text) Then
                        MsgBox "El Código del Insumo y/o Servicio debe ser un Número Válido", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_CODIGO
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_CODIGO
                    Else
                        If Not Busco_Insumo_Servicio(dbgLineas_Servicios.Columns("codigo").text, R) Then
                            MsgBox "Insumo y/o Servicio Inexistente", vbInformation, MsgTit
                            dbgLineas_Servicios.Col = CGS_CODIGO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_CODIGO
                        Else
                            If lbolResguardo And R!codigo_retencion_dgi = "" Then
                                MsgBox "Código Ingresado No corresponde a Código de Retención para Resguardos", vbInformation, MsgTit
                                dbgLineas_Servicios.Col = CGS_CODIGO
                                dbgLineas_Servicios.SetFocus
                                dbgLineas_Servicios.Col = CGS_CODIGO
                            Else
                                ' AIR 20210211 se quita este control porque existen servicios con codigo de retencion de dgi por otros conceptos que no es resguardo y es correcto que se utilicen aqui como ser los Alquileres
'                                If Not lbolResguardo And R!codigo_retencion_dgi <> "" Then
'                                    MsgBox "Código Ingresado Corresponde a Documentos de Resguardo", vbInformation, MsgTit
'                                    dbgLineas_Servicios.Col = CGS_CODIGO
'                                    dbgLineas_Servicios.SetFocus
'                                    dbgLineas_Servicios.Col = CGS_CODIGO
'                                Else
                                    If Trim(UCase(R!tipo_documentos)) = "V" Or Trim(UCase(R!tipo_documentos)) = "T" Then
                                        dbgLineas_Servicios.Columns("descripcion").text = Trim(R!Descripcion)
                                        
                                        'If Trim(dbgLineas_Servicios.Columns("seccion").text) = "" Then
                                            'ATU 20180619 - Se trae la seccion x defecto del servicio.
                                            dbgLineas_Servicios.Columns("seccion").text = R!seccion_x_defecto_facturar
                                            If Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
                                                dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
                                            End If
                                        'End If
                                        
                                        ' AIR 01/04/2016
                                        
                                        If R!Activo = "N" Then
                                            MsgBox "El Insumo y/o Servicio NO esta Activo. Verifique", vbInformation, MsgTit
                                            
                                        Else
                                            'AIR 20220722 se agrega que cargue el % si tienen definido en el servicio
                                            If lbolResguardo Then
                                                dbgLineas_Servicios.Columns("tasa_resguardo").text = IIf(IsNull(R!porcentaje_retencion_dgi), 0, R!porcentaje_retencion_dgi)
                                            Else
                                                dbgLineas_Servicios.Columns("tasa_resguardo").text = 0
                                            End If
                                            
                                            If Trim(dbgLineas_Servicios.Columns("tiva").text) = "" Then
                                                dbgLineas_Servicios.Columns("tiva").text = R!cod_iva
                                                dbgLineas_Servicios.Columns("tcofis").text = 1
                                                dbgLineas_Servicios.Columns("cofis").text = 0
                                                dbgLineas_Servicios.Columns("cofis_iva").text = 0
                                                                            
                                                If Busco_Impuesto("IVA", dbgLineas_Servicios.Columns("tiva").text) Then
                                                    dbgLineas_Servicios.Columns("tcofis_iva").text = dbgLineas_Servicios.Columns("tiva").text
                                                    dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, date), "#0.00")
                                                Else
                                                    dbgLineas_Servicios.Columns("tcofis_iva").text = "1"
                                                    dbgLineas_Servicios.Columns("iva").text = "0"
                                                End If
                                            End If
                                            
                                            If Precio_Vigente_Insumo_Servicio(val(dbgLineas_Servicios.Columns("codigo").text), val(txtLista.text), CDate(txtFec_Doc.text), PV) Then
                                                dbgLineas_Servicios.Columns("precio_siva").text = Format(PV!Precio, "0.00")
                                                dbgLineas_Servicios.Columns("precio").text = Format(PV!Precio, "0.00")
                                            Else
                                                dbgLineas_Servicios.Columns("precio_siva").text = "0.00"
                                                dbgLineas_Servicios.Columns("precio").text = "0.00"
                                            End If
                                                                                       
                                            Call Calcular_Importes_de_la_Linea_Servicios(True, "", lbolResguardo)
                                                                            
                                            dbgLineas_Servicios.Columns("eliminada").Value = False
                                            
                                            If Trim(UCase(R!permite_cambiar_desc)) = "S" Then
                                                dbgLineas_Servicios.Col = CGS_DESCRIPCION
                                                dbgLineas_Servicios.SetFocus
                                                dbgLineas_Servicios.Col = CGS_DESCRIPCION
                                            Else
                                                dbgLineas_Servicios.Col = CGS_SECCION
                                                dbgLineas_Servicios.SetFocus
                                                dbgLineas_Servicios.Col = CGS_SECCION
                                            End If

                                        End If
                                    Else
                                        MsgBox "Insumo y/o Servicio No Se Puede Utilizar en Documentos de Venta", vbInformation, MsgTit
                                    End If
                                'End If
                            End If
                        End If
                    End If
                End If
            
            Case CGS_DESCRIPCION   ' DESCRIPCION
                If Not Busco_Insumo_Servicio(dbgLineas_Servicios.Columns("codigo").text, R) Then
                    MsgBox "Insumo y/o Servicio Inexistente", vbInformation, MsgTit
                    dbgLineas_Servicios.Col = CGS_CODIGO
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_CODIGO
                Else
                    If Trim(dbgLineas_Servicios.Columns("descripcion").text) = "" Then
                        MsgBox "La Descripción No puede ser Nula", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_DESCRIPCION
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_DESCRIPCION
                    Else
                        If Trim(UCase(R!permite_cambiar_desc)) <> "S" Then
                            dbgLineas_Servicios.Columns("descripcion").text = Trim(R!Descripcion)
                        End If
                        dbgLineas_Servicios.Col = CGS_SECCION
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_SECCION
                    End If
                    dbgLineas_Servicios.Columns("eliminada").Value = False
                End If
                
            Case CGS_SECCION   ' SECCION
                If Trim(dbgLineas_Servicios.Columns("seccion").text) = "" Then
                    MsgBox "La Sección No puede ser Nula", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_SECCION
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_SECCION

                Else
                    If Not IsNumeric(dbgLineas_Servicios.Columns("seccion").text) Then
                        MsgBox "El Código de la Sección debe ser un Número Válido", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_SECCION
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_SECCION
                    Else
                        If Not Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
                            MsgBox "Sección Inexistente", vbInformation, MsgTit
                            dbgLineas_Servicios.Col = CGS_SECCION
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_SECCION

                        Else
                            If Trim(UCase(rstSecciones!tipo_documentos)) = "V" Or Trim(UCase(rstSecciones!tipo_documentos)) = "T" Then
                                dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
                                If Trim(rstSecciones!cod_tip_Impuesto) = "IVA" Then
                                    dbgLineas_Servicios.Columns("tiva").text = Trim(rstSecciones!cod_impuesto)
                                End If
                                If Busco_Impuesto("IVA", dbgLineas_Servicios.Columns("tiva").text) Then
                                    dbgLineas_Servicios.Columns("tcofis_iva").text = dbgLineas_Servicios.Columns("tiva").text
                                    dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, date), "#0.00")
                                Else
                                    dbgLineas_Servicios.Columns("tcofis_iva").text = "1"
                                    dbgLineas_Servicios.Columns("iva").text = "0"
                                End If
                                
                                dbgLineas_Servicios.Columns("tcofis").text = "0"
                                dbgLineas_Servicios.Columns("cofis").text = "0"
                                
                                If lbolResguardo Then
                                    dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                                    dbgLineas_Servicios.SetFocus
                                    dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                                Else
                                    dbgLineas_Servicios.Col = CGS_TIVA
                                    dbgLineas_Servicios.SetFocus
                                    dbgLineas_Servicios.Col = CGS_TIVA
                                End If
                                
                                ' AIR 20170504
                                If ConfFormato_Factura = "HERTZ" And dbgLineas_Servicios.Columns("seccion").text <> "0" Then
                                    dbgLineas_Servicios.Columns("tiva").Locked = True
                                Else
                                    dbgLineas_Servicios.Columns("tiva").Locked = False
                                End If
                                
                            Else
                                MsgBox "La Seccion No Se Puede Utilizar en Documentos de Venta", vbInformation, MsgTit
                                dbgLineas_Servicios.Col = CGS_SECCION
                                dbgLineas_Servicios.SetFocus
                                dbgLineas_Servicios.Col = CGS_SECCION
                            End If
                        End If
                    End If
                End If
            
            Case CGS_TCOFIS  ' COFIS
                If Trim(dbgLineas_Servicios.Columns("tcofis").text) = "" Then
                    MsgBox "La Tasa de Cofis No puede ser Nula", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_TCOFIS
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_TCOFIS
                Else
                    If IsNumeric(dbgLineas_Servicios.Columns("tcofis").text) Then
                        If Busco_Impuesto("COFIS", dbgLineas_Servicios.Columns("tcofis").text) Then
                            dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, date), "#0.00")
                            
                            If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
                                dbgLineas_Servicios.Columns("cofis_iva").text = 0
                            Else
                                dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
                            End If
                            dbgLineas_Servicios.Col = CGS_COFIS
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_COFIS
                        Else
                            gbolESC = True
                            MsgBox "Código de COFIS Inexistente", vbInformation, MsgTit
                            dbgLineas_Servicios.Col = CGS_TCOFIS
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_TCOFIS
                        End If
                    Else
                        gbolESC = True
                        MsgBox "El Código de COFIS Debe ser un número Válido", vbInformation, MsgTit
                        dbgLineas_Servicios.Col = CGS_TCOFIS
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_TCOFIS
                    End If
                End If
                
            Case CGS_TIVA  ' IVA
                If Trim(dbgLineas_Servicios.Columns("tiva").text) = "" Or Trim(dbgLineas_Servicios.Columns("tiva").text) = "0" Then
                    MsgBox "La Tasa de IVA No puede ser Nula", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_TIVA
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_TIVA

                Else
                    If Not IsNumeric(dbgLineas_Servicios.Columns("tiva").text) Then
                        MsgBox "La Tasa de IVA debe ser un Número Válido", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_TIVA
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_TIVA
                    Else
                        If Busco_Impuesto("IVA", dbgLineas_Servicios.Columns("tiva").text) Then
                            dbgLineas_Servicios.Columns("tcofis_iva").text = dbgLineas_Servicios.Columns("tiva").text
                            dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, date), "#0.00")
                            dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                        Else
                            MsgBox "La Tasa de IVA No Existe", vbCritical, MsgTit
                            dbgLineas_Servicios.Col = CGS_TIVA
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_TIVA
                        End If
                    End If
                End If
            
            Case CGS_PUNITARIO_SIVA   ' PRECIO sin iva
                If Not IsNumeric(dbgLineas_Servicios.Columns("precio_siva").text) Then
                    MsgBox "El Precio debe ser un Número Válido", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                Else
                    If esEFactura(val(txtCodDoc.text)) And Not lbolResguardo And dbgLineas_Servicios.Columns("precio_siva").text < 0 Then   'SS 20181207
                        MsgBox "El Precio NO puede ser Negativo", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_PUNITARIO_SIVA
                    Else
                        Call Calcular_Importes_de_la_Linea_Servicios(True, "N", lbolResguardo)
                        If lbolResguardo Then
                            dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                        Else
                            dbgLineas_Servicios.Col = CGS_PUNITARIO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_PUNITARIO
                        End If
                    End If
                End If
                
            Case CGS_PUNITARIO   ' PRECIO
                If Trim(dbgLineas_Servicios.Columns("precio").text) = "" Then
                    MsgBox "El precio No puede ser Nulo", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_PUNITARIO
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_PUNITARIO
                Else
                    If Not IsNumeric(dbgLineas_Servicios.Columns("precio").text) Then
                        MsgBox "El Precio debe ser un Número Válido", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_PUNITARIO
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_PUNITARIO
                    Else
                        If esEFactura(val(txtCodDoc.text)) And Not lbolResguardo And dbgLineas_Servicios.Columns("precio").text < 0 Then     'SS 20181207
                            MsgBox "El Precio NO puede ser Negativo", vbCritical, MsgTit
                            dbgLineas_Servicios.Col = CGS_PUNITARIO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_PUNITARIO
                        Else
                            Call Calcular_Importes_de_la_Linea_Servicios(True, "S", lbolResguardo)
                            dbgLineas_Servicios.MoveNext
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                        End If
                    End If
                End If
        
            Case CGS_TASA_RESGUARDO     ' TASA RETENCION RESGUARDO
                If Trim(dbgLineas_Servicios.Columns("tasa_resguardo").text) = "" Then
                    MsgBox "La Tasa No puede ser Nula", vbCritical, MsgTit
                    dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                Else
                    If Not IsNumeric(dbgLineas_Servicios.Columns("tasa_resguardo").text) Then
                        MsgBox "La Tasa debe ser un Número Válido", vbCritical, MsgTit
                        dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                    Else
                        If val(dbgLineas_Servicios.Columns("tasa_resguardo").text) = 0 Or val(dbgLineas_Servicios.Columns("tasa_resguardo").text) > 100 Then    'Agrego control tasa <> 0   SS 20181030
                            MsgBox "La Tasa debe ser un Número Válido", vbCritical, MsgTit
                            dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_TASA_RESGUARDO
                        Else
                            Call Calcular_Importes_de_la_Linea_Servicios(True, "N", lbolResguardo) 'N al ser resguardo es un importe sin impuestos SS 20180813
                            dbgLineas_Servicios.MoveNext
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = CGS_UNIDADES
                        End If
                    End If
                End If
        
        End Select
        Call Marcar_Col(dbgLineas_Servicios)
    End If

    If KeyCode = vbKeyF1 Then
        lbolResguardo = False           ' SS 20160404
        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumentos) Then
            If lrstDocumentos!tipo_doc = "G" Then
                lbolResguardo = True
            End If
        End If
    
        Select Case dbgLineas_Servicios.Col
            Case CGS_CODIGO
                GForm = Me.Name
                GTipoBusc = "ma_Insumos_Servicios"
                GCampoBusqueda = "grilla_servicios"
                gF1_F3 = True
                If lbolResguardo Then
                    whereSelCamG = " codigo_retencion_dgi <> '' "
                Else
                    whereSelCamG = " codigo_retencion_dgi = '' "
                End If
                frmBusquedas.Show
            
            Case CGS_SECCION
                GForm = Me.Name
                GTipoBusc = "secciones"
                GCampoBusqueda = "grilla_servicios"
                gF1_F3 = True
                whereSelCamG = ""
                frmBusquedas.Show
            Case CGS_TCOFIS
                GForm = Me.Name
                GTipoBusc = "impuestos"
                GCampoBusqueda = "GRILLA_COFIS"
                whereSelCamG = " cod_tipo_impuesto = 'COFIS'"
                gF1_F3 = True
                frmBusquedas.Show
            Case CGS_TIVA
                GForm = Me.Name
                GTipoBusc = "impuestos"
                GCampoBusqueda = "GRILLA_IVA"
                whereSelCamG = " cod_tipo_impuesto = 'IVA'"
                gF1_F3 = True
                frmBusquedas.Show
        End Select
    End If

    If KeyCode = vbKeyF3 Then
        gbolESC = True
        Busqueda = True
        frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
        frmBusqueda_Documentos.plngCod_Doc = val(txtCodDoc.text)
        frmBusqueda_Documentos.plngCod_Cliente = val(txtCodProv.text)
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
        frmBusqueda_Documentos.pstrCampo_Que_Llama = "GRILLA_SERVICIOS"
        
        If IsFormLoaded(frmBusqueda_Documentos) Then
            Unload frmBusqueda_Documentos
        End If
        frmBusqueda_Documentos.Show vbModal     'Cambio a Modal, para que funcione el F3   SS 20190306
                                                ' vbModal AIR 20181213 comentado porque al ser llamado como modal, luego dentro de ese formulario al hacer F1 para llamar a otro form que es modal da error
        
        If Trim(frmBusqueda_Documentos.pstrFiltros) <> "" Then
            Call Cargar_Desde_Otro_Documento_Servicio(frmBusqueda_Documentos.pstrFiltros)
            frmBusqueda_Documentos.pstrFiltros = ""
        End If
                
        frmBusqueda_Documentos.pstrTipo_Busqueda = ""
        frmBusqueda_Documentos.plngCod_Doc = 0
        frmBusqueda_Documentos.plngCod_Cliente = 0
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = ""
        frmBusqueda_Documentos.pstrCampo_Que_Llama = ""
    End If
    

    If KeyCode = vbKeyF12 Then
        ' JE 20170628  /    Ingreso Datos si es una Linea Valida (para que siempre pase a eFactura, sino no la toma porque no es una linea a enviar a eFactura
        If Trim(dbgLineas_Servicios.Columns("unidades").text) <> "" And Not dbgLineas_Servicios.Columns("eliminada").Value Then
            Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(val(txtEmpresa.text), val(txtCodDoc.text), txtDoc.text, txtCodProv.text)
            Call Ingreso_Modifico_Datos_Auxiliares_de_la_Linea(val(txtEmpresa.text), val(txtCodDoc.text), txtDoc.text, txtCodProv.text, (dbgLineas_Servicios.Row + 1))
        End If
    End If

    If KeyCode = vbKeyF6 Then       ' Fichas de Viaje       SS 20171117
        Call Cargar_Desde_Ficha_Viaje(val(txtEmpresa.text), ConfFicha_Viaje_Cod_Doc_x_Defecto, val(txtDoc.text), val(txtCodProv.text), val(txtMoneda.text))
    End If
    
    If KeyCode = vbKeyF8 Then       'Resguardo           AIR 20200827
        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumentos) Then
            If lrstDocumentos!tipo_doc = "G" Then
                Call Cargar_Documentos_Mercaderia_para_Resguardo(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(txtMoneda.text))
            Else
                MsgBox "Funcionalidad NO disponible para este Tipo de Documento.", vbCritical, MsgTit
            End If
        End If
    End If
    
    If KeyCode = vbKeyF10 Then      ' JE 20231003
        gCargoDesdeF = True
        If ConfControla_Saldo_Cantidad_Por_Documento = True Then
            ' Utiliza definicion de doc.pend.definidos en ma_Tipos_Docs_Pendientes_Validos
            
'            ' JE 20180817  / Consulto si hay lineas ingresadas en la Grilla (por si hay un error de tecla)
'            If vsfLineas_Mercaderia.Rows > 1 Then
'                vsfLineas_Mercaderia.SetFocus
'                DoEvents
'                If MsgBox("Desea Limpiar la Grilla Totalmente?", vbQuestion + vbYesNo) = vbYes Then
'                    Call Inicializo_Grilla_Lineas_Mercaderia
'                    gbln_Cargo_Datos_Desde_F10 = False
'                End If
'            Else
'                Call Inicializo_Grilla_Lineas_Mercaderia
'            End If
'            Call Inicializo_Grilla_Series_Articulos
            
            Call Cargar_Desde_Remito_Grilla_Servicios(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(txtMoneda.text), CDate(txtFec_Doc.text))
            
            If Buscar_Cliente(CLng(txtCodProv.text), C) Then
                If Trim(UCase(C!generico)) = "S" Then
                
                End If
            End If
            
        End If
        gCargoDesdeF = False
    End If
    
    
    
    If KeyCode = vbKeyDelete Then
        lbolHabilitar_Boton_Guardar = False
        'AIR 20231012 se agrega el igual porque estas grillas cuentan desde la row 0
        ' If dbgLineas_Servicios.Row > 0 Then
        If dbgLineas_Servicios.Row >= 0 Then
            If ConfPuntoVta_Utilizar_Autorizacion = "S" And ConfPuntoVta_Utilizar_Autorizacion_Incluye_Eliminar_Lineas = "S" Then   ' Se agrega configuracion para eliminacion de las lineas    SS 20180711
                If Not Autorizacion_Supervision(9, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    If MsgBox("Desea Eliminar la Linea?", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
                        Call Cargo_Logtrans("LINEA ELIMINADA " & dbgLineas_Servicios.Row & " " & dbgLineas_Servicios.Columns("descripcion").text)
                        dbgLineas_Servicios.RemoveItem (dbgLineas_Servicios.Row)
                        dbgLineas_Servicios.Columns("eliminada").Value = True
                        Call Calculo_Total_Lineas_Servicios(dbgLineas_Servicios, lbolHabilitar_Boton_Guardar)  'AIR 20180815 cuando se elimina la linea hay que recalcular el total
                    End If
                Else
                    MsgBox "ATENCION: No tiene Permiso para Eliminar una Linea. Llame al Supervisor..", vbInformation + vbOKOnly
                End If
            Else
                If MsgBox("Desea Eliminar la Linea?", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
                    Call Cargo_Logtrans("LINEA ELIMINADA " & dbgLineas_Servicios.Row & " " & dbgLineas_Servicios.Columns("descripcion").text)
                    dbgLineas_Servicios.RemoveItem (dbgLineas_Servicios.Row)
                    dbgLineas_Servicios.Columns("eliminada").Value = True
                    Call Calculo_Total_Lineas_Servicios(dbgLineas_Servicios, lbolHabilitar_Boton_Guardar)    'AIR 20180815  cuando se elimina la linea hay que recalcular el total
                End If
            End If
        End If
    End If
    
    If KeyCode = vbKeyEscape Then
        gbolESC = True
        Call Habilitar_Deshabilitar_Controles(Me, False)
        DoEvents
    End If
    
Exit Sub

Errores:

    MsgBox "Ha Ocurrido un Error, Verifique y Vuelva a Intentarlo", vbCritical, MsgTit
    dbgLineas_Servicios.SetFocus
    Exit Sub

End Sub

Private Sub dbgLineas_Servicios_KeyUp(KeyCode As Integer, Shift As Integer)
    dbgLineas_Servicios.ActiveRowStyleSet = "resaltar"
End Sub

Private Sub dbgLineas_Servicios_RowColChange(ByVal LastRow As Variant, ByVal LastCol As Integer)
Dim D As Recordset

    ' Se agrega control     SS 20180904
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        If D!tipo_doc <> "G" Then
            If LastCol = 9 Then     'columna precio_siva
                If IsNumeric(dbgLineas_Servicios.Columns("precio_siva").text) Then
                    Call Calcular_Importes_de_la_Linea_Servicios(False, "N", False)
                End If
            End If
            If LastCol = 10 Then    'columna precio
                If IsNumeric(dbgLineas_Servicios.Columns("precio").text) Then
                    Call Calcular_Importes_de_la_Linea_Servicios(False, "S", False)
                End If
            End If
        End If
    End If

End Sub

Private Sub Form_Activate()
 

    If plngCod_Emp <> 0 And plngCod_Doc <> 0 And plngNro_Doc <> 0 Then
        gbolCerrar_Proceso_Sin_Preguntar = True
        lbolCerrar_Documento_Sin_Preguntar = True
        Call Proceso_Consulta(True, plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov)
    End If
    
   
End Sub








Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    
    If KeyCode = vbKeyEscape Then
        gbolESC = True
        Unload Me
    End If

End Sub

Function Cargo_Combo_Paises(ByRef pssdCombo As SSDBCombo)
Dim SQL As String
Dim R As Recordset
Dim llngMarca As Long
    
       
    SQL = "SELECT * FROM ma_paises "
    SQL = SQL & " WHERE codigo >= 100"
    SQL = SQL & " ORDER BY nombre"
    
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    pssdCombo.removeAll
    
    llngMarca = 0
    
    While Not R.EOF
        
        pssdCombo.AddItem R!codigo & " " & R!nombre
        
        R.MoveNext
    Wend
    
    pssdCombo.text = pssdCombo.Columns("nombre").text
    
End Function

Private Sub Form_Load()
Dim lPermisos As Permisos_del_Menu
Dim R As Recordset

   

    Call F_Inicio(Me, False, False, plngCod_Programa)

    lPermisos = F_Permisos_Programa(plngCod_Programa)
    
    MAlta.Enabled = lPermisos.Alta
    MBaja.Enabled = lPermisos.Baja
    MModificacion.Enabled = lPermisos.Modificacion
    MAutorizar.Enabled = lPermisos.Autorizar
    MConsulta.Enabled = lPermisos.Consulta
    MListar.Enabled = lPermisos.Listar
    MReimpresion.Enabled = lPermisos.Listar
    MCambios.Enabled = lPermisos.Autorizar
    MVer_Documentos_Afectados.Enabled = lPermisos.Consulta
    
    'AIR 20220816 se cambia para vincularlo a los permisos de la consulta - BOYERCO
    'MVer_Asiento_Contable.Enabled = lPermisos.Autorizar
    MVer_Asiento_Contable.Enabled = lPermisos.Consulta
    
    If pstrTipo_Ingreso_Documentos = "M" Then
        Me.Caption = "  (4)  Emisión de Documentos - Mercadería"
        vsfLineas_Mercaderia.visible = True
        dbgLineas_Servicios.visible = False
        
        Chk_del_Cliente.visible = ConfPuntoVta_Check_Articulos_Cliente_Visible
        
        sspDatos_Mercaderia.visible = True
        sspDatos_Contrato.visible = False
        SSPContrato_Externo.visible = False
        
        If Trim(UCase(ConfBusqueda_Articulo_Dinamica_Habilitada)) = "S" Then
            Load frmBusqueda_Articulos_Dinamica_Vista_Chica
        End If
                
        
    ElseIf pstrTipo_Ingreso_Documentos = "S" Then
        Me.Caption = "  (90)  Emisión de Documentos - Servicios"
        vsfLineas_Mercaderia.visible = False
        dbgLineas_Servicios.visible = True
        dbgLineas_Servicios.Columns("descripcion").FieldLen = 75
        Chk_del_Cliente.visible = False
        
        sspDatos_Mercaderia.visible = False
        sspDatos_Contrato.visible = False
        SSPContrato_Externo.visible = False
                
    Else
        Me.Caption = "  (4)  Emisión de Documentos - Mercadería"
        vsfLineas_Mercaderia.visible = True
        dbgLineas_Servicios.visible = False
    End If
        
    glngColor_x_Defecto_Fuente_Nombre = RGB(0, 0, 0)
    
    If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
        
        TxtLector.TabIndex = 30
        TxtFactor.TabIndex = 31
        
        labUnidades.Top = 120
        labUnidades.Left = 4200 '4440
        TxtFactor.Top = 120
        TxtFactor.Left = 4970 '5280
        labCodigo.Top = 120
        labCodigo.Left = 1550 '1680
        TxtLector.Top = 120
        TxtLector.Left = 2270 '2400
        
    Else
    
        TxtFactor.TabIndex = 30
        TxtLector.TabIndex = 31
        
        labUnidades.Top = 120
        labUnidades.Left = 1550 '1800
        TxtFactor.Top = 120
        TxtFactor.Left = 2390   '2640
        labCodigo.Top = 120
        labCodigo.Left = 3720
        TxtLector.Top = 120
        TxtLector.Left = 4440
    
    End If
        
    If Trim(ConfPuntoVta_Cajon_Puerto_Set) <> "" And Trim(ConfPuntoVta_Cajon_Puerto_Set) <> "0" Then
        MApertura_Cajon.visible = True
    Else
        MApertura_Cajon.visible = False
    End If
        
    Call Habilitar_Deshabilitar_Controles(Me, False)
    
    cmdEntrega.Enabled = False
    txtImporte.Locked = True
    
    ' AIR 20170517
    If ConfDiseño_Para_Grandes_Cifras = True Then
        txtImporte.FontSize = 7
        txtImporte.Alignment = 1
        txtTotal_Calculado.Alignment = 1
        txtTotal_Medios_Pago.Width = 1800
        
        dbgLineas_Servicios.Columns("Descripcion").Width = 5100
        dbgLineas_Servicios.Columns("Importe").Width = 1900
        dbgLineas_Servicios.Columns("Precio").Width = 1400
        dbgLineas_Servicios.Columns("Precio_siva").Width = 1300
        
    Else
        txtImporte.FontSize = 12
        txtImporte.Alignment = 2
        txtTotal_Calculado.Alignment = 2
        
        txtTotal_Medios_Pago.Width = 1455
        dbgLineas_Servicios.Columns("Descripcion").Width = 5999.812
        dbgLineas_Servicios.Columns("Importe").Width = 1005.165
        dbgLineas_Servicios.Columns("Precio").Width = 884.9764
        dbgLineas_Servicios.Columns("Precio_siva").Width = 689.9528
    End If
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    
    Call Cargar_Impuestos_Actuales
    
    stbAyuda.Panels(1).text = "Seleccione la Operación a Realizar"
    txtFec_Doc.text = Format(date, "dd/mm/yyyy")
    gdteFecha_Documento = date
    sspTiene_Remitos_Pendientes.visible = False
    frameVencimientos_Cuotas.visible = False
    Imagen_Producto.visible = True
    FrameExportacion.visible = False
       
    If ConfSeccion_Facturador = True Then
        txtSeccion.visible = True
    End If
    
    labCajas.visible = ConfPuntoVta_Ver_Columna_Cajas
    txtCajas.visible = ConfPuntoVta_Ver_Columna_Cajas
    
    'txtTotal_Unidades.visible = Not txtCajas.visible
    txtTotal_Unidades.visible = Not ConfPuntoVta_Ver_Columna_Cajas  'la sentencia anterior no funciona  SS 20180912
    
    If Seteo_Maximo_Lineas(llngMaximo_Lineas) Then
    End If
    
    If ConfFormato_Factura = "HERTZ" Then
        txtMoneda.Locked = True
    End If
    
    gblnCancelar = False
    gbln_Cargo_Datos_Desde_F10 = False
    gbln_Articulo_de_F10 = Falsef
    
    gNumerar = True
    
'    If Inicializar_Valores_x_Campos_Programa_Empresa(gCodigo_Empresa, plngCod_Programa, lcolCampos) Then
'    End If
'
'    Call Visualizar_Campos_Formulario
'
'    Call Bloquear_Campos_Formulario
    
    Call Inicializo_Grilla_Lineas_Mercaderia
    
    Call Inicializo_Grilla_Series_Articulos
    
    Call Inicializo_Grilla_Lineas_Impuestos

    Call Inicializo_Grilla_Lineas_Medios_Pago
    
    Call Inicializo_Grilla_Vencimientos_Cuotas
    
    Call Inicializo_Campos_para_Autorizar

    Call Inicializo_Grilla_Cheques
    
    Call Inicializo_Grilla_Tarjetas
    
    Call Inicializo_Grilla_Vales
    
    Call Inicializo_Grilla_Descuento_x_Volumen
    
    Call Inicializo_Grilla_Equivalencias_Stock
    
    Call Inicializo_Grilla_Personas_Autorizadas
        
    Call Ajustar_Boton_Observaciones_Extras(txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text, sscObservacion_Extra)
    
    Call Cargo_Combo_Paises(txtPais)
    
    lbolCerrar_Documento_Sin_Preguntar = False
    
    If Busco_Label_Diccionario(gCodigo_Empresa, 1, R) <> "" Then
        LblRut.Caption = R!Texto
        LblRut.Caption = LblRut.Caption & "/" & Busco_Label_Diccionario(gCodigo_Empresa, 2, R)
    End If
    
    
    gNroProceso = 0
    
End Sub


Private Sub Form_Unload(Cancel As Integer)
Dim sigo As Integer

   

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Cancel = True
            Exit Sub
        End If
    End If

    If Not gbolCerrar_Proceso_Sin_Preguntar And Not gPtoVenta_Robot Then
        sigo = MsgBox("Desea Salir del Facturador?", vbYesNo + vbInformation, MsgTit)
        If sigo = vbYes Then
            Call Borra_Tabla_Temporal(lNombre_Tabla_Temporal)
            
            pbolCargo_Desde_Movil = False
            
            If Trim(UCase(ConfBusqueda_Articulo_Dinamica_Habilitada)) = "S" Then
                Unload frmBusqueda_Articulos_Dinamica_Vista_Chica
            End If
            
        Else
            Cancel = True
            Exit Sub
        End If
    End If
    
End Sub

Sub Inicializo_Tabla_Remitos(argTabla As String)
    gstrTabla_Temporal_Preventa = argTabla
End Sub

Private Sub MAlta_Click()
    gbolESC = True
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If

    Call Proceso_Alta

End Sub

Private Sub MApertura_Cajon_Click()
    
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    
    If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
        If Autorizacion_Supervision(11, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
            If Not Abrir_Cajon_Dinero And (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "EL_PALENQUE") Then
                 MsgBox "Error al Abrir el Cajon de Dinero", vbCritical, MsgTit
             End If
        End If
    Else
        If Not Abrir_Cajon_Dinero And (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "EL_PALENQUE") Then
            MsgBox "Error al Abrir el Cajon de Dinero", vbCritical, MsgTit
        End If
    End If

End Sub

Private Sub MAutorizar_Opciones_Click(Index As Integer)
Dim e As Recordset
    
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If
    
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    
    gGuardando_Documento = False
    yaAutorizado = False
    
    lNombre_Tabla_Temporal = ""
    sspOperacion.visible = True
    sspOperacion.Caption = "U"
    sspCantidad_Lineas.Caption = "0"
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    
    gbolCargo_Desde_WIS = False
    gbolCargo_Desde_Preventa = False
    pbolCargo_Desde_Movil = False

    Call Habilitar_Deshabilitar_Controles(Me, True)
    
    cmdEntrega.Enabled = False

    Call Limpiar_Controles(Me)
    
    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    
    labTope_Credito_Moneda.Caption = ""
    labTope_Credito.Caption = ""
    labSaldo_Credito_Moneda.Caption = ""
    labSaldo_Credito.Caption = ""
    
    labTope_Credito_Moneda.BackColor = &HE0E0E0
    labTope_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.BackColor = &HE0E0E0
    labSaldo_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.FontBold = False
    labSaldo_Credito.FontBold = False
    
    lbDisplay.Caption = ""
    
    Select Case Index
    
        Case 1
            txtLista.Locked = False
            txtFec_Doc.text = Format(date, "dd/mm/yyyy")
            
            If Buscar_Empresa(gCodigo_Empresa, e) Then
                txtEmpresa.text = gCodigo_Empresa
                txtNom_Empresa.text = Trim(e!Descripcion)
                Select Case Trim(UCase(e!mod_fecha_facturador))
                    Case "S"
                        txtFec_Doc.Locked = False
                    Case "N"
                        txtFec_Doc.Locked = True
                    Case "C"
                        txtFec_Doc.Locked = False
                        txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
                End Select
            Else
                MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
                Call Limpiar_Controles(Me)
                lbDisplay.Caption = ""
            End If
            
            sspTiene_Remitos_Pendientes.visible = False
            frameVencimientos_Cuotas.visible = False
            Imagen_Producto.visible = True
        
            Call Posiciono_en_Pantalla

        Case 2
        
            gbolESC = True
            Busqueda = True
            GForm = Me.Name
            frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
            'frmBusqueda_Documentos.plngCod_Doc = Val(TxtCodDoc.Text)
            frmBusqueda_Documentos.pbolAutorizarLote = True
            frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
        
            If IsFormLoaded(frmBusqueda_Documentos) Then
                Unload frmBusqueda_Documentos
            End If
            frmBusqueda_Documentos.Show vbModal 'Se agrega Modal    SS 20190306
            DoEvents
        
    End Select
    
End Sub

Private Sub MBaja_Opciones_Click(Index As Integer)
Dim e As Recordset

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If


    nro_doc_Wis = ""
    camion_Wis = ""
    txtLista.Locked = False
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    
    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    
    
    Select Case Index
        
        Case 0
        
            gGuardando_Documento = False
            yaAutorizado = False
            lNombre_Tabla_Temporal = ""
            gstrUltimo_Nro_Autorizacion_Tarjeta = ""
            gbolProceso_Tarjeta = False        'SS 20181224
            
            sspCantidad_Lineas.Caption = "0"
            gbolCargo_Desde_WIS = False
            gbolCargo_Desde_Preventa = False
            pbolCargo_Desde_Movil = False
            
            sspOperacion.visible = True
            sspOperacion.Caption = "B"
        
            Call Habilitar_Deshabilitar_Controles(Me, True)
            
            cmdEntrega.Enabled = False
            
            Call Limpiar_Controles(Me)
            
            labTope_Credito_Moneda.Caption = ""
            labTope_Credito.Caption = ""
            labSaldo_Credito_Moneda.Caption = ""
            labSaldo_Credito.Caption = ""
            
            labTope_Credito_Moneda.BackColor = &HE0E0E0
            labTope_Credito.BackColor = &HE0E0E0
            labSaldo_Credito_Moneda.BackColor = &HE0E0E0
            labSaldo_Credito.BackColor = &HE0E0E0
            labSaldo_Credito_Moneda.FontBold = False
            labSaldo_Credito.FontBold = False
            
            lbDisplay.Caption = ""
            
            txtFec_Doc.text = Format(date, "dd/mm/yyyy")
            If Buscar_Empresa(gCodigo_Empresa, e) Then
                txtEmpresa.text = gCodigo_Empresa
                txtNom_Empresa.text = Trim(e!Descripcion)
                Select Case Trim(UCase(e!mod_fecha_facturador))
                    Case "S"
                        txtFec_Doc.Locked = False
                    Case "N"
                        txtFec_Doc.Locked = True
                    Case "C"
                        txtFec_Doc.Locked = False
                        txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
                End Select
            Else
                MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
                Call Limpiar_Controles(Me)
                lbDisplay.Caption = ""
            End If
            
            Call Posiciono_en_Pantalla
                    
        Case 1
        
            gGuardando_Documento = False
            yaAutorizado = False
            lNombre_Tabla_Temporal = ""
            gstrUltimo_Nro_Autorizacion_Tarjeta = ""
            gbolProceso_Tarjeta = False        'SS 20181224
            
            sspCantidad_Lineas.Caption = "0"
            gbolCargo_Desde_WIS = False
            gbolCargo_Desde_Preventa = False
            pbolCargo_Desde_Movil = False
            
            sspOperacion.visible = True
            sspOperacion.Caption = "D"
        
            Call Habilitar_Deshabilitar_Controles(Me, True)
            
            cmdEntrega.Enabled = False
            
            Call Limpiar_Controles(Me)
            
            labTope_Credito_Moneda.Caption = ""
            labTope_Credito.Caption = ""
            labSaldo_Credito_Moneda.Caption = ""
            labSaldo_Credito.Caption = ""
            
            labTope_Credito_Moneda.BackColor = &HE0E0E0
            labTope_Credito.BackColor = &HE0E0E0
            labSaldo_Credito_Moneda.BackColor = &HE0E0E0
            labSaldo_Credito.BackColor = &HE0E0E0
            labSaldo_Credito_Moneda.FontBold = False
            labSaldo_Credito.FontBold = False
            
            lbDisplay.Caption = ""
            
            txtFec_Doc.text = Format(date, "dd/mm/yyyy")
            If Buscar_Empresa(gCodigo_Empresa, e) Then
                txtEmpresa.text = gCodigo_Empresa
                txtNom_Empresa.text = Trim(e!Descripcion)
                Select Case Trim(UCase(e!mod_fecha_facturador))
                    Case "S"
                        txtFec_Doc.Locked = False
                    Case "N"
                        txtFec_Doc.Locked = True
                    Case "C"
                        txtFec_Doc.Locked = False
                        txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
                End Select
            Else
                MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
                Call Limpiar_Controles(Me)
                lbDisplay.Caption = ""
            End If
            
            Call Posiciono_en_Pantalla
                    
    End Select
    
    sspTiene_Remitos_Pendientes.visible = False
    frameVencimientos_Cuotas.visible = False
    Imagen_Producto.visible = True

End Sub

Private Sub MCalculadora_Click()
On Error Resume Next
    Call Calculadora
End Sub

Private Sub MCambio_Datos_Cheques_Click(Index As Integer)
    frmPunto_Venta_Cambio_Datos_Cheques.Show
End Sub


Private Sub MCambio_Datos_de_Tarjeta_Click(Index As Integer)
    frmPunto_Venta_Cambio_Voucher_Tarjeta_Credito.Show
End Sub


Private Sub MCambios_Acopio_Click(Index As Integer)

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If
    frmPunto_Venta_Cambio_Acopio.Show

End Sub

Private Sub MCambios_Cliente_Click(Index As Integer)
    
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If
    frmPunto_Venta_Cambio_Cliente.pTitular = "C"
    frmPunto_Venta_Cambio_Cliente.Show
End Sub

Private Sub MCambios_Forma_Pago_Click(Index As Integer)
    frmPunto_Venta_Cambio_Forma_Pago.Show
End Sub

Private Sub MCambios_Medios_Pago_Click(Index As Integer)
    frmPunto_Venta_Cambio_Medio_Pago.Show
End Sub

Private Sub MCambios_Observacion_Click(Index As Integer)
    frmPunto_Venta_Cambio_Observacion.Show
End Sub

Private Sub MCambios_Tipo_Documento_Click(Index As Integer)
    frmPunto_Venta_Cambio_Tipo_Documento.Show
End Sub

Private Sub MCambios_Tipo_Entrega_y_Deposito_Click(Index As Integer)

    frmPunto_Venta_Cambio_Tipo_Entrega_Deposito_Lineas_Doc.plngEmpresa = val(txtEmpresa.text)
    frmPunto_Venta_Cambio_Tipo_Entrega_Deposito_Lineas_Doc.plngCod_Doc = val(txtCodDoc.text)
    frmPunto_Venta_Cambio_Tipo_Entrega_Deposito_Lineas_Doc.plngNro_Doc = val(txtDoc.text)
    frmPunto_Venta_Cambio_Tipo_Entrega_Deposito_Lineas_Doc.plngCliente = val(txtCodProv.text)
    
    frmPunto_Venta_Cambio_Tipo_Entrega_Deposito_Lineas_Doc.Show
    
End Sub

Private Sub MCambios_Vendedor_Click(Index As Integer)
    frmPunto_Venta_Cambio_Vendedor.Show
End Sub

Private Sub MConsulta_Click()

'AIR 11/11/2015

Dim llngEmpresa As Long
Dim llngCodDoc As Long
Dim llngNroDoc As Long
Dim llngCodProv As Long
Dim lblnExterno As Boolean
    gbolESC = True
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If


    lblnExterno = False
    llngEmpresa = 0
    llngCodDoc = 0
    llngNroDoc = 0
    llngCodProv = 0
 
    Call Proceso_Consulta(lblnExterno, llngEmpresa, llngCodDoc, llngNroDoc, llngCodProv)

End Sub



Public Sub Cargo_codigo_programa(codigo As Long)
        plngCod_Programa = codigo
      
End Sub


Private Sub MDepositoCopiar_Click()
Dim i As Long
Dim DEP As Recordset
    
    llngdDeposito = 0
    If Busco_Stk_Deposito(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO)), DEP) Then
    Else
        Exit Sub
    End If
    
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
        vsfLineas_Mercaderia.TextMatrix(i, CGL_DEPOSITO) = Trim(UCase(DEP!codigo))
    Next
End Sub

Private Sub MListar_Anulados_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Anulados(Index).Caption
    
    Select Case Index
        
        Case 0
            ' Listar Documentos Anulados
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("A", False, False, False, False, False, True, lstrTitulo)
            
        Case 1
            ' Listar Documentos Anulados - Totales
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("A", True, False, False, False, False, True, lstrTitulo)
            
    End Select

End Sub

Private Sub MListar_Cabezales_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Cabezales(Index).Caption
    
    Select Case Index
    
        Case 0
            ' Listar Cabezales
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, False, False, False, True, lstrTitulo)
            
        Case 1
            ' Listar Cabezales Con Observaciones
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, True, False, False, True, lstrTitulo)
        
        Case 2
            ' Listar Cabezales Con Datos e-Factura
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, True, True, False, True, lstrTitulo)
            
        Case 3
            ' Listar Cabezales Con Contrato, Observaciones y Medios de Pago
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, True, False, True, True, lstrTitulo)
        
        Case 4
            ' Listar Cabezales Agrupado por Contrato
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, True, False, True, False, lstrTitulo)
        
        Case 5
            ' Listar Cabezales Con Netos x IVA
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, True, False, False, False, True, lstrTitulo)
            
        Case 6
            ' Listar Cabezales con Ajuste INAC
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("I", False, False, False, False, False, True, lstrTitulo)

        Case 7
            ' Listar Cabezales con RUT
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", False, False, False, False, False, True, lstrTitulo, True)
        

    End Select
        
End Sub

Private Sub MListar_Detallado_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Detallado(Index).Caption

    Select Case Index
        
        Case 0
            ' Listar Detalle x Documento
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Detalle_x_Documento(lstrTitulo)
            
        Case 1
            ' Listar Detalle Comparativo de Precio x Articulo de Documento
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Comparativo_Precio_x_Articulo(lstrTitulo)
        
    End Select
    
End Sub

Private Sub MListar_Opciones_Click(Index As Integer)
Dim lstrTitulo As String

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If
    
    lstrTitulo = MListar_Opciones(Index).Caption

    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    
    Select Case Index
    
        Case 8
            ' Listar Resguardos
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Resguardos_Resumen(lstrTitulo)         'SS 20190510
        
        Case 12
            ' Listar Detalle de Descuentos
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Detalle_Descuento(lstrTitulo)
    
        Case 16
            ' Listar Documentos x Seccion Detalle
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Solo_Cabezales_con_Seccion("SD", "N", "N", lstrTitulo)
            
        Case 18
            ' Listar Documentos Anulados - Totales
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("V", False, False, False, False, False, True, lstrTitulo)
            
    End Select

End Sub

Private Sub MListar_Pedidos_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Pedidos(Index).Caption

    Select Case Index
    
        Case 0
            ' Listar Pedidos
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("P", False, False, False, False, False, True, lstrTitulo)
            
        Case 1
            'Listar Pedidos Resumido // LC 20161122
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Pedidos_Resumido(lstrTitulo)
            
        Case 2
            ' Listar Pedidos Detallado
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Pedidos_Detallado(lstrTitulo)
        
        Case 3
            ' Listar Pedidos Totales
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("P", True, False, False, False, False, True, lstrTitulo)
        
        Case 4
            ' Listar Pedidos Formato Grilla
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            gModoSalidaInforme = ""
            Call Listar_Pedidos_Formato_Matriz(lstrTitulo)
        
    End Select
    
End Sub


Private Sub MListar_Pendientes_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Pendientes(Index).Caption

    Select Case Index
    
        Case 0
            ' Listar Documentos Pendientes - F10, Resumido por Documento, con Saldo
            
            frmInf_Documentos_Emitidos_Pendientes.Show vbModal
                                
        Case 1
            ' Listar Documentos Pendientes - F10    -   Grilla
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            
            Call Listar_Documentos_Pendientes_Grilla(lstrTitulo)
            
    End Select

End Sub

Private Sub MListar_Totales_Click(Index As Integer)
Dim lstrTitulo As String

    lstrTitulo = MListar_Totales(Index).Caption

    Select Case Index
    
        Case 0
            ' Listar Totales x Articulos
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Totales_x_Articulo(lstrTitulo)
            
        Case 1
            ' Listar Totales x Tipos Documentos
            lstrFiltros = ""
            gString_Orden = ""
            gNombre_Tabla_Temporal = ""
            Call Listar_Cabezales("F", True, False, False, False, False, True, lstrTitulo)
            
    End Select
    
End Sub


Private Sub MModificacion_Click()

Dim llngEmpresa As Long
Dim llngCodDoc As Long
Dim llngNroDoc As Long
Dim llngCodProv As Long
Dim lblnExterno As Boolean

    'AIR 20170503 se crea un metodo para la modificacion para poder llamarlo externamente
    gbolESC = True
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If

    lblnExterno = False
    llngEmpresa = 0
    llngCodDoc = 0
    llngNroDoc = 0
    llngCodProv = 0

    Call Proceso_Modificacion(lblnExterno, llngEmpresa, llngCodDoc, llngNroDoc, llngCodProv)

End Sub



Private Sub MReimpresion_Opciones_Click(Index As Integer)
Dim lReImprimir As Boolean
Dim e As Recordset

Dim RD As Recordset
Dim llngCod_Emp As Long
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim llngCod_Prov As Long

On Error GoTo Errores
    gbolESC = True
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If
    
    
    txtLista.Locked = False
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    
    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    
    Select Case Index
        
        Case 0
        
            ' IMPRESION DEL DOCUMENTO
            
            lReImprimir = False
            sspTiene_Remitos_Pendientes.visible = False
            frameVencimientos_Cuotas.visible = False
            Imagen_Producto.visible = True
            
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If Autorizacion_Supervision(19, 1, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    lReImprimir = True
                End If
            Else
                lReImprimir = True
            End If
            
            If lReImprimir = True Then
            
                lNombre_Tabla_Temporal = ""
            
                Call Habilitar_Deshabilitar_Controles(Me, True)
                
                cmdEntrega.Enabled = False
                
                Call Limpiar_Controles(Me)
        
                labTope_Credito_Moneda.Caption = ""
                labTope_Credito.Caption = ""
                labSaldo_Credito_Moneda.Caption = ""
                labSaldo_Credito.Caption = ""
                
                labTope_Credito_Moneda.BackColor = &HE0E0E0
                labTope_Credito.BackColor = &HE0E0E0
                labSaldo_Credito_Moneda.BackColor = &HE0E0E0
                labSaldo_Credito.BackColor = &HE0E0E0
                labSaldo_Credito_Moneda.FontBold = False
                labSaldo_Credito.FontBold = False
        
                lbDisplay.Caption = ""
        
                txtFec_Doc.text = Format(date, "dd/mm/yyyy")
                If Buscar_Empresa(gCodigo_Empresa, e) Then
                    txtEmpresa.text = gCodigo_Empresa
                    txtNom_Empresa.text = Trim(e!Descripcion)
                    Select Case Trim(UCase(e!mod_fecha_facturador))
                        Case "S"
                            txtFec_Doc.Locked = False
                        Case "N"
                            txtFec_Doc.Locked = True
                        Case "C"
                            txtFec_Doc.Locked = False
                            txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
                    End Select
                Else
                    MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
                    Call Limpiar_Controles(Me)
                    lbDisplay.Caption = ""
                End If
                
                txtNro_Fanfold.text = Obtener_Nro_Fanfold(val(txtEmpresa.text), val(txtCodDoc.text), ConfPuntoVta_Nro_Caja)
                
                sspCantidad_Lineas.Caption = "0"
                
                sspOperacion.visible = True
                sspOperacion.Caption = "R"
                Call Posiciono_en_Pantalla
                    
            End If
        
        Case 2
        
            ' IMPRESION X LOTE
        
            lReImprimir = False
            sspTiene_Remitos_Pendientes.visible = False
            frameVencimientos_Cuotas.visible = False
            Imagen_Producto.visible = True
            
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If Autorizacion_Supervision(19, 1, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    lReImprimir = True
                End If
            Else
                lReImprimir = True
            End If
            
            If lReImprimir = True Then
            
                Call Limpiar_Controles(Me)
                                        
                labTope_Credito_Moneda.Caption = ""
                labTope_Credito.Caption = ""
                labSaldo_Credito_Moneda.Caption = ""
                labSaldo_Credito.Caption = ""
                
                labTope_Credito_Moneda.BackColor = &HE0E0E0
                labTope_Credito.BackColor = &HE0E0E0
                labSaldo_Credito_Moneda.BackColor = &HE0E0E0
                labSaldo_Credito.BackColor = &HE0E0E0
                labSaldo_Credito_Moneda.FontBold = False
                labSaldo_Credito.FontBold = False
                                        
                lbDisplay.Caption = ""
                                        
                sspOperacion.visible = True
                sspOperacion.Caption = "R"
                
                frmPunto_Venta_Impresion_x_Lote.pstrTipo_Ingreso_Documentos = pstrTipo_Ingreso_Documentos
                frmPunto_Venta_Impresion_x_Lote.Show vbModal
                    
            End If
        
        Case 4
        
            ' IMPRESION TICKETS DE ENTREGAS/ENVIOS
            
'            llngCod_Emp = 2
'            llngCod_Doc = 133
'            llngNro_Doc = 35
'            llngCod_Prov = 899
'
'            If Buscar_Tipo_Documento(llngCod_Doc, RD) Then
'            End If
'
'            ' JE 20240607   -    Incluyo aqui ademas de chequear si el Docuemnto tiene configurado que Imprime (independiente del tipo de entrega)
'            If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) <> "N" And Trim(UCase(RD!se_Imprime)) = "S" Then
'
'                If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "S" Then
'                    ' JE 20180313   /   Conservo este parametro con S para la Impresion por eFactura
'                    Call Imprimir_Ticket_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov)
'                End If
'                If Trim(UCase(RD!imprimir_ticket_x_tipo_entrega)) = "L" Then
'                    ' JE 20180313   /  Para Imprimir en Impresora Local con un RPT Configurado
'                    Call Imprimir_Laser_POSTVENTA_Segun_Tipo_Entrega_Mercaderia(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, RD!imprimir_ticket_x_tipo_entrega, cryImpresion_Factura_Laser)
'                End If
'
'            End If
'
        
    End Select
    
    
Exit Sub
            
Errores:
        MsgBox "Ha Ocurrido un Error, Intente Nuevamente", vbExclamation, MsgTit
    
End Sub

Private Sub MTipo_Entrega_Copiar_Click()
Dim i As Long
Dim TE As Recordset
    
    llngTipo_Entrega = 0
    If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_TIPO_ENTREGA)), TE) Then
    Else
        Exit Sub
    End If
    
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
        vsfLineas_Mercaderia.TextMatrix(i, CGL_TIPO_ENTREGA) = Trim(UCase(TE!descripcion_corta))
    Next
    
End Sub

Private Sub MVer_Asiento_Contable_Click()
Dim llngCod_Emp As Long
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim llngCod_Prov As Long

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If

    gbolESC = True

    If Trim(txtEmpresa.text) = "" Or Trim(txtCodDoc.text) = "" Or Trim(txtDoc.text) = "" Or Trim(txtCodProv.text) = "" Then

        If Leo_Documento_Dado_Alta_o_Modificado(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov) Then
            frmVer_Asiento_Contable_x_Documento.plngCod_Emp = llngCod_Emp
            frmVer_Asiento_Contable_x_Documento.plngCod_Doc = llngCod_Doc
            frmVer_Asiento_Contable_x_Documento.plngNro_Doc = llngNro_Doc
            frmVer_Asiento_Contable_x_Documento.plngCod_Prov = llngCod_Prov
        End If
    Else
        frmVer_Asiento_Contable_x_Documento.plngCod_Emp = val(txtEmpresa.text)
        frmVer_Asiento_Contable_x_Documento.plngCod_Doc = val(txtCodDoc.text)
        frmVer_Asiento_Contable_x_Documento.plngNro_Doc = val(txtDoc.text)
        frmVer_Asiento_Contable_x_Documento.plngCod_Prov = val(txtCodProv.text)
    End If
    
    frmVer_Asiento_Contable_x_Documento.Show vbModal
    
End Sub

Private Sub MVer_Documentos_Afectados_Click()
Dim llngCod_Emp As Long
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim llngCod_Prov As Long

    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If


    gbolESC = True

    If Trim(txtEmpresa.text) = "" Or Trim(txtCodDoc.text) = "" Or Trim(txtDoc.text) = "" Or Trim(txtCodProv.text) = "" Then

        If Leo_Documento_Dado_Alta_o_Modificado(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov) Then
            frmPunto_Venta_Ver_Docs_Afectados.plngCod_Emp = llngCod_Emp
            frmPunto_Venta_Ver_Docs_Afectados.plngCod_Doc = llngCod_Doc
            frmPunto_Venta_Ver_Docs_Afectados.plngNro_Doc = llngNro_Doc
            frmPunto_Venta_Ver_Docs_Afectados.plngCod_Prov = llngCod_Prov
            frmPunto_Venta_Ver_Docs_Afectados.pstrGrilla = "WIS_FACTURACIONES"
        End If
    Else
        frmPunto_Venta_Ver_Docs_Afectados.plngCod_Emp = val(txtEmpresa.text)
        frmPunto_Venta_Ver_Docs_Afectados.plngCod_Doc = val(txtCodDoc.text)
        frmPunto_Venta_Ver_Docs_Afectados.plngNro_Doc = val(txtDoc.text)
        frmPunto_Venta_Ver_Docs_Afectados.plngCod_Prov = val(txtCodProv.text)
        frmPunto_Venta_Ver_Docs_Afectados.pstrGrilla = "WIS_FACTURACIONES"
    End If
    
    frmPunto_Venta_Ver_Docs_Afectados.Show vbModal
    
End Sub

Private Sub MVer_Verificacion_Click()

    '  JE 20240819  /   Se agrega este punto para chequear si estan las lineas verificadas
    
    If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
        If vsfLineas_Mercaderia.Rows > 1 Then
            MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
            Exit Sub
        End If
    End If

    gbolESC = True

    If Trim(txtEmpresa.text) <> "" And Trim(txtCodDoc.text) <> "" And Trim(txtDoc.text) <> "" And Trim(txtCodProv.text) <> "" Then
        
        Unload frmVerificar_Articulos_del_Documento
        
        frmVerificar_Articulos_del_Documento.plngEmpresa = val(txtEmpresa.text)
        frmVerificar_Articulos_del_Documento.plngCod_Doc = val(txtCodDoc.text)
        frmVerificar_Articulos_del_Documento.plngNro_Doc = val(txtDoc.text)
        frmVerificar_Articulos_del_Documento.plngTitular = val(txtCodProv.text)
        frmVerificar_Articulos_del_Documento.pstrOperacion = "C"
    
        frmVerificar_Articulos_del_Documento.Show vbModal
    
        frmVerificar_Articulos_del_Documento.plngEmpresa = 0
        frmVerificar_Articulos_del_Documento.plngCod_Doc = 0
        frmVerificar_Articulos_del_Documento.plngNro_Doc = 0
        frmVerificar_Articulos_del_Documento.plngTitular = 0
        frmVerificar_Articulos_del_Documento.pstrOperacion = ""
    
    End If
 
End Sub

Private Sub PDF_Click()
On Error GoTo Errores
Dim lCfe As efCFE
Dim D As Recordset

    lCfe = obtengoCaeXDocumento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
    
    If lCfe.cae.numero <> 0 Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            'AIR 20220818 se agregan mas parametros
            'Call obtengoYMuestroPDF(Val(txtEmpresa.text), lCfe.cae.idInterno, Trim(D!formato_impresion))
                    
            Call obtengoYMuestroPDF(val(txtEmpresa.text), lCfe.cae.idInterno, Trim(D!formato_impresion), lCfe.cae.Tipo, lCfe.cae.serie, lCfe.cae.numero)
        End If
    End If
    
Exit Sub
Errores:
Call FErrores
'Resume
End Sub

Private Sub sscObservacion_Extra_Click()
    If txtCodDoc.text <> "" And txtDoc.text <> "" And txtCodProv.text <> "" Then
        Call Agregar_Ver_Observaciones_Extras_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), txtDoc.text, txtCodProv.text)
        Call Ajustar_Boton_Observaciones_Extras(txtEmpresa.text, val(txtCodDoc.text), txtDoc.text, txtCodProv.text, sscObservacion_Extra)
    End If
End Sub

Private Sub sstDetalle_Pagos_Click(PreviousTab As Integer)
    If sstDetalle_Pagos.Tab <> PreviousTab Then
        Select Case sstDetalle_Pagos.Tab
'            Case 0
'            Case 1
        End Select
    End If
End Sub

Private Sub sstSecciones_Lineas_Click(PreviousTab As Integer)
'On Error Resume Next

    If sstSecciones_Lineas.Tab <> PreviousTab Then
        Select Case sstSecciones_Lineas.Tab
            Case 0
                gbolESC = True
                If txtCodDoc.Enabled Then
                    txtCodDoc.SetFocus
                End If
            
            Case 1
                vsfSeries_Articulos.SetFocus
                If vsfSeries_Articulos.Rows > 1 Then
                    vsfSeries_Articulos.Row = 1
                    vsfSeries_Articulos.Col = CGSA_CODIGO_PROD
                End If
        
        End Select
    End If

End Sub



Private Sub SSverFirmaDigitalizada_Click()
On Error GoTo Errores
    frmFirmaDigitalizada.pbolVerFirma = True
    frmFirmaDigitalizada.pstrCodEmp = txtEmpresa.text
    frmFirmaDigitalizada.pstrCodDoc = txtCodDoc.text
    frmFirmaDigitalizada.pstrNroDoc = txtDoc.text
    frmFirmaDigitalizada.pstrCodProv = txtCodProv.text
    
    frmFirmaDigitalizada.Show 1
Exit Sub
Errores:
    MsgBox "Error al Consultar la Firma Digitalizada", vbCritical, MsgTit
End Sub

Private Sub txtAcopio_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtAcopio").solicitar_datos = "S"
    End If

End Sub


Private Sub txtAcopio_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtAcopio").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese el Código de Acopio"
    Call Color_Control_Seleccionado(Me, txtAcopio)
    Call MarcarTexto(txtAcopio)
    
End Sub


Private Sub txtAcopio_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
        
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtCI_Persona_Autorizada.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        If Not txtLista.Locked Then
            GForm = Me.Name
            GTipoBusc = "ma_acopios"
            gbolESC = True
            whereSelCamG = ""
            frmBusquedas.Show
        End If
    End If
    
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtAcopio").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(1, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtAcopio.Locked = False
                End If
            End If
        End If
    End If
    

End Sub

Private Sub txtAcopio_LostFocus()
On Error GoTo Errores
Dim R As Recordset
Dim D As Recordset

    If Not gbolESC Then
        If Trim(txtAcopio.text) <> "" Then
            If IsNumeric(txtAcopio.text) Then
                If Not Buscar_Acopio(val(txtAcopio.text), R) Then
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Acopio Inexistente", vbInformation, MsgTit
                    txtAcopio.SetFocus
                    Exit Sub
                Else
                    txtDescripcion_Acopio.text = Trim(R!Descripcion)
                    
                    If val(txtAcopio.text) = 0 Then
                        txtCI_Persona_Autorizada.text = ""
                        txtCI_Persona_Autorizada.Locked = True
                        txtCI_Persona_Autorizada.BackColor = &H8000000F
                    Else
                        txtCI_Persona_Autorizada.Locked = False
                        txtCI_Persona_Autorizada.BackColor = &H80000005
                    End If
                    
                    Call Inicializo_Campos_para_Autorizar
                    
                End If
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Código de Acopio debe ser un número válido", vbInformation, MsgTit
                txtAcopio.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Código de Acopio No puede ser Nulo", vbInformation, MsgTit
            txtAcopio.SetFocus
        End If
    End If
        
Exit Sub
Errores:
    gbooErrorRobot = True
    Resume Next
End Sub


Private Sub txtCajas_GotFocus()
    
    stbAyuda.Panels(1).text = "Ingrese las Cajas/Bultos"
    If Trim(txtCajas.text) = "" Then
        txtCajas.text = "1"
    End If
    Call Color_Control_Seleccionado(Me, txtCajas)
    Call MarcarTexto(txtCajas)

End Sub

Private Sub txtCajas_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtGuia.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
            TxtLector.SetFocus
        Else
            TxtFactor.SetFocus
        End If
    End If

End Sub

Private Sub txtCajas_LostFocus()
Dim lrstArticulo As Recordset
    
    If Not gbolESC Then
        If Trim(txtCajas.text) <> "" Then
            If Not IsNumeric(txtCajas.text) Then
                MsgBox "La Cantidad de Cajas/Bultos debe ser un Número Válido", vbInformation, MsgTit
                txtCajas.SetFocus
            Else

            End If
        End If
    End If

End Sub

Private Sub txtCambio_GotFocus()
    'Call Color_Control_Seleccionado(Me, txtCambio)
    Call MarcarTexto(txtCambio)

End Sub

Private Sub txtCambio_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyEscape Then
        gbolESC = True
        Call Habilitar_Deshabilitar_Controles(Me, False)
        DoEvents
    End If
    
    If KeyCode = vbKeyReturn Then
        
        If Controlar_Ingreso_Medios_Pago Then
            If Trim(UCase(sspOperacion.Caption)) = "C" Then
                cmdGuardar.Enabled = False
            Else
                cmdGuardar.Enabled = True
                cmdGuardar.SetFocus
            End If
        Else
            gbolESC = True
            MsgBox "El Detalle de Medios de Pago no es Correcto, Verifique", vbCritical + vbOKOnly
            cmdGuardar.Enabled = False
            vsfMedios_Pagos.SetFocus
        
           Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
                Case "DESCRIPCION"
                    vsfMedios_Pagos.Col = CGMP_DESCRIPCION
                Case Else
                    vsfMedios_Pagos.Col = CGMP_IMPORTE
            End Select
        
        End If
    
    End If
End Sub

Private Sub txtCambio_LostFocus()
 
'AIR 20250929

Dim ldblCambio As Double
Dim ldblCambioOtraMon As Double
Dim ldblTCOtraMon As Double

Dim ldblTipo_Cambio As Double
Dim lstrMN_ME As String

On Error GoTo Errores
    If Not gbolESC Then
        
        If Not ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas Then
            Exit Sub
        End If
        
        If Trim(txtCambio.text) <> "" Then
            If val(txtCambio.text) = 0 Then
            
                txtCambio.text = Format(txtCambio.text, "###,##0.00")
                DoEvents
                
                ldblCambio = Round(CDbl(Format(txtTotal_Medios_Pago.text, "0.00")) - CDbl(Format(NullToZero(txtImporte.text), "0.00")), 2)
                
                If ldblCambio < 0 Then
                    ' El cambio no puede ser Negativo
                    txtCambio.text = "0.00"
                    Exit Sub
                End If
                
                ldblTipo_Cambio = val(txtTipo_Cambio.text)
                
                If llngMoneda <> gMoneda_Base Then
                    lstrMN_ME = Buscar_Configuracion_Variables_Documento_C(val(txtCodDoc.text), "TIPO_COTIZACION_LINEA_ART_MN_ME")
                    If Trim(lstrMN_ME) = "" Then
                         lstrMN_ME = "F"
                    End If
                Else
                    lstrMN_ME = Buscar_Configuracion_Variables_Documento_C(val(txtCodDoc.text), "TIPO_COTIZACION_LINEA_ART_ME_MN")
                    If Trim(lstrMN_ME) = "" Then
                        lstrMN_ME = "P"
                    End If
                End If
                
                ReDim gVecCambio(1 To 5, 1 To 9)
                With frmPunto_Venta_Ingresa_Cambio_x_Moneda
                    
                    Call .Inicializo_Grilla_Lineas_Cambio
                    
                    .glngCodDoc = val(txtCodDoc.text)
                    .txtCambio.text = Format(ldblCambio, "###,##0.00")
                    .TxtSimbolo_Cambio.text = Me.TxtSimbolo_Cambio.text
                    
                    .txtMoneda.text = Me.txtMoneda.text
                    .txtSimbolo.text = Me.txtDes_Moneda.text
                    .txtTipo_Cambio.text = Me.txtTipo_Cambio.text
                    .txtImporte_Total.text = Me.txtImporte.text
                    .vsfMedios_Pagos_Cambio.Rows = 1
                    
                    'AIR 20250929 por ahora se va a limitar al cambio en moneda base y moneda referencia.
                    For i = 1 To vsfMedios_Pagos.Rows - 1
                        If (val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Or (val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) = 0 And vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = txtMoneda.text)) And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO) <> "CAMBIO" _
                        And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) = "E" And (vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = gMoneda_Base Or vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = gMoneda_Referencia) Then
                            
                            'Const CGC_MEDIO_PAGO As Long = 1
                            'Const CGC_DESCRIPCION As Long = 2
                            'Const CGC_MONEDA As Long = 3
                            'Const CGC_TC As Long = 4
                            'Const CGC_SIMBOLO As Long = 5
                            'Const CGC_IMPCALC As Long = 6
                            'Const CGC_IMPORTE As Long = 7
                            'Const CGC_TIPO_MPAGO As Long = 8
                            'Const CGC_MONPAGA As Long = 9

                            .vsfMedios_Pagos_Cambio.Rows = .vsfMedios_Pagos_Cambio.Rows + 1
                            
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, CGMP_MEDIO_PAGO) = vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, CGMP_DESCRIPCION) = vsfMedios_Pagos.TextMatrix(i, CGMP_DESCRIPCION)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 3) = vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 4) = vsfMedios_Pagos.TextMatrix(i, CGMP_TC)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 5) = vsfMedios_Pagos.TextMatrix(i, CGMP_SIMBOLO)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 7) = "0.00"                'CGC_IMPORTE
                            
                            If val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = val(txtMoneda.text) Then
                                .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 6) = ldblCambio         'CGC_IMPCALC
                                .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 7) = ldblCambio        'CGC_IMPORTE
                            Else
                                If vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) <> "" Then
                                    ldblTCOtraMon = vsfMedios_Pagos.TextMatrix(i, CGMP_TC)
                                    
                                    If vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = "" Or val(vsfMedios_Pagos.TextMatrix(i, CGMP_TC)) = 0 Then
                                        ldblTCOtraMon = 1
                                    Else
                                        ldblTCOtraMon = CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_TC))
                                    End If
                                                    
                                    If val(txtMoneda.text) = gMoneda_Base Then
                                         .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 6) = Round(ldblCambio / ldblTCOtraMon, 2)
                                     Else
                                    
                                        ldblCambioOtraMon = Convertir_Importe_Entre_Monedas_Segun_Cotizacion(val(txtEmpresa.text), lstrMN_ME, val(txtMoneda.text), val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTCOtraMon, ldblCambio, txtFec_Doc.text)
                                        .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 6) = ldblCambioOtraMon        '  CGC_IMPCALC
                                    End If
                                End If
                            End If
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 8) = vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO)
                            .vsfMedios_Pagos_Cambio.TextMatrix(.vsfMedios_Pagos_Cambio.Rows - 1, 9) = IIf(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) > 0, "T", "F")  ' CGC_MONPAGA
                                                            
                        End If
                    Next i
                End With
                
                frmPunto_Venta_Ingresa_Cambio_x_Moneda.Show vbModal
                ldblCambio = frmPunto_Venta_Ingresa_Cambio_x_Moneda.txtCambio.text
                
                txtCambio.text = Format(ldblCambio, "###,##0.00")
                
            Else
                ldblCambio = Round(CDbl(Format(txtTotal_Medios_Pago.text, "0.00")) - CDbl(Format(NullToZero(txtImporte.text), "0.00")), 2)
                txtCambio.text = Format(ldblCambio, "###,##0.00")
            
            End If
                         
            DoEvents
   
            cmdGuardar.SetFocus
            
        Else
            Call Calculo_Total_Medios_Pago(True)
            cmdGuardar.SetFocus
        End If
    End If
Exit Sub
Errores:
    Call FErrores
Exit Sub
    Resume
    
End Sub


Private Sub TxtCFinal_GotFocus()
    Call Color_Control_Seleccionado(Me, TxtCFinal)
    Call MarcarTexto(TxtCFinal)
End Sub


Private Sub TxtCFinal_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        TxtCodSuc.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
       TxtRuc.SetFocus
    End If
End Sub


Private Sub TxtCFinal_KeyPress(KeyAscii As Integer)
    If KeyAscii <> 8 Then
        char = Chr(KeyAscii)
        char = UCase(char)
        If char <> " " And char <> "X" Then
            'MsgBox "Solo X o Vacio", vbExclamation, MsgTit
            char = " "
        End If
        KeyAscii = Asc(UCase(char))
    End If
End Sub

Private Sub txtCI_Persona_Autorizada_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtCI_Persona_Autorizada").solicitar_datos = "S"
    End If

End Sub


Private Sub txtCI_Persona_Autorizada_GotFocus()
  
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtCI_Persona_Autorizada").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese la C.I. de la Persona Autorizada"
    Call Color_Control_Seleccionado(Me, txtCI_Persona_Autorizada)
    Call MarcarTexto(txtCI_Persona_Autorizada)

End Sub


Private Sub txtCI_Persona_Autorizada_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtAcopio.SetFocus
    End If
        
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtObs.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        If Not txtLista.Locked Then
            GForm = Me.Name
            GTipoBusc = "ma_Acopios_Personas_Autorizadas"
            gbolESC = True
            whereSelCamG = "acopio = " & val(txtAcopio.text)
            frmBusquedas.Show
        End If
    End If
    
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtAcopio").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(1, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtAcopio.Locked = False
                End If
            End If
        End If
    End If
    

End Sub

Private Sub txtCI_Persona_Autorizada_LostFocus()
On Error GoTo Errores
Dim R As Recordset

    If Not gbolESC Then
        If val(txtAcopio.text) <> 0 Then
            If Trim(txtCI_Persona_Autorizada.text) <> "" Then
                If IsNumeric(txtCI_Persona_Autorizada.text) Then
                    If Not Buscar_Persona_Autorizada_de_Acopio(val(txtAcopio.text), Trim(txtCI_Persona_Autorizada.text), R) Then
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "CI de la Persona No Autorizada para operar con el Acopio", vbInformation, MsgTit
                        
                        'AIR 20250218/20250321 se quita la obligatoriedad a pedido del cliente Sergio Gimenez
'                        txtCI_Persona_Autorizada.SetFocus
'                        Exit Sub
                    Else
                        Call Inicializo_Campos_para_Autorizar
                    End If
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "La CI de la Persona debe ser un número válido", vbInformation, MsgTit
                    'AIR 20250218/20250321 se levanta la restrinccion a pedido de Sergio Gimenez
                    'txtCI_Persona_Autorizada.SetFocus
                End If
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "La CI de la Persona No puede ser Nulo", vbInformation, MsgTit
                'AIR 20250218/20250321 se levanta la restrinccion a pedido de Sergio Gimenez
                'txtCI_Persona_Autorizada.SetFocus
            End If
        End If
    End If
        
Exit Sub
Errores:
    gbooErrorRobot = True
    Resume Next

End Sub

Private Sub txtClauVta_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtClauVta").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtClauVta").solicitar_datos = "S"
    End If

End Sub

Private Sub txtClauVta_GotFocus()
    
    If Trim(txtClauVta.text) = "" Then
        txtClauVta.text = "FOB"
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtClauVta").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese la Clausula de Venta"
    Call Color_Control_Seleccionado(Me, txtClauVta)
    Call MarcarTexto(txtClauVta)
    
End Sub

Private Sub txtClauVta_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtViaTransporte.SetFocus
    End If
    
End Sub

Private Sub txtClauVta_LostFocus()
'    lbolPide_Dato_Manual = False
End Sub

Private Sub txtCodDoc_GotFocus()
    gBolTodosLosDescuentos = False
     stbAyuda.Panels(1).text = "Ingrese el Código de Documento - <F1>Búsqueda por Nombre - <F5> Numera/No Numera - <F7> PreVentas"
  
    If gNumerar = False Then
        lbDisplay.Caption = " NUMERADOR INHABILITADO"
        lbDisplay.Refresh
    End If
    PDF.visible = False
    Call Color_Control_Seleccionado(Me, txtCodDoc)
    Call MarcarTexto(txtCodDoc)
    
     
         
End Sub

Public Sub txtCodDoc_KeyDown(KeyCode As Integer, Shift As Integer)
Dim llngCod_Prov As Long

    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        'AIR 20210712 se cambia el int por val ya que el int de sql es mas amplio
        'If IsNumeric(txtCodDoc.text) And Len(txtCodDoc.text) < 5 Then
        'If Trim(Int(txtCodDoc.text)) = Trim(txtCodDoc.text) Then
        If IsNumeric(txtCodDoc.text) And Len(txtCodDoc.text) < 6 Then
            If Trim(val(txtCodDoc.text)) = Trim(txtCodDoc.text) Then
                If Verifico_Control_Fecha_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), CDate(txtFec_Doc.text), CDate(txtFec_Doc.text), "D") Then
                    txtDoc.SetFocus
                Else
                    txtCodDoc.SetFocus
                End If
            Else
                gbolESC = True
                MsgBox "El código del Tipo de Documento debe ser numérico", vbInformation, MsgTit
                txtCodDoc.SetFocus
            End If
        Else
            gbolESC = True
            MsgBox "El código del Tipo de Documento debe ser numérico", vbInformation, MsgTit
            txtCodDoc.SetFocus
        End If
    End If
   
    If KeyCode = vbKeyF1 Then
        If Not txtCodDoc.Locked Then
            GForm = Me.Name
            If pstrTipo_Ingreso_Documentos = "M" Then
                whereSelCamG = " tipo_doc in('E','P') AND mueve_merca_serv = 'M' and cod_doc NOT IN (" & confDoc_Ingreso_Pedido & "," & confDoc_Ingreso_Pedido_Sugerido & ")"
                whereSelCamG = whereSelCamG & " AND cod_doc IN (SELECT cod_doc FROM vista_ma_Permisos_x_Documentos WHERE cod_funcionario = " & gNro_Usuario & " AND " & Convertir_Operacion_a_Campo_Base_Datos(sspOperacion.Caption) & ")"
            End If
            If pstrTipo_Ingreso_Documentos = "S" Then
                whereSelCamG = " tipo_doc='E' AND mueve_merca_serv = 'S'"
                whereSelCamG = whereSelCamG & " AND cod_doc IN (SELECT cod_doc FROM vista_ma_Permisos_x_Documentos WHERE cod_funcionario = " & gNro_Usuario & " AND " & Convertir_Operacion_a_Campo_Base_Datos(sspOperacion.Caption) & ")"
            End If
            GTipoBusc = "documentos"
            gbolESC = True
            frmBusquedas.Show
            DoEvents
        End If
        '
    End If
    
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtCodDoc").pide_autorizacion = "S" Then    ' Lo comento porque daba error en Casino Justicia SS 20160527, ATU 20170505 se activa nuevamente
                If Autorizacion_Supervision(13, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtCodDoc.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtCodDoc.Locked = False
            End If
        End If
    End If
    
    
    If KeyCode = vbKeyF5 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If Autorizacion_Supervision(17, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                If gNumerar = True Then
                    gNumerar = False
                    lbDisplay.Caption = " NUMERADOR INHABILITADO"
                    lbDisplay.Refresh
                Else
                    gNumerar = True
                    lbDisplay.Caption = ""
                    lbDisplay.Refresh
                    Unload Me
                End If
            End If
        Else
                If gNumerar = True Then
                    gNumerar = False
                    lbDisplay.Caption = " NUMERADOR INHABILITADO"
                    lbDisplay.Refresh
                Else
                    gNumerar = True
                    lbDisplay.Caption = ""
                    lbDisplay.Refresh
                    Unload Me
                End If
        End If
    End If

    
    If KeyCode = vbKeyF7 And (sspOperacion.Caption = "A" Or sspOperacion.Caption = "B") Then
        gbolESC = True
        ' JE 20170519   /   Chequeo si el Cliente es 0 entonces paso -1 aqui para que seleccione todos los clientes
        '                   Sino paso el codigo de proveedor
        '                   Si esta misma funcion la llamo del codigo de Articulo ahi siempre paso el codigo de cliente (aun siendo 0 para que filtre por ese codigo)
        If val(txtCodProv.text) = 0 Then
            llngCod_Prov = -1
        Else
            llngCod_Prov = val(txtCodProv.text)
        End If
        Call Cargar_Desde_Preventas_Pendientes(val(txtEmpresa.text), llngCod_Prov, True)
    End If
    
  '  If KeyCode = vbKeyF2 Then
  '       If Autorizacion_Supervision(6, 4, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
   '           gBolTodosLosDescuentos = True
  '        End If
   ' End If
   
    
End Sub

Private Sub txtCodDoc_LostFocus()
On Error Resume Next
Dim D As Recordset
Dim e As Recordset
Dim M As Recordset
Dim L As Recordset
Dim R As Recordset
Dim RV As Recordset
Dim lrstDocPend As Recordset

Dim llngLista_x_Defecto As Long

    If Not gbolESC Or gPtoVenta_Robot Then
    
        If Trim(txtCodDoc.text) <> "" Then
            llngMaximo_Lineas = llngMaximo_Lineas
        
            If (IsNumeric(txtCodDoc.text) And Trim(Int(txtCodDoc.text)) = Trim(txtCodDoc.text)) And Len(txtCodDoc.text) < 6 Then

                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                    If Trim(UCase(sspOperacion.Caption)) <> "C" And D!signo = 1 And Trim(UCase(D!tipo_doc)) = "E" Then
                        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                            If lcolCampos("txtCodDoc").pide_autorizacion = "S" Then
                                If Not Autorizacion_Supervision(39, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                    txtCodDoc.text = ""
                                    txtCodDoc.SetFocus
                                    Exit Sub
                                End If
                            End If
                        End If
                    End If
                    
                    If Not D!digitado And Trim(UCase(sspOperacion.Caption)) <> "C" And Not gPtoVenta_Robot Then
                        gbolESC = True
                        MsgBox "El Tipo de Documento Ingresado no se Digita", vbInformation, MsgTit
                        txtCodDoc.SetFocus
                        Exit Sub
                    Else
                        If Not Documento_Habilitado_x_Empresa(val(txtEmpresa.text), val(txtCodDoc.text)) Then
                                 gbolESC = True
                                MsgBox "Documento no aceptado para la empresa ingresada ", vbExclamation + vbOKOnly, MsgTit
                                txtCodDoc.SetFocus
                        End If
                        If Not D!eliminar And sspOperacion.Caption = "B" Then
                            gbolESC = True
                            MsgBox "Documento NO Eliminable por Configuracion. Verifique por Favor", vbExclamation + vbOKOnly, MsgTit
                            txtCodDoc.SetFocus
                            Exit Sub
                        Else
                            ' JE 20240622   /   Considero aqui tambien los Documentos tipo_doc = "A" (presupuestos de clientes)
                            If Not Valido_Tipo_Documento("E", Trim(pstrTipo_Ingreso_Documentos), val(txtCodDoc.text)) Then
                            'If Not Valido_Tipo_Documento(D!tipo_doc, Trim(pstrTipo_Ingreso_Documentos), txtCodDoc.text) Then
                                If Trim(D!mueve_merca_serv) = "M" Then
                                    gbolESC = True
                                    MsgBox "Documento No Definido como de Emisión de Servicio. Verifique por Favor", vbExclamation + vbOKOnly
                                    txtCodDoc.SetFocus
                                    Exit Sub
                                Else
                                    gbolESC = True
                                    MsgBox "Documento No Definido como de Emisión de Mercadería. Verifique por Favor", vbExclamation + vbOKOnly
                                    txtCodDoc.SetFocus
                                    Exit Sub
                                End If
                            Else
                            
                                If D!Activo = "N" Then
                                    gbolESC = True
                                    MsgBox "Documento NO esta ACTIVO. Verifique por Favor", vbExclamation + vbOKOnly, MsgTit
                                    txtCodDoc.SetFocus
                                    Exit Sub
                                Else
                                    
                                    If Not Valido_Permiso_de_Usuario_Sobre_el_Documento(val(txtCodDoc.text), gNro_Usuario, sspOperacion.Caption) Then
                                        gbolESC = True
                                        MsgBox "EL USUARIO ACTIVO NO TIENE PERMISOS SOBRE EL DOCUMENTO. Verifique por Favor", vbExclamation + vbOKOnly
                                        txtCodDoc.SetFocus
                                        Exit Sub
                                    Else
                                    
                                        glngCantLinMaxima = Cantidad_Maxima_Lineas_Documento(CLng(Me.txtCodDoc.text))
            
                                    
                                        'Si cambian el tipo de documento, inicializo medios de pago, ya que tambien depende del tipo doc    SS 20200121
                                        If (Trim(UCase(sspOperacion.Caption)) = "A" Or Trim(UCase(sspOperacion.Caption)) = "M") And glngAnterior_Cod_Doc <> val(txtCodDoc.text) Then
                                            Call Inicializo_Grilla_Lineas_Medios_Pago
                                        End If
                                        
                                        If Trim(UCase(sspOperacion.Caption)) = "R" And D!se_Imprime = "N" Then
                                            gbolESC = True
                                            MsgBox "Documento NO SE IMPRIME x Definición. Verifique por Favor", vbExclamation + vbOKOnly, MsgTit
                                            txtCodDoc.SetFocus
                                            Exit Sub
                                        End If
                                        
                                        ' JE 20180707   /   ahora se inicializa el campo txtFactor segun el valor configurado en el Documento
                                        '                   aqui la guardo en esta variable para usarla al inicializar el campo
                                        gstrUnidades_x_Defecto = ""
                                        If Trim(D!unidades_x_defecto_facturador) <> "" Then
                                            If IsNumeric(D!unidades_x_defecto_facturador) Then
                                                gstrUnidades_x_Defecto = Trim(D!unidades_x_defecto_facturador)
                                            End If
                                        End If
                                        
                                        If D!signo = -1 Then
                                            txtNomDoc_Mostrar.ForeColor = &H0&
                                        Else
                                            txtNomDoc_Mostrar.ForeColor = &HFF&
                                        End If
                                        
                                        'Seteo columnas de servicios y otros  SS 20160405
                                        If pstrTipo_Ingreso_Documentos = "S" Then
                                            If D!tipo_doc = "G" Then
                                                LabelCliente.Caption = "Proveedor *"
                                                dbgLineas_Servicios.Columns("precio").visible = False
                                                dbgLineas_Servicios.Columns("tasa_resguardo").visible = True
                                                dbgLineas_Servicios.Columns("precio_siva").Caption = "Monto"
                                            Else
                                                LabelCliente.Caption = "Cliente *"
                                                dbgLineas_Servicios.Columns("precio").visible = True
                                                dbgLineas_Servicios.Columns("tasa_resguardo").visible = False
                                                dbgLineas_Servicios.Columns("precio_siva").Caption = "Sin IVA"
                                            End If
                                            'Seteo columna de Ficha Viaje   SS 20171121
                                            If ConfFicha_Viaje_Cod_Doc_x_Defecto <> 0 Then
                                                dbgLineas_Servicios.Columns("ficha_viaje").visible = True
                                            Else
                                                dbgLineas_Servicios.Columns("ficha_viaje").visible = False
                                            End If
                                        End If
                                        
                                        If D!moneda_x_defecto <> 0 Then
                                            'txtMoneda.text = D!moneda_x_defecto
                                            ' AIR 20240506 sigue habiendo problemas de foco por la rutina de control de descuento agregada por lo cual se controla aqui en la consulta que esta cambiando la moneda que ya fue inicializada para el doc.
                                            If Trim(UCase(sspOperacion.Caption)) = "A" Then
                                                txtMoneda.text = D!moneda_x_defecto
                                            End If
                                            
                                            glngAnterior_Moneda = val(txtMoneda.text)
                                            
                                            If Buscar_Moneda(val(txtMoneda.text), M) Then
                                                txtDes_Moneda.text = Trim(M!simbolo)
                                                txtSimbolo_SubTotal.text = Trim(M!simbolo)
                                                TxtSimbolo_Medios_Pago.text = Trim(M!simbolo)
                                                txtSimbolo_Redondeo.text = Trim(M!simbolo)
                                                TxtSimbolo_Cambio.text = Trim(M!simbolo)
                                                
                                                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                                                
                                                'AIR 20221111 se cambia a pedido de Ricardo porque esta mal esto debe ir el Interbancario
                                                'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
'                                                If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'                                                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'                                                End If
                                                
                                                If ldblTipo_Cambio <> 0 Then
                                                    txtTipo_Cambio.text = Format(ldblTipo_Cambio, "###0.000")

                                                    'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
                                                    'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                                                    'If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                                                    '    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
                                                    'Else
                                                        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                                                    
                                                    'End If
                                                    
                                                    If ldblTipo_Cambio <> 0 Then
                                                        If Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S" Then
                                                            gblnCancelar = False
                                                             
                                                             Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                                             'AIR 20190605
                                                             If gblnCancelar Then
                                                                 gblnCancelar = False
                                                                 txtCodDoc.SetFocus
                                                             End If
                                                        End If
                                                        Call Inicializo_Campos_para_Autorizar
                                                    Else
                                                        gbolESC = True
                                                        MsgBox "Tipo de Cambio Inexistente para la Moneda de Referencia a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                                        txtMoneda.SetFocus
                                                    End If
                                                Else
                                                    gbolESC = True
                                                    MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(txtDes_Moneda.text) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                                    txtMoneda.SetFocus
                                                End If
                                            End If
                                        End If
                                        
                                        If Trim(UCase(sspOperacion.Caption)) = "A" Then
                                            ' Si estamos en ALTA y el Documento tiene un Deposito x defecto se coloca este deposito
                                            
                                            If Buscar_Empresa(val(txtEmpresa.text), e) Then
                                            End If
                                            
                                            txtDeposito.text = Trim(UCase(e!Deposito))
                                            
                                            If Trim(UCase(D!deposito_origen_x_defecto)) <> "" Then
                                                If Trim(UCase(e!Deposito)) <> Trim(UCase(D!deposito_origen_x_defecto)) Then
                                                    txtDeposito.text = Trim(UCase(D!deposito_origen_x_defecto))
                                                End If
                                            End If
                                            
                                            'Se toma lista de precios segun sea mercaderia o servicio   SS 20171027
                                            llngLista_x_Defecto = 0
                                            If pstrTipo_Ingreso_Documentos = "M" And D!lista_x_defecto <> 0 Then
                                                llngLista_x_Defecto = D!lista_x_defecto
                                            End If
                                            If pstrTipo_Ingreso_Documentos = "S" And D!lista_servicios_x_defecto <> 0 Then
                                                llngLista_x_Defecto = D!lista_servicios_x_defecto
                                            End If
                                            If llngLista_x_Defecto <> 0 Then
                                                txtLista.text = llngLista_x_Defecto
                                                If Not Busco_Lista_Precio(val(txtLista.text), D!tipo_lista_x_defecto, L) Then
                                                    MsgBox "Lista del Documento INEXISTENTE. Verifique por Favor...", vbCritical + vbOKOnly
                                                Else
                                                    txtNombre_Lista.text = L!Descripcion
    
                                                    ' JE / 20161011 /Actualizar la Grilla si se cambio la Lista....
                                                    If (Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Lista <> val(txtLista.text) Then
                                                        gblnCancelar = False
                                                         
                                                         Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                                         'AIR 20190605
                                                         If gblnCancelar Then
                                                             gblnCancelar = False
                                                             txtCodDoc.SetFocus
                                                         End If
                                                    End If
                                                    glngAnterior_Lista = val(txtLista.text)
                                                End If
                                        
                                            End If
                                        End If
                                        
                                        txtForma_Pago.text = D!forma_pago
                                        If Busco_Forma_Pago(txtForma_Pago.text) Then
                                            txtDes_Forma_Pago.text = rstFormas_Pago!Descripcion
                                            If Trim(txtFec_Vencimiento.text) = "" Then
                                                If IsNumeric(rstFormas_Pago!dias_a_sumar) Then
                                                    txtFec_Vencimiento.text = Calculo_Vencimiento_Forma_Pago_Cliente(val(txtForma_Pago.text), CDate(txtFec_Doc.text))
                                                    txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                                                Else
                                                    txtFec_Vencimiento.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
                                                End If
                                            End If
                                        End If
                                        
                                        If Trim(UCase(D!mueve_merca_serv)) = "S" Then
                                            sspDatos_Mercaderia.visible = False
                                            sspDatos_Contrato.visible = False
                                            SSPContrato_Externo.visible = False
                                            
                                            If Trim(UCase(D!pide_contrato)) = "S" Then
                                                sspDatos_Contrato.visible = True
                                               ' gbolESC = True
                                               ' txtDoc.SetFocus
                                                DoEvents
                                            End If
                                            If Trim(UCase(D!pide_contrato)) = "E" Then
                                                SSPContrato_Externo.visible = True
                                               ' gbolESC = True
                                               ' txtDoc.SetFocus
                                                DoEvents
                                            End If
                                        Else
                                            sspDatos_Mercaderia.visible = True
                                            sspDatos_Contrato.visible = False
                                            SSPContrato_Externo.visible = False
                                        End If
                                        
                                        If Trim(UCase(D!controlar_saldo_cliente_facturador)) <> "S" Then
                                            labTope_Credito_Moneda.BackColor = &HFFFFFF
                                            labTope_Credito.BackColor = &HFFFFFF
                                            labSaldo_Credito_Moneda.BackColor = RGB(252, 242, 164)
                                            labSaldo_Credito.BackColor = RGB(252, 242, 164)
                                            labSaldo_Credito_Moneda.FontBold = True
                                            labSaldo_Credito.FontBold = True
                                        Else
                                            labTope_Credito_Moneda.Caption = ""
                                            labTope_Credito.Caption = ""
                                            labSaldo_Credito_Moneda.Caption = ""
                                            labSaldo_Credito.Caption = ""
                                            
                                            labTope_Credito_Moneda.BackColor = &HE0E0E0
                                            labTope_Credito.BackColor = &HE0E0E0
                                            labSaldo_Credito_Moneda.BackColor = &HE0E0E0
                                            labSaldo_Credito.BackColor = &HE0E0E0
                                            labSaldo_Credito_Moneda.FontBold = False
                                            labSaldo_Credito.FontBold = False
                                        End If
                                        
                                        fraDescuento_x_Volumen.visible = f_paso_S_N_a_Boolean(D!ver_descuentos_x_volumen)
                                        fraEquivalencias_Stock.visible = f_paso_S_N_a_Boolean(D!ver_equivalencias_stock)
                                        
                                        If vsfLineas_Mercaderia.Rows <= 1 Then
                                            Call Inicializo_Grilla_Lineas_Mercaderia
                                            Call Inicializo_Grilla_Series_Articulos
                                        End If
                                        
                                        Call Inicializo_Campos_para_Autorizar
                                        
                                        If D!signo > 0 Or D!clase = "NDEBITO" Then      ' AIR 20260115 faltaba pasar a asta version la condicion de q la nota de debito pueda afectar
                                            txtDoc_Afectado.Locked = False
                                            txtDoc_Afectado.Enabled = True
                                            txtDoc_Afectado.BackColor = &H80000005
                                            txtNro_Doc_Afectado.Locked = False
                                            txtNro_Doc_Afectado.Enabled = True
                                            txtNro_Doc_Afectado.BackColor = &H80000005
                                            
                                            txtDoc_Remito.Locked = True
                                            txtDoc_Remito.Enabled = False
                                            txtDoc_Remito.BackColor = &HE0E0E0
                                            txtRemito.Locked = True
                                            txtRemito.Enabled = False
                                            txtRemito.BackColor = &HE0E0E0
                                            
                                        Else
                                            txtDoc_Afectado.Locked = True
                                            txtDoc_Afectado.Enabled = False
                                            txtDoc_Afectado.BackColor = &H8000000F
                                            txtNro_Doc_Afectado.Locked = True
                                            txtNro_Doc_Afectado.Enabled = False
                                            txtNro_Doc_Afectado.BackColor = &H8000000F
                                        
                                            txtDoc_Remito.Locked = False
                                            txtDoc_Remito.Enabled = True
                                            txtDoc_Remito.BackColor = &H8000000F
                                            txtRemito.Locked = False
                                            txtRemito.Enabled = True
                                            txtRemito.BackColor = &H8000000F
                                        End If
                                        
                                        'AIR 20250519 en caso que en el alta se cambie el codigo de doc sin dar alta nuevamente que limpian estos campos para evitar errores
                                        txtDoc_Afectado.text = 0
                                        txtNro_Doc_Afectado.text = 0
                                        
                                        txtNomDoc_Mostrar.text = D!nom_doc_mostrar      ' SS 20150917
                                        
                                        If D!pide_orden_compra = "S" Then  ' AIR 20171124
                                            TxtNroIdCompra.Enabled = True
                                        Else
                                            TxtNroIdCompra.Enabled = False
                                        End If
                                        
                                        If sspOperacion.Caption = "M" Or sspOperacion.Caption = "C" Then
                                            cmdEntrega.Enabled = f_paso_S_N_a_Boolean(D!pide_datos_entrega)
                                        End If
                                        
                                        If D!exportacion = "S" Then
                                            Me.txtClauVta.text = "FOB"
                                            Me.txtPais.text = "330 Uruguay/UY"
                                            Me.txtViaTransporte.text = "9 - OTRO"
                                            FrameVendedorGuia.visible = False
                                            FrameExportacion.visible = True
                                            If Buscar_Configuracion_Variables_Documento_B(val(txtCodDoc.text), "FACTURA_EXPORTACION_ZONAFRANCA") Then
                                               FrameVendedorGuia.visible = True
                                               FrameExportacion.visible = False
                                            End If
                                        Else
                                            FrameVendedorGuia.visible = True
                                            FrameExportacion.visible = False
                                        End If
                                        
                                        txtNro_Fanfold.text = Obtener_Nro_Fanfold(val(txtEmpresa.text), val(txtCodDoc.text), ConfPuntoVta_Nro_Caja)
                                        
                                        Select Case ConfFormato_Factura
                                        
                                            Case "DTODASPARTES_SALINAS"
                                                llngMaximo_Lineas = glngCantLinMaxima 'ConfCantidad_Maxima_Lineas_Facturador
                                            
                                            Case "DTODASPARTES_RIVERA"
                                                'If D!cod_doc = 102 Or D!cod_doc = 113 Or D!cod_doc = 152 Or D!cod_doc = 163 Then
                                                    llngMaximo_Lineas = glngCantLinMaxima 'ConfCantidad_Maxima_Lineas_Facturador
                                                'Else
                                                '    llngMaximo_Lineas = 11
                                                'End If
                                                
                                            Case "CASINO-POS"
                                                'If D!cod_doc = 302 Or D!cod_doc = 303 Then
                                                If D!cod_doc = 302 Then     'SS 20190912
                                                    llngMaximo_Lineas = 24
                                                Else
                                                    llngMaximo_Lineas = glngCantLinMaxima
                                                End If
                                            Case "VILDOX"
                                                    llngMaximo_Lineas = glngCantLinMaxima 'ConfCantidad_Maxima_Lineas_Facturador
                                            Case Else
                                                llngMaximo_Lineas = glngCantLinMaxima
                                            
                                        End Select
                                        
                                        glngAnterior_Cod_Doc = val(txtCodDoc.text)
                                        
                                        If IsNull(D!precios_impuestos_incluidos) Then
                                            If Buscar_Variable_Global("PuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos", R) Then
                                                ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = Trim(R!valor)
                                            End If
                                        Else
                                            ConfPuntoVta_Imprime_Efactura_Precio_con_Impuestos_Incluidos = f_paso_S_N_a_Boolean(D!precios_impuestos_incluidos)
                                        End If
                                        
                                        'AIR 20230615
                                        If Buscar_Configuracion_Variables_Documento_B(val(txtCodDoc.text), "PUNTOVTA_IMPRIME_EFACTURA_ADENDA_HABILITA_LINK_PAGO") Then
                                            ChkLink_pago.Value = vbChecked
                                            ChkLink_pago.visible = True
                                        Else
                                            ChkLink_pago.Value = vbUnchecked
                                            ChkLink_pago.visible = False
                                        End If
                                        Call Documento_Usa_IAdic(D!mueve_merca_serv)
                                        
                                    End If
                                End If
                            End If
                        End If
                    End If
                Else
                    gbolESC = True
                    MsgBox "Tipo de Documento Inexistente", vbInformation, MsgTit
                    txtCodDoc.SetFocus
                    Exit Sub
                End If
            Else
                gbolESC = True
                MsgBox "El código del Tipo de Documento debe ser numérico", vbInformation, MsgTit
                txtCodDoc.SetFocus
                Exit Sub
            End If
        Else
            gbolESC = True
            MsgBox "El código del Tipo de Documento No Puede Ser Nulo", vbInformation, MsgTit
            txtCodDoc.SetFocus
            Exit Sub
        End If
    End If
    ' AIR 20170517
    If ConfDiseño_Para_Grandes_Cifras = True Then
        txtImporte.FontSize = 10
        txtTotal_Medios_Pago.Width = 1800
        dbgLineas_Servicios.Columns("Descripcion").Width = 5100
        dbgLineas_Servicios.Columns("Importe").Width = 1900
        dbgLineas_Servicios.Columns("Precio").Width = 1400
        dbgLineas_Servicios.Columns("Precio_siva").Width = 1300
    Else
        txtTotal_Medios_Pago.Width = 1455
        dbgLineas_Servicios.Columns("Descripcion").Width = 5999.812
        dbgLineas_Servicios.Columns("Importe").Width = 1005.165
        dbgLineas_Servicios.Columns("Precio").Width = 884.9764
        dbgLineas_Servicios.Columns("Precio_siva").Width = 689.9528
    End If
    
 ' AIR 20250411
 ' JE 20240819  /   Se agregaron que no se oculte la CI Persona autorizada y se inicializa el Acopio y Descripcion para que no salte en el control de Vacio
    If Not f_InStr_Split(Trim(ConfDocs_Validos_Acopio), Trim(txtCodDoc.text)) Then
        txtAcopio.text = 0
        txtDescripcion_Acopio.text = "SIN ACOPIO ASIGNADO"
        txtAcopio.visible = False
        txtDescripcion_Acopio.visible = False
        labAcopio.visible = False
        labCIPAUT.visible = False
        txtCI_Persona_Autorizada.visible = False
    Else
        txtAcopio.text = 0
        txtDescripcion_Acopio.text = "SIN ACOPIO ASIGNADO"
        txtAcopio.visible = True
        txtDescripcion_Acopio.visible = True
        labAcopio.visible = True
        labCIPAUT.visible = True
        txtCI_Persona_Autorizada.visible = True
    End If
        
    DoEvents
    If dbgLineas_Servicios.visible Then
        dbgLineas_Servicios.Refresh
    End If
    Sleep 1000
End Sub

Sub Documento_Usa_IAdic(ByVal argMovMercServ As String)
        If Trim(UCase(confPais)) = "CL" And Buscar_Configuracion_Variables_Documento_B(val(txtCodDoc.text), "PUNTOVENTA_INGRESA_IMPUESTOS_ADICIONALES") Then
             If Trim(argMovMercServ) = "M" Then
                  vsfLineas_Mercaderia.ColHidden(CGL_TIADIC) = False
                  vsfLineas_Mercaderia.ColHidden(CGL_IADIC) = False
                  vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE_IADIC) = False
             End If
        End If
End Sub
                                    
                                    
Private Sub txtCodProv_GotFocus()
On Error Resume Next
Dim D As Recordset
    
    txtCodProv.Locked = False
    
    If Trim(txtCodProv.text) = "" Then
        txtCodProv.text = ConfPuntoVta_Cliente_x_Defecto    'SS 20180905
    End If
    
    stbAyuda.Panels(1).text = "<F1> Buscar  - <F2> Buscar x Telefono - <F6> Seleccionar Pedidos Pendientes del Movil - <F7> Seleccionar Preventas Pendientes"
    Call Color_Control_Seleccionado(Me, txtCodProv)
    Call MarcarTexto(txtCodProv)
    gCod_Prov = 0
    If sspOperacion.Caption <> "A" Then
        txtCodProv.Locked = True
    End If
    plngCliente_Anterior = txtCodProv.text

End Sub

Private Sub txtCodProv_KeyDown(KeyCode As Integer, Shift As Integer)
DoEvents
Dim D As Recordset
Dim llngCod_Prov As Long

    gbolESC = False
    
    gCargoDesdeF = False
    gstrCodBarraIngresadoPuntoVta = ""
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyUp And sspOperacion.Caption = "M" Then
        txtDoc.SetFocus
    End If
    
    If KeyCode = vbKeyUp And sspOperacion.Caption = "A" Then
        txtCodDoc.SetFocus
    End If
    
    If KeyCode = vbKeyReturn Then

        If txtNomCli.Enabled = True Then
            txtNomCli.SetFocus
        Else
            If TxtRuc.Enabled = False Then
                TxtCodSuc.SetFocus
            Else
                TxtRuc.SetFocus
            End If
        End If
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 And sspOperacion.Caption = "A" Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then           ' SS 20160408
            If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then
                GForm = Me.Name
                GTipoBusc = "proveedores"
                gbolESC = True
                whereSelCamG = ""
                frmBusquedas.Show vbModal
            Else
                'AIR 20250218/20250321
                If f_InStr_Split(Trim(ConfDocs_Validos_Acopio), Trim(txtCodDoc.text)) Then
                    GForm = Me.Name
                    GTipoBusc = "clientes"
                    gbolESC = True
                    whereSelCamG = " nro_cli in (select nro_cli from ma_Acopios_Clientes)"
                    frmBusquedas.Show vbModal
                    
                Else
                    GForm = Me.Name
                    GTipoBusc = "clientes"
                    gbolESC = True
                    whereSelCamG = ""
                    frmBusquedas.Show vbModal
                End If
        
            End If
            gbolESC = False
            Call txtCodProv_KeyDown(vbKeyReturn, 0)
        End If
    End If
       
       
    If KeyCode = vbKeyF2 And sspOperacion.Caption = "A" Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then
                GForm = Me.Name
                GTipoBusc = "VISTA_PROVEEDORES_TELEFONOS"
                gbolESC = True
                whereSelCamG = ""
                frmBusquedas.Show vbModal
            Else
                GForm = Me.Name
                GTipoBusc = "VISTA_CLIENTES_TELEFONOS"
                gbolESC = True
                whereSelCamG = ""
                frmBusquedas.Show vbModal
            End If
            gbolESC = False
            Call txtCodProv_KeyDown(vbKeyReturn, 0)
        End If
    End If
    
       
       
    If KeyCode = vbKeyF6 And sspOperacion.Caption = "A" Then
        gCargoDesdeF = True
        If Cantidad_Moviles <> 0 Then
            gbolESC = True
            frmVer_Documentos_Movil_Pendientes_Procesar.pstrForm_Origen = Me.Name
            frmVer_Documentos_Movil_Pendientes_Procesar.pstrTipo_Llamada = "P"
            frmVer_Documentos_Movil_Pendientes_Procesar.pstrFiltro_Cod_Doc = ConfDoc_Ingreso_Pedido_Cli
            frmVer_Documentos_Movil_Pendientes_Procesar.Show 'vbModal   saco el vbModal     SS 20180601
        End If
        gCargoDesdeF = False
    End If
    
    If KeyCode = vbKeyF7 And (sspOperacion.Caption = "A" Or sspOperacion.Caption = "B") Then
        ' CARGAR DESDE LAS PREVENTAS
        
        gCargoDesdeF = True
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If D!signo = -1 Then
                gbolESC = True
                ' JE 20170519   /   Chequeo si el Cliente es 0 entonces paso -1 aqui para que seleccione todos los clientes
                '                   Sino paso el codigo de proveedor
                '                   Si esta misma funcion la llamo del codigo de Articulo ahi siempre paso el codigo de cliente (aun siendo 0 para que filtre por ese codigo)
                If val(txtCodProv.text) = 0 Then
                    llngCod_Prov = -1
                Else
                    llngCod_Prov = val(txtCodProv.text)
                End If
                Call Cargar_Desde_Preventas_Pendientes(val(txtEmpresa.text), llngCod_Prov, False)
            End If
        End If
        gCargoDesdeF = False
    End If
    
    
End Sub

Public Sub txtCodProv_LostFocus()

Dim B As Recordset
Dim R As Recordset
Dim C As Recordset
Dim L As Recordset
Dim CV As Recordset
Dim U As Recordset
Dim D As Recordset
Dim M As Recordset
Dim CT As Recordset
Dim lrstPais As Recordset
Dim lrsCliente As Recordset

Dim lCliCofis As String
Dim ldblPorcentaje_TBromatologica As Double
Dim lrstPorcentaje_TBromatologica As Recordset
Dim RCI As Recordset
Dim RCuenta_Madre As Recordset
Dim ldblSaldo_Estado_Cuenta As Double
Dim llngLinea_Programa As Long
Dim llngCantidad_Contratos_Vigentes As Long
Dim ldblLimite_Credito_MBase As Double
Dim ldblLimite_Credito_MReferencia As Double
Dim llngLista_x_Defecto_Cliente As Long
Dim llngLista_x_Defecto_Documento As Long
Dim llngCantidad_Dias_Sin_Movimiento As Long
Dim ldblSaldo_Facturas_Vencidas As Double
Dim lbolCambio_Moneda As Boolean
Dim Respuesta As Integer

On Error GoTo Errores:

esTarjeta = False
sumaPuntos = 0
lbolCambio_Moneda = False

'txtDtoGlobal.Locked = False
Respuesta = 0

If plngCliente_Anterior = val(txtCodProv.text) And sspOperacion.Caption <> "A" Then
        gbolESC = True
        Call Color_Control_Seleccionado(Me, txtNomCli)
        Call MarcarTexto(txtNomCli)
        gbooErrorRobot = True
        Exit Sub
End If


If Not gbolESC Or gPtoVenta_Robot Then

    
    If sspOperacion.Caption = "A" Then      'lo dejo dentro del If para que no deje en 0 el descuento cuando lo trae de la preventa SS 20180912
        txtDtoGlobal.text = Format(0, "##0.00")
    End If

    If Trim(txtCodProv.text) <> "" Then
        
        If IsNumeric(txtCodProv.text) Then
            
            If Trim(Len(txtCodProv.text)) > 10 Then
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "Código de Cliente No Válido. Verifique por favor...", vbInformation, MsgTit
                txtCodProv.SetFocus
                Exit Sub
            End If
            
            If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "No se Pudo Inicializar la Configuracion del Documento. Verifique por favor...", vbInformation, MsgTit
                txtCodProv.SetFocus
                Exit Sub
            End If

            '###Proceso el codigo por si es de tarjeta
            If Len(Trim(txtCodProv.text)) > 6 And Mid(Trim(txtCodProv.text), 1, 2) = ConfPrefijoTarjeta Then
                If UCase(Trim(D!acepta_promociones)) = "S" Then
                    txtCodProv.text = val(Mid(Trim(txtCodProv.text), 3, 5))
                    esTarjeta = True
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "El Documento No Acepta Promociones", vbInformation, MsgTit
                    txtCodProv.SetFocus
                    Exit Sub
                End If
            Else
                esTarjeta = False
            End If
            
            
            If Not Buscar_Cliente_Documento(CLng(txtCodProv), CLng(txtCodDoc.text)) Then
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "Cliente no Autorizado en el Documento", vbInformation, MsgTit
                txtCodProv.SetFocus
                Exit Sub
            End If
            
            
                
            'Para buscar por CI en le caso de LCP o La Campana
            If D!tipo_doc <> "G" Then
                If Len(txtCodProv.text) = 7 Or Len(txtCodProv.text) = 8 Then
                    If Buscar_Cliente_X_CI(Trim(txtCodProv.text), RCI) Then
                        txtCodProv.text = RCI!nro_cli
                    End If
                End If
            End If
            
                        
            If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then  ' caso resguardos   SS 20160408
                If Buscar_Proveedor(txtCodProv.text, R) Then
                    
                    'Vemos si el proveedor esta activo
                    If Trim(UCase(R!Activo)) = "S" Then
                        ' AIR 20210226 se agrega la rutina para que cuando levante nombres que llevan apostrofe y tienen el tilde lo convierta para que Efactura lo imprima bien
                        txtNomCli.text = Trim(UCase(f_Ins_String_Con_TILDE(R!rsocial_prov)))
                        
                        If UCase(Trim(sspOperacion.Caption)) = "A" Then
                            If Busco_Empresa(val(txtEmpresa.text)) Then
                                txtLista.text = rstEmpresas!nro_lista
                            Else
                                txtLista.text = 1
                            End If
                            
                            glngAnterior_Lista = val(txtLista.text)
                            
                            TxtRuc.text = ""
                            
                            ' AIR 20210408 se toma el valor definido en el campo nuevo en el proveedor
                            txtTipo_Doc_Identidad.text = R!tipo_doc_identidad
                            glngTipo_Documento_Identidad = R!tipo_doc_identidad
                            
                            If Trim(R!ruc_prov) <> "" Then
                                'txtTipo_Doc_Identidad.text = "2"
                                'glngTipo_Documento_Identidad = 2
                                TxtRuc.text = Trim(R!ruc_prov)
                            Else
                                If Trim(R!ci_prov) <> "" Then
                                    'txtTipo_Doc_Identidad.text = "3"
                                    'glngTipo_Documento_Identidad = 3
                                    TxtRuc.text = Trim(R!ci_prov)
                                Else
                                    ' AIR se toma el valor del campo nuevo definido en el proveedor
                                    txtTipo_Doc_Identidad.text = 4
                                    glngTipo_Documento_Identidad = 4
                                    'AIR 20210629 faltaba cargar este dato
                                    TxtRuc.text = ""
                                End If
                                
                            End If
                            
                            lbDisplay.Caption = Trim(R!dir_prov)
                            TxtTCofis.text = "N"
                            ldblPorcentaje_TBromatologica = 0
                            txtTasa_Bromatologica.text = "0"
                            txtImporte_TBromatologica.text = Format(0, "0.00")
                            txtPorcentaje_TBromatologica.text = "0.00"
                            
                            If Trim(txtMoneda.text) = "" Then
                                txtMoneda.text = 1
                                glngAnterior_Moneda = val(txtMoneda.text)
                            End If
                            
                            If Busco_Moneda(txtMoneda.text) Then
                                 txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                                 txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
                                 TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
                                 txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
                                 TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
                            Else
                                 gbooErrorRobot = True
                                 MsgBox "Moneda INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
                                 txtCodProv.SetFocus
                                 Exit Sub
                            End If
                            
                                                 
                            
                            Call Cargo_Grilla_Medios_Pago_Cliente
                                    
                            Call Calculo_Total_Medios_Pago(True)
                        End If
                    Else
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "El Proveedor Esta Inactivo", vbInformation, MsgTit
                        txtCodProv.SetFocus
                    End If
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Proveedor Inexistente", vbInformation, MsgTit
                    txtCodProv.SetFocus
                End If
            Else
                If Buscar_Cliente(txtCodProv.text, R) = True Then
                    
                    ' Chequeo si el Documento Acepta Clientes Genericos
                    If Trim(UCase(R!generico)) = "S" Then
                        If Trim(UCase(D!permite_titular_generico)) = "N" Then
                            gbolESC = True
                            gbooErrorRobot = True
                            MsgBox "El Documento No Acepta Clientes Genericos", vbInformation, MsgTit
                            txtCodProv.SetFocus
                            Exit Sub
                        End If
                    End If
                    'AIR 20201203 se agrega que cargue el pais del cliente automaticamnte
                    If D!exportacion = "S" Then
                        If Busco_Pais(R!pais, lrstPais) = True Then
                            If txtPais.Rows = 0 Then
                                txtPais.AddItem lrstPais!codigo & " " & lrstPais!nombre
                                txtPais.text = Trim(lrstPais!codigo & " " & lrstPais!nombre)
                            Else
                                txtPais.text = Trim(lrstPais!codigo & " " & lrstPais!nombre)
                            End If
                        End If
                    End If
                    ' AIR 20171024 Control MGI Argentina - se controla si el tipo de Factura del cliente es coherente con el tipo de factura del tipo de documento
                    If ConfVerifica_Tipo_Factura_Cliente_Proveedor = True And Trim(R!tipo_factura) <> Trim(D!tipo_factura) And Trim(UCase(R!generico)) = "N" Then
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "El Documento No Acepta Clientes con Tipo de Factura: " & R!tipo_factura, vbInformation, MsgTit
                        txtCodProv.SetFocus
                        Exit Sub
                    
                    End If
                    
                    'LC 29/11/2016 Consulto si esta seguro si es el documento por defecto
                    If Not val(R!cod_doc_x_defecto) = 0 And Not gPtoVenta_Robot Then
                        If Not val(R!cod_doc_x_defecto) = val(txtCodDoc.text) Then
                                                           
                            Respuesta = MsgBox("Al Cliente se le Factura Habitualmente con Documento (" & R!cod_doc_x_defecto & ") Desea continuar?", vbYesNo + vbQuestion + vbDefaultButton2)
                            
                        End If
                        
                    End If
                    
                    
                    'Vemos si el cliente esta activo
                    If Trim(UCase(R!Activo)) = "S" Then
                    
                        If Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "G" Then
                            ' JE 20160114 / Documento Configurado para que Controle la Cuenta Corriente del Cliente ingresado
                            If (Trim(UCase(R!estado_credito)) <> "H" And Trim(UCase(D!tipo_estado_cta)) = "C" And Trim(UCase(D!clase)) <> "CONTADO" And Trim(UCase(D!clase)) <> "CONTADO PENDIENTE") Or (Trim(UCase(R!estado_credito)) <> "H" And Trim(UCase(D!clase)) = "PEDIDO") Then
                                gbolESC = True
                                gbooErrorRobot = True
                                'If Not gPtoVenta_Robot Then
                                    MsgBox "Crédito Inhabilitado. Solo Puede Comprar Contado", vbInformation, MsgTit
                                'End If
                                txtCodProv.SetFocus
                                Exit Sub
                            End If
                        End If


                        'si es una tarjeta que se paso, vemos que sea un cliente de tarjeta
                        If esTarjeta = True And Trim(UCase(R!cliente_tarjeta)) = "N" Then
                            gbolESC = True
                            gbooErrorRobot = True
                            MsgBox "El Cliente No Tiene Tarjeta", vbInformation, MsgTit
                            txtCodProv.SetFocus
                            Exit Sub
                        Else
                            If ConfPuntoVta_Mostrar_Pedidos_Pendientes_Cliente Then
                                If Buscar_Si_Existe_Pedido_Remito_del_Cliente(val(txtEmpresa.text), val(txtCodProv.text)) Then
                                    sspTiene_Remitos_Pendientes.visible = True
                                Else
                                    sspTiene_Remitos_Pendientes.visible = False
                                End If
                            Else
                                sspTiene_Remitos_Pendientes.visible = False
                            End If
                            'AIR 20210525 se agrega la flag agregada en el tipo de documento controla_cantidad_dias_facturas_vencidas
                            If D!controla_cantidad_dias_facturas_vencidas = "S" And (ConfPuntoVta_Controla_Atraso_Cuotas > 0 Or R!Cantidad_Dias_Facturas_Vencidas > 0) Then
                                ' Controla si el Cliente Tiene Atraso en el Vencimiento de las Cuotas Mayor a lo que dice el Parametro
                                If Verificar_Atraso_Cuotas_Cliente(val(txtEmpresa.text), val(txtCodProv.text), IIf(ConfPuntoVta_Controla_Atraso_Cuotas > 0, ConfPuntoVta_Controla_Atraso_Cuotas, R!Cantidad_Dias_Facturas_Vencidas)) Then
                                    gbolESC = True
                                    gbooErrorRobot = True
                                    MsgBox "El Cliente Tiene Cuotas Vencidas Mayores a " & IIf(ConfPuntoVta_Controla_Atraso_Cuotas > 0, ConfPuntoVta_Controla_Atraso_Cuotas, R!Cantidad_Dias_Facturas_Vencidas) & " Dias" & "." & Chr(13) & "LLame al Supervisor", vbInformation, MsgTit
                                    DoEvents
                                    If ConfPuntoVta_Controla_Cuenta_Madre And R!nro_cli_padre <> 0 Then
                                        ' Se controla la cuenta Madre y este Cliente tiene una cuenta Madre asociada.
                                        ' En este caso solo Aviso pero dejo seguir facturando
                                    Else
                                        ' AIR 20190717 se agrega la solicitud de Autorizacion
                                        
                                        If Not Autorizacion_Supervision(35, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            DoEvents
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                End If
                            End If
                            
                            If ConfPuntoVta_Controla_Cuenta_Madre Then
                                ' Se controla el Uso de la Cuenta Madre
                                If R!nro_cli_padre <> 0 And D!tipo_estado_cta <> "R" Then
                                    If Buscar_Cliente(R!nro_cli_padre, RCuenta_Madre) Then
                                    
                                        'Verifico si el cliente es cuenta madre - no se puede facturar directamente al cliente que es cuenta madre
                                        If val(txtCodProv.text) = R!nro_cli_padre Then
                                        
                                            'AIR 20190403 se agrega exepcion para el Baratillo para los documentos de retenciones y comisiones
                                            If ConfFormato_Factura = "BARATILLO" And (val(txtCodDoc.text) = 162 Or val(txtCodDoc.text) = 163 Or val(txtCodDoc.text) = 164) Then
                                                ' se permite ingresar estos documentos a cuenta madre
                                                
                                            Else
                                                gbolESC = True
                                                gbooErrorRobot = True
                                                MsgBox "Cliente Definido para Trabajar como Cuenta Madre, NO se permite imputar facturas directamente. Verifique...", vbCritical + vbOKOnly
                                                txtCodProv.SetFocus
                                                Exit Sub
                                            
                                            End If
                                        End If
                                         
                                        If Trim(UCase(R!exclusivoclipadre)) = "N" Then
                                            ' Consulto si la venta se carga a la Cuenta Madre o a la Cuenta Personal
                                            If MsgBox("El Documento se Carga a la Cuenta Madre --> " & R!nro_cli_padre & " - " & UCase(Trim(RCuenta_Madre!rsocial_cli)) + " ?", vbQuestion + vbYesNo) = vbYes Then
                                                txtCta_Madre.text = R!nro_cli_padre
                                            Else
                                                txtCta_Madre.text = "0"
                                            End If
                                        Else
                                            txtCta_Madre.text = R!nro_cli_padre
                                        End If
                                    Else
                                        If Trim(UCase(R!exclusivoclipadre)) = "S" Then
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            MsgBox "Cliente Definido para Trabajar Exclusivo con la Cuenta Madre, Pero No existe la Cuenta Madre Asignada. Verifique...", vbCritical + vbOKOnly
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                Else
                                    txtCta_Madre.text = "0"
                                End If
                            End If
                        
                            If ConfPuntoVta_Controla_Cuenta_Madre And val(txtCta_Madre.text) <> 0 Then
                            
                                ' Chequeo que el Documento que estoy ingresando tenga el Documento a Generar en la Cuenta Madre
                                If D!cod_doc_cta_madre = 0 Then
                                    gbolESC = True
                                    gbooErrorRobot = True
                                    MsgBox "El Documento No Tiene Asociado el Documento a Generar para la Cuenta Madre", vbInformation, MsgTit
                                    txtCodProv.SetFocus
                                    Exit Sub
                                End If
                            End If
                        
                        
                            If UCase(Trim(sspOperacion.Caption)) = "A" Or UCase(Trim(sspOperacion.Caption)) = "M" Then
                                    
                                If glngAnterior_Cliente <> val(txtCodProv.text) Then
                                                                
                                    txtMoneda.text = 1
                                    glngAnterior_Moneda = val(txtMoneda.text)
                                        
                                    ' Inicializo Moneda Segun Tipo de Documento
                                    If pstrTipo_Ingreso_Documentos = "M" Then
                                        If ConfPuntoVta_Moneda_x_Defecto_DMercaderia <> 0 Then
                                            txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DMercaderia
                                            glngAnterior_Moneda = val(txtMoneda.text)
                                        End If
                                    End If
                                    
                                    If pstrTipo_Ingreso_Documentos = "S" Then
                                        If ConfPuntoVta_Moneda_x_Defecto_DServicio <> 0 Then
                                            txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DServicio
                                            glngAnterior_Moneda = val(txtMoneda.text)
                                        End If
                                    End If
                                
                                    ' Inicializo Moneda Segun Codigo de Documento
                                    If D!moneda_x_defecto <> 0 Then
                                        txtMoneda.text = D!moneda_x_defecto
                                        glngAnterior_Moneda = val(txtMoneda.text)
                                    End If
                                    
                                    'Saco esto del IF anterior para que actualice datos de la moneda siempre    SS 20191113
                                    If Buscar_Moneda(val(txtMoneda.text), M) Then
                                        txtDes_Moneda.text = Trim(M!simbolo)
                                        txtSimbolo_SubTotal.text = Trim(M!simbolo)
                                        TxtSimbolo_Medios_Pago.text = Trim(M!simbolo)
                                        txtSimbolo_Redondeo.text = Trim(M!simbolo)
                                        TxtSimbolo_Cambio.text = Trim(M!simbolo)
                                        
                                        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                                        
                                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
'                                        If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'                                            ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'                                        End If
'
                                        If ldblTipo_Cambio <> 0 Then
                                            txtTipo_Cambio.text = Format(ldblTipo_Cambio, "###0.000")

                                            'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
                                            'AIR 20180326 si la factura es en DOLARES toma el manual comprador
'                                            If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'                                                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'                                            Else
                                                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
 '                                           End If
                                            
                                            If ldblTipo_Cambio <> 0 Then
                                                If Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S" Then
                                                    
                                                    gblnCancelar = False
                                                    
                                                    Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                                    'AIR 20190605
                                                    If gblnCancelar Then
                                                        txtCodProv.SetFocus
                                                        gblnCancelar = False
                                                    End If
                                                End If
                                                Call Inicializo_Campos_para_Autorizar
                                            Else
                                                gbolESC = True
                                                gbooErrorRobot = True
                                                MsgBox "Tipo de Cambio Inexistente para la Moneda de Referencia a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                                txtMoneda.SetFocus
                                            End If
                                        Else
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(txtDes_Moneda.text) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                            txtMoneda.SetFocus
                                        End If
                                    End If
                                End If
                                
                                ' JE 20180611   /    Si el Cliente tiene una Moneda x Defecto para Facturar lo aplico aqui
                                If R!moneda_x_defecto_facturar <> 0 Then
                                    
                                    'glngAnterior_Moneda = Val(txtMoneda.text)  'Se comenta y pasa despues del IF   SS 20200213
                                    txtMoneda.text = R!moneda_x_defecto_facturar
                                    
                                    If Buscar_Moneda(val(txtMoneda.text), M) Then
                                        txtDes_Moneda.text = Trim(M!simbolo)
                                        txtSimbolo_SubTotal.text = Trim(M!simbolo)
                                        TxtSimbolo_Medios_Pago.text = Trim(M!simbolo)
                                        txtSimbolo_Redondeo.text = Trim(M!simbolo)
                                        TxtSimbolo_Cambio.text = Trim(M!simbolo)
                                        
                                        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                                        
                                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
                                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador

'                                        If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'                                            ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'                                        End If
                                        
                                        If ldblTipo_Cambio <> 0 Then
                                            txtTipo_Cambio.text = Format(ldblTipo_Cambio, "###0.000")

                                            'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
                                            'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                                            
                                            'If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                                            '    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
                                            'Else
                                                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                                            'End If
                                            
                                            If ldblTipo_Cambio <> 0 Then
                                                If (Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Moneda <> val(txtMoneda.text) Then 'Agrego si cambio moneda    SS 20200213
                                                   
                                                    gblnCancelar = False
                                                    Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                                    'AIR 20190605
                                                    If gblnCancelar Then
                                                        gblnCancelar = False
                                                        txtCodProv.SetFocus
                                                    End If
                                                    
                                                End If
                                                Call Inicializo_Campos_para_Autorizar
                                            Else
                                                gbolESC = True
                                                gbooErrorRobot = True
                                                MsgBox "Tipo de Cambio Inexistente para la Moneda de Referencia a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                                txtCodProv.SetFocus
                                            End If
                                        Else
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(txtDes_Moneda.text) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                            txtCodProv.SetFocus
                                        End If
                                    End If
                                    
                                    glngAnterior_Moneda = val(txtMoneda.text)   'SS 20200213
                                    
                                End If
                            
                            
                                'Si todo OK
                                If ConfPuntoVta_Controla_Limite_Credito_Cheques_Cartera Then
                                    
                                    'Solo control para casino, controlamos que el cliente no supere el limite de credito
                                    'Contra los cheques recibidos en cartera
                                    
                                    'If Val(txtCodProv.Text) <> 0 Then
                                    If val(R!limite_credito_cheques) <> 0 Then
                                        If Supera_Saldo_Cheques("C", val(txtCodProv.text), R!limite_credito_cheques, "C") Then
                                            MsgBox "El Monto de Cheques en Cartera Supera el Limite", vbInformation, MsgTit
                                            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                                If Not Autorizacion_Supervision(15, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                    txtCodProv.text = ""
                                                    gbooErrorRobot = True
                                                    
                                                    txtCodProv.SetFocus
                                                    Exit Sub
                                                End If
                                            Else
                                                gbooErrorRobot = True
                                                txtCodProv.text = ""
                                                gbooErrorRobot = True
                                                txtCodProv.SetFocus
                                                Exit Sub
                                            End If
                                        End If
                                    End If
                                End If
                                    
                                If ConfPuntoVta_Controla_X_Dias_Cliente_Sin_Movimientos > 0 Then
                                    ' JE 20180409   /   Controlar si el Cliente lleva mas de X dias sin movimientos  - Casino Justicia
                                    llngCantidad_Dias_Sin_Movimiento = Cantidad_Dias_Ultimo_Movimiento_Cliente(val(txtEmpresa.text), val(txtCodProv.text))
                                    If llngCantidad_Dias_Sin_Movimiento > ConfPuntoVta_Controla_X_Dias_Cliente_Sin_Movimientos Then
                                        MsgBox "El Cliente no Tiene Movimientos por un Periodo de " & llngCantidad_Dias_Sin_Movimiento & " dias." & Chr(13) & "LLame al Supervisor", vbCritical + vbOKOnly, MsgTit
                                        
                                        If Not Autorizacion_Supervision(34, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            DoEvents
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                End If
                                'AIR 20210525 se agrega la flag agregada en el tipo de documento controla_cantidad_dias_facturas_vencidas
                                If D!controla_cantidad_dias_facturas_vencidas = "S" And (ConfPuntoVta_Controla_X_Dias_Cliente_Facturas_Vencidas > 0 Or R!Cantidad_Dias_Facturas_Vencidas > 0) Then
                                    ' JE 20180409   /   Controlar si el Cliente tiene Facturas Vencidas por mas de X dias
                                    If Hay_Documentos_Pendientes_Cancelacion_Mayores_a_X_Dias(val(txtEmpresa.text), val(txtCodProv.text), ldblSaldo_Facturas_Vencidas, R!Cantidad_Dias_Facturas_Vencidas) Then
                                    
                                        If Buscar_Moneda(gMoneda_Base, M) Then
                                        End If
                                        
                                        MsgBox "El Cliente Tiene Facturas Vencidas de mas de " & IIf(R!Cantidad_Dias_Facturas_Vencidas <> 0, R!Cantidad_Dias_Facturas_Vencidas, ConfPuntoVta_Controla_X_Dias_Cliente_Facturas_Vencidas) & " dias, por un importe en Moneda Nacional " & Trim(UCase(M!simbolo)) & " " & Format(ldblSaldo_Facturas_Vencidas, "0.00") & "." & Chr(13) & "LLame al Supervisor", vbCritical + vbOKOnly, MsgTit
                                        
                                        If Not Autorizacion_Supervision(35, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            DoEvents
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                End If
                                
                                labTope_Credito_Moneda.Caption = ""
                                labTope_Credito.Caption = ""
                                labSaldo_Credito_Moneda.Caption = ""
                                labSaldo_Credito.Caption = ""
                                
                                labTope_Credito_Moneda.BackColor = &HE0E0E0
                                labTope_Credito.BackColor = &HE0E0E0
                                labSaldo_Credito_Moneda.BackColor = &HE0E0E0
                                labSaldo_Credito.BackColor = &HE0E0E0
                                labSaldo_Credito_Moneda.FontBold = False
                                labSaldo_Credito.FontBold = False
                                    
                                If ConfPuntoVta_Controla_Limite_Credito Or (Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "G") Then
                                    If R!cre_cli <> 0 Then
                                       If Not Buscar_Limite_Credito(val(txtEmpresa.text), val(txtCodDoc.text), txtCodProv.text, val(txtMoneda.text), CDate(txtFec_Doc.text), 0, val(txtTipo_Cambio.text), True) Then
                                            gbolESC = True
                                            gbooErrorRobot = True
                                            DoEvents
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                        
                                    End If
                                End If
                                
                                txtDtoGlobal.text = Format(0, "##0.00")
                                ' AIR 20250425 estaba cargando el % de dscto del cliente para un resguardo
                                If D!tipo_doc <> "G" Then
                                    If Trim(UCase(R!tipo_porcentaje)) = "D" Then
                                       'JCH 20220519 se agrego este if para ver que descuento se toma segun la moneda
                                       If IsNumeric(txtMoneda.text) Then
                                           If val(txtMoneda.text) = gMoneda_Base Then
                                              Me.txtDtoGlobal.text = IIf(IsNull(R!porcentaje), 0, R!porcentaje)
                                           Else
                                              Me.txtDtoGlobal.text = IIf(IsNull(R!porcentaje_ref), 0, R!porcentaje_ref)
                                           End If
                                       End If
                                    
                                    End If
                                End If
                                ' JE 20240819   /   Si Avisa los Clientes con Descuento Global coloco mje
                                If ConfPuntoVta_Avisa_Cliente_Con_Descuento_Global Then
                                    If val(txtDtoGlobal.text) > 0 Then
                                        MsgBox "ATENCION: Cliente con Descuento Global", vbInformation + vbOKOnly
                                    End If
                                End If
                                
                                If esTarjeta = True Then
                                    sumaPuntos = R!suma_puntos
                                End If
                                
                                'ATU 20170729, si el documento es CONTADO no carga la forma de pago del cliente registrado.
                                'Se agrega excepcion para CASINO JUSTICIA SS 20160817
                                'Se agrega excepcion para UNIVER JE 20160823
                                
                                If (R!tip_cli <> 0 And D!clase <> "CONTADO" And D!clase <> "CONTADO PENDIENTE") Or (R!tip_cli <> 0 And (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "DUNIVER")) Then
                                    ' El Cliente tiene una Forma de Pago Distinta a la del Documento... Dejo entonces la Forma de Pago del Cliente
                                    txtForma_Pago.text = R!tip_cli
                                    If Busco_Forma_Pago(txtForma_Pago.text) Then
                                        txtDes_Forma_Pago.text = rstFormas_Pago!Descripcion
                                        txtFec_Vencimiento.text = CDate(txtFec_Doc.text) + rstFormas_Pago!dias_a_sumar
                                        txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                                    End If
                                    rstFormas_Pago.Close
                                End If
                                                                
                                If Trim(UCase(sspOperacion.Caption)) = "A" Then
                                    If Not gbolCargo_Desde_Preventa Then
                                        ' AIR 20210226 se agrega la rutina para que cuando levante nombres que llevan apostrofe y tienen el tilde lo convierta para que Efactura lo imprima bien
                                        txtNomCli.text = Trim(UCase(f_Ins_String_Con_TILDE(R!rsocial_cli)))
                                        TxtRuc.text = ""                        ' SS 20150804
                                        txtTipo_Doc_Identidad.text = "4"
                                        glngTipo_Documento_Identidad = 4
                                    Else
                                        txtNomCli.text = Trim(UCase(f_Ins_String_Con_TILDE(R!rsocial_cli)))
                                        TxtRuc.text = Trim(R!ruc_cli)   'AIR 20191010 se inicializa xq estaba quedando el rut mal cuando levantaban de una preventa y luego cambiaban el cliente
                                    End If
                                    
                                    ' JE 20160820   /   Se inicializa cuando es un ALTA estos Datos de la Direccion desde la Ficha del Cliente.
                                    ' sino se ingresa otra con el F10 en el Nombre del Cliente del forumulario se da de Alta estos datos en la Faccmp_Cabezal_Auxiliar
                                    
                                    If Trim(R!ruc_cli) <> "" Then
                                    
                                        glngTipo_Documento_Identidad = 2
                                        gstrDocumento_Identidad = Trim(R!ruc_cli)
                                        
                                    Else
                                        If Trim(R!ci_contacto) <> "" Then
                                            'AIR 202100712 se cambia porque la cedula de ID es codigo 3
                                            'glngTipo_Documento_Identidad = 4
                                        
                                            txtTipo_Doc_Identidad.text = "3"
                                            glngTipo_Documento_Identidad = 3
                                            
                                           TxtRuc.text = Trim(R!ci_contacto)
                                           gstrDocumento_Identidad = Trim(R!ci_contacto)
                                        Else
                                            'AIR 202100712  faltaba cargar este dato
                                            txtTipo_Doc_Identidad.text = "4"
                                            glngTipo_Documento_Identidad = 4
                                            TxtRuc.text = Trim(R!otro_doc_identidad_cli)
                                            gstrDocumento_Identidad = Trim(R!otro_doc_identidad_cli)
                                        End If
                                    End If
                                    
                                                                       
                                    
                                    
                                    
                                    gstrDireccion = Trim(UCase(R!dir_cli)) & " " & Trim(UCase(R!nro_puerta))
                                    If Trim(R!nro_apto) <> "" Then
                                        gstrDireccion = Trim(gstrDireccion) & " / " & Trim(R!nro_apto)
                                    End If
                                    
                                    gstrTelefonos = Trim(Telefonos_Cliente(R!nro_cli))
                                    glngCod_Pais = R!pais
                                    glngCod_Departamento = R!departamento
                                    glngCod_Ciudad = R!Ciudad
                                    gstreMail = Trim(LCase(R!email_cli))
                                    glngCod_Grupo = R!grupo
                                    
                                Else
                                    ' AIR 20210226 se agrega la rutina para que cuando levante nombres que llevan apostrofe y tienen el tilde lo convierta para que Efactura lo imprima bien
                                    txtNomCli.text = Trim(UCase(f_Ins_String_Con_TILDE(R!rsocial_cli)))
                                    TxtRuc.text = ""                            ' SS 20150804
                                    txtTipo_Doc_Identidad.text = "4"
                                    glngTipo_Documento_Identidad = 4
                                End If
                                
                                TxtComentario.text = Trim(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(IIf(IsNull(R!comentario), "", Trim(R!comentario))))
                                
                                Call Cargo_Tipo_Documento_Identidad(R!nro_cli)
                                
                                Select Case val(txtTipo_Doc_Identidad.text)

                                    Case 2 ' RUT Uruguay
                                        'Si no tienen ruc, los marcamos como consumo final y controla la CI con la rutina
                                        If Trim(TxtRuc.text) = "" Then
                                            TxtCFinal.text = "X"
                                        Else
                                            If val(TxtRuc.text) <> 0 Then
                                                If Not Validar_RUT(TxtRuc.text) Then
                                                    gbooErrorRobot = True
                                                    MsgBox "ERROR: EL RUT del Cliente No es Válido. Verifique...", vbCritical + vbOKOnly
                                                    txtCodProv.SetFocus
                                                    Exit Sub
                                                End If
                                                
                                                 'jch 31.07.2024 controla que el cliente no tenga el mismo rut que la empresa
                                                If Trim(txtTipo_Doc_Identidad.text) = "2" And D!tipo_doc = "E" Then
                                                    If Not Control_Empresa_Cliente_RUT(CLng(txtEmpresa.text), TxtRuc.text) Then
                                                        gbolESC = True
                                                        gbooErrorRobot = True
                                                        txtCodProv.text = ""
                                                        TxtRuc.text = ""
                                                        txtNomCli.text = ""
                                                        DoEvents
                                                        txtCodProv.SetFocus
                                                        Exit Sub
                                                    End If
                                                End If
                                            Else
                                                TxtRuc.text = ""
                                                TxtCFinal.text = "X"
                                            End If
                                        End If
                                        
                                       
                                    
                                    Case 3  ' CI Uruguay
                                        If Trim(TxtRuc.text) <> "" Then
                                            If Not Validar_CI_Uruguay(TxtRuc.text) Then
                                                gbooErrorRobot = True
                                                MsgBox "ERROR: LA CI Ingresada No es Válida. Verifique...", vbCritical + vbOKOnly
                                                txtCodProv.SetFocus
                                                Exit Sub
                                            End If
                                        End If
                                    Case Else
                                                                            
                                End Select
                                
                                lCliCofis = R!desglosa_Cofis
                                If Trim(TxtRuc.text) <> "" Or Trim(lCliCofis) = "S" Then
                                    TxtTCofis.text = "S"
                                Else
                                    TxtTCofis.text = "N"
                                End If
                                'ATU, si esta bloqueada es porque se cargo desde un pedido de WIS
                                '06/03/2014
                                If Not gbolCargo_Desde_WIS And Not gbolCargo_Desde_Preventa Then
                                
                                    'Establece lista por defecto del documento      SS 20171030
                                    llngLista_x_Defecto_Documento = 0
                                    If pstrTipo_Ingreso_Documentos = "M" Then
                                        llngLista_x_Defecto_Documento = D!lista_x_defecto
                                    End If
                                    If pstrTipo_Ingreso_Documentos = "S" Then
                                        llngLista_x_Defecto_Documento = D!lista_servicios_x_defecto
                                    End If
                                    
                                    'Establece lista por defecto del cliente
                                    llngLista_x_Defecto_Cliente = 0
                                    If pstrTipo_Ingreso_Documentos = "M" Then
                                        llngLista_x_Defecto_Cliente = R!nro_lista
                                    End If
                                    If pstrTipo_Ingreso_Documentos = "S" Then
                                        llngLista_x_Defecto_Cliente = R!nro_lista_servicios
                                    End If
                                
                                    txtLista.text = llngLista_x_Defecto_Cliente
                                    If llngLista_x_Defecto_Documento <> 0 And UCase(Trim(D!tipo_lista_x_defecto)) = "V" Then
                                        ' JE 20160113 / Si el Cliente tien configurado lista 0 y ademas el Documento si tiene una lista por defecto paso esta
                                        txtLista.text = llngLista_x_Defecto_Documento
                                    Else
                                        If val(txtLista.text) = 0 Then
                                            ' JE 20160220 / Si sigue en 0 la lista y el documento no tiene configurado ninguna lista por defecto, uso la de la Empresa
                                            If Busco_Empresa(val(txtEmpresa.text)) Then
                                                txtLista.text = rstEmpresas!nro_lista
                                            End If
                                        End If
                                    End If
                                    If Not Busco_Lista_Precio(txtLista.text, "V", L) Then
                                        gbooErrorRobot = True
                                        MsgBox "Lista del Cliente INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
                                        txtCodProv.SetFocus
                                        Exit Sub
                                    Else
                                        If Trim(UCase(L!Activo)) = "S" Then
                                            txtNombre_Lista.text = L!Descripcion
                                        Else
                                            gbooErrorRobot = True
                                            MsgBox "Lista del Cliente INACTIVA. Verifique por Favor", vbCritical + vbOKOnly
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                    glngAnterior_Lista = val(txtLista.text)
                                End If
                                
                                If Trim(txtMoneda.text) = "" Then
                                    txtMoneda.text = 1
                                    glngAnterior_Moneda = val(txtMoneda.text)
                                End If
                                
                                If Busco_Moneda(txtMoneda.text) Then
                                    txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
                                Else
                                    gbooErrorRobot = True
                                    MsgBox "Moneda de la Lista INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
                                    txtCodProv.SetFocus
                                    Exit Sub
                                End If

                                ' JE 20160808   /   para que si se cambia de nuevo el cliente se refresque el codigo de vendedor aun sindo distinto de cero.
'                                If Trim(sspOperacion.Caption) = "A" And Val(TxtVendedor.Text) = 0 Then
                                If Trim(sspOperacion.Caption) = "A" Then
                                    If ConfPuntoVta_Vendedor_x_Defecto <> 0 Then
                                        txtVendedor.text = ConfPuntoVta_Vendedor_x_Defecto
                                    Else
                                        If txtVendedor.text <> "" And (ConfFormato_Factura = "ALMADU" Or ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET") Then   ' SS 20161007  para cuando factura pedidos del movil
                                        Else
                                            If Busco_Usuario(str(gNro_Usuario), U) Then
                                                txtVendedor.text = U!vendedor
                                            End If
                                            If val(txtVendedor.text) = 0 Or Trim(ConfPuntoVta_Usa_Vendedor_Cliente) = "S" Then
                                                txtVendedor.text = R!nro_ven
                                            End If
                                                                 
                                        End If
                                    End If
                                    If Buscar_Vendedor(txtVendedor.text, C) Then
                                        If C!Activo = "S" Then
                                            TxtNomVen.text = Trim(IIf(IsNull(C!nom_ven), " ", C!nom_ven) & " " & IIf(IsNull(C!ape_ven), " ", C!ape_ven))
                                        Else
                                            MsgBox "Vendedor  " & txtVendedor.text & "  No esta Activo. Verifique por Favor", vbCritical + vbOKOnly
                                            gbooErrorRobot = True
                                            txtCodProv.SetFocus
                                            Exit Sub
                                        End If
                                    End If
                                End If
                                
                                'Incluimos la observacion automatica
                                'Si es exportacion, no la cargamos.
                                If Trim(R!observa_factura) <> "" And Trim(sspOperacion.Caption) = "A" And D!exportacion <> "S" Then
                                    txtObs.text = Trim(R!observa_factura)
                                End If
                                
                                txtTasa_Bromatologica.text = IIf(IsNull(R!tasa_bromatologica), "0", Trim(R!tasa_bromatologica))
                                
                                If Busco_Tipo_Tasa_Bromatologica(txtTasa_Bromatologica.text, B) Then
                                    ldblPorcentaje_TBromatologica = Porcentaje_Tasa_Bromatologica_Vigente(B!codigo, CDate(txtFec_Doc.text), lrstPorcentaje_TBromatologica)
                                    txtPorcentaje_TBromatologica.text = Format(ldblPorcentaje_TBromatologica / 100, "0.00%")
                                Else
                                    ldblPorcentaje_TBromatologica = 0
                                    txtPorcentaje_TBromatologica.text = "0.00"
                                End If
                                            
                                If (Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Cliente <> val(txtCodProv.text) Then 'Se agrega si cambia el cliente SS 20200121
                                    
                                    gblnCancelar = False
                                    Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                    'AIR 20190605
                                    If gblnCancelar Then
                                        gblnCancelar = False
                                        txtCodProv.SetFocus
                                    End If
                                    
                                End If
                                
                                If Busco_Categoria_Credito_Cliente(R!categoria_credito, CT) Then
                                    txtCategoria_Descripcion.text = Trim(UCase(CT!Descripcion))
                                    If Trim(UCase(CT!avisar_cobranza_clientes)) = "S" Then
                                        MsgBox "CATEGORIA DEL CREDITO: " & (UCase(CT!Descripcion)), vbInformation, MsgTit
                                    End If
                                End If
                                
                                'Inicializo la grilla de detalle
                                If pstrTipo_Ingreso_Documentos = "S" And ConfFicha_Viaje_Cod_Doc_x_Defecto <> 0 Then      ' SS 20171122
                                    dbgLineas_Servicios.removeAll
                                End If
                                
                                Call Cargo_Grilla_Personas_Autorizadas(val(txtCodProv.text))
                                
                                Call Cargo_Grilla_Medios_Pago_Cliente
                                
                                Call Calculo_Total_Medios_Pago(True)
                                
                                Call Color_Control_Seleccionado(Me, txtNomCli)
                                Call MarcarTexto(txtNomCli)
                                
                                Call Muestro_Direccion_Ciudad_Telefono(R!nro_cli, val(TxtCodSuc.text))
                                
                                Call Verifico_Documento_Cancelado

                                glngAnterior_Cliente = val(txtCodProv.text)

                                DoEvents
                            End If
                            
                                                        
                            
                            If Not ControlDescuentosGeneral("txtCodProv") Then
                                gbolESC = True
                                gbooErrorRobot = True
                                'MsgBox "Lista de Precios Inexistente", vbInformation, MsgTit
                                txtCodProv.SetFocus
                                Exit Sub
                            End If
                            
                                                       
                            
                            
                        End If
                    Else
                        gbolESC = True
                        MsgBox "El Cliente Esta Inactivo", vbInformation, MsgTit
                        gbooErrorRobot = True
                        txtCodProv.SetFocus
                    End If
                    
                    ' AIR 12/06/2017 Se agrega control a pedido de Veicuer para que no se pueda cambiar el nombre ni Rut del cliente a menos que el cliente sea el generico/ se disparan Lostfocus necesarios para la carga de datos.
                    If ConfPuntoVta_Permite_Cambiar_Nombre_Cliente = False And (Trim(UCase(R!generico)) = "N" Or IsNull(UCase(R!generico))) Then
                        
                        ' AIR 20220311 Cambio  el dehabilitar para despues de ejecutar los lostfocus porque al ejecutarse esta cambiando el estatus nuevamente.
'                        txtNomCli.Enabled = False
'                        txtTipo_Doc_Identidad.Enabled = False
'                        TxtCFinal.Enabled = False
'                        TxtRuc.Enabled = False
'
                        Call TxtRuc_LostFocus
                        Call TxtCodSuc_GotFocus
                        
                        Call TxtCodSuc_LostFocus
                        
                        txtNomCli.Enabled = False
                        txtTipo_Doc_Identidad.Enabled = False
                        TxtCFinal.Enabled = False
                        TxtRuc.Enabled = False
                        
                    Else
                        txtNomCli.Enabled = True
                        txtTipo_Doc_Identidad.Enabled = True
                        TxtCFinal.Enabled = True
                        TxtRuc.Enabled = True
                        
                    End If
                    'AIR 20240429 con el agregado de la rutina ControlDescuentosGeneral() mas arriba se esta perdiendo el foco definido en el keydown por lo cual agrego la definicion aqui
                    If txtNomCli.Enabled = True Then
                        txtNomCli.SetFocus
                    Else
                        If TxtRuc.Enabled = False Then
                            TxtCodSuc.SetFocus
                        Else
                            TxtRuc.SetFocus
                        End If
                    End If
                    
                    If Respuesta = vbNo Then
                        gbolESC = True
                        gbooErrorRobot = True
                                'txtCodProv.text = ""
                        txtCodDoc.SetFocus
                        Exit Sub
                    End If
                    
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Cliente Inexistente", vbInformation, MsgTit
                    txtCodProv.SetFocus
                End If
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El código del Cliente es numerico", vbInformation, MsgTit
            txtCodProv.SetFocus
        End If
    Else
        If sspOperacion.Caption <> "B" And Not gbolESC Then
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El código del Cliente No Puede Ser Nulo", vbInformation, MsgTit
            txtCodProv.SetFocus
        End If
    End If
End If



    
Exit Sub

Errores:
    gbooErrorRobot = True
    MsgBox "Error Nro: " & Err.number & Chr(13) & "Des: " & Err.Description & Chr(13) & Err.Source, vbCritical, MsgTit
    Resume Next
End Sub

Private Sub TxtCodSuc_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("TxtCodSuc").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("TxtCodSuc").solicitar_datos = "S"
    End If

End Sub

Private Sub TxtCodSuc_GotFocus()
On Error Resume Next
    
    If Trim(TxtCodSuc.text) = "" Then
        TxtCodSuc.text = 0
    End If
    
    
    
    
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtCodSuc").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Código de Sucursal - 0=No Asignada"
    Call Color_Control_Seleccionado(Me, TxtCodSuc)
    Call MarcarTexto(TxtCodSuc)
    
End Sub


Private Sub TxtCodSuc_KeyDown(KeyCode As Integer, Shift As Integer)
   
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
        
    If KeyCode = vbKeyReturn Then
        txtLista.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
        If TxtRuc.Enabled = True Then
            TxtRuc.SetFocus
        End If
    End If
    
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "ma_sucursales_clientes"
        gbolESC = True
        whereSelCamG = " nro_cli = " & val(txtCodProv.text) & " "
        frmBusquedas.Show
    End If

End Sub

Private Sub TxtCodSuc_LostFocus()
Dim R As Recordset
Dim L As Recordset
Dim CV As Recordset
Dim V As Recordset
Dim DV As Recordset
Dim llngCantidad_Contratos_Vigentes As Long

If Not gbolESC Then
    
    If Trim(TxtCodSuc.text) <> "" And Trim(txtCodProv.text) <> "" Then
        If IsNumeric(TxtCodSuc.text) And val(TxtCodSuc.text) <> 0 Then
            If Buscar_Sucursal(txtCodProv.text, TxtCodSuc.text, R) Then
                TxtNomSuc.text = Trim(R!nombre)
                Call Muestro_Direccion_Ciudad_Telefono(val(txtCodProv.text), val(TxtCodSuc.text))
            
                If Trim(sspOperacion.Caption) = "A" Then
                    If sspDatos_Contrato.visible Then
                        If Buscar_Contrato_Servicio_Vigente_x_Cliente(val(txtEmpresa.text), val(txtCodProv.text), val(TxtCodSuc.text), CDate(txtFec_Doc.text), llngCantidad_Contratos_Vigentes, CV) Then
                            If llngCantidad_Contratos_Vigentes = 1 Then
                                txtContrato.text = CV!codigo
                                txtDescripcion_Contrato.text = Trim(UCase(CV!Descripcion))
                                txtLista.text = CV!nro_lista
                                If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
                                    If Trim(UCase(L!Activo)) = "S" Then
                                        txtNombre_Lista.text = Trim(L!Descripcion)
                                        glngAnterior_Lista = val(txtLista.text)
                                    Else
                                        gbooErrorRobot = True
                                        MsgBox "Lista de la Sucursal del Cliente INACTIVA. Verifique por Favor", vbCritical + vbOKOnly
                                        TxtCodSuc.SetFocus
                                        Exit Sub
                                    End If
                                End If
                            End If
                        End If
                    End If
                    
                    If ConfPuntoVta_Vendedor_x_Defecto = 0 Then
                        If txtVendedor.text <> "" And (ConfFormato_Factura = "ALMADU" Or ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET") Then   ' SS 20161007  para cuando factura pedidos del movil
                        Else
                            If Buscar_Vendedor_x_Defecto_para_el_Facturador_Sucursal_Cliente(val(txtCodProv.text), val(TxtCodSuc.text), V) Then
                                If Buscar_Vendedor(V!nro_ven, DV) Then
                                    txtVendedor.text = DV!nro_ven
                                    If DV!Activo = "S" Then
                                        TxtNomVen.text = Trim(IIf(IsNull(DV!nom_ven), " ", DV!nom_ven) & " " & IIf(IsNull(DV!ape_ven), " ", DV!ape_ven))
                                    Else
                                        TxtNomSuc.text = ""
                                        gbolESC = True
                                        gbooErrorRobot = True
                                        Call MsgBox("Vendedor  " & txtVendedor.text & " Definido en Sucursal,  No esta Activo. Verifique por Favor", (vbExclamation + vbOKOnly))
                                        TxtCodSuc.SetFocus
                                        Exit Sub
                                    End If
                                End If
                            End If
                        End If
                    End If
                    
                End If
            
            Else
                TxtNomSuc.text = ""
                gbolESC = True
                gbooErrorRobot = True
                Call MsgBox("El código de Sucursal no Existe", (vbExclamation + vbOKOnly))
                TxtCodSuc.SetFocus
            End If
        Else
            If val(TxtCodSuc.text) <> 0 Then
                gbolESC = True
                gbooErrorRobot = True
                Call MsgBox("El código de Sucursal debe ser un Número Válido", (vbExclamation + vbOKOnly))
                TxtCodSuc.SetFocus
            Else
                TxtNomSuc.text = "Casa Central / Todas"
                If Trim(sspOperacion.Caption) = "A" Then
                    If sspDatos_Contrato.visible Then
                        If Buscar_Contrato_Servicio_Vigente_x_Cliente(val(txtEmpresa.text), val(txtCodProv.text), val(TxtCodSuc.text), CDate(txtFec_Doc.text), llngCantidad_Contratos_Vigentes, CV) Then
                            If llngCantidad_Contratos_Vigentes = 1 Then
                                txtContrato.text = CV!codigo
                                txtDescripcion_Contrato.text = Trim(UCase(CV!Descripcion))
                                txtLista.text = CV!nro_lista
                                If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
                                    If Trim(UCase(L!Activo)) = "S" Then
                                        txtNombre_Lista.text = Trim(L!Descripcion)
                                        glngAnterior_Lista = val(txtLista.text)
                                    Else
                                        gbooErrorRobot = True
                                        MsgBox "Lista de la Sucursal del Cliente INACTIVA. Verifique por Favor", vbCritical + vbOKOnly
                                        TxtCodSuc.SetFocus
                                        Exit Sub
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    Else
        gbolESC = True
        gbooErrorRobot = True
        Call MsgBox("El código de Sucursal NO puede ser Nulo", (vbExclamation + vbOKOnly))
        TxtCodSuc.SetFocus
    End If

End If
                        
'    lbolPide_Dato_Manual = False
                        
End Sub

Private Sub TxtContrato_Externo_GotFocus()

    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtContrato_Externo").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese el Código de Contrato Externo"
'    Call Color_Control_Seleccionado(Me, TxtContrato_Externo)
'    Call MarcarTexto(TxtContrato_Externo)

End Sub

Private Sub TxtContrato_Externo_KeyDown(KeyCode As Integer, Shift As Integer)
   
   gbolESC = False
    
' AIR 20160619

    If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If
        
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If
    
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtVendedor.SetFocus
        DoEvents
    End If
End Sub

Private Sub TxtContrato_Externo_LostFocus()
    If Not gbolESC Then
        If Trim(TxtContrato_Externo.text) <> "" And txtObs.text = "" Then
            txtObs.text = Trim(TxtContrato_Externo.text) & " " & txtObs.text

        End If
    End If

End Sub

Private Sub txtContrato_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Código de Contrato"
    lbDisplay.Caption = ""
    Call Color_Control_Seleccionado(Me, txtContrato)
    Call MarcarTexto(txtContrato)
End Sub

Private Sub txtContrato_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If
        
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        Call txtContrato_LostFocus
    End If
    
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "ma_Contratos_Servicios"
        gbolESC = True
        whereSelCamG = "ma_Contratos_Servicios.cod_emp = " & val(txtEmpresa.text) & " AND ma_Contratos_Servicios.nro_cli = " & val(txtCodProv.text) & " AND ma_Contratos_Servicios.nro_sucursal = " & val(TxtCodSuc.text) & " AND ma_Contratos_Servicios.estado = 'A'"
        frmBusquedas.Show
    End If
    
End Sub

Private Sub txtContrato_LostFocus()
On Error GoTo Errores
Dim R As Recordset

    
    If Not gbolESC Then
        If Trim(txtContrato.text) <> "" Then
            If IsNumeric(txtContrato.text) Then
                If Not Busco_Contrato_Servicio(val(txtEmpresa.text), val(txtContrato.text), R) Then
                    gbolESC = True
                    MsgBox "Contrato Inexistente", vbInformation, MsgTit
                    txtContrato.SetFocus
                Else
                    If R!nro_cli <> val(txtCodProv.text) And R!nro_sucursal <> val(TxtCodSuc.text) Then
                        gbolESC = True
                        MsgBox "El Contrato no esta Asignado al Cliente/Sucursal de la Factura", vbInformation, MsgTit
                        txtContrato.SetFocus
                    Else
                        If Trim(UCase(R!estado)) = "A" Then
                            If R!fecha_desde <= CDate(txtFec_Doc.text) Then
                                If Not IsNull(R!Fecha_Hasta) Then
                                    If R!Fecha_Hasta >= CDate(txtFec_Doc.text) Then
                                        If R!nro_lista = val(txtLista.text) Then
                                            txtDescripcion_Contrato.text = Trim(R!Descripcion)
                                            Call Cargar_Lineas_Servicios_Desde_Un_Contrato(val(txtEmpresa.text), val(txtContrato.text), True)
                                        Else
                                            gbolESC = True
                                            MsgBox "El Contrato Seleccionado Tiene una Lista Diferente. Verifique....", vbInformation, MsgTit
                                            txtContrato.SetFocus
                                        End If
                                    Else
                                        gbolESC = True
                                        MsgBox "El Contrato no esta Vigente para la Fecha del Documento", vbInformation, MsgTit
                                        txtContrato.SetFocus
                                    End If
                                Else
                                    txtDescripcion_Contrato.text = Trim(R!Descripcion)
                                    Call Cargar_Lineas_Servicios_Desde_Un_Contrato(val(txtEmpresa.text), val(txtContrato.text), True)
                                End If
                            Else
                                gbolESC = True
                                MsgBox "El Contrato no esta Vigente para la Fecha del Documento", vbInformation, MsgTit
                                txtContrato.SetFocus
                            End If
                        Else
                            gbolESC = True
                            MsgBox "El Contrato NO esta ACTIVO", vbInformation, MsgTit
                            txtContrato.SetFocus
                        End If
                    End If
                End If
            Else
                gbolESC = True
                MsgBox "El Código de Contrato debe ser un número válido", vbInformation, MsgTit
                txtContrato.SetFocus
            End If
        Else
            If dbgLineas_Servicios.visible Then
                 dbgLineas_Servicios.Enabled = True
                 dbgLineas_Servicios.SetFocus
                 dbgLineas_Servicios.Col = 0
             End If
        End If
        
    End If
Exit Sub

Errores:
    Resume Next

End Sub



Private Sub txtDeposito_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtDeposito").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtDeposito").solicitar_datos = "S"
    End If

End Sub

Private Sub txtDeposito_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtDeposito").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese el Depósito - <F1>Búsqueda"
    Call Color_Control_Seleccionado(Me, txtDeposito)
    Call MarcarTexto(txtDeposito)
    
End Sub

Private Sub txtDeposito_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If txtCodProv.Enabled Then
            txtCodProv.SetFocus
        End If
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
        txtCodDoc.SetFocus
    End If

    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "ma_stk_depositos"
        gbolESC = True
        whereSelCamG = ""
        frmBusquedas.Show
    End If

End Sub

Private Sub txtDeposito_LostFocus()
Dim R As Recordset

    If Not gbolESC Then
        If Trim(txtDeposito.text) <> "" Then
            txtDeposito.text = Trim(UCase(txtDeposito.text))
            If Not Busco_Stk_Deposito(Trim(txtDeposito.text), R) Then
                MsgBox "Deposito Inexistente", vbExclamation, MsgTit
                gbolESC = True
                txtDeposito.SetFocus
            End If
            R.Close
        Else
            MsgBox "El Código de Deposito No Puede Ser Nulo", vbInformation, MsgTit
            gbolESC = True
            txtDeposito.SetFocus
        End If
    End If

'    lbolPide_Dato_Manual = False

End Sub

Private Sub txtDoc_Afectado_Click()
 

    If lcolCampos.Count > 10 Then
        lcolCampos("txtDoc_Afectado").solicitar_datos = "S"
    End If

End Sub

Private Sub txtDoc_Afectado_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtDoc_Afectado").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese el Código de Documento a Afectar (<F1> - Buscar Documento  - <F1> - Buscar Tipo Documento) "
    Call Color_Control_Seleccionado(Me, txtDoc_Afectado)
    Call MarcarTexto(txtDoc_Afectado)
    
End Sub

Private Sub txtDoc_Afectado_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtNro_Doc_Afectado.SetFocus
    End If
   
    If KeyCode = vbKeyF1 Then
        frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
        frmBusqueda_Documentos.txtEmpresa = txtEmpresa.text
        frmBusqueda_Documentos.txtCliente = txtCodProv.text
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
        frmBusqueda_Documentos.pstrCampo_Que_Llama = "TXTDOC_AFECTADO"
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        End If
        whereSelCamG = "documentos.tipo_doc = 'E' AND documentos.tipo_estado_cta in ('C','N') AND documentos.mueve_merca_serv = '" & Trim(D!mueve_merca_serv) & "'"
        whereSelCamG = whereSelCamG & " AND documentos.signo = " & D!signo * -1
       
        ' JE 20220615   Controlo que muestre los tipos de Documentos Validos para el documento ingresado
        lstrDocumentos_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento(val(txtCodDoc.text))
        
        If Trim(lstrDocumentos_Validos) <> "" Then
            whereSelCamG = whereSelCamG & " AND documentos.cod_doc IN (" & Trim(lstrDocumentos_Validos) & ")"
        End If
                
        GForm = Me.Name
        GCampoBusqueda = "DOC_AFECTADO"
        GTipoBusc = "documentos"
        gbolESC = True
        Unload frmBusqueda_Documentos
        frmBusqueda_Documentos.Show vbModal
        
        DoEvents
    End If
    
    If KeyCode = vbKeyF2 Then
        GForm = Me.Name
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        End If
        
        whereSelCamG = " tipo_doc = 'E' AND tipo_estado_cta in ('C','N') AND mueve_merca_serv = '" & Trim(D!mueve_merca_serv) & "'"
        whereSelCamG = whereSelCamG & " AND signo = " & D!signo * -1
                
        ' JE 20220615   Controlo que muestre los tipos de Documentos Validos para el documento ingresado
        lstrDocumentos_Validos = Documentos_Pendientes_Validos_x_Tipo_Documento(val(txtCodDoc.text))
        
        If Trim(lstrDocumentos_Validos) <> "" Then
            whereSelCamG = whereSelCamG & " AND cod_doc IN (" & Trim(lstrDocumentos_Validos) & ")"
        End If
                
        GCampoBusqueda = "DOC_AFECTADO"
        GTipoBusc = "documentos"
        gbolESC = True
        frmBusquedas.Show vbModal   'Agrego Modal   SS 20190306
        DoEvents
    End If
    
    
    
End Sub

Private Sub txtDoc_Afectado_LostFocus()
Dim lrstDocAfectado As Recordset
Dim lrstDocIngresado As Recordset

On Error Resume Next

    If Not gbolESC Then
    
        If Trim(txtDoc_Afectado.text) <> "" Then
        
            If IsNumeric(txtDoc_Afectado.text) Then

                If Buscar_Tipo_Documento(val(txtDoc_Afectado.text), lrstDocAfectado) Then
                    If lrstDocAfectado!Activo = "N" Then
                        gbolESC = True
                        MsgBox "Documento NO esta ACTIVO. Verifique por Favor", vbExclamation + vbOKOnly, MsgTit
                        txtDoc_Afectado.SetFocus
                    Else
                        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocIngresado) Then
                            If lrstDocIngresado!signo <> lrstDocAfectado!signo * -1 Then     ' And txtCodDoc.text <> gCod_Doc_Bonificaciones_Generadas
                                gbolESC = True
                                MsgBox "Documento a Afectar Tiene el Mismo Signo que el Documento Ingresado. Verifique....", vbExclamation + vbOKOnly, MsgTit
                                txtDoc_Afectado.SetFocus
                            Else
                                If lrstDocAfectado!tipo_doc <> "E" And lrstDocAfectado!tipo_doc <> "G" Then
                                    gbolESC = True
                                    MsgBox "Documento No Cumple las Condiciones para ser Afectado. Verifique....", vbExclamation + vbOKOnly, MsgTit
                                    txtDoc_Afectado.SetFocus
                                Else
                                    If lrstDocAfectado!tipo_estado_cta <> "C" And lrstDocAfectado!tipo_estado_cta <> "N" And lrstDocAfectado!tipo_estado_cta <> "P" And lrstDocAfectado!tipo_estado_cta <> "R" Then  'Se agrega referenciar remitos    SS 20190415
                                        gbolESC = True
                                        MsgBox "Documento No Cumple las Condiciones para ser Afectado. Verifique....", vbExclamation + vbOKOnly, MsgTit
                                        txtDoc_Afectado.SetFocus
                                    Else
                                        ' JE 20220615   Se agrega el control que si el documento tiene "Documentos Validos" este en dicho conjunto
                                        If Not Validar_Documento_para_un_Tipo_Documento(val(txtCodDoc.text), val(txtDoc_Afectado.text)) Then
                                            MsgBox "Documento " & val(txtDoc_Afectado.text) & " No es Válido para este Documento. Verifique por favor...", vbInformation, MsgTit
                                            Cargar_Documento_Automaticamente = False
                                            txtDoc_Afectado.SetFocus
                                        End If
                                    End If
                                End If
                            End If
                            'AIR 20190725 se agrega control para que no se afecten documentos con cuotas los mismo deben ser afectado con un recibo ya que el Punto de Venta
                            '  no vincula la Nota de credito con en la FaccmpCuotas. Por lo tanto no queda afectada en la faccmpcuotas la factura y sigue como pendiente.
                         Else
                            gbolESC = True
                            MsgBox "Error: No se encuentra Definido el Documento Base. Verifique....", vbExclamation + vbOKOnly, MsgTit
                            txtDoc_Afectado.SetFocus
                        End If
                    End If
                Else
                    gbolESC = True
                    MsgBox "Tipo de Documento a Afectar Inexistente", vbInformation, MsgTit
                    txtDoc_Afectado.SetFocus
                End If
                rstTipos_Documentos.Close
            Else
                gbolESC = True
                MsgBox "El Código del Tipo de Documento a Afectar debe ser numérico", vbInformation, MsgTit
                txtDoc_Afectado.SetFocus
            End If
        Else
            If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocIngresado) Then
                If Trim(UCase(lrstDocIngresado!documento_afectado_obligatorio)) = "S" Then
                    gbolESC = True
                    MsgBox "El Código del Tipo de Documento a Afectar No Puede Ser Vacio", vbInformation, MsgTit
                    txtDoc_Afectado.SetFocus
                End If
            Else
                gbolESC = True
                MsgBox "El Código del Documento No existe en el Sistema. Verifique....", vbInformation, MsgTit
                txtDoc_Afectado.SetFocus
            End If
        End If
    End If

End Sub


Public Sub txtDoc_GotFocus()
On Error Resume Next
Dim lEmpresa As Long
Dim D As Recordset

    txtDoc.Locked = False
    
    'If Trim(txtCodDoc.text) = "" Then
    '     txtCodDoc.SetFocus
    'End If
    
    

    If sspOperacion.Caption = "A" Then
    
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
    
            If D!ndor_doc <> 0 Then
                If gNumerar = True Then
                    txtDoc.Locked = True
                    If ConfElegirEmpresa = True And ConfPuntoVta_Numerador_Empresa_Madre > 0 Then
                        lEmpresa = ConfPuntoVta_Numerador_Empresa_Madre
                    Else
                        lEmpresa = txtEmpresa.text
                    End If
                    
                    txtDoc.text = Tomo_Nuevo_Numero_Contador_Documentos(lEmpresa, D!ndor_doc, "D", False)
                                        
                    ' JE 20180219   /   se consulta si el campo se debe ingresar datos por configuracion para hacer foco en el
                    If lcolCampos.Count > 10 Then
                        If lcolCampos("TxtCodSuc").solicitar_datos = "S" Then
                            txtDeposito.SetFocus
                        Else
                            If txtCodProv.Enabled Then      ' SS 20160205  en lugar del SendKeys que no siempre funciona
                                txtCodProv.SetFocus
                            End If
                        End If
                    Else
                        If txtCodProv.Enabled Then      ' SS 20160205  en lugar del SendKeys que no siempre funciona
                            txtCodProv.SetFocus
                        End If
                    End If
                Else
                    txtDoc.text = ""
                    stbAyuda.Panels(1).text = "Ingrese el Nro. de Documento"
                    Call Color_Control_Seleccionado(Me, txtDoc)
                    Call MarcarTexto(txtDoc)
                End If
            Else
                If D!documento_eFactura = "C" And txtSerie_Contingencia.text <> "" And txtAutorizacion_Contingencia.text <> "" Then ' SS 20160118
                    Exit Sub
                End If
            
                txtDoc.text = ""
                stbAyuda.Panels(1).text = "Ingrese el Nro. de Documento"
                Call Color_Control_Seleccionado(Me, txtDoc)
                Call MarcarTexto(txtDoc)
            End If
        End If
    Else
        stbAyuda.Panels(1).text = "Ingrese el Nro. de Documento"
        Call Color_Control_Seleccionado(Me, txtDoc)
        Call MarcarTexto(txtDoc)
    End If


End Sub

Private Sub txtDoc_KeyDown(KeyCode As Integer, Shift As Integer)
Dim lrstDocumentos As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If Not IsNumeric(txtDoc.text) Then
            Exit Sub
        End If
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumentos) Then   ' SS 20160114
            txtSerie_Contingencia.text = ""
            txtAutorizacion_Contingencia.text = ""
            If sspOperacion.Caption = "A" Then
                If lrstDocumentos!documento_eFactura = "C" Then     'es contingencia, pide mas datos
                    gbolESC = True
                    frmPunto_Venta_Datos_Contingencia.txtNumero_Contingencia = txtDoc.text
                    frmPunto_Venta_Datos_Contingencia.Show vbModal
                    gbolESC = False
                    DoEvents
                End If
            End If
        End If
       
        ' JE 20180219   /   se consulta si el campo se debe ingresar datos por configuracion para hacer foco en el
        If lcolCampos.Count > 10 Then
            If lcolCampos("TxtCodSuc").solicitar_datos = "S" Then
                txtDeposito.SetFocus
            Else
                If txtCodProv.Enabled Then      ' SS 20160205  en lugar del SendKeys que no siempre funciona
                    txtCodProv.SetFocus
                End If
            End If
        Else
            If txtCodProv.Enabled Then      ' SS 20160205  en lugar del SendKeys que no siempre funciona
                txtCodProv.SetFocus
            End If
        End If
       
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
        txtCodDoc.SetFocus
    End If

    If KeyCode = vbKeyF1 Then
        gbolESC = True
        Busqueda = True
        frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
        frmBusqueda_Documentos.plngCod_Doc = val(txtCodDoc.text)
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
        frmBusqueda_Documentos.pstrCampo_Que_Llama = "TXTDOC"
        
        If IsFormLoaded(frmBusqueda_Documentos) Then
            Unload frmBusqueda_Documentos
        End If
        frmBusqueda_Documentos.Show vbModal
    End If

End Sub

Private Sub txtDoc_LostFocus()
On Error Resume Next
Dim R As Recordset
Dim S As Recordset
Dim L As Recordset
Dim F As Recordset
Dim B As Recordset
Dim lrstDocPend As Recordset

Dim lrstPorcentaje_TBromatologica As Recordset
Dim lrstCuenta_Madre As Recordset
Dim lrstAcopio As Recordset
Dim lCfe As efCFE
Dim lbolHay_Imagen As Boolean

Dim lstrSQL As String
Dim lrstDocumento_Afectado As Recordset

    If Not gbolESC And Trim(txtCodDoc.text) <> "" Then
        If Trim(txtDoc.text) <> "" Then
            If IsNumeric(txtDoc.text) Then

                    Select Case sspOperacion.Caption
                        
                        Case "A"
                            If Busco_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
                                gbolESC = True
                                Call MsgBox("Documento Ya Existente", (vbExclamation + vbOKOnly))
                                txtCodDoc.SetFocus
                            Else
                                txtCta_Madre.text = "0"
                                gNro_Caja = ConfPuntoVta_Nro_Caja
                                txtCaja.text = ConfPuntoVta_Nro_Caja
                                
                                ' JE20230920    /   Inicializo el Acopio en 0
                                txtAcopio.text = "0"
                                If Buscar_Acopio(val(txtAcopio.text), R) Then
                                    txtDescripcion_Acopio.text = Trim(UCase(R!Descripcion))
                                    txtCI_Persona_Autorizada.text = ""
                                End If
                                
                                Call Inicializo_Grilla_Cheques
                                'Call Cargo_Grilla_Cheques(txtEmpresa.Text, txtCodDoc.Text, txtDoc.Text)
                                Call Inicializo_Grilla_Tarjetas
                                'Call Cargo_Grilla_Tarjetas(txtEmpresa.Text, txtCodDoc.Text, txtDoc.Text)
                                Call Inicializo_Grilla_Vales
                                TxtFecReg.text = Format(date, "dd/mm/yyyy")
                                txtUsuario.text = UCase(Trim(gUsuario))
                            End If
                        
                        Case "B", "D"
                            'Efactura, no se puede anular o dar baja(intocable)
                            If esEFactura(val(txtCodDoc.text)) Then
                                gbolESC = True
                                MsgBox "Documento de Facturacion Electronica, NO Anulable. Verifique por Favor", vbExclamation + vbOKOnly
                                txtDoc.SetFocus
                                Exit Sub
                            End If
                            If Not Busco_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
                                gbolESC = True
                                MsgBox "Documento NO Existente. Verifique por Favor", vbExclamation + vbOKOnly
                                txtDoc.SetFocus
                            Else
                                If Not Valido_Permiso_de_Usuario_Sobre_el_Documento(val(txtCodDoc.text), gNro_Usuario, sspOperacion.Caption) Then
                                    gbolESC = True
                                    MsgBox "EL USUARIO ACTIVO NO TIENE PERMISOS SOBRE EL DOCUMENTO. Verifique por Favor", vbExclamation + vbOKOnly
                                    txtDoc.SetFocus
                                Else
                                    If Documento_Afectado_por_otro_Doc(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), rstCabezales_Documentos!Cod_Prov) Then
                                        gbolESC = True
                                        MsgBox "Documento Afectado por Otro. No se puede Anular", vbExclamation + vbOKOnly
                                        txtDoc.SetFocus
                                        Exit Sub
                                    Else
                                        If sspOperacion.Caption = "D" Then
                                            If rstCabezales_Documentos!Autorizado = "S" Then
                                                gbolESC = True
                                                MsgBox "DOCUMENTO YA ACTIVO", vbInformation
                                                txtDoc.SetFocus
                                                Exit Sub
                                            End If
                                        Else
                                            If rstCabezales_Documentos!Autorizado = "N" Then
                                                gbolESC = True
                                                MsgBox "DOCUMENTO YA ANULADO", vbInformation
                                                txtDoc.SetFocus
                                                Exit Sub
                                            End If
                                            
                                        End If
                                    End If
                                End If
                                
                                'AIR 20190408 se agrega control sobre tipo de documento con dinamica de F10 que no se puede modificar.
                                
                                If Documentos_Pendientes_Validos_para_Control_Cantidades_x_Tipo_Documento(val(txtCodDoc.text), lrstDocPend) Then
                                    If Docs_Pendientes_con_Documento_Relacionado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), rstCabezales_Documentos!Cod_Prov) Then
                                        gbolESC = True
                                        MsgBox "NO SE PERMITE dar de Baja el Documento, tiene facturas vinculadas... ", vbExclamation + vbOKOnly
                                        txtDoc.SetFocus
                                        Exit Sub
                                    End If
                                End If
                                                                
                                                                                                
                                txtFec_Doc.text = Format(rstCabezales_Documentos!fec_doc, "dd/mm/yyyy")
                                txtCodProv.text = rstCabezales_Documentos!Cod_Prov
                                txtNomCli.text = Trim(UCase(rstCabezales_Documentos!nom_cli))
                                
                                ' JE20230920    /   Inicializo con el Acopio ingresado en el Alta del Documento
                                If Buscar_Acopio_De_Un_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lrstAcopio) Then
                                    txtAcopio.text = lrstAcopio!cod_acopio
                                    txtCI_Persona_Autorizada.text = Trim(lrstAcopio!ci_persona_autorizada)
                                Else
                                    txtAcopio.text = "0"
                                    txtCI_Persona_Autorizada.text = ""
                                End If
                                If Buscar_Acopio(val(txtAcopio.text), R) Then
                                    txtDescripcion_Acopio.text = Trim(UCase(R!Descripcion))
                                End If
                                
                                If Buscar_Cuenta_Madre_De_Un_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lrstCuenta_Madre) Then
                                    txtCta_Madre.text = lrstCuenta_Madre!cuenta_madre
                                Else
                                    txtCta_Madre.text = "0"
                                End If
                                
                                'Para identificar el consumo final
                                If Trim(rstCabezales_Documentos!ruc) <> "" Then
                                    If Right(rstCabezales_Documentos!ruc, 1) = "X" Then
                                        TxtCFinal.text = "X"
                                        TxtRuc.text = Mid(Trim(rstCabezales_Documentos!ruc), 1, Len(Trim(rstCabezales_Documentos!ruc)) - 1)
                                    Else
                                        TxtRuc.text = rstCabezales_Documentos!ruc
                                    End If
                                Else
                                    TxtRuc.text = rstCabezales_Documentos!ruc
                                End If
                                
                                gstrDocumento_Identidad = TxtRuc.text
                                
                                Call Cargar_Datos_Cabezal_Auxiliar(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                If Trim(txtTipo_Doc_Identidad.text) = "" Then
                                    Call Cargo_Tipo_Documento_Identidad(rstCabezales_Documentos!Cod_Prov)
                                End If
                                
                                TxtCodSuc.text = rstCabezales_Documentos!cod_suc
                                
                                If Buscar_Sucursal(txtCodProv.text, TxtCodSuc.text, S) Then
                                    TxtNomSuc.text = Trim(S!nombre)
                                End If
                                
                                txtLista.text = rstCabezales_Documentos!nro_rollo
                                If Not Busco_Lista_Precio(txtLista.text, "V", L) Then
                                    MsgBox "Lista de Precios Inexistente", vbInformation, MsgTit
                                Else
                                    If Trim(UCase(L!Activo)) = "S" Then
                                        txtNombre_Lista.text = Trim(L!Descripcion)
                                        glngAnterior_Lista = val(txtLista.text)
                                    Else
                                        MsgBox "Lista de Precios INACTIVA. Verifique por Favor...", vbCritical + vbOKOnly, MsgTit
                                    End If
                                End If
                                
                                TxtTCofis.text = rstCabezales_Documentos!lleva_Cofis

                                txtFec_Vencimiento.text = Format(rstCabezales_Documentos!fec_venc, "dd/mm/yyyy")
                                txtDtoGlobal.text = Format(rstCabezales_Documentos!dto_global, "0.00")
                                
                                txtMoneda.text = rstCabezales_Documentos!moneda
                                glngAnterior_Moneda = val(txtMoneda.text)
                                
                                If Busco_Moneda(txtMoneda.text) Then
                                    txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
                                End If
                                txtTipo_Cambio.text = Format(rstCabezales_Documentos!Tipo_Cambio, "0.000")
                                txtObs.text = Trim(rstCabezales_Documentos!observa)
                                txtVendedor.text = rstCabezales_Documentos!nro_ven
                                If Buscar_Vendedor(txtVendedor.text, R) Then
                                    TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
                                End If
                                
                                If UCase(sspOperacion.Caption) = "B" Then
                                    gNro_Caja = rstCabezales_Documentos!Caja
                                    txtCaja.text = rstCabezales_Documentos!Caja
                                Else
                                    gNro_Caja = ConfPuntoVta_Nro_Caja
                                    txtCaja.text = ConfPuntoVta_Nro_Caja
                                End If
                                
                                TxtFecReg.text = Format(rstCabezales_Documentos!fec_reg, "dd/mm/yyyy")
                                txtUsuario.text = UCase(Trim(rstCabezales_Documentos!usuario))
                                If Not IsNull(rstCabezales_Documentos!Hora) Then
                                    txtFec_Transferido.text = Format(rstCabezales_Documentos!Hora, "HH:MM")
                                End If
                                
                                If esEFactura(val(txtCodDoc.text)) Then
                                    PDF.visible = True
                                    PDF.Enabled = False
                                    labDocumento_DGI.Caption = "eFactura"
                                    txtSerie_DGI.BackColor = &HFF&
                                    txtSerie_DGI.ForeColor = &HFFFF&
                                    txtNro_Fanfold.Locked = True
                                    txtNro_Fanfold.BackColor = &HFF&
                                    txtNro_Fanfold.ForeColor = &HFFFF&
                                    lCfe = obtengoCaeXDocumento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                    If lCfe.cae.serie <> "" Then
                                        txtSerie_DGI.text = Trim(lCfe.cae.serie)
                                    End If
                                    If lCfe.cae.numero <> 0 Then
                                        txtNro_Fanfold.text = lCfe.cae.numero
                                    End If
                                Else
                                    PDF.visible = False
                                    labDocumento_DGI.Caption = "Fanfold"
                                    txtSerie_DGI.BackColor = &H8000000F
                                    txtSerie_DGI.ForeColor = &H80000008
                                    txtNro_Fanfold.Locked = False
                                    txtNro_Fanfold.BackColor = &HFFFFFF
                                    txtNro_Fanfold.ForeColor = &H80000008
                                End If
                                
                                Call Cargar_Lineas_Factura(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                txtForma_Pago.text = rstCabezales_Documentos!forma_pago
                                If Busco_Forma_Pago(txtForma_Pago.text) Then
                                    txtDes_Forma_Pago.text = rstFormas_Pago!Descripcion
                                End If
                                rstFormas_Pago.Close
            
                                Call Cargo_Coleccion_Series(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
            
                                Call Cargo_Grilla_Series
                                
                                Call Cargo_Grilla_Medios_Pago(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), 0)
                                Call Cargo_Grilla_Cheques(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Grilla_Tarjetas(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Grilla_Vales(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                Call Cargo_Datos_Tasa_Bromatologica(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                Call Visualizar_Imagen_Producto(0, Imagen_Producto, "C", lbolHay_Imagen)
                                
                                If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
                                    txtImporte.text = Format(rstCabezales_Documentos!Importe, "######0.00")
                                    txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, "######0.00")
                                Else
                                    If (val(txtMoneda.text)) <> gMoneda_Base Then
                                        txtImporte.text = Format(rstCabezales_Documentos!Importe, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                                        txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                                    Else
                                        txtImporte.text = Format(rstCabezales_Documentos!Importe, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                                        txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                                    End If
                                End If
                                
                                If rstCabezales_Documentos!Autorizado = "S" Then
                                    TxtAutorizado.text = "AUTORIZADO"
                                    TxtAutorizado.ForeColor = &H80000008
                                Else
                                    TxtAutorizado.text = "SIN AUTORIZAR"
                                    TxtAutorizado.ForeColor = &HFF&
                                End If
                                
                                txtRemito.text = IIf(IsNull(rstCabezales_Documentos!cofismin), 0, rstCabezales_Documentos!cofismin)
                                txtGuia.text = IIf(IsNull(rstCabezales_Documentos!cofisexento), 0, rstCabezales_Documentos!cofisexento)
                                                                
                                Call Verifico_Documento_Cancelado

                                Call Alta_Documento_Bloqueado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
                                
                                PDF.Enabled = PDF.visible

                                If sspOperacion.Caption = "B" Then
                                    
                                    If (val(txtCodDoc.text) = ConfDoc_Ruptura Or val(txtCodDoc.text) = ConfDoc_Ruptura2) Or val(txtCodDoc.text) = ConfDoc_Ingreso_PreVenta_Cli Or _
                                        val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Presupuesto_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli_API Then
                                        If val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli And ConfFormato_Factura = "CASINO" Then
                                            lmsje = "Desea Eliminar/Anular el Pedido"
                                        Else
                                            lmsje = "Desea Eliminar el Documento"
                                        End If
                                    Else
                                        lmsje = "Desea Anular el Documento"
                                    End If
                                    
                                    If MsgBox(lmsje, (vbInformation + vbYesNo + vbDefaultButton2), MsgTit) = vbYes Then
                                        'Rupturas y Pedidos se dan de baja sin anular.
                                        If (val(txtCodDoc.text) = ConfDoc_Ruptura Or val(txtCodDoc.text) = ConfDoc_Ruptura2) Or val(txtCodDoc.text) = ConfDoc_Ingreso_PreVenta_Cli Or _
                                            val(txtCodDoc.text) = ConfDoc_Ingreso_Presupuesto_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli_API Then      ' AIR 20502725
                                            If val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli And ConfFormato_Factura = "CASINO" Then
                                                lmsje = "Desea Eliminarlo? (Si Elige No el Pedido queda ANULADO pero Mantiene la Informacion)"
                                                If MsgBox(lmsje, (vbInformation + vbYesNo + vbDefaultButton2), MsgTit) = vbYes Then
                                                    Call Eliminar_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
                                                Else
                                                    Call Anular_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), True)
                                                End If
                                            Else
                                                Call Eliminar_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
                                            End If
                                        Else
                                            Call Anular_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), True)
                                        End If
                                        Call Cargo_Logtrans("BAJA DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & Trim(txtCodProv.text))
                                        Call MBaja_Opciones_Click(0)
                                    End If
                                End If
                                
                                If sspOperacion.Caption = "D" Then
                                      MousePointer = 1
                                      sigo = MsgBox("Desea DesHacer la Anulacion del Documento?", vbYesNo + vbInformation, MsgTit)
                                      If sigo = vbYes Then
                                          
                                          Call Activar_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text)
                                          
                                          Call Cargo_Logtrans("DESHACER ANULACION DOCUMENTO " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & " " & Trim(txtCodProv.text))
                                          
                                          'AIR 20171214 No se estaba llamando a la generacion del asiento contable y quedaban documentos sin contabilizar
                                          'LLAMO A LA FUNCION DE GENERACION DEL ASIENTO. SI EL DOCUMENTO NO GENERA ASIENTO SIGUE.
                                          If Not Generar_Asiento_x_Documento("V", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, 0, True) And ConfContabilidad_Controla_Generacion_Asiento_Ventas = "TRUE" Then
                                                gbolESC = True
                                                Call MsgBox("No fue posible Generar el Asiento Contable, el Documento NO se Revierte, Verifique...", (vbExclamation + vbOKOnly))
                                                txtDoc.SetFocus
                                                Exit Sub
                                          End If
                                          
                                          MsgBox "Documento Activado", vbInformation, MsgTit
                                          gGuardando_Documento = False
                                      
                                      Else
                                          gGuardando_Documento = False
                                          cmdGuardar.Enabled = True
                                      End If
                                
                                      Call f_Transaccion(Wks, "COMMIT")
                                      Call MBaja_Opciones_Click(1)
                                
                                      MousePointer = 1
                                      lNombre_Tabla_Temporal = ""
                                
                                      Exit Sub
                                
                                End If
                                
                            End If
                            
                        Case "M", "R", "C", "U"

                            If Trim(UCase(sspOperacion.Caption)) = "C" Then
                                cmdGuardar.Enabled = False
                            End If
                            
                            If Not Busco_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
                                gbolESC = True
                                Call MsgBox("Documento NO Existente. Verifique por Favor", (vbExclamation + vbOKOnly))
                                txtDoc.SetFocus
                                Exit Sub
                            Else
                                'Efactura, no se puede modificar/autorizar (intocable)
                                If esEFactura(val(txtCodDoc.text)) And rstCabezales_Documentos!Autorizado = "S" And sspOperacion.Caption <> "R" And sspOperacion.Caption <> "C" Then
                                    gbolESC = True
                                    cmdGuardar.Enabled = False
                                    MsgBox "Documento de Facturacion Electronica, NO Modificable. Verifique por Favor", vbExclamation + vbOKOnly
                                    txtDoc.SetFocus
                                    Exit Sub
                                End If
                                
                                If Trim(UCase(sspOperacion.Caption)) = "M" Then
                                    If Documentos_Pendientes_Validos_para_Control_Cantidades_x_Tipo_Documento(val(txtCodDoc.text), lrstDocPend) Then
                                    
                                        'No se puede modificar si tiene documentos relacionados     SS 20190613
                                        If Docs_Pendientes_con_Documento_Relacionado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), rstCabezales_Documentos!Cod_Prov) Then
                                            MsgBox "NO SE PERMITE Modificar el Documento, tiene Facturas Vinculadas, debe utilizar el contra-documento para ajustar... ", vbExclamation + vbOKOnly
                                            sspOperacion.Caption = "C"
                                            cmdGuardar.Enabled = False
                                        End If
                                    End If
                                End If
                                
                                If rstCabezales_Documentos!Autorizado = "S" Then
                                    lbDisplay.Caption = ""
                                    lbDisplay.Refresh
                                Else
                                    If val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Presupuesto_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli _
                                       And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli_Web And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli_API Then  'AIR 20250725 api - Agrego doc web SS 20191119
                                        If esEFactura(val(txtCodDoc.text)) Then
                                            lbDisplay.Caption = "SIMULADO"
                                        Else
                                            lbDisplay.Caption = "ANULADO"
                                        End If
                                        lbDisplay.Refresh
                                    End If
                                End If
                                txtFec_Doc.text = Format(rstCabezales_Documentos!fec_doc, "dd/mm/yyyy")
                                txtCodProv.text = rstCabezales_Documentos!Cod_Prov
                                glngAnterior_Cliente = val(txtCodProv.text)         'SS 20200213
                                
                                txtNomCli.text = Trim(UCase(rstCabezales_Documentos!nom_cli))
                                
                                ' JE20230920    /   Inicializo con el Acopio ingresado en el Alta del Documento
                                If Buscar_Acopio_De_Un_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lrstAcopio) Then
                                    txtAcopio.text = lrstAcopio!cod_acopio
                                    txtCI_Persona_Autorizada.text = Trim(lrstAcopio!ci_persona_autorizada)
                                Else
                                    txtAcopio.text = "0"
                                    txtCI_Persona_Autorizada.text = ""
                                End If
                                If Buscar_Acopio(val(txtAcopio.text), R) Then
                                    txtDescripcion_Acopio.text = Trim(UCase(R!Descripcion))
                                End If
                                
                                If Buscar_Cuenta_Madre_De_Un_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, lrstCuenta_Madre) Then
                                    txtCta_Madre.text = lrstCuenta_Madre!cuenta_madre
                                Else
                                    txtCta_Madre.text = "0"
                                End If
                                
                                'Para identificar el consumo final
                                If Trim(rstCabezales_Documentos!ruc) <> "" Then
                                    If Right(rstCabezales_Documentos!ruc, 1) = "X" Then
                                        TxtCFinal.text = "X"
                                        TxtRuc.text = Mid(Trim(rstCabezales_Documentos!ruc), 1, Len(Trim(rstCabezales_Documentos!ruc)) - 1)
                                    Else
                                        TxtRuc.text = rstCabezales_Documentos!ruc
                                    End If
                                Else
                                    TxtRuc.text = rstCabezales_Documentos!ruc
                                End If
                                
                                gstrDocumento_Identidad = TxtRuc.text
                                
                                Call Cargar_Datos_Cabezal_Auxiliar(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                If Trim(txtTipo_Doc_Identidad.text) = "" Then
                                    Call Cargo_Tipo_Documento_Identidad(rstCabezales_Documentos!Cod_Prov)
                                End If
                                
                                TxtCodSuc.text = rstCabezales_Documentos!cod_suc
                                If Buscar_Sucursal(txtCodProv.text, TxtCodSuc.text, S) Then
                                    TxtNomSuc.text = Trim(S!nombre)
                                End If
                                
                                txtLista.text = rstCabezales_Documentos!nro_rollo
                                If Not Busco_Lista_Precio(txtLista.text, "V", L) Then
                                    MsgBox "Lista de Precios Inexistente", vbInformation, MsgTit
                                Else
                                    If Trim(UCase(L!Activo)) = "S" Then
                                        txtNombre_Lista.text = Trim(L!Descripcion)
                                        glngAnterior_Lista = val(txtLista.text)
                                    Else
                                        MsgBox "Lista de Precios INACTIVA. Verifique por Favor...", vbCritical + vbOKOnly, MsgTit
                                    End If
                                End If
                                
                                
                                TxtTCofis.text = rstCabezales_Documentos!lleva_Cofis
                                txtFec_Vencimiento.text = Format(rstCabezales_Documentos!fec_venc, "dd/mm/yyyy")
                                txtDtoGlobal.text = Format(rstCabezales_Documentos!dto_global, "0.00")
                                                                
                                txtMoneda.text = rstCabezales_Documentos!moneda
                                glngAnterior_Moneda = val(txtMoneda.text)
                                
                                If Busco_Moneda(txtMoneda.text) Then
                                    txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
                                    txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
                                    TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
                                End If
                                txtTipo_Cambio.text = Format(rstCabezales_Documentos!Tipo_Cambio, "0.000")
                                txtObs.text = Trim(rstCabezales_Documentos!observa)
                                txtVendedor.text = rstCabezales_Documentos!nro_ven
                                If Buscar_Vendedor(txtVendedor.text, R) Then
                                    TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
                                End If
                                
                                If UCase(sspOperacion.Caption) = "M" Or UCase(sspOperacion.Caption) = "C" Then
                                    gNro_Caja = rstCabezales_Documentos!Caja
                                    txtCaja.text = rstCabezales_Documentos!Caja
                                Else
                                    gNro_Caja = ConfPuntoVta_Nro_Caja
                                    txtCaja.text = ConfPuntoVta_Nro_Caja
                                End If
                                
                                TxtFecReg.text = Format(rstCabezales_Documentos!fec_reg, "dd/mm/yyyy")
                                txtUsuario.text = UCase(Trim(rstCabezales_Documentos!usuario))
                                If Not IsNull(rstCabezales_Documentos!Hora) Then
                                    txtFec_Transferido.text = Format(rstCabezales_Documentos!Hora, "HH:MM")
                                End If
                                
                                If esEFactura(val(txtCodDoc.text)) Then
                                    PDF.visible = True
                                    PDF.Enabled = False
                                    DoEvents
                                    labDocumento_DGI.Caption = "eFactura"
                                    txtSerie_DGI.BackColor = &HFF&
                                    txtSerie_DGI.ForeColor = &HFFFF&
                                    txtNro_Fanfold.Locked = True
                                    txtNro_Fanfold.BackColor = &HFF&
                                    txtNro_Fanfold.ForeColor = &HFFFF&
                                    lCfe = obtengoCaeXDocumento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                    If lCfe.cae.serie <> "" Then
                                        txtSerie_DGI.text = Trim(lCfe.cae.serie)
                                    End If
                                    If lCfe.cae.numero <> 0 Then
                                        txtNro_Fanfold.text = lCfe.cae.numero
                                    End If
                                    
                                    If Trim(UCase(rstCabezales_Documentos!Autorizado)) = "S" Then
                                        lbDisplay = obtengoEstadoCFE(val(txtEmpresa.text), lCfe.cae.idInterno)
                                    End If
                                    
                                Else
                                    PDF.visible = False
                                    labDocumento_DGI.Caption = "Fanfold"
                                    txtSerie_DGI.BackColor = &H8000000F
                                    txtSerie_DGI.ForeColor = &H80000008
                                    txtNro_Fanfold.Locked = False
                                    txtNro_Fanfold.BackColor = &HFFFFFF
                                    txtNro_Fanfold.ForeColor = &H80000008
                                End If
                               
                              
                                Call Cargar_Lineas_Factura(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                txtForma_Pago.text = rstCabezales_Documentos!forma_pago
                                If Busco_Forma_Pago(txtForma_Pago.text) Then
                                    txtDes_Forma_Pago.text = rstFormas_Pago!Descripcion
                                End If
                                rstFormas_Pago.Close
                                
                                Call Cargo_Coleccion_Series(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
            
                                Call Cargo_Grilla_Series
                                
                                Call Cargo_Grilla_Medios_Pago(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), 0)
                                Call Cargo_Grilla_Cheques(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Grilla_Tarjetas(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Grilla_Vales(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Datos_Tasa_Bromatologica(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                Call Cargo_Datos_EFactura_Exportacion_Otros(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
                                
                                Call Visualizar_Imagen_Producto(0, Imagen_Producto, "C", lbolHay_Imagen)
                                
                                If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
                                    txtImporte.text = Format(rstCabezales_Documentos!Importe, "######0.00")
                                    txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, "######0.00")
                                Else
                                    If val(txtMoneda.text) <> gMoneda_Base Then
                                        txtImporte.text = Format(rstCabezales_Documentos!Importe, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                                        txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                                    Else
                                        txtImporte.text = Format(rstCabezales_Documentos!Importe, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                                        txtRedondeo.text = Format(rstCabezales_Documentos!redondeo, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                                    End If
                                End If
                                
                                If rstCabezales_Documentos!Autorizado = "S" Then
                                    TxtAutorizado.text = "AUTORIZADO"
                                    TxtAutorizado.ForeColor = &H80000008
                                Else
                                    TxtAutorizado.text = "SIN AUTORIZAR"
                                    TxtAutorizado.ForeColor = &HFF&
                                End If
                                
                                txtRemito.text = IIf(IsNull(rstCabezales_Documentos!cofismin), 0, rstCabezales_Documentos!cofismin)
                                txtGuia.text = IIf(IsNull(rstCabezales_Documentos!cofisexento), 0, rstCabezales_Documentos!cofisexento)
                                
                                Call Verifico_Documento_Cancelado
                                
                                Call Alta_Documento_Bloqueado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
                                
                                If Not esEFactura(val(txtCodDoc.text)) Then
                                    If Busco_Numero_Fanfold_X_Doc(rstCabezales_Documentos!Cod_Emp, rstCabezales_Documentos!cod_doc, rstCabezales_Documentos!nro_doc, F) = True And sspOperacion.Caption = "C" Then
                                        txtNro_Fanfold.text = F!nro_fanfold
                                    End If
                                End If
                                                    
                                PDF.Enabled = PDF.visible
                            
                            End If
                    
                    End Select
            Else
                gbolESC = True
                MsgBox "El Número de Documento no es Numerico", vbInformation, MsgTit
                txtDoc.SetFocus
            End If
        Else
            gbolESC = True
            MsgBox "El Número de Documento No Puede Ser Nulo", vbInformation, MsgTit
            txtDoc.SetFocus
        End If
    End If
    
End Sub

Private Sub txtDoc_Remito_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtDoc_Remito").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtDoc_Remito").solicitar_datos = "S"
    End If

End Sub

Private Sub txtDoc_Remito_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Código del Documento PreVenta/Pedido/Remito"
    Call Color_Control_Seleccionado(Me, txtDoc_Remito)
    Call MarcarTexto(txtDoc_Remito)

    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtDoc_Remito").solicitar_datos = "N" Then
            Sendkeys "{ENTER}"
        End If
    End If

End Sub

Private Sub txtDoc_Remito_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtRemito.SetFocus
    End If
   
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        
        whereSelCamG = " cod_doc IN (" & ConfDoc_Ingreso_Pedido_Cli & "," & ConfDoc_Ingreso_PreVenta_Cli & "," & ConfDoc_Ingreso_Remito_Cli & "," & ConfDoc_Ingreso_Pedido_Cli_API & ")"    ' AIR 20250725
                
        GCampoBusqueda = "DOC_REMITO"
        GTipoBusc = "documentos"
        gbolESC = True
        frmBusquedas.Show
        DoEvents
    End If
    
End Sub

Private Sub txtDoc_Remito_LostFocus()
Dim D As Recordset
Dim R As Recordset

On Error Resume Next

    If Not gbolESC Then
    
        If Trim(txtDoc_Remito.text) <> "" Then
        
            If IsNumeric(txtDoc_Remito.text) Then

                If Buscar_Tipo_Documento(val(txtDoc_Remito.text), D) Then
                    If D!Activo = "N" Then
                        gbolESC = True
                        MsgBox "Documento NO esta ACTIVO. Verifique por Favor", vbExclamation + vbOKOnly, MsgTit
                        txtDoc_Remito.SetFocus
                    Else
                        If val(txtDoc_Remito.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtDoc_Remito.text) <> ConfDoc_Ingreso_PreVenta_Cli And val(txtDoc_Remito.text) <> ConfDoc_Ingreso_Remito_Cli And val(txtDoc_Remito.text) <> ConfDoc_Ingreso_Pedido_Cli_API Then  ' AIR 20250725
                            gbolESC = True
                            MsgBox "Documento No Cumple las Condiciones para ser Afectado. Verifique....", vbExclamation + vbOKOnly, MsgTit
                            txtDoc_Remito.SetFocus
                        End If
                    End If
                Else
                    gbolESC = True
                    MsgBox "Tipo de Documento a Afectar Inexistente", vbInformation, MsgTit
                    txtDoc_Remito.SetFocus
                End If
                rstTipos_Documentos.Close
            Else
                gbolESC = True
                MsgBox "El Código del Tipo de Documento a Afectar debe ser numérico", vbInformation, MsgTit
                txtDoc_Remito.SetFocus
            End If
        End If
    End If

End Sub


Private Sub txtDtoGlobal_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtDtoGlobal").solicitar_datos = "S"
    End If

End Sub

Private Sub txtDtoGlobal_GotFocus()
    
    If Trim(txtDtoGlobal.text) = "" Then
        txtDtoGlobal.text = "0.00"
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtDtoGlobal").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Descuento Global"
    Call Color_Control_Seleccionado(Me, txtDtoGlobal)
    Call MarcarTexto(txtDtoGlobal)
    
     ValorInicialDtoGlobal = txtDtoGlobal.text
    
       
End Sub

Private Sub txtDtoGlobal_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtTipo_Cambio.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then               ' SS 20151006
            'AIR 20170602 cambio la condicion porque si No esta locked pero esta Enable=False explota.
            'If Not txtDoc_Afectado.Locked Then
            'If txtDoc_Afectado.Enabled Then
                'txtDoc_Afectado.SetFocus
            
            ' AIR 20171123
            If lbolUtilizo_Configuracion_Campos Then
                If TxtNroIdCompra.Enabled And TxtNroIdCompra.visible Then  ' AIR 20171123
                    TxtNroIdCompra.SetFocus
                Else
                    If txtDoc_Afectado.Enabled Then
                        txtDoc_Afectado.SetFocus
                    Else
                        If txtAcopio.visible Then
                            txtAcopio.SetFocus
                        Else
                            txtObs.SetFocus
                        End If
                    End If
                End If

            Else
                If txtDoc_Afectado.Enabled Then
                    txtDoc_Afectado.SetFocus
                Else
                    If txtAcopio.visible Then
                        txtAcopio.SetFocus
                    Else
                        txtObs.SetFocus
                    End If
                    DoEvents
                End If
           
            End If
        'End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtDtoGlobal").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(4, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtDtoGlobal.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtDtoGlobal.Locked = False
            End If
        End If
    End If

End Sub


Private Sub txtDtoGlobal_LostFocus()
Dim i As Long
Dim Aceptado As Boolean


    If Not gbolESC Then
        If Trim(txtDtoGlobal.text) <> "" Then
            If IsNumeric(txtDtoGlobal.text) Then
                If Trim(UCase(confSistemaControlDtos)) = Trim(UCase(SistemaControlDtos_Cifer)) Then
                    If ControlDescuentosGeneral("txtDtoGlobal") Then
                        Call Inicializo_Campos_para_Autorizar
                    Else
                        gbolESC = True
                        txtDtoGlobal.text = Format(0, "##0.00")
                        txtDtoGlobal.SetFocus
                    End If
                Else
                    If Controlo_Descuento_Global(True, 0) Then
                        txtDtoGlobal.text = Format(txtDtoGlobal.text, "##0.00")
                    
                        Call Inicializo_Campos_para_Autorizar
                    
                        ' Recalculo las Lineas de la Factura
                        For i = 1 To vsfLineas_Mercaderia.Rows - 1
                            Call Calcular_Importes_de_la_Linea_Mercaderia(i, False, True)
                        Next i
                    Else
                        gbolESC = True
                        txtDtoGlobal.text = Format(0, "##0.00")
                        txtDtoGlobal.SetFocus
                    End If
                End If
                
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Descuento Global debe ser un número válido", vbInformation, MsgTit
                txtDtoGlobal.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Descuento Global No Puede Ser Nulo", vbInformation, MsgTit
            txtDtoGlobal.SetFocus
        End If
    End If
End Sub

Private Sub txtEmpresa_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Código de Empresa"
    Call Color_Control_Seleccionado(Me, txtEmpresa)
    Call MarcarTexto(txtEmpresa)
End Sub

 Sub txtEmpresa_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                gbooErrorRobot = True
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "empresas"
        gbolESC = True
        whereSelCamG = ""
        frmBusquedas.Show
    End If
    
    If KeyCode = vbKeyReturn Then
        txtFec_Doc.SetFocus
    End If
    
End Sub

Private Sub txtEmpresa_LostFocus()

    If Not gbolESC Then
        If Trim(txtEmpresa.text) <> "" Then
            If IsNumeric(txtEmpresa.text) Then
                If Busco_Empresa(val(txtEmpresa.text)) Then
                    txtNom_Empresa.text = rstEmpresas!Descripcion
                    gMoneda_Base = rstEmpresas!moneda
                    If Inicializar_Valores_x_Campos_Programa_Empresa(val(txtEmpresa.text), plngCod_Programa, 0, lcolCampos) Then
                    End If
                Else
                    gbolESC = True
                    MsgBox "Empresa Inexistente", vbInformation, MsgTit
                    gbooErrorRobot = True
                    txtEmpresa.SetFocus
                End If
                rstEmpresas.Close
            Else
                gbolESC = True
                MsgBox "El código de la Empresa es numerico", vbInformation, MsgTit
                gbooErrorRobot = True
                txtEmpresa.SetFocus
            End If
        Else
            gbolESC = True
            MsgBox "El Código de Empresa puede ser Nulo", vbInformation, MsgTit
            gbooErrorRobot = True
            txtEmpresa.SetFocus
        End If
    End If
    
End Sub

Private Sub TxtFactor_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("TxtFactor").solicitar_datos = "S"
    End If

End Sub

Private Sub TxtFactor_GotFocus()
    
    'AIR 20211227 PuntoVta_Calcula_Cajas_x_Packing ya viene cargado el factor desde Proceso_Codigo ejecutado en txtLector.txt
    If ConfPuntoVta_Calcula_Cajas_x_Packing And ConfPuntoVta_Ver_Columna_Cajas And Trim(txtCajas.text) <> "" Then
    Else
        TxtFactor.text = ""
    End If
    If Trim(gstrUnidades_x_Defecto) <> "" And ConfPuntoVta_Calcula_Cajas_x_Packing = False Then
        TxtFactor.text = val(gstrUnidades_x_Defecto)
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtFactor").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese las Unidades de Venta  -  <F3> Copiar Lineas desde Otro Documento"
    Call Color_Control_Seleccionado(Me, TxtFactor)
    Call MarcarTexto(TxtFactor)
    'AIR 20231106 perdia el foco al volver de la grilla en el caso q se va a poner dsctos en al linea
    TxtFactor.SetFocus

End Sub


Private Sub TxtFactor_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        If TxtTCofis.visible Then
            TxtTCofis.SetFocus
        Else
            'AIR 20211228 se agrega que considere el caso de la variable de configuracion para ver donde hacer el foco
            If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                TxtLector.SetFocus
            Else
                If txtPais.visible Then
                    txtPais.SetFocus
                Else
                      txtVendedor.SetFocus
                End If
            End If
        End If
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                gbooErrorRobot = True
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                gbooErrorRobot = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If Trim(TxtFactor.text) = "" Then
            sigo = MsgBox("Desea Finalizar el Documento", vbYesNo + vbExclamation, MsgTit)
            If sigo = vbYes Then
            
                lbDisplay.Caption = ""
                fraDescuento_x_Volumen.visible = False
                fraEquivalencias_Stock.visible = False
                
                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                
                    Select Case ConfFormato_Factura
                        Case "LCP-LACAMPANA"
                            If D!tipo_estado_cta <> "C" Then
                                txtForma_Pago.text = 0
                            End If
                        Case "DIBERACO"
                            If D!tipo_estado_cta <> "C" Then
                                txtForma_Pago.text = 0
                            End If
                        Case "LORIANO"
                            If D!tipo_estado_cta <> "C" Then
                                txtForma_Pago.text = 0
                            End If
                    End Select
                    
                    If ConfPuntoVta_Enviar_Articulo_Agrupado_EFactura And sspOperacion.Caption = "A" Then
                        'AIR 20201016 reordeno la grilla
                        If vsfLineas_Mercaderia.Rows - 1 > 1 Then
                            ' sort by name
                            vsfLineas_Mercaderia_AfterMoveColumn 0, 0
                            
                        End If
                    End If
                    
                    sstDetalle_Pagos.Tab = 0
                    txtForma_Pago.SetFocus
                Else
                    gbooErrorRobot = True
                    MsgBox "Código de Documento No Existe en el Sistema. Verifique por favor...", vbInformation, MsgTit
                    TxtFactor.SetFocus
                End If
            End If
        Else
            'AIR 20211227 PuntoVta_Calcula_Cajas_x_Packing paso a pedir caja nuevamente
            If ConfPuntoVta_Calcula_Cajas_x_Packing And ConfPuntoVta_Ver_Columna_Cajas Then
                txtCajas.SetFocus
            Else
                TxtLector.SetFocus
            End If
        End If
    End If
    
    If KeyCode = vbKeyF3 Then
        gbolESC = True
        Busqueda = True
        frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
        frmBusqueda_Documentos.plngCod_Doc = val(txtCodDoc.text)
        frmBusqueda_Documentos.plngCod_Cliente = val(txtCodProv.text)
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
        frmBusqueda_Documentos.pstrCampo_Que_Llama = "TXTFACTOR"
        txtCajas.text = ""
        
        
        If IsFormLoaded(frmBusqueda_Documentos) Then
            Unload frmBusqueda_Documentos
        End If
        frmBusqueda_Documentos.Show vbModal     'Cambio a Modal, para que funcione el F3   SS 20190306
                                                'AIR 20181213 comentado porque al ser llamado como modal, luego dentro de ese formulario al hacer F1 para llamar a otro form que es modal da error
        DoEvents
        If Trim(frmBusqueda_Documentos.pstrFiltros) <> "" Then
            Call Cargar_Desde_Otro_Documento_Mercaderia(frmBusqueda_Documentos.pstrFiltros)
            frmBusqueda_Documentos.pstrFiltros = ""
        End If
        frmBusqueda_Documentos.pstrTipo_Busqueda = ""
        frmBusqueda_Documentos.plngCod_Doc = 0
        frmBusqueda_Documentos.plngCod_Cliente = 0
        frmBusqueda_Documentos.pstrFormulario_Que_Llama = ""
        frmBusqueda_Documentos.pstrCampo_Que_Llama = ""
        
    End If
    
    If KeyCode = vbKeyDown Then
'        vsfLineas_Mercaderia.Row = vsfLineas_Mercaderia.Rows - 1
        ' JE 20180725   /   Me posiciono en la Primer Fila
        If vsfLineas_Mercaderia.Rows > 1 Then
            vsfLineas_Mercaderia.SetFocus
            vsfLineas_Mercaderia.Col = CGL_UNIDADES
            vsfLineas_Mercaderia.Row = 1
        End If
    End If

End Sub

Private Sub TxtFactor_KeyPress(KeyAscii As Integer)
   char = Chr(KeyAscii)
   KeyAscii = Asc(UCase(char))
End Sub

Private Sub TxtFactor_LostFocus()
Dim D As Recordset
Dim pcancelar As Boolean

    If Not gbolESC Then
        If Trim(TxtFactor.text) <> "" Then
            If Not IsNumeric(TxtFactor.text) Then
                MsgBox "El Factor de Multiplicación debe ser un Numero Válido", vbInformation, MsgTit
                TxtFactor.SetFocus
                Exit Sub
            Else
                If Not ConfPuntoVta_Permite_Unidades_Fraccionadas And Trim(TxtFactor.text) <> Format(Trim(TxtFactor.text), "0") Then
                    MsgBox "Las Unidades de Venta deben ser un Número ENTERO", vbInformation, MsgTit
                    TxtFactor.SetFocus
                    Exit Sub
                Else
                
                    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                        Exit Sub
                    End If
                    
                    If ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET" Then    'Si esta fraccionado, la fraccion tiene que ser < 1     SS 20170320
                        If Trim(TxtFactor.text) <> Format(Trim(TxtFactor.text), "0") And CDbl(Trim(TxtFactor.text)) > 1 Then
                            MsgBox "ATENCION: Unidades Facionadas => Ingrese por Separado las Unidades Completas (" & Int(CDbl(TxtFactor.text)) & "), de la Unidad Fraccionada (0.5)", vbInformation, MsgTit
                            TxtFactor.SetFocus
                            Exit Sub
                        Else
                            If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                                If Proceso_Codigo(TxtLector.text, ConfPuntoVta_Descuento_1_x_Defecto, ConfPuntoVta_Descuento_2_x_Defecto, ConfPuntoVta_Descuento_3_x_Defecto, 0, D!tipo_entrega_mercaderia_x_defecto, txtDeposito.text, False, "TXTFACTOR", True, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                                    TxtFactor.text = ""
                                End If
                            End If
                        End If
                    Else
                        If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                            If Proceso_Codigo(TxtLector.text, ConfPuntoVta_Descuento_1_x_Defecto, ConfPuntoVta_Descuento_2_x_Defecto, ConfPuntoVta_Descuento_3_x_Defecto, 0, D!tipo_entrega_mercaderia_x_defecto, txtDeposito.text, False, "TXTFACTOR", True, 0, 0, 0, 0, 0, 0, 0, 0, 0, pcancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                                'AIR 20211227 PuntoVta_Calcula_Cajas_x_Packing paso a pedir caja nuevamente
                                If ConfPuntoVta_Calcula_Cajas_x_Packing And ConfPuntoVta_Ver_Columna_Cajas Then
                                    txtCajas.text = ""
                                    TxtFactor.text = ""
                                Else
                                    TxtFactor.text = ""
                                End If
                            End If
                        End If
                    End If
                End If
                
                'AIR 20231103 sino se ingreso codigo no se pasa a la grilla
                If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia And Trim(TxtLector.text) <> "" Then
                    vsfLineas_Mercaderia.SetFocus
                    vsfLineas_Mercaderia.Select vsfLineas_Mercaderia.Row, CGL_DTO1
                End If
            
                If lcolCampos.Count > 10 Then
                    lcolCampos("TxtFactor").solicitar_datos = lcolCampos("TxtFactor").solicitar_datos_definicion_original
                End If
            
            End If
        End If
    End If

End Sub

Private Sub txtFec_Doc_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese la Fecha del Documento"
    Call Color_Control_Seleccionado(Me, txtFec_Doc)
    Call MarcarTexto(txtFec_Doc)
End Sub

Private Sub txtFec_Doc_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        Call ArmoFecha(txtFec_Doc, txtFec_Doc)
        DoEvents
        If Not IsDate(txtFec_Doc.text) Then
            txtFec_Doc.SetFocus
        Else
            txtCodDoc.SetFocus
        End If
    End If
    
    If KeyCode = vbKeyUp Then
        txtEmpresa.SetFocus
    End If
    
    If KeyCode = vbKeyF4 Then
        If txtFec_Doc.Locked Then
            If lcolCampos.Count > 10 Then
                If lcolCampos("txtFec_Doc").pide_autorizacion = "S" Then
                    If Autorizacion_Supervision(25, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                        txtFec_Doc.Locked = False
                    End If
                'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
                'intervenir al supervisor
                Else
                    txtFec_Doc.Locked = False
                End If
            Else
                If Autorizacion_Supervision(25, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtFec_Doc.Locked = False
                End If
            End If
        End If
    End If
    
End Sub

Private Sub txtFec_Doc_LostFocus()

    If Not gbolESC Then
        If Trim(txtFec_Doc.text) <> "" Then
            If Not IsDate(txtFec_Doc.text) Then
                gbolESC = True
                MsgBox "La Fecha no es Correcta", vbInformation, MsgTit
                gbooErrorRobot = True
                txtFec_Doc.SetFocus
            Else
                txtFec_Doc.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "La Fecha No Puede Ser Nula", vbInformation, MsgTit
            txtFec_Doc.SetFocus
        End If
    End If
End Sub

Private Sub txtFec_Vencimiento_GotFocus()
Dim D As Recordset
    
    stbAyuda.Panels(1).text = "Ingrese la Fecha de Vencimiento del Documento"
    Call Color_Control_Seleccionado(Me, txtFec_Vencimiento)
    Call MarcarTexto(txtFec_Vencimiento)

    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtFec_Vencimiento").solicitar_datos = "N" Then
            Sendkeys "{ENTER}"
        Else
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then   'SS 20200121
                If Trim(D!permite_cambiar_forma_pago) = "N" Then
                    Sendkeys "{ENTER}"
                End If
            End If
        End If
    End If

End Sub

Private Sub txtFec_Vencimiento_KeyDown(KeyCode As Integer, Shift As Integer)
    
    If KeyCode = vbKeyUp Then
        sstDetalle_Pagos.Tab = 0
        txtForma_Pago.SetFocus
    End If
    
    If KeyCode = vbKeyReturn Then
        Call ArmoFecha(txtFec_Vencimiento, txtFec_Vencimiento)
        If Not IsDate(txtFec_Vencimiento.text) Then
            txtFec_Vencimiento.SetFocus
        Else
        
            If CDate(txtFec_Vencimiento.text) < CDate(txtFec_Doc.text) Then
                MsgBox "Fecha de Vencimiento Menor a la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
                gbolESC = True
                txtFec_Vencimiento.SetFocus
                Exit Sub
            End If
            
           ' If CDate(txtFec_Vencimiento.text) >= DateAdd("yyyy", 1, CDate(txtFec_Doc.text)) Then
           '     MsgBox "Fecha de Vencimiento Mayor a un Año de la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
            'AIR se cambia y agrega variable de cofiguracion para el control de la cantidad maxima de meses para el vencimiento de la factura
            If CDate(txtFec_Vencimiento.text) > DateAdd("m", ConfPuntoVta_Tope_Max_Meses_Vencimiento_Factura, CDate(txtFec_Doc.text)) Then
                MsgBox "Fecha de Vencimiento Mayor a " & ConfPuntoVta_Tope_Max_Meses_Vencimiento_Factura & " meses de la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
                
                gbolESC = True
                txtFec_Vencimiento.SetFocus
                Exit Sub
            End If
            
            If vsfMedios_Pagos.Rows = 1 Then
                MsgBox "No Completo la Secuencia con ENTER Desde el Cliente y Faltan los Medios de Pago", vbExclamation, MsgTit
                gbolESC = True
                txtFec_Vencimiento.SetFocus
                Exit Sub
            End If

            vsfMedios_Pagos.SetFocus
            
            Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
                Case "DESCRIPCION"
                    vsfMedios_Pagos.Col = CGMP_DESCRIPCION
                Case Else
                    vsfMedios_Pagos.Col = CGMP_IMPORTE
            End Select
            
            vsfMedios_Pagos.Row = 1
        End If
    End If

    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    'ATU 20170505 se incorpora manejo de autorizacion
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtFec_Vencimiento").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(29, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtFec_Vencimiento.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtFec_Vencimiento.Locked = False
            End If
        End If
    End If

End Sub

Private Sub txtForma_Pago_GotFocus()
Dim D As Recordset
     
    If Trim(txtForma_Pago.text) = "" Then
        txtForma_Pago.text = 1
    End If
    
    stbAyuda.Panels(1).text = "Ingrese la Forma de Pago"
    lForma_Pago_Anterior = val(txtForma_Pago.text)
    Call Color_Control_Seleccionado(Me, txtForma_Pago)
    Call MarcarTexto(txtForma_Pago)

    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtForma_Pago").solicitar_datos = "N" Then
            Sendkeys "{ENTER}"
        Else
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then   'SS 20200121
                If Trim(D!permite_cambiar_forma_pago) = "N" Then
                    Sendkeys "{ENTER}"
                End If
            End If
        End If
    End If
    
End Sub

Private Sub txtForma_Pago_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtFec_Vencimiento.SetFocus
    End If
    
    If KeyCode = vbKeyUp Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If Trim(D!mueve_merca_serv) = "M" Then
                TxtLector.SetFocus
            Else
                dbgLineas_Servicios.SetFocus
                dbgLineas_Servicios.MoveFirst
                dbgLineas_Servicios.Col = 0
            End If
        End If
    End If
    
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "formas_pago"
        gbolESC = True
        whereSelCamG = ""
        frmBusquedas.Show
    End If
    
    'ATU 20170505 se incorpora manejo de autorizacion
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtForma_Pago").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(28, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtForma_Pago.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtForma_Pago.Locked = False
            End If
        End If
    End If

End Sub

Private Sub txtForma_Pago_LostFocus()
Dim FP As Recordset

    If Not gbolESC Then
        If Trim(txtForma_Pago.text) <> "" Then
            If IsNumeric(txtForma_Pago.text) Then
                If Buscar_Forma_Pago(val(txtForma_Pago.text), FP) Then
                    txtDes_Forma_Pago.text = FP!Descripcion
                    
                    If Trim(UCase(sspOperacion.Caption)) = "A" Then
                        If IsNumeric(FP!dias_a_sumar) Then
                            txtFec_Vencimiento.text = Calculo_Vencimiento_Forma_Pago_Cliente(val(txtForma_Pago.text), CDate(txtFec_Doc.text))
                            txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                        Else
                            txtFec_Vencimiento.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
                        End If
                    Else
                        If Trim(txtFec_Vencimiento.text) = "" Then
                            If IsNumeric(FP!dias_a_sumar) Then
                                txtFec_Vencimiento.text = Calculo_Vencimiento_Forma_Pago_Cliente(val(txtForma_Pago.text), CDate(txtFec_Doc.text))
                                txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                            Else
                                txtFec_Vencimiento.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
                            End If
                        Else
                            If Trim(lForma_Pago_Anterior) <> Trim(txtForma_Pago.text) Then
                                If IsNumeric(FP!dias_a_sumar) Then
                                    txtFec_Vencimiento.text = Calculo_Vencimiento_Forma_Pago_Cliente(val(txtForma_Pago.text), CDate(txtFec_Doc.text))
                                    txtFec_Vencimiento.text = Format(txtFec_Vencimiento.text, "dd/mm/yyyy")
                                Else
                                    txtFec_Vencimiento.text = Format(txtFec_Doc.text, "dd/mm/yyyy")
                                End If
                            End If
                        End If
                    End If
                Else
                    gbolESC = True
                    MsgBox "Forma de Pago Inexistente", vbInformation, MsgTit
                    txtForma_Pago.SetFocus
                End If
            Else
                gbolESC = True
                MsgBox "El código de la Forma de Pago es numérico", vbInformation, MsgTit
                txtForma_Pago.SetFocus
            End If
        Else
            gbolESC = True
            MsgBox "El código de la Forma de Pago No Puede Ser Nulo", vbInformation, MsgTit
            txtForma_Pago.SetFocus
        End If
    End If

End Sub

Private Sub TxtGuia_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("TxtGuia").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("TxtGuia").solicitar_datos = "S"
    End If

End Sub

Private Sub txtGuia_GotFocus()
            
    If Trim(txtGuia.text) = "" Then
        txtGuia.text = "0"
    End If

    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtGuia").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If

    stbAyuda.Panels(1).text = "Ingrese la Guía del Documento"
    Call Color_Control_Seleccionado(Me, txtGuia)
    Call MarcarTexto(txtGuia)

End Sub


Private Sub txtGuia_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    
    If KeyCode = vbKeyReturn Then
    
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        End If
        
        If Trim(D!mueve_merca_serv) = "M" Then
    
            If txtCajas.visible Then
                txtCajas.SetFocus
                DoEvents
            Else

                If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                    TxtLector.SetFocus
                Else
                    TxtFactor.SetFocus
                End If
                
            End If
        End If
        
        If Trim(D!mueve_merca_serv) = "S" Then
            
            If sspDatos_Contrato.visible Then
                txtContrato.SetFocus
            Else
                dbgLineas_Servicios.Enabled = True
                dbgLineas_Servicios.SetFocus
                dbgLineas_Servicios.Col = 0
            End If
        End If
        
    End If

End Sub

Private Sub TxtGuia_LostFocus()
'    lbolPide_Dato_Manual = False
End Sub

Private Sub txtImporte_GotFocus()
    
    stbAyuda.Panels(1).text = "Total Final del Documento"
        
    Call Calculo_Total_Documento(True)
    
    Call MarcarTexto(txtImporte)
    
End Sub

Private Sub txtImporte_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn And cmdGuardar.Enabled Then
        cmdGuardar.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
        txtFec_Vencimiento.SetFocus
    End If
     
End Sub

Private Sub txtImporte_LostFocus()
    
    If Not gbolESC Then
        If Trim(txtImporte.text) <> "" Then
            If Not IsNumeric(txtImporte.text) Then
                gbolESC = True
                MsgBox "El Importe del Documento debe ser un Número Válido", vbInformation, MsgTit
                txtImporte.SetFocus
            Else
                If Not Valido_Redondeo Then
                    gbolESC = True
                    txtImporte.SetFocus
                Else
                    txtImporte.text = Format(txtImporte.text, "#######0.00")
                End If
            End If
        Else
            gbolESC = True
            MsgBox "El Importe del Documento No Puede Ser Nulo", vbInformation, MsgTit
            txtImporte.SetFocus
        End If
    End If

End Sub

Private Sub txtLector_GotFocus()
    stbAyuda.Panels(1).text = "F1-Búsqueda/F2-B.xFamilia/F3-B.Avanzada/F4-B.Codigos/F5-Sel.Pedido/F6-Sel.Pedido-Devolución/F7-Sel.PreVenta/F8-Sel.Remito/F9-Sel.WIS/F10-Sel.Docs.Pend./+ Cod. Sistema Anterior"
    lbDisplay.Caption = ""
    Call Color_Control_Seleccionado(Me, TxtLector)
    Call MarcarTexto(TxtLector)
End Sub

Private Sub txtLector_KeyDown(KeyCode As Integer, Shift As Integer)
On Error GoTo Errores
Dim sigo As Integer
Dim lCampo As String
Dim lBuscar As Boolean
Dim D As Recordset
Dim C As Recordset
Dim lblnCancelar As Boolean
Dim rstMailing As Recordset
Dim lclsCodigo As New clsCodigo
Dim lFactor As String
Dim lbolCrear_Tabla_Temporal_Cotizaciones As Boolean
    
Dim lrstGarantias, R As Recordset
    
    gbolESC = False
    gCargoDesdeF = False
    If KeyCode = vbKeyUp Then
        TxtFactor.SetFocus
    End If
     gstrCodBarraIngresadoPuntoVta = ""
    
    If Trim(UCase(ConfBusqueda_Articulo_Dinamica_Habilitada)) = "S" Then
        If KeyCode = vbKeyRight Then
            
            frmBusqueda_Articulos_Dinamica_Vista_Chica.Top = Me.Top + frameLin.Top + 850
            frmBusqueda_Articulos_Dinamica_Vista_Chica.Left = (Screen.Width - frmBusqueda_Articulos_Dinamica_Vista_Chica.Width) / 2
            
            frmBusqueda_Articulos_Dinamica_Vista_Chica.plngCod_Prod = 0
            frmBusqueda_Articulos_Dinamica_Vista_Chica.pbolMostrar_Todos_los_Registros = False
            frmBusqueda_Articulos_Dinamica_Vista_Chica.Show vbModal
            
        End If
    End If
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                gbooErrorRobot = True
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                gbooErrorRobot = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If Trim(TxtLector) = "" Then
            
            If Not gPtoVenta_Robot Then
                sigo = MsgBox("Desea Finalizar el Documento", vbYesNo + vbExclamation, MsgTit)
            Else
                sigo = vbYes
            End If
            
            If sigo = vbYes Then
                lblnCancelar = False
                
                lbDisplay.Caption = ""
                fraDescuento_x_Volumen.visible = False
                fraEquivalencias_Stock.visible = False
                
                If vsfMedios_Pagos.Rows = 1 Then
                    MsgBox "No Completo la Secuencia con ENTER Desde el Cliente y Faltan los Medios de Pago", vbExclamation, MsgTit
                    gbooErrorRobot = True
                    txtCodProv.SetFocus
                    Exit Sub
                End If
                lbDisplay.Caption = ""
                
                If ConfPuntoVta_Mostrar_Vencimientos_Cuotas Then
                    frameVencimientos_Cuotas.visible = True
                    Imagen_Producto.visible = False
                Else
                    frameVencimientos_Cuotas.visible = False
                    Imagen_Producto.visible = True
                End If
                         
                'If ConfPuntoVta_Enviar_Articulo_Agrupado_EFactura And sspOperacion.Caption = "A" Then
                '    'AIR 20201016 reordeno la grilla por el codigo de articulo
                '    If vsfLineas_Mercaderia.Rows - 1 > 1 Then
                '        vsfLineas_Mercaderia_AfterMoveColumn 0, 0
                '    End If
                'End If
                
                sstDetalle_Pagos.Tab = 0
                txtForma_Pago.SetFocus
                
            End If
        Else
            'lectura de codigo de barra de documentos a a afectar
            If Len(Trim(TxtLector.text)) = 12 Then
                If Mid(Trim(UCase(TxtLector.text)), 1, 2) = Trim(UCase(confPuntoVta_Prefijo_CodBarra_Seleccion)) Then
                    Select Case confPuntoVta_TeclaF_x_Defecto
                        Case 7
                            If sspOperacion.Caption = "A" Then
                               ' Solo carga PREVENTAS
                               gCargoDesdeF = True
                               If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                                   
                                   If D!signo = -1 Then
                                       If ConfWIS_INTERFASE_PEDIDOS Then
                                           If txtCodDoc.text <> ConfDoc_Ingreso_Pedido_Cli And txtCodDoc.text <> ConfDoc_Ingreso_PreVenta_Cli Then
                                               'Si estamos con WIS solo se cargan pedidos al llamar para hacer una factura
                                               gstrCodBarraIngresadoPuntoVta = TxtLector.text
                                               Call Cargar_Desde_Pedido(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), True)
                                           End If
                                       Else
                                           gstrCodBarraIngresadoPuntoVta = TxtLector.text
                                           Call Cargar_Desde_Preventas_Pendientes(val(txtEmpresa.text), val(txtCodProv.text), False)
                                       End If
                                   Else
                                       'Es una nota de credito y buscamos las facturas pendientes.
                                       gstrCodBarraIngresadoPuntoVta = TxtLector.text
                                       Call Cargar_Desde_Factura(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
                                   End If
                               End If
                            End If
                             
                    End Select
                    gCargoDesdeF = False
                    Exit Sub
                End If
                
            End If
            
        
            If Not campos_Ingresados(lCampo) Then
                MsgBox "Falta Ingresar el Campo " & lCampo & ", Recuerde usar el ENTER para Cargarlos", vbExclamation, MsgTit
                Exit Sub
            End If
            'AIR 20230612 se vuelve atras esta condicion porque esta dando problemas en Justicia
            'If (vsfLineas_Mercaderia.Rows > llngMaximo_Lineas) And controlarLineas(val(txtCodDoc.text)) Then
            If (vsfLineas_Mercaderia.Rows >= llngMaximo_Lineas) And controlarLineas(val(txtCodDoc.text)) Then
                MsgBox "Llego al Máximo de Lineas Permitido por Factura", vbInformation, MsgTit
            Else
                                
                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                    
                    fraDescuento_x_Volumen.visible = f_paso_S_N_a_Boolean(D!ver_descuentos_x_volumen)
                    fraEquivalencias_Stock.visible = f_paso_S_N_a_Boolean(D!ver_equivalencias_stock)
                
                    If Proceso_Codigo(TxtLector.text, ConfPuntoVta_Descuento_1_x_Defecto, ConfPuntoVta_Descuento_2_x_Defecto, ConfPuntoVta_Descuento_3_x_Defecto, 0, D!tipo_entrega_mercaderia_x_defecto, txtDeposito.text, False, "TXTLECTOR", True, 0, 0, 0, 0, 0, 0, 0, 0, 0, lblnCancelar, 1, glngColor_x_Defecto_Fuente_Nombre) Then
                        
                        If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia Then 'se posiciona para ingresar el descuento en la grilla
                            'AIR 20211227 PuntoVta_Calcula_Cajas_x_Packing ya viene cargado el factor desde Proceso_Codigo
                            If Not ConfPuntoVta_Calcula_Cajas_x_Packing Then
                                TxtFactor.text = ""
                            End If
                            vsfLineas_Mercaderia.SetFocus
                            vsfLineas_Mercaderia.Col = CGL_DTO1
                            If Trim(UCase(ConfPuntoVta_Ordenar_Grilla_Mercaderia_Ultimo_Ingreso)) = "N" Then
                                vsfLineas_Mercaderia.Row = vsfLineas_Mercaderia.Rows - 1
                            Else
                                vsfLineas_Mercaderia.Row = 1
                            End If
                        Else
                            Select Case ConfFormato_Factura
                                Case "DUBER"
                                    vsfLineas_Mercaderia.SetFocus
                                    vsfLineas_Mercaderia.Col = CGL_UNIDADES
                                    vsfLineas_Mercaderia.Row = vsfLineas_Mercaderia.Rows - 1
                                Case Else
                                    'AIR 20211227 PuntoVta_Calcula_Cajas_x_Packing ya viene cargado el factor desde Proceso_Codigo
                                    If ConfPuntoVta_Calcula_Cajas_x_Packing And ConfPuntoVta_Ver_Columna_Cajas Then
                                    
                                    Else
                                        TxtFactor.text = ""
                                                                    
                                        If Trim(gstrUnidades_x_Defecto) <> "" Then
                                            TxtFactor.text = val(gstrUnidades_x_Defecto)
                                        End If
                                    End If
                                    
                                    TxtFactor.SetFocus
                            End Select
                        End If
          
                        
                    Else
                        Call txtLector_GotFocus
                    End If
                Else
                    gbooErrorRobot = True
                    MsgBox "ERROR: Codigo de Documento Ingresado No Existe en el Sistema. Verifique por favor...", vbCritical + vbOKOnly
                    Call txtLector_GotFocus
                End If
            End If
        End If
    End If
    
    If KeyCode = vbKeyF1 Then
        lBuscar = False
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("vsfLM_Codigo").pide_autorizacion_busquedas = "S" Then
                If Autorizacion_Supervision(18, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    lBuscar = True
                End If
            Else
                lBuscar = True
            End If
        Else
            lBuscar = True
        End If
        
        If lBuscar Then
            GForm = Me.Name
            GTipoBusc = "productos"
            gF1_F3 = True
            whereSelCamG = ""
            ' JE 20250708   /   Se agregan estos parametros para la busqueda de Precio de Venta
            frmBusquedas.plngPVenta_Nro_Lista = val(txtLista.text)
            frmBusquedas.plngPVenta_Moneda = val(txtMoneda.text)
            frmBusquedas.pdblPVenta_TC = val(txtTipo_Cambio.text)
            frmBusquedas.Show 1
        End If
        
        
        
    End If
    
    
    If KeyCode = vbKeyF2 Then
        frmMan_Clasificacion_Familias.pbolSolo_Busqueda = True
        frmMan_Clasificacion_Familias.Show
    End If
    
    If KeyCode = vbKeyF3 Then
        lBuscar = False
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("vsfLM_Codigo").pide_autorizacion_busquedas = "S" Then
                If Autorizacion_Supervision(18, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    lBuscar = True
                End If
            Else
                lBuscar = True
            End If
        Else
            lBuscar = True
        End If
        If lBuscar Then
           If Not ConfConsulta_Articulos_MultiSeleccion Then
               GForm = Me.Name
               gbolESC = True
               gF1_F3 = True
               Unload frmBusqueda_Articulos
               frmBusqueda_Articulos.Show
           Else
                Set gcolListaCodigo = New colListaCodigo
                GForm = "MultiSeleccion"
                gbolESC = True
                
                Unload frmBusqueda_Articulos
                
                frmBusqueda_Articulos.pstrFiltros = ""
                frmBusqueda_Articulos.pstrDescripcion_Filtros = ""
                
                frmBusqueda_Articulos.Show vbModal
                DoEvents
                
                If IsNumeric(TxtFactor.text) Then
                    lFactor = TxtFactor.text
                Else
                    lFactor = 1
                End If
                
                For i = 1 To gcolListaCodigo.Count()
                    If ConfPuntoVta_Ingresa_Codigo_SAnterior Then   ' AIR 20231108
                        TxtLector.text = gcolListaCodigo.Item(i).codigoSAnt
                    Else
                        TxtLector.text = gcolListaCodigo.Item(i).codigo
                    End If
                    If gcolListaCodigo.Count > 1 Then
                        If ConfPuntoVta_Ingresa_Codigo_SAnterior Then   ' AIR 20231108
                            TxtFactor.text = BuscoValorMinVenta(gcolListaCodigo.Item(i).codigoSAnt)
                        Else
                            TxtFactor.text = BuscoValorMinVenta(gcolListaCodigo.Item(i).codigo)
                        End If
                        DoEvents
                        Call txtLector_KeyDown(vbKeyReturn, 0)
                    End If
                Next
                GForm = ""
                TxtFactor.text = ""
                TxtLector.SetFocus

           End If
        End If
    End If
    
    If KeyCode = vbKeyF4 Then
        GForm = Me.Name
        gbolESC = True
        gF1_F3 = True
        Unload frmBusqueda_Articulos
        frmBusqueda_Articulos.pbolBusquedaXCodigos = True
        frmBusqueda_Articulos.Show
    End If

    If KeyCode = vbKeyF5 Then
        If txtCodDoc.text = ConfDoc_Ingreso_Pedido_Cli Or txtCodDoc.text = ConfDoc_Ingreso_PreVenta_Cli Then
            'Si estamos con WIS solo se cargan pedidos al llamar para hacer una factura
            gCargoDesdeF = True
            Call Cargar_Desde_Pedido_Proveedor(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), IIf(val(txtEmpresa.text) = 9, 1001, 110), False)
            gCargoDesdeF = False
        End If
    End If


    If KeyCode = vbKeyF6 Then
        ' Solo PEDIDOS DE CLIENTES
        gCargoDesdeF = True
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If D!signo = -1 Then
                If ConfWIS_INTERFASE_PEDIDOS Then
                    If txtCodDoc.text <> ConfDoc_Ingreso_Pedido_Cli And txtCodDoc.text <> ConfDoc_Ingreso_PreVenta_Cli Then
                        'Si estamos con WIS solo se cargan pedidos al llamar para hacer una factura
                        Call Cargar_Desde_Pedido(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), False)
                    End If
                Else
                    Call Cargar_Desde_Pedido(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), False)
                End If
            Else
                
                Call Cargar_Desde_Pedido(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), False)
                ' JE 20180503   /   se comento esta llamada, para dejar solo Pedidos en F6 (Pedidos y Dev. de Pedidos)
                '                   con F7 se sigue llamando a las facturas cuando el documento es una nota de credito
                'Es una nota de credito y buscamos las facturas pendientes.
                'Call Cargar_Desde_Factura(Val(txtEmpresa.Text), Val(txtCodDoc.Text), Val(txtDoc.Text), Val(txtCodProv.Text))
            End If
            
        End If
        gCargoDesdeF = False
    End If

    If KeyCode = vbKeyF7 And sspOperacion.Caption = "A" Then
        ' Solo carga PREVENTAS
        gCargoDesdeF = True
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If D!signo = -1 Then
                If ConfWIS_INTERFASE_PEDIDOS Then
                    If txtCodDoc.text <> ConfDoc_Ingreso_Pedido_Cli And txtCodDoc.text <> ConfDoc_Ingreso_PreVenta_Cli Then
                        'Si estamos con WIS solo se cargan pedidos al llamar para hacer una factura
                        Call Cargar_Desde_Pedido(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), True)
                    End If
                Else
                    Call Cargar_Desde_Preventas_Pendientes(val(txtEmpresa.text), val(txtCodProv.text), False)
                End If
            Else
                'Es una nota de credito y buscamos las facturas pendientes.
                Call Cargar_Desde_Factura(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
            End If
        End If
        gCargoDesdeF = False
    End If

    If KeyCode = vbKeyF8 And confPuntoVta_Activa_Seleccion_F8 Then
        gCargoDesdeF = True
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If D!signo = -1 Then
                Call Cargar_Desde_Remito(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
            End If
        End If
        gCargoDesdeF = False
    End If
    
    If KeyCode = vbKeyF9 Then
'        gCargoDesdeF = True
'        If ConfProceso_Datos_WIS = True Then
'            nro_doc_Wis = ""
'            camion_Wis = ""
'            Call Cargar_Desde_WIS(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
'        End If
'        gCargoDesdeF = False

        gCargoDesdeF = True
        If ConfProceso_Datos_WIS = True Then
            ' AIR 20240205 se pasa la inicializacion para dentro de la funcion porque si apretan 2 veces F9 se pierde lo seleccionado en el primer F9
'            nro_doc_Wis = ""
'            camion_Wis = ""
            ' AIR 20240205 Se agrega la consulta si hay lineas ingresadas en la Grilla por una descarga anterior(por si hay un error de tecla)
            If vsfLineas_Mercaderia.Rows > 1 And nro_doc_Wis <> "" Then
                vsfLineas_Mercaderia.SetFocus
                DoEvents
                If MsgBox("Hay datos descargados previamente." & Chr(13) & "Desea limpiar la descarga anterior?", vbQuestion + vbYesNo + vbDefaultButton2) = vbYes Then
                    Call Inicializo_Grilla_Lineas_Mercaderia
                    nro_doc_Wis = ""
                    camion_Wis = ""
                End If
            End If
            Call Cargar_Desde_WIS(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
        End If
        gCargoDesdeF = False
    End If
    
    If KeyCode = vbKeyF10 Then      ' Documentos parciales                                  SS 20160127
        gCargoDesdeF = True
        If ConfControla_Saldo_Cantidad_Por_Documento = True Then
            ' Utiliza definicion de doc.pend.definidos en ma_Tipos_Docs_Pendientes_Validos
            
            ' JE 20180817  / Consulto si hay lineas ingresadas en la Grilla (por si hay un error de tecla)
            If vsfLineas_Mercaderia.Rows > 1 Then
                vsfLineas_Mercaderia.SetFocus
                DoEvents
                If MsgBox("Desea Limpiar la Grilla Totalmente?", vbQuestion + vbYesNo) = vbYes Then
                    Call Inicializo_Grilla_Lineas_Mercaderia
                    gbln_Cargo_Datos_Desde_F10 = False
                End If
            Else
                Call Inicializo_Grilla_Lineas_Mercaderia
            End If
            Call Inicializo_Grilla_Series_Articulos
            
            Call Cargar_Desde_Doc_Pendientes_Definidos(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), val(TxtCodSuc.text), val(txtMoneda.text))
            If Buscar_Cliente(CLng(txtCodProv.text), C) Then
                If Trim(UCase(C!generico)) = "S" Then
                
                End If
            End If
            
            If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                TxtLector.SetFocus
            Else
                TxtFactor.SetFocus
            End If
            
        End If
        gCargoDesdeF = False
    End If

    If KeyCode = vbKeyF11 Then      ' JE 20180725   /   Ingreso Articulos por Color y Talle
        gFormOrig = Me.Name
        frmIngreso_Articulos_x_Color_Talle.plngCod_Empresa = val(txtEmpresa.text)
        frmIngreso_Articulos_x_Color_Talle.plngCod_Doc = val(txtCodDoc.text)
        frmIngreso_Articulos_x_Color_Talle.plngCod_Cliente = val(txtCodProv.text)
        frmIngreso_Articulos_x_Color_Talle.plngLista_PVenta = val(txtLista.text)
        frmIngreso_Articulos_x_Color_Talle.plngMoneda = val(txtMoneda.text)
        frmIngreso_Articulos_x_Color_Talle.pdblTipo_Cambio = val(txtTipo_Cambio.text)
        frmIngreso_Articulos_x_Color_Talle.pstrDeposito = Trim(txtDeposito.text)
        frmIngreso_Articulos_x_Color_Talle.pstrFecha = Trim(txtFec_Doc.text)
        
        frmIngreso_Articulos_x_Color_Talle.Show vbModal
        
    End If

    If KeyCode = vbKeyF12 Then      ' JE 20240616   /   Ingreso Cotizaciones
    
        lbolCrear_Tabla_Temporal_Cotizaciones = False
        If gstrTabla_Temporal_Cotizaciones = "" Then
            gstrTabla_Temporal_Cotizaciones = CrearTablaTemporal
            lbolCrear_Tabla_Temporal_Cotizaciones = True
        End If

        gFormOrig = Me.Name
        frmPunto_Venta_Cotizaciones.plngCod_Empresa = val(txtEmpresa.text)
        frmPunto_Venta_Cotizaciones.plngCod_Doc = val(txtCodDoc.text)
        frmPunto_Venta_Cotizaciones.plngNro_Doc = val(txtDoc.text)
        frmPunto_Venta_Cotizaciones.plngCod_Cliente = val(txtCodProv.text)
        frmPunto_Venta_Cotizaciones.plngLista_PVenta = val(txtLista.text)
        frmPunto_Venta_Cotizaciones.plngMoneda = val(txtMoneda.text)
        
        If val(txtMoneda.text) = gMoneda_Base Then
            frmPunto_Venta_Cotizaciones.pdblTCambio = 0                         ' JE 20241025   /   Se pasa 0 para que tome Tipo de Cambio Configurado de precios
        Else
            frmPunto_Venta_Cotizaciones.pdblTCambio = val(txtTipo_Cambio.text)
        End If
        
        frmPunto_Venta_Cotizaciones.pstrFecha_Vigencia = Trim(txtFec_Doc.text)
        frmPunto_Venta_Cotizaciones.pstrTabla_Temporal_Cotizaciones = gstrTabla_Temporal_Cotizaciones
        frmPunto_Venta_Cotizaciones.pbolCrear_Temporal_Cotizaciones = lbolCrear_Tabla_Temporal_Cotizaciones
        frmPunto_Venta_Cotizaciones.pstrOperacion = Trim(sspOperacion.Caption)
        
        frmPunto_Venta_Cotizaciones.Show
        
    End If

    If KeyCode = vbKeyDown Then
'        vsfLineas_Mercaderia.Row = vsfLineas_Mercaderia.Rows - 1
        ' JE 20180725   /   Me posiciono en la Primer Fila
        If vsfLineas_Mercaderia.Rows > 1 Then
            vsfLineas_Mercaderia.SetFocus
            vsfLineas_Mercaderia.Col = CGL_UNIDADES
            vsfLineas_Mercaderia.Row = 1
        End If
    End If


Exit Sub

Errores:
    MsgBox "Ha Ocurrido un Error, Vuelva a Intentar", vbExclamation, MsgTit
    MousePointer = 1
Exit Sub
Resume
End Sub

Private Sub txtLector_KeyPress(KeyAscii As Integer)
   char = Chr(KeyAscii)
   KeyAscii = Asc(UCase(char))
End Sub


Private Sub txtLista_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtLista").solicitar_datos = "S"
    End If

End Sub

Private Sub txtLista_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtLista").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
        
    stbAyuda.Panels(1).text = "Ingrese el Código de Lista"
    Call Color_Control_Seleccionado(Me, txtLista)
    Call MarcarTexto(txtLista)
    
    If Trim(txtLista.text) <> "" Then
       plngNroLista_Anterior = txtLista.text
    End If
    
End Sub

Private Sub txtLista_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        'AIR 20240604
        'TxtCodSuc.SetFocus
        If TxtCodSuc.Enabled = True And lcolCampos("TxtCodSuc").solicitar_datos = "S" Then
            TxtCodSuc.SetFocus
        Else
            txtCodProv.SetFocus
        End If
    End If
        
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtMoneda.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        If Not txtLista.Locked Then
            GForm = Me.Name
            GTipoBusc = "listas_precios"
            gbolESC = True
            whereSelCamG = "listas_precios.tipo_lista = 'V'"
            frmBusquedas.Show
        End If
    End If
    
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtLista").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(1, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtLista.Locked = False
                End If
            End If
        End If
    End If
    
End Sub

Private Sub txtLista_LostFocus()
On Error GoTo Errores
Dim R As Recordset
Dim D As Recordset
Dim C As Recordset
     
    If plngNroLista_Anterior = val(txtLista.text) And sspOperacion.Caption <> "A" Then
        gbolESC = True
        Call Color_Control_Seleccionado(Me, txtMoneda)
        Call MarcarTexto(txtMoneda)
        Exit Sub
    End If


    If Not gbolESC Then
        If Trim(txtLista.text) <> "" Then
            
            If IsNumeric(txtLista.text) Then
                
                If Not Busco_Lista_Precio(txtLista.text, "V", R) Then
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Lista de Precios Inexistente", vbInformation, MsgTit
                    txtLista.SetFocus
                    Exit Sub
                Else
                    If Trim(UCase(R!Activo)) <> "S" Then
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "Lista de Precios INACTIVA. Verifique por Favor...", vbCritical + vbOKOnly, MsgTit
                        txtLista.SetFocus
                        Exit Sub
                    End If
                
                    txtNombre_Lista.text = Trim(R!Descripcion)
                    DtoGeneralLista = 0 'ObtenerDescuentoListaVenta(CLng(txtLista.text))
                    
                    
                    'Paso esto para mas abajo, ya que el precio depende de la moneda tambien, luego del cambio de moneda, se actualiza el precio    SS 20180420
                    
                    'If Trim(UCase(sspOperacion.Caption)) = "A" Then
                        ' Si estamos en ALTA y el Documento tiene un Deposito x defecto se coloca este deposito
                    
                        ' JE / 20161012 /Actualizar la Grilla si se cambio la Lista....
                    '    If (Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Lista <> Val(txtLista.Text) Then
                    '        Call Actualizo_Precios_de_Articulos_de_la_Grilla
                    '    End If
                    'End If
                    
                    'glngAnterior_Lista = Val(txtLista.Text)
                    
                    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                        MsgBox "Documento INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
                        gbooErrorRobot = True
                        txtCodDoc.SetFocus
                        Exit Sub
                    End If
                    
                    If D!moneda_x_defecto = 0 Then
                        If Trim(UCase(sspOperacion.Caption)) = "A" And Not gbolCargo_Desde_Preventa Then
                            
                            If Trim(D!mueve_merca_serv) = "M" Then
                                If ConfPuntoVta_Moneda_x_Defecto_DMercaderia <> 0 Then
                                    txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DMercaderia
                                Else
                                    'ATU 20180723, se agrega funcionaldad nueva, para que arrastre la moneda del cliente.
                                    If Buscar_Cliente(val(txtCodProv.text), C) Then
                                        If C!moneda_x_defecto_facturar <> 0 Then
                                            txtMoneda.text = C!moneda_x_defecto_facturar
                                        Else
                                            txtMoneda.text = R!moneda
                                        End If
                                    Else
                                        txtMoneda.text = R!moneda
                                    End If
                                End If
                                glngAnterior_Moneda = val(txtMoneda.text)
                            End If
                            If Trim(D!mueve_merca_serv) = "S" Then
                                If ConfPuntoVta_Moneda_x_Defecto_DServicio <> 0 Then
                                    txtMoneda.text = ConfPuntoVta_Moneda_x_Defecto_DServicio
                                Else
                                    If D!tipo_doc <> "G" Then  ' Para resguardos queda moneda de la lista   SS 20200219
                                        'ATU 20180723, se agrega funcionaldad nueva, para que arrastre la moneda del cliente.
                                        If Buscar_Cliente(val(txtCodProv.text), C) Then
                                            If C!moneda_x_defecto_facturar <> 0 Then
                                                txtMoneda.text = C!moneda_x_defecto_facturar
                                            Else
                                                txtMoneda.text = R!moneda
                                            End If
                                        Else
                                            txtMoneda.text = R!moneda
                                        End If
                                    Else
                                        txtMoneda.text = R!moneda
                                    End If
                                End If
                                glngAnterior_Moneda = val(txtMoneda.text)
                            
                            End If
                        End If
                    End If
                    
                    
                    If Busco_Moneda(txtMoneda.text) Then
                        txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                    Else
                        MsgBox "Moneda de la Lista INEXISTENTE. Verifique por Favor", vbCritical + vbOKOnly
                        gbooErrorRobot = True
                        txtLista.SetFocus
                        Exit Sub
                    End If
                    
                    
                    
                    If Not gPtoVenta_Robot Then
                        frmPunto_Venta.txtMoneda_LostFocus  'actualiza tipo de cambio por el cambio de moneda   SS 20180420
                    End If
                    
                    
                                                    
                    If Trim(UCase(sspOperacion.Caption)) = "A" Or Trim(UCase(sspOperacion.Caption)) = "M" Then      'Agrego M   SS 20190918
                        ' JE / 20161012 /Actualizar la Grilla si se cambio la Lista....
                        If (Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Lista <> val(txtLista.text) Then
                            
                            gblnCancelar = False
                            
                            Call Actualizo_Precios_de_Articulos_de_la_Grilla
                            'AIR 20190605
                            If gblnCancelar Then
                                gblnCancelar = False
                                txtLista.SetFocus
                            End If
                        End If
                    End If
                    glngAnterior_Lista = val(txtLista.text)
                    
                    If Trim(UCase(sspOperacion.Caption)) <> "A" And Trim(UCase(sspOperacion.Caption)) <> "M" Then      'Agrego      SS 20190918 (corria la actualizacion de precios 2 veces)
                        If Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S" Then
                        
                            gblnCancelar = False
                             
                             Call Actualizo_Precios_de_Articulos_de_la_Grilla
                             'AIR 20190605
                             If gblnCancelar Then
                                 gblnCancelar = False
                                 txtLista.SetFocus
                             End If
                        End If
                    End If
                    
                    If Not ControlDescuentosGeneral("txtLista") Then
                         gbolESC = True
                         gbooErrorRobot = True
                         'MsgBox "Lista de Precios Inexistente", vbInformation, MsgTit
                         txtLista.SetFocus
                         Exit Sub
                    End If
                                        
                    Call Inicializo_Campos_para_Autorizar
                    
                End If
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Número de Lista de Precios debe ser un número válido", vbInformation, MsgTit
                txtLista.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Número de Lista de Precios No puede ser Nulo", vbInformation, MsgTit
            txtLista.SetFocus
        End If
    End If
    
'    lbolPide_Dato_Manual = False
    
Exit Sub
Errores:
    gbooErrorRobot = True
    Resume Next
End Sub


Private Sub txtMoneda_Click()
    
    If lcolCampos.Count > 10 And ConfFormato_Factura <> "HERTZ" Then
        lcolCampos("txtMoneda").solicitar_datos = "S"
    End If

End Sub

Private Sub txtMoneda_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtMoneda").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Código de la Moneda"
    Call Color_Control_Seleccionado(Me, txtMoneda)
    Call MarcarTexto(txtMoneda)
    
    plngMoneda_Anterior = IIf(IsNumeric(txtMoneda.text), txtMoneda.text, 0)

End Sub

Private Sub txtMoneda_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtLista.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtTipo_Cambio.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        If Not txtMoneda.Locked Then
            GForm = Me.Name
            GTipoBusc = "monedas"
            gbolESC = True
            whereSelCamG = ""
            frmBusquedas.Show
        End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtMoneda").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(2, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtMoneda.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtMoneda.Locked = False
            End If
        End If
    End If

End Sub

Public Sub txtMoneda_LostFocus()
Dim D As Recordset
Dim R As Recordset
Dim C As Recordset
Dim P As Recordset
Dim i As Integer
Dim lrstMag As Recordset
Dim ldblTipo_Cambio As Double
Dim lequivalencia As Double
Dim lCantidad As Double

Dim lPrecioMinimo As Double
Dim ldblDtoMaximo As Double


    If plngMoneda_Anterior = val(txtMoneda.text) And sspOperacion.Caption <> "A" Then
        gbolESC = True
        Call Color_Control_Seleccionado(Me, txtTipo_Cambio)
        Call MarcarTexto(txtTipo_Cambio)
        Exit Sub
    End If
        
    ' AIR 20250623
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        gbolESC = True
        gbooErrorRobot = True
        MsgBox "No se Pudo Inicializar la Configuracion del Documento. Verifique por favor...", vbInformation, MsgTit
        txtCodProv.SetFocus
        Exit Sub
    End If
               
    If Not gbolESC Or gPtoVenta_Robot Then
    
        If Trim(txtMoneda.text) <> "" Then
            If IsNumeric(txtMoneda.text) Then
                If Busco_Moneda(txtMoneda.text) Then
                    txtDes_Moneda.text = Trim(rstMonedas!simbolo)
                    txtSimbolo_SubTotal.text = Trim(rstMonedas!simbolo)
                    TxtSimbolo_Medios_Pago.text = Trim(rstMonedas!simbolo)
                    txtSimbolo_Redondeo.text = Trim(rstMonedas!simbolo)
                    TxtSimbolo_Cambio.text = Trim(rstMonedas!simbolo)
                                       
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                    
                    'AIR 20180326 si la venta es en DOLARES, se toma el MANUAL COMPRADOR para Veicuer
                    'AIR 20180326 si la factura es en DOLARES toma el manual comprador
'                    If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
'                        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
'                    End If
                    'JCH 20220519 se agrego este if para ver que descuento se toma segun la moneda
                                        
                    ' AIR 20250623 estaba cargando el % de dscto del cliente para un resguardo
                    If D!tipo_doc <> "G" Then
                        If sspOperacion.Caption = "A" Then
                            txtDtoGlobal.text = Format(0, "##0.00")
                            If IsNumeric(txtCodProv.text) Then
                                If Buscar_Cliente(txtCodProv.text, C) Then
                                    If Trim(UCase(C!tipo_porcentaje)) = "D" Then
                                       If val(txtMoneda.text) = gMoneda_Base Then
                                          Me.txtDtoGlobal.text = IIf(IsNull(C!porcentaje), 0, C!porcentaje)
                                       Else
                                          Me.txtDtoGlobal.text = IIf(IsNull(C!porcentaje_ref), 0, C!porcentaje_ref)
                                       End If
                                    End If
                                End If
                            End If
                        End If
                    Else
                        txtDtoGlobal.text = Format(0, "##0.00")
                    End If
                    
                    If ldblTipo_Cambio <> 0 Then
                        txtTipo_Cambio.text = Format(ldblTipo_Cambio, "###0.000")
                                                
                        'ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), gMoneda_Referencia, Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
                        
                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador a pedido de Ricardo
                        'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                        'If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                        '    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
                        'Else
                            ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), gMoneda_Referencia, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                        'End If
                                                                                                    
                        If ldblTipo_Cambio <> 0 Then
'                            If Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S" Then
                            ' JE / 20160805 / Agreo que ingreso a Actualizar la Grilla si se cambio la Moneda....
                            If ((Not gbolCargo_Desde_Preventa And ConfPuntoVta_Actualizar_Precios_de_Lista_Automaticamente = "S") Or glngAnterior_Moneda <> val(txtMoneda.text)) And vsfLineas_Mercaderia.Rows > 1 Then ' AIR 20190410 se agrega control de que la grilla tenga lineas para realizar el calculo. Estaba dando error en algunos casos.
                                
                                'AIR 20190605
                                gblnCancelar = False
                                
                                Call Actualizo_Precios_de_Articulos_de_la_Grilla
                                
                                'jch actualizo precios minimos de linea
                                For i = 1 To vsfLineas_Mercaderia.Rows - 1
                                     If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
                                         If Buscar_Articulo(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), P) Then
                                         End If
                                
                                         lPrecioMinimo = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), P!Cod_Prod, val(txtCodProv.text), val(txtCodDoc.text), val(txtLista.text), txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ldblDtoMaximo)
            
            
                                         If Buscar_Equivalencia(P!Cod_Prod, P!magnitud, vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD), lrstMag) Then
                                             lequivalencia = lrstMag!val_equivalencia
                                         Else
                                             lequivalencia = 1
                                         End If
            
                                         If confUsaEquivalenciaMagnitudes Then
                                             Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, lPrecioMinimo)
                                         End If
                        
                                         vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_MINIMO) = Format(lPrecioMinimo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                         vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCUENTO_MAXIMO) = Format(ldblDtoMaximo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                     End If
                                Next
                                                                
                               
                                'AIR 20190605
                               If gblnCancelar Then
                                    txtMoneda.text = glngAnterior_Moneda
                                    gblnCancelar = False
                                    txtMoneda.SetFocus
                                End If
                            End If
                            
                            lblTC_Linea.Caption = Mostrar_TC_Cotizacion_Linea(val(txtEmpresa.text), val(txtCodDoc.text), val(txtMoneda.text), CDate(txtFec_Doc.text))
                            
                            Call Inicializo_Campos_para_Autorizar
                            


                        Else
                            gbolESC = True
                            gbooErrorRobot = True
                            MsgBox "Tipo de Cambio Inexistente para la Moneda de Referencia a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                            txtMoneda.SetFocus
                        End If
                    Else
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(txtDes_Moneda.text) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                        txtMoneda.SetFocus
                    End If
                
                    glngAnterior_Moneda = val(txtMoneda.text)
                                    
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Moneda Inexistente", vbInformation, MsgTit
                    txtMoneda.SetFocus
                End If
                'rstMonedas.Close
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Código de la Moneda es numérico", vbInformation, MsgTit
                txtMoneda.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Código de la Moneda No Puede Ser Nulo", vbInformation, MsgTit
            txtMoneda.SetFocus
        End If
    End If

End Sub

Private Sub txtNomCli_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtNomCli").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtNomCli").solicitar_datos = "S"
    End If

End Sub

Private Sub txtNomCli_GotFocus()
    
        
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtNomCli").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = " <F1> Ver Cuotas Pendientes / <F2> Ver Resumen de Cuotas / <F3> Ver Historial de Pagos / <F10> Ingresar Dirección"
    Call Color_Control_Seleccionado(Me, txtNomCli)
    Call MarcarTexto(txtNomCli)

End Sub

Private Sub txtNomCli_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If TxtRuc.Enabled = False Then
            TxtCodSuc.SetFocus
        Else
            TxtRuc.SetFocus
        End If

        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        Call Busqueda_Documentos_Cuotas_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", -1, "facturas_cuotas", val(txtMoneda.text))
    End If

    If KeyCode = vbKeyF2 Then
        Call Busqueda_Documentos_Cuotas_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", -1, "facturas_cuotas_resumen", val(txtMoneda.text))
    End If
    
    If KeyCode = vbKeyF3 Then
        Call Busqueda_Documentos_Cuotas_a_Afectar(val(txtEmpresa.text), txtCodProv.text, "E", -1, "facturas_cuotas_historial", val(txtMoneda.text))
    End If
    
    If KeyCode = vbKeyF10 Then
        frmPunto_Venta_Datos_Direccion.plngCod_Emp = val(txtEmpresa.text)
        frmPunto_Venta_Datos_Direccion.plngCod_Doc = val(txtCodDoc.text)
        frmPunto_Venta_Datos_Direccion.plngNro_Doc = val(txtDoc.text)
        frmPunto_Venta_Datos_Direccion.plngCod_Cliente = val(txtCodProv.text)
        frmPunto_Venta_Datos_Direccion.plngTipo_Documento = glngTipo_Documento_Identidad
        frmPunto_Venta_Datos_Direccion.pstrDocumento = gstrDocumento_Identidad
        frmPunto_Venta_Datos_Direccion.pstrDireccion = gstrDireccion
        frmPunto_Venta_Datos_Direccion.pstrTelefonos = gstrTelefonos
        frmPunto_Venta_Datos_Direccion.plngCod_Pais = glngCod_Pais
        frmPunto_Venta_Datos_Direccion.plngCod_Departamento = glngCod_Departamento
        frmPunto_Venta_Datos_Direccion.plngCod_Ciudad = glngCod_Ciudad
        frmPunto_Venta_Datos_Direccion.pstreMail = gstreMail
        frmPunto_Venta_Datos_Direccion.plngCod_Grupo = glngCod_Grupo
        
        frmPunto_Venta_Datos_Direccion.pbolDatos_Confirmados = False
        
        frmPunto_Venta_Datos_Direccion.Show vbModal
        
        If frmPunto_Venta_Datos_Direccion.pbolDatos_Confirmados Then
            
            txtTipo_Doc_Identidad.text = frmPunto_Venta_Datos_Direccion.plngTipo_Documento
            TxtRuc.text = frmPunto_Venta_Datos_Direccion.pstrDocumento
            
            glngTipo_Documento_Identidad = frmPunto_Venta_Datos_Direccion.plngTipo_Documento
            gstrDocumento_Identidad = frmPunto_Venta_Datos_Direccion.pstrDocumento
            gstrDireccion = frmPunto_Venta_Datos_Direccion.pstrDireccion
            gstrTelefonos = frmPunto_Venta_Datos_Direccion.pstrTelefonos
            glngCod_Pais = frmPunto_Venta_Datos_Direccion.plngCod_Emp
            glngCod_Departamento = frmPunto_Venta_Datos_Direccion.plngCod_Departamento
            glngCod_Ciudad = frmPunto_Venta_Datos_Direccion.plngCod_Ciudad
            gstreMail = frmPunto_Venta_Datos_Direccion.pstreMail
            glngCod_Grupo = frmPunto_Venta_Datos_Direccion.plngCod_Grupo
        End If
        
    End If
    
    If KeyCode = vbKeyUp Then
        txtCodProv.SetFocus
    End If
    
End Sub


Private Sub txtNomCli_KeyPress(KeyAscii As Integer)
   char = Chr(KeyAscii)
   KeyAscii = Asc(UCase(char))
End Sub

Private Sub txtNro_Doc_Afectado_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtNro_Doc_Afectado").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtNro_Doc_Afectado").solicitar_datos = "S"
    End If

End Sub

Private Sub txtNro_Doc_Afectado_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtNro_Doc_Afectado").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Número del Documento a Afectar"
    Call Color_Control_Seleccionado(Me, txtNro_Doc_Afectado)
    Call MarcarTexto(txtNro_Doc_Afectado)
    
End Sub

Private Sub txtNro_Doc_Afectado_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If txtNro_Doc_Afectado.text <> "" Then
            txtCajas.text = ""
        End If
        
        'AIR 20250623
        If txtAcopio.visible = True And txtAcopio.Enabled = True Then
            txtAcopio.SetFocus
        Else
            txtObs.SetFocus
        End If

        DoEvents
    End If
    
'    If KeyCode = vbKeyF1 Then  'lo comento porque tenemos que hacer varios arreglos para que funcione y esta funcionalidad no esta informada al cliente    SS 20190306
'        gbolESC = True
'        Busqueda = True
'        frmBusqueda_Documentos.pstrTipo_Busqueda = "DOCUMENTOS"
'        frmBusqueda_Documentos.plngCod_Doc = Val(txtNro_Doc_Afectado.text)
'        frmBusqueda_Documentos.pstrFormulario_Que_Llama = Me.Name
'        frmBusqueda_Documentos.pstrCampo_Que_Llama = "TXTNRO_DOC_AFECTADO"
'        frmBusqueda_Documentos.Show
'    End If
    
End Sub

Private Sub txtNro_Doc_Afectado_LostFocus()

Dim lrstDocumento As Recordset
Dim lrstDocumento_Origen As Recordset
Dim lrstDoc_Cuotas As Recordset
Dim lrstAfecta As Recordset             'AIR 20250429
Dim lstrDocs As String

Dim lstrFiltros As String

On Error Resume Next

     If Not gbolESC Then
        
        If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumento) Then
        
            If Trim(txtNro_Doc_Afectado.text) <> "" Then
            
                If IsNumeric(txtNro_Doc_Afectado.text) Then
    
                    ' Chequeo si existe el documento de referencia
                    
                    If Not Busco_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text)) Then
                        gbolESC = True
                        MsgBox "Documento NO Existente. Verifique por Favor", vbExclamation + vbOKOnly
                        txtNro_Doc_Afectado.SetFocus
                    Else
                        If val(txtCodProv.text) <> rstCabezales_Documentos!Cod_Prov Then
                            gbolESC = True
                            MsgBox "El Documento a Afectar No Pertenece al Cliente Ingresado", vbInformation, MsgTit
                            txtNro_Doc_Afectado.SetFocus
                        Else
                            If val(txtMoneda.text) <> rstCabezales_Documentos!moneda Then   'controlo igual moneda  SS 20180328
                                gbolESC = True
                                MsgBox "El Documento a Afectar fue Emitido con una Moneda diferente", vbInformation, MsgTit
                                txtNro_Doc_Afectado.SetFocus
                            Else
                                
                                ' Busca tipo documento de referencia
                                If Buscar_Tipo_Documento(val(txtDoc_Afectado.text), lrstDocumento_Origen) Then
                                    If Trim(UCase(lrstDocumento_Origen!clase)) <> Trim(UCase(lrstDocumento!clase)) Then
                                        gbolESC = True
                                        MsgBox "El Documento a Afectar es del Tipo " & Trim(UCase(lrstDocumento_Origen!clase)), vbInformation, MsgTit
                                        txtNro_Doc_Afectado.SetFocus
                                    Else
                                        ' AIR 20250519 se verifica el signo para avisar que se esta dando esta condicion por si hay un error.
                                        
                                        If Trim(UCase(lrstDocumento_Origen!signo)) = Trim(UCase(lrstDocumento!signo)) Then
                                            MsgBox "ATENCION: Documento " & Trim(txtDoc_Afectado.text) & "/" & Trim(txtNro_Doc_Afectado.text) & "  Es de igual signo al Documento que esta ingresando.. " & " Verifique.. ", vbInformation + vbOKOnly
                                        End If
                                        'AIR 20250429
                                        'If Saldo_A_Cancelar_de_un_Documento(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), val(txtMoneda.text)) <= 0 Then
                                        ' Verifico si tiene saldo a cancelar
                                        If Saldo_A_Cancelar_de_un_Documento(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), val(txtMoneda.text), lrstAfecta) <= 0 Then
                                            
                                            lstrDocs = ""
                                            If Not lrstAfecta Is Nothing Then
                                                lrstAfecta.MoveFirst
                                                Do While Not lrstAfecta.EOF
                                                    lstrDocs = lstrDocs & "-" & str(lrstAfecta!cod_doc) & "/" & str(lrstAfecta!nro_doc)
                                                    lrstAfecta.MoveNext
                                                Loop
                                            End If
                                            
                                            'gbolESC = True
                                            'Si el documento de referencia ya esta afectado, solo se informa    SS 20151013
                                            MsgBox "ATENCION: Documento " & Trim(txtDoc_Afectado.text) & "/" & Trim(txtNro_Doc_Afectado.text) & "  Ya esta Cancelado Totalmente x Doc: " & lstrDocs & " Puede continuar... ", vbInformation + vbOKOnly
                                            'txtNro_Doc_Afectado.SetFocus
                                        Else
                                            'lstrFiltros = "cod_emp = " & Val(txtEmpresa.text) & " AND cod_doc = " & Val(txtDoc_Afectado.text) & " AND nro_doc = " & Val(txtNro_Doc_Afectado) & " AND cod_prov = " & Val(txtCodProv)
                                            
                                            ' AIR 20190725 control para que no se afecten facturas que son en cuotas ya que el punto de venta no genera movim. en la faccmp_cuotas que cierre la cancelacion.
                                            ' hay que hacerlo con un recibo enla cobranza de cuotas
                                            
                                            If Buscar_Documento_Cuota(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), lrstDoc_Cuotas) Then
                                                              
                                                  gbolESC = True
                                                  MsgBox "Documento en Cuotas No Cumple las Condiciones para ser Afectado. Verifique....", vbExclamation + vbOKOnly, MsgTit
                                                  txtNro_Doc_Afectado.SetFocus
                                            Else
                                             
                                                'AIR 20250210 se traslada el nro. del vendedor del documento a la nota de credito - AROCENA para el calculo de las comisiones.
                                                If lrstDocumento!signo = 1 Then
                                                    txtVendedor.text = rstCabezales_Documentos!nro_ven
                                                End If
                                                
                                                If Trim(lrstDocumento!mueve_merca_serv) = "M" Then
                                                    lstrFiltros = "fl.cod_emp = " & val(txtEmpresa.text) & " AND fl.cod_doc = " & val(txtDoc_Afectado.text) & " AND fl.nro_doc = " & val(txtNro_Doc_Afectado) & " AND fl.cod_prov = " & val(txtCodProv)
                                                    Call Inicializo_Grilla_Lineas_Mercaderia                    ' SS 20151006
                                                    Call Documento_Usa_IAdic(lrstDocumento!mueve_merca_serv)
                                                    Call Inicializo_Grilla_Series_Articulos
                                                    Call Cargar_Desde_Otro_Documento_Mercaderia(lstrFiltros)
                                                    If IsNumeric(txtDoc_Afectado.text) And IsNumeric(txtNro_Doc_Afectado.text) Then
                                                        Call Cargo_Grilla_Medios_Pago(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtMoneda.text), True)
                                                    End If

                                                    Dim RA As Recordset
                                                    If Buscar_Cliente(rstCabezales_Documentos!Cod_Prov, RA) Then
                                                    
                                                    ' AIR 20250428 se deben levantar los datos de la factura original se debe generar la devolucion identica a la orginal.
                                                        If RA!generico = "S" Then
                                                            Me.txtNomCli = rstCabezales_Documentos!nom_cli
                                                            If Trim(rstCabezales_Documentos!ruc) = "X" Then
                                                               Me.TxtRuc.text = ""
                                                               Me.txtTipo_Doc_Identidad = 4
                                                               Me.TxtCFinal.text = Trim(rstCabezales_Documentos!ruc)
                                                            End If
                                                        Else
                                                            Me.TxtRuc.text = Trim(rstCabezales_Documentos!ruc)
                                                            Me.txtTipo_Doc_Identidad = f_Tipo_documento_DGI(rstCabezales_Documentos!ruc)
                                                            Me.TxtCFinal.text = ""
                                                        End If
                                                    
                                                    End If
                                                    
                                                End If
                                                If Trim(lrstDocumento!mueve_merca_serv) = "S" Then
                                                    lstrFiltros = "Faccmp.cod_emp = " & val(txtEmpresa.text) & " AND Faccmp.cod_doc = " & val(txtDoc_Afectado.text) & " AND Faccmp.nro_doc = " & val(txtNro_Doc_Afectado) & " AND Faccmp.cod_prov = " & val(txtCodProv)
                                                    Call Cargar_Desde_Otro_Documento_Servicio(lstrFiltros)
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                Else
                    gbolESC = True
                    MsgBox "El Número del Documento a Afectar debe ser numérico", vbInformation, MsgTit
                    txtNro_Doc_Afectado.SetFocus
                End If
            Else
                If Trim(UCase(lrstDocumento!documento_afectado_obligatorio)) = "S" Then
                    gbolESC = True
                    MsgBox "El Número del Tipo de Documento a Afectar No Puede Ser Vacio", vbInformation, MsgTit
                    txtNro_Doc_Afectado.SetFocus
                End If
            End If
        Else
            gbolESC = True
            MsgBox "El Código del Documento No existe en el Sistema. Verifique....", vbInformation, MsgTit
            txtDoc_Afectado.SetFocus
        End If
    End If

End Sub

Private Sub txtNro_Fanfold_GotFocus()
    
    If esEFactura(val(txtCodDoc.text)) Then
        labDocumento_DGI.Caption = "eFactura"
        txtNro_Fanfold.Locked = True
        txtNro_Fanfold.BackColor = &HFF&
        txtNro_Fanfold.ForeColor = &HFFFF&
    Else
        labDocumento_DGI.Caption = "Fanfold"
        glngNro_Fanfold_Anterior = val(txtNro_Fanfold.text)
        stbAyuda.Panels(1).text = "Ingrese el Numero de Fanfold"
        txtNro_Fanfold.BackColor = &HFFFFFF
        txtNro_Fanfold.ForeColor = &H80000008
        Call Color_Control_Seleccionado(Me, txtNro_Fanfold)
        Call MarcarTexto(txtNro_Fanfold)
    End If
    
End Sub

Private Sub txtNro_Fanfold_KeyDown(KeyCode As Integer, Shift As Integer)
    
    If Not esEFactura(val(txtCodDoc.text)) Then
        If KeyCode = vbKeyF4 Then
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If lcolCampos("txtNro_Fanfold").pide_autorizacion = "S" Then
                    If Autorizacion_Supervision(10, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                        txtNro_Fanfold.Locked = False
                    End If
                End If
            End If
        End If
    End If

End Sub


Private Sub txtNro_Fanfold_LostFocus()


If Not esEFactura(val(txtCodDoc.text)) Then
    If Not IsNumeric(txtNro_Fanfold.text) Then
        MsgBox "El Numero de Fanfold no es Valido", vbExclamation, MsgTit
    Else
        Call Inicializo_Campos_para_Autorizar
        If glngNro_Fanfold_Anterior <> CLng(txtNro_Fanfold.text) Then
            gbolCambio_Manual_Nro_Fanfold = True
            txtNro_Fanfold.BackColor = &HFF&
            txtNro_Fanfold.ForeColor = &HFFFF&
        Else
            gbolCambio_Manual_Nro_Fanfold = False
            txtNro_Fanfold.BackColor = &HFFFFFF
            txtNro_Fanfold.ForeColor = &H80000008
        End If
    End If
End If

End Sub

    
Private Sub txtObs_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtObs").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtObs").solicitar_datos = "S"
    End If

End Sub

Private Sub txtObs_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtObs").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
            
    stbAyuda.Panels(1).text = "Ingrese la Observación del Documento"
    Call Color_Control_Seleccionado(Me, txtObs)
    Call MarcarTexto(txtObs)
    
End Sub

Private Sub txtObs_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    
    If KeyCode = vbKeyReturn Then
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            'Si es exportacion vamos a la clausula de venta
            If D!exportacion = "S" And Not CBool(Buscar_Configuracion_Variables_Documento_B(val(txtCodDoc.text), "FACTURA_EXPORTACION_ZONAFRANCA")) Then
                txtClauVta.SetFocus
            Else
                If TxtContrato_Externo.visible = False Then
                    If txtTarea_Codigo_Documento.visible = False Then
                        
                        ' AIR 20210609 se agrega control porque puede estar no visible
                        If txtVendedor.visible = False Then
                            TxtLector.SetFocus
                        Else
                            txtVendedor.SetFocus
                        End If
                    Else
                        txtTarea_Codigo_Documento.SetFocus
                    End If
                Else
                    TxtContrato_Externo.SetFocus
                End If
                DoEvents
            End If
        Else
            MsgBox "Código de Documento No Existe en el Sistema. Verifique por favor...", vbInformation, MsgTit
        End If
    End If
    

End Sub

Private Sub txtObs_LostFocus()

'    lbolPide_Dato_Manual = False

End Sub

Private Sub TxtPais_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtPais").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtPais").solicitar_datos = "S"
    End If

End Sub

Private Sub txtPais_GotFocus()
    
    If Trim(txtPais.text) = "" Then
        txtPais.text = "330 Uruguay/UY"
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtPais").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Pais de Destino"
    Call Color_Control_Seleccionado(Me, txtPais)
    Call MarcarTexto(txtPais)
    
End Sub

Private Sub txtPais_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtViaTransporte.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If txtCajas.visible Then
            txtCajas.SetFocus
        Else
        
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            End If
            If Trim(D!mueve_merca_serv) = "S" Then
                
                If sspDatos_Contrato.visible Then
                    txtContrato.SetFocus
                Else
                    dbgLineas_Servicios.Enabled = True
                    dbgLineas_Servicios.SetFocus
                    dbgLineas_Servicios.Col = 0
                End If
            Else
                If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                    If TxtLector.visible Then
                        TxtLector.SetFocus
                    Else
                        If dbgLineas_Servicios.visible Then
                            dbgLineas_Servicios.Enabled = True
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = 0
                        End If
                    End If
                Else
                    If TxtFactor.visible Then
                        TxtFactor.SetFocus
                    Else
                        If dbgLineas_Servicios.visible Then
                            dbgLineas_Servicios.Enabled = True
                            dbgLineas_Servicios.SetFocus
                            dbgLineas_Servicios.Col = 0
                        End If
                    End If
                End If
            End If
            
        End If
    End If
End Sub

Private Sub txtPais_LostFocus()
'    lbolPide_Dato_Manual = False
End Sub

Private Sub txtRemito_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtRemito").solicitar_datos = "S"
    End If

End Sub

Private Sub txtRemito_GotFocus()
    
    If Trim(txtRemito.text) = "" Then
        txtRemito.text = "0"
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtRemito").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Número de Remito"
    Call Color_Control_Seleccionado(Me, txtRemito)
    Call MarcarTexto(txtRemito)
    
End Sub

Private Sub txtRemito_KeyDown(KeyCode As Integer, Shift As Integer)
Dim D As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtGuia.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
    
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        End If
        
        If Trim(D!mueve_merca_serv) = "S" Then
    
            dbgLineas_Servicios.Enabled = True
            dbgLineas_Servicios.SetFocus
            dbgLineas_Servicios.Col = 0
        
        Else
    
            If txtCajas.visible = True And txtCajas.Enabled = True Then
                txtCajas.SetFocus
            Else
                If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                    If TxtLector.visible Then
                        TxtLector.SetFocus
                    Else
                        If txtContrato.visible Then
                            txtContrato.SetFocus
                        End If
                    End If
                Else
                    If TxtFactor.visible Then
                        TxtFactor.SetFocus
                    Else
                        If txtContrato.visible Then
                            txtContrato.SetFocus
                        End If
                    End If
                End If
            End If
            
        End If
    End If

End Sub

Private Sub txtRedondeo_GotFocus()
    txtRedondeo.SelLength = Len(txtRedondeo.text)
End Sub

Private Sub txtRedondeo_KeyDown(KeyCode As Integer, Shift As Integer)
    
    If KeyCode = vbKeyReturn Then
       If Not IsNumeric(txtRedondeo.text) Then
          MsgBox "Error...debe ser Numerico", vbInformation, MsgTit
          txtRedondeo.SetFocus
       End If
    End If
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If

End Sub

Private Sub Calculo_Total_Lineas_Mercaderia(lGrilla As VSFlexGrid, pbolHabilitar_Boton_Guardar As Boolean)
On Error GoTo Errores
Dim lSumaImporte As Double
Dim lSumaImporteSinIVA As Double
Dim lrow As Long

Dim lclsItemImpuesto As New clsImpuesto
Dim lcolImpuestos As New colImpuestos

Dim lclsItemImpuestoActuales As New clsImpuesto
Dim lcolImpuestosOrdenados As New colImpuestos

Dim lclsItemCofis_x_Iva As New clsCofis_x_Iva
Dim lcolCofis_x_Iva As New colCofis_x_Iva

Dim lclsItemCofis_x_Iva_Ordenados As New clsCofis_x_Iva
Dim lcolCofis_x_Iva_Ordenados As New colCofis_x_Iva

Dim lbolEncontre As Boolean

Dim B As Recordset
Dim ldblPorcentaje_TBromatologica As Double
Dim ldblImporte_TBromatologica As Double

Dim llngCantidad_Lineas As Long
    
    Set lcolCofis_x_Iva = Nothing
    Set lcolCofis_x_Iva_Ordenados = Nothing
    
    lSumaImporte = 0
    lSumaImporteSinIVA = 0
    llngCantidad_Lineas = 0
        
    For i = 1 To lGrilla.Rows - 1
        
        If lGrilla.TextMatrix(i, CGL_CODIGO) <> "" And lGrilla.TextMatrix(i, CGL_IMPORTE) <> "" And lGrilla.TextMatrix(i, CGL_IMPORTE) <> "0" Then
            
            ' Sumo los Totales
            
            lSumaImporte = lSumaImporte + CDbl(lGrilla.TextMatrix(i, CGL_IMPORTE))
            lSumaImporteSinIVA = lSumaImporteSinIVA + CDbl(lGrilla.TextMatrix(i, CGL_IMPORTE_SIN_IVA))
            
            ' Doy de Alta el Valor del IVA y el COFIS del IVA
            lbolEncontre = False
            For Each lclsItemCofis_x_Iva In lcolCofis_x_Iva
                If lclsItemCofis_x_Iva.cod_iva = lGrilla.TextMatrix(i, CGL_TIVA) Then
                    lbolEncontre = True
                    lclsItemCofis_x_Iva.importe_cofis = lclsItemCofis_x_Iva.importe_cofis + lGrilla.TextMatrix(i, CGL_IMPORTE_COFIS)
                    lclsItemCofis_x_Iva.importe_iva = lclsItemCofis_x_Iva.importe_iva + lGrilla.TextMatrix(i, CGL_IMPORTE_IVA)
                    lclsItemCofis_x_Iva.importe_sin_impuestos = lclsItemCofis_x_Iva.importe_sin_impuestos + lGrilla.TextMatrix(i, CGL_IMPORTE_SIN_IVA)
                End If
            Next
            If Not lbolEncontre Then
                lcolCofis_x_Iva.Add lGrilla.TextMatrix(i, CGL_TIVA), lGrilla.TextMatrix(i, CGL_TCOFIS_IVA), lGrilla.TextMatrix(i, CGL_IMPORTE_IVA), lGrilla.TextMatrix(i, CGL_IMPORTE_COFIS), lGrilla.TextMatrix(i, CGL_COFIS), lGrilla.TextMatrix(i, CGL_IVA), lGrilla.TextMatrix(i, CGL_IMPORTE_SIN_IVA)
            End If
            
            llngCantidad_Lineas = llngCantidad_Lineas + 1
        End If
    Next i
        
    ' Coloco la Cantidad de Lineas de la Grilla
    sspCantidad_Lineas.Caption = Format(llngCantidad_Lineas, 0)

    ' Ordeno los Impuestos
    For Each lclsItemImpuestoActuales In gcolImpuestos_Actuales
    
        For Each lclsItemCofis_x_Iva In lcolCofis_x_Iva
            If lclsItemImpuestoActuales.cod_impuesto = lclsItemCofis_x_Iva.cod_iva Then
                lcolCofis_x_Iva_Ordenados.Add lclsItemCofis_x_Iva.cod_iva, lclsItemCofis_x_Iva.cod_cofis, lclsItemCofis_x_Iva.importe_iva, lclsItemCofis_x_Iva.importe_cofis, lclsItemCofis_x_Iva.porcentaje_cofis, lclsItemCofis_x_Iva.porcentaje_iva, lclsItemCofis_x_Iva.importe_sin_impuestos
            End If
        Next
    
    Next
    
    ' Cargo Grilla de Impuestos
    
    vsfImpuestos.Rows = 1
    
    For Each lclsItemCofis_x_Iva_Ordenados In lcolCofis_x_Iva_Ordenados
    
        vsfImpuestos.Rows = vsfImpuestos.Rows + 1
    
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_PORCENTAJE_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.porcentaje_iva, "0.00")
        
        ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
        
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IMPORTE_SIN_IMPUESTOS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_sin_impuestos, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_COFIS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        ' JE 20180829       / Se formatea ahora a 4 decimales porque sino da diferencia en el calculo del IVA para eFactura cuando hay muchas lineas
'        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, "0.0000")
        
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_CODIGO_IVA) = lclsItemCofis_x_Iva_Ordenados.cod_iva
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_PORCENTAJE_COFIS) = Porcentaje_Impuesto_Vigente("COFIS_TIVA", lclsItemCofis_x_Iva_Ordenados.cod_iva, CDate(txtFec_Doc.text))
    Next
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
    
    
    txtTotal_Lineas.text = Format(lSumaImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    txtTotal_Lineas_Sin_Impuestos.text = Format(lSumaImporteSinIVA, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
    ' Calculo Importe de la Tasa Bromatologica
    
    ldblImporte_TBromatologica = 0
    If val(txtTasa_Bromatologica.text) > 0 Then
        If Busco_Tipo_Tasa_Bromatologica(txtTasa_Bromatologica.text, B) Then
            ldblPorcentaje_TBromatologica = Porcentaje_Tasa_Bromatologica_Vigente(B!codigo, CDate(txtFec_Doc.text), B)
            ldblImporte_TBromatologica = lSumaImporteSinIVA * ldblPorcentaje_TBromatologica / 100
            txtTBromatologica_Importe_SIVA.text = lSumaImporteSinIVA
        Else
            ldblPorcentaje_TBromatologica = 0
            ldblImporte_TBromatologica = 0
            txtTBromatologica_Importe_SIVA.text = 0
        End If
    End If
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
    txtImporte_TBromatologica.text = Format(ldblImporte_TBromatologica, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
    Call Calculo_Total_Calculado(pbolHabilitar_Boton_Guardar)
    
Exit Sub
Errores:
    
    
End Sub


Private Sub Calculo_Total_Lineas_Servicios(lGrilla As SSDBGrid, pbolHabilitar_Boton_Guardar As Boolean)
Dim lSumaImporte As Double
Dim lSumaImporteSinIVA As Double
Dim lrow As Long

Dim lclsItemImpuesto As New clsImpuesto
Dim lcolImpuestos As New colImpuestos

Dim lclsItemImpuestoActuales As New clsImpuesto
Dim lcolImpuestosOrdenados As New colImpuestos

Dim lclsItemCofis_x_Iva As New clsCofis_x_Iva
Dim lcolCofis_x_Iva As New colCofis_x_Iva

Dim lclsItemCofis_x_Iva_Ordenados As New clsCofis_x_Iva
Dim lcolCofis_x_Iva_Ordenados As New colCofis_x_Iva

Dim lbolEncontre As Boolean
Dim B As Recordset
    
    Set lcolCofis_x_Iva = Nothing
    Set lcolCofis_x_Iva_Ordenados = Nothing
    
    lSumaImporte = 0
    lSumaImporteSinIVA = 0
    
    lrow = lGrilla.Row
    lMarca = lGrilla.Bookmark
    
    lGrilla.MoveFirst
    For i = 0 To lGrilla.Rows - 1
        DoEvents
        If lGrilla.Columns("importe").text <> "" And lGrilla.Columns("importe").text <> "0" And lGrilla.Columns("eliminada").Value = False Then ' AIR 20180815 se agrega la condicion de eliminada para que no se tomen en cuenta
            
            ' Sumo los Totales
            
            lSumaImporte = lSumaImporte + CDbl(lGrilla.Columns("importe").text)
            lSumaImporteSinIVA = lSumaImporteSinIVA + CDbl(lGrilla.Columns("importe_sin_iva").text)
            
            ' Doy de Alta el Valor del IVA y el COFIS del IVA
            lbolEncontre = False
            For Each lclsItemCofis_x_Iva In lcolCofis_x_Iva
                If lclsItemCofis_x_Iva.cod_iva = lGrilla.Columns("tiva").Value Then
                    lbolEncontre = True
                    lclsItemCofis_x_Iva.importe_sin_impuestos = lclsItemCofis_x_Iva.importe_sin_impuestos + CDbl(lGrilla.Columns("importe_sin_iva").text)
                    lclsItemCofis_x_Iva.importe_cofis = lclsItemCofis_x_Iva.importe_cofis + lGrilla.Columns("importe_cofis").Value
                    lclsItemCofis_x_Iva.importe_iva = lclsItemCofis_x_Iva.importe_iva + lGrilla.Columns("importe_iva").Value
                End If
            Next
            If Not lbolEncontre Then
                lcolCofis_x_Iva.Add lGrilla.Columns("tiva").Value, lGrilla.Columns("tcofis_iva").Value, lGrilla.Columns("importe_iva").Value, lGrilla.Columns("importe_cofis").Value, lGrilla.Columns("cofis").Value, lGrilla.Columns("iva").Value, lGrilla.Columns("importe_sin_iva").Value
            End If
            
        End If
        lGrilla.MoveNext
    Next i
    If lrow < 0 Then
        lGrilla.Row = lGrilla.Rows
    Else
        lGrilla.Row = lrow
    End If
    
    ' Coloco la Cantidad de Lineas de la Grilla
    sspCantidad_Lineas.Caption = Format(lGrilla.Rows, "0")
    
    lGrilla.Bookmark = lMarca
    
    ' Ordeno los Impuestos
    For Each lclsItemImpuestoActuales In gcolImpuestos_Actuales
    
        For Each lclsItemCofis_x_Iva In lcolCofis_x_Iva
            If lclsItemImpuestoActuales.cod_impuesto = lclsItemCofis_x_Iva.cod_iva Then
                lcolCofis_x_Iva_Ordenados.Add lclsItemCofis_x_Iva.cod_iva, lclsItemCofis_x_Iva.cod_cofis, lclsItemCofis_x_Iva.importe_iva, lclsItemCofis_x_Iva.importe_cofis, lclsItemCofis_x_Iva.porcentaje_cofis, lclsItemCofis_x_Iva.porcentaje_iva, lclsItemCofis_x_Iva.importe_sin_impuestos
            End If
        Next
    
    Next
    
    ' Cargo Grilla de Impuestos
    vsfImpuestos.Rows = 1
    
    For Each lclsItemCofis_x_Iva_Ordenados In lcolCofis_x_Iva_Ordenados
    
        vsfImpuestos.Rows = vsfImpuestos.Rows + 1
    
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_PORCENTAJE_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.porcentaje_iva, "0.00")
        
        ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
        
'        If esEFactura(Val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
'            vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IMPORTE_SIN_IMPUESTOS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_sin_impuestos, "0.00")
'            vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_COFIS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_cofis, "0.00")
'            vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, "0.00")
'        Else
'            If Val(txtMoneda.text) <> gMoneda_Base Then
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IMPORTE_SIN_IMPUESTOS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_sin_impuestos, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_COFIS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_cofis, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'            Else
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IMPORTE_SIN_IMPUESTOS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_sin_impuestos, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_COFIS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_cofis, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'                vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'            End If
'        End If
        
        
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IMPORTE_SIN_IMPUESTOS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_sin_impuestos, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_COFIS) = Format(lclsItemCofis_x_Iva_Ordenados.importe_cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_IVA) = Format(lclsItemCofis_x_Iva_Ordenados.importe_iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_CODIGO_IVA) = lclsItemCofis_x_Iva_Ordenados.cod_iva
        vsfImpuestos.TextMatrix(vsfImpuestos.Rows - 1, CGI_PORCENTAJE_COFIS) = Porcentaje_Impuesto_Vigente("COFIS_TIVA", lclsItemCofis_x_Iva_Ordenados.cod_iva, CDate(txtFec_Doc.text))
    Next
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
'    If esEFactura(Val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
'        txtTotal_Lineas.text = Format(lSumaImporte, "0.00")
'        txtTotal_Lineas_Sin_Impuestos.text = Format(lSumaImporteSinIVA, "0.00")
'    Else
'        If Val(txtMoneda.text) <> gMoneda_Base Then
'            txtTotal_Lineas.text = Format(lSumaImporte, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'            txtTotal_Lineas_Sin_Impuestos.text = Format(lSumaImporteSinIVA, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'        Else
'            txtTotal_Lineas.text = Format(lSumaImporte, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'            txtTotal_Lineas_Sin_Impuestos.text = Format(lSumaImporteSinIVA, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'        End If
'    End If
    
    txtTotal_Lineas.text = Format(lSumaImporte, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
    txtTotal_Lineas_Sin_Impuestos.text = Format(lSumaImporteSinIVA, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
    
    
    ' Calculo Importe de la Tasa Bromatologica
    
    ldblImporte_TBromatologica = 0
    If val(txtTasa_Bromatologica.text) > 0 Then
        If Busco_Tipo_Tasa_Bromatologica(txtTasa_Bromatologica.text, B) Then
            ldblPorcentaje_TBromatologica = Porcentaje_Tasa_Bromatologica_Vigente(B!codigo, CDate(txtFec_Doc.text), B)
            ldblImporte_TBromatologica = lSumaImporteSinIVA * ldblPorcentaje_TBromatologica / 100
            txtTBromatologica_Importe_SIVA.text = lSumaImporteSinIVA
        Else
            ldblPorcentaje_TBromatologica = 0
            ldblImporte_TBromatologica = 0
            txtTBromatologica_Importe_SIVA.text = 0
        End If
    End If
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
    txtImporte_TBromatologica.text = Format(ldblImporte_TBromatologica, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
    Call Calculo_Total_Calculado(pbolHabilitar_Boton_Guardar)

End Sub


Private Sub Calculo_Total_Calculado(pbolHabilitar_Boton_Guardar As Boolean)
On Error GoTo Errores
Dim lTotal_Lineas As Double
Dim lTotal_Impuestos As Double
Dim lBromatologia As Double


    If Trim(txtTotal_Lineas_Sin_Impuestos.text) <> "" Then
        lTotal_Lineas = CDbl(txtTotal_Lineas_Sin_Impuestos.text)
    Else
        lTotal_Lineas = 0
    End If
    
    lTotal_Impuestos = 0
    
    For i = 1 To vsfImpuestos.Rows - 1
        If vsfImpuestos.TextMatrix(i, CGI_COFIS) <> 0 Then
            lTotal_Impuestos = lTotal_Impuestos + vsfImpuestos.TextMatrix(i, CGI_COFIS)
        End If
        If vsfImpuestos.TextMatrix(i, CGI_IVA) <> 0 Then
            'lTotal_Impuestos = lTotal_Impuestos + vsfImpuestos.TextMatrix(i, CGI_IVA)
            lTotal_Impuestos = lTotal_Impuestos + Format(vsfImpuestos.TextMatrix(i, CGI_IVA), f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))    'SS 20190128
        End If
    Next i
    
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
         lTotal_Impuestos = lTotal_Impuestos + val(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE_IADIC))
    Next
    
    
    
    If IsNumeric(txtImporte_TBromatologica.text) Then
        lBromatologia = CDbl(txtImporte_TBromatologica.text)
    Else
        lBromatologia = 0
    End If
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas

'    If esEFactura(Val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
'        txtTotal_Calculado.text = Format((lTotal_Lineas + lTotal_Impuestos + lBromatologia), "#####0.00")
'    Else
'        If Val(txtMoneda.text) <> gMoneda_Base Then
'            txtTotal_Calculado.text = Format((lTotal_Lineas + lTotal_Impuestos + lBromatologia), f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'        Else
'            txtTotal_Calculado.text = Format((lTotal_Lineas + lTotal_Impuestos + lBromatologia), f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'        End If
'    End If
    
    txtTotal_Calculado.text = Format((lTotal_Lineas + lTotal_Impuestos + lBromatologia), f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
    DoEvents
    
    ' JE 20200824   /   Cambio aqui por >1
    'If vsfLineas_Mercaderia.Rows > 2 Then
    
    
  '  If vsfLineas_Mercaderia.Rows > 1 Then
        Call Calculo_Total_Documento(pbolHabilitar_Boton_Guardar)
  '  End If
Exit Sub
Errores:

    Call FErrores
    
End Sub

Private Sub Calculo_Total_Documento(pbolHabilitar_Boton_Guardar As Boolean)
On Error GoTo Errores

Dim R As Recordset
Dim lRedondeo_Moneda_Base As String
Dim lRedondeo_Otra_Moneda As String

    ' AIR 20190509 se agrega la consulta a la configuracion del documento para evaluar si se toma la config del documento o la configuracion de las variables globales
    lRedondeo_Moneda_Base = "C"
    lRedondeo_Otra_Moneda = "C"

    If Trim(txtTotal_Calculado.text) = "" Then
        txtTotal_Calculado.text = Format(0, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    End If
    ' AIR 20190509
    If Buscar_Tipo_Documento(val(txtCodDoc.text), R) Then
        lRedondeo_Moneda_Base = R!Redondeo_Moneda_Base
        lRedondeo_Otra_Moneda = R!Redondeo_Otra_Moneda
    End If
    
    If val(txtMoneda.text) = gMoneda_Base Then
        If lRedondeo_Moneda_Base = "C" Then
            If ConfPuntoVta_Redondeo_Total_Documento_Pesos Then
                txtImporte.text = Round(txtTotal_Calculado.text, 0)
            Else
                txtImporte.text = txtTotal_Calculado.text
            End If
        Else
            ' AIR 20190509
            If lRedondeo_Moneda_Base = "S" Then
                txtImporte.text = Round(txtTotal_Calculado.text, 0)
            Else
                txtImporte.text = txtTotal_Calculado.text
            End If
        End If
    End If
    
    If val(txtMoneda.text) <> gMoneda_Base Then
        If lRedondeo_Otra_Moneda = "C" Then
            If ConfPuntoVta_Redondeo_Total_Documento_Otras_Monedas Then
                 txtImporte.text = Round(txtTotal_Calculado.text, 0)
             Else
                 txtImporte.text = txtTotal_Calculado.text
             End If
        Else
            ' AIR 20190509
            If lRedondeo_Otra_Moneda = "S" Then
                 txtImporte.text = Round(txtTotal_Calculado.text, 0)
             Else
                 txtImporte.text = txtTotal_Calculado.text
             End If
        End If
    End If
    
    ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas

'    If esEFactura(Val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
'        txtImporte.text = Format(txtImporte.text, "0.00")
'    Else
'        If Val(txtMoneda.text) <> gMoneda_Base Then
'            txtImporte.text = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
'        Else
'            txtImporte.text = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
'        End If
'    End If
    
    txtImporte.text = Format(txtImporte.text, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
    DoEvents
    txtRedondeo.text = Format(CDbl(NullToZero(txtImporte.text)) - CDbl(NullToZero(txtTotal_Calculado.text)), "0.00")
    DoEvents
    
    If Trim(UCase(sspOperacion.Caption)) = "C" Then
        cmdGuardar.Enabled = False
    Else
        If pbolHabilitar_Boton_Guardar Then
            If Controlar_Ingreso_Medios_Pago Then
                cmdGuardar.Enabled = True
            Else
                cmdGuardar.Enabled = False
            End If
        Else
            cmdGuardar.Enabled = False
        End If
    End If
Exit Sub
Errores:
    Call FErrores
    
End Sub

Private Function Calculo_Unidades_Ingresadas_x_Articulo(llngCod_Prod As Long, llngFila As Long) As Double
    
    Calculo_Unidades_Ingresadas_x_Articulo = 0
    
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
        If llngFila <> i Then
            If vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO) = llngCod_Prod Then
                Calculo_Unidades_Ingresadas_x_Articulo = Calculo_Unidades_Ingresadas_x_Articulo + vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)
            End If
        End If
    Next i
    
End Function

Private Sub Calculo_Total_Medios_Pago(pbolHabilitar_Boton_Guardar As Boolean)
Dim lTotal_Medios_Pago As Double
Dim ldblTipo_Cambio_Rec As Double
Dim ldblImporte_X_Medio As Double
Dim ldblImporte As Double
Dim R As Recordset
  
    lTotal_Medios_Pago = 0
    ldblImporte = 0
    ldblImporte_X_Medio = 0
    For i = 1 To vsfMedios_Pagos.Rows - 1
'ATU 23/03/2016
'Se suman el total de los medios de pago recibidos, pero NO el cambio, para mantener controles y compatibilidad

        If Busco_Medios_Pago(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)), R) Then
        
            If Trim(R!tipo_dev_cambio <> "CAMBIO") Then
        
                If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TC)) = "" Then
                    ldblTipo_Cambio_Rec = val(txtTipo_Cambio.text)
                Else
                    ldblTipo_Cambio_Rec = val(vsfMedios_Pagos.TextMatrix(i, CGMP_TC))
                End If
                
                If val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Then
                
                    '#####################################################
                    'Si la moneda de la factura es DIFERENTE a la moneda recibida
                    '#####################################################
                    If val(txtMoneda.text) <> val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
                        'Si la Factura es en $
                        If val(txtTipo_Cambio.text) = 1 Then
                            ''Tomamos el tipo de cambio de la moneda recibida
                            
                            'ldblTipo_Cambio_Rec = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), Val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
                            
                            If ldblTipo_Cambio_Rec = 0 Then
                                ldblTipo_Cambio_Rec = 1
                            End If
                            ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) * ldblTipo_Cambio_Rec
                        Else
                            'ldblTipo_Cambio_Rec es el tipo de cambio de la factura
                            ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) / ldblTipo_Cambio_Rec
                        End If
                    Else
                        '
                        ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                    End If
                
                    lTotal_Medios_Pago = lTotal_Medios_Pago + ldblImporte_X_Medio
                    
                End If
            End If
        End If
    Next i
    
    If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
        txtTotal_Medios_Pago.text = Format(lTotal_Medios_Pago, "#####0.00")
    Else
        If val(txtMoneda.text) <> gMoneda_Base Then
            txtTotal_Medios_Pago.text = Format(lTotal_Medios_Pago, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
        Else
            txtTotal_Medios_Pago.text = Format(lTotal_Medios_Pago, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
        End If
    End If
    
    DoEvents
    
    ldblCambio = 0

    If IsNumeric(txtImporte.text) Then
        ldblCambio = CDbl(txtTotal_Medios_Pago.text) - CDbl(txtImporte.text)
    End If

    If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
        txtCambio.text = Format(ldblCambio, "#####0.00")
    Else
        If val(txtMoneda.text) <> gMoneda_Base Then
            txtCambio.text = Format(ldblCambio, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
        Else
            txtCambio.text = Format(ldblCambio, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
        End If
    End If
    
    DoEvents
    
    If pbolHabilitar_Boton_Guardar Then
        If Trim(UCase(sspOperacion.Caption)) = "C" Then
            cmdGuardar.Enabled = False
        Else
            If CDbl(txtCambio.text) < 0 Then
                cmdGuardar.Enabled = False
            Else
                If Controlar_Ingreso_Medios_Pago Then
                    cmdGuardar.Enabled = True
                Else
                    cmdGuardar.Enabled = False
                End If
            End If
        End If
    End If
    
    
End Sub

Private Function Calculo_Total_Medios_Pago_SIN_DEVOLUCION(plngMedioPago As Long)
Dim lTotal_Medios_Pago As Double
Dim ldblTipo_Cambio_Rec As Double
Dim ldblImporte_X_Medio As Double
Dim ldblImporte As Double
Dim R As Recordset
    Calculo_Total_Medios_Pago_SIN_DEVOLUCION = 0
    lTotal_Medios_Pago = 0
    ldblImporte = 0
    ldblImporte_X_Medio = 0
    For i = 1 To vsfMedios_Pagos.Rows - 1
    
        If vsfMedios_Pagos.Col = CGMP_IMPORTE And Trim(vsfMedios_Pagos.EditText) = "+" Then
            vsfMedios_Pagos.EditText = ""
        End If
        
        
        If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TC)) = "" Then
            ldblTipo_Cambio_Rec = val(txtTipo_Cambio.text)
        Else
            ldblTipo_Cambio_Rec = val(vsfMedios_Pagos.TextMatrix(i, CGMP_TC))
        End If
        
        If val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Or val(vsfMedios_Pagos.EditText) <> 0 Then
            ' AIR 20190514 se comenta porque es necesario que convierta a la moneda correcta el monto del importe en el medio de pago en el cual estoy parado que no lo hace en la rutina que llama a esta
            If Busco_Medios_Pago(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO), R) Then  'AIR 20190514 And vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) <> plngMedioPago Then
                If Trim(R!tipo_dev_cambio) <> "PUEDE_DEVOLVER" Then
                    '#####################################################
                    'Si la moneda de la factura es DIFERENTE a la moneda recibida
                    '#####################################################
                    If val(txtMoneda.text) <> val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
                        'Si la Factura es en $
                        If val(txtTipo_Cambio.text) = 1 Then
                            ''Tomamos el tipo de cambio de la moneda recibida
                            
                            'ldblTipo_Cambio_Rec = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), Val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
                            
                            If ldblTipo_Cambio_Rec = 0 Then
                                ldblTipo_Cambio_Rec = 1
                            End If
                            If vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) = plngMedioPago Then 'AIR 20190514
                                ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.EditText)) = "", 0, CDbl(vsfMedios_Pagos.EditText))) * ldblTipo_Cambio_Rec
                            Else
                                ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) * ldblTipo_Cambio_Rec
                            End If
                        Else
                            If vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) = plngMedioPago Then 'AIR 20190514
                                ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.EditText)) = "", 0, CDbl(vsfMedios_Pagos.EditText))) / ldblTipo_Cambio_Rec
                            Else
                                'ldblTipo_Cambio_Rec es el tipo de cambio de la factura
                                ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) / ldblTipo_Cambio_Rec
                            End If
                        End If
                    Else
                        If vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) = plngMedioPago Then 'AIR 20190514
                            ldblImporte_X_Medio = CDbl(IIf(val(vsfMedios_Pagos.EditText) = "0", 0, val(vsfMedios_Pagos.EditText)))
                        Else
                            ldblImporte_X_Medio = CDbl(IIf(val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) = "0", 0, val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                        End If
                    End If
                    
                    lTotal_Medios_Pago = lTotal_Medios_Pago + ldblImporte_X_Medio
                End If
            End If
        End If
    Next i

Calculo_Total_Medios_Pago_SIN_DEVOLUCION = lTotal_Medios_Pago
    
End Function

Public Sub Calcular_Importes_de_la_Linea_Mercaderia(llngRow As Long, pMantener_Precio_Digitado As Boolean, pbolHabilitar_Boton_Guardar As Boolean, Optional pbooHabilita_dtos_prec_Mailing As Boolean = True)
On Error GoTo Errores
Dim L As Recordset
Dim e As Recordset
Dim lValorIva As Double
Dim lImp_Cofis As Double
Dim lImp_Iva As Double
Dim lPrecioUnitConDto As Double
Dim lPrecioUnitSImpConDto As Double
Dim lImporteSinIVA As Double
Dim lImporte As Double
Dim lDescuento_Maximo As Double
Dim lLista_Minimo As Long
Dim lPrecio_Minimo As Double
Dim ldblDescuento_x_Volumen As Double
Dim lbolTiene_Descuento_x_Volumen As Boolean
Dim pstrLista As String

    lImp_Cofis = 0
    lImp_Iva = 0
    lPrecioUnitConDto = 0
    lImporteSinIVA = 0
    lImporte = 0
    lbolTiene_Descuento_x_Volumen = False
    
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Exit Sub
    End If
    
    If Not IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) Then
        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1) = Format(0, "#0.00")
    End If
    If Not IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) Then
        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2) = Format(0, "#0.00")
    End If
    If Not IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3)) Then
        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3) = Format(0, "#0.00")
    End If
    
    
    If Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_CODIGO)) <> "" Then
    
            If ConfPuntoVta_Usar_Descuentos_x_Volumen Then
                ' JE 20180315   /   Se revisa nuevamente si tiene descuento por volumen este articulo para dejar el Precio Unitario (Despues del calcularlo con el Dto 1)
                '                   con el valor redondeado a 2 decimales como esta en el Mant. de Precios por volumen.
                '                   Se hace esto asi aqui adentro, porque debe ser chequeado linea a linea ya que esta funcion se llama desde varios lugares
                
                ' JE 20250708   /   Estaba mal aqui val(vsfLineas_Mercaderia.TextMatrix(lRow, CGL_UNIDADES)) y  val(vsfLineas_Mercaderia.TextMatrix(lRow, CGL_UNIDADES_MAGNITUD))
                lbolTiene_Descuento_x_Volumen = Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_CODIGO)), val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES_MAGNITUD)), val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_MAGNITUD)), ldblDescuento_x_Volumen)
                If Not lbolTiene_Descuento_x_Volumen Then
                    If val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) = 0 Then
                         vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1) = Format(ldblDescuento_x_Volumen, "#0.00")
                    End If
                Else
                    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1) = Format(ldblDescuento_x_Volumen, "#0.00")
                End If
                
            End If
    
    
            If pMantener_Precio_Digitado = False And UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 Then
                ' Se controla que el Precio final no sea menor al Precio de la lista Minima
            
                If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
                    lLista_Minimo = L!lista_precio_minimo
                End If
            End If
            
            If ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET" Then         'Precio para venta faccionada   SS 20170320
            
                If CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES)) < 1 Then
                    If (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO)) * CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES))) - Int(CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO)) * CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES))) <> 0 Then
                        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO) = Format(CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO)) + 1, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                End If
            End If
            
            If confUsaEquivalenciaMagnitudes Then
                lPrecioUnitConDto = CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO_MAGNITUD))
            Else
                lPrecioUnitConDto = CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO))
            End If
            
            
            '-----------------------------------  DESCUENTO  GLOBAL  -----------------------------------------
            
            If Trim(txtDtoGlobal.text) <> "" Then
                If IsNumeric(txtDtoGlobal.text) Then
                    lPrecioUnitConDto = lPrecioUnitConDto * (1 - (txtDtoGlobal.text) / 100)
                End If
            End If
            
            'AIR 20221004 se agrega control de dscto distinto de 0 (cero)
            
            If CDbl(NullToZero(txtDtoGlobal.text)) <> 0 And pMantener_Precio_Digitado = False And UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 Then
                If Not Control_Precio_Minimo(lLista_Minimo, CDbl(txtDtoGlobal.text), llngRow, lPrecioUnitConDto, lPrecio_Minimo, lDescuento_Maximo) Then
                    If pMantener_Precio_Digitado = False Then
                        lPrecioUnitConDto = lPrecio_Minimo
                    End If
                End If
            End If
            
            '-------------------------------------  DESCUENTO  1  --------------------------------------------
            
            If Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) <> "" Then
                If IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) Then
                    lPrecioUnitConDto = lPrecioUnitConDto * (1 - (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) / 100))
                    If lbolTiene_Descuento_x_Volumen Then
                        ' JE 20180315   /   Si el % aplicado es un Descuento por Volumen, entonces ajusto el Precio Unitario a 2 decimales
                        '                   que es lo mismo que hace el Mant. de Descuentos por volumen, y asi tener el mismo Precio en ambos lugares
                        lPrecioUnitConDto = Format(lPrecioUnitConDto, "0.00")
                    End If
                End If
            End If
            
            'AIR 20221004 se agrega control de dscto distinto de 0 (cero)
            If CDbl(NullToZero(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1))) <> 0 And pMantener_Precio_Digitado = False And UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 Then
                If Not Control_Precio_Minimo(lLista_Minimo, CDbl(txtDtoGlobal.text), llngRow, lPrecioUnitConDto, lPrecio_Minimo, lDescuento_Maximo) Then
                    If pMantener_Precio_Digitado = False Then
                        lPrecioUnitConDto = lPrecio_Minimo
                    End If
                    If lDescuento_Maximo > CDbl(txtDtoGlobal.text) Then
                         pstrLista = Trim(DtoGeneralLista) & ";"
                         pstrLista = pstrLista & Trim(txtDtoGlobal.text) & ";"
                         pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) & ";"
                         pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3))
                        lDescuento_Maximo = CalculoDtoFinal(lDescuento_Maximo, CalculoDtoTotal(pstrLista))
                    Else
                        lDescuento_Maximo = 0
                    End If
                    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1) = Format(lDescuento_Maximo, "0.00")
                    
                End If
            End If
            
            '-------------------------------------  DESCUENTO  2  --------------------------------------------
            
            If Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) <> "" Then
                If IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) Then
                    lPrecioUnitConDto = lPrecioUnitConDto * (1 - (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) / 100))
                End If
            End If
            
            'AIR 20221004 se agrega control de dscto distinto de 0 (cero)
            If CDbl(NullToZero(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2))) <> 0 And pMantener_Precio_Digitado = False And UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 Then
                If Not Control_Precio_Minimo(lLista_Minimo, CDbl(txtDtoGlobal.text), llngRow, lPrecioUnitConDto, lPrecio_Minimo, lDescuento_Maximo) Then
                    If pMantener_Precio_Digitado = False Then
                        lPrecioUnitConDto = lPrecio_Minimo
                    End If
                    If lDescuento_Maximo > CDbl(txtDtoGlobal.text) Then
                        pstrLista = Trim(DtoGeneralLista) & ";"
                        pstrLista = pstrLista & Trim(txtDtoGlobal.text) & ";"
                        pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) & ";"
                        pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3))
                        lDescuento_Maximo = CalculoDtoFinal(lDescuento_Maximo, CalculoDtoTotal(pstrLista))
                    Else
                        lDescuento_Maximo = 0
                    End If
                    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2) = Format(lDescuento_Maximo, "0.00")
                    
                End If
            End If
            
            '-------------------------------------  DESCUENTO  3  --------------------------------------------
            
            
            If Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3)) <> "" Then
                If IsNumeric(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3)) Then
                    lPrecioUnitConDto = lPrecioUnitConDto * (1 - (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3)) / 100))
                End If
            End If
            
            'AIR 20221004 se agrega control de dscto distinto de 0 (cero)
            If CDbl(NullToZero(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3))) <> 0 And pMantener_Precio_Digitado = False And UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 Then
                If Not Control_Precio_Minimo(lLista_Minimo, CDbl(txtDtoGlobal.text), llngRow, lPrecioUnitConDto, lPrecio_Minimo, lDescuento_Maximo) Then
                    If pMantener_Precio_Digitado = False Then
                        lPrecioUnitConDto = lPrecio_Minimo
                    End If
                    If lDescuento_Maximo > CDbl(txtDtoGlobal.text) Then
                        pstrLista = Trim(DtoGeneralLista) & ";"
                        pstrLista = Trim(txtDtoGlobal.text) & ";"
                        pstrLista = Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) & ";"
                        pstrLista = Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2))
                        lDescuento_Maximo = CalculoDtoFinal(lDescuento_Maximo, CalculoDtoTotal(pstrLista))
                    Else
                        lDescuento_Maximo = 0
                    End If
                    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3) = Format(lDescuento_Maximo, "0.00")
                    
                End If
            End If
            
            '-------------------------------------  FIN DESCUENTOS  --------------------------------------------
            
            If Not pbooHabilita_dtos_prec_Mailing Then
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1) = Format(0, "0.00")
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2) = Format(0, "0.00")
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3) = Format(0, "0.00")
            End If
            
        
            
            pstrLista = Trim(DtoGeneralLista) & ";"
            pstrLista = pstrLista & Trim(txtDtoGlobal.text) & ";"
            pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO1)) & ";"
            pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO2)) & ";"
            pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_DTO3))
            lDescuento_Maximo = CalculoDtoTotal(pstrLista)
           
            
            If confUsaEquivalenciaMagnitudes Then
                  lPrecioUnitConDto = CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO_MAGNITUD)) * (1 - (lDescuento_Maximo / 100))
            Else
                  lPrecioUnitConDto = CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO)) * (1 - (lDescuento_Maximo / 100))
            End If
            
            ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
            lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            If Not confUsaEquivalenciaMagnitudes Then
                lImporte = lPrecioUnitConDto * CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES))
            Else
                lImporte = lPrecioUnitConDto * CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES_MAGNITUD))
            End If
            
            ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
            lImporte = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            'Se redondea el precio con descuento, tomando la parte entera   SS 20170320
            If ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET" Then
                lImporte = Int(lImporte)
            End If
            
            If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                lImp_Iva = lImporte - (lImporte / (1 + (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IVA)) / 100)))
                
                ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
                'lImp_Iva = Format(lImp_Iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
                
                ' JE 20180829   /   Dejo ahora en 4 decimales el IVA para que no de diferente con eFactura cuando son muchas lineas
                lImp_Iva = Format(lImp_Iva, "0.0000")
                
                lImp_Cofis = 0
                
                lPrecioUnitSImpConDto = lPrecioUnitConDto / (1 + (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IVA)) / 100))
            
                ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas
                lPrecioUnitSImpConDto = Format(lPrecioUnitSImpConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
                lImporteSinIVA = lImporte - lImp_Iva - lImp_Cofis
            
                ' JE 20180707   /   Se comenta esto porque ahora se usa la configuracion de las variables de Precio Unitario Segun moneda
                If confUsaEquivalenciaMagnitudes Then
                    lPrecioUnitConDto = lPrecioUnitConDto '* Val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES_MAGNITUD))
                Else
                    lPrecioUnitConDto = lPrecioUnitConDto '* Val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES))
                End If
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO_CON_DTO) = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIOSIMP_CON_DTO) = Format(lPrecioUnitSImpConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
            Else
                lImp_Iva = lImporte * (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IVA)) / 100)
                
                ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
                'lImp_Iva = Format(lImp_Iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
                
                ' JE 20180829   /   Dejo ahora en 4 decimales el IVA para que no de diferente con eFactura cuando son muchas lineas
                lImp_Iva = Format(lImp_Iva, "0.0000")
                
                lImp_Cofis = 0

                lPrecioUnitSImpConDto = lPrecioUnitConDto
                
                ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas
                lPrecioUnitSImpConDto = Format(lPrecioUnitSImpConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                lPrecioUnitConDto = lPrecioUnitSImpConDto * (1 + (CDbl(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IVA)) / 100))
                
                ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas
                lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                
                
                If confUsaEquivalenciaMagnitudes Then
                    lPrecioUnitConDto = lPrecioUnitConDto * vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES_MAGNITUD)
                Else
                    lPrecioUnitConDto = lPrecioUnitConDto * vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES)
                End If
                   ' JE 20180709   /   Se configura la cantidad de Decimales segun Configuracion y con la funcion f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIO_CON_DTO) = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIOSIMP_CON_DTO) = Format(lPrecioUnitSImpConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                lImporteSinIVA = lImporte

            End If
            
    End If
    
    ' JE 20180707   /   Configuro los Decimales segun configuracion por Monedas de los Importes
    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE) = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_COFIS) = Format(lImp_Cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))

    ' JE 20180829   /   Dejo ahora en 4 decimales el IVA para que no de diferente con eFactura cuando son muchas lineas
'    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_IVA) = Format(lImp_Iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(Val(txtCodDoc.text), Val(txtMoneda.text)))
    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_IVA) = Format(lImp_Iva, "0.0000")
    
  '  vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_SIN_IVA) = Format(lImporteSinIVA, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
  ' AIR 20240812 /   Dejo ahora en 4 decimales el IVA para que no de diferente con eFactura cuando son muchas lineas
      vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_SIN_IVA) = Format(lImporteSinIVA, "0.0000")
    
    vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_IMPORTE_IADIC) = Round(lImporteSinIVA * val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_TIADIC)) / 100, 2)
                   
        
    If val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES)) <> 0 Then
        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIOSIMP) = Format(lImporteSinIVA / val(vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_UNIDADES)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    Else
        vsfLineas_Mercaderia.TextMatrix(llngRow, CGL_PUNITARIOSIMP) = Format(lImporteSinIVA, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    End If
    
    vsfLineas_Mercaderia.Cell(flexcpBackColor, llngRow, CGL_PUNITARIO_CON_DTO) = &HFFFF&
    vsfLineas_Mercaderia.Cell(flexcpForeColor, llngRow, CGL_PUNITARIO_CON_DTO) = &H80000008
    vsfLineas_Mercaderia.Cell(flexcpFontBold, llngRow, CGL_PUNITARIO_CON_DTO) = False
    
    vsfLineas_Mercaderia.Cell(flexcpBackColor, llngRow, CGL_PUNITARIOSIMP_CON_DTO) = &HFFFF&
    vsfLineas_Mercaderia.Cell(flexcpForeColor, llngRow, CGL_PUNITARIOSIMP_CON_DTO) = &H80000008
    vsfLineas_Mercaderia.Cell(flexcpFontBold, llngRow, CGL_PUNITARIOSIMP_CON_DTO) = False
    
    vsfLineas_Mercaderia.Cell(flexcpBackColor, llngRow, CGL_IMPORTE) = &HFF&
    vsfLineas_Mercaderia.Cell(flexcpForeColor, llngRow, CGL_IMPORTE) = &HFFFFFF
    vsfLineas_Mercaderia.Cell(flexcpFontBold, llngRow, CGL_IMPORTE) = True
    
    vsfLineas_Mercaderia.Cell(flexcpBackColor, llngRow, CGL_IMPORTE_SIN_IVA) = &HFF&
    vsfLineas_Mercaderia.Cell(flexcpForeColor, llngRow, CGL_IMPORTE_SIN_IVA) = &HFFFFFF
    vsfLineas_Mercaderia.Cell(flexcpFontBold, llngRow, CGL_IMPORTE_SIN_IVA) = True
    
    
    Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, pbolHabilitar_Boton_Guardar)
Exit Sub
Errores:

End Sub

Private Sub txtRemito_LostFocus()
Dim D As Recordset
Dim lstrFiltros As String

On Error Resume Next

    If Not gbolESC Then
    
        If Trim(txtRemito.text) <> "" Then
        
            If IsNumeric(txtRemito.text) Then

                ' Chequeo si existe el documento
                
                If Not Busco_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtDoc_Remito.text), val(txtRemito.text)) Then
                    gbolESC = True
                    MsgBox "Documento NO Existente. Verifique por Favor", vbExclamation + vbOKOnly
                    txtRemito.SetFocus
                Else
                    If val(txtCodProv.text) <> rstCabezales_Documentos!Cod_Prov Then
                        gbolESC = True
                        MsgBox "El Documento a Afectar No Pertenece al Cliente Ingresado", vbInformation, MsgTit
                        txtRemito.SetFocus
                    Else
                        ' Verifico si tiene saldo a cancelar
                        If Saldo_A_Cancelar_de_un_Documento(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtRemito.text), val(txtCodProv.text), val(txtMoneda.text)) <= 0 Then
                            gbolESC = True
                            MsgBox "Documento " & Trim(txtDoc_Afectado.text) & "/" & Trim(txtRemito.text) & "  Ya esta Cancelado Totalmente. Verifique.. ", vbExclamation + vbOKOnly
                            txtRemito.SetFocus
                        End If
                    End If
                End If
            Else
                gbolESC = True
                MsgBox "El Número del Documento a Afectar debe ser numérico", vbInformation, MsgTit
                txtRemito.SetFocus
            End If
        Else
            If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                If Trim(UCase(D!documento_afectado_obligatorio)) = "S" Then
                    gbolESC = True
                    MsgBox "El Número del Tipo de Documento a Afectar No Puede Ser Vacio", vbInformation, MsgTit
                    txtRemito.SetFocus
                End If
            Else
                gbolESC = True
                MsgBox "El Código del Documento No existe en el Sistema. Verifique....", vbInformation, MsgTit
                txtDoc_Afectado.SetFocus
            End If
        
        
        End If
    End If

End Sub

Private Sub TxtRuc_Click()
 

    If lcolCampos.Count > 10 Then
        lcolCampos("TxtRuc").solicitar_datos = "S"
    End If

End Sub

Private Sub TxtRuc_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtRuc").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    gTxtRuc_original = TxtRuc.text
    
    stbAyuda.Panels(1).text = "Ingrese el RUT/CI del Cliente"
    Call Color_Control_Seleccionado(Me, TxtRuc)
    Call MarcarTexto(TxtRuc)

End Sub

Private Sub TxtRuc_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        TxtCodSuc.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyUp Then
       txtNomCli.SetFocus
    End If

End Sub

Private Sub TxtRuc_LostFocus()

Dim C As Recordset
Dim D As Recordset
Dim rstD As Recordset
Dim lrstDocumentos As Recordset
Dim lrsClientes As Recordset
Dim llngNuevo_Cliente As Long
Dim llngBoton_x_Defecto As Long
Dim pbooAltaCliente As Boolean
Dim pintReult As Integer
Dim TxtRutCi As String


    On Error GoTo Errores


    
    pbooAltaCliente = False
    
    
    If Trim(TxtRuc.text) <> "" Then
        TxtRuc.text = LimpioString(TxtRuc.text)
   
        If IsNumeric(TxtRuc.text) Then
       
           If Not Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocumentos) Then
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "No se Pudo Inicializar la Configuracion del Documento. Verifique por favor...", vbInformation, MsgTit
                TxtRuc.SetFocus
                Exit Sub
            End If
       
            ' JE 20170407   Si es un RUT Valido / Coloco txtTipo_Doc_Identidad.txt = 2
            'AIR 20231420 se quita esta variable que habia sido agregada y genera un comportamiento erroneo en el punto de vta , es para el mant. de clientes.
            'If Validar_RUT(TxtRuc.text) And Not ConfMan_Clientes_Verifica_RUT_Extranjero_Deja_Seguir Then
            If Validar_RUT(TxtRuc.text) Then
                txtTipo_Doc_Identidad.text = 2
                glngTipo_Documento_Identidad = 2
            ElseIf Validar_CI_Uruguay(TxtRuc.text) Then
                txtTipo_Doc_Identidad.text = 3
                glngTipo_Documento_Identidad = 3
            Else
                If txtTipo_Doc_Identidad.text = 2 Or txtTipo_Doc_Identidad.text = 3 Or Trim(txtTipo_Doc_Identidad.text) = "" Then
                    txtTipo_Doc_Identidad.text = 4
                    glngTipo_Documento_Identidad = 4
                End If
            End If
       
            Select Case val(txtTipo_Doc_Identidad.text)
           
                Case 2  ' RUT Uruguay
               
                    TxtCFinal.text = ""
                    If val(TxtRuc.text) <> 0 Then
                        If Not Validar_RUT(TxtRuc.text) Then
                            gbolESC = True
                            gbooErrorRobot = True
                            MsgBox "ERROR: EL RUT Ingresado No es Válido. Verifique...", vbCritical + vbOKOnly
                            TxtRuc.SetFocus
                        Else
                            If Trim(TxtCodSuc.text) = "" Then
                                TxtCodSuc.text = 0
                            End If
                            
                            'AIR 20231103 no es valido este control cuando la instalacion permite distintos clientes con el mismo RUT
                            'AIR 20240320 cambio el control a: si el recordset devuelve mas de 1 registro no se cambia el cliente porque queda indefinido cual utilizar.
                            'AIR 20240405 se evita el control si es un resguardo ya que lo ingresado es un proveedor
                            If ConfMan_Clientes_Controla_RUT_Deja_Seguir = False And ConfFormato_Factura <> "BSGIMENEZ" And ConfFormato_Factura <> "CASINO-POS" And ConfFormato_Factura <> "CASINO" And lrstDocumentos!tipo_doc <> "G" Then
                                If Busco_Cliente_x_RUT(TxtRuc.text, D) Then
                                    If txtCodProv.text <> D!nro_cli And D.RecordCount = 1 Then
                                        txtCodProv.text = D!nro_cli
                                        Call txtCodProv_LostFocus
                                        Exit Sub
                                    End If
                                Else
                                    If confCodigo_Cliente_RUT_Generico <> 0 Then
                                        If Buscar_Cliente(val(txtCodProv.text), C) Then
                                            If Trim(UCase(C!generico)) = "S" And txtCodProv.text <> confCodigo_Cliente_RUT_Generico Then
                                                TxtRutCi = TxtRuc.text
                                                txtCodProv.text = confCodigo_Cliente_RUT_Generico
                                                Call txtCodProv_LostFocus
                                                 txtTipo_Doc_Identidad.text = 2
                                                TxtRuc.text = TxtRutCi
                                            End If
                                        End If
                                    End If
                                        
                                End If
                            End If
                                                        
                            If lrstDocumentos!tipo_doc <> "G" Then                          'para resguardos no aplica    SS 20160408
                                If Buscar_Cliente(val(txtCodProv.text), C) Then
                                    'If (Trim(C!generico) = "N" Or IsNull(C!generico)) And Trim(ConfFormato_Factura) <> "CASINO-POS" Then  'AIR 20191105 se agrega contol para Casino que dio problemas con cambios de RUT que no debe pasar
                                   
                                    If (Trim(C!generico) = "N" Or IsNull(C!generico)) Then  'AIR 20200306 se quita el hardcodeo para Casino, se utiliza la variable de configuracion para controlar la modificacion
                                        'AIR 20191021 se agrega parametro que define si se de permite o no actualizar el RUT
                                        If Trim(C!ruc_cli) <> Trim(TxtRuc.text) And ConfPuntoVta_Permite_Actualizar_RUT_Cliente Then        'clte NO generico con cambio en su RUT
                                            Call PreguntarYesNo("Actualiza el RUT del Cliente en la Ficha?", -1)
                                            If gintYesNo = vbYes Then
                                                If Not Actualizar_CI_o_RUT(TxtRuc.text, "RUT", val(txtCodProv.text), "C") Then
                                                    gbolESC = True
                                                    gbooErrorRobot = True
                                                    MsgBox "ERROR: EL RUT Ingresado No se pudo Actualizar en el Cliente. Verifique...", vbCritical + vbOKOnly
                                                    TxtRuc.SetFocus
                                                Else
                                                    txtCodProv.SetFocus
                                                End If
                                            End If
                                        End If
                                    Else
                                        'AIR 20200306 se agrega el control de si se permite modificar la ficha ya que en Casino NO se permite bajo ningun concepto
                                        If Trim(C!rsocial_cli) <> Trim(txtNomCli.text) And ConfPuntoVta_Permite_Actualizar_RUT_Cliente Then 'clte GENERICO con cambio en su nombre
                                            If Not Busco_Cliente_x_RUT(Trim(TxtRuc.text), lrsClientes) Then
                                                If ConfPuntoVta_Permite_Alta_En_Clientes Then                       ' SS 20151120
                                                   If ConfPuntoVta_Permite_Alta_En_Clientes_Valor_x_Defecto Then
                                                       llngBoton_x_Defecto = vbDefaultButton1
                                                   Else
                                                       llngBoton_x_Defecto = vbDefaultButton2
                                                   End If
                                                   pbooAltaCliente = False
                                                   'Sleep (500)
                                                   Call PreguntarYesNo("Alta del Cliente en la Ficha?", llngBoton_x_Defecto)
                                                   If gintYesNo = vbYes Then
                                                       pbooAltaCliente = True
                                                       If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                                           If lcolCampos("txtNomCli").pide_autorizacion = "S" Then
                                                               If Not Autorizacion_Supervision(38, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                                   pbooAltaCliente = False
                                                               End If
                                                           End If
                                                       End If
                                                       If pbooAltaCliente Then
                                                           If Not Alta_Clientes_Automatico(True, Trim(txtNomCli.text), Trim(TxtRuc.text), "R", val(txtCodDoc.text), llngNuevo_Cliente, 0, 1, 1, 0, 0, 0, "", "", Trim(txtNomCli.text), "", "", "", "", "", "", "", "") Then
                                                               gbolESC = True
                                                               gbooErrorRobot = True
                                                               MsgBox "ERROR: NO se dio de alta el cliente en la Ficha a partir del RUT", vbCritical + vbOKOnly
                                                               TxtRuc.SetFocus
                                                           Else
                                                               pbooAltaCliente = True
                                                               txtCodProv.text = llngNuevo_Cliente
                                                           End If
                                                       End If
                                                   End If
                                                End If
                                            Else
                                                txtCodProv.text = lrsClientes!nro_cli
                                                txtCodProv.SetFocus
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                        'jch 31.07.2024 controla que el cliente no tenga el mismo rut que la empresa
                        If Buscar_Tipo_Documento(CLng(Me.txtCodDoc.text), rstD) Then
                        End If
                        
                        If Trim(txtTipo_Doc_Identidad.text) = "2" And Trim(rstD!tipo_doc) = "E" Then
                            If Not Control_Empresa_Cliente_RUT(CLng(txtEmpresa.text), TxtRuc.text) Then
                                gbolESC = True
                                gbooErrorRobot = True
                                txtCodProv.text = ""
                                TxtRuc.text = ""
                                txtNomCli.text = ""
                                DoEvents
                                txtCodProv.SetFocus
                                Exit Sub
                            End If
                        End If
                    End If
               
                Case 3  ' CI Uruguay
               
                    TxtCFinal.text = "X"
                    If Not Validar_CI_Uruguay(TxtRuc.text) Then
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "ERROR: LA CI Ingresada No es Válida. Verifique...", vbCritical + vbOKOnly
                        TxtRuc.SetFocus
                    Else
                        If Trim(TxtCodSuc.text) = "" Then
                            TxtCodSuc.text = 0
                        End If
                        
                        'AIR 20231103 no es valido este control cuando la instalacion tienen distintos clientes con el mismo RUT
                        'AIR 20240405 cambio el control a: si el recordset devuelve mas de 1 registro no se cambia el cliente porque queda indefinido cual utilizar.
                        'AIR 20240405 se evita el control si es un resguardo ya que lo ingresado es un proveedor
                        If ConfMan_Clientes_Controla_RUT_Deja_Seguir = False And ConfFormato_Factura <> "CASINO-POS" And ConfFormato_Factura <> "CASINO" And Trim(lrstDocumentos!tipo_doc) <> "G" Then
                            If Busco_Cliente_x_CI(TxtRuc.text, D) Then
                                If txtCodProv.text <> D!nro_cli And D.RecordCount = 1 Then
                                    txtCodProv.text = D!nro_cli
                                    Call txtCodProv_LostFocus
                                    Exit Sub
                                End If
                            End If
                        End If
                        If Trim(lrstDocumentos!tipo_doc) <> "G" Then                          'para resguardos no aplica    SS 20160408
                             
                            If Buscar_Cliente(val(txtCodProv.text), C) Then
                                 If Trim(C!generico) = "N" Then
                                   
                                   If Trim(C!ci_contacto) <> Trim(TxtRuc.text) And ConfPuntoVta_Permite_Actualizar_Doc_Identidad_Cliente Then    'clte GENERICO con cambio en su cedula
                                     
                                        Call PreguntarYesNo("Actualiza la C.I. del Cliente en la Ficha?", -1)
                                        If gintYesNo = vbYes Then
                                            If Not Actualizar_CI_o_RUT(TxtRuc.text, "CI", val(txtCodProv.text), "C") Then
                                                gbolESC = True
                                                gbooErrorRobot = True
                                                MsgBox "ERROR: La CI Ingresada No se pudo Actualizar  en el Cliente. Verifique...", vbCritical + vbOKOnly
                                                TxtRuc.SetFocus
                                            Else
                                                txtCodProv.SetFocus
                                            End If
                                        End If
                                   End If
                                Else
                                    ' AIR 20200306 se agrega contol por variable de modificar o no el documento de identidad en el cliente
                                      Call Cargo_Logtrans("grabo Ci 1.1")
                                    If Trim(C!rsocial_cli) <> Trim(txtNomCli.text) And ConfPuntoVta_Permite_Actualizar_Doc_Identidad_Cliente Then  'clte GENERICO con cambio en su nombre
                                         
                                        If Not Busco_Cliente_x_CI(Trim(TxtRuc.text), lrsClientes) Then
                                           
                                            If ConfPuntoVta_Permite_Alta_En_Clientes Then         ' SS 20151120
                                               
                                                If ConfPuntoVta_Permite_Alta_En_Clientes_Valor_x_Defecto Then
                                                    llngBoton_x_Defecto = vbDefaultButton1
                                                Else
                                                    llngBoton_x_Defecto = vbDefaultButton2
                                                End If
                                                 
                                                pbooAltaCliente = False
                                                'Sleep (500)
                                                Call PreguntarYesNo("Alta del Cliente en la Ficha?", llngBoton_x_Defecto)
                                                If gintYesNo = vbYes Then
                                                   pbooAltaCliente = True
                                                   If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                                      If lcolCampos("txtNomCli").pide_autorizacion = "S" Then
                                                         If Not Autorizacion_Supervision(38, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                             pbooAltaCliente = False
                                                         End If
                                                      End If
                                                   End If
                                                End If
                                                If pbooAltaCliente Then
                                                    If Not Alta_Clientes_Automatico(True, Trim(txtNomCli.text), Trim(TxtRuc.text), "C", val(txtCodDoc.text), llngNuevo_Cliente, 0, 1, 1, 0, 0, 0, "", "", Trim(txtNomCli.text), "", "", "", "", "", "", "", "") Then
                                                        gbolESC = True
                                                        gbooErrorRobot = True
                                                        MsgBox "ERROR: NO se dio de alta el cliente en la Ficha a partir del RUT", vbCritical + vbOKOnly
                                                        TxtRuc.SetFocus
                                                    Else
                                                        pbooAltaCliente = True
                                                        txtCodProv.text = llngNuevo_Cliente
                                                    End If
                                                End If
                                             
                                            End If
                                        Else
                                            txtCodProv.text = lrsClientes!nro_cli
                                            txtCodProv.SetFocus
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
               
            End Select
           
        Else
            If val(txtTipo_Doc_Identidad.text) <> 4 Then
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "ERROR: EL RUT Ingresado Debe ser un Número Válido. Verifique...", vbCritical + vbOKOnly
                TxtRuc.SetFocus
            Else
                TxtCFinal.text = "X"
            End If
        End If
    Else
        TxtCFinal.text = "X"
    End If
   
    If val(txtTipo_Doc_Identidad.text) <> 2 And confCodigo_Cliente_Consumo_Final_Generico <> 0 Then
         If Buscar_Cliente(val(txtCodProv.text), C) Then
             If Trim(UCase(C!generico)) = "S" And CLng(txtCodProv.text) <> confCodigo_Cliente_Consumo_Final_Generico Then
                 TxtRutCi = TxtRuc.text
                 txtTipoRucCi = txtTipo_Doc_Identidad.text
                 txtCodProv.text = confCodigo_Cliente_Consumo_Final_Generico
                 Call txtCodProv_LostFocus
                 txtTipo_Doc_Identidad.text = txtTipoRucCi
                 TxtRuc.text = TxtRutCi
                 Exit Sub
             End If
         End If
    End If
   
   
   
    Exit Sub

'    lbolPide_Dato_Manual = False


Errores:
     gbooErrorRobot = True
     Call Cargo_Logtrans(Err.Description)

End Sub

Private Sub txtSeccion_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Código de la Moneda"
    If Trim(txtSeccion.text) = "" Then
        txtSeccion.text = 0
    End If
    Call Color_Control_Seleccionado(Me, txtSeccion)
    Call MarcarTexto(txtSeccion)
End Sub


Private Sub txtSeccion_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        TxtFactor.SetFocus
    End If
    
    If KeyCode = vbKeyF1 Then
        GForm = Me.Name
        GTipoBusc = "secciones"
        GCampoBusqueda = "cabezal"
        gbolESC = True
        whereSelCamG = ""
        frmBusquedas.Show
    End If
End Sub

Private Sub txtTarea_Codigo_Documento_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtTarea_Codigo_Documento").solicitar_datos = "S"
    End If

End Sub

Private Sub txtTarea_Codigo_Documento_GotFocus()

    If Trim(txtTarea_Codigo_Documento.text) = "" Then
        txtTarea_Codigo_Documento.text = ""
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtTarea_Codigo_Documento").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Código de Documento de la Tarea"
    Call Color_Control_Seleccionado(Me, txtTarea_Codigo_Documento)
    Call MarcarTexto(txtTarea_Codigo_Documento)

End Sub

Private Sub txtTarea_Codigo_Documento_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
         If txtTarea_Numero.visible And txtTarea_Numero.Enabled Then    'agrega if por visible  SS 20180321
             txtTarea_Numero.SetFocus
         Else
            If txtObs.visible And txtObs.Enabled Then
                txtObs.SetFocus
            End If
         End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtTarea_Numero").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(32, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtTarea_Codigo_Documento.Locked = False
                End If
            Else
                txtTarea_Codigo_Documento.Locked = False
            End If
        End If
    End If

End Sub

Private Sub txtTarea_Codigo_Documento_LostFocus()
Dim D As Recordset

    If Not gbolESC Then
        If Trim(txtTarea_Codigo_Documento.text) <> "" Then
            If Not IsNumeric(txtTarea_Codigo_Documento.text) Then
                gbolESC = True
                MsgBox "El Código de Documento de La Tarea debe ser un número válido", vbInformation, MsgTit
                txtTarea_Codigo_Documento.SetFocus
            Else
                If Buscar_Tipo_Documento(val(txtTarea_Codigo_Documento.text), D) Then
                   If Trim(UCase(D!tipo_doc)) = "U" Then
                   Else
                        gbolESC = True
                        MsgBox "El Tipo de Documento Ingresado No esta Definido como Tarea", vbInformation, MsgTit
                        txtTarea_Codigo_Documento.SetFocus
                    End If
                Else
                    gbolESC = True
                    MsgBox "El Tipo de Documento Ingresado No esta Definido. Verifique por Favor...", vbInformation, MsgTit
                    txtTarea_Codigo_Documento.SetFocus
                End If
            End If
        End If
    End If

End Sub

Private Sub txtTarea_Numero_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtTarea_Numero").solicitar_datos = "S"
    End If

End Sub

Private Sub txtTarea_Numero_GotFocus()
    
    If Trim(txtTarea_Numero.text) = "" Then
        txtTarea_Numero.text = ""
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtTarea_Numero").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Número de Tarea"
    Call Color_Control_Seleccionado(Me, txtTarea_Numero)
    Call MarcarTexto(txtTarea_Numero)

End Sub

Private Sub txtTarea_Numero_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then               ' SS 20151006
        If txtVendedor.visible And txtVendedor.Enabled Then 'agrega if por visible  SS 20180321
            txtVendedor.SetFocus
        Else
            txtObs.SetFocus
            DoEvents
        End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtTarea_Numero_KeyDown").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(33, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtTarea_Numero.Locked = False
                End If
            Else
                txtTarea_Numero.Locked = False
            End If
        End If
    End If

End Sub

Private Sub txtTarea_Numero_LostFocus()
Dim DC As Recordset

    If Not gbolESC Then
        If Trim(txtTarea_Numero.text) <> "" Then
            If IsNumeric(txtTarea_Numero.text) Then
                If Not Buscar_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtTarea_Codigo_Documento.text), val(txtTarea_Numero.text), DC) Then
                    gbolESC = True
                    MsgBox "Tarea NO Existente. Verifique por Favor", vbExclamation + vbOKOnly
                    txtTarea_Numero.SetFocus
                 End If
            Else
                gbolESC = True
                MsgBox "La Tarea debe ser un número válido", vbInformation, MsgTit
                txtTarea_Numero.SetFocus
            End If
        Else
            If Trim(txtTarea_Codigo_Documento.text) <> "" Then
                gbolESC = True
                MsgBox "Debe ingresar un Número Válido de Tarea ya que ingresó un Código de Documento de la Tarea", vbInformation, MsgTit
                txtTarea_Numero.SetFocus
            End If
        End If
    End If

End Sub

Private Sub TxtTCofis_GotFocus()
    Call Color_Control_Seleccionado(Me, TxtTCofis)
    Call MarcarTexto(TxtTCofis)
End Sub

Private Sub TxtTCofis_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyEscape Then

        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyUp Then
        txtVendedor.SetFocus
    End If
    
    If KeyCode = vbKeyReturn Then
        TxtFactor.text = ""
        If Trim(gstrUnidades_x_Defecto) <> "" Then
            TxtFactor.text = val(gstrUnidades_x_Defecto)
        End If
        TxtFactor.SetFocus
        DoEvents
    End If
    
End Sub


Private Sub TxtTCofis_LostFocus()
    
    TxtTCofis.text = UCase(TxtTCofis.text)
    If Trim(TxtTCofis.text) <> "S" And Trim(TxtTCofis.text) <> "N" Then
        gbolESC = True
        MsgBox "Valores Posibles S o N", vbInformation, MsgTit
        TxtTCofis.SetFocus
    End If

End Sub


Private Sub txtTipo_Cambio_Click()

    If lcolCampos.Count > 10 Then
        lcolCampos("txtTipo_Cambio").solicitar_datos = "S"
    End If
    
End Sub

Private Sub txtTipo_Cambio_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtTipo_Cambio").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Tipo de Cambio del Documento"
    Call Color_Control_Seleccionado(Me, txtTipo_Cambio)
    Call MarcarTexto(txtTipo_Cambio)

End Sub

Private Sub txtTipo_Cambio_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtMoneda.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtDtoGlobal.SetFocus
        DoEvents
    End If
    
    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("txtTipo_Cambio").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(3, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtTipo_Cambio.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtTipo_Cambio.Locked = False
            End If
        End If
    End If
    
End Sub

Private Sub txtTipo_Cambio_LostFocus()
    
    If Not gbolESC Then
        If Trim(txtTipo_Cambio.text) <> "" Then
            If IsNumeric(txtTipo_Cambio.text) Then
                txtTipo_Cambio.text = Format(txtTipo_Cambio.text, "###0.000")
                Call Inicializo_Campos_para_Autorizar
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Tipo de Cambio debe ser un Número Válido", vbInformation, MsgTit
                txtTipo_Cambio.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Tipo de Cambio No Puede Ser Nulo", vbInformation, MsgTit
            txtTipo_Cambio.SetFocus
        End If
    End If

'    lbolPide_Dato_Manual = False

End Sub

Private Sub txtTipo_Doc_Identidad_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtTipo_Doc_Identidad").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtTipo_Doc_Identidad").solicitar_datos = "S"
    End If

End Sub

Private Sub txtTipo_Doc_Identidad_GotFocus()
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtTipo_Doc_Identidad").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Seleccione el Tipo de Documento de Identificación"
    Call Color_Control_Seleccionado(Me, txtTipo_Doc_Identidad)
    Call MarcarTexto(txtTipo_Doc_Identidad)
    
End Sub

Private Sub txtTipo_Doc_Identidad_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtNomCli.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        ' AIR por veicuer
        
        If TxtRuc.visible And TxtRuc.Enabled Then
            TxtRuc.SetFocus
        Else
            TxtCodSuc.SetFocus
            
        End If
    End If

End Sub

Private Sub txtTipo_Doc_Identidad_LostFocus()
'    lbolPide_Dato_Manual = False

    If Not gbolESC Or gPtoVenta_Robot Then
        If UCase(Trim(sspOperacion.Caption)) = "A" Then     'Aplico codigo IVA segun condicion de RUT   SS 20190527
            If Not gbolCargo_Desde_Preventa Then
                
                Screen.MousePointer = vbHourglass
                Call f_esperar(8)
                Call Actualizo_Precios_de_Articulos_de_la_Grilla
                Unload frmMensaje_Esperar
                Screen.MousePointer = vbDefault
                
            End If
        End If
    End If
    
    glngTipo_Documento_Identidad = val(txtTipo_Doc_Identidad.text)
    
End Sub

Private Sub TxtVendedor_Click()
    If lcolCampos.Count > 10 Then
        lcolCampos("TxtVendedor").solicitar_datos = "S"
    End If

End Sub

Private Sub TxtVendedor_GotFocus()
On Error Resume Next

    If Trim(txtVendedor.text) = "" Then
        txtVendedor.text = 0
    End If
    'ATU, Parche para veicuer, quieren que se ponga SI O SI el vendedor
    If ConfFormato_Factura = "VEICUER" And txtVendedor.text = 0 Then
        txtVendedor.text = ""
        TxtNomVen.text = ""
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        txtVendedor.Locked = f_paso_S_N_a_Boolean(lcolCampos("TxtVendedor").bloqueado)
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtVendedor").solicitar_datos = "N" Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    
    stbAyuda.Panels(1).text = "Ingrese el Código de Vendedor - 0=No Asignado"
    Call Color_Control_Seleccionado(Me, txtVendedor)
    Call MarcarTexto(txtVendedor)


End Sub

Private Sub TxtVendedor_KeyDown(KeyCode As Integer, Shift As Integer)

    gbolESC = False
        If KeyCode = vbKeyUp Then
        txtObs.SetFocus
    End If

    If KeyCode = vbKeyEscape Then
        
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If
        
        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        
        If txtGuia.visible Then
            txtGuia.SetFocus
        Else
            If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                If TxtLector.visible Then
                    TxtLector.SetFocus
                Else
                    If dbgLineas_Servicios.visible Then
                        dbgLineas_Servicios.Enabled = True
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = 0
                    End If
                End If
            Else
                If TxtFactor.visible Then
                    TxtFactor.SetFocus
                Else
                    If dbgLineas_Servicios.visible Then
                        dbgLineas_Servicios.Enabled = True
                        dbgLineas_Servicios.SetFocus
                        dbgLineas_Servicios.Col = 0
                    End If
                End If
            End If
        End If
        
        DoEvents
    End If
    
    If KeyCode = vbKeyF1 Then
        If Not txtVendedor.Locked Then
            GForm = Me.Name
            GTipoBusc = "vendedores"
            gbolESC = True
            whereSelCamG = "activo='S'"     'Controlo por vendedor activo   SS 20181213
            frmBusquedas.Show
        End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("TxtVendedor").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(5, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    txtVendedor.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                txtVendedor.Locked = False
            End If
        End If
    End If

End Sub

Private Sub TxtVendedor_LostFocus()
Dim R As Recordset
On Error GoTo Errores
    If Not gbolESC Then
        If Trim(txtVendedor.text) <> "" Then
            If IsNumeric(txtVendedor.text) Then
                If ConfPuntoVta_Controla_Vendedor Then
                    ' Se controla que si o si El Documento tenga un Vendedor Asociado
                    If val(txtVendedor.text) = 0 Then
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "Debe Ingresar un Vendedor al Documento.", vbInformation, MsgTit
                        txtVendedor.SetFocus
                        Exit Sub
                    End If
                End If
                    
                If Buscar_Vendedor(txtVendedor.text, R) Then
                    If R!Activo = "S" Then
                        TxtNomVen.text = Trim(IIf(IsNull(R!nom_ven), " ", R!nom_ven) & " " & IIf(IsNull(R!ape_ven), " ", R!ape_ven))
                        Call Inicializo_Campos_para_Autorizar
                    Else
                        gbolESC = True
                        gbooErrorRobot = True
                        MsgBox "Vendedor  " & txtVendedor.text & "  No esta Activo. Verifique por Favor", vbInformation, MsgTit
                        txtVendedor.SetFocus
                    End If
                Else
                    gbolESC = True
                    gbooErrorRobot = True
                    MsgBox "Vendedor Inexistente. Verifique por Favor", vbInformation, MsgTit
                    txtVendedor.SetFocus
                End If
            Else
                gbolESC = True
                gbooErrorRobot = True
                MsgBox "El Código del Vendedor debe ser un Número Valido", vbInformation, MsgTit
                txtVendedor.SetFocus
            End If
        Else
            gbolESC = True
            gbooErrorRobot = True
            MsgBox "El Código del Vendedor No Puede Ser Nulo", vbInformation, MsgTit
            txtVendedor.SetFocus
        End If
    End If
Exit Sub
Errores:
    gbooErrorRobot = True
    Exit Sub
End Sub


Sub Inicializo_Grilla_Lineas_Mercaderia()
Dim e As Recordset
Dim D As Recordset
Dim llngRestar As Long
Dim lbolVer_Columna_Procedencia As Boolean
Dim lbolVer_Columna_Tipo_Entrega As Boolean
Dim lbolVer_Columna_Deposito As Boolean

    Screen.MousePointer = vbHourglass
                                                  
    llngRestar = 0
    If ConfPuntoVta_Ver_Columna_Codigo_Sistema_Anterior Then
        llngRestar = llngRestar + 1200
    End If
    If ConfPuntoVta_Ver_Columna_Cajas Then
        llngRestar = llngRestar + 500
    End If
    If ConfPuntoVta_Ver_Columna_IVA Then
        llngRestar = llngRestar + 500
    End If
                                                  
    lbolVer_Columna_Procedencia = False
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        If Trim(UCase(D!facturador_ver_columna_procedencia)) = "S" Then
            lbolVer_Columna_Procedencia = True
            llngRestar = llngRestar + 1000
        End If
    End If
                                                  
    lbolVer_Columna_Tipo_Entrega = False
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        If Trim(UCase(D!facturador_ver_columna_tipo_entrega)) = "S" Then
            lbolVer_Columna_Tipo_Entrega = True
            llngRestar = llngRestar + 1200
        End If
    End If
    
    lbolVer_Columna_Deposito = False
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        If Trim(UCase(D!Facturador_Ver_Columna_Deposito)) = "S" Then
            lbolVer_Columna_Deposito = True
            llngRestar = llngRestar + 1100
            
        End If
    End If
                                                                                                                  
    vsfLineas_Mercaderia.Rows = 1
    vsfLineas_Mercaderia.Rows = vsfLineas_Mercaderia.FixedRows
    vsfLineas_Mercaderia.Cols = CGL_ES_MAILING + 1
    vsfLineas_Mercaderia.FixedCols = 2
    vsfLineas_Mercaderia.ColWidth(0) = 0
    
    
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_CODIGO) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_CODIGO) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_CODIGO) = "Código"
    vsfLineas_Mercaderia.ColWidth(CGL_CODIGO) = 700
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_CODIGO_SANTERIOR) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_CODIGO_SANTERIOR) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_CODIGO_SANTERIOR) = "C.S.Anterior"
    
    If ConfPuntoVta_Ver_Columna_Codigo_Sistema_Anterior Then
        vsfLineas_Mercaderia.ColWidth(CGL_CODIGO_SANTERIOR) = 1200
    Else
        vsfLineas_Mercaderia.ColWidth(CGL_CODIGO_SANTERIOR) = 0
    End If
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_DESCRIPCION) = flexAlignLeftBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DESCRIPCION) = flexAlignLeftBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DESCRIPCION) = "Descripción"
    vsfLineas_Mercaderia.ColWidth(CGL_DESCRIPCION) = 6100 - llngRestar
    
    ' Nueva Columna Agregadas porque vienen desde el movil                    JE 20151203
    vsfLineas_Mercaderia.FixedAlignment(CGL_TIPO_ENTREGA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_TIPO_ENTREGA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_TIPO_ENTREGA) = "T.Entrega"
    vsfLineas_Mercaderia.ColDataType(CGL_TIPO_ENTREGA) = flexDTString
    vsfLineas_Mercaderia.ColWidth(CGL_TIPO_ENTREGA) = 1200
    vsfLineas_Mercaderia.ColComboList(CGL_TIPO_ENTREGA) = String_Tipos_Entrega_para_Combo("'C','T'")
    vsfLineas_Mercaderia.ColHidden(CGL_TIPO_ENTREGA) = Not lbolVer_Columna_Tipo_Entrega
    
    'AIR 20221019 se agrega el control del permiso para ver stock
    If Not Tiene_Permiso_Para_Ver_Stock Then
        vsfLineas_Mercaderia.ColHidden(CGL_STOCK) = True
    End If
        
    
    ' Nueva Columna Agregada                                                    AIR 20171003
    vsfLineas_Mercaderia.FixedAlignment(CGL_DEPOSITO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DEPOSITO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DEPOSITO) = "Depósito"
    vsfLineas_Mercaderia.ColDataType(CGL_DEPOSITO) = flexDTString
    vsfLineas_Mercaderia.ColWidth(CGL_DEPOSITO) = 1300
    vsfLineas_Mercaderia.ColComboList(CGL_DEPOSITO) = String_Depositos_para_Combo
    vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) = Not lbolVer_Columna_Deposito
    
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_CAJAS) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_CAJAS) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_CAJAS) = "Cajas"
    vsfLineas_Mercaderia.ColDataType(CGL_CAJAS) = flexDTLong
    
    If ConfPuntoVta_Ver_Columna_Cajas Then
        vsfLineas_Mercaderia.ColWidth(CGL_CAJAS) = 500
    Else
        vsfLineas_Mercaderia.ColWidth(CGL_CAJAS) = 0
    End If
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_PROCEDENCIA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_PROCEDENCIA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_PROCEDENCIA) = "Procedencia"
    vsfLineas_Mercaderia.ColDataType(CGL_PROCEDENCIA) = flexDTString
    vsfLineas_Mercaderia.ColWidth(CGL_PROCEDENCIA) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_PROCEDENCIA) = Not lbolVer_Columna_Procedencia
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_STOCK) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_STOCK) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_STOCK) = "Stock"
    vsfLineas_Mercaderia.ColDataType(CGL_STOCK) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_STOCK) = 800
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_COFIS) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_COFIS) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_COFIS) = "Cofis"
    vsfLineas_Mercaderia.ColWidth(CGL_COFIS) = 0
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_IVA) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_IVA) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_IVA) = "IVA"

    If ConfPuntoVta_Ver_Columna_IVA Then
        vsfLineas_Mercaderia.ColWidth(CGL_IVA) = 500
    Else
        vsfLineas_Mercaderia.ColWidth(CGL_IVA) = 0
    End If
    
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_IADIC) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_IADIC) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_IADIC) = "I.Adi"
    vsfLineas_Mercaderia.ColDataType(CGL_IADIC) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_IADIC) = 500
        
    vsfLineas_Mercaderia.FixedAlignment(CGL_TIADIC) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_TIADIC) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_TIADIC) = "%I.Ad."
    vsfLineas_Mercaderia.ColWidth(CGL_TIADIC) = 500
    vsfLineas_Mercaderia.ColDataType(CGL_TIADIC) = flexDTDouble
        
    vsfLineas_Mercaderia.FixedAlignment(CGL_IMPORTE_IADIC) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_IMPORTE_IADIC) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_IMPORTE_IADIC) = "Imp.I.Ad."
    vsfLineas_Mercaderia.ColDataType(CGL_IMPORTE_IADIC) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_IMPORTE_IADIC) = 1200
    
    vsfLineas_Mercaderia.ColHidden(CGL_TIADIC) = True
    vsfLineas_Mercaderia.ColHidden(CGL_IADIC) = True
    vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE_IADIC) = True
    
    
    
           
    vsfLineas_Mercaderia.FixedAlignment(CGL_DTO1) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DTO1) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DTO1) = "Dto 1"
    vsfLineas_Mercaderia.ColDataType(CGL_DTO1) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_DTO1) = 700
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_DTO2) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DTO2) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DTO2) = "Dto 2"
    vsfLineas_Mercaderia.ColWidth(CGL_DTO2) = 700
    vsfLineas_Mercaderia.ColDataType(CGL_DTO2) = flexDTDouble
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_DTO3) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DTO3) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DTO3) = "Dto 3"
    vsfLineas_Mercaderia.ColDataType(CGL_DTO3) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_DTO3) = 700
    
    ' AIR 20170517
    If ConfDiseño_Para_Grandes_Cifras = False Then
        vsfLineas_Mercaderia.FixedAlignment(CGL_UNIDADES) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_UNIDADES) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_UNIDADES) = "Unidades"
        vsfLineas_Mercaderia.ColDataType(CGL_UNIDADES) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_UNIDADES) = 1000
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_UNIDADES_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_UNIDADES_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_UNIDADES_MAGNITUD) = "Unidades"
        vsfLineas_Mercaderia.ColDataType(CGL_UNIDADES_MAGNITUD) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_UNIDADES_MAGNITUD) = 1000
               

        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO) = "P.Unitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO) = 1200
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO_MAGNITUD) = "P.Unitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO_MAGNITUD) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO_MAGNITUD) = 1000
        
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIOSIMP) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIOSIMP) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIOSIMP) = "PSUnitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIOSIMP) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIOSIMP) = 1200
    
    
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO_CON_DTO) = "P.U.c/Dto"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO_CON_DTO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO_CON_DTO) = 1200
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIOSIMP_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIOSIMP_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIOSIMP_CON_DTO) = "P.U.c/Dto"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIOSIMP_CON_DTO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIOSIMP_CON_DTO) = 1200
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_IMPORTE) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_IMPORTE) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_IMPORTE) = "Importe"
        vsfLineas_Mercaderia.ColDataType(CGL_IMPORTE) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_IMPORTE) = 1200
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_IMPORTE_SIN_IVA) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_IMPORTE_SIN_IVA) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_IMPORTE_SIN_IVA) = "Importe"
        vsfLineas_Mercaderia.ColDataType(CGL_IMPORTE_SIN_IVA) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_IMPORTE_SIN_IVA) = 1200
    Else
        vsfLineas_Mercaderia.FixedAlignment(CGL_UNIDADES) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_UNIDADES) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_UNIDADES) = "Unidades"
        vsfLineas_Mercaderia.ColDataType(CGL_UNIDADES) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_UNIDADES) = 800
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_UNIDADES_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_UNIDADES_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_UNIDADES_MAGNITUD) = "Unidades"
        vsfLineas_Mercaderia.ColDataType(CGL_UNIDADES_MAGNITUD) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_UNIDADES_MAGNITUD) = 800

        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO) = "P.Unitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO) = 1300
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO_MAGNITUD) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO_MAGNITUD) = "P.Unitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO_MAGNITUD) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO_MAGNITUD) = 1300
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIOSIMP) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIOSIMP) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIOSIMP) = "PSUnitario"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIOSIMP) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIOSIMP) = 1300
    
    
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIO_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIO_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIO_CON_DTO) = "P.U.c/Dto"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIO_CON_DTO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIO_CON_DTO) = 1300
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIOSIMP_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIOSIMP_CON_DTO) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIOSIMP_CON_DTO) = "P.U.c/Dto"
        vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIOSIMP_CON_DTO) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIOSIMP_CON_DTO) = 1300
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_IMPORTE) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_IMPORTE) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_IMPORTE) = "Importe"
        vsfLineas_Mercaderia.ColDataType(CGL_IMPORTE) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_IMPORTE) = 1700
        
        vsfLineas_Mercaderia.FixedAlignment(CGL_IMPORTE_SIN_IVA) = flexAlignRightBottom
        vsfLineas_Mercaderia.ColAlignment(CGL_IMPORTE_SIN_IVA) = flexAlignRightBottom
        vsfLineas_Mercaderia.TextMatrix(0, CGL_IMPORTE_SIN_IVA) = "Importe"
        vsfLineas_Mercaderia.ColDataType(CGL_IMPORTE_SIN_IVA) = flexDTDouble
        vsfLineas_Mercaderia.ColWidth(CGL_IMPORTE_SIN_IVA) = 1500
    
    End If
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_PUNITARIOSINIVA) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_PUNITARIOSINIVA) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_PUNITARIOSINIVA) = "PUnit.S/IVA"
    vsfLineas_Mercaderia.ColDataType(CGL_PUNITARIOSINIVA) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_PUNITARIOSINIVA) = 1000
   
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_PRECIO_ORIGINAL) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_PRECIO_ORIGINAL) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_PRECIO_ORIGINAL) = "POrig"
    vsfLineas_Mercaderia.ColDataType(CGL_PRECIO_ORIGINAL) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_PRECIO_ORIGINAL) = 700
    vsfLineas_Mercaderia.ColHidden(CGL_PRECIO_ORIGINAL) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_PRECIO_MINIMO) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_PRECIO_MINIMO) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_PRECIO_MINIMO) = "PMin"
    vsfLineas_Mercaderia.ColDataType(CGL_PRECIO_MINIMO) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_PRECIO_MINIMO) = 700
    vsfLineas_Mercaderia.ColHidden(CGL_PRECIO_MINIMO) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_DESCUENTO_MAXIMO) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_DESCUENTO_MAXIMO) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_DESCUENTO_MAXIMO) = "DtoMax"
    vsfLineas_Mercaderia.ColDataType(CGL_DESCUENTO_MAXIMO) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_DESCUENTO_MAXIMO) = 700
    vsfLineas_Mercaderia.ColHidden(CGL_DESCUENTO_MAXIMO) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_ES_MAILING) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_ES_MAILING) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_ES_MAILING) = "Es.Mailing"
    vsfLineas_Mercaderia.ColDataType(CGL_ES_MAILING) = flexDTDouble
    vsfLineas_Mercaderia.ColWidth(CGL_ES_MAILING) = 700
    vsfLineas_Mercaderia.ColHidden(CGL_ES_MAILING) = True
    
    
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_MAGNITUD) = flexAlignRightBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_MAGNITUD) = flexAlignRightBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_MAGNITUD) = "C.Mag"
    vsfLineas_Mercaderia.ColDataType(CGL_MAGNITUD) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_MAGNITUD) = 550
   
   
     ' combo de magnituides de un Articulo                    JE 20151203
    vsfLineas_Mercaderia.FixedAlignment(CGL_NOMBRE_MAGNITUD) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_NOMBRE_MAGNITUD) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_NOMBRE_MAGNITUD) = "Mag"
    vsfLineas_Mercaderia.ColDataType(CGL_NOMBRE_MAGNITUD) = flexDTString
    vsfLineas_Mercaderia.ColWidth(CGL_NOMBRE_MAGNITUD) = 500
    vsfLineas_Mercaderia.ColComboList(CGL_NOMBRE_MAGNITUD) = String_Magnituides_para_Combo(-1)
    
    
    
    If confUsaEquivalenciaMagnitudes Then
        vsfLineas_Mercaderia.ColHidden(CGL_UNIDADES) = True
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIO) = True
         vsfLineas_Mercaderia.ColHidden(CGL_MAGNITUD) = True
    Else
        vsfLineas_Mercaderia.ColHidden(CGL_UNIDADES_MAGNITUD) = True
        vsfLineas_Mercaderia.ColHidden(CGL_MAGNITUD) = True
        vsfLineas_Mercaderia.ColHidden(CGL_NOMBRE_MAGNITUD) = True
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIO_MAGNITUD) = True
    End If
    
    ' Oculto las Columnas de las Tasas
    vsfLineas_Mercaderia.ColHidden(CGL_TCOFIS) = True
    vsfLineas_Mercaderia.ColHidden(CGL_TIVA) = True
    vsfLineas_Mercaderia.ColHidden(CGL_TCOFIS_IVA) = True
    vsfLineas_Mercaderia.ColHidden(CGL_COFIS_IVA) = True
    
    vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE_COFIS) = True
    vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE_IVA) = True
    vsfLineas_Mercaderia.ColHidden(CGL_NRO_LINEA) = True
    
    If Not Buscar_Empresa(gCodigo_Empresa, e) Then
        MsgBox "Error en la Configuracion de la Empresa", vbCritical, MsgTit
    End If
    
    If Trim(UCase(e!imp_inc_facturador)) = "S" Then
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSIMP) = True
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSIMP_CON_DTO) = True
        vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE_SIN_IVA) = True
    Else
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSIMP) = True
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIO_CON_DTO) = True
        vsfLineas_Mercaderia.ColHidden(CGL_IMPORTE) = True
    End If
    
    If val(Me.txtCodDoc.text) <> 0 Then
        If Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S" Then
            vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSINIVA) = True
        Else
            vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSINIVA) = False
        End If
    Else
        vsfLineas_Mercaderia.ColHidden(CGL_PUNITARIOSINIVA) = False
    End If
    
        
    
    ' Nueva Columna Agregadas porque vienen desde el movil                    JE 20151203
    vsfLineas_Mercaderia.FixedAlignment(CGL_FORMA_PAGO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_FORMA_PAGO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_FORMA_PAGO) = "Forma Pago"
    vsfLineas_Mercaderia.ColDataType(CGL_FORMA_PAGO) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_FORMA_PAGO) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_FORMA_PAGO) = True
    
    ' Nuevas Columnas con los documentos de referencia por remitos parciales    SS 20160203
    vsfLineas_Mercaderia.FixedAlignment(CGL_COD_DOC_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_COD_DOC_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_COD_DOC_REF) = "Cod.Doc.Ref."
    vsfLineas_Mercaderia.ColDataType(CGL_COD_DOC_REF) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_COD_DOC_REF) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_COD_DOC_REF) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_NRO_DOC_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_NRO_DOC_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_NRO_DOC_REF) = "Nro.Doc.Ref."
    vsfLineas_Mercaderia.ColDataType(CGL_NRO_DOC_REF) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_NRO_DOC_REF) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_NRO_DOC_REF) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_NRO_LINEA_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_NRO_LINEA_REF) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_NRO_LINEA_REF) = "Nro.Lin.Ref."
    vsfLineas_Mercaderia.ColDataType(CGL_NRO_LINEA_REF) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_NRO_LINEA_REF) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_NRO_LINEA_REF) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_CANTIDAD_SALDO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_CANTIDAD_SALDO) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_CANTIDAD_SALDO) = "Cant.Original"
    vsfLineas_Mercaderia.ColDataType(CGL_CANTIDAD_SALDO) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_CANTIDAD_SALDO) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_CANTIDAD_SALDO) = True
    
    vsfLineas_Mercaderia.FixedAlignment(CGL_CANTIDAD_ENTREGADA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.ColAlignment(CGL_CANTIDAD_ENTREGADA) = flexAlignCenterBottom
    vsfLineas_Mercaderia.TextMatrix(0, CGL_CANTIDAD_ENTREGADA) = "Cant.Original"
    vsfLineas_Mercaderia.ColDataType(CGL_CANTIDAD_ENTREGADA) = flexDTLong
    vsfLineas_Mercaderia.ColWidth(CGL_CANTIDAD_ENTREGADA) = 1000
    vsfLineas_Mercaderia.ColHidden(CGL_CANTIDAD_ENTREGADA) = True
    
    vsfLineas_Mercaderia.ColSort(CGL_NRO_LINEA) = flexSortNumericDescending
        
    Screen.MousePointer = vbDefault

End Sub


Private Sub txtViaTransporte_Click()
'    If lcolCampos.Count > 10 Then
'        If lcolCampos("txtViaTransporte").bloqueado = "N" Then
'            lbolPide_Dato_Manual = True
'        Else
'            lbolPide_Dato_Manual = False
'        End If
'    Else
'        lbolPide_Dato_Manual = False
'    End If

    If lcolCampos.Count > 10 Then
        lcolCampos("txtViaTransporte").solicitar_datos = "S"
    End If

End Sub

Private Sub txtViaTransporte_GotFocus()
    
    If Trim(txtViaTransporte.text) = "" Then
        txtViaTransporte.text = "9 - OTRO"
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("txtViaTransporte").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese la Via de Transporte"
    Call Color_Control_Seleccionado(Me, txtViaTransporte)
    Call MarcarTexto(txtViaTransporte)

End Sub

Private Sub txtViaTransporte_KeyDown(KeyCode As Integer, Shift As Integer)
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtClauVta.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        txtPais.SetFocus
    End If
End Sub

Private Sub txtViaTransporte_LostFocus()
'    lbolPide_Dato_Manual = False
End Sub

Private Sub vsfCheques_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
    vsfCheques.Cell(flexcpFontBold, OldRow, OldCol, OldRow, OldCol) = False
    vsfCheques.Cell(flexcpFontBold, NewRow, NewCol, NewRow, NewCol) = True

    Select Case NewCol  'SS 20190212
    
        Case CGCH_CUENTA
            If Trim(vsfCheques.TextMatrix(OldRow, CGCH_CUENTA)) = "" Then
                vsfCheques.TextMatrix(OldRow, CGCH_CUENTA) = 0
            End If
        Case CGCH_FECHA_EMISION
            If Trim(vsfCheques.TextMatrix(OldRow, CGCH_FECHA_EMISION)) = "" Then
                vsfCheques.TextMatrix(OldRow, CGCH_FECHA_EMISION) = Format(date, "dd/mm/yyyy")
            End If
        Case CGCH_FECHA_VTO
            If Trim(vsfCheques.TextMatrix(OldRow, CGCH_FECHA_VTO)) = "" Then
                vsfCheques.TextMatrix(OldRow, CGCH_FECHA_VTO) = Format(date, "dd/mm/yyyy")
            End If

    End Select

End Sub

Private Sub vsfCheques_EnterCell()
    
    If vsfCheques.Col = CGCH_IMPORTE Or _
        vsfCheques.Col = CGCH_CUENTA Or _
        vsfCheques.Col = CGCH_MONEDA Or _
        vsfCheques.Col = CGCH_BANCO Or _
        vsfCheques.Col = CGCH_NUMERO_CHEQUE Or _
        vsfCheques.Col = CGCH_FECHA_EMISION Or _
        vsfCheques.Col = CGCH_FECHA_VTO Or _
        vsfCheques.Col = CGCH_DOCUMENTO Or _
        vsfCheques.Col = CGCH_OBS Or _
        vsfCheques.Col = CGCH_CUENTA_LIBRADOR Or _
        vsfCheques.Col = CGCH_TITULAR_LIBRADOR Or _
        vsfCheques.Col = CGCH_TC Or _
        vsfCheques.Col = CGCH_SERIE Then
            
            vsfCheques.AutoSearch = flexSearchNone
            vsfCheques.Editable = flexEDKbdMouse
    Else
        vsfCheques.AutoSearch = flexSearchFromTop
        vsfCheques.Editable = flexEDNone
        
    End If

End Sub

Private Sub vsfCheques_GotFocus()

    stbAyuda.Panels(1).text = "Ingrese el Detalle de Cheques / F12 - Finaliza "

End Sub

Private Sub vsfCheques_KeyDown(KeyCode As Integer, Shift As Integer)
Dim R As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyF12 Or KeyCode = vbKeyEnd Then
        sstDetalle_Pagos.Tab = 0
        vsfMedios_Pagos.SetFocus
        
        Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
             Case "DESCRIPCION"
                 vsfMedios_Pagos.Col = CGMP_DESCRIPCION
             Case Else
                 vsfMedios_Pagos.Col = CGMP_IMPORTE
         End Select
    
        vsfMedios_Pagos.Row = 1
    End If
    
    If KeyCode = vbKeyF1 Then
        Select Case vsfCheques.Col
            Case CGCH_BANCO
                    GForm = Me.Name
                    GCampoBusqueda = ""
                    whereSelCamG = ""
                    GTipoBusc = "bancos"
                    gbolESC = True
                    frmBusquedas.Show 1
                    If Trim(vsfCheques.text) <> "" Then
                        If Not Busco_Banco(vsfCheques.text, R) Then
                            MsgBox "Banco Inexistente", vbCritical, MsgTit
                        Else
                            vsfCheques.TextMatrix(vsfCheques.Row, CGCH_DESCRIPCION) = Trim(R!nombre)
                        End If
                    End If
            Case CGCH_DOCUMENTO
                    GForm = Me.Name
                    GCampoBusqueda = "CHEQUES"
                    'AIR 20240109 se agrega opcion para que se puedan seleccionar docs de tipo transferencias.
                    'whereSelCamG = "tipo_doc='C' and signo =  -1"
                    whereSelCamG = "(tipo_doc='C' and signo =  -1) or (tipo_doc='B' and signo =  -1 and (tipo_cheque = 'TXBANCO_DIA' OR tipo_cheque = 'TXBANCO_DIFERIDO' ))"
                    GTipoBusc = "documentos"
                    gbolESC = True
                    frmBusquedas.Show 1
        End Select
    End If


    If KeyCode = vbKeyDown Then

        If vsfCheques.Rows = vsfCheques.Row + 1 Then
            vsfCheques.Rows = vsfCheques.Rows + 1
            vsfCheques.Row = vsfCheques.Row + 1
        End If
        vsfCheques.Col = CGCH_BANCO
        Sendkeys "{LEFT}"

    End If
    
    If KeyCode = vbKeyDelete Then
        If MsgBox("Desea Eliminar la Linea", vbYesNo + vbDefaultButton2) = vbYes Then
            vsfCheques.RemoveItem (vsfCheques.Row)
            
        End If
    End If



End Sub

Private Sub vsfCheques_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
On Error GoTo Errores
Dim R As Recordset
Dim ch As Recordset
Dim llngCuenta As Long
Dim lstrFecha As String
Dim ldblTipo_Cambio As Double
Dim lrstMovBancarios As Recordset
Dim lrstCuentas_Librador As Recordset

    Select Case Col

        Case CGCH_BANCO

            If Trim(vsfCheques.EditText) <> "" Then
                If Not Busco_Banco(val(vsfCheques.EditText), R) Then
                    MsgBox "Banco Inexistente", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    vsfCheques.TextMatrix(Row, CGCH_DESCRIPCION) = Trim(R!nombre)
                    vsfCheques.Select Row, CGCH_CUENTA
                End If
            Else
                vsfCheques.TextMatrix(Row, CGCH_DESCRIPCION) = ""
            End If

        
        Case CGCH_CUENTA
                
            If Trim(vsfCheques.EditText) <> "" And Trim(vsfCheques.EditText) <> 0 Then
                If IsNumeric(vsfCheques.EditText) Then
                
                    If Not Busco_Cuenta_Bancaria(val(txtEmpresa.text), val(vsfCheques.TextMatrix(Row, CGCH_BANCO)), val(vsfCheques.EditText), R) Then
                        MsgBox "Cuenta Bancaria NO Existente", vbInformation, MsgTit
                        Cancel = True
                        Exit Sub
                    Else
                        If UCase(Trim(R!Activo)) <> "S" Then
                            MsgBox "Cuenta Bancaria INACTIVA. Verifique....", vbInformation, MsgTit
                            Cancel = True
                            Exit Sub
                        End If

                        vsfCheques.TextMatrix(Row, CGCH_MONEDA) = R!cod_moneda
                        If Not Busco_Moneda(vsfCheques.TextMatrix(Row, CGCH_MONEDA)) Then
                            MsgBox "Moneda de la Cuenta Inexistente", vbCritical, MsgTit
                            Cancel = True
                            Exit Sub
                        Else
                            ldblTipo_Cambio = Tipo_Cambio(vsfCheques.TextMatrix(Row, CGCH_MONEDA), txtFec_Doc.text)
                            
                            If ldblTipo_Cambio <> 0 Then
                                vsfCheques.TextMatrix(Row, CGCH_TC) = Format(ldblTipo_Cambio, "###0.00")
                            Else
                                MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfCheques.TextMatrix(Row, CGCH_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                                Cancel = True
                                Exit Sub
                            End If
                        
                            vsfCheques.TextMatrix(Row, CGCH_SIMBOLO) = Trim(rstMonedas!simbolo)
                            vsfCheques.Select Row, CGCH_DOCUMENTO
                        End If
                    End If
                Else
                    MsgBox "El número de la Cuenta Bancaria debe ser un Número Válido", vbInformation, MsgTit
                    Cancel = True
                    Exit Sub
                End If
            Else
                If Trim(vsfCheques.EditText) <> 0 Then
                    MsgBox "El número de la Cuenta Bancaria No Puede ser Nulo", vbInformation, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    vsfCheques.Select Row, CGCH_DOCUMENTO       'SS 20190212
                End If
            End If
        
        
        Case CGCH_DOCUMENTO

              If val(vsfCheques.EditText) <> 730 And val(vsfCheques.EditText) <> 735 And val(vsfCheques.EditText) <> 701 And val(vsfCheques.EditText) <> 690 And val(vsfCheques.EditText) <> 694 Then
                  MsgBox "Debe Ingresar 730 (CONTADO) , 735 (DIFERIDO) , 701 (DEPOSITO) o 690/694 (TRANSFERENCIA BANCARIA)", vbCritical, MsgTit
                  Cancel = True
                  Exit Sub
              Else
                  vsfCheques.Select Row, CGCH_SERIE
              End If
    
              If val(vsfCheques.EditText) = 690 Then
                  vsfCheques.TextMatrix(Row, CGCH_NUMERO_CHEQUE) = Tomo_Nuevo_Numero_Contador_Documentos(val(txtEmpresa.text), vsfCheques.EditText, "D", False)
              End If
            
    
        Case CGCH_SERIE
            vsfCheques.Select Row, CGCH_NUMERO_CHEQUE

        
'        Case CGCH_NUMERO_CHEQUE
'            If Not IsNumeric(vsfCheques.EditText) Then
'                MsgBox "El Número del Documento debe ser un Número Válido", vbCritical, MsgTit
'                Cancel = True
'                Exit Sub
'            Else
'                If Trim(UCase(sspOperacion.Caption)) = "A" Then
'                    ' Chequeo que el Documento no Exista
'                    Select Case Val(txtMoneda.text)
'                        Case gMoneda_Base
'                            llngCuenta = gCuenta_Base
'                        Case gMoneda_Referencia
'                            llngCuenta = gCuenta_Referencia
'                    End Select
'
'                    If IsNumeric(txtEmpresa.text) And IsNumeric(vsfCheques.TextMatrix(Row, CGCH_BANCO)) And IsNumeric(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) And IsNumeric(vsfCheques.EditText) Then
'                        If Busco_Movimiento_Bancario(Val(txtEmpresa.text), Val(vsfCheques.TextMatrix(Row, CGCH_BANCO)), llngCuenta, Val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)), Val(vsfCheques.EditText), "", ch) Then
'                            MsgBox "ERROR: Cheque " & Trim(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) & "/" & Trim(vsfCheques.EditText) & " Ingresado Ya Existe en el Sistema.Verifique...", vbCritical, MsgTit
'                            Cancel = True
'                        Else
'                            vsfCheques.Select Row, CGCH_VTO
'                        End If
'                    Else
'                        vsfCheques.Select Row, CGCH_VTO
'                    End If
'                End If
'            End If

        Case CGCH_NUMERO_CHEQUE
            If Not IsNumeric(vsfCheques.EditText) Then
                MsgBox "Debe Ingresar un Numero", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                vsfCheques.Select Row, CGCH_MONEDA
            End If
            

        Case CGCH_MONEDA
            If Not IsNumeric(vsfCheques.EditText) Then
                MsgBox "Moneda No Valida. Verifique....", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not Busco_Moneda(vsfCheques.EditText) Then
                    MsgBox "Moneda Inexistente", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    If val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) = 690 Or val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) = 701 Then    ' 690 TRANSFERENCIA BANCARIA / 701 DEPOSITO
                        If Busco_Movimiento_Bancario(val(txtEmpresa.text), val(vsfCheques.TextMatrix(Row, CGCH_BANCO)), val(vsfCheques.TextMatrix(Row, CGCH_CUENTA)), vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO), vsfCheques.TextMatrix(Row, CGCH_NUMERO_CHEQUE), vsfCheques.TextMatrix(Row, CGCH_SERIE), lrstMovBancarios) Then
                            MsgBox "Este Movimiento ya Está Ingresado en el Sistema", vbCritical, MsgTit
                            vsfCheques.TextMatrix(Row, CGCH_NUMERO_CHEQUE) = ""
                            vsfCheques.TextMatrix(Row, CGCH_MONEDA) = ""
                            vsfCheques.Select Row, CGCH_NUMERO_CHEQUE
                            Cancel = True
                            Exit Sub
                        End If
                    End If

                    If val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) = 730 Or val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)) = 735 Then  ' 730 CONTADO / 735 DIFERIDO
                        If Busco_Movimiento_Bancario(val(txtEmpresa.text), gBanco_Empresa, IIf(val(vsfCheques.EditText) = gMoneda_Base, gCuenta_Base, gCuenta_Referencia), vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO), vsfCheques.TextMatrix(Row, CGCH_NUMERO_CHEQUE), vsfCheques.TextMatrix(Row, CGCH_SERIE), lrstMovBancarios) Then
                            MsgBox "Este Cheque ya Está Ingresado en el Sistema", vbCritical, MsgTit
                            vsfCheques.TextMatrix(Row, CGCH_NUMERO_CHEQUE) = ""
                            vsfCheques.TextMatrix(Row, CGCH_MONEDA) = ""
                            vsfCheques.Select Row, CGCH_NUMERO_CHEQUE
                            Cancel = True
                            Exit Sub
                        End If
                    End If
                   
                    
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(vsfCheques.EditText), Format(txtFec_Doc.text, "dd/mm/yyyy"), IIf(ConfFormato_Factura = "BARRACAPARANA", "CM", "C"))
                    
                    If ldblTipo_Cambio <> 0 Then
                        vsfCheques.TextMatrix(Row, CGCH_TC) = Format(ldblTipo_Cambio, "###0.00")
                    Else
                        MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfCheques.TextMatrix(Row, CGCH_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                        vsfCheques.Select Row, CGCH_MONEDA
                        Cancel = True
                        Exit Sub
                    End If
                    
                    If IsNumeric(txtMoneda.text) And vsfCheques.TextMatrix(Row, CGCH_IMPORTE) <> "" Then
                        If CLng(txtMoneda.text) = gMoneda_Base Then
                            vsfCheques.TextMatrix(Row, CGCH_IMPORTE_DEL_DOC) = Importe_Base(CInt(vsfCheques.TextMatrix(Row, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, CDbl(vsfCheques.TextMatrix(Row, CGCH_IMPORTE)))
                        End If
                        
                        If CLng(txtMoneda.text) = gMoneda_Referencia Then
                            vsfCheques.TextMatrix(Row, CGCH_IMPORTE_DEL_DOC) = Importe_Referencia(CInt(vsfCheques.TextMatrix(Row, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, CDbl(vsfCheques.TextMatrix(Row, CGCH_IMPORTE)))
                            
                        End If
                    End If
                    vsfCheques.TextMatrix(Row, CGCH_SIMBOLO) = Trim(rstMonedas!simbolo)
                    vsfCheques.Select Row, CGCH_IMPORTE
                End If
            End If

        Case CGCH_TC
            If Not IsNumeric(vsfCheques.EditText) Then
                MsgBox "Tipo de Cambio No Valido. Verifique....", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                vsfCheques.EditText = Format(vsfCheques.EditText, "##0.00")
                TxtTCCheques.text = Format(vsfCheques.EditText, "###0.00")

                vsfCheques.Select Row, CGCH_IMPORTE
            End If

        
        Case CGCH_IMPORTE
        
            If IsNumeric(vsfCheques.EditText) Then
                vsfCheques.EditText = Format(vsfCheques.EditText, "0.00")
                
                If IsNumeric(vsfCheques.TextMatrix(Row, CGCH_TC)) Then
                    ldblTipo_Cambio = CDbl(vsfCheques.TextMatrix(Row, CGCH_TC))
                Else
                    MsgBox "ERROR: Tipo de Cambio de la Linea Ingresada No Valido. Verifique por favor..", vbCritical
                    Cancel = True
                    Exit Sub
                End If
                        
                If IsNumeric(txtMoneda.text) Then
                    If CLng(txtMoneda.text) = gMoneda_Base Then
                        vsfCheques.TextMatrix(Row, CGCH_IMPORTE_DEL_DOC) = Importe_Base(CInt(vsfCheques.TextMatrix(Row, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, Abs(vsfCheques.EditText))
                    End If
                    
                    If CLng(txtMoneda.text) = gMoneda_Referencia Then
                        vsfCheques.TextMatrix(Row, CGCH_IMPORTE_DEL_DOC) = Importe_Referencia(CInt(vsfCheques.TextMatrix(Row, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, Abs(vsfCheques.EditText))
                    End If
                End If
            Else
                Cancel = True
                Exit Sub
            End If
        
            vsfCheques.Select Row, CGCH_FECHA_EMISION
        
'        Case CGCH_IMPORTE
'            If Not IsNumeric(vsfCheques.EditText) Then
'                MsgBox "El Importe del Documento debe ser un Número Válido", vbCritical, MsgTit
'                Cancel = True
'            Else
'                If vsfCheques.Rows = vsfCheques.Row + 1 Then    ' SS 20160204
'                    vsfCheques.Rows = vsfCheques.Rows + 1
'                    vsfCheques.Row = vsfCheques.Row + 1
'                End If
'                'vsfCheques.Row = vsfCheques.Row + 1
'                vsfCheques.Select vsfCheques.Row, CGCH_BANCO
'            End If
        
        
        Case CGCH_FECHA_EMISION

            vsfCheques.EditText = f_ArmoFecha(vsfCheques.EditText)
            If Not IsDate(vsfCheques.EditText) Then
                MsgBox "La Fecha De Emisión Debe Ingresarse en Formato dd/mm/yyyy", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                vsfCheques.TextMatrix(Row, CGCH_FECHA_EMISION) = Format(vsfCheques.EditText, "dd/mm/yyyy")
                vsfCheques.Select Row, CGCH_FECHA_VTO
            End If
        
        
        Case CGCH_FECHA_VTO

            vsfCheques.EditText = f_ArmoFecha(vsfCheques.EditText)
            If Not IsDate(vsfCheques.EditText) Then
                MsgBox "La Fecha de Vencimiento Debe Ingresarse en Formato dd/mm/yyyy", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                vsfCheques.TextMatrix(Row, CGCH_FECHA_VTO) = Format(vsfCheques.EditText, "dd/mm/yyyy")
                If Not Validar_Fecha_Vencimiento_Cheques_Diferidos(val(vsfCheques.TextMatrix(Row, CGCH_DOCUMENTO)), CDate(vsfCheques.TextMatrix(Row, CGCH_FECHA_EMISION)), CDate(vsfCheques.EditText)) Then
                    Cancel = True
                    Exit Sub
                Else
                    vsfCheques.Select Row, CGCH_CUENTA_LIBRADOR
                End If
            End If
        
'        Case CGCH_FECHA_VTO
'
'            vsfCheques.EditText = f_ArmoFecha(vsfCheques.EditText)
'            If Not IsDate(vsfCheques.EditText) Then
'                MsgBox "La Fecha Debe Ingresarse en Formato dd/mm/yyyy", vbCritical, MsgTit
'            Else
'                vsfCheques.EditText = Format(vsfCheques.EditText, "dd/mm/yyyy")
'                vsfCheques.Select Row, CGCH_MONEDA
'            End If
'
        
        Case CGCH_CUENTA_LIBRADOR
            If Trim(vsfCheques.EditText) <> "" Then
                If val(vsfCheques.TextMatrix(Row, CGCH_BANCO)) <> gBanco_Empresa Then
                    If Not Busco_Cuenta_Librador(val(vsfCheques.TextMatrix(Row, CGCH_BANCO)), Trim(vsfCheques.EditText), lrstCuentas_Librador) Then
                        vsfCheques.Select Row, CGCH_TITULAR_LIBRADOR
                    Else
                        vsfCheques.TextMatrix(Row, CGCH_TITULAR_LIBRADOR) = Trim(lrstCuentas_Librador!Titular_librador)
                        vsfCheques.Select Row, CGCH_OBS
                    End If
                Else
                    vsfCheques.Select Row, CGCH_OBS
                End If
            Else
                vsfCheques.Select Row, CGCH_OBS
            End If
             
        Case CGCH_TITULAR_LIBRADOR
             vsfCheques.Select Row, CGCH_OBS
             
        Case CGCH_OBS
            If vsfCheques.Rows = vsfCheques.Row + 1 Then
                vsfCheques.Rows = vsfCheques.Rows + 1
                vsfCheques.Row = vsfCheques.Row + 1
            End If
            vsfCheques.Col = CGCH_BANCO
            Sendkeys "{LEFT}"

        
    End Select
    
Exit Sub

Errores:
    MsgBox "Ha ocurrido un error, Verifique", vbInformation, MsgTit
    Exit Sub

End Sub


Private Sub vsfEquivalencias_Stock_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
Dim lbolHay_Imagen As Boolean
    Call Visualizar_Imagen_Producto(vsfEquivalencias_Stock.TextMatrix(NewRow, CGES_CODIGO), Imagen_Producto, "C", lbolHay_Imagen)
End Sub

Private Sub vsfEquivalencias_Stock_Click()
Dim lbolHay_Imagen As Boolean
    Call Visualizar_Imagen_Producto(vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.RowSel, CGES_CODIGO), Imagen_Producto, "C", lbolHay_Imagen)
End Sub

Private Sub vsfImpuestos_AfterEdit(ByVal Row As Long, ByVal Col As Long)
        
    Call Calculo_Total_Calculado(True)

End Sub

Private Sub vsfImpuestos_EnterCell()
    
    'If vsfImpuestos.Col = CGI_COFIS Or vsfImpuestos.Col = CGI_IVA Then
    If vsfImpuestos.Col = CGI_COFIS Then
        vsfImpuestos.AutoSearch = flexSearchNone
        vsfImpuestos.Editable = flexEDKbdMouse
    Else
        vsfImpuestos.AutoSearch = flexSearchFromTop
        vsfImpuestos.Editable = flexEDNone
    End If

End Sub

Private Sub vsfImpuestos_GotFocus()
    
    stbAyuda.Panels(1).text = "Lineas de los Impuestos"

End Sub

Private Sub vsfImpuestos_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    
    Select Case Col

        Case CGI_COFIS
            
            If Trim(vsfImpuestos.EditText) <> "" Then
                MsgBox "El Importe del Cofis No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not IsNumeric(vsfImpuestos.EditText) Then
                    MsgBox "El Importe del COFIS Debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                
                End If
            End If
            
        Case CGI_IVA
            
            If Trim(vsfImpuestos.EditText) <> "" Then
                MsgBox "El Importe del IVA No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not IsNumeric(vsfImpuestos.EditTex) Then
                    MsgBox "El Importe del IVA Debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                End If
            End If

    End Select


End Sub

Private Sub vsfLineas_Mercaderia_AfterEdit(ByVal Row As Long, ByVal Col As Long)

On Error GoTo Errores
    
    Call Calcular_Importes_de_la_Linea_Mercaderia(Row, False, True)
    
    Call Total_Unidades
    
Exit Sub

Errores:
    MsgBox "Ha ocurrido un error, Verifique", vbInformation, MsgTit
    Exit Sub
End Sub

Private Sub vsfLineas_Mercaderia_AfterMoveColumn(ByVal Col As Long, Position As Long)

 ' sort the data from first to last column
 vsfLineas_Mercaderia.Select 1, 0, 1, vsfLineas_Mercaderia.Cols - 1
 vsfLineas_Mercaderia.Sort = flexSortGenericAscending
 vsfLineas_Mercaderia.Select Position, CGL_CODIGO

End Sub

Private Sub vsfLineas_Mercaderia_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
Dim lbolHay_Imagen As Boolean
Dim lrstGarantias, R As Recordset

    If fraDescuento_x_Volumen.visible Then
        Call Cargo_Grilla_Descuentos_x_Volumen(val(vsfLineas_Mercaderia.TextMatrix(NewRow, CGL_CODIGO)), CDate(txtFec_Doc.text), val(txtLista.text), val(vsfLineas_Mercaderia.TextMatrix(NewRow, CGL_PUNITARIO)))       ' JE 20250708   /   parametro nuevo
    End If
    
    If fraEquivalencias_Stock.visible Then
        Cargo_Grilla_Equivalencias_Stock (val(vsfLineas_Mercaderia.TextMatrix(NewRow, CGL_CODIGO)))
    End If

    Call Visualizar_Imagen_Producto(val(vsfLineas_Mercaderia.TextMatrix(NewRow, CGL_CODIGO)), Imagen_Producto, "C", lbolHay_Imagen)

    Call Total_Unidades

End Sub

Private Sub vsfLineas_Mercaderia_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    vsfLineas_Mercaderia.ColComboList(CGL_NOMBRE_MAGNITUD) = String_Magnituides_para_Combo(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
 
End Sub

Private Sub vsfLineas_Mercaderia_CellChanged(ByVal Row As Long, ByVal Col As Long)
    
Dim TE As Recordset
    Select Case vsfLineas_Mercaderia.Col
        Case CGL_TIPO_ENTREGA
            If vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) = False Then
                If Not confPuntoVta_Inicializar_Deposito_X_Articulo Then
                    If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIPO_ENTREGA)), TE) Then
                        If TE!Deposito <> "" Then
                            vsfLineas_Mercaderia.TextMatrix(Row, CGL_DEPOSITO) = Trim(TE!Deposito)
                            vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK) = Format(Stock_Linea(val(txtEmpresa.text), Trim(TE!Deposito), CLng(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")


                            If val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK)) <= 0 Then
                                vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_STOCK) = &HFF&
                                vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_STOCK) = True
                            Else
                                vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_STOCK) = &H0&
                                vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_STOCK) = False
                            End If
                         End If
                    End If
                End If
            End If

        Case CGL_DEPOSITO
            If vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) = False Then
                vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK) = Format(Stock_Linea(val(txtEmpresa.text), Trim(UCase(vsfLineas_Mercaderia.TextMatrix(Row, CGL_DEPOSITO))), CLng(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")

                If val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK)) <= 0 Then
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_STOCK) = &HFF&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_STOCK) = True
                Else
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_STOCK) = &H0&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_STOCK) = False
                End If
            End If
        
        
        
    End Select
    
    If Row <> 0 Then
        vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_PUNITARIO) = &HFF&
        vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_PUNITARIO) = True
        vsfLineas_Mercaderia.Cell(flexcpForeColor, Row, CGL_PUNITARIO_MAGNITUD) = &HFF&
        vsfLineas_Mercaderia.Cell(flexcpFontBold, Row, CGL_PUNITARIO_MAGNITUD) = True
    End If
    
    

End Sub

Private Sub vsfLineas_Mercaderia_Click()
    If Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.RowSel, CGL_DESCRIPCION)) <> "" And vsfLineas_Mercaderia.RowSel <> 0 Then
        lbDisplay.Caption = Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.RowSel, CGL_DESCRIPCION))
    
        If fraDescuento_x_Volumen.visible Then
            Call Cargo_Grilla_Descuentos_x_Volumen(val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.RowSel, CGL_CODIGO)), CDate(txtFec_Doc.text), val(txtLista.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.RowSel, CGL_PUNITARIO)))    ' JE 20250708   /   parametro nuevo
        End If
    
        If fraEquivalencias_Stock.visible Then
            Cargo_Grilla_Equivalencias_Stock (val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.RowSel, CGL_CODIGO)))
        End If
    
    End If
End Sub


Private Sub vsfLineas_Mercaderia_ComboCloseUp(ByVal Row As Long, ByVal Col As Long, FinishEdit As Boolean)
Dim TE As Recordset
    Select Case vsfLineas_Mercaderia.Col
        Case CGL_TIPO_ENTREGA
            If vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) = False Then
                If Not confPuntoVta_Inicializar_Deposito_X_Articulo Then
                    If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_TIPO_ENTREGA)), TE) Then
                        If TE!Deposito <> "" Then
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO) = Trim(TE!Deposito)
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK) = Format(Stock_Linea(val(txtEmpresa.text), Trim(TE!Deposito), CLng(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")


                            If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) <= 0 Then
                                vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Row, CGL_STOCK) = &HFF&
                                vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Row, CGL_STOCK) = True
                            Else
                                vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Row, CGL_STOCK) = &H0&
                                vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Row, CGL_STOCK) = False
                            End If

                        End If
                    End If
                End If
            End If

        Case CGL_DEPOSITO
            If vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) = False Then
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK) = Format(Stock_Linea(val(txtEmpresa.text), Trim(UCase(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO))), CLng(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), ConfPuntoVta_Recalcula_Stock_On_Line), "0.00")

                If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) <= 0 Then
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Row, CGL_STOCK) = &HFF&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Row, CGL_STOCK) = True
                Else
                    vsfLineas_Mercaderia.Cell(flexcpForeColor, vsfLineas_Mercaderia.Row, CGL_STOCK) = &H0&
                    vsfLineas_Mercaderia.Cell(flexcpFontBold, vsfLineas_Mercaderia.Row, CGL_STOCK) = False
                End If
            End If
    End Select
    
    FinishEdit = True
End Sub

Private Sub vsfLineas_Mercaderia_EnterCell()

Dim lrstArticulo As Recordset
Dim ldblArticuloGenerico As Boolean
    Select Case vsfLineas_Mercaderia.Col
        
        Case CGL_UNIDADES
            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
            
            
        Case CGL_UNIDADES_MAGNITUD
            If confUsaEquivalenciaMagnitudes Then
                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
            End If
            
        Case CGL_NOMBRE_MAGNITUD
            If confUsaEquivalenciaMagnitudes Then
                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
            End If
            
        Case CGL_DESCRIPCION
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If lcolCampos("vsfLM_Descripcion").pide_autorizacion = "S" Then
                    'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
                    'intervenir al supervisor
                    If Autorizacion_Supervision(26, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                        vsfLineas_Mercaderia.Editable = flexEDNone
                    End If
                'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
                'intervenir al supervisor
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                End If
            Else
                If Trim(UCase(ConfPuntoVta_Permite_Cambiar_Nombre_Articulo)) = "S" Then ' SS 20150728
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else
                    If Buscar_Articulo(val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), lrstArticulo) Then
                        If lrstArticulo!generico = "S" Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                            vsfLineas_Mercaderia.Editable = flexEDNone
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                        vsfLineas_Mercaderia.Editable = flexEDNone
                    End If
                End If
            End If
                
                
        Case CGL_TIPO_ENTREGA
            If Not vsfLineas_Mercaderia.ColHidden(CGL_TIPO_ENTREGA) Then
                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
            End If
                            
       Case CGL_DEPOSITO
            If Not vsfLineas_Mercaderia.ColHidden(CGL_DEPOSITO) Then
                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
            End If
            
        Case CGL_PUNITARIO, CGL_PUNITARIOSIMP, CGL_PUNITARIO_MAGNITUD, CGL_PUNITARIOSINIVA
        
            'ATU 20170505 se cambia seleccion de articulo generico para ser usada en 2 lugares
            If Buscar_Articulo(val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), lrstArticulo) Then
                If lrstArticulo!generico = "S" Then
                    ldblArticuloGenerico = True
                Else
                    ldblArticuloGenerico = False
                End If
            Else
                ldblArticuloGenerico = False
            End If
            
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If gNivel >= 3 Or ((ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ") And ldblArticuloGenerico = True) Then
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else
                    If lcolCampos("vsfLM_PUnitario").pide_autorizacion = "S" Then
                       ' AIR 20221110 se agrega la posibilidad de que si el articulo (ej:genericos) tiene configurado que se puede cambiar el precio entonces pida autorizacion con el nivel mas bajo
                        If f_es_Permitido_Cambiar_Precio(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) Then
                            If Autorizacion_Supervision(30, 1, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            Else
                                vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                                vsfLineas_Mercaderia.Editable = flexEDNone
                            End If
                        Else
                            If Autorizacion_Supervision(30, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            Else
                                vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                                vsfLineas_Mercaderia.Editable = flexEDNone
                            End If
                       End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If
            Else
                If Trim(UCase(ConfPuntoVta_Permite_Cambiar_PVenta)) = "S" Then
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else

                    If ldblArticuloGenerico = True Then
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                        vsfLineas_Mercaderia.Editable = flexEDNone
                    End If

                End If
            End If
                    
        Case CGL_DTO1
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If lcolCampos("vsfLM_Dto_1").pide_autorizacion = "S" Then
                    If Not YaAutorizadoDescuento Then
                        If Autorizacion_Supervision(31, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            Call UnificaAutorizacionDescuento
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                            vsfLineas_Mercaderia.Editable = flexEDNone
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                End If
            Else
                If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" Or (val(txtCodDoc.text) = ConfDoc_Ruptura Or val(txtCodDoc.text) = ConfDoc_Ruptura2) Then
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                    vsfLineas_Mercaderia.Editable = flexEDNone
                End If
            End If
            
        Case CGL_DTO2
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If lcolCampos("vsfLM_Dto_2").pide_autorizacion = "S" Then
                    If Not YaAutorizadoDescuento Then
                        If Autorizacion_Supervision(31, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            Call UnificaAutorizacionDescuento
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                            vsfLineas_Mercaderia.Editable = flexEDNone
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                End If
            Else
                If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" Or (val(txtCodDoc.text) = ConfDoc_Ruptura Or val(txtCodDoc.text) = ConfDoc_Ruptura2) Then
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                    vsfLineas_Mercaderia.Editable = flexEDNone
                End If
            End If
            
        Case CGL_DTO3
            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                If lcolCampos("vsfLM_Dto_3").pide_autorizacion = "S" Then
                    If Not YaAutorizadoDescuento Then
                        If Autorizacion_Supervision(31, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            Call UnificaAutorizacionDescuento
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                            vsfLineas_Mercaderia.Editable = flexEDNone
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                End If
            Else
                If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" Or (val(txtCodDoc.text) = ConfDoc_Ruptura Or val(txtCodDoc.text) = ConfDoc_Ruptura2) Then
                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                Else
                    vsfLineas_Mercaderia.AutoSearch = flexSearchFromTop
                    vsfLineas_Mercaderia.Editable = flexEDNone
                End If
            End If
            
        Case Else
            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
            vsfLineas_Mercaderia.Editable = flexEDNone
    
    End Select
    
End Sub

Private Sub vsfLineas_Mercaderia_GotFocus()

    stbAyuda.Panels(1).text = "Ingrese las Lineas del Documento F4-Autorizar / F8-Historía Costos / F9-Historía P.Venta / F10-Historía Ventas / F11-Series / F12-Ingreso D.Auxiliares"

End Sub

Private Sub vsfLineas_Mercaderia_KeyDown(KeyCode As Integer, Shift As Integer)
Dim C As Recordset
Dim D As Recordset
Dim P As Recordset
Dim M As Recordset
Dim TE As Recordset

Dim ldblSaldo_Estado_Cuenta As Double
Dim ldblTotal_Documento_Actual As Double
Dim ldblLimite_Credito_MBase As Double
    
    
    If KeyCode = vbKeyF1 Then
        If confPermite_Lineas_Negativas_FE Then
            If (CGL_UNIDADES = vsfLineas_Mercaderia.Col Or CGL_UNIDADES_MAGNITUD = vsfLineas_Mercaderia.Col) And IsNumeric(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.Col)) Then
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.Col) = Format(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.Col), f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text))) * -1
                Call vsfLineas_Mercaderia_AfterEdit(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.Col)
                TxtLector.SetFocus
            End If
        End If
    
    End If

        
    If KeyCode = vbKeyF4 Then
        
        If ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ" Then
            yaAutorizado = False
        End If
        
        Select Case vsfLineas_Mercaderia.Col
            
            Case CGL_DESCRIPCION
                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If lcolCampos("vsfLM_Descripcion").pide_autorizacion = "S" Then
                        If yaAutorizado Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        Else
                            If Autorizacion_Supervision(8, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                yaAutorizado = True
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                            End If
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If
            
            Case CGL_DTO1
                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If lcolCampos("vsfLM_Dto_1").pide_autorizacion = "S" Then
                        If Not YaAutorizadoDescuento Then
                            If Autorizacion_Supervision(8, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                yaAutorizado = True
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                                Call UnificaAutorizacionDescuento
                            End If
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If
            
            Case CGL_DTO2
                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If lcolCampos("vsfLM_Dto_2").pide_autorizacion = "S" Then
                        If Not YaAutorizadoDescuento Then
                            If Autorizacion_Supervision(8, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                yaAutorizado = True
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                                Call UnificaAutorizacionDescuento
                            End If
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If
            
            Case CGL_DTO3
                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If lcolCampos("vsfLM_Dto_3").pide_autorizacion = "S" Then
                        If Not YaAutorizadoDescuento Then
                            If Autorizacion_Supervision(8, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                yaAutorizado = True
                                vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                                Call UnificaAutorizacionDescuento
                            End If
                        Else
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If

            Case CGL_PUNITARIO, CGL_PUNITARIOSIMP
'                If (ConfPuntoVta_Utilizar_Autorizacion = "S" And f_es_Permitido_Cambiar_Precio(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))) Or ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ" Then
                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If lcolCampos("vsfLM_PUnitario").pide_autorizacion = "S" Then
                        If yaAutorizado Then
                            vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                            vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                        Else
                            ' AIR 20221110 se agrega la posibilidad de que si el articulo (ej:genericos) tiene configurado que se puede cambiar el precio entonces pida autorizacion con el nivel mas bajo, para que quede registro.
                            If f_es_Permitido_Cambiar_Precio(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) Then
                                If Autorizacion_Supervision(16, 1, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                    yaAutorizado = True
                                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                                End If
                            Else
                                If Autorizacion_Supervision(16, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                    yaAutorizado = True
                                    vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                                    vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                                End If
                            End If
                        End If
                    Else
                        vsfLineas_Mercaderia.AutoSearch = flexSearchNone
                        vsfLineas_Mercaderia.Editable = flexEDKbdMouse
                    End If
                End If
        End Select
    End If

    If KeyCode = vbKeyF8 Then
        If Tiene_Permiso_Para_Ver_Costos Then
            If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) <> 0 Then
                ' Ver Historico de Costos
                frmIngreso_Documentos_Ver_Historia_Costos_PVenta.pstrTipo = "C"
                frmIngreso_Documentos_Ver_Historia_Costos_PVenta.plngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
                frmIngreso_Documentos_Ver_Historia_Costos_PVenta.Show vbModal
            End If
        Else
            MsgBox "USUARIO SIN PERMISO PARA VER LOS COSTOS.", vbCritical + vbOKOnly
        End If
    End If

    If KeyCode = vbKeyF9 Then
        If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) <> 0 Then
            ' Ver Historico de Precios de Venta
            frmIngreso_Documentos_Ver_Historia_Costos_PVenta.pstrTipo = "V"
            frmIngreso_Documentos_Ver_Historia_Costos_PVenta.plngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
            frmIngreso_Documentos_Ver_Historia_Costos_PVenta.Show vbModal
        End If
    End If

    If KeyCode = vbKeyF10 Then
        If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) <> 0 Then
            ' Ver Historico de Ventas
            frmPunto_Venta_Ver_Historia_Ventas.plngCod_Emp = val(txtEmpresa.text)
            frmPunto_Venta_Ver_Historia_Ventas.plngCod_Prov = val(txtCodProv.text)
            frmPunto_Venta_Ver_Historia_Ventas.plngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
            frmPunto_Venta_Ver_Historia_Ventas.Show vbModal
            DoEvents
        End If
    End If

    If KeyCode = vbKeyF11 Then
        
        ' Tocando el F11, abre la pantalla de series del articulo
        
        If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) <> 0 Then
        
            If Buscar_Articulo(val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), P) Then
                
                frmPunto_Venta_Seleccion_Series.plngCod_Emp = val(txtEmpresa.text)
                frmPunto_Venta_Seleccion_Series.plngCod_Doc = val(txtCodDoc.text)
                frmPunto_Venta_Seleccion_Series.plngNro_Doc = val(txtDoc.text)
                frmPunto_Venta_Seleccion_Series.plngCod_Prov = val(txtCodProv.text)
                frmPunto_Venta_Seleccion_Series.plngNro_Linea = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_NRO_LINEA))
                frmPunto_Venta_Seleccion_Series.plngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
                frmPunto_Venta_Seleccion_Series.plngUnidades = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES))
                frmPunto_Venta_Seleccion_Series.pstrOperacion = Trim(UCase(sspOperacion.Caption))
                
                Set frmPunto_Venta_Seleccion_Series.pcolSeries_Articulos = gcolSeries_Articulos
                
                frmPunto_Venta_Seleccion_Series.Show vbModal
                
                Call Cargo_Grilla_Series
                
            Else
                MsgBox "ERROR: Debe ingresar primero un Código de Artículo Válido", vbCritical
            End If
        Else
            MsgBox "ERROR: Debe ingresar primero un Código de Artículo Válido", vbCritical
        End If
    End If

    If KeyCode = vbKeyDelete Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" And ConfPuntoVta_Utilizar_Autorizacion_Incluye_Eliminar_Lineas = "S" Then   ' Se agrega configuracion para eliminacion de las lineas    SS 20180711
            If Autorizacion_Supervision(9, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
            
                If vsfLineas_Mercaderia.Row > 0 Then
                    Call Cargo_Logtrans("LINEA ELIMINADA " & vsfLineas_Mercaderia.Row & " " & vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_NRO_LINEA) & " " & vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
                    vsfLineas_Mercaderia.RemoveItem (vsfLineas_Mercaderia.Row)
                    Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                    Call Total_Unidades
                    
                    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                    End If
                    
                    If ConfPuntoVta_Controla_Limite_Credito Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Then
                    
                        If Buscar_Cliente(val(txtCodProv.text), C) Then
                        
                            If C!cre_cli <> 0 Then
                                If Not Buscar_Limite_Credito(val(txtEmpresa.text), val(txtCodDoc.text), txtCodProv.text, val(txtMoneda.text), CDate(txtFec_Doc.text), CDbl(NullToZero(txtImporte.text)), val(txtTipo_Cambio.text), False) Then
                                End If
                            End If
                        End If
                    End If
                    
                End If
            End If
        Else
            If vsfLineas_Mercaderia.Row > 0 Then
                Call Cargo_Logtrans("LINEA ELIMINADA " & vsfLineas_Mercaderia.Row & " " & vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_NRO_LINEA) & " " & vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
                vsfLineas_Mercaderia.RemoveItem (vsfLineas_Mercaderia.Row)
                Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                Call Total_Unidades
                
                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                End If
                
                If ConfPuntoVta_Controla_Limite_Credito Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Then
                
                    If Buscar_Cliente(val(txtCodProv.text), C) Then
                    
                        If C!cre_cli <> 0 Then
                            
                            ' Controlo el Limite de Credito.. Si en el Cliente esta Definido el TOPE
                            If Not Buscar_Limite_Credito(val(txtEmpresa.text), val(txtCodDoc.text), txtCodProv.text, val(txtMoneda.text), CDate(txtFec_Doc.text), CDbl(NullToZero(txtImporte.text)), val(txtTipo_Cambio.text), False) Then
                            End If
                            
                        End If
                    End If
                End If
            
            End If
        End If
    End If
    
    If KeyCode = vbKeyF12 Then
        If Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)) <> "" Then
            ' JE 20170628  /    Ingreso Datos si es una Linea Valida (para que siempre pase a eFactura, sino no la toma porque no es una linea a enviar a eFactura
            Call Crear_Temporal_Datos_Auxiliares_de_las_Lineas(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text)
            Call Ingreso_Modifico_Datos_Auxiliares_de_la_Linea(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), txtCodProv.text, vsfLineas_Mercaderia.Row)
        End If
    End If
    

    If KeyCode = vbKeyF5 Then
    'Articulos
    
        ' JE 20180220   /    Controlar que tenga Permisos para el Formulario
        If Not Buscar_Permiso_Programa_x_Usuario(gNro_Usuario, 27, P) Then
            MsgBox "El Usuario NO TIENE PERMISO de ACCESO al Mantenimiento de Artículos", vbCritical + vbOKOnly
            Exit Sub
        End If
    
        If gNro_Usuario <> 99999 Then
            If Trim(UCase(P!Modificacion)) <> "S" Then
                MsgBox "El Usuario NO TIENE PERMISO de MODIFICACION en el Mantenimiento de Artículos", vbCritical + vbOKOnly
                Exit Sub
            End If
        End If
           
        frmMan_Articulos.plngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO))
        frmMan_Articulos.pstrOperacion = "M"
        frmMan_Articulos.pbooFormularioNoModal = True
        frmMan_Articulos.Show
    
    End If
    
    ' AIR 20170710 el cursor vuelve automaticamente al campo de unidades
    If KeyCode = vbKeyReturn Then

        'If ConfFormato_Factura = "MANTA" Then
        
        If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia Then
            Select Case vsfLineas_Mercaderia.Col
            Case CGL_DTO3
                TxtFactor.SetFocus
            End Select
        End If
        
        If vsfLineas_Mercaderia.Col = CGL_TIPO_ENTREGA Then
            
            If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_TIPO_ENTREGA)), TE) Then
                If Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO)) = txtDeposito.text And TE!Deposito <> "" Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO) = TE!Deposito
                End If
            End If
        End If
    End If
    
    If KeyCode = vbKeyUp Then
        If vsfLineas_Mercaderia.Row = 1 Then
            If ConfPuntoVta_Pide_Codigo_Despues_Unidades Then
                If TxtLector.visible Then
                    TxtLector.SetFocus
                End If
            Else
                If TxtFactor.visible Then
                    TxtFactor.SetFocus
                End If
            End If
        End If
    End If
    
    'AIR 20171213
    If KeyCode = vbKeyDown Then
        If vsfLineas_Mercaderia.Col = CGL_UNIDADES Then
            If Not ConfPuntoVta_Permite_Unidades_Fraccionadas And val(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES))) <> Format(Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES)), "0") Then
                MsgBox "Las Unidades de Venta deben ser un Número ENTERO. Ingrese un numero valido", vbInformation, MsgTit
                vsfLineas_Mercaderia.Select vsfLineas_Mercaderia.Row - 1, CGL_UNIDADES
            End If
        End If
    End If
   
   
    If KeyCode = vbKeyEnd Then
        TxtFactor.text = ""
        If Trim(gstrUnidades_x_Defecto) <> "" Then
            TxtFactor.text = val(gstrUnidades_x_Defecto)
        End If
        TxtLector.SetFocus
    End If

End Sub

Private Sub vsfLineas_Mercaderia_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
    If ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ" Then
       char = Chr(KeyAscii)
       KeyAscii = Asc(UCase(char))
    End If
End Sub

Private Sub vsfLineas_Mercaderia_LostFocus()
Dim C As Recordset
Dim D As Recordset

    If Not Buscar_Cliente(val(txtCodProv.text), C) Then
        Exit Sub
    End If
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Exit Sub
    End If
    
    If ConfPuntoVta_Controla_Limite_Credito Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Then
    
        If C!cre_cli <> 0 Then
            
            If Not Buscar_Limite_Credito(val(txtEmpresa.text), val(txtCodDoc.text), val(txtCodProv.text), val(txtMoneda.text), CDate(txtFec_Doc.text), CDbl(NullToZero(txtImporte.text)), val(txtTipo_Cambio.text), False) Then
                Exit Sub
            End If
            'If Not Controlar_Saldo_Cliente_al_Guardar(Val(txtEmpresa.text), Val(txtCodProv.text), Val(txtCodDoc.text), txtFec_Doc.text, Val(txtMoneda.text), Val(txtTipo_Cambio.text), CDbl(NullToZero(txtImporte.text))) Then
            '    Exit Sub
            'End If
            
        End If
    End If

End Sub

Private Sub vsfLineas_Mercaderia_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
Dim TE As Recordset

    Select Case vsfLineas_Mercaderia.Col
        
'        If Button = 2 Then
'            Me.PopupMenu MTipo_Entrega
'        End If

        Case CGL_TIPO_ENTREGA
            If Button = 2 Then
                Me.PopupMenu MTipo_Entrega
                       
            End If
        
        ' AIR 20171003 agregue nuevo Popup Menu

        Case CGL_DEPOSITO
            If Button = 2 Then
                Me.PopupMenu MDeposito
            End If
        
    End Select
    
End Sub

Private Sub vsfLineas_Mercaderia_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
Dim ldblStock_Actual As Double
Dim llngsigno As Long
Dim ldblUnidades_a_Vender As Double
Dim lrstTipo_Doc As Recordset
Dim ldblPrecio_VentaSImp As Double
Dim lImpIva As Double
Dim ldblPrecio_Venta As Double
Dim ldblPrecio_Venta_Base As Double
Dim ldblPrecio_Venta_Ingresado_Base As Double
Dim ldblDescuento_x_Volumen As Double
Dim ldblCosto_Base As Double
Dim lrstUsuario As Recordset
Dim e As Recordset
Dim D As Recordset
Dim M As Recordset
Dim DE As Recordset
Dim PV As Recordset
Dim CLI As Recordset
Dim TE As Recordset
Dim lrstIva As Recordset
Dim ldblSaldo_Estado_Cuenta As Double
Dim ldblTotal_Documento_Actual As Double
Dim ldblSaldo_Estado_Cuenta_Con_Importe_Documento As Double

Dim lrstMag As Recordset     'JCH 20220528
Dim lCantidad As Double
Dim lCantSugerido As Double
Dim lPrecio As Double
Dim lprecioMGM As Double
Dim lequivalencia As Double
Dim MA As Recordset
Dim P As Recordset
Dim cantSugerido As Double
Dim valor As Double
Dim ldblDtoMaximo As Double
Dim Unidadorigen As Double

On Error GoTo Errores

    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Cancel = True
    End If
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        MsgBox "Código de Documento No Definido en el Sistema. Verifique por favor...", vbCritical, MsgTit
        Cancel = True
        Exit Sub
    End If
    
    If Not Buscar_Cliente(val(txtCodProv.text), CLI) Then
        MsgBox "Código de Cliente No Definido en el Sistema. Verifique por favor...", vbCritical, MsgTit
        Cancel = True
        Exit Sub
    End If
    
       
    
                    
    Select Case Col
    
        Case CGL_DESCRIPCION
        
            vsfLineas_Mercaderia.EditText = UCase(Trim(vsfLineas_Mercaderia.EditText))

        Case CGL_UNIDADES
                   
        
             Unidadorigen = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
             
             If val(vsfLineas_Mercaderia.EditText) > ConfPuntoVta_Unidades_Maxima_Ingresadas Then
                 MsgBox "Error - SE esta superando la cantidad maxima de unidades aceptada por linea  ", vbInformation + vbSystemModal, MsgTit
                 Cancel = True
                 Exit Sub
             End If
            
            If Trim(vsfLineas_Mercaderia.EditText) = "" Then
                MsgBox "La cantidad de Unidades No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                    MsgBox "La cantidad de Unidades debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                      
                End If
            End If
            
            If Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") <> 0 And Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") < CDbl(vsfLineas_Mercaderia.EditText) Then
                 MsgBox "La cantidad supera la cantidad maxima permitidad en el documento", vbCritical, MsgTit
                 Cancel = True
                 Exit Sub
            End If
            
            ' JE 20250708   /   ver esto -----------------------------------------------
            
            If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
            End If
            
            If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, vsfLineas_Mercaderia.TextMatrix(Row, CGL_MAGNITUD), lrstMag) Then
                lequivalencia = lrstMag!val_equivalencia
            Else
                lequivalencia = 1
            End If
            
            lCantidad = val(vsfLineas_Mercaderia.EditText)
            lPrecio = val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PRECIO_ORIGINAL))
            Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, lPrecio)
            
            vsfLineas_Mercaderia.EditText = Format(val(vsfLineas_Mercaderia.EditText), f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            ' ---------------------------------------------------------------------------------
            
            If Buscar_Articulo(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), P) Then
                If Not IsNull(P!unid_min_venta) Then
                    If P!unid_min_venta > RedondeoUnidMinVenta(val(vsfLineas_Mercaderia.EditText), P!unid_min_venta) And P!unid_min_venta > 0 Then
                         cantSugerido = Control_Cantidad_Sugerida(lCantidad, 1, vsfLineas_Mercaderia.TextMatrix(Row, CGL_NOMBRE_MAGNITUD), P)
                         vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                         vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                         lCantidad = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
                        'MsgBox "Error-no se pude vender menos de " & p!unid_min_venta & " unidades de stock ", vbInformation + vbSystemModal, MsgTit
                        'Cancel = True
                        'Exit Sub
                    End If
                End If
                If Not IsNull(P!Multiplo_unid_min_vta) Then
                    If P!Multiplo_unid_min_vta = "S" Then
                        If Not esMultiplo(val(vsfLineas_Mercaderia.EditText), P!unid_min_venta) Then
                           cantSugerido = Control_Cantidad_Sugerida(lCantidad, 1, vsfLineas_Mercaderia.TextMatrix(Row, CGL_NOMBRE_MAGNITUD), P)
                           vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                           vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                      
                           'MsgBox "La cantidad ingresa no es multiplo de " & Trim(p!unid_min_venta), vbInformation + vbSystemModal, MsgTit
                           'Cancel = True
                           'Exit Sub
                        End If
                    End If
                End If
            End If
            

            'Si esta fraccionado, la fraccion tiene que ser < 1     SS 20170320
             If ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET" Then
                 If Trim(vsfLineas_Mercaderia.EditText) <> Format(Trim(vsfLineas_Mercaderia.EditText), "0") And CDbl(Trim(vsfLineas_Mercaderia.EditText)) > 1 Then
                      MsgBox "ATENCION: Unidades Fracionadas => Ingrese por Separado las Unidades Completas (" & Int(CDbl(Trim(vsfLineas_Mercaderia.EditText))) & "), de la Unidad Fraccionada (0.5)", vbInformation, MsgTit
                      Cancel = True
                      Exit Sub
                 End If
             End If
             
            ' AIR 20250321 se mueve esta consulta afuera del if porque la rutina controlstock (que esta por fuera del if) utilizada mas abajo necesita del recordset de esta consulta
            If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
                MsgBox "Artículo Inexistente. Verifique", vbInformation, MsgTit
                Cancel = True
                Exit Sub
            End If
                        
            'Controlamos el stock
                    
             If ConfPuntoVta_Controla_Stock_Negativo Then
                    
'                If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
'                    MsgBox "Artículo Inexistente. Verifique", vbInformation, MsgTit
'                    Cancel = True
'                    Exit Sub
'                End If
                                               
                ' Los Articulos genericos no controla stock
                If rstProd!generico <> "S" Then
                    
                    ' Los Articulos de Envase los dejo por fuera del control, por ahora... porque generalmente estan en Negativo
                    If rstProd!tipo_prod <> 90 Then
                    
                    ' AIR 20171005  Implementar pasar por parametro el deposito de la linea si esta Visible el deposito por linea en el documento
                    
                        'ldblStock_Actual = Stock_Linea(txtEmpresa.Text, Trim(txtDeposito.Text), vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), ConfPuntoVta_Recalcula_Stock_On_Line)
                        ldblStock_Actual = Stock_Linea(txtEmpresa.text, Trim(UCase(vsfLineas_Mercaderia.TextMatrix(Row, CGL_DEPOSITO))), vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), ConfPuntoVta_Recalcula_Stock_On_Line)
                        
                        If Busco_Tipo_Documento_CRSet(val(txtCodDoc.text), lrstTipo_Doc) Then
                            llngsigno = lrstTipo_Doc!signo
                        Else
                            llngsigno = 0
                        End If
                        
                        If lrstTipo_Doc!signo < 0 Then
                        
                            ' Documento de Venta
                            
                            ldblUnidades_a_Vender = Calculo_Unidades_Ingresadas_x_Articulo(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), Row) + CDbl(vsfLineas_Mercaderia.EditText)
                            
                            If (ldblStock_Actual - ldblUnidades_a_Vender) < 0 Then
                            
                                If ConfPuntoVta_Permite_Venta_Stock_Negativo Then
                                    sigo = MsgBox("ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "Se Esta Vendiendo por Debajo del Stock Actual. " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00") & Chr(13) & "Desea continuar?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                                    If sigo = vbNo Then
                                        Cancel = True
                                        Exit Sub
                                    Else
                                        ' Chequeo si necesita autorizacion para Vender con Stock Negativo
                                        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                            If Not Autorizacion_Supervision(24, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                Cancel = True
                                                Exit Sub
                                            End If
                                        End If
                                    End If
                                Else
                                    ' Chequeo ahora si el Deposito Me esta configurado para que se pueda vender con Stock Negativo
                                    
                                    'AIR 20171005  pasar por parametro el deposito de la linea si corresponde
                                    
                                    'If Not Busco_Stk_Deposito(Trim(txtDeposito.Text), DE) Then
                                    If Not Busco_Stk_Deposito(Trim(UCase(vsfLineas_Mercaderia.TextMatrix(Row, CGL_DEPOSITO))), DE) Then
                                        MsgBox "ERROR: Deposito No definido en el Sistema. Verifique por favor....", vbCritical + vbOKOnly
                                        Cancel = True
                                        Exit Sub
                                    End If
                                    
                                    If Trim(UCase(DE!permite_vender_stock_negativo)) <> "S" Then
                                        MsgBox "ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "No Tiene Stock para la Venta " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00"), vbCritical + vbOKOnly, MsgTit
                                        Cancel = True
                                        Exit Sub
                                    Else
                                        sigo = MsgBox("ADVERTENCIA!!!, El Articulo " & lCod & "  -  " & Trim(rstProd!nom_prod) & Chr(13) & "Se Esta Vendiendo por Debajo del Stock Actual. " & Chr(13) & "Cantidad (Total) a Facturar --> " & Format(ldblUnidades_a_Vender, "0.00") & "  Stock Actual --> " & Format(ldblStock_Actual, "0.00") & Chr(13) & "Desea continuar?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
                                        If sigo = vbNo Then
                                            Cancel = True
                                            Exit Sub
                                        Else
                                            ' Chequeo si necesita autorizacion para Vender con Stock Negativo
                                            If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                                                If Not Autorizacion_Supervision(24, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                                    Cancel = True
                                                    Exit Sub
                                                End If
                                            End If
                                        End If
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
             End If
                    
             vsfLineas_Mercaderia.EditText = Format(vsfLineas_Mercaderia.EditText, f_Mascara_Decimales_para_Format(ConfPuntoVta_Unidades_Decimales))
                    
                                    
            ' Documentos parciales => se controla cambio en la cantidad (no puede ser mayor que el doc original + - los doc de referencia)  SS 20160208
            If ConfControla_Saldo_Cantidad_Por_Documento Then
                ' Si la cant original o cantidad entregada es > 0, la linea viene de un doc.original, debemos controlar saldos
                If D!signo = 1 Then     'es una devolucion
                    If vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CANTIDAD_ENTREGADA) <> 0 Then
                        If CDbl(vsfLineas_Mercaderia.EditText) > vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CANTIDAD_ENTREGADA) Then
                            MsgBox "La Cantidad NO puede ser mayor a la Cantidad Entregada", vbCritical, MsgTit
                            Cancel = True
                            Exit Sub
                        End If
                    End If
                Else
                    If vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CANTIDAD_SALDO) <> 0 Then
                        If CDbl(vsfLineas_Mercaderia.EditText) > vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CANTIDAD_SALDO) Then
                            MsgBox "La Cantidad NO puede ser mayor al Saldo a Entregar", vbCritical, MsgTit
                            Cancel = True
                            Exit Sub
                        End If
                    End If
                End If
            End If
                      
            
            'AIR 20171213 se agrega control de unidades fraccionadas en la linea
            If vsfLineas_Mercaderia.Col = CGL_UNIDADES Then
                If Not ConfPuntoVta_Permite_Unidades_Fraccionadas And val(Trim(vsfLineas_Mercaderia.EditText)) <> Format(Trim(vsfLineas_Mercaderia.EditText), "0") Then
                    MsgBox "Las Unidades de Venta deben ser un Número ENTERO. Ingrese un numero valido", vbInformation, MsgTit
                    vsfLineas_Mercaderia.Select vsfLineas_Mercaderia.Row, CGL_UNIDADES
                   
                End If
            End If
            
            
            If Not ControlStock(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES), _
                 vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) Then
                 vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES) = ""
                 Cancel = True
                 Exit Sub
            End If
            
            If ConfPuntoVta_Usar_Descuentos_x_Volumen Then
                ' Busco si Hay Descuentos x Volumen de Venta
                If Busco_Descuento_x_Volumen_General(val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_LISTA)), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.EditText), val(Unidadorigen), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1)), ldblDescuento_x_Volumen) Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1) = Format(ldblDescuento_x_Volumen, "0.00")
                End If
            End If
            
            
            
            
        Case CGL_UNIDADES_MAGNITUD
             Unidadorigen = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
             
             
             If val(vsfLineas_Mercaderia.EditText) > ConfPuntoVta_Unidades_Maxima_Ingresadas Then
                 MsgBox "Error - SE esta superando la cantidad maxima de unidades aceptadas por linea  ", vbInformation + vbSystemModal, MsgTit
                 Cancel = True
                 Exit Sub
             End If
             
            If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
            End If
            
            If Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") <> 0 And Buscar_Configuracion_Variables_Documento_N(CLng(txtCodDoc.text), "CANTIDAD_MAXIMA_INGRESADA_ARTICULO") < CDbl(vsfLineas_Mercaderia.EditText) Then
                 MsgBox "La cantidad supera la cantidad maxima permitidad en el documento", vbCritical, MsgTit
                 Cancel = True
                 Exit Sub
            End If
            
        
            If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, vsfLineas_Mercaderia.TextMatrix(Row, CGL_MAGNITUD), lrstMag) Then
                lequivalencia = lrstMag!val_equivalencia
            Else
                lequivalencia = 1
            End If
            lCantidad = val(vsfLineas_Mercaderia.EditText)
            lPrecio = val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PRECIO_ORIGINAL))
            Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, lPrecio)
            
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(lCantidad, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.EditText = Format(val(vsfLineas_Mercaderia.EditText), f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(val(vsfLineas_Mercaderia.EditText), f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
            lCantidad = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
            
            If Not IsNull(rstProd!unid_min_venta) Then
                If rstProd!unid_min_venta > RedondeoUnidMinVenta(lCantidad, rstProd!unid_min_venta) And rstProd!unid_min_venta > 0 Then
                    cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, vsfLineas_Mercaderia.TextMatrix(Row, CGL_MAGNITUD), rstProd)
                    vsfLineas_Mercaderia.EditText = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                    Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio)
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                    lCantidad = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
                    'MsgBox "Error-no se pude vender menos de " & rstProd!unid_min_venta & " unidades de stock ", vbInformation + vbSystemModal, MsgTit
                    'Cancel = True
                    'Exit Sub
                End If
            End If
            
            If Not IsNull(rstProd!Multiplo_unid_min_vta) Then
                If rstProd!Multiplo_unid_min_vta = "S" Then
                    If Not esMultiplo(lCantidad, rstProd!unid_min_venta) Then
                       cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, vsfLineas_Mercaderia.TextMatrix(Row, CGL_NOMBRE_MAGNITUD), rstProd)
                       vsfLineas_Mercaderia.EditText = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio)
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       'vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        
                        
                        
                        'MsgBox "La cantidad ingresa no es multiplo de " & Trim(rstProd!unid_min_venta), vbInformation + vbSystemModal, MsgTit
                        'Cancel = True
                        'Exit Sub
                    End If
                End If
            End If
            
            'Si esta fraccionado, la fraccion tiene que ser < 1     SS 20170320
            If ConfFormato_Factura = "TABACCOS" Or ConfFormato_Factura = "ENET" Then
                If Trim(vsfLineas_Mercaderia.EditText) <> Format(Trim(vsfLineas_Mercaderia.EditText), "0") And CDbl(Trim(vsfLineas_Mercaderia.EditText)) > 1 Then
                     MsgBox "ATENCION: Unidades Fracionadas => Ingrese por Separado las Unidades Completas (" & Int(CDbl(Trim(vsfLineas_Mercaderia.EditText))) & "), de la Unidad Fraccionada (0.5)", vbInformation, MsgTit
                     Cancel = True
                     Exit Sub
                End If
            End If
            
                        
            If Not ControlStock(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES), _
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) Then
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES) = ""
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES_MAGNITUD) = ""
                     Cancel = True
                     Exit Sub
            End If
            
            If ConfPuntoVta_Usar_Descuentos_x_Volumen Then
                 ' Busco si Hay Descuentos x Volumen de Venta
                If Not Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES_MAGNITUD)), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), ldblDescuento_x_Volumen) Then
                    ldblDescuento_x_Volumen = 0
                End If
                If Busco_Descuento_x_Volumen_General_Magnitud(val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO)), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_LISTA)), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES_MAGNITUD)), val(Unidadorigen), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1), val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), ldblDescuento_x_Volumen) Then
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1) = Format(ldblDescuento_x_Volumen, "0.00")
                Else
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1) = Format(0, "0.00")
                   
                End If
            End If
            
            
            
        Case CGL_PUNITARIOSINIVA
        
            valor = val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA))
            lPrecio = Importe_Con_Impuestos_Vigente(val(vsfLineas_Mercaderia.EditText), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA))
            lCantidad = val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD))
            
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                     If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), lrstMag) Then
                          vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio * lCantidad / vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                     Else
                          vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                     End If
                Else
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
            
            If Not ControlDescuentosRegistro(Row) Then
                vsfLineas_Mercaderia.EditText = valor
                If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                   lPrecio = Importe_Con_Impuestos_Vigente(val(vsfLineas_Mercaderia.EditText), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA))
                   If confUsaEquivalenciaMagnitudes Then
                        vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), lrstMag) Then
                            vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio * lCantidad / vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        Else
                            vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                    Else
                        vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                End If
                Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                 'Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True)
            End If
            
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(val(val(vsfLineas_Mercaderia.EditText)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
          
            
           
            
        Case CGL_NOMBRE_MAGNITUD
            If Trim(vsfLineas_Mercaderia.EditText) = Trim(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_NOMBRE_MAGNITUD)) Then
                Exit Sub
            End If
            
            lMagnitud = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)
            
            If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
            End If
            
            If Busco_Magnitud_Descripcion_Corta(Trim(vsfLineas_Mercaderia.EditText), TE) Then
                 lMagnitud = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)
                 vsfLineas_Mercaderia.TextMatrix(Row, CGL_MAGNITUD) = TE!codigo
            End If
            
            ldblStock_Actual = Stock_Linea(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(Row, CGL_DEPOSITO), vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), True)
            
            If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)) = rstProd!magnitud Then
                 lequivalencia = 1
                 vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES), f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                 vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            Else
                 If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), lrstMag) Then
                     lequivalencia = lrstMag!val_equivalencia
                     
                     vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) / lequivalencia, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                     vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) * lequivalencia, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                     ldblStock_Actual = ldblStock_Actual / lequivalencia
                 End If
            End If
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK) = Format(ldblStock_Actual, "0.00")
                      
            lCantidad = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
            If Not IsNull(rstProd!unid_min_venta) Then
                   If rstProd!unid_min_venta > RedondeoUnidMinVenta(lCantidad, rstProd!unid_min_venta) And rstProd!unid_min_venta > 0 Then
                       cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, TE!UniMed, rstProd)
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio)
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       cantSugerido = vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)
                      'MsgBox "Error-no se pude vender menos de " & rstProd!unid_min_venta & " unidades de stock ", vbInformation + vbSystemModal, MsgTit
                      'Cancel = True
                      Exit Sub
                  End If
            End If
            
            If Not IsNull(rstProd!Multiplo_unid_min_vta) Then
                If rstProd!Multiplo_unid_min_vta = "S" Then
                    If Not esMultiplo(lCantidad, rstProd!unid_min_venta) Then
                       cantSugerido = Control_Cantidad_Sugerida(lCantidad, lequivalencia, TE!UniMed, rstProd)
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       Call CalcularCantidadyPrecioEquivalente(lequivalencia, cantSugerido, lPrecio)
                       vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES) = Format(cantSugerido, f_Mascara_Decimales_Unidades_para_Format_Segun_Configuracion(val(txtCodDoc.text)))
                       
                    End If
                End If
            End If
            If Not ControlStock(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES), _
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) Then
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES) = "0"
                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES_MAGNITUD) = "0"
                Cancel = True
                Exit Sub
            End If
            
            
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD)), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO)), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
            
            valor = ObtenerPrecioMinimoVenta(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), val(txtLista.text), txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ldblDtoMaximo)
            
            If confUsaEquivalenciaMagnitudes Then
               Call CalcularCantidadyPrecioEquivalente(lequivalencia, lCantidad, valor)
            End If
                        
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_PRECIO_MINIMO) = Format(valor, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            vsfLineas_Mercaderia.TextMatrix(lrow, CGL_DESCUENTO_MAXIMO) = Format(ldblDtoMaximo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            
            If ConfPuntoVta_Usar_Descuentos_x_Volumen Then
                 ' Busco si Hay Descuentos x Volumen de Venta
                If Busco_Descuento_x_Volumen_x_Articulo_Vigente_a_una_Fecha(val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)), val(txtLista.text), CDate(txtFec_Doc.text), val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES)), val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD)), val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_MAGNITUD)), ldblDescuento_x_Volumen) Then
                     vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1) = Format(ldblDescuento_x_Volumen, "0.00")
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1) = Format(0, "0.00")
                 End If
            End If
            
            If Not ControlDescuentosRegistro(Row) Then
                Cancel = True
                Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                 'Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True)
            End If
            
            
        Case CGL_PUNITARIO_MAGNITUD
        
            If Not Busco_Producto(vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO)) Then
            End If
            
                       
            lCantidad = val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES_MAGNITUD))
            lPrecio = val(vsfLineas_Mercaderia.EditText)
            
            valor = CDbl(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD))
            
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(val(vsfLineas_Mercaderia.EditText), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            If Not ControlDescuentosRegistro(Row) Then
                vsfLineas_Mercaderia.EditText = valor
                vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD) = Format(valor, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
           
                Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                
                'Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True)
            
            End If
            
            If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), lrstMag) Then
               ' Call CalcularCantidadyPrecioEquivalente(lrstMag!val_equivalencia, lCantidad, lPrecio)
                                
                vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(lPrecio * lCantidad / vsfLineas_Mercaderia.TextMatrix(Row, CGL_UNIDADES), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
            Else
                If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)) = rstProd!magnitud Then
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(vsfLineas_Mercaderia.EditText, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                     MsgBox "Magnitud sin equivalencia para el articulo", vbCritical, MsgTit
                     Cancel = True
                     Exit Sub
                End If
            End If
            
                        
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.EditText), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO)), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
            
                       
            

        Case CGL_PUNITARIO, CGL_PUNITARIOSIMP
        
           If Trim(vsfLineas_Mercaderia.EditText) = "" Then
                MsgBox "El precio No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
           Else
                If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                    MsgBox "El Precio debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    
             ' AIR  20181228 se pasa la consulta a Documentos y clientes para mas arriba
 
                ' AIR 20221005 se agrega control de precio minimo por si se digito el precio a mano en la grilla ================================================================
                    '-----------------------------------  PRECIO UNITARIO  -----------------------------------------
                   
                    Dim lPrecio_Minimo As Double
                    Dim L As Recordset
                    Dim lLista_Minimo As Long
                    If UCase(Trim(ConfPuntoVta_Controla_PMinimo)) = "S" And val(txtCodDoc.text) <> ConfDoc_Ruptura And val(txtCodDoc.text) <> ConfDoc_Ruptura2 _
                    And CGL_PUNITARIO = Col Then
                    ' Se controla que el Precio no sea menor al Precio de la lista Minima
                    
                        If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
                            lLista_Minimo = L!lista_precio_minimo
                        End If
                        'AIR 20221116 falto el ver que si la lista no tiene lista minima definida no debe controlar
                        If lLista_Minimo <> 0 Then
                            lPrecio_Minimo = Busco_Precio_Emision(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), lLista_Minimo, val(txtMoneda.text), CDbl(txtTipo_Cambio.text), Format(date, "dd/mm/yyyy"), "N", PV)
                            If vsfLineas_Mercaderia.EditText < lPrecio_Minimo Then
                                'vsfLineas_Mercaderia.EditText = lPrecio_Minimo
                                vsfLineas_Mercaderia.EditText = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO)
                                MsgBox "EL PRECIO QUEDA POR DEBAJO DEL PRECIO MINIMO DE LA LISTA : " & lPrecio_Minimo, vbInformation + vbOKOnly
                                
                                lPrecio_Minimo = 0
                            End If
                        End If
                    End If
                ' ==========================================================================
               
                    ' AIR 20181228  Se pasa todo el control del precio de venta a un  rutina de control de Venta debajo de P.Venta y Costo
                    Cancel = Control_PUnitario_Debajo_PVenta_o_Costo(e, D, CLI)
       
                End If
            End If
            valor = CDbl(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO))
            
            If Not (Trim(confPuntoVta_Ver_Columna_PUnitario_SIVA_Siempre) = "N" Or Trim(UCase(e!imp_inc_facturador)) = "N" Or Trim(D!exportacion) = "S") Then
                If confUsaEquivalenciaMagnitudes Then
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO_MAGNITUD)), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.EditText), vsfLineas_Mercaderia.TextMatrix(Row, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
            vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(val(val(vsfLineas_Mercaderia.EditText)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
           
            If Not ControlDescuentosRegistro(Row) Then
                vsfLineas_Mercaderia.TextMatrix(Row, CGL_PUNITARIO) = Format(valor, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
                Call Calculo_Total_Lineas_Mercaderia(vsfLineas_Mercaderia, True)
                
                Exit Sub
                'Call Calcular_Importes_de_la_Linea_Mercaderia(lrow, False, True)
            End If

        Case CGL_DTO1
            If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                MsgBox "El Descuento debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Controlo_Descuento_Linea(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.EditText, vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO2), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO3), CGL_DTO1) Then
                    'vsfLineas_Mercaderia.EditText = Format(vsfLineas_Mercaderia.EditText, "0.00")
                    
                    ' se agrega el control de precio en los descuentos
                    Cancel = Control_PUnitario_Debajo_PVenta_o_Costo(e, D, CLI)
                    
                Else
                    Cancel = True
                    Exit Sub
                End If
            End If
            ' AIR 20170710
            'If ConfFormato_Factura = "MANTA" Then
            If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia Then
                vsfLineas_Mercaderia.Select Row, CGL_DTO2
            End If
            
        Case CGL_DTO2
            If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                MsgBox "El Descuento debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Controlo_Descuento_Linea(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1), vsfLineas_Mercaderia.EditText, vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO3), CGL_DTO2) Then
                    vsfLineas_Mercaderia.EditText = Format(vsfLineas_Mercaderia.EditText, "0.00")
                    ' AIR 20181231 se agrega el control de precio en los descuentos
                    Cancel = Control_PUnitario_Debajo_PVenta_o_Costo(e, D, CLI)
                    
                Else
                    Cancel = True
                    Exit Sub
                End If
            End If
            
            ' AIR 20170710
            'If ConfFormato_Factura = "MANTA" Then
            If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia Then
                vsfLineas_Mercaderia.Select Row, CGL_DTO3
            End If
            
        Case CGL_DTO3
            If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                MsgBox "El Descuento debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Controlo_Descuento_Linea(vsfLineas_Mercaderia.Row, vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO2), vsfLineas_Mercaderia.EditText, CGL_DTO3) Then
                    vsfLineas_Mercaderia.EditText = Format(vsfLineas_Mercaderia.EditText, "0.00")
                    
                    ' AIR 20181231 se agrega el control de precio en los descuentos
                    Cancel = Control_PUnitario_Debajo_PVenta_o_Costo(e, D, CLI)
                Else
                    Cancel = True
                    Exit Sub
                End If
            End If
            
            ' AIR 20170710 el cursor vuelve automaticamente al campo de unidades
            'If ConfFormato_Factura = "MANTA" Then
            If ConfPuntoVta_Pide_Descuentos_Grilla_Mercaderia Then
                TxtFactor.SetFocus
            End If
            
        Case CGL_CAJAS
            If Trim(vsfLineas_Mercaderia.EditText) <> "" Then
                If Not IsNumeric(vsfLineas_Mercaderia.EditText) Then
                    MsgBox "La Cantidad de Cajas debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    vsfLineas_Mercaderia.EditText = Format(vsfLineas_Mercaderia.EditText, "0")
                End If
            End If

        Case CGL_TIPO_ENTREGA
            If Not confPuntoVta_Inicializar_Deposito_X_Articulo Then
                If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.EditText), TE) Then
                    If TE!Deposito <> "" Then
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO) = TE!Deposito
                    End If
                End If
            End If
            
        Case CGL_DEPOSITO
            If Not ControlStock(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DEPOSITO), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_UNIDADES), _
                 vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_STOCK)) Then
                Cancel = True
                Exit Sub
            Else
                If confUsaEquivalenciaMagnitudes Then
                    lMagnitud = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)
                    ldblStock_Actual = Stock_Linea(val(txtEmpresa.text), vsfLineas_Mercaderia.EditText, vsfLineas_Mercaderia.TextMatrix(Row, CGL_CODIGO), True)
            
                    If val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)) = rstProd!magnitud Then
                        lequivalencia = 1
                    Else
                        If Buscar_Equivalencia(rstProd!Cod_Prod, rstProd!magnitud, val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_MAGNITUD)), lrstMag) Then
                            lequivalencia = lrstMag!val_equivalencia
                            ldblStock_Actual = ldblStock_Actual / lequivalencia
                        End If
                    End If
                    vsfLineas_Mercaderia.TextMatrix(Row, CGL_STOCK) = Format(ldblStock_Actual, "0.00")
                End If
            End If
                
    End Select
    
    Exit Sub
    
Errores:
    MsgBox Err.Description, vbInformation, MsgTit
    
    
    

End Sub

Function Control_PUnitario_Debajo_PVenta_o_Costo(e As Recordset, D As Recordset, CLI As Recordset) As Boolean


On Error GoTo Errores

Dim ldblStock_Actual As Double
Dim llngsigno As Long
Dim ldblUnidades_a_Vender As Double
Dim lrstTipo_Doc As Recordset
Dim ldblPrecio_VentaSImp As Double
Dim lImpIva As Double
Dim ldblPrecio_Venta As Double
Dim ldblPrecio_Venta_Base As Double
Dim ldblPrecio_Venta_Ingresado_Base As Double
Dim ldblDescuento_x_Volumen As Double
Dim ldblCosto_Base As Double
Dim lrstUsuario As Recordset
Dim M As Recordset
Dim DE As Recordset
Dim PV As Recordset
Dim TE As Recordset
Dim lrstIva As Recordset

Dim Punitario As Double
Dim Punitariosimp As Double
Dim PunitariocDto As Double
Dim PunitariocDto_Base As Double
Dim ldblTCambio As Double

Dim dto1 As Double
Dim dto2 As Double
Dim dto3 As Double
Dim Dtogral As Double
Dim Col As Integer


        Col = vsfLineas_Mercaderia.Col

        If Not confUsaEquivalenciaMagnitudes Then
            Punitario = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO)
            Punitariosimp = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIOSIMP)
        Else
            Punitario = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO_MAGNITUD)
            Punitariosimp = Round(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIOSIMP) * vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO_MAGNITUD) / vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO), 2)
        End If
        
        
        Dtogral = CDbl(NullToZero(txtDtoGlobal.text))
        dto1 = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO1)
        dto2 = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO2)
        dto3 = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_DTO3)


        Select Case Col
            Case CGL_PUNITARIO
                Punitario = CDbl(vsfLineas_Mercaderia.EditText)
            Case CGL_PUNITARIOSIMP
                Punitariosimp = CDbl(vsfLineas_Mercaderia.EditText)
            Case CGL_DTO1
                dto1 = CDbl(vsfLineas_Mercaderia.EditText)
            Case CGL_DTO2
                dto2 = CDbl(vsfLineas_Mercaderia.EditText)
            Case CGL_DTO3
                dto3 = CDbl(vsfLineas_Mercaderia.EditText)
            Case Else
                Punitario = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO)
                Punitariosimp = vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIOSIMP)
        End Select
        
        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, Col) = Format(vsfLineas_Mercaderia.EditText, "0#.00")

        PunitariocDto = Punitario - (Punitario * Dtogral / 100)
        PunitariocDto = PunitariocDto - (PunitariocDto * dto1 / 100)
        PunitariocDto = PunitariocDto - (PunitariocDto * dto2 / 100)
        PunitariocDto = PunitariocDto - (PunitariocDto * dto3 / 100)
        PunitariocDto_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, PunitariocDto)
      
        ldblPrecio_VentaSImp = Punitario
        lImpIva = (ldblPrecio_VentaSImp) * val(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_IVA)) / 100

        If ConfPuntoVta_Controla_Venta_Menor_PVenta Then

            ldblPrecio_Venta = Busco_Precio_Emision(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
            ldblPrecio_Venta_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblPrecio_Venta)
            
            If Col = CGL_PUNITARIOSIMP Then
                If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                    ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblPrecio_VentaSImp + lImpIva)
                Else
                    ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblPrecio_VentaSImp)
                End If
            Else
                ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, Punitariosimp)
            End If

            ' Comparo los Importes en Moneda Base
            If ldblPrecio_Venta_Base > PunitariocDto_Base Then   '  'AIR 20181231   ldblPrecio_Venta_Base > ldblPrecio_Venta_Ingresado_Base Then

                If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                    If Not Autorizacion_Supervision(22, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                        MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al Precio de Venta del Sistema. ", vbCritical, MsgTit
                        
                        Control_PUnitario_Debajo_PVenta_o_Costo = True
                        Exit Function
                    Else
                        MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR QUE EL ACTUAL DEL SISTEMA... ", vbCritical, MsgTit

                        If Col = CGL_PUNITARIOSIMP Then
                            If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            Else
                                vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            End If
                        Else
                            If Col = CGL_PUNITARIOIMP Then
                                vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        
                            End If
                        End If
                    End If
                Else
                    If Busco_Usuario(CStr(gNro_Usuario), lrstUsuario) Then
                        If lrstUsuario!nivel >= gNivel_Supervisor Then
                            MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR QUE EL ACTUAL DEL SISTEMA... ", vbCritical, MsgTit
                            If Col = CGL_PUNITARIOSIMP Then
                                If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                Else
                                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                End If
                            Else
                                If Col = CGL_PUNITARIOIMP Then
                                    vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                End If
                            End If
                        Else
                            MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al Precio de Venta del Sistema. ", vbCritical, MsgTit
                         
                            Control_PUnitario_Debajo_PVenta_o_Costo = True
                            Exit Function
                        End If
                    Else
                        MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al Precio de Venta del Sistema. ", vbCritical, MsgTit
                        Control_PUnitario_Debajo_PVenta_o_Costo = True
                        Exit Function
                    End If
                End If
            Else
                If Col = CGL_PUNITARIOSIMP Then
                    If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    Else
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                Else
                    If Col = CGL_PUNITARIOIMP Then
                        vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                End If
            End If
        Else
            If Col = CGL_PUNITARIOSIMP Then
                If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            ElseIf Col = CGL_PUNITARIOSIMP Then
                    vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            End If
        End If


        'Controlamos precio debajo del costo

        If ConfPuntoVta_Controla_Venta_Menor_PCosto Then

            If Busco_Costo(vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_CODIGO), txtFec_Doc.text) Then
                
            ' AIR 20190731 se busca el tipo de cambio de conversion de costos porque cuando esta en USD el costo y la factura en pesos no convertia bien a pesos
               'ldblCosto_Base = Importe_Base(rstPrec!moneda, txtTipo_Cambio.text, txtFec_Doc.text, rstPrec!precio_cto)
               
                ldblTCambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), rstPrec!moneda, txtFec_Doc.text, "CC")
                ldblCosto_Base = Importe_Base(rstPrec!moneda, ldblTCambio, txtFec_Doc.text, rstPrec!precio_cto)
                
                ' AIR 20181228 se agrega que se le quite el Iva al costo cuando la empresa no maneja Iva en el punto de venta
                If Trim(UCase(e!imp_inc_facturador)) = "N" Then
                    If Busco_Vista_IVA(rstPrec!cod_iva_compras, lrstIva) Then

                        ldblCosto_Base = ldblCosto_Base / (1 + lrstIva!porcentaje / 100)

                    End If
                End If
                If Col = CGL_PUNITARIOSIMP Then
                    If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                        ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblPrecio_VentaSImp + lImpIva)
                    Else
                        ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, ldblPrecio_VentaSImp)
                    End If
                Else
                    ldblPrecio_Venta_Ingresado_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, CDbl(Punitario))
                End If

                If PunitariocDto_Base < ldblCosto_Base Then     'AIR 20181231  ldblPrecio_Venta_Ingresado_Base < ldblCosto_Base Then

                    If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
                        If Not Autorizacion_Supervision(23, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                            MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al COSTO del Sistema. ", vbCritical, MsgTit
                            Control_PUnitario_Debajo_PVenta_o_Costo = True
                            Exit Function
                        Else
                            MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR AL DEL COSTO ACTUAL DEL SISTEMA... ", vbCritical, MsgTit
                            If Col = CGL_PUNITARIOSIMP Then
                                If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                Else
                                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                End If
                            Else
                                If Col = CGL_PUNITARIOIMP Then
                                    vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                End If
                            End If
                        End If
                    Else
                        If Busco_Usuario(CStr(gNro_Usuario), lrstUsuario) Then
                            If lrstUsuario!nivel >= gNivel_Supervisor Then
                                MsgBox "NIVEL DE SUPERVISOR: SE AUTORIZA EL INGRESO DE PRECIO MENOR AL DEL COSTO ACTUAL DEL SISTEMA... ", vbCritical, MsgTit
                                If Col = CGL_PUNITARIOSIMP Then
                                    If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                        vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    Else
                                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                        vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    End If
                                Else
                                    If Col = CGL_PUNITARIOIMP Then
                                        vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                                    End If
                                End If
                            Else
                                MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al COSTO del Sistema. ", vbCritical, MsgTit
                                Control_PUnitario_Debajo_PVenta_o_Costo = True
                                Exit Function
                            End If
                        Else
                            MsgBox "El Precio de Venta Ingresado NO PUEDE SER MENOR al COSTO del Sistema. ", vbCritical, MsgTit
                            Control_PUnitario_Debajo_PVenta_o_Costo = True
                            Exit Function
                        End If
                    End If
                Else
                    If Col = CGL_PUNITARIOSIMP Then
                        If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        Else
                            vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                    Else
                        If Col = CGL_PUNITARIOIMP Then
                            vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                    End If
                End If
            Else
                If Col = CGL_PUNITARIOSIMP Then
                    If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    Else
                        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                Else
                    If Col = CGL_PUNITARIOIMP Then
                        vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    End If
                End If
            End If
        Else
            If Col = CGL_PUNITARIOSIMP Then
                If Trim(UCase(e!imp_inc_facturador)) = "S" Then
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp + lImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                    vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, CGL_PUNITARIO) = Format(ldblPrecio_VentaSImp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    vsfLineas_Mercaderia.EditText = Format(Punitariosimp, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            Else
                If Col = CGL_PUNITARIOSIMP Then
                    vsfLineas_Mercaderia.EditText = Format(Punitario, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
            End If
        End If
        
        vsfLineas_Mercaderia.TextMatrix(vsfLineas_Mercaderia.Row, Col) = Format(vsfLineas_Mercaderia.EditText, "##0.00")

Exit Function

Errores:
    MsgBox "Se ha producido un error en la validacion del precio... Vuelva a intentar. ", vbCritical, MsgTit
    Control_PUnitario_Debajo_PVenta_o_Costo = True
    
End Function

Public Sub Inicializo_Campos_para_Autorizar()

    If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
        If lcolCampos.Count < 10 Then
            ' JE 20160608
            ' Esto para conservar la compatibilidad con la forma anterior
            txtLista.Locked = True
            txtMoneda.Locked = True
            txtTipo_Cambio.Locked = True
            txtDtoGlobal.Locked = True
            txtNro_Fanfold.Locked = True
            txtVendedor.Locked = True
        Else
            If lcolCampos("txtLista").pide_autorizacion = "S" Then
                txtLista.Locked = True
                txtMoneda.Locked = True
                txtTipo_Cambio.Locked = True
                txtDtoGlobal.Locked = True
                txtNro_Fanfold.Locked = True
                txtVendedor.Locked = True
            End If
        End If
    Else
        If ConfProceso_Datos_WIS <> True Then
            txtLista.Locked = False
        End If
        txtMoneda.Locked = False
        txtTipo_Cambio.Locked = False
        txtDtoGlobal.Locked = False
        txtVendedor.Locked = False
        txtNro_Fanfold.Locked = False
    End If
    If ConfFormato_Factura = "CASINO-POS" Then
        txtCodDoc.Locked = True
    End If
    
End Sub

Public Sub Visualizar_Campos_Formulario()
' 20160620  cambiado
'Dim lclsCampos As clsCampos_Ingreso_Programa
'
'    For Each lclsCampos In lcolCampos
'        Select Case Trim(UCase(lclsCampos.campo))
'            Case Trim(UCase("txtCajas"))
'                labCajas.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
'                txtCajas.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
'            Case Trim(UCase("TxtGuia"))
'                labGuia.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
'                txtGuia.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
'        End Select
'    Next
'
Dim lclsCampos As clsCampos_Ingreso_Programa
Dim i As Long

    For i = 0 To Me.Controls.Count - 1
        If TypeOf Me.Controls(i) Is TextBox Then
            For Each lclsCampos In lcolCampos
                If Trim(UCase(lclsCampos.campo)) = Trim(UCase(Me.Controls(i).Name)) Then
                    Me.Controls(i).visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                    
                    Select Case Trim(UCase(lclsCampos.campo))
                        Case Trim(UCase("txtCajas"))
                            labCajas.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                        Case Trim(UCase("txtAcopio"))
                            labAcopio.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                            txtDescripcion_Acopio.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                        
                        Case Trim(UCase("txtCI_Persona_Autorizada"))    ' AIR 20240802
                            labCIPAUT.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                            
                        Case Trim(UCase("TxtGuia"))
                            labGuia.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                        Case Trim(UCase("txtTarea_Codigo_Documento"))
                            labCod_Doc_Tarea.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                        Case Trim(UCase("txtTarea_Numero"))
                            labNro_Doc_Tarea.visible = f_paso_S_N_a_Boolean(lclsCampos.visible)
                    End Select
                     
                End If
            Next
        End If
    Next i
    
    'AIR 20171123 Nuevo campo de orden de compra que tal vez no se vea en todos los clientes, entonces hay que dejar no visible el label tambien
    If TxtNroIdCompra.visible = False Then
        LblOC.visible = False
    Else
        LblOC.visible = True
    End If
    
End Sub

Private Sub Cambio_gbolESC()
    gbolESC = True
End Sub

Public Sub Bloquear_Campos_Formulario()
Dim lclsCampos As clsCampos_Ingreso_Programa
Dim i As Long

    For i = 0 To Me.Controls.Count - 1
        If TypeOf Me.Controls(i) Is TextBox Then
            For Each lclsCampos In lcolCampos
                If Trim(UCase(lclsCampos.campo)) = Trim(UCase(Me.Controls(i).Name)) Then
                    Me.Controls(i).Locked = f_paso_S_N_a_Boolean(lclsCampos.bloqueado)
                End If
            Next
        End If
    Next i

End Sub

Sub Inicializo_Grilla_Lineas_Impuestos()

    Screen.MousePointer = vbHourglass
                                                  
    vsfImpuestos.Rows = 1
    vsfImpuestos.Rows = vsfImpuestos.FixedRows
    vsfImpuestos.Cols = CGI_PORCENTAJE_COFIS + 1
    vsfImpuestos.FixedCols = 2
    vsfImpuestos.ColWidth(0) = 0
        
    ' AIR 20170517
    If ConfDiseño_Para_Grandes_Cifras = False Then
        vsfImpuestos.ColAlignment(CGI_PORCENTAJE_IVA) = flexAlignCenterBottom
        vsfImpuestos.TextMatrix(0, CGI_PORCENTAJE_IVA) = "% IVA"
        vsfImpuestos.ColDataType(CGI_PORCENTAJE_IVA) = flexDTDouble
        vsfImpuestos.ColWidth(CGI_PORCENTAJE_IVA) = 600
    
        vsfImpuestos.ColAlignment(CGI_IMPORTE_SIN_IMPUESTOS) = flexAlignRightBottom
        vsfImpuestos.TextMatrix(0, CGI_IMPORTE_SIN_IMPUESTOS) = "Importe"
        vsfImpuestos.ColDataType(CGI_IMPORTE_SIN_IMPUESTOS) = flexDTDouble
        vsfImpuestos.ColWidth(CGI_IMPORTE_SIN_IMPUESTOS) = 1000
    Else
        vsfImpuestos.ColAlignment(CGI_PORCENTAJE_IVA) = flexAlignCenterBottom
        vsfImpuestos.TextMatrix(0, CGI_PORCENTAJE_IVA) = "% IVA"
        vsfImpuestos.ColDataType(CGI_PORCENTAJE_IVA) = flexDTDouble
        vsfImpuestos.ColWidth(CGI_PORCENTAJE_IVA) = 500
        
        vsfImpuestos.ColAlignment(CGI_IMPORTE_SIN_IMPUESTOS) = flexAlignRightBottom
        vsfImpuestos.TextMatrix(0, CGI_IMPORTE_SIN_IMPUESTOS) = "Importe"
        vsfImpuestos.ColDataType(CGI_IMPORTE_SIN_IMPUESTOS) = flexDTDouble
        vsfImpuestos.ColWidth(CGI_IMPORTE_SIN_IMPUESTOS) = 1400
    End If
    
    vsfImpuestos.ColAlignment(CGI_IVA) = flexAlignRightBottom
    vsfImpuestos.TextMatrix(0, CGI_IVA) = "IVA"
    vsfImpuestos.ColDataType(CGI_IVA) = flexDTDouble
    vsfImpuestos.ColWidth(CGI_IVA) = 1000

    ' Oculto las Columnas de las Tasas
    vsfImpuestos.ColHidden(CGI_COFIS) = True
    vsfImpuestos.ColHidden(CGI_CODIGO_IVA) = True
    vsfImpuestos.ColHidden(CGI_PORCENTAJE_COFIS) = True

    Screen.MousePointer = vbDefault

End Sub

Sub Inicializo_Grilla_Vencimientos_Cuotas()

    Screen.MousePointer = vbHourglass
                                                  
    vsfVencimientos_Cuotas.Rows = 1
    vsfVencimientos_Cuotas.Rows = vsfVencimientos_Cuotas.FixedRows
    vsfVencimientos_Cuotas.Cols = CGVC_IMPORTE + 1
    vsfVencimientos_Cuotas.FixedCols = 1
    vsfVencimientos_Cuotas.ColWidth(0) = 0
    
    vsfVencimientos_Cuotas.ColAlignment(CGVC_NUMERO) = flexAlignCenterBottom
    vsfVencimientos_Cuotas.TextMatrix(0, CGVC_NUMERO) = "Cuota"
    vsfVencimientos_Cuotas.ColDataType(CGVC_NUMERO) = flexDTLong
    vsfVencimientos_Cuotas.ColWidth(CGVC_NUMERO) = 600
    
    vsfVencimientos_Cuotas.ColAlignment(CGVC_VENCIMIENTO) = flexAlignCenterBottom
    vsfVencimientos_Cuotas.TextMatrix(0, CGVC_VENCIMIENTO) = "Vencimiento"
    vsfVencimientos_Cuotas.ColDataType(CGVC_VENCIMIENTO) = flexDTDate
    vsfVencimientos_Cuotas.ColWidth(CGVC_VENCIMIENTO) = 1200
        
    vsfVencimientos_Cuotas.ColAlignment(CGVC_IMPORTE) = flexAlignRightBottom
    vsfVencimientos_Cuotas.TextMatrix(0, CGVC_IMPORTE) = "Importe"
    vsfVencimientos_Cuotas.ColDataType(CGVC_IMPORTE) = flexDTDouble
    vsfVencimientos_Cuotas.ColWidth(CGVC_IMPORTE) = 1200

    Screen.MousePointer = vbDefault

End Sub

Sub Inicializo_Grilla_Lineas_Medios_Pago()

    Screen.MousePointer = vbHourglass
                                                  
    vsfMedios_Pagos.Rows = 1
    vsfMedios_Pagos.Rows = vsfMedios_Pagos.FixedRows
    vsfMedios_Pagos.Cols = CGMP_TIPO_DEV_CAMBIO + 1
    vsfMedios_Pagos.FixedCols = 2
    vsfMedios_Pagos.ColWidth(0) = 0
    
    vsfMedios_Pagos.ColAlignment(CGMP_MEDIO_PAGO) = flexAlignCenterBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_MEDIO_PAGO) = "Cód."
    vsfMedios_Pagos.ColWidth(CGMP_MEDIO_PAGO) = 500
        
    vsfMedios_Pagos.ColAlignment(CGMP_CUOTAS) = flexAlignCenterBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_CUOTAS) = "Ctas."
    vsfMedios_Pagos.ColWidth(CGMP_CUOTAS) = 400
    
    vsfMedios_Pagos.ColAlignment(CGMP_MONEDA) = flexAlignRightBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_MONEDA) = "Mon."
    vsfMedios_Pagos.ColWidth(CGMP_MONEDA) = 0
    
    vsfMedios_Pagos.ColAlignment(CGMP_TC) = flexAlignRightBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_TC) = "T.C."
    vsfMedios_Pagos.ColWidth(CGMP_TC) = 600
    
    vsfMedios_Pagos.ColAlignment(CGMP_SIMBOLO) = flexAlignCenterBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_SIMBOLO) = "Mon."
    vsfMedios_Pagos.ColWidth(CGMP_SIMBOLO) = 400
    
    ' AIR 20170517
    If ConfDiseño_Para_Grandes_Cifras = False Then
        vsfMedios_Pagos.ColAlignment(CGMP_DESCRIPCION) = flexAlignLeftBottom
        vsfMedios_Pagos.TextMatrix(0, CGMP_DESCRIPCION) = "Descripción"
        vsfMedios_Pagos.ColWidth(CGMP_DESCRIPCION) = 1500
        
        vsfMedios_Pagos.ColAlignment(CGMP_IMPORTE) = flexAlignRightBottom
        vsfMedios_Pagos.TextMatrix(0, CGMP_IMPORTE) = "Importe"
        vsfMedios_Pagos.ColWidth(CGMP_IMPORTE) = 1100
    Else
        vsfMedios_Pagos.ColAlignment(CGMP_DESCRIPCION) = flexAlignLeftBottom
        vsfMedios_Pagos.TextMatrix(0, CGMP_DESCRIPCION) = "Descripción"
        vsfMedios_Pagos.ColWidth(CGMP_DESCRIPCION) = 1300
        
        vsfMedios_Pagos.ColAlignment(CGMP_IMPORTE) = flexAlignRightBottom
        vsfMedios_Pagos.TextMatrix(0, CGMP_IMPORTE) = "Importe"
        vsfMedios_Pagos.ColWidth(CGMP_IMPORTE) = 1500
    End If
    
    vsfMedios_Pagos.ColAlignment(CGMP_REFERENCIA) = flexAlignRightBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_REFERENCIA) = "Referencia"
    vsfMedios_Pagos.ColWidth(CGMP_REFERENCIA) = 1050
    vsfMedios_Pagos.ColHidden(CGMP_REFERENCIA) = Not ConfPuntoVta_Grilla_MPago_Mostrar_Referencia
    
    vsfMedios_Pagos.ColAlignment(CGMP_TIPO_DEV_CAMBIO) = flexAlignRightBottom
    vsfMedios_Pagos.TextMatrix(0, CGMP_TIPO_DEV_CAMBIO) = "Tipo Cambio Dev. Cambio"
    vsfMedios_Pagos.ColWidth(CGMP_TIPO_DEV_CAMBIO) = 1050
    
    vsfMedios_Pagos.ColHidden(CGMP_CODDOC) = True
    vsfMedios_Pagos.ColHidden(CGMP_NRODOC) = True
    vsfMedios_Pagos.ColHidden(CGMP_CODPROV) = True
    
    vsfMedios_Pagos.ColHidden(CGMP_TIPO_DEV_CAMBIO) = True
    vsfMedios_Pagos.ColHidden(CGMP_TIPO_MPAGO) = True

    Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
        Case "DESCRIPCION"
            vsfMedios_Pagos.SelectionMode = flexSelectionFree
        Case Else
            vsfMedios_Pagos.SelectionMode = flexSelectionByRow
    End Select
        
    Screen.MousePointer = vbDefault

End Sub


Sub Inicializo_Grilla_Cheques()
Dim i As Integer

    Screen.MousePointer = vbHourglass
                                                  
    vsfCheques.Rows = 1
    vsfCheques.Rows = vsfCheques.FixedRows
'
    vsfCheques.Cols = CGCH_NRO_DOCA_DEP + 1
    vsfCheques.FixedCols = 1
    vsfCheques.ColWidth(0) = 0
    vsfCheques.TextMatrix(0, CGCH_BANCO) = "Banco"
    vsfCheques.ColAlignment(CGCH_BANCO) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_BANCO) = flexDTLong
    vsfCheques.ColWidth(CGCH_BANCO) = 600
    
    vsfCheques.TextMatrix(0, CGCH_DESCRIPCION) = "Descripción"
    vsfCheques.ColAlignment(CGCH_DESCRIPCION) = flexAlignLeftBottom
    vsfCheques.ColDataType(CGCH_DESCRIPCION) = flexDTString
    vsfCheques.ColWidth(CGCH_DESCRIPCION) = 1000
    
    vsfCheques.TextMatrix(0, CGCH_CUENTA) = "Cuenta"
    vsfCheques.ColAlignment(CGCH_CUENTA) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_CUENTA) = flexDTLong
    vsfCheques.ColWidth(CGCH_CUENTA) = 600

    vsfCheques.TextMatrix(0, CGCH_DOCUMENTO) = "Doc."
    vsfCheques.ColAlignment(CGCH_DOCUMENTO) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_DOCUMENTO) = flexDTLong
    vsfCheques.ColWidth(CGCH_DOCUMENTO) = 500
    
    vsfCheques.TextMatrix(0, CGCH_SERIE) = "Serie"
    vsfCheques.ColAlignment(CGCH_SERIE) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_SERIE) = flexDTString
    vsfCheques.ColWidth(CGCH_SERIE) = 500
    
    vsfCheques.TextMatrix(0, CGCH_NUMERO_CHEQUE) = "Número"
    vsfCheques.ColAlignment(CGCH_NUMERO_CHEQUE) = flexAlignRightBottom
    vsfCheques.ColDataType(CGCH_NUMERO_CHEQUE) = flexDTLong
    vsfCheques.ColWidth(CGCH_NUMERO_CHEQUE) = 1000
    
    vsfCheques.TextMatrix(0, CGCH_FECHA_EMISION) = "F.Emisión"
    vsfCheques.ColAlignment(CGCH_FECHA_EMISION) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_FECHA_EMISION) = flexDTDate
    vsfCheques.ColWidth(CGCH_FECHA_EMISION) = 1100
    
    vsfCheques.TextMatrix(0, CGCH_FECHA_VTO) = "Vencimiento"
    vsfCheques.ColAlignment(CGCH_FECHA_VTO) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_FECHA_VTO) = flexDTDate
    vsfCheques.ColWidth(CGCH_FECHA_VTO) = 1100
    
    vsfCheques.TextMatrix(0, CGCH_MONEDA) = "Mon."
    vsfCheques.ColAlignment(CGCH_MONEDA) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_MONEDA) = flexDTLong
    vsfCheques.ColWidth(CGCH_MONEDA) = 500
    
    vsfCheques.TextMatrix(0, CGCH_TC) = "TC."
    vsfCheques.ColAlignment(CGCH_TC) = flexAlignRightBottom
    vsfCheques.ColDataType(CGCH_TC) = flexDTDouble
    vsfCheques.ColWidth(CGCH_TC) = 700
    
    vsfCheques.TextMatrix(0, CGCH_SIMBOLO) = ""
    vsfCheques.ColAlignment(CGCH_SIMBOLO) = flexAlignCenterBottom
    vsfCheques.ColDataType(CGCH_SIMBOLO) = flexDTString
    vsfCheques.ColWidth(CGCH_SIMBOLO) = 400
    
    ' AIR 20170517
    
    If ConfDiseño_Para_Grandes_Cifras = False Then
        vsfCheques.TextMatrix(0, CGCH_IMPORTE) = "Importe"
        vsfCheques.ColAlignment(CGCH_IMPORTE) = flexAlignRightBottom
        vsfCheques.ColDataType(CGCH_IMPORTE) = flexDTDouble
        vsfCheques.ColWidth(CGCH_IMPORTE) = 1100
        vsfCheques.ColFormat(CGCH_IMPORTE) = "###,##0.00"
    Else
        vsfCheques.TextMatrix(0, CGCH_IMPORTE) = "Importe"
        vsfCheques.ColAlignment(CGCH_IMPORTE) = flexAlignRightBottom
        vsfCheques.ColDataType(CGCH_IMPORTE) = flexDTDouble
        vsfCheques.ColWidth(CGCH_IMPORTE) = 1400
        vsfCheques.ColFormat(CGCH_IMPORTE) = "###,###,##0.00"
    End If
    
    vsfCheques.TextMatrix(0, CGCH_IMPORTE_DEL_DOC) = "Importe en la Moneda del Documento"
    vsfCheques.ColAlignment(CGCH_IMPORTE_DEL_DOC) = flexAlignRightBottom
    vsfCheques.ColDataType(CGCH_IMPORTE_DEL_DOC) = flexDTDouble
    vsfCheques.ColWidth(CGCH_IMPORTE_DEL_DOC) = 0
    
    vsfCheques.TextMatrix(0, CGCH_CUENTA_LIBRADOR) = "Cta.Librador"
    vsfCheques.ColAlignment(CGCH_CUENTA_LIBRADOR) = flexAlignLeftBottom
    vsfCheques.ColDataType(CGCH_CUENTA_LIBRADOR) = flexDTString
    vsfCheques.ColWidth(CGCH_CUENTA_LIBRADOR) = 1000
    
    vsfCheques.TextMatrix(0, CGCH_TITULAR_LIBRADOR) = "Titular Librador"
    vsfCheques.ColAlignment(CGCH_TITULAR_LIBRADOR) = flexAlignLeftBottom
    vsfCheques.ColDataType(CGCH_TITULAR_LIBRADOR) = flexDTString
    vsfCheques.ColWidth(CGCH_TITULAR_LIBRADOR) = 2000
    
    vsfCheques.TextMatrix(0, CGCH_OBS) = "Observaciones"
    vsfCheques.ColAlignment(CGCH_OBS) = flexAlignLeftBottom
    vsfCheques.ColDataType(CGCH_OBS) = flexDTString
    vsfCheques.ColWidth(CGCH_OBS) = 2000
    vsfCheques.ColHidden(CGCH_OBS) = True
    
    ' AIR 20180906
    vsfCheques.ColHidden(CGCH_ESTADO) = True
    vsfCheques.ColHidden(CGCH_FEC_REG) = True
    vsfCheques.ColHidden(CGCH_USUARIO) = True
    vsfCheques.ColHidden(CGCH_COD_BANCO_EMI) = True
    vsfCheques.ColHidden(CGCH_FEC_BANCO) = True
    vsfCheques.ColHidden(CGCH_NRO_INT) = True
    vsfCheques.ColHidden(CGCH_COD_DOCA_DEP) = True
    vsfCheques.ColHidden(CGCH_NRO_DOCA_DEP) = True

    If vsfCheques.Rows = 1 Then
        vsfCheques.Rows = vsfCheques.Rows + 1
    End If
    
    
    
    Screen.MousePointer = vbDefault
    
End Sub


'Sub Inicializo_Grilla_Cheques()
'Dim i As Integer
'
'    Screen.MousePointer = vbHourglass
'
'    vsfCheques.Rows = 1
'    vsfCheques.Rows = vsfCheques.FixedRows
''
'    vsfCheques.Cols = CGCH_IMPORTE + 1
'    vsfCheques.FixedCols = 1
'    vsfCheques.ColWidth(0) = 0
'    vsfCheques.ColAlignment(CGCH_BANCO) = flexAlignCenterBottom
'    vsfCheques.TextMatrix(0, CGCH_BANCO) = "Banco"
'    vsfCheques.ColWidth(CGCH_BANCO) = 600
'
'    vsfCheques.ColAlignment(CGCH_DESCRIPCION) = flexAlignLeftBottom
'    vsfCheques.TextMatrix(0, CGCH_DESCRIPCION) = "Descripción"
'    vsfCheques.ColWidth(CGCH_DESCRIPCION) = 1500
'
'    vsfCheques.ColAlignment(CGCH_DOCUMENTO) = flexAlignLeftBottom
'    vsfCheques.TextMatrix(0, CGCH_DOCUMENTO) = "Documento"
'    vsfCheques.ColWidth(CGCH_DOCUMENTO) = 1000
'
'
'    vsfCheques.ColAlignment(CGCH_NUMERO_CHEQUE) = flexAlignLeftBottom
'    vsfCheques.TextMatrix(0, CGCH_NUMERO_CHEQUE) = "Numero"
'    vsfCheques.ColWidth(CGCH_NUMERO_CHEQUE) = 1000
'
'    vsfCheques.ColAlignment(CGCH_VTO) = flexAlignLeftBottom
'    vsfCheques.TextMatrix(0, CGCH_VTO) = "Vencimiento"
'    vsfCheques.ColWidth(CGCH_VTO) = 1400
'
'    vsfCheques.ColAlignment(CGCH_MONEDA) = flexAlignRightBottom
'    vsfCheques.TextMatrix(0, CGCH_MONEDA) = "Mon."
'    vsfCheques.ColWidth(CGCH_MONEDA) = 400
'
'    vsfCheques.ColAlignment(CGCH_SIMBOLO) = flexAlignCenterBottom
'    vsfCheques.TextMatrix(0, CGCH_SIMBOLO) = ""
'    vsfCheques.ColWidth(CGCH_SIMBOLO) = 400
'
'    'AIR 20170518
'    If ConfDiseño_Para_Grandes_Cifras = False Then
'        vsfCheques.ColAlignment(CGCH_IMPORTE) = flexAlignRightBottom
'        vsfCheques.TextMatrix(0, CGCH_IMPORTE) = "Importe"
'        vsfCheques.ColWidth(CGCH_IMPORTE) = 900
'    Else
'        vsfCheques.ColAlignment(CGCH_IMPORTE) = flexAlignRightBottom
'        vsfCheques.TextMatrix(0, CGCH_IMPORTE) = "Importe"
'        vsfCheques.ColWidth(CGCH_IMPORTE) = 1300
'
'    End If
'    vsfCheques.Rows = vsfCheques.Rows + 1
'
'    Screen.MousePointer = vbDefault
'
'End Sub

Sub Inicializo_Grilla_Tarjetas()
Dim i As Integer

    Screen.MousePointer = vbHourglass
                                                  
    vsfTarjetas_Credito.Rows = 1
    vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.FixedRows

    vsfTarjetas_Credito.Cols = CGTA_IMPORTE + 1
    vsfTarjetas_Credito.FixedCols = 1
    vsfTarjetas_Credito.ColWidth(0) = 0
    
    vsfTarjetas_Credito.ColAlignment(CGTA_MEDIO_PAGO) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_MEDIO_PAGO) = "Tarjeta"
    vsfTarjetas_Credito.ColWidth(CGTA_MEDIO_PAGO) = 600
    
    vsfTarjetas_Credito.ColAlignment(CGTA_DESCRIPCION) = flexAlignLeftBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_DESCRIPCION) = "Descripción"
    vsfTarjetas_Credito.ColWidth(CGTA_DESCRIPCION) = 1500
    
    vsfTarjetas_Credito.ColAlignment(CGTA_NUMERO) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_NUMERO) = "Número"
    vsfTarjetas_Credito.ColWidth(CGTA_NUMERO) = 1600
    
    vsfTarjetas_Credito.ColAlignment(CGTA_FECHA_VTO) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_FECHA_VTO) = "Vencimiento"
    vsfTarjetas_Credito.ColWidth(CGTA_FECHA_VTO) = 1200
    
    vsfTarjetas_Credito.ColAlignment(CGTA_NOMBRE_TITULAR) = flexAlignLeftBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_NOMBRE_TITULAR) = "Nombre Titular"
    vsfTarjetas_Credito.ColWidth(CGTA_NOMBRE_TITULAR) = 1500
    
    vsfTarjetas_Credito.ColAlignment(CGTA_CODIGO_VERIFICACION) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_CODIGO_VERIFICACION) = "Verificador"
    vsfTarjetas_Credito.ColWidth(CGTA_CODIGO_VERIFICACION) = 1000
    
    vsfTarjetas_Credito.ColAlignment(CGTA_CUOTAS) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_CUOTAS) = "Cuotas"
    vsfTarjetas_Credito.ColWidth(CGTA_CUOTAS) = 800
    
    vsfTarjetas_Credito.ColAlignment(CGTA_AUTORIZACION) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_AUTORIZACION) = "Autorización"
    vsfTarjetas_Credito.ColWidth(CGTA_AUTORIZACION) = 1000
 
    vsfTarjetas_Credito.ColAlignment(CGTA_LOTE) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_LOTE) = "N.Lote"
    vsfTarjetas_Credito.ColWidth(CGTA_LOTE) = 800
    
    vsfTarjetas_Credito.ColAlignment(CGTA_MONEDA) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_MONEDA) = "Mon."
    vsfTarjetas_Credito.ColWidth(CGTA_MONEDA) = 400
    
    vsfTarjetas_Credito.ColAlignment(CGTA_SIMBOLO) = flexAlignCenterBottom
    vsfTarjetas_Credito.TextMatrix(0, CGTA_SIMBOLO) = ""
    vsfTarjetas_Credito.ColWidth(CGTA_SIMBOLO) = 400
    
    'AIR 20170518
    If ConfDiseño_Para_Grandes_Cifras = False Then
        vsfTarjetas_Credito.ColAlignment(CGTA_IMPORTE) = flexAlignRightBottom
        vsfTarjetas_Credito.TextMatrix(0, CGTA_IMPORTE) = "Importe"
        vsfTarjetas_Credito.ColWidth(CGTA_IMPORTE) = 900
    Else
        vsfTarjetas_Credito.ColAlignment(CGTA_IMPORTE) = flexAlignRightBottom
        vsfTarjetas_Credito.TextMatrix(0, CGTA_IMPORTE) = "Importe"
        vsfTarjetas_Credito.ColWidth(CGTA_IMPORTE) = 1300
    
    End If
    vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Rows + 1

    Screen.MousePointer = vbDefault
    
End Sub

Sub Inicializo_Grilla_Descuento_x_Volumen()

    Screen.MousePointer = vbHourglass
                                                  
    vsfDescuentos_x_Volumen.Rows = 1
    vsfDescuentos_x_Volumen.Rows = vsfDescuentos_x_Volumen.FixedRows
'
    vsfDescuentos_x_Volumen.Cols = CGDV_PVENTA + 1
    vsfDescuentos_x_Volumen.FixedCols = 1
    vsfDescuentos_x_Volumen.ColWidth(0) = 0
    
    vsfDescuentos_x_Volumen.ColAlignment(CGDV_CANTIDAD) = flexAlignCenterBottom
    vsfDescuentos_x_Volumen.TextMatrix(0, CGDV_CANTIDAD) = "Unidades"
    vsfDescuentos_x_Volumen.ColWidth(CGDV_CANTIDAD) = 800
    vsfDescuentos_x_Volumen.ColDataType(CGDV_CANTIDAD) = flexDTDouble
    
    vsfDescuentos_x_Volumen.ColAlignment(CGDV_DTO) = flexAlignCenterBottom
    vsfDescuentos_x_Volumen.TextMatrix(0, CGDV_DTO) = "Dto."
    vsfDescuentos_x_Volumen.ColWidth(CGDV_DTO) = 900
    vsfDescuentos_x_Volumen.ColDataType(CGDV_DTO) = flexDTDouble
    
    vsfDescuentos_x_Volumen.ColAlignment(CGDV_PVENTA) = flexAlignRightBottom
    vsfDescuentos_x_Volumen.TextMatrix(0, CGDV_PVENTA) = "P.Venta"
    vsfDescuentos_x_Volumen.ColWidth(CGDV_PVENTA) = 900
    vsfDescuentos_x_Volumen.ColDataType(CGDV_PVENTA) = flexDTDouble
    
    Screen.MousePointer = vbDefault
    
End Sub

Sub Inicializo_Grilla_Equivalencias_Stock()
Dim e As Recordset

    Screen.MousePointer = vbHourglass
                                                  
    vsfEquivalencias_Stock.Rows = 1
    vsfEquivalencias_Stock.Rows = vsfEquivalencias_Stock.FixedRows
'
    vsfEquivalencias_Stock.Cols = CGES_STOCK_3 + 1
    vsfEquivalencias_Stock.FixedCols = 1
    vsfEquivalencias_Stock.ColWidth(0) = 0
    
    vsfEquivalencias_Stock.ColAlignment(CGES_CODIGO) = flexAlignCenterBottom
    vsfEquivalencias_Stock.TextMatrix(0, CGES_CODIGO) = "Código"
    vsfEquivalencias_Stock.ColWidth(CGES_CODIGO) = 0
    vsfEquivalencias_Stock.ColDataType(CGES_CODIGO) = flexDTLong
    
    vsfEquivalencias_Stock.ColAlignment(CGES_CODIGO_SANTERIOR) = flexAlignCenterBottom
    vsfEquivalencias_Stock.TextMatrix(0, CGES_CODIGO_SANTERIOR) = "Código"
    vsfEquivalencias_Stock.ColWidth(CGES_CODIGO_SANTERIOR) = 1100
    vsfEquivalencias_Stock.ColDataType(CGES_CODIGO_SANTERIOR) = flexDTString
    
    vsfEquivalencias_Stock.ColAlignment(CGES_DESCRIPCION) = flexAlignLeftBottom
    vsfEquivalencias_Stock.TextMatrix(0, CGES_DESCRIPCION) = "Descripción"
    vsfEquivalencias_Stock.ColWidth(CGES_DESCRIPCION) = 2500
    vsfEquivalencias_Stock.ColDataType(CGES_DESCRIPCION) = flexDTString
    
    vsfEquivalencias_Stock.ColAlignment(CGES_PVENTA) = flexAlignRightBottom
    vsfEquivalencias_Stock.TextMatrix(0, CGES_PVENTA) = "P.Venta"
    vsfEquivalencias_Stock.ColWidth(CGES_PVENTA) = 900
    vsfEquivalencias_Stock.ColDataType(CGES_PVENTA) = flexDTDouble
    
    vsfEquivalencias_Stock.ColAlignment(CGES_STOCK_1) = flexAlignRightBottom
    If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_1, e) Then
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_1) = Trim(e!titulo_reportes)
    Else
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_1) = "Stock 1"
    End If
    vsfEquivalencias_Stock.ColWidth(CGES_STOCK_1) = 900
    vsfEquivalencias_Stock.ColDataType(CGES_STOCK_1) = flexDTDouble
    
    vsfEquivalencias_Stock.ColAlignment(CGES_STOCK_2) = flexAlignRightBottom
    If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_2, e) Then
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_2) = Trim(e!titulo_reportes)
    Else
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_2) = "Stock 2"
    End If
    vsfEquivalencias_Stock.ColWidth(CGES_STOCK_2) = 900
    vsfEquivalencias_Stock.ColDataType(CGES_STOCK_2) = flexDTDouble
    
    vsfEquivalencias_Stock.ColAlignment(CGES_STOCK_3) = flexAlignRightBottom
    If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_3, e) Then
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_3) = Trim(e!titulo_reportes)
    Else
        vsfEquivalencias_Stock.TextMatrix(0, CGES_STOCK_3) = "Stock 3"
    End If
    vsfEquivalencias_Stock.ColWidth(CGES_STOCK_3) = 900
    vsfEquivalencias_Stock.ColDataType(CGES_STOCK_3) = flexDTDouble
    
    Screen.MousePointer = vbDefault
    
End Sub

Sub Inicializo_Grilla_Personas_Autorizadas()

    Screen.MousePointer = vbHourglass
                                                  
    vsfPersonas_Autorizadas.Rows = 1
    vsfPersonas_Autorizadas.Rows = vsfPersonas_Autorizadas.FixedRows
'
    vsfPersonas_Autorizadas.Cols = CGPA_DESCRIPCION + 1
    vsfPersonas_Autorizadas.FixedCols = 1
    vsfPersonas_Autorizadas.ColWidth(0) = 0
    
    vsfPersonas_Autorizadas.ColAlignment(CGPA_CI) = flexAlignCenterBottom
    vsfPersonas_Autorizadas.TextMatrix(0, CGPA_CI) = "C.I."
    vsfPersonas_Autorizadas.ColWidth(CGPA_CI) = 1000
    vsfPersonas_Autorizadas.ColDataType(CGPA_CI) = flexDTLong
    
    vsfPersonas_Autorizadas.ColAlignment(CGPA_DESCRIPCION) = flexAlignLeftBottom
    vsfPersonas_Autorizadas.TextMatrix(0, CGPA_DESCRIPCION) = "Referencia"
    vsfPersonas_Autorizadas.ColWidth(CGPA_DESCRIPCION) = 5500
    vsfPersonas_Autorizadas.ColDataType(CGPA_DESCRIPCION) = flexDTString
    
    Screen.MousePointer = vbDefault
    
End Sub


Function Controlo_Descuento_Global(pblDtoGlobal As Boolean, plngRow As Long) As Boolean
On Error GoTo Errores
Dim R As Recordset
Dim i As Long

    Controlo_Descuento_Global = True
    
    ' AIR 20210720 se comenta el control de Doc_Ruptura a pedido de ATU "Básicamente esos documentos no controla el descuento global."
    ' If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" Or (Val(txtCodDoc.text) = ConfDoc_Ruptura Or Val(txtCodDoc.text) = ConfDoc_Ruptura2) Then
    
    If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" Then
        Exit Function
    End If

    If Buscar_Cliente(txtCodProv.text, R) Then
        If R!tope_descuento = 0 Then
            ' 20240629  /   Si el Tope es 0 no se controla
        Else
            If Trim(txtDtoGlobal.text) <> "" Then
                If IsNumeric(txtDtoGlobal.text) Then
                    If CDbl(txtDtoGlobal.text) > R!tope_descuento And Not gCargoDesdeF Then
                        gbolESC = True
                        MsgBox "Descuento Global a Aplicar, Supera el Descuento Maximo del Cliente (" & Format(R!tope_descuento, "0.00") & " %)", vbCritical + vbOKOnly
                        txtDtoGlobal.text = Format(0, "##0.00")
                        Controlo_Descuento_Global = False
                        Exit Function
                    End If
                End If
            End If
        End If
    End If
    
    'AIR 20220826 se evalua si la llamada a la rutina viene desde el objeto txtdtoglobal o desde la grilla. Si es desde la grilla no es necesario recorrerla toda nuevamente.
    If pblDtoGlobal = False Then
        ' Verificamos si el articulo soporta descuento
        'Si un articulo no lo soporta, nos vamos y no aplicamos descuento
        'AIR 20220831
        'If vsfLineas_Mercaderia.Row <> 0 Then
        If plngRow <> 0 Then
            'If Controlo_Descuento_Global_X_Articulo(vsfLineas_Mercaderia.Row) = False Then
            If Controlo_Descuento_Global_X_Articulo(plngRow) = False Then
                MsgBox "El Descuento Global NO SE PUEDE APLICAR porque hay Articulos que no lo Permiten", vbExclamation, MsgTit
                Controlo_Descuento_Global = False
                Exit Function
            End If
        End If
    Else
    
        ' Verificamos si todos los articulos soportan descuento
        For i = 1 To vsfLineas_Mercaderia.Rows - 1
            'Si un articulo no lo soporta, nos vamos y no aplicamos descuento
            If Controlo_Descuento_Global_X_Articulo(i) = False Then
                MsgBox "El Descuento Global NO SE PUEDE APLICAR porque hay Articulos que no lo Permiten", vbExclamation, MsgTit
                Controlo_Descuento_Global = False
                Exit Function
            End If
        Next i
    End If
Exit Function
Errores:
    Call FErrores
   ' Resume
End Function

Function Controlo_Descuento_Linea(plngRow As Long, pdblDto_1 As Double, pdblDto_2 As Double, pdblDto_3 As Double, Optional ubicacion As Long = -1) As Boolean
Dim R As Recordset
Dim P As Recordset
Dim ldblDescuento_Global As Double
Dim ldblTotal_Descuentos As Double
Dim pdblPrecionConDtos As Double
Dim pstrLista As String

    Controlo_Descuento_Linea = True
    
       
       
    
    If Not Buscar_Articulo(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_CODIGO), P) Then
        gbolESC = True
        Controlo_Descuento_Linea = False
        Exit Function
    End If
    

'ATU, se controlan los descuentos tambien para los documentos especiales.
'Se anula doble control, dejando solamente el parametro de acepta_promociones; pero ademas se verifica que no supere el tope de descuento del producto al final
'29/03/2016

    If Trim(UCase(ConfPuntoVta_Controla_Dtos)) <> "S" And Trim(UCase(P!acepta_promociones)) <> "S" Then
        If pdblDto_1 <> 0 Or pdblDto_2 <> 0 Or pdblDto_3 <> 0 Then
            gbolESC = True
            MsgBox "El Artículo No Acepta Descuentos", vbCritical + vbOKOnly
            Controlo_Descuento_Linea = False
            Exit Function
        End If
    
    End If

'ATU 28/03/2016
'Si el parametro de controlar datos esta en N entra para validar todos los controles
        
        ' Si el Articulo No tiene Descuento, no permito ingresar Descuentos Salvo con Autorizacion de Gerencia
        If Trim(UCase(P!acepta_promociones)) <> "S" Then
            If pdblDto_1 <> 0 Or pdblDto_2 <> 0 Or pdblDto_3 <> 0 Then
                ' Necesito Autorizacion del Gerente
                If Not YaAutorizadoDescuento Then
                   If Autorizacion_Supervision(6, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                       Call UnificaAutorizacionDescuento
                       Controlo_Descuento_Linea = True
                       Exit Function
                   Else
                       gbolESC = True
                       MsgBox "El Artículo No Acepta Descuentos", vbCritical + vbOKOnly
                       Controlo_Descuento_Linea = False
                       Exit Function
                   End If
                End If
            Else
                Controlo_Descuento_Linea = True
                Exit Function
            End If
        End If
        
        If Trim(UCase(confSistemaControlDtos)) = Trim(SistemaControlDtos_General) Then
            If Buscar_Cliente(txtCodProv.text, R) Then
                If Trim(txtDtoGlobal.text) <> "" Then
                    If IsNumeric(txtDtoGlobal.text) Then
                        ldblDescuento_Global = CDbl(txtDtoGlobal.text)
                    End If
                 End If

                 ldblTotal_Descuentos = ldblDescuento_Global + pdblDto_1 + pdblDto_2 + pdblDto_3
                 'ATU 29/03/2016 se controla si el tope de descuento es > 0, para dar compatibilidad con el cambio de arriba
                 If R!tope_descuento > 0 Then
                     If ldblTotal_Descuentos > R!tope_descuento Then
                         If Not YaAutorizadoDescuento Then
                             If Autorizacion_Supervision(7, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                 Call UnificaAutorizacionDescuento
                                 Controlo_Descuento_Linea = True
                                 Exit Function
                             Else
                                 gbolESC = True
                                 MsgBox "Descuentos a Aplicar, Supera el Descuento Maximo del Cliente (" & Format(R!tope_descuento, "0.00") & " %)", vbCritical + vbOKOnly
                                 Controlo_Descuento_Linea = False
                                 Exit Function
                             End If
                         End If
                     End If
                End If
            End If
'ATU 29/03/2016 Se controla el tope de descuento fijado en el producto, si esta en 0 no controla.
            If P!tope_descuento > 0 Then
                If ldblTotal_Descuentos > P!tope_descuento Then
                    If Not YaAutorizadoDescuento Then
                        If Autorizacion_Supervision(6, 4, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                            Call UnificaAutorizacionDescuento
                            Controlo_Descuento_Linea = True
                            Exit Function
                        Else
                            gbolESC = True
                            MsgBox "Descuentos a Aplicar, Supera el Descuento Maximo del Articulo (" & Format(P!tope_descuento, "0.00") & " %)", vbCritical + vbOKOnly
                            Controlo_Descuento_Linea = False
                            Exit Function
                        End If
                    End If
                End If
           End If
    

        End If
        
        
'JCH 29.12.2022 Se controla el tope de descuento fijado en el producto, si esta en 0 no controla.
        'If p!tope_descuento > 0 Then
            If ControlDtos(plngRow) Then
                 gbolESC = True
                 Controlo_Descuento_Linea = True
            End If
        'End If
        
 
End Function




Function ControlDescuentosRegistro(plngRow As Long, Optional ubicacion As Long = -1) As Boolean
        Dim pdblPrecionConDtos As Double
        Dim pstrLista As String
        
        ControlDescuentosRegistro = True
        
        If gCargoDesdeF = True Then
            Exit Function
        End If
        
        
        pstrLista = Trim(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_DTO1)) & ";"
        pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_DTO2)) & ";"
        pstrLista = pstrLista & Trim(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_DTO3)) & ";"
        pstrLista = pstrLista & Trim(Me.txtDtoGlobal.text)
        
        ldblTotal_Descuentos = CalculoDtoTotal(pstrLista)
        
        

        If confUsaEquivalenciaMagnitudes Then
            pdblPrecionConDtos = CDbl(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_PUNITARIO_MAGNITUD)) * (1 - (ldblTotal_Descuentos / 100))
        Else
            pdblPrecionConDtos = CDbl(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_PUNITARIO)) * (1 - (ldblTotal_Descuentos / 100))
        End If
            
        'jch 19092022 controlo que los descuentos no se vayan acumulando
        If val(pdblPrecionConDtos) < val(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_PRECIO_MINIMO)) Then
             MsgBox "Los Descuentos a Aplicar, Superan el Descuento Maximo aceptado, el precio con Dtos debe ser >= a  " & Trim(CDbl(vsfLineas_Mercaderia.TextMatrix(plngRow, CGL_PRECIO_MINIMO))), vbCritical + vbOKOnly
             If Not YaAutorizadoDescuento Then
                 If Autorizacion_Supervision(40, 4, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                     Call UnificaAutorizacionDescuento
                     Exit Function
                 Else
                     gbolESC = True
                     vsfLineas_Mercaderia.TextMatrix(plngRow, ubi) = Format(0, "#0.00")
                     vsfLineas_Mercaderia.EditText = 0
                     ControlDescuentosRegistro = False
                 End If
             Else
                 Exit Function
             End If
                
        End If

End Function


Private Sub vsfMedios_Pagos_AfterEdit(ByVal Row As Long, ByVal Col As Long)
On Error GoTo Errores
    
    Select Case Col

        Case CGMP_MONEDA

            If Not Busco_Moneda(vsfMedios_Pagos.EditText) Then
                MsgBox "Moneda Inexistente", vbCritical, MsgTit
            Else
                vsfMedios_Pagos.TextMatrix(Row, CGMP_SIMBOLO) = Trim(rstMonedas!simbolo)
            End If
        Case CGMP_TC
            
            vsfMedios_Pagos.TextMatrix(Row, CGMP_TC) = Format(vsfMedios_Pagos.TextMatrix(Row, CGMP_TC), "0.00")
            vsfMedios_Pagos.Select Row, CGMP_IMPORTE
    End Select
    
    Call Calculo_Total_Medios_Pago(True)
    
Exit Sub
Errores:
    MsgBox "Ha ocurrido un error, Verifique", vbInformation, MsgTit
    Exit Sub

End Sub

Private Sub vsfMedios_Pagos_EnterCell()
    
    Select Case vsfMedios_Pagos.Col
        Case CGMP_IMPORTE
            If Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_DEV_CAMBIO)) <> "CAMBIO" Then
                vsfMedios_Pagos.AutoSearch = flexSearchNone
                vsfMedios_Pagos.Editable = flexEDKbdMouse
            Else
                vsfMedios_Pagos.AutoSearch = flexSearchFromTop
                vsfMedios_Pagos.Editable = flexEDNone
            End If
        Case CGMP_REFERENCIA
            If Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_DEV_CAMBIO)) <> "CAMBIO" Then
                vsfMedios_Pagos.AutoSearch = flexSearchNone
                vsfMedios_Pagos.Editable = flexEDKbdMouse
            Else
                vsfMedios_Pagos.AutoSearch = flexSearchNone
                vsfMedios_Pagos.Editable = flexEDKbdMouse
            End If
        Case CGMP_TC
        'ATU 22/03/2016 , se permite cambiar el tipo de cambio cuando la moneda del medio de pago es diferente
        'a la del cabezal.(no a la moneda base)
            If val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)) <> val(txtMoneda.text) And Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_DEV_CAMBIO)) <> "CAMBIO" Then
                vsfMedios_Pagos.AutoSearch = flexSearchNone
                vsfMedios_Pagos.Editable = flexEDKbdMouse
            Else
                vsfMedios_Pagos.AutoSearch = flexSearchFromTop
                vsfMedios_Pagos.Editable = flexEDNone
            End If
        Case Else
            vsfMedios_Pagos.AutoSearch = flexSearchFromTop
            vsfMedios_Pagos.Editable = flexEDNone
    End Select

End Sub

Public Sub Cargo_Grilla_Medios_Pago_Cliente()
Dim SQL As String
Dim C As Recordset
Dim R As Recordset
Dim D As Recordset
Dim MPC As Recordset
Dim ldblTipo_Cambio As Double
Dim cotiz As String

'ATU 23 / 3 / 2016
' Se cargan los medios de pago por debajo del 89 y se asignan al final los referidos al cambio.
'AIR 20231031 se amplian el margen de codigo de medios de pago - porque San Cono supero la numeracion.

    Select Case ConfFormato_Factura
        Case "CASINO", "CASINO-POS", "DALTIRO", "BARATILLO", "MMARTINEZ"
            ' Solo Coloco los Medios de Pago segun la Forma de Pago.
            ' Forma Pago 0 - Contado - Solo coloco Efectivo
            ' Forma Pago <> 0 - Pongo Todos
            
            If Tipo_Documento_Tiene_Medios_Pago_Definidos(val(txtCodDoc.text)) Then
            
                ' El documento TIENE Restriccion del Tipo de Documento
                If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                
                    If pstrTipo_Ingreso_Documentos <> "S" Or D!tipo_doc <> "G" Then     ' excluye resguardos
                        If Buscar_Cliente(txtCodProv.text, C) = True Then
                            ' AIR 20190606 a pedido de Casino Justicia se cambia la condicion, y se levantan todos los medios de pago para todos los clientes y condicion del documento.
                            If C!tip_cli = 0 And ConfFormato_Factura <> "CASINO-POS" And ConfFormato_Factura <> "BARATILLO" And ConfFormato_Factura <> "MMARTINEZ" Then
                                ' Solo Efectivo
                                SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                                SQL = SQL & " WHERE Medios_Pago.tipo_medio_pago = 'E' "
                                'AIR 20231031
                                'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                                SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                                SQL = SQL & " AND Medios_Pago.activo = 'S' "
                                SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                                SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                                SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                                SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                            Else
                                If ConfTRANSACT_Habilitado = "S" Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S" Then
                                    SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento "
                                    'AIR 20231031
                                    'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                                    SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                                    
                                    SQL = SQL & " AND Medios_Pago.activo = 'S' "
                                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                                    SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                                    SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                                Else
                                    SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                                    'AIR 20231031
                                    'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                                    SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                                    
                                    SQL = SQL & " AND Medios_Pago.activo = 'S' "
                                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                                    SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                                    SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                                End If
                            End If
                        Else
                            'JEL-20111201  cambie este punto para que queden solo los Medios de Pago Efectivo cuando no existe el cliente
                            'SQL = "SELECT * FROM Medios_Pago WHERE CODIGO < 99 "
                            SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                            'AIR 20231031
                            'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                            SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                            
                            SQL = SQL & " AND Medios_Pago.activo = 'S' "
                            SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                            SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                            SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        End If
                    Else
                        ' Resguardos, toma los medios de pago del documento     SS 20160408
                        SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                            'AIR 20231031
                        'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                        SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                        
                        SQL = SQL & " AND Medios_Pago.activo = 'S' "
                        SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                        SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                    End If
                End If
            Else
                ' El documento no tiene Restriccion del Tipo de Documento
                
                If Buscar_Cliente(txtCodProv.text, C) = True Then
                    If C!tip_cli = 0 And ConfFormato_Factura <> "CASINO-POS" Then ' AIR 20190606 a pedido de Casino Justicia se cambia la condicion, y se levantan todos los medios de pago para todos los clientes y condicion del documento.
                        ' Solo Efectivo
                        SQL = "SELECT * FROM Medios_Pago"
                        SQL = SQL & " WHERE tipo_medio_pago = 'E' "
                        SQL = SQL & " AND activo = 'S' "
                        'AIR 20231031
                        'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                        SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                        
                        SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                    Else
                        If ConfTRANSACT_Habilitado = "S" Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S" Then
                            SQL = "SELECT * FROM Medios_Pago "
                            SQL = SQL & " WHERE activo = 'S' "
                            'AIR 20231031
                            'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                            SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                            
                            SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        Else
                            SQL = "SELECT * FROM Medios_Pago"
                            SQL = SQL & " WHERE tipo_medio_pago = 'E' "
                            SQL = SQL & " AND activo = 'S' "
                            'AIR 20231031
                            'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                            SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                           
                           
                            SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        End If
                    End If
                Else
                    'JEL-20111201  cambie este punto para que queden solo los Medios de Pago Efectivo cuando no existe el cliente
    '                SQL = "SELECT * FROM Medios_Pago WHERE CODIGO < 99 "
                    SQL = "SELECT * FROM Medios_Pago"
                    SQL = SQL & " WHERE tipo_medio_pago = 'E'"
                    SQL = SQL & " AND activo = 'S' "
                    'AIR 20231031
                    'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                    SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                    
                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                End If
            End If
            
        Case Else
            If Tipo_Documento_Tiene_Medios_Pago_Definidos(val(txtCodDoc.text)) Then
                ' El documento TIENE Restriccion del Tipo de Documento

                    SQL = "SELECT Medios_Pago.*,isnull(Medios_Pago_x_Tipo_Documento.cod_mpago,-1) cod_mpago "
                    SQL = SQL & " FROM Medios_Pago INNER join Medios_Pago_x_Tipo_Documento on Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                    SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                    SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                    SQL = SQL & " AND Medios_Pago.activo = 'S' "
                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"

            Else
                ' Chequeo la Tabla de Medios_Pago_x_Cliente, si No hay Medios de Pago pongo Todos, Sino los del Cliente
                
                SQL = "SELECT Medios_Pago.* FROM Medios_Pago_x_Cliente,Medios_Pago"
                SQL = SQL & " WHERE Medios_Pago_x_Cliente.cod_cliente = " & val(txtCodProv.text)
                SQL = SQL & " AND Medios_Pago_x_Cliente.cod_mpago = Medios_Pago.codigo"
                SQL = SQL & " AND Medios_Pago.activo = 'S' "
                SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                
                Set MPC = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                If MPC.EOF Then
                    SQL = "SELECT * FROM Medios_Pago "
                    SQL = SQL & " WHERE activo = 'S' "
                    'AIR 20231031
                    'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                    SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                End If
            End If
            
    End Select

    vsfMedios_Pagos.Rows = 1
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    While Not R.EOF
    
        vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows + 1
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MEDIO_PAGO) = R!codigo
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_MPAGO) = Trim(R!tipo_medio_pago)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_DESCRIPCION) = Trim(R!Descripcion)
        
        If R!cuotas <> 0 Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = R!cuotas
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = ""
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = R!moneda
        
        If Busco_Moneda(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) Then
        Else
            MsgBox "Moneda Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        
        If R!moneda <> gMoneda_Base Then
'            ldblTipo_Cambio = Tipo_Cambio(R!moneda, txtFec_Doc.Text)
            
            'AIR 20180326 si la factura es en DOLARES se toma el manual comprador
            
            If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
            Else
                cotiz = Buscar_Configuracion_Variables_Documento_C(val(txtCodDoc.text), "TIPO_COTIZACION_MEDIO_PAGO_ME_MN")
                If Trim(cotiz) = "" Then
                     ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                Else
                     ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), cotiz)
                End If
            End If
                
            If ldblTipo_Cambio <> 0 Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(ldblTipo_Cambio, "###0.000")
            Else
                MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
            End If
        
       
        End If
                
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_SIMBOLO) = Trim(rstMonedas!simbolo)
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = "0.00"
        
        vsfMedios_Pagos.Cell(flexcpBackColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFF&
        vsfMedios_Pagos.Cell(flexcpForeColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFFFFFF
        vsfMedios_Pagos.Cell(flexcpFontBold, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = True
        
        ' AIR 20181128 datos de la SEÑA
        If Trim(R!tipo_medio_pago) = "S" Then
            Call Cargo_Datos_Seña(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text))
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODDOC) = ""
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_NRODOC) = ""
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODPROV) = ""
        End If
        
        R.MoveNext
    Wend
    R.Close
'ATU se agregan los de cambio al FINAL.
    
    SQL = "SELECT * FROM Medios_Pago"
    SQL = SQL & " WHERE tipo_medio_pago = 'E'"
    SQL = SQL & " AND activo = 'S' "
    SQL = SQL & " AND tipo_dev_cambio ='CAMBIO' "
    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
    SQL = SQL & " ORDER BY Medios_Pago.moneda"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not R.EOF
        vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows + 1
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MEDIO_PAGO) = R!codigo
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_MPAGO) = Trim(R!tipo_medio_pago)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_DESCRIPCION) = Trim(R!Descripcion)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = ""
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = R!moneda
        
        If Busco_Moneda(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) Then
        Else
            MsgBox "Moneda Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        
        If R!moneda <> gMoneda_Base Then
'            ldblTipo_Cambio = Tipo_Cambio(R!moneda, txtFec_Doc.Text)
'            ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), R!moneda, Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
            
            'AIR 20180326 si la factura es en DOLARES toma el manual comprador
            
            If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
            Else
                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
            End If
            
            If ldblTipo_Cambio <> 0 Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(ldblTipo_Cambio, "###0.000")
            Else
                MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
            End If
        End If
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_SIMBOLO) = Trim(rstMonedas!simbolo)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = "0.00"
        vsfMedios_Pagos.Cell(flexcpBackColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFF&
        vsfMedios_Pagos.Cell(flexcpForeColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFFFFFF
        vsfMedios_Pagos.Cell(flexcpFontBold, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = True
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_DEV_CAMBIO) = Trim(R!tipo_dev_cambio)
        
        R.MoveNext
    Wend
    R.Close
End Sub

Private Sub vsfMedios_Pagos_GotFocus()
On Error GoTo Errores
Dim SQL As String
Dim R As Recordset
Dim i As Integer
Dim lbolEncontre As Boolean
Dim D As Recordset
Dim cotiz As String
Dim moneda As Long
Dim pstrME_MN As String
Dim pstrMN_ME As String

'ATU 22/03/2016, no se inicializa la grilla si es una consulta de comprobante.
If UCase(Trim(sspOperacion.Caption)) <> "C" Then


    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        MsgBox "El Código del Documento No existe en el Sistema. Verifique....", vbInformation, MsgTit
        Exit Sub
    End If
    
    ' Recalculo, por si hicieron cambios sin ENTER
    If pstrTipo_Ingreso_Documentos = "S" Then   'SS 20180917

        dbgLineas_Servicios.MoveFirst
        For i = 0 To dbgLineas_Servicios.Rows - 1
            If D!tipo_doc = "G" Then    'N al ser resguardo es un importe sin impuestos SS 20180813
                Call Calcular_Importes_de_la_Linea_Servicios(False, "N", True)
            Else
                Call Calcular_Importes_de_la_Linea_Servicios(False, "S", False)
            End If
            dbgLineas_Servicios.MoveNext
        Next i
    End If
    
    ' AIR 20250725
    If val(txtCodDoc.text) = ConfDoc_Ingreso_PreVenta_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Presupuesto_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli Or val(txtCodDoc.text) = ConfDoc_Ingreso_Pedido_Cli_API Or D!pide_medio_pago = "N" Then
    
    ' Se agrega cambio a 3 digitos para automaticos, segun configuracion    SS 20151013
    
        txtCambio.text = 0
        
        If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
            txtTotal_Medios_Pago.text = Format(txtImporte.text, "0.00")
        Else
            If val(txtMoneda.text) <> gMoneda_Base Then
                txtTotal_Medios_Pago.text = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
            Else
                txtTotal_Medios_Pago.text = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            End If
        End If
        
        ' Inicializo La Grilla
        For i = 1 To vsfMedios_Pagos.Rows - 1
            If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
                vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, "0.00")
            Else
                If val(txtMoneda.text) <> gMoneda_Base Then
                    vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                Else
                    vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                End If
            End If
            
            'ATU 21/03/2016, actualizamoz el tipo de cambio con el ingresado en el cabezal
            If vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = val(txtMoneda.text) Then
                ' JE 31/05/2016, si la moneda es la misma a la del cabezal se cambia
                vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = Format(txtTipo_Cambio.text, "0.000")
            End If
            
        Next i
        
        SQL = "select * from medios_pago where x_defecto='S' and moneda = " & val(txtMoneda.text)
        Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If Not R.EOF Then
            lbolEncontre = False
            For i = 1 To vsfMedios_Pagos.Rows - 1
                If vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) = R!codigo Then
                
                    If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
                        vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, "0.00")
                    Else
                        If val(txtMoneda.text) <> gMoneda_Base Then
                            vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                        Else
                            vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                        End If
                    End If
                    
                    lbolEncontre = True
                    Exit For
                End If
            Next i
        End If
        
        'Si no tiene por defecto va a la primera de la misma moneda
        lbolEncontre = False
        For i = 1 To vsfMedios_Pagos.Rows - 1
            If vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = val(txtMoneda.text) Then
            
                If esEFactura(val(txtCodDoc.text)) Then     'Cambio formato segun configuracion SS 20180411
                    vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, "0.00")
                Else
                    If val(txtMoneda.text) <> gMoneda_Base Then
                        vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                    Else
                        vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                    End If
                End If
                
                lbolEncontre = True
                Exit For
            End If
        Next i
        
        If Not lbolEncontre Then
            GoTo Errores:
        Else
            If Trim(UCase(sspOperacion.Caption)) = "C" Then
                cmdGuardar.Enabled = False
            Else
                cmdGuardar.Enabled = True
                cmdGuardar.SetFocus
            End If
        End If
        
    Else
        'Para este caso, carga en EFECTIVO el valor para no tener que pasar por la grilla
        'Salvo que sea tarjeta
        'se quito en este if la siguiento opcion  ConfFormato_Factura = "MILY"
        If (ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "JAGUILAR" Or ConfFormato_Factura = "STAUDINGER" _
            Or ConfFormato_Factura = "TATOREPRESENTACIONES" Or ConfFormato_Factura = "ENET" _
            Or ConfFormato_Factura = "BARATILLO" Or ConfFormato_Factura = "MMARTINEZ" _
            Or ConfFormato_Factura = "MAVIM" Or ConfFormato_Factura = "CARLITOS" Or ConfFormato_Factura = "COPISER" Or ConfFormato_Factura = "MERCADO") And sspOperacion.Caption = "A" Then
            txtCambio.text = 0
            txtTotal_Medios_Pago.text = Format(txtImporte.text, "0.00")
                
            ' Inicializo La Grilla
            For i = 1 To vsfMedios_Pagos.Rows - 1
                vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, "0.00")
                
                'ATU 21/03/2016, actualizamoz el tipo de cambio con el ingresado en el cabezal
                ' JE 31/05/2016, si la moneda es la misma a la del cabezal se cambia
                If vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = val(txtMoneda.text) Then
                    ' JE 31/05/2016, si la moneda es la misma a la del cabezal se cambia
                    vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = Format(txtTipo_Cambio.text, "0.000")
                End If
            Next i
            
            SQL = "select * from medios_pago where x_defecto='S' and moneda = " & val(txtMoneda.text)
            Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            If Not R.EOF Then
                lbolEncontre = False
                For i = 1 To vsfMedios_Pagos.Rows - 1
                    If vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO) = R!codigo Then
                        vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, "0.00")
                        lbolEncontre = True
                        Exit For
                    End If
                Next i
            End If
            
            'Si no tiene por defecto va a la primera de la misma moneda
            lbolEncontre = False
            For i = 1 To vsfMedios_Pagos.Rows - 1
                If vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = val(txtMoneda.text) Then
                    vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(txtImporte.text, "0.00")
                    lbolEncontre = True
                    Exit For
                End If
            Next i
            
        Else
        
            ' Inicializo La Grilla
            pstrME_MN = Buscar_Configuracion_Variables_Documento_C(val(txtCodDoc.text), "TIPO_COTIZACION_MEDIO_PAGO_ME_MN")
            If Trim(pstrME_MN) = "" Then
                 pstrME_MN = "F"
            End If
                        
            pstrMN_ME = Buscar_Configuracion_Variables_Documento_C(val(txtCodDoc.text), "TIPO_COTIZACION_MEDIO_PAGO_MN_ME")
            If Trim(pstrMN_ME) = "" Then
                 pstrMN_ME = "F"
            End If
              
            
            For i = 1 To vsfMedios_Pagos.Rows - 1
                If Trim(pstrME_MN) <> "" And Trim(pstrMN_ME) <> "" Then
            
                    'AIR 20180309 se agrega porque si se ingresaron VALES DE PAGO o Cheques o Seña en la pestaña correspondiente se borran los montos cargados automaticamente en la grilla de medios de pago
                    ' Para Goal Sport
                
                    If vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "S" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "V" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "C" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "T" Then
                        vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, "0.00")
                    End If
                
                    'ATU 21/03/2016, actualizamoz el tipo de cambio con el ingresado en el cabezal
                
                    ' Jch 07/09/2022,
                    If (pstrME_MN = "" Or pstrMN_ME = "") Then
                        If val(txtMoneda.text) = val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
                           ldblTipo_Cambio = val(txtTipo_Cambio.text)
                        End If
                    Else
                        If txtMoneda.text = val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
                            ldblTipo_Cambio = 1
                        Else
                            If val(txtMoneda.text) = gMoneda_Base Then
                                cotiz = pstrMN_ME
                                moneda = val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA))
                             Else
                                cotiz = pstrME_MN
                                moneda = val(txtMoneda.text)
                             End If
                          
                             ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), cotiz)
                        End If
                    End If
                    If ldblTipo_Cambio = 1 Then
                       ' vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = ""
                    Else
                       vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = Format(ldblTipo_Cambio, "0.000")
                    End If
                Else
                     'AIR 20180309 se agrega porque si se ingresaron VALES DE PAGO o Cheques o Seña en la pestaña correspondiente se borran los montos cargados automaticamente en la grilla de medios de pago
                     ' Para Goal Sport
                
                     If vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "S" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "V" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "C" And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) <> "T" Then
                         vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE) = Format(0, "0.00")
                     End If
                     If val(txtMoneda.text) <> gMoneda_Base Then
                         vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = ""
                     End If
                     
                
                     'ATU 21/03/2016, actualizamoz el tipo de cambio con el ingresado en el cabezal
                     If vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA) = val(txtMoneda.text) Then
                         ' JE 31/05/2016, si la moneda es la misma a la del cabezal se cambia
                         If val(txtMoneda.text) <> gMoneda_Base Then
                             vsfMedios_Pagos.TextMatrix(i, CGMP_TC) = Format(txtTipo_Cambio.text, "0.000")
                         End If
                     End If
                
                End If
            Next i
            Call Calculo_Total_Medios_Pago(True)
        
        End If
        
        stbAyuda.Panels(1).text = "F12-Finaliza Medios de Pago / F5-Visualiza Cambio en Moneda Base ($) / F6-Detalle de Cheques / F9-Transaccion TARJETA ONLINE / F3-Selección de Señas (+)-AutoCompleta Saldo "
    End If

End If

Exit Sub

Errores:
    MsgBox "Ha Ocurrido un Error al Asignar el Medio de Pago", vbExclamation, MsgTit
    'Resume
    Exit Sub
End Sub

Private Sub vsfMedios_Pagos_KeyDown(KeyCode As Integer, Shift As Integer)
Dim i As Integer
Dim llngCod_Emp As Long
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim llngCod_Prov As Long
Dim ldblImporte As Double
Dim llngCod_Medio_Pago As Long
Dim lrstTarjeta As Recordset
Dim lrstMedio_Pago As Recordset
Dim ldblImporte_Total_Factura As Double
Dim ldblImporte_Monto_Gravado As Double
Dim ldblImporte_IVA As Double
Dim pdblTc As Double
Dim lRuc As String
Dim lCancel As Boolean
    gbolESC = False
    
    If KeyCode = vbKeyF5 Then
        If Trim(txtCambio.text) <> "" Then
            MsgBox "CAMBIO EN $ " & val(txtCambio.text) * val(txtTipo_Cambio.text), vbInformation, MsgTit
        End If
    End If
    
    If KeyCode = vbKeyF9 Then
    
        llngCod_Emp = CLng(txtEmpresa.text)
        If Not (llngCod_Emp > 0) Then
            MsgBox "ERROR: Código de Empresa No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
            
        llngCod_Doc = CLng(txtCodDoc.text)
        If Not (llngCod_Doc > 0) Then
            MsgBox "ERROR: Código de Documento No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
            
        llngNro_Doc = CLng(txtDoc.text)
        If Not (llngNro_Doc > 0) Then
            MsgBox "ERROR: Número de Documento No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
            
        llngCod_Prov = CLng(txtCodProv.text)
        If Not (llngCod_Prov >= 0) Then
            MsgBox "ERROR: Código de Cliente No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
            
        llngCod_Medio_Pago = CLng(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MEDIO_PAGO))
        If Not (llngCod_Medio_Pago > 0) Then
            MsgBox "ERROR: Código de Medio de Pago No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
            
        If Busco_Medios_Pago(llngCod_Medio_Pago, lrstMedio_Pago) Then
            If lrstMedio_Pago!Transact_chequear <> "S" And lrstMedio_Pago!fiserv_chequear <> "S" And lrstMedio_Pago!poslink_chequear <> "S" And lrstMedio_Pago!Sarea_chequear <> "S" Then
                MsgBox "ERROR: Medio de Pago No Esta ACTIVO para TRANSACION ON LINE. Verifique...", vbCritical + vbOKOnly
                Exit Sub
            End If
        Else
            MsgBox "ERROR: Código de Medio de Pago No Válido. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
        
        ldblImporte = CDbl(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE))
        If Not (ldblImporte > 0) Then
            MsgBox "ERROR: Debe Ingresar un Importe. Verifique...", vbCritical + vbOKOnly
            Exit Sub
        End If
        
        'AIR 20250207 la funcion clng no esta devolviendo el numero correcto para esta comparacion
        'If (Trim(lrstMedio_Pago!tipo_dev_cambio) = "PUEDE_DEVOLVER") Or (Trim(lrstMedio_Pago!tipo_dev_cambio) = "NO_PUEDE_DEVOLVER" And (CLng(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE))) <= val(txtImporte.text)) Then
        'If (Trim(lrstMedio_Pago!tipo_dev_cambio) = "PUEDE_DEVOLVER") Or (Trim(lrstMedio_Pago!tipo_dev_cambio) = "NO_PUEDE_DEVOLVER" And (CDbl(NullToZero(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE)))) <= Round(val(txtImporte.text) * val(txtTipo_Cambio.text), 2)) Then
        'Else
        '      MsgBox "Los Importes del Medio de Pago NO Permiten Devolver Cambio", vbCritical, MsgTit
        '      Cancel = True
        '      Exit Sub
       'End If
        
        
                        
        ldblImporte_Total_Factura = CDbl(txtImporte.text)
        ldblImporte_Monto_Gravado = Calcular_Monto_Gravado
        ldblImporte_IVA = Calcular_Monto_IVA
         If ConfTRANSACT_Habilitado = "S" And ConfTRANSACT_Version < 4 Then
            If TARJETA_ON_LINE(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, llngCod_Medio_Pago, ldblImporte, TxtRuc.text, ldblImporte_Total_Factura, ldblImporte_Monto_Gravado) Then
            End If
         Else
             'gCuotasTarjetas = IIf(IsNull(lrstMedio_Pago!fiserv_cuotas), 1, lrstMedio_Pago!fiserv_cuotas)
             If (ConfTRANSACT_Habilitado = "S" And ConfTRANSACT_Version >= 4) Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S" Or ConfCASHDRO_Habilitado = "S" Then
                  Load frmIngresoBaucher_TCredito
                  
                  If CInt(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)) = CLng(Me.txtMoneda.text) Then
                      If Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TC)) = "" Then
                          pdblTc = CDbl(Me.txtTipo_Cambio.text)
                      Else
                          pdblTc = CDbl(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TC))
                      End If
                  ElseIf CInt(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)) = 1 And CLng(Me.txtMoneda.text) = 2 Then
                      pdblTc = CDbl(Me.txtTipo_Cambio.text)
                  ElseIf CInt(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)) = 2 And CLng(Me.txtMoneda.text) = 1 Then
                      pdblTc = CDbl(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TC))
                  End If
                  
                  If Me.txtTipo_Doc_Identidad.text = 2 Then
                     lRuc = TxtRuc.text
                  Else
                     lRuc = ""
                  End If
                  
                   
                  Call frmIngresoBaucher_TCredito.CargaParametros(llngCod_Emp, llngCod_Doc, llngNro_Doc, llngCod_Prov, llngCod_Medio_Pago, ldblImporte, lRuc, ldblImporte_Total_Factura, _
                            ldblImporte_Monto_Gravado, Trim(txtDoc_Afectado.text), Trim(txtNro_Doc_Afectado.text), CInt(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)), pdblTc, _
                            CLng(Me.txtMoneda.text), ldblImporte_IVA)
                  frmIngresoBaucher_TCredito.Show vbModal
                  pdblTc = pdblTc
             End If
         
         End If
        
    End If
    
    If KeyCode = vbKeyAdd Then
        If val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE)) > 0 Then
            Exit Sub
        End If
        If Not IsNumeric(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE)) Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE) = 0
        End If
        If txtMoneda.text = vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA) Then
             pdblTc = 1
        Else
             If val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TC)) = 0 Then
                  pdblTc = 1
             Else
                  pdblTc = val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TC))
             End If
        End If
        lImporte = val(txtImporte.text) - val(Me.txtTotal_Medios_Pago.text)
        If txtMoneda.text = gMoneda_Base Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE) = Format(lImporte / pdblTc, "0.00")
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_IMPORTE) = Format(lImporte * pdblTc, "0.00")
        End If
        vsfMedios_Pagos.Col = CGMP_IMPORTE
        vsfMedios_Pagos.EditText = lImporte
        
        
        lCancel = False
        Call vsfMedios_Pagos_KeyDown(vbKeyReturn, 0)
        Call vsfMedios_Pagos_ValidateEdit(vsfMedios_Pagos.Row, CGMP_IMPORTE, lCancel)
       
        llngCod_Medio_Pago = vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MEDIO_PAGO)
        If Busco_Medios_Pago(llngCod_Medio_Pago, lrstMedio_Pago) Then
            If Not Tarjeta_Habilitada(lrstMedio_Pago) Then
                Exit Sub
            Else
                Call vsfMedios_Pagos_KeyDown(vbKeyF9, 0)
            End If
        End If
        
    End If
    
    If KeyCode = vbKeyF12 Or KeyCode = vbKeyEnd Then

         If Controlar_Ingreso_Medios_Pago Then
            If Trim(UCase(sspOperacion.Caption)) = "C" Then
                cmdGuardar.Enabled = False
            Else
                'AIR 20250929
                If ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas = True And CDbl(NullToZero(txtCambio.text <> 0)) Then
                    txtCambio.Enabled = True
                    txtCambio.Locked = False
                    txtCambio.SetFocus
                Else
                    cmdGuardar.Enabled = True
                    cmdGuardar.SetFocus
                End If
            End If
        Else
            gbolESC = True
            MsgBox "El Detalle de Medios de Pago no es Correcto, Verifique", vbCritical + vbOKOnly
            cmdGuardar.Enabled = False
            vsfMedios_Pagos.SetFocus
        
           Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
                Case "DESCRIPCION"
                    vsfMedios_Pagos.Col = CGMP_DESCRIPCION
                Case Else
                    vsfMedios_Pagos.Col = CGMP_IMPORTE
            End Select
        End If
            
    End If
    
    If KeyCode = vbKeyLeft Then
           Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
                Case "DESCRIPCION"
                    If vsfMedios_Pagos.Col = CGMP_IMPORTE Or vsfMedios_Pagos.Col = CGMP_CUOTAS Or vsfMedios_Pagos.Col = CGMP_TC Or vsfMedios_Pagos.Col = CGMP_SIMBOLO Then
                        vsfMedios_Pagos.Col = CGMP_DESCRIPCION
                    End If
                Case Else
            End Select
    End If
    
    If KeyCode = vbKeyRight Then
           Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
                Case "DESCRIPCION"
                    If vsfMedios_Pagos.Col = CGMP_DESCRIPCION Or vsfMedios_Pagos.Col = CGMP_CUOTAS Or vsfMedios_Pagos.Col = CGMP_TC Or vsfMedios_Pagos.Col = CGMP_SIMBOLO Then
                        vsfMedios_Pagos.Col = CGMP_IMPORTE
                    End If
                Case Else
            End Select
    End If
    
    
    If KeyCode = vbKeyF3 Then   ' AIR 20181129 busqueda de Seña
        If vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_MPAGO) = "S" Then   ' AIR 20181130 Tipo de Medio de Pago Seña
            
            If vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA) <> val(txtMoneda.text) Then
                MsgBox "ERROR: La Moneda de la Seña no es Válida para este Documento. Verifique...", vbCritical + vbOKOnly
                Exit Sub
            Else
                Call Busqueda_Documentos_a_Afectar(val(txtEmpresa.text), val(txtCodProv.text), "Y", "E", 1, "Medios_Pagos", val(txtMoneda.text))
            End If
        End If
    
    End If
    
End Sub

Public Function Control_Interface_Tarjetas() As Boolean
     Dim i As Integer
     Dim lrstMedio_Pago As Recordset
     Dim lrstBaucher As Recordset
     Dim lstrTransact As String
     Dim lstrFiserv As String
     Dim llngNro_Doc_Provisorio As Long
     Dim ltotal_medio As Double
     Dim ltotal_baucher As Double
     Dim lTC As Double
     Dim psql As String
     Dim rtMda As Recordset

     On Error GoTo Errores
     
     Control_Interface_Tarjetas = True
     
     
     If Not ConfControlImportesVoucher Or Me.sspOperacion.Caption <> "A" Then
         Exit Function
     End If
     
     
     
     
     psql = "select distinct a.moneda,b.simbolo From Medios_Pago a ,monedas b where a.moneda=b.codigo order by a.moneda"
     Set rtMda = Dbs.OpenRecordset(psql, dbOpenSnapshot)
    
     
     While Not rtMda.EOF
         ltotal_medio = 0
         ltotal_baucher = 0
         lTC = 1
         For i = 1 To vsfMedios_Pagos.Rows - 1
             If val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = rtMda!moneda Then
                 If EsMedioPagoInterfaceTarjeta(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)) Then
                     ltotal_medio = ltotal_medio + (val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) * lTC)
                 End If
             End If
         Next
     
         If Me.sspOperacion.Caption = "A" Then
            ' AIR 20250505
            'llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_Caja * ConfMultiplo_caja) + CLng(txtDoc.text)
            llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_SubCaja * ConfMultiplo_caja) + CLng(txtDoc.text)
         Else
             llngNro_Doc_Provisorio = CLng(txtDoc.text)
         End If
                 
         ltotal_baucher = 0
         If Obtener_Lista_Baucher(CLng(txtEmpresa.text), CLng(txtCodDoc.text), llngNro_Doc_Provisorio, CLng(txtCodProv.text), -1, lrstBaucher, -3) Then
             While Not lrstBaucher.EOF
                 If lrstBaucher!moneda = rtMda!moneda Then
                     ltotal_baucher = ltotal_baucher + (lrstBaucher!Importe * lTC)
                 End If
                 lrstBaucher.MoveNext
             Wend
         End If
    
         If Round(ltotal_medio, 2) <> Round(ltotal_baucher, 2) Then
             MsgBox "El total de medios de pagos en " & Trim(rtMda!simbolo) & " con Interface a tarjetas es de " & Format(ltotal_medio, "0.00") & " y el saldo de Voucher es " & Format(ltotal_baucher, "0.00") & " son diferentes ", vbInformation, MsgTit
             Control_Interface_Tarjetas = False
             Exit Function
         End If
         'gTotal_Baucher = gTotal_Baucher + ltotal_baucher
         
         rtMda.MoveNext
    Wend
    
    Exit Function
     
Errores:
     MsgBox Err.Description, vbInformation, MsgTit
        
     Control_Interface_Tarjetas = False

End Function



Private Sub vsfMedios_Pagos_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
Dim R As Recordset
Dim lrstSeña As Recordset
Dim ldblTotalSinDevolucion As Double
Dim lImporte As Double

    Select Case Col

        Case CGMP_IMPORTE
            If Trim(vsfMedios_Pagos.EditText) = "" And Not IsNumeric(vsfMedios_Pagos.TextMatrix(Row, Col)) Then
                MsgBox "El Importe No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not IsNumeric(vsfMedios_Pagos.EditText) And Not IsNumeric(vsfMedios_Pagos.TextMatrix(Row, Col)) Then
                    MsgBox "El Importe Debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                If IsNumeric(vsfMedios_Pagos.EditText) Then
                      lImporte = vsfMedios_Pagos.EditText
                ElseIf IsNumeric(vsfMedios_Pagos.TextMatrix(Row, Col)) Then
                      lImporte = vsfMedios_Pagos.TextMatrix(Row, Col)
                End If
                
                'ATU 22/03/2016 se busca el medio de pago y se controla si permite o no devolver.
                    If Busco_Medios_Pago(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MEDIO_PAGO), R) Then
                        
                        ldblTotalSinDevolucion = Round(Calculo_Total_Medios_Pago_SIN_DEVOLUCION(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MEDIO_PAGO)), 2)
                        
                        ' jch 20190514 se agrego en el if si ingresa 0 no controla devolucion
                         
                        If val(vsfMedios_Pagos.EditText) = 0 Or (Trim(R!tipo_dev_cambio) = "PUEDE_DEVOLVER") Or (Trim(R!tipo_dev_cambio) = "NO_PUEDE_DEVOLVER" And (ldblTotalSinDevolucion) <= val(txtImporte.text)) Then ' + Val(vsfMedios_Pagos.EditText)
                            vsfMedios_Pagos.EditText = Format(lImporte, "0.00")
                            
                            Call Calculo_Total_Medios_Pago(True)
                            
                            If ConfPuntoVta_Mostrar_Vencimientos_Cuotas Then
                                Call Cargo_Grilla_Vencimientos_Cuotas(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MEDIO_PAGO), CDate(txtFec_Doc.text), vsfMedios_Pagos.EditText)
                            End If
                    
                        Else
                            MsgBox "Los Importes del Medio de Pago NO Permiten Devolver Cambio", vbCritical, MsgTit
                            Cancel = True
                            Exit Sub
                        End If
                        
                        ' AIR 20190221 se agrega control para que no se cambie el monto de la seña elegida en la grilla de medios de pago. El monto tiene que ser el del documento de cobranza de la seña
                        
                        If vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_MPAGO) = "S" And CDbl(lImporte) <> 0 And val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_CODDOC)) <> 0 Then
                    
                            lstrSQL = "SELECT FACCMP.* "
                            lstrSQL = lstrSQL & " FROM FACCMP "
                            lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                            lstrSQL = lstrSQL & " AND cod_doc = " & vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_CODDOC)
                            lstrSQL = lstrSQL & " AND nro_doc = " & vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_NRODOC)
                            lstrSQL = lstrSQL & " AND cod_prov = " & vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_CODPROV)
                            
                            Set lrstSeña = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                                
                            If Not lrstSeña.EOF Then
                                If lrstSeña!Importe <> CDbl(lImporte) Then
                                    MsgBox "El Monto de la Seña No puede ser modificado .", vbCritical, MsgTit
                                    vsfMedios_Pagos.EditText = Format(lrstSeña!Importe, "0.00")
                                    Cancel = True
                                    Exit Sub
                                End If
                            End If
                        Else
                            If vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_TIPO_MPAGO) = "S" Then
                                vsfMedios_Pagos.EditText = Format(0, "0.00")
                            End If
                        End If
                    Else
                        MsgBox "El Medio de Pago No Existe", vbCritical, MsgTit
                        Cancel = True
                        Exit Sub
                    End If
                End If
            End If

        Case CGMP_MONEDA
            If Trim(vsfMedios_Pagos.EditText) = "" Then
                MsgBox "El Código de Moneda No puede ser Nulo", vbCritical, MsgTit
                Cancel = True
                Exit Sub
            Else
                If Not IsNumeric(Trim(vsfMedios_Pagos.EditText)) Then
                    MsgBox "El Código de Moneda Debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    If Not Busco_Moneda(vsfMedios_Pagos.EditText) Then
                        MsgBox "Moneda Inexistente", vbCritical, MsgTit
                        Cancel = True
                        Exit Sub
                    End If
                End If
            End If

        Case CGMP_TC
            If val(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Row, CGMP_MONEDA)) <> gMoneda_Base Then
                If Trim(vsfMedios_Pagos.EditText) = "" Then
                    MsgBox "El Tipo de Cambio de la Moneda No puede ser Nulo", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                Else
                    If Not IsNumeric(Trim(vsfMedios_Pagos.EditText)) Then
                        MsgBox "El Tipo de Cambio de la Moneda Debe ser un Número Válido", vbCritical, MsgTit
                        Cancel = True
                        Exit Sub
                    Else
                        vsfMedios_Pagos.EditText = Format(vsfMedios_Pagos.EditText, "0.00")
                        Call Calculo_Total_Medios_Pago(True)
                    End If
                End If
            End If
        
        Case CGMP_REFERENCIA
            If Trim(vsfMedios_Pagos.EditText) <> "" Then
                If Not IsNumeric(Trim(vsfMedios_Pagos.EditText)) Then
                    MsgBox "La Referencia Debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                    Exit Sub
                End If
            End If

    End Select
End Sub

Public Function Cargo_Grilla_Medios_Pago(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngMoneda As Long, Optional pbooAfectacion As Boolean = False)
On Error GoTo Errores
Dim SQL As String
Dim C As Recordset
Dim R As Recordset
Dim D As Recordset
Dim ldblTipo_Cambio As Double

'ATU 23 / 3 / 2016
' Se cargan los medios de pago por debajo del 89 y se asignan al final los referidos al cambio.

    Select Case ConfFormato_Factura
        Case "CASINO", "CASINO-POS", "DALTIRO"
            ' Solo Coloco los Medios de Pago segun la Forma de Pago.
            ' Forma Pago 0 - Contado - Solo coloco Efectivo
            ' Forma Pago <> 0 - Pongo Todos
            
            If Tipo_Documento_Tiene_Medios_Pago_Definidos(plngCod_Doc) Then
                ' El documento TIENE Restriccion del Tipo de Documento
                
                If Buscar_Cliente(txtCodProv.text, C) = True Then
                    If C!tip_cli = 0 And ConfFormato_Factura <> "CASINO-POS" Then ' AIR 20190606 a pedido de Casino Justicia se cambia la condicion, y se levantan todos los medios de pago para todos los clientes y documentos.
                        ' Solo Efectivo
                        SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                        SQL = SQL & " WHERE Medios_Pago.tipo_medio_pago = 'E' "
                        'AIR 20231031
                        'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                        SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                        
                        SQL = SQL & " AND Medios_Pago.activo = 'S' "
                        SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                        SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                    Else
                        If ConfTRANSACT_Habilitado = "S" Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S" Then
                            SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento "
                            'AIR 20231031
                            'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                            SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                            SQL = SQL & " AND Medios_Pago.activo = 'S' "
                            ql = SQL & " AND Medios_Pago.visible_pos='S'"
                            SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                            SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        Else
                            SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                            'AIR 20231031
                            'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                            SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                            
                            SQL = SQL & " AND Medios_Pago.activo = 'S' "
                            SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                            SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                            SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        End If
                    End If
                Else
                    'JEL-20111201  cambie este punto para que queden solo los Medios de Pago Efectivo cuando no existe el cliente
    '                SQL = "SELECT * FROM Medios_Pago WHERE CODIGO < 99 "
                    SQL = "SELECT Medios_Pago.* FROM Medios_Pago,Medios_Pago_x_Tipo_Documento"
                    'AIR 20231031
                    'SQL = SQL & " WHERE Medios_Pago.codigo < 89 "
                    SQL = SQL & " WHERE (Medios_Pago.codigo < 89 OR codigo > 99) "
                    
                    SQL = SQL & " AND Medios_Pago.activo = 'S' "
                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                    SQL = SQL & " AND Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                    SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & val(txtCodDoc.text)
                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                End If
            
            Else
                ' El documento no tiene Restriccion del Tipo de Documento
                
                If Buscar_Cliente(txtCodProv.text, C) = True Then
                    If C!tip_cli = 0 And ConfFormato_Factura <> "CASINO-POS" Then     ' AIR 20190606 a pedido de Casino Justicia se cambia la condicion, y se levantan todos los medios de pago para todos los clientes y documentos.
                        ' Solo Efectivo
                        SQL = "SELECT * FROM Medios_Pago"
                        SQL = SQL & " WHERE tipo_medio_pago = 'E' "
                        SQL = SQL & " AND activo = 'S' "
                        'AIR 20231031
                        'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                        SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                        SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                    Else
                        SQL = "SELECT * FROM Medios_Pago "
                        SQL = SQL & " WHERE activo = 'S' "
                        'AIR 20231031
                        'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                        SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                        
                        SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                    End If
                Else
                    SQL = "SELECT * FROM Medios_Pago "
                    SQL = SQL & " WHERE activo = 'S' "
                    'AIR 20231031
                    'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                    SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "

                    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                    SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                End If
            End If
            
        Case Else
            ' Chequeo la Tabla de Medios_Pago_x_Cliente, si No hay Medios de Pago pongo Todos, Sino los del Cliente
            
              
            
                
                SQL = "SELECT Medios_Pago.* FROM Medios_Pago_x_Cliente,Medios_Pago"
                SQL = SQL & " WHERE Medios_Pago_x_Cliente.cod_cliente = " & val(txtCodProv.text)
                SQL = SQL & " AND Medios_Pago.activo = 'S' "
                SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                SQL = SQL & " AND Medios_Pago_x_Cliente.cod_mpago = Medios_Pago.codigo"
                SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                
                Set MPC = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                If MPC.EOF Then
                
                        If Buscar_Medio_Pago_Documento_NoVisible(plngCod_Emp, plngCod_Doc, plngNro_Doc) Then
                           ' ATU busca el medio de pago del documento 29/10/2015
                            SQL = "SELECT Medios_Pago.*,ISNULL(Medios_Pago_x_Tipo_Documento.cod_mpago,-1) cod_mpago "
                            SQL = SQL & " FROM Medios_Pago LEFT OUTER JOIN Medios_Pago_x_Tipo_Documento ON Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                        Else
                            SQL = "SELECT Medios_Pago.*,ISNULL(Medios_Pago_x_Tipo_Documento.cod_mpago,-1) cod_mpago "
                            SQL = SQL & " FROM Medios_Pago INNER JOIN Medios_Pago_x_Tipo_Documento ON Medios_Pago.codigo = Medios_Pago_x_Tipo_Documento.cod_mpago"
                        End If
                        SQL = SQL & " AND Medios_Pago_x_Tipo_Documento.cod_doc=" & plngCod_Doc
                        SQL = SQL & " WHERE "
                        'SQL = SQL & " Medios_Pago.codigo < 89 "
                        'AIR 20231031
                        SQL = SQL & " (Medios_Pago.codigo < 89 OR codigo > 99) "
                        SQL = SQL & " AND Medios_Pago.activo = 'S' "
                        If Trim(sspOperacion.Caption) = "A" And Not pbooAfectacion Then ' jch 20240307 estaba distinto a C debe ser igual a A
                                SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                        End If
                        If Buscar_Tipo_Documento(plngCod_Doc, D) Then
                             If Trim(UCase(D!clase)) = "CREDITO" Then
                                 SQL = Replace(SQL, "Medios_Pago LEFT OUTER JOIN Medios_Pago_x_Tipo_Documento", "Medios_Pago INNER JOIN Medios_Pago_x_Tipo_Documento")
                             End If
                        End If
                        
                        SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        
                        Set MPC = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                        
                        If MPC.EOF Then
                            SQL = "SELECT *,codigo as cod_mpago FROM Medios_Pago "
                            SQL = SQL & " WHERE activo = 'S' "
                            'AIR 20231031
                            'SQL = SQL & " AND Medios_Pago.codigo < 89 "
                            SQL = SQL & " AND (Medios_Pago.codigo < 89 OR codigo >99) "
                                        
                            If Trim(sspOperacion.Caption) <> "C" Then
                                SQL = SQL & " AND Medios_Pago.visible_pos='S'"
                            End If
                            SQL = SQL & " ORDER BY Medios_Pago.x_defecto DESC,Medios_Pago.moneda,Medios_Pago.descripcion"
                        End If
                    End If
                
            
    End Select
    
    vsfMedios_Pagos.Rows = 1
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    While Not R.EOF
        vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows + 1
        
        SQL = "SELECT FaccmpMpagos.*,Medios_Pago.descripcion FROM FaccmpMpagos, Medios_Pago "
        SQL = SQL & " WHERE FaccmpMpagos.cod_emp = " & plngCod_Emp
        SQL = SQL & " AND FaccmpMpagos.cod_doc = " & plngCod_Doc
        SQL = SQL & " AND FaccmpMpagos.nro_doc = " & plngNro_Doc
        SQL = SQL & " AND FaccmpMpagos.cod_mpago = Medios_Pago.codigo AND Medios_Pago.codigo = " & R!codigo
        SQL = SQL & " ORDER BY FaccmpMpagos.cod_mpago"
        
        Set C = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If Not C.EOF Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = C!moneda_rec
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = Format(C!importe_digitado, "0.00")
            
            If C!moneda_rec <> C!moneda Or C!moneda_rec <> gMoneda_Base Then   ' C!moneda_rec <> gMoneda_Base Then AIR 20160809 modificado para que levante la cotizacion ingresada al momento de facturar.
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(C!Tipo_Cambio_Rec, "###0.000")
            Else
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = ""
            End If
        Else
            If R!moneda <> gMoneda_Base Then
'                ldblTipo_Cambio = Tipo_Cambio(R!moneda, txtFec_Doc.Text)
'                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), R!moneda, Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
                
                'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
                Else
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                End If
                
                If ldblTipo_Cambio <> 0 Then
                    vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(ldblTipo_Cambio, "###0.000")
                Else
                    MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                End If
            End If
        
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = R!moneda
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = Format(0, "0.00")
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MEDIO_PAGO) = R!codigo
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_MPAGO) = Trim(R!tipo_medio_pago)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_DESCRIPCION) = Trim(R!Descripcion)

        If IsNumeric(C!referencia) Then
            If C!referencia <> 0 Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_REFERENCIA) = C!referencia
            End If
        End If
        
        If R!cuotas <> 0 Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = R!cuotas
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = ""
        End If
        
        If Busco_Moneda(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) Then
        Else
            MsgBox "Moneda Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_SIMBOLO) = Trim(rstMonedas!simbolo)
        
        ' AIR 20181128 datos de la SEÑA
        If Trim(R!tipo_medio_pago) = "S" Then
            Call Cargo_Datos_Seña(plngCod_Emp, plngCod_Doc, plngNro_Doc)
        Else
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODDOC) = ""
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_NRODOC) = ""
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CODPROV) = ""
        End If
        
        vsfMedios_Pagos.Cell(flexcpBackColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFF&
        vsfMedios_Pagos.Cell(flexcpForeColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFFFFFF
        vsfMedios_Pagos.Cell(flexcpFontBold, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = True
        
        'JCH 20250218
        If ConfFormato_Factura = "CASINO" Or ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "DALTIRO" Then
                'AIR 20260113 se corrige el nombre del recordset
'             If C.EOF And FieldExists(RM, "cod_mpago") Then
'                'If RM!cod_mpago = -1 Then
             If C.EOF And FieldExists(R, "cod_mpago") Then
                If R!cod_mpago = -1 Then
                
                    vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows - 1
                End If
             End If
        End If
        
        R.MoveNext
    Wend
    R.Close
    
'ATU se agregan los de cambio al FINAL.

    SQL = "SELECT * FROM Medios_Pago"
    SQL = SQL & " WHERE tipo_medio_pago = 'E'"
    SQL = SQL & " AND activo = 'S' "
    SQL = SQL & " AND Medios_Pago.visible_pos='S'"
    SQL = SQL & " AND tipo_dev_cambio ='CAMBIO' "
    SQL = SQL & " ORDER BY Medios_Pago.moneda"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    While Not R.EOF
        vsfMedios_Pagos.Rows = vsfMedios_Pagos.Rows + 1
        
        SQL = "SELECT FaccmpMpagos.*,Medios_Pago.descripcion FROM FaccmpMpagos, Medios_Pago "
        SQL = SQL & " WHERE FaccmpMpagos.cod_emp = " & plngCod_Emp
        SQL = SQL & " AND FaccmpMpagos.cod_doc = " & plngCod_Doc
        SQL = SQL & " AND FaccmpMpagos.nro_doc = " & plngNro_Doc
        SQL = SQL & " AND FaccmpMpagos.cod_mpago = Medios_Pago.codigo AND Medios_Pago.codigo = " & R!codigo
        SQL = SQL & " ORDER BY FaccmpMpagos.cod_mpago"
        
        Set C = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If Not C.EOF Then
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = C!moneda_rec
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = Format(C!importe_digitado, "0.00")
            If C!moneda_rec <> gMoneda_Base Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(C!Tipo_Cambio_Rec, "###0.000")
            Else
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = ""
            End If
        Else
            If R!moneda <> gMoneda_Base Then
'                ldblTipo_Cambio = Tipo_Cambio(R!moneda, txtFec_Doc.Text)
'                ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.Text), R!moneda, Format(txtFec_Doc.Text, "dd/mm/yyyy"), "F")
                
                'AIR 20180326 si la factura es en DOLARES toma el manual comprador
                If val(txtMoneda.text) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
                Else
                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), R!moneda, Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
                End If
                
                If ldblTipo_Cambio <> 0 Then
                    vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TC) = Format(ldblTipo_Cambio, "###0.000")
                Else
                    MsgBox "Tipo de Cambio Inexistente para la Moneda " & Trim(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) & " a la Fecha " & txtFec_Doc.text, vbInformation, MsgTit
                End If
            End If
        
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA) = R!moneda
            vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = Format(0, "0.00")
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MEDIO_PAGO) = R!codigo
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_MPAGO) = Trim(R!tipo_medio_pago)
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_DESCRIPCION) = Trim(R!Descripcion)
        
        If IsNumeric(C!referencia) Then
            If C!referencia <> 0 Then
                vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_REFERENCIA) = C!referencia
            End If
        End If
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_CUOTAS) = ""
        
        If Busco_Moneda(vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_MONEDA)) Then
        Else
            MsgBox "Moneda Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_SIMBOLO) = Trim(rstMonedas!simbolo)
        
        vsfMedios_Pagos.Cell(flexcpBackColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFF&
        vsfMedios_Pagos.Cell(flexcpForeColor, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = &HFFFFFF
        vsfMedios_Pagos.Cell(flexcpFontBold, vsfMedios_Pagos.Rows - 1, CGMP_IMPORTE) = True
        
        vsfMedios_Pagos.TextMatrix(vsfMedios_Pagos.Rows - 1, CGMP_TIPO_DEV_CAMBIO) = Trim(R!tipo_dev_cambio)
        
        R.MoveNext
    Wend
    R.Close
    
    Call Calculo_Total_Calculado(True)
    Call Calculo_Total_Medios_Pago(True)
    
Exit Function
Errores:
    MsgBox "Error al Cargar los Medios de Pago, Verifique por Favor", vbInformation, MsgTit
End Function

Public Function Cargo_Datos_Tasa_Bromatologica(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim SQL As String
Dim C As Recordset
Dim B As Recordset
Dim lrstPorcentaje_TBromatologica As Recordset
Dim ldblPorcentaje_TBromatologica As Double

        
    SQL = "SELECT FaccmpBromatologia.*,ma_Tipos_Tasas_Bromatologicas.descripcion "
    SQL = SQL & " FROM FaccmpBromatologia, ma_Tipos_Tasas_Bromatologicas "
    SQL = SQL & " WHERE FaccmpBromatologia.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND FaccmpBromatologia.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND FaccmpBromatologia.nro_doc = " & plngNro_Doc
    SQL = SQL & " AND FaccmpBromatologia.cod_tasa = ma_Tipos_Tasas_Bromatologicas.codigo"
    
    Set C = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If Not C.EOF Then
        txtTasa_Bromatologica.text = C!cod_tasa
        txtImporte_TBromatologica.text = Format(C!Importe, "0.00")
    Else
        txtTasa_Bromatologica.text = "0"
        txtImporte_TBromatologica.text = Format(0, "0.00")
    End If
            
    If Busco_Tipo_Tasa_Bromatologica(txtTasa_Bromatologica.text, B) Then
        ldblPorcentaje_TBromatologica = Porcentaje_Tasa_Bromatologica_Vigente(B!codigo, CDate(txtFec_Doc.text), lrstPorcentaje_TBromatologica)
        txtPorcentaje_TBromatologica.text = Format(ldblPorcentaje_TBromatologica / 100, "0.00%")
    Else
        ldblPorcentaje_TBromatologica = 0
        txtPorcentaje_TBromatologica.text = "0.00"
    End If
    
End Function

Public Function Cargo_Datos_EFactura_Exportacion_Otros(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim SQL As String
Dim C As Recordset
Dim B As Recordset

    SQL = "SELECT FaccmpEfactura.* "
    SQL = SQL & " FROM FaccmpEfactura "
    SQL = SQL & " WHERE FaccmpEfactura.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND FaccmpEfactura.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND FaccmpEfactura.nro_doc = " & plngNro_Doc
    
    Set C = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If Not C.EOF Then
        txtClauVta.text = C!clauvta
        txtViaTransporte.text = C!viatransporte
        If Busco_Pais(C!pais, B) Then
            txtPais.text = B!codigo & " " & B!nombre
        Else
            txtPais.text = ""
        End If
        txtTipo_Doc_Identidad.text = C!tipo_doc_identidad
        glngTipo_Documento_Identidad = val(txtTipo_Doc_Identidad.text)

    Else
        txtClauVta.text = ""
        txtViaTransporte.text = ""
        txtPais.text = ""
    End If
            
End Function

Public Function Cargo_Grilla_Cheques(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim SQL As String
Dim C As Recordset
Dim M As Recordset
Dim R As Recordset
Dim lrstMovBancarios As Recordset
Dim i As Integer
Dim ldblTipo_Cambio As Double

    vsfCheques.Rows = 1
    
    SQL = "SELECT Faccmpcheques.* FROM Faccmpcheques "
    SQL = SQL & " WHERE Faccmpcheques.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND Faccmpcheques.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND Faccmpcheques.nro_doc = " & plngNro_Doc

    SQL = SQL & " ORDER BY Faccmpcheques.nro_linea"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not R.EOF
    
        vsfCheques.Rows = vsfCheques.Rows + 1
        
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_BANCO) = R!cod_banco
        If Busco_Banco(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_BANCO), C) Then
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_DESCRIPCION) = C!nombre
        Else
            MsgBox "Banco Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        If NullToZero(R!Cuenta) <> 0 Then
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_CUENTA) = R!Cuenta
        End If
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_DOCUMENTO) = R!Cod_Doc_Cheque
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_SERIE) = R!serie
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_NUMERO_CHEQUE) = R!nro_cheque
        
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_MONEDA) = R!moneda
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_TC) = Format(R!Tipo_Cambio, "0.00")
        If Buscar_Moneda(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_MONEDA), M) Then
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_SIMBOLO) = Trim(M!simbolo)
        Else
            MsgBox "Moneda Inexistente. Verifique", vbCritical + vbOKOnly
        End If
        
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_IMPORTE) = Format(R!Importe, "###,##0.00")
        
        vsfCheques.Cell(flexcpBackColor, vsfCheques.Rows - 1, CGCH_IMPORTE) = &HFF&
        vsfCheques.Cell(flexcpForeColor, vsfCheques.Rows - 1, CGCH_IMPORTE) = &HFFFFFF
        vsfCheques.Cell(flexcpFontBold, vsfCheques.Rows - 1, CGCH_IMPORTE) = True
        
        ldblTipo_Cambio = R!Tipo_Cambio
                
        If IsNumeric(txtMoneda.text) Then
            If CLng(txtMoneda.text) = gMoneda_Base Then
                vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_IMPORTE_DEL_DOC) = Format(Importe_Base(CInt(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, Abs(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_IMPORTE))), "###,##0.00")
            End If
            
            If CLng(txtMoneda.text) = gMoneda_Referencia Then
                vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_IMPORTE_DEL_DOC) = Format(Importe_Referencia(CInt(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_MONEDA)), ldblTipo_Cambio, txtFec_Doc.text, Abs(vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_IMPORTE))), "###,##0.00")
            End If
        End If
        
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_FECHA_EMISION) = Format(R!fec_emision, "dd/mm/yyyy")
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_FECHA_VTO) = Format(R!fec_ven, "dd/mm/yyyy")

        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_CUENTA_LIBRADOR) = R!Cuenta_librador
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_TITULAR_LIBRADOR) = R!Titular_librador  ' SS 20160927
        vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_OBS) = lstrObservacion                  ' SS 20161220

                    
        ' Busco en Mov_Bancarios    'AIR 20190215
        SQL = "SELECT * FROM Mov_Bancarios "
        SQL = SQL & " WHERE cod_emp = " & plngCod_Emp
        SQL = SQL & " AND   cod_banco_emi = " & R!cod_banco
        SQL = SQL & " AND   nro_cuenta = " & R!Cuenta
        SQL = SQL & " AND   cod_doc = " & R!Cod_Doc_Cheque
        SQL = SQL & " AND   nro_doc = " & R!nro_cheque
        
        Set lrstMovBancarios = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        
        If Not lrstMovBancarios.EOF Then
        
            ' AIR 20180906 se agregaron los datos del cheque para no perder datos y estado del cheque en caso de modificacion
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_ESTADO) = lrstMovBancarios!estado  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_FEC_REG) = lrstMovBancarios!fec_reg  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_USUARIO) = lrstMovBancarios!usuario  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_COD_BANCO_EMI) = lrstMovBancarios!cod_banco_emi  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_FEC_BANCO) = lrstMovBancarios!fec_banco  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_COD_DOCA_DEP) = NullToZero(lrstMovBancarios!cod_doca_dep)  ' AIR 20180906
            vsfCheques.TextMatrix(vsfCheques.Rows - 1, CGCH_NRO_DOCA_DEP) = NullToZero(lrstMovBancarios!nro_doca_dep)  ' AIR 20180906
        End If
        
        R.MoveNext
    Wend
    
    If vsfCheques.Rows <= 1 Then
        vsfCheques.Rows = vsfCheques.Rows + 1
    End If
    
End Function

Public Function Cargo_Grilla_Tarjetas(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim SQL As String
Dim R As Recordset

    vsfTarjetas_Credito.Rows = 1
    
    SQL = "SELECT Faccmp_Baucher_TCredito.*,Medios_Pago.descripcion,Monedas.simbolo "
    SQL = SQL & " FROM Faccmp_Baucher_TCredito,Medios_Pago,Monedas "
    SQL = SQL & " WHERE Faccmp_Baucher_TCredito.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND Faccmp_Baucher_TCredito.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND Faccmp_Baucher_TCredito.nro_doc = " & plngNro_Doc
    SQL = SQL & " AND Faccmp_Baucher_TCredito.cod_mpago = Medios_Pago.codigo"
    SQL = SQL & " AND Faccmp_Baucher_TCredito.moneda = Monedas.codigo"

    SQL = SQL & " ORDER BY Faccmp_Baucher_TCredito.linea"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not R.EOF
    
        vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Rows + 1
        
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_MEDIO_PAGO) = R!cod_mpago
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_DESCRIPCION) = R!Descripcion
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_NUMERO) = R!nro_tarjeta
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_FECHA_VTO) = Format(R!fec_vencimiento, "dd/mm/yyyy")
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_NOMBRE_TITULAR) = Trim(UCase(R!titular))
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_CODIGO_VERIFICACION) = 0
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_CUOTAS) = R!cuotas
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_AUTORIZACION) = Trim(R!autorizacion)
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_LOTE) = Trim(R!lote)
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_MONEDA) = R!moneda
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_SIMBOLO) = Trim(R!simbolo)
        
        vsfTarjetas_Credito.TextMatrix(vsfTarjetas_Credito.Rows - 1, CGTA_IMPORTE) = Format(R!Importe, "0.00")
        
        vsfTarjetas_Credito.Cell(flexcpBackColor, vsfTarjetas_Credito.Rows - 1, CGTA_IMPORTE) = &HFF&
        vsfTarjetas_Credito.Cell(flexcpForeColor, vsfTarjetas_Credito.Rows - 1, CGTA_IMPORTE) = &HFFFFFF
        vsfTarjetas_Credito.Cell(flexcpFontBold, vsfTarjetas_Credito.Rows - 1, CGTA_IMPORTE) = True
        
        R.MoveNext
    Wend
    
    If vsfTarjetas_Credito.Rows <= 1 Then
        vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Rows + 1
    End If
    
End Function

Public Sub Cargo_Grilla_Series()
Dim lclsSerie_Articulo As clsSerie_Articulo
Dim P As Recordset

    vsfSeries_Articulos.Rows = 1
    
    For Each lclsSerie_Articulo In gcolSeries_Articulos

        If Trim(lclsSerie_Articulo.serie) <> "" Then
    
            If Buscar_Articulo(lclsSerie_Articulo.Cod_Prod, P) Then
            
                vsfSeries_Articulos.Rows = vsfSeries_Articulos.Rows + 1
                
                vsfSeries_Articulos.TextMatrix(vsfSeries_Articulos.Rows - 1, CGSA_CODIGO_PROD) = lclsSerie_Articulo.Cod_Prod
                
                vsfSeries_Articulos.TextMatrix(vsfSeries_Articulos.Rows - 1, CGSA_CODIGO_PROD_ANTERIOR) = Trim(P!cod_prod_sistema_ant)
                
                vsfSeries_Articulos.TextMatrix(vsfSeries_Articulos.Rows - 1, CGSA_DESCRIPCION) = Trim(P!nom_prod)
                
                vsfSeries_Articulos.TextMatrix(vsfSeries_Articulos.Rows - 1, CGSA_SERIE) = Trim(lclsSerie_Articulo.serie)
                
                vsfSeries_Articulos.TextMatrix(vsfSeries_Articulos.Rows - 1, CGSA_SERIE_SIN_CONTROL_COMPRA) = Trim(lclsSerie_Articulo.serie_sin_control_compra)
                
            End If
        End If
        
    Next
        
    vsfSeries_Articulos.ColSort(CGSA_CODIGO_PROD) = flexSortNumericAscending
    vsfSeries_Articulos.Sort = flexSortStringAscending
        
    vsfSeries_Articulos.SubtotalPosition = flexSTBelow
    vsfSeries_Articulos.OutlineBar = flexOutlineBarComplete
    
    vsfSeries_Articulos.Subtotal flexSTCount, CGSA_CODIGO_PROD, CGSA_SERIE, , &HCED7E6, , True, "%s"
        
End Sub

Public Function Cargo_Grilla_Vales(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim SQL As String
Dim R As Recordset

    vsfVales.Rows = 1
    
    SQL = "SELECT Faccmp_Vales.*,Monedas.simbolo "
    SQL = SQL & " FROM Faccmp_Vales,Monedas "
    SQL = SQL & " WHERE Faccmp_Vales.cod_emp = " & plngCod_Emp
    SQL = SQL & " AND Faccmp_Vales.cod_doc = " & plngCod_Doc
    SQL = SQL & " AND Faccmp_Vales.nro_doc = " & plngNro_Doc
    SQL = SQL & " AND Faccmp_Vales.moneda =  Monedas.codigo "
    SQL = SQL & " ORDER BY Faccmp_Vales.nro_doc"
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not R.EOF
    
        vsfVales.Rows = vsfVales.Rows + 1
        
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_CODDOC) = R!cod_doca
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_NRODOC) = R!nro_doca
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_CODPROV) = R!Cod_Prova
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_DOCID) = R!doc_identidad
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_MONEDA) = R!moneda
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_SIMBOLO) = Trim(R!simbolo)
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_IMPORTE) = R!Importe
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_FEC_VENC) = R!fec_venc
        vsfVales.TextMatrix(vsfVales.Rows - 1, CGVA_SALDO) = 0
     
        vsfVales.Cell(flexcpBackColor, vsfVales.Rows - 1, CGVA_IMPORTE) = &HFF&
        vsfVales.Cell(flexcpForeColor, vsfVales.Rows - 1, CGVA_IMPORTE) = &HFFFFFF
        vsfVales.Cell(flexcpFontBold, vsfVales.Rows - 1, CGVA_IMPORTE) = True
        
        R.MoveNext
    Wend
    
    If vsfVales.Rows <= 1 Then
        vsfVales.Rows = vsfVales.Rows + 1
    End If
    
End Function
Public Function Cargo_Grilla_Vencimientos_Cuotas(plngCod_Medio_Pago As Long, pdteFecha As Date, pdblImporte As Double)
Dim lrstMedio_Pago As Recordset
Dim ldblImporte_Cuota As Double
Dim ldteFecha_Vencimiento As Date
Dim i As Long
Dim ldblDiferencia As Double

    ldblDiferencia = 0
    If Busco_Medios_Pago(plngCod_Medio_Pago, lrstMedio_Pago) Then
    
        If lrstMedio_Pago!cuotas > 0 Then
            ' El Medio de Pago se Divide en Cuotas
                            
            ldblImporte_Cuota = pdblImporte / lrstMedio_Pago!cuotas
            
            If ConfFormato_Factura = "BARATILLO" Then
                
                If ldblImporte_Cuota > Int(ldblImporte_Cuota) Then
                    ldblImporte_Cuota = Int(ldblImporte_Cuota + 1)
                Else
                    ldblImporte_Cuota = Int(ldblImporte_Cuota)
                End If
                
                'ldblImporte_Cuota = Round(ldblImporte_Cuota, 0)
                ldblDiferencia = pdblImporte - (ldblImporte_Cuota * lrstMedio_Pago!cuotas)
                
            Else
                'AIR 20250815
                'ldblImporte_Cuota = Round(ldblImporte_Cuota, 2)
                ldblImporte_Cuota = Format(ldblImporte_Cuota, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                ldblDiferencia = pdblImporte - (ldblImporte_Cuota * lrstMedio_Pago!cuotas)
                                
            End If
            
            
            vsfVencimientos_Cuotas.Rows = 1
            
            For i = 1 To lrstMedio_Pago!cuotas
                                
                If Calcular_Fecha_Vencimiento_Cuota(plngCod_Medio_Pago, i, pdteFecha, ldteFecha_Vencimiento) Then
                
                    vsfVencimientos_Cuotas.Rows = vsfVencimientos_Cuotas.Rows + 1
                    vsfVencimientos_Cuotas.TextMatrix(vsfVencimientos_Cuotas.Rows - 1, CGVC_NUMERO) = i
                    vsfVencimientos_Cuotas.TextMatrix(vsfVencimientos_Cuotas.Rows - 1, CGVC_VENCIMIENTO) = Format(ldteFecha_Vencimiento, "dd/mm/yyyy")
                    
                    'AIR 20250815
                    'If i = lrstMedio_Pago!cuotas And ConfFormato_Factura = "BARATILLO" Then
                    If i = lrstMedio_Pago!cuotas Then
                        vsfVencimientos_Cuotas.TextMatrix(vsfVencimientos_Cuotas.Rows - 1, CGVC_IMPORTE) = Format(ldblImporte_Cuota + ldblDiferencia, "0.00")
                    Else
                        vsfVencimientos_Cuotas.TextMatrix(vsfVencimientos_Cuotas.Rows - 1, CGVC_IMPORTE) = Format(ldblImporte_Cuota, "0.00")
                    End If
                End If
            Next
        End If
    End If
        
    If vsfVencimientos_Cuotas.Rows > 1 Then
        frameVencimientos_Cuotas.visible = True
        Imagen_Producto.visible = False
    End If
    
End Function

Public Sub Cargo_Grilla_Descuentos_x_Volumen(plngCod_Prod As Long, pdteFecha As Date, plngLista As Long, pdblPVenta As Double)
Dim FDV As Recordset
Dim DV As Recordset
Dim ldblPrecio_Venta_Con_Dto As Double

    vsfDescuentos_x_Volumen.Rows = 1

    lstrSQL = "SELECT MAX(fec_vigencia) AS fec_vigencia "
    lstrSQL = lstrSQL & " FROM ma_Porcentaje_Dto_x_Volumen_x_Articulo_Cabezal"
    lstrSQL = lstrSQL & " WHERE cod_prod = " & plngCod_Prod
    lstrSQL = lstrSQL & " AND fec_vigencia <= " & f_Fecha_Base(pdteFecha, Conf_Motor_Base)
    lstrSQL = lstrSQL & " AND nro_lista = " & llngLista         ' JE 20250708   /   campo nuevo
    
    Set FDV = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    If Not FDV.EOF Then
        If Not IsNull(FDV!fec_vigencia) Then
            If IsDate(FDV!fec_vigencia) Then
        
                lstrSQL = "SELECT * "
                lstrSQL = lstrSQL & " FROM ma_Porcentaje_Dto_x_Volumen_x_Articulo_Dtos"
                lstrSQL = lstrSQL & " WHERE cod_prod = " & plngCod_Prod
                lstrSQL = lstrSQL & " AND fec_vigencia = " & f_Fecha_Base(FDV!fec_vigencia, Conf_Motor_Base)
                lstrSQL = lstrSQL & " AND nro_lista = " & llngLista         ' JE 20250708   /   campo nuevo
                lstrSQL = lstrSQL & " ORDER BY unidades"
                
                Set DV = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                    
                While Not DV.EOF
                                        
                    ldblPrecio_Venta_Con_Dto = pdblPVenta * (1 - (DV!porcentaje / 100))
                    ldblPrecio_Venta_Con_Dto = Round(ldblPrecio_Venta_Con_Dto, 1)
                    
                    vsfDescuentos_x_Volumen.Rows = vsfDescuentos_x_Volumen.Rows + 1
                    vsfDescuentos_x_Volumen.TextMatrix(vsfDescuentos_x_Volumen.Rows - 1, CGDV_CANTIDAD) = DV!unidades
                    vsfDescuentos_x_Volumen.TextMatrix(vsfDescuentos_x_Volumen.Rows - 1, CGDV_DTO) = Format(DV!porcentaje, "0.00")
                    vsfDescuentos_x_Volumen.TextMatrix(vsfDescuentos_x_Volumen.Rows - 1, CGDV_PVENTA) = Format(ldblPrecio_Venta_Con_Dto, "0.00")
                    
                    DV.MoveNext
                    
                Wend
            End If
        End If
    End If
        
End Sub

Public Sub Cargo_Grilla_Equivalencias_Stock(plngCod_Prod As Long)
Dim e As Recordset
Dim R As Recordset
Dim PV As Recordset
Dim ldblPrecio_Venta As Double
Dim ldblStock_Empresa_1 As Double
Dim ldblStock_Empresa_2 As Double
Dim ldblStock_Empresa_3 As Double

    vsfEquivalencias_Stock.Rows = 1

    lstrSQL = "SELECT ma_Equivalencias_Entre_Articulos.*,Productos.nom_prod,Productos.cod_prod_sistema_ant "
    lstrSQL = lstrSQL & " FROM ma_Equivalencias_Entre_Articulos,Productos"
    lstrSQL = lstrSQL & " WHERE ma_Equivalencias_Entre_Articulos.cod_prod = " & plngCod_Prod
    lstrSQL = lstrSQL & " AND ma_Equivalencias_Entre_Articulos.cod_prod_equivalente = Productos.cod_prod"
    lstrSQL = lstrSQL & " ORDER BY Productos.nom_prod"

    Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    While Not R.EOF
                            
        ldblPrecio_Venta = Busco_Precio_Emision(val(txtEmpresa.text), R!cod_prod_equivalente, val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
        
        vsfEquivalencias_Stock.Rows = vsfEquivalencias_Stock.Rows + 1
        vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_CODIGO) = Trim(R!cod_prod_equivalente)
        vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_CODIGO_SANTERIOR) = Trim(R!cod_prod_sistema_ant)
        vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_DESCRIPCION) = Trim(R!nom_prod)
        vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_PVENTA) = Format(ldblPrecio_Venta, "0.00")
        
        If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_1, e) Then
            ldblStock_Empresa_1 = Stock_Linea(ConfPuntoVta_Stock_Empresa_1, Trim(txtDeposito.text), R!cod_prod_equivalente, ConfPuntoVta_Recalcula_Stock_On_Line)
        Else
            ldblStock_Empresa_1 = 0
        End If
        
        If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_2, e) Then
            ldblStock_Empresa_2 = Stock_Linea(ConfPuntoVta_Stock_Empresa_2, Trim(txtDeposito.text), R!cod_prod_equivalente, ConfPuntoVta_Recalcula_Stock_On_Line)
        Else
            ldblStock_Empresa_2 = 0
        End If
        
        If Buscar_Empresa(ConfPuntoVta_Stock_Empresa_3, e) Then
            ldblStock_Empresa_3 = Stock_Linea(ConfPuntoVta_Stock_Empresa_3, Trim(txtDeposito.text), R!cod_prod_equivalente, ConfPuntoVta_Recalcula_Stock_On_Line)
        Else
            ldblStock_Empresa_3 = 0
        End If
        
        If ldblStock_Empresa_1 <> 0 Then
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_1) = Format(ldblStock_Empresa_1, "0.00")
        Else
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_1) = ""
        End If
        
        If ldblStock_Empresa_2 <> 0 Then
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_2) = Format(ldblStock_Empresa_2, "0.00")
        Else
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_2) = ""
        End If
        
        If ldblStock_Empresa_3 <> 0 Then
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_3) = Format(ldblStock_Empresa_3, "0.00")
        Else
            vsfEquivalencias_Stock.TextMatrix(vsfEquivalencias_Stock.Rows - 1, CGES_STOCK_3) = ""
        End If
        
        R.MoveNext
    Wend
        
End Sub

Public Sub Cargo_Grilla_Personas_Autorizadas(plngCliente As Long)
Dim R As Recordset
Dim lstrReferencia As String

    vsfPersonas_Autorizadas.Rows = 1

    lstrSQL = "SELECT * "
    lstrSQL = lstrSQL & " FROM Clientes_Personas_Autorizadas"
    lstrSQL = lstrSQL & " WHERE Clientes_Personas_Autorizadas.nro_cli = " & plngCliente
    lstrSQL = lstrSQL & " ORDER BY Clientes_Personas_Autorizadas.ci"

    Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    While Not R.EOF
                            
        lstrReferencia = Trim(R!nombre) & " " & Trim(R!apellido) & " " & Trim(R!relacion)
        
        vsfPersonas_Autorizadas.Rows = vsfPersonas_Autorizadas.Rows + 1
        vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_CI) = Trim(R!CI)
        vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_DESCRIPCION) = Mid(lstrReferencia, 1, 50)
        
        If Trim(Mid(lstrReferencia, 51, 50)) <> "" Then
            vsfPersonas_Autorizadas.Rows = vsfPersonas_Autorizadas.Rows + 1
            vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_CI) = ""
            vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_DESCRIPCION) = Mid(lstrReferencia, 51, 50)
        End If
        
        If Trim(Mid(lstrReferencia, 101, 50)) <> "" Then
            vsfPersonas_Autorizadas.Rows = vsfPersonas_Autorizadas.Rows + 1
            vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_CI) = ""
            vsfPersonas_Autorizadas.TextMatrix(vsfPersonas_Autorizadas.Rows - 1, CGPA_DESCRIPCION) = Mid(lstrReferencia, 101, 50)
        End If
        
        R.MoveNext
    Wend
        
End Sub


Function Control_Precio_Minimo(plngLista_Minimo As Long, pdblDescuento_Global As Double, plngFila As Long, pdblPrecio_Calculado As Double, ByRef pdblPrecio_Minimo As Double, ByRef pdblDescuento_Maximo As Double) As Boolean
Dim PV As Recordset
Dim P As Recordset

    Control_Precio_Minimo = True
    pdblDescuento_Maximo = 0

    If plngLista_Minimo <> 0 Then
        ' AIR 20210907 se cambia porque cuando la lista es autogenerada no la va a encontrar en la funcion Busco_Precio_lista
       'If Busco_Precio_Lista(vsfLineas_Mercaderia.TextMatrix(plngFila, CGL_CODIGO), Format(date, "dd/mm/yyyy"), plngLista_Minimo, PV) Then
            'pdblPrecio_Minimo = PV!precio_vta
        
        ' AIR 20221004
        ' Al cambiar la rutina falto ajustar tambien el parametro controlar pminimo ya que esta rutina ya controla el precio minimo
        'pdblPrecio_Minimo = Busco_Precio_Emision(Val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(plngFila, CGL_CODIGO), Val(txtCodProv.text), Val(txtCodDoc.text), plngLista_Minimo, Val(txtMoneda.text), CDbl(txtTipo_Cambio.text), Format(date, "dd/mm/yyyy"), ConfPuntoVta_Controla_PMinimo, PV)
        
        pdblPrecio_Minimo = Busco_Precio_Emision(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(plngFila, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), plngLista_Minimo, val(txtMoneda.text), CDbl(txtTipo_Cambio.text), Format(date, "dd/mm/yyyy"), "N", PV)
        
        'AIR- JE 20230313
        pdblPrecio_Minimo = Format(pdblPrecio_Minimo, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        If pdblPrecio_Minimo >= 0 Then
            
            If pdblPrecio_Calculado < pdblPrecio_Minimo Then
                If pdblPrecio_Minimo <> 0 Then
                    pdblDescuento_Maximo = Abs((1 - (pdblPrecio_Minimo / vsfLineas_Mercaderia.TextMatrix(plngFila, CGL_PUNITARIO))) * 100)
                End If
                MsgBox "El Artículo " & Trim(vsfLineas_Mercaderia.TextMatrix(plngFila, CGL_CODIGO)) & " - Tiene Precio Mínimo --> " & pdblPrecio_Minimo & "  - Se le Aplico el Siguiente Descuento Máximo --> " & Format(pdblDescuento_Maximo, "0.00") & " %", vbCritical + vbOKOnly
                Control_Precio_Minimo = False
            End If
        Else
            If plngLista_Minimo = -1 Then MsgBox "Verifique la moneda de la lista de precios.", vbCritical + vbOKOnly
        
            Control_Precio_Minimo = False
        End If
    End If

End Function

Sub Verifico_Documento_Cancelado()
Dim lstrSQL As String
Dim lrstPagos As Recordset
Dim ldblSaldo As Double
Dim F As Recordset

    If sspOperacion = "A" Then
        txtCancelada.text = "SIN CANCELAR"
    Else
        If sspOperacion = "B" Or sspOperacion = "M" Or sspOperacion = "C" Or sspOperacion = "R" Or sspOperacion = "U" Then
        
            If Buscar_Forma_Pago(val(txtForma_Pago.text), F) Then
                If Trim(UCase(F!cancela_documento)) = "S" Then
                    txtCancelada.BackColor = &HFFFF&
                    txtCancelada.ForeColor = &HFF&
                    txtCancelada.text = "CANCELADA TOTAL"
                    Exit Sub
                End If
            End If
            
            
            lstrSQL = "SELECT sum(importe) as importe"
            lstrSQL = lstrSQL & " FROM faccmppagos"
            lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
            lstrSQL = lstrSQL & " AND cod_doca = " & val(txtCodDoc.text)
            lstrSQL = lstrSQL & " AND nro_doca = " & val(txtDoc.text)
            lstrSQL = lstrSQL & " AND cod_prova = " & txtCodProv.text
            
            Set lrstPagos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            
            If lrstPagos.EOF Then
                txtCancelada.text = "SIN CANCELAR"
            Else
                If IsNull(lrstPagos!Importe) Then
                    txtCancelada.text = "SIN CANCELAR"
                Else
                    If IsNumeric(lrstPagos!Importe) Then
                        If lrstPagos!Importe >= CDbl(NullToZero(txtImporte.text)) Then
                            txtCancelada.BackColor = &HFFFF&
                            txtCancelada.ForeColor = &HFF&
                            txtCancelada.text = "CANCELADA TOTAL"
                        Else
                            ldblSaldo = CDbl(NullToZero(txtImporte.text)) - lrstPagos!Importe
                            txtCancelada.text = "SALDO -> " & Format(ldblSaldo, "0.00")
                            txtCancelada.BackColor = &HFF&
                            txtCancelada.ForeColor = &HFFFF&
                        End If
                    End If
                End If
            End If
        End If
    End If
            
End Sub


Public Function TARJETA_ON_LINE(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, plngCod_Medio_Pago As Long, pdblImporte As Double, pstrRUT As String, pdblMonto_Total_Factura As Double, pdblMonto_Gravado As Double) As Boolean
Dim lrstMedios_Pago As Recordset
Dim lstrRespuesta As String
Dim lstrReferencia As String
Dim lstrTipo_Operacion As String
Dim D As Recordset

Dim lstrTarjeta_Cliente As String
Dim lstrAutorizacion_Tarjeta As String
Dim llngTipo_Tarjeta As Long
Dim llngCuotas As Long
Dim llngNro_Factura_Original_para_Anular As Long
Dim lbolOK_Nro_Factura_Original_para_Anular As Boolean
Dim llngNro_Doc_Provisorio As Long

Dim lclsLinea_Baucher_Tarjeta As New clsLinea_Baucher_Tarjeta




'variables para fiserv
Dim gbolAplica_Ley_19210 As Boolean
Dim lrstAutorizacion As Recordset
Dim ltipoAutorizacion As String

    TARJETA_ON_LINE = True

    If ConfTRANSACT_Habilitado = "S" Then
    
        If Busco_Medios_Pago(plngCod_Medio_Pago, lrstMedios_Pago) Then
    
            If Not IsNull(lrstMedios_Pago!Transact_chequear) Then
                
                If Trim(UCase(lrstMedios_Pago!Transact_chequear)) = "S" Then
                    
                    If Buscar_Tipo_Documento(plngCod_Doc, D) Then
                        
                        lbolOK_Nro_Factura_Original_para_Anular = True
                        
                        If D!signo < 0 Then
                            lstrTipo_Operacion = "Venta"
                            llngNro_Factura_Original_para_Anular = plngNro_Doc
                        Else
                            lstrTipo_Operacion = "Anulacion"
                            If Trim(txtNro_Doc_Afectado.text) = "" Then
                                If Not Pido_Transaccion_Original(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, llngNro_Factura_Original_para_Anular) Then
                                    lbolOK_Nro_Factura_Original_para_Anular = False
                                End If
                            Else
                                If IsNumeric(txtNro_Doc_Afectado.text) Then
                                    llngNro_Factura_Original_para_Anular = val(txtNro_Doc_Afectado.text)
                                Else
                                    lbolOK_Nro_Factura_Original_para_Anular = False
                                End If
                            End If
                        End If
                    
                        If lbolOK_Nro_Factura_Original_para_Anular Then
                        
                            ' AIR 20250505
                            'llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_Caja * ConfMultiplo_caja) + plngNro_Doc ' SS 20190214
                            llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_SubCaja * ConfMultiplo_caja) + plngNro_Doc
                        
                        
                            gbolProceso_Tarjeta = True     ' Prende FLAG   SS 20181224
                            cmdGuardar.Enabled = False              ' Se inhabilita boton   SS 20181218

                            Call Cargo_Logtrans("ANTES de Realizar Consulta TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                            
                            If gclsTransAct.Realizar_Consulta(plngNro_Doc, lstrTipo_Operacion, lrstMedios_Pago!transact_id_tarjeta, lrstMedios_Pago!transact_cuotas, "Pesos", pdblImporte, llngNro_Factura_Original_para_Anular, pstrRUT, pdblMonto_Total_Factura, pdblMonto_Gravado) Then
                            
                                Call Cargo_Logtrans("DESPUES de Realizar Consulta TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov)   ' SS 20190214
                            
                                Screen.MousePointer = vbHourglass   ' SS 20181218
                            
                                Sleep 6000      ' SS 20190219
                                
                                Call Cargo_Logtrans("ANTES de Realizar Confirmacion TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                                
                                If gclsTransAct.Confirmar_Transaccion(plngNro_Doc, lstrRespuesta) Then
                                
                                    Call Cargo_Logtrans("DESPUES de Realizar Confirmacion TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                                    
                                    lstrReferencia = Trim(gISOTransAct.NroTarjeta)
                                    lstrTarjeta_Cliente = gstrTarjeta
                                    
                                    If IsNumeric(gISOTransAct.IdTarjeta) Then
                                        llngTipo_Tarjeta = CLng(gISOTransAct.IdTarjeta)
                                    Else
                                        llngTipo_Tarjeta = 0
                                    End If
                                    
                                    If IsNumeric(gISOTransAct.cuotas) Then
                                        llngCuotas = CLng(gISOTransAct.cuotas)
                                    Else
                                        llngCuotas = 0
                                    End If
                                    
                                    lclsLinea_Baucher_Tarjeta.medio_pago = plngCod_Medio_Pago
                                    lclsLinea_Baucher_Tarjeta.Importe = pdblImporte
                                    lclsLinea_Baucher_Tarjeta.moneda = 1
                                    lclsLinea_Baucher_Tarjeta.nro_rollo = 1
                                    
                                    If gISOTransAct.AutorizacionManual Then
                                        lclsLinea_Baucher_Tarjeta.tipo_autorizacion = "Transaccion OFF LINE"
                                    Else
                                        lclsLinea_Baucher_Tarjeta.tipo_autorizacion = "Transaccion ON LINE"
                                    End If
                                    
                                    If gISOTransAct.LecturaManual Then
                                        lclsLinea_Baucher_Tarjeta.tipo_lectura = "Manual"
                                    Else
                                        lclsLinea_Baucher_Tarjeta.tipo_lectura = "Banda"
                                    End If
                                    
                                    lclsLinea_Baucher_Tarjeta.descripcion_tarjeta = Trim(gISOTransAct.Tarjeta)
                                    lclsLinea_Baucher_Tarjeta.nro_tarjeta = Trim(gISOTransAct.NroTarjeta)
                                    lclsLinea_Baucher_Tarjeta.titular = Trim(gISOTransAct.titular)
                                    lclsLinea_Baucher_Tarjeta.fec_vencimiento = Trim(gISOTransAct.Vencimiento)
                                                                    
                                    If IsNumeric(gISOTransAct.Plan) Then
                                        lclsLinea_Baucher_Tarjeta.nro_plan = CLng(gISOTransAct.Plan)
                                    Else
                                        lclsLinea_Baucher_Tarjeta.nro_plan = 0
                                    End If
                                    
                                    If IsNumeric(gISOTransAct.cuotas) Then
                                        lclsLinea_Baucher_Tarjeta.cuotas = CLng(gISOTransAct.cuotas)
                                    Else
                                        lclsLinea_Baucher_Tarjeta.cuotas = 0
                                    End If
                                    
                                    lclsLinea_Baucher_Tarjeta.autorizacion = Trim(gISOTransAct.autorizacion)
                                    gstrUltimo_Nro_Autorizacion_Tarjeta = Trim(lclsLinea_Baucher_Tarjeta.autorizacion)
                                                                    
                                    If IsNumeric(gISOTransAct.Operacion) Then
                                        lclsLinea_Baucher_Tarjeta.tipo_operacion = CLng(gISOTransAct.Operacion)
                                    Else
                                        lclsLinea_Baucher_Tarjeta.tipo_operacion = 0
                                    End If
                                    
                                    If IsNumeric(gISOTransAct.lote) Then
                                        lclsLinea_Baucher_Tarjeta.lote = CLng(gISOTransAct.lote)
                                    Else
                                        lclsLinea_Baucher_Tarjeta.lote = 0
                                    End If
                                    
                                    If IsNumeric(gISOTransAct.Ticket) Then
                                        lclsLinea_Baucher_Tarjeta.nro_ticket = CLng(gISOTransAct.Ticket)
                                    Else
                                        lclsLinea_Baucher_Tarjeta.nro_ticket = 0
                                    End If
                                    
                                    lclsLinea_Baucher_Tarjeta.id_comercio = Trim(gISOTransAct.CodComercio)
                                    lclsLinea_Baucher_Tarjeta.id_terminal = Trim(gISOTransAct.IDTerminal)
                                    
                                    lclsLinea_Baucher_Tarjeta.nro_ticket_original = plngNro_Doc
                                        
                                    lclsLinea_Baucher_Tarjeta.MontoImp = 0
                                    lclsLinea_Baucher_Tarjeta.DevIVATexto = ""
                                    lclsLinea_Baucher_Tarjeta.MontoImpTexto = ""
                                    lclsLinea_Baucher_Tarjeta.ModoLecturaTexto = ""
                                    lclsLinea_Baucher_Tarjeta.TipoCuenta = ""
                                        
                                    If ConfTRANSACT_Version >= 1 Then
                                        If IsNumeric(gISOTransAct.MontoImp) Then
                                            lclsLinea_Baucher_Tarjeta.MontoImp = gISOTransAct.MontoImp
                                        Else
                                            lclsLinea_Baucher_Tarjeta.MontoImp = 0
                                        End If
                                        
                                        If Not IsNull(gISOTransAct.DevIVATexto) Then
                                            lclsLinea_Baucher_Tarjeta.DevIVATexto = gISOTransAct.DevIVATexto
                                        Else
                                            lclsLinea_Baucher_Tarjeta.DevIVATexto = ""
                                        End If
                                    End If
                                    
                                    If ConfTRANSACT_Version >= 2 Then
                                        If Not IsNull(gISOTransAct.MontoImpTexto) Then
                                            lclsLinea_Baucher_Tarjeta.MontoImpTexto = gISOTransAct.MontoImpTexto
                                        Else
                                            lclsLinea_Baucher_Tarjeta.MontoImpTexto = ""
                                        End If
                                    
                                        If Not IsNull(gISOTransAct.ModoLecturaTexto) Then
                                            lclsLinea_Baucher_Tarjeta.ModoLecturaTexto = gISOTransAct.ModoLecturaTexto
                                        Else
                                            lclsLinea_Baucher_Tarjeta.ModoLecturaTexto = ""
                                        End If
                                    
                                        If Not IsNull(gISOTransAct.TipoCuenta) Then
                                            lclsLinea_Baucher_Tarjeta.TipoCuenta = gISOTransAct.TipoCuenta
                                        Else
                                            lclsLinea_Baucher_Tarjeta.TipoCuenta = ""
                                        End If
                                    End If
                                        
                                    If ConfTRANSACT_Version >= 3 Then
                                        If Not IsNull(gISOTransAct.NumeroCuenta) Then
                                            lclsLinea_Baucher_Tarjeta.NumeroCuenta = gISOTransAct.NumeroCuenta
                                        Else
                                            lclsLinea_Baucher_Tarjeta.NumeroCuenta = ""
                                        End If
                                        
                                        If Not IsNull(gISOTransAct.EMVApNombre) Then
                                            lclsLinea_Baucher_Tarjeta.EMVApNombre = gISOTransAct.EMVApNombre
                                        Else
                                            lclsLinea_Baucher_Tarjeta.EMVApNombre = ""
                                        End If
                                        
                                        If Not IsNull(gISOTransAct.TextoAdicional) Then
                                            lclsLinea_Baucher_Tarjeta.TextoAdicional = gISOTransAct.TextoAdicional
                                        Else
                                            lclsLinea_Baucher_Tarjeta.TextoAdicional = ""
                                        End If
                                        
                                        If Not IsNull(gISOTransAct.ImpTitular) Then
                                            lclsLinea_Baucher_Tarjeta.ImpTitular = gISOTransAct.ImpTitular
                                        Else
                                            lclsLinea_Baucher_Tarjeta.ImpTitular = True
                                        End If
                                        
                                    End If
                                    
                                    If Not Guardar_Datos_Tarjeta_Credito_Confirmada_Transact(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, lclsLinea_Baucher_Tarjeta) Then
                                        Call Cargo_Logtrans("ERROR al grabar en Faccmp_Baucher_TCredito " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                                        MsgBox "No se pudo Guardar los Datos de la Tarjeta Confirmada", vbCritical, MsgTit
                                        TARJETA_ON_LINE = False
                                        gbolProceso_Tarjeta = False    ' SS 20181224
                                        Screen.MousePointer = vbDefault         ' SS 20181218
                                        cmdGuardar.Enabled = True               ' SS 20181218
                                        Exit Function
                                    End If
                                Else
                                    Call Cargo_Logtrans("ERROR al Confirmar TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                                    MsgBox "No se pudo Confirmar la Transacción la Tarjeta. La Respuesta del Emisor es --> " & Trim(lstrRespuesta), vbCritical, MsgTit
                                    TARJETA_ON_LINE = False
                                    gbolProceso_Tarjeta = False    ' SS 20181224
                                    Screen.MousePointer = vbDefault         ' SS 20181218
                                    cmdGuardar.Enabled = True               ' SS 20181218
                                    Exit Function
                                End If
                                
                                Screen.MousePointer = vbDefault             ' SS 20181218
                            Else
                                Call Cargo_Logtrans("ERROR al Consultar TRANSACT " & plngCod_Doc & "-" & llngNro_Doc_Provisorio & "-" & plngCod_Prov) ' SS 20190214
                                MsgBox "No se pudo Realizar la Consulta a Emisor de la Tarjeta", vbCritical, MsgTit
                                TARJETA_ON_LINE = False
                                gbolProceso_Tarjeta = False        ' SS 20181224
                                cmdGuardar.Enabled = True                   ' SS 20181218
                                Exit Function
                            End If
                            
                            cmdGuardar.Enabled = True                       ' SS 20181218
                            
                        Else
                            MsgBox "No se pudo Realizar la Consulta a Emisor de la Tarjeta", vbCritical, MsgTit
                            TARJETA_ON_LINE = False
                            Exit Function
                        End If
                    Else
                        MsgBox "ERROR al Buscar el Tipo de Documento en la Base", vbCritical, MsgTit
                        TARJETA_ON_LINE = False
                        Exit Function
                    End If
                Else
                    lstrTarjeta_Cliente = gstrTarjeta
                    lstrAutorizacion_Tarjeta = "0"
                    llngTipo_Tarjeta = 0
                    llngCuotas = 0
        
                    MsgBox "ERROR: Falta Configuracion en el Medio de Pago en Chequea Tarjeta. Verifique...", vbCritical + vbOKOnly
                    TARJETA_ON_LINE = False     'SS 20181218
                End If
            Else
                lstrTarjeta_Cliente = gstrTarjeta
                lstrAutorizacion_Tarjeta = "0"
                llngTipo_Tarjeta = 0
                llngCuotas = 0
        
                MsgBox "ERROR: Falta Configuracion en el Medio de Pago en Chequea Tarjeta. Verifique...", vbCritical + vbOKOnly
                TARJETA_ON_LINE = False         'SS 20181218
            End If
        Else
            lstrTarjeta_Cliente = gstrTarjeta
            lstrAutorizacion_Tarjeta = "0"
            llngTipo_Tarjeta = 0
            llngCuotas = 0
        
            MsgBox "ERROR: No Existe el Medio de Pago. Verifique...", vbCritical + vbOKOnly
            TARJETA_ON_LINE = False
        
        End If
    End If
    
        
    If ConfTRANSACT_Habilitado = "N" Then
        lstrTarjeta_Cliente = gstrTarjeta
        lstrAutorizacion_Tarjeta = "0"
        llngTipo_Tarjeta = 0
        llngCuotas = 0
    
        MsgBox "LA CAJA NO ESTA HABILITADA PARA TRABAJAR CON TRANSACCIONES DE TARJETAS AUTOMÁTICAS", vbCritical + vbOKOnly
        TARJETA_ON_LINE = False
    End If

End Function





Function Pido_Transaccion_Original(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, ByRef plngNro_Factura_Original As Long) As Boolean
Dim lstrSQL As String
Dim lrstBaucher As Recordset

On Error Resume Next

    plngNro_Factura_Original = InputBox("Ingrese el Número de Factura Original: ", "Validar Transacción Original", 0)

    If Not IsNumeric(plngNro_Factura_Original) Then
        Pido_Transaccion_Original = False
    Else
        If plngNro_Factura_Original <= 0 Then
            Pido_Transaccion_Original = False
        Else
            ' Busco el Documento con ese Nro y paso el Nro. que Originalmente tenia el sistema antes de dar el GUARDAR y que se le envio
            ' a TRANSACT
            
            lstrSQL = "SELECT MAX(nro_doc_original) as nro_doc_original FROM Faccmp_Baucher_TCredito"
            lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
            lstrSQL = lstrSQL & " AND nro_doc = " & plngNro_Factura_Original
            lstrSQL = lstrSQL & " AND cod_prov = " & plngCod_Prov
            
            Set lrstBaucher = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            
            If lrstBaucher.EOF Then
                Pido_Transaccion_Original = False
            Else
                plngNro_Factura_Original = lrstBaucher!nro_doc_original
                Pido_Transaccion_Original = True
            End If
        End If
    End If
    
End Function
Public Sub Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar As Boolean, pstrPrioridad_Precio_Con_Impuestos As String, pbolEsResguardo As Boolean)
Dim lValorIva As Double
Dim lImp_Cofis As Double
Dim lImp_Iva As Double
Dim lPrecioUnitConDto As Double
Dim lPrecioUnitConDto_ImpIva As Double
Dim lPrecioUnitConDto_ImpCofis As Double
Dim lPrecioUnitSinIVa As Double
Dim lImporteSinIVA As Double
Dim lImporte As Double
Dim e As Recordset
Dim lbolPrioridad_Precio_Con_Impuestos As Boolean

    Select Case Trim(UCase(pstrPrioridad_Precio_Con_Impuestos))
    
        Case "S"
            lbolPrioridad_Precio_Con_Impuestos = True
            
        Case "N"
            lbolPrioridad_Precio_Con_Impuestos = False
            
        Case Else
            lbolPrioridad_Precio_Con_Impuestos = True
            
    End Select

    lImp_Cofis = 0
    lImp_Iva = 0
    lPrecioUnitConDto = 0
    lPrecioUnitSinIVa = 0
    lImporteSinIVA = 0
    lImporte = 0
    
    If Trim(dbgLineas_Servicios.Columns("unidades").text) <> "" And dbgLineas_Servicios.Columns("eliminada").Value = False Then
    
        If dbgLineas_Servicios.Columns("iva").text = "" Then
            dbgLineas_Servicios.Columns("iva").text = 0
        End If
        If dbgLineas_Servicios.Columns("cofis").text = "" Then
            dbgLineas_Servicios.Columns("cofis").text = 0
        End If
    
        ' AIR 13/01/2015 pongo la condicion de Hertz para que siempre calcule para ellos desde el precio unitario con iva incluido los montos.
        '  esta dando problemas cuando luego se calcula por el els a la inversa el iva desde el monto sin iva. Ej al ingresar precio con iva incl. 200 USD
        ' AIR 20170908 Se agrega a VEICUER en esta condicion da problema similar a Hertz con el calculo hacia atras
        
'        If (Trim(dbgLineas_Servicios.Columns("precio").text) <> "" And Trim(dbgLineas_Servicios.Columns("precio_siva").text) = "0") Or (ConfFormato_Factura = "HERTZ" And Trim(dbgLineas_Servicios.Columns("precio").text) <> "") Or (ConfFormato_Factura = "VEICUER" And Trim(dbgLineas_Servicios.Columns("precio").text) <> "") Then
'
'            lPrecioUnitConDto = CDbl(dbgLineas_Servicios.Columns("precio").text)
'
'            lPrecioUnitConDto_ImpIva = CDbl(dbgLineas_Servicios.Columns("precio").text) - (CDbl(dbgLineas_Servicios.Columns("precio").text) / (1 + (CDbl(dbgLineas_Servicios.Columns("iva").text) / 100)))
'            lPrecioUnitConDto_ImpIva = Format(lPrecioUnitConDto_ImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas)
'
'            lPrecioUnitConDto_ImpCofis = (CDbl(dbgLineas_Servicios.Columns("precio").text) - lPrecioUnitConDto_ImpIva) - ((CDbl(dbgLineas_Servicios.Columns("precio").text) - lPrecioUnitConDto_ImpIva) / (1 + (CDbl(dbgLineas_Servicios.Columns("cofis").text) / 100)))
'            lPrecioUnitConDto_ImpCofis = Format(lPrecioUnitConDto_ImpCofis, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas)
'
'
'            ' Le saco los descuentos
'            If Trim(txtDtoGlobal.text) <> "" Then
'                If IsNumeric(txtDtoGlobal.text) Then
'                    lPrecioUnitConDto = lPrecioUnitConDto * (1 - (txtDtoGlobal.text) / 100)
'                End If
'            End If
'
'            lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas)
'
'            lImporte = lPrecioUnitConDto * CDbl(dbgLineas_Servicios.Columns("unidades").text)
'            lImporte = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'            If CDbl(NullToZero(dbgLineas_Servicios.Columns("tasa_resguardo").text)) <> 0 Then
'                lImporte = lImporte * CDbl(dbgLineas_Servicios.Columns("tasa_resguardo").text) / 100
'            End If
'
'            lImporte = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'            lImp_Iva = lImporte - (lImporte / (1 + (CDbl(dbgLineas_Servicios.Columns("iva").text) / 100)))
'            lImp_Iva = Format(lImp_Iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'            lImp_Cofis = (lImporte - lImp_Iva) - ((lImporte - lImp_Iva) / (1 + (CDbl(dbgLineas_Servicios.Columns("cofis").text) / 100)))
'            lImp_Cofis = Format(lImp_Cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'            lImporteSinIVA = lImporte - lImp_Iva - lImp_Cofis
'            lImporteSinIVA = Format(lImporteSinIVA, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'            dbgLineas_Servicios.Columns("precio_siva").text = Format(CDbl(dbgLineas_Servicios.Columns("precio").text) - lPrecioUnitConDto_ImpIva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas)
'
'        Else
        
        If lbolPrioridad_Precio_Con_Impuestos Then
            ' JE 20080710   /   Se da prioridad al calculo a partir del Precio CON Impuestos
                    
            If dbgLineas_Servicios.Columns("precio").text = "" Then
                dbgLineas_Servicios.Columns("precio").text = 0
            End If
            lPrecioUnitConDto = CDbl(dbgLineas_Servicios.Columns("precio").text)
            lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            If val((dbgLineas_Servicios.Columns("iva").text)) <> 0 Then
                lPrecioUnitSinIVa = lPrecioUnitConDto / (1 + (CDbl(dbgLineas_Servicios.Columns("iva").text) / 100))
            Else
                lPrecioUnitSinIVa = lPrecioUnitConDto    'AIR 20180815 se agrega porque el precio sin iva es igual al precio neto
                
                lPrecioUnitConDto_ImpIva = 0
            End If
            lPrecioUnitSinIVa = Format(lPrecioUnitSinIVa, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            lPrecioUnitConDto_ImpCofis = 0
            lPrecioUnitConDto_ImpCofis = Format(lPrecioUnitConDto_ImpCofis, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
            lPrecioUnitConDto_ImpIva = lPrecioUnitConDto - lPrecioUnitSinIVa - lPrecioUnitConDto_ImpCofis
            lPrecioUnitConDto_ImpIva = Format(lPrecioUnitConDto_ImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
        Else
            ' JE 20080710   /   Se da prioridad al calculo a partir del Precio SIN Impuestos
            
            If dbgLineas_Servicios.Columns("precio_siva").text = "" Then
                dbgLineas_Servicios.Columns("precio_siva").text = 0
            End If
            lPrecioUnitSinIVa = CDbl(dbgLineas_Servicios.Columns("precio_siva").text)
            lPrecioUnitSinIVa = Format(lPrecioUnitSinIVa, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            lPrecioUnitConDto_ImpIva = lPrecioUnitSinIVa * ((CDbl(dbgLineas_Servicios.Columns("iva").text) / 100))
            lPrecioUnitConDto_ImpIva = Format(lPrecioUnitConDto_ImpIva, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            lPrecioUnitConDto_ImpCofis = 0
            lPrecioUnitConDto_ImpCofis = Format(lPrecioUnitConDto_ImpCofis, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            lPrecioUnitConDto = lPrecioUnitSinIVa + lPrecioUnitConDto_ImpIva + lPrecioUnitConDto_ImpCofis
            lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        End If
        
        dbgLineas_Servicios.Columns("precio_siva").text = Format(lPrecioUnitSinIVa, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        dbgLineas_Servicios.Columns("precio").text = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        ' Le saco los descuentos
        If Trim(txtDtoGlobal.text) <> "" Then
            If IsNumeric(txtDtoGlobal.text) Then
                lPrecioUnitConDto = lPrecioUnitConDto * (1 - (txtDtoGlobal.text) / 100)
            End If
        End If
        
        lPrecioUnitConDto = Format(lPrecioUnitConDto, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        If Not pbolEsResguardo Then     'Calculo para NO resguardo   SS 20181030
            lImporte = lPrecioUnitConDto * CDbl(dbgLineas_Servicios.Columns("unidades").text)
        End If
        
        If CDbl(NullToZero(dbgLineas_Servicios.Columns("tasa_resguardo").text)) <> 0 Then   'Calculo para resguardo, la tasa es <> 0
            lImporte = lPrecioUnitConDto * CDbl(dbgLineas_Servicios.Columns("unidades").text)
            lImporte = lImporte * CDbl(dbgLineas_Servicios.Columns("tasa_resguardo").text) / 100
        End If

        lImporte = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))

        lImp_Iva = lImporte - (lImporte / (1 + (CDbl(dbgLineas_Servicios.Columns("iva").text) / 100)))
        lImporte = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
        
        
        lImp_Cofis = (lImporte - lImp_Iva) - ((lImporte - lImp_Iva) / (1 + (CDbl(dbgLineas_Servicios.Columns("cofis").text) / 100)))
        lImp_Cofis = Format(lImp_Cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
        lImporteSinIVA = lImporte - lImp_Iva - lImp_Cofis
        lImporteSinIVA = Format(lImporteSinIVA, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
'        End If
        
    End If
    
    dbgLineas_Servicios.Columns("importe").text = Format(lImporte, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    dbgLineas_Servicios.Columns("importe_sin_iva").text = Format(lImporteSinIVA, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    dbgLineas_Servicios.Columns("importe_cofis").text = Format(lImp_Cofis, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    dbgLineas_Servicios.Columns("importe_iva").text = Format(lImp_Iva, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
    
    Call Calculo_Total_Lineas_Servicios(dbgLineas_Servicios, pbolHabilitar_Boton_Guardar)
    
End Sub


Public Sub Cargar_Lineas_Servicios(lcod_emp As Long, lCod_Doc As Long, lNro_Doc As Long, pbolHabilitar_Boton_Guardar As Boolean)

Dim lstrCliente_Aplica_IVA As String

Dim lstrSQL As String
Dim CLI As Recordset
Dim SUC As Recordset



    lstrCliente_Aplica_IVA = "S"

    If Buscar_Cliente(txtCodProv.text, CLI) Then
        lstrCliente_Aplica_IVA = Trim(UCase(CLI!aplica_IVA_Ventas))
    End If

    If val(TxtCodSuc.text) > 0 Then
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc), SUC) Then
            lstrCliente_Aplica_IVA = Trim(UCase(SUC!aplica_IVA_Ventas))
        End If
    End If
    
    lstrSQL = "SELECT * FROM FaccmpServicios "
    lstrSQL = lstrSQL & " WHERE cod_emp = " & lcod_emp
    lstrSQL = lstrSQL & " AND cod_doc = " & lCod_Doc
    lstrSQL = lstrSQL & " AND nro_doc = " & lNro_Doc
    lstrSQL = lstrSQL & " ORDER BY nro_linea ASC"
    
    Set rstlineas_documentos = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    dbgLineas_Servicios.removeAll
    dbgLineas_Servicios.MoveFirst
    
    Do While Not rstlineas_documentos.EOF
        
        dbgLineas_Servicios.Columns("unidades").text = rstlineas_documentos!unidades
        dbgLineas_Servicios.Columns("precio_siva").text = "0"
        dbgLineas_Servicios.Columns("codigo").text = rstlineas_documentos!codigo
        dbgLineas_Servicios.Columns("descripcion").text = rstlineas_documentos!Descripcion
        dbgLineas_Servicios.Columns("seccion").text = rstlineas_documentos!seccion
        If Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
            dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
        End If
        
        If Trim(UCase(lstrCliente_Aplica_IVA)) = "S" Then
          
            dbgLineas_Servicios.Columns("tcofis").text = rstlineas_documentos!tcofis
            dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
            
            dbgLineas_Servicios.Columns("tiva").text = rstlineas_documentos!tiva
            dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
            
            dbgLineas_Servicios.Columns("tcofis_iva").text = rstlineas_documentos!tiva
            If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
                dbgLineas_Servicios.Columns("cofis_iva").text = 0
            Else
                dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
            End If

        Else
            dbgLineas_Servicios.Columns("tcofis").text = 1
            dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
        
            dbgLineas_Servicios.Columns("tiva").text = 1
            dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
        
            dbgLineas_Servicios.Columns("tcofis_iva").text = 1
            If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
                dbgLineas_Servicios.Columns("cofis_iva").text = 0
            Else
                dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
            End If
        End If
        
        dbgLineas_Servicios.Columns("precio").text = Format(rstlineas_documentos!Precio, "0.00")
        
        dbgLineas_Servicios.Columns("tasa_resguardo").text = Format(rstlineas_documentos!tasa_resguardo, "0.00")
        
        dbgLineas_Servicios.Columns("eliminada").Value = False
        

        If rstlineas_documentos!tasa_resguardo <> 0 Then    'N al ser resguardo es un importe sin impuestos SS 20180813
            dbgLineas_Servicios.Columns("precio_siva").text = Format(rstlineas_documentos!Precio, "0.00")
            Call Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar, "N", True)
        Else
            Call Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar, "", False)
        End If
        
        rstlineas_documentos.MoveNext
        dbgLineas_Servicios.MoveNext
    Loop
    dbgLineas_Servicios.MoveFirst
    rstlineas_documentos.Close
       
End Sub

Public Sub Cargar_Lineas_Servicios_Desde_Un_Contrato(plngEmpresa As Long, plngContrato As Long, pbolHabilitar_Boton_Guardar As Boolean)
Dim R As Recordset
Dim C As Recordset
Dim S As Recordset
Dim PV As Recordset
Dim SQL As String

    If Not Busco_Contrato_Servicio(plngEmpresa, plngContrato, C) Then
        MsgBox "ERROR: Contrato " & plncContrato & " NO Existente en el Sistema. Verifique por favor...", vbCritical
        Exit Sub
    End If

    SQL = "SELECT * FROM ma_Servicios_x_Contrato"
    SQL = SQL & " WHERE ma_Servicios_x_Contrato.contrato = " & plngContrato
    SQL = SQL & " ORDER BY ma_Servicios_x_Contrato.servicio"
    
    Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    dbgLineas_Servicios.removeAll
    dbgLineas_Servicios.MoveFirst
    
    Do While Not R.EOF
        
        dbgLineas_Servicios.Columns("unidades").text = R!unidades
        dbgLineas_Servicios.Columns("codigo").text = R!Servicio
        
        If Busco_Insumo_Servicio(R!Servicio, S) Then
            dbgLineas_Servicios.Columns("descripcion").text = S!Descripcion
        End If
        
        dbgLineas_Servicios.Columns("seccion").text = 0
        If Busco_Seccion(dbgLineas_Servicios.Columns("seccion").text) Then
            dbgLineas_Servicios.Columns("desc_seccion").text = Trim(rstSecciones!Descripcion)
        End If
        
        dbgLineas_Servicios.Columns("tcofis").text = 0
        dbgLineas_Servicios.Columns("cofis").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
        
        dbgLineas_Servicios.Columns("tiva").text = S!cod_iva
        dbgLineas_Servicios.Columns("iva").text = Format(Porcentaje_Impuesto_Vigente("IVA", dbgLineas_Servicios.Columns("tiva").text, CDate(txtFec_Doc.text)), "#0.00")
        
        dbgLineas_Servicios.Columns("tcofis_iva").text = S!cod_iva
        If val(dbgLineas_Servicios.Columns("tcofis").text) = 0 Then
            dbgLineas_Servicios.Columns("cofis_iva").text = 0
        Else
            dbgLineas_Servicios.Columns("cofis_iva").text = Format(Porcentaje_Impuesto_Vigente("COFIS", dbgLineas_Servicios.Columns("tcofis").text, CDate(txtFec_Doc.text)), "#0.00")
        End If
        
        If Busco_Precio_Lista_Servicios(S!codigo, Format(txtFec_Doc.text, "dd/mm/yyyy"), val(txtLista.text), PV) Then
            dbgLineas_Servicios.Columns("precio_siva").text = "0"
            dbgLineas_Servicios.Columns("precio").text = Format(PV!Precio, "0.00")
        Else
            dbgLineas_Servicios.Columns("precio_siva").text = Format(0, "0.00")
            dbgLineas_Servicios.Columns("precio").text = Format(0, "0.00")
        End If
        
        Call Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar, "", False)
    
        R.MoveNext
        dbgLineas_Servicios.MoveNext
    Loop
    R.Close
       
    If dbgLineas_Servicios.visible Then
        dbgLineas_Servicios.Enabled = True
        dbgLineas_Servicios.SetFocus
        dbgLineas_Servicios.Col = 0
    End If
       
End Sub

Sub Actualizo_Precios_de_Articulos_de_la_Grilla()
Dim e As Recordset
Dim PV As Recordset
Dim P As Recordset
Dim CLI As Recordset
Dim SUC As Recordset
Dim lrstDocum As Recordset

Dim i As Long
Dim ldblPrecio As Double
Dim ldblPrecioMGM As Double
Dim lCantidad As Double
Dim llngCod_Prod As Long
Dim ldblTipo_Cambio As Double
Dim lstrCliente_Aplica_IVA As String
Dim lstrDoc_Aplica_IVA As String
Dim eq As Recordset
Dim pstrMN_ME As String
Dim pdblTCambio As Double

    lCantidad = 0
        
    If pstrTipo_Ingreso_Documentos = "S" Then       'Se agrega que solo sea para Mercaderia     SS 20200219
        Exit Sub
    End If
    
    If Trim(UCase(sspOperacion.Caption)) <> "A" And Trim(UCase(sspOperacion.Caption)) <> "M" Then   'Se agrega recalculo precio en operacion = M    SS 20181128
        Exit Sub
    End If
    
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Exit Sub
    End If
    
    ' AIR 20210719 se pasa a contemplar en la Venta si el documento aplica IVA o no para el caso de zona franca
    lstrDoc_Aplica_IVA = "S"
    If Buscar_Tipo_Documento(val(txtCodDoc.text), lrstDocum) Then
        If lrstDocum!aplica_iva = "N" Then
            lstrDoc_Aplica_IVA = "N"
        End If
    End If
                 
    If pbolCargo_Desde_Movil Then       ' Si viene del movil, no le cambia el precio luego de cargar la grilla  SS 20170704
        Exit Sub
    End If
        
    lstrCliente_Aplica_IVA = "S"

    If Not Buscar_Cliente(val(txtCodProv.text), CLI) Then
        MsgBox "ERROR: Cliente " & txtCodProv.text & " No Definido en el Sistema. Verifique por favor...", vbCritical
        Exit Sub
    Else
        lstrCliente_Aplica_IVA = Trim(UCase(CLI!aplica_IVA_Ventas))
    End If
    
    If val(TxtCodSuc.text) > 0 Then
        If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc), SUC) Then
            lstrCliente_Aplica_IVA = Trim(UCase(SUC!aplica_IVA_Ventas))
        End If
    End If
    
'    Screen.MousePointer = vbHourglass
'    Call f_esperar(8)           ' SS 20190917

    If val(txtMoneda.text) <> gMoneda_Base Then
        pstrMN_ME = Buscar_Configuracion_Variables_Documento_C(CLng(txtCodDoc.text), "TIPO_COTIZACION_LINEA_ART_MN_ME")
        If Trim(pstrMN_ME) = "" Then
             pstrMN_ME = "P"
        Else
             pbooTipoCotizacion = True
        End If
    Else
        pstrMN_ME = Buscar_Configuracion_Variables_Documento_C(CLng(txtCodDoc.text), "TIPO_COTIZACION_LINEA_ART_ME_MN")
        If Trim(pstrMN_ME) = "" Then
            pstrMN_ME = "P"
        End If
    End If



        
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
        If i < vsfLineas_Mercaderia.Rows Then       'Agrego x si estan borrando lineas mientras se corre este proceso   SS 20190918
            If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
                llngCod_Prod = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                 If Not Buscar_Articulo(llngCod_Prod, P) Then
                    Exit Sub
                End If
                
                ldblPrecio = Busco_Precio_Emision(val(txtEmpresa.text), llngCod_Prod, val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                              
                 ' JE 20240819   /   Ver si el Precio a colocar es Precio Sin IVA - Tipo Precio en el Documento S
                If lrstDocum!tipo_precio = "S" Or lrstDocum!exportacion = "S" Then
                    ldblPrecio = Precio_Venta_SIN_IVA(llngCod_Prod, ldblPrecio)
                End If
                
                ldblPrecioMGM = ldblPrecio
                If confUsaEquivalenciaMagnitudes Then
                    If Buscar_Equivalencia(llngCod_Prod, P!magnitud, val(vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD)), eq) Then
                       'charlocharlo
                       Call CalcularCantidadyPrecioEquivalente(eq!val_equivalencia, lCantidad, ldblPrecioMGM)
                      
                    End If
                End If
                
                
                If ldblPrecio = -1 Then
                    MsgBox "El Documento NO Permite Articulos con Moneda en la Lista de Precio en Diferente Moneda al Facturador", vbInformation + vbOKOnly
                    gblnCancelar = True
                    Exit Sub
                End If
                
               
                
                If (Trim(UCase(P!generico)) = "S" And val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)) <> 0) Then 'Or (Not confPuntoVta_Inicializa_Precio_Grilla_Mercaderia And val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)) <> 0) Then
                    'EL articulo generico se actualiza si cambia de Moneda al tipo de cambio configurado
                    
                    pdblTCambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), CDate(Me.txtFec_Doc.text), pstrMN_ME)
                    
                    
                    If glngAnterior_Moneda <> val(txtMoneda.text) Then
                    
                        ldblPrecio = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO))
                        ldblPrecioMGM = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD))
                        
                        If ConfPuntoVta_Convertir_TCambio = True Then
                            ldblTipo_Cambio = val(txtTipo_Cambio.text)
                            If val(txtMoneda.text) <> gMoneda_Base Then
                                'ATU 20170711, si el precio de venta es en PESOS y la factura en DOLARES, se toma el MANUAL COMPRADOR
                                If ConfFormato_Factura = "VEICUER" Then
                                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), CDate(txtFec_Doc.text), "PP")
                                    ldblPrecio = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), "PP", glngAnterior_Moneda, val(txtMoneda.text), ldblTipo_Cambio, CDate(txtFec_Doc.text), ldblPrecio)
                                    ldblPrecioMGM = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), "PP", glngAnterior_Moneda, val(txtMoneda.text), ldblTipo_Cambio, CDate(txtFec_Doc.text), ldblPrecioMGM)
                                Else
                                    ' JE 20170718   /   Se comenta estas lineas y se utiliza la funcion de Convertir entre Monedas
                                    '               /   esto es porque se puede dar el caso de que se quiera facturar en EU y el precio de Venta este en U$S
                                    ldblPrecio = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), pstrMN_ME, glngAnterior_Moneda, val(txtMoneda.text), pdblTCambio, CDate(txtFec_Doc.text), ldblPrecio)
                                    ldblPrecioMGM = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), pstrMN_ME, glngAnterior_Moneda, val(txtMoneda.text), pdblTCambio, CDate(txtFec_Doc.text), ldblPrecioMGM)
                                End If
                            Else
                                If ConfFormato_Factura = "VEICUER" Then
                                    ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), CDate(txtFec_Doc.text), "PP")
                                    ldblPrecio = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), "PP", glngAnterior_Moneda, val(txtMoneda.text), ldblTipo_Cambio, CDate(txtFec_Doc.text), ldblPrecio)
                                    ldblPrecioMGM = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), "PP", glngAnterior_Moneda, val(txtMoneda.text), ldblTipo_Cambio, CDate(txtFec_Doc.text), ldblPrecioMGM)
                                Else
                                    ldblPrecio = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), pstrMN_ME, glngAnterior_Moneda, val(txtMoneda.text), pdblTCambio, CDate(txtFec_Doc.text), ldblPrecio)
                                    ldblPrecioMGM = Convertir_Importe_Entre_Monedas_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), pstrMN_ME, glngAnterior_Moneda, val(txtMoneda.text), pdblTCambio, CDate(txtFec_Doc.text), ldblPrecioMGM)
                                End If
                            End If
                        End If
                    
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD) = Format(ldblPrecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_ORIGINAL) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        
                        
                    
                    End If
                                        
                Else
                   ' If Trim(UCase(lstrCliente_Aplica_IVA)) = "S" Then   'Se agrega condicion del cliente    SS 20200206
                    If (Trim(UCase(lstrCliente_Aplica_IVA)) = "S" And lstrDoc_Aplica_IVA = "S") Or (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                        'If lstrDoc_Aplica_IVA = "S" Then                'AIR 20210719
                        
                            If txtTipo_Doc_Identidad.text = 2 Then          'Cambio codigo IVA segun condicion de RUT   SS 20190527
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA) = P!cod_iva_ventas_con_rut
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS_IVA) = P!cod_iva_ventas_con_rut
                            Else
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA) = P!cod_iva
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS_IVA) = P!cod_iva
                            End If
                        
                            If Busco_Impuesto("IVA", vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)) Then
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA) = Format(Porcentaje_Impuesto_Vigente("IVA", vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA), date), "#0.00")
                            Else
                                vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA) = Format(0, "#0.00")
                            End If
                        'Else
                         '   vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS) = 1
                         '   vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA) = 1
                         '   vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS_IVA) = 1
                        '    vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS) = Format(0, "#0.00")
                        '    vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA) = Format(0, "#0.00")
                         '   vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS_IVA) = 0
                        'End If
                    Else
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS) = 1
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA) = 1
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS_IVA) = 1
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS) = Format(0, "#0.00")
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA) = Format(0, "#0.00")
                        vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS_IVA) = 0
                    End If
                    
                    ' -------------------------------------------------------------------------------------------------
                    
                    ldblPrecio = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                    ldblPrecioMGM = ldblPrecio
                    'If Trim(UCase(e!imp_inc_facturador)) <> "S" Then
                        If confUsaEquivalenciaMagnitudes Then
                            If Buscar_Equivalencia(llngCod_Prod, P!magnitud, val(vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD)), eq) Then
                            'charlocharlo
                                 Call CalcularCantidadyPrecioEquivalente(eq!val_equivalencia, lCantidad, ldblPrecioMGM)
                      
                            End If
                        End If
                    
                    'End If
                    
                    If pPedidoFactura = True Then
                       vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                       vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecio, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                       vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD) = Format(lprecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                       vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_ORIGINAL) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
          
                    Else
                        If (Trim(UCase(e!imp_inc_facturador)) = "S" And lstrDoc_Aplica_IVA = "S") Or (Not confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecio, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD) = Format(ldblPrecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_ORIGINAL) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
          
                        End If
                        If (Trim(UCase(e!imp_inc_facturador)) = "N" And lstrDoc_Aplica_IVA = "S") Or (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecio, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecio, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecioMGM, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_ORIGINAL) = Format(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                        
                        ' JE 20240819   /   Si el documento No Aplica IVA, coloco el Precio de Venta que tengo y que toma segun configuracion del documento del tipo de importe
                        If lstrDoc_Aplica_IVA = "N" Then
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP) = Format(Importe_Sin_Impuestos_Vigente(ldblPrecio, vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD) = Format(ldblPrecioMGM, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_PRECIO_ORIGINAL) = Format(ldblPrecio, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                        End If
                        
                        If (confPuntoVta_Precio_Sin_Impuestos_Exportacion And lrstDocum!exportacion = "S") Then
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS) = 1
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA) = 1
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_TCOFIS_IVA) = 1
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS) = Format(0, "#0.00")
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA) = Format(0, "#0.00")
                            vsfLineas_Mercaderia.TextMatrix(i, CGL_COFIS_IVA) = 0
                        End If
                    End If
                  
                    
                End If
                If confUsaEquivalenciaMagnitudes Then
                     vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD)), vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                Else
                     vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSINIVA) = Format(Importe_Sin_Impuestos_Vigente(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)), vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                End If
                
                Call Calcular_Importes_de_la_Linea_Mercaderia(i, False, True)
            End If
        End If
    Next
    
'    Unload frmMensaje_Esperar
'    Screen.MousePointer = vbDefault
    
End Sub



Function Controlar_Datos_Ingresados_Antes_de_Guardar(pbolHabilitar_Boton_Guardar As Boolean) As Boolean

On Error GoTo Errores
Dim B As Recordset
Dim C As Recordset
Dim R As Recordset
Dim ch As Recordset
Dim D As Recordset
Dim FP As Recordset
Dim M As Recordset
Dim MP As Recordset
Dim MAX As Recordset
Dim TE As Recordset
Dim lrstProveedores As Recordset
Dim RstMoneda As Recordset
Dim rstDocum As Recordset
Dim lrstDoc_Cuotas As Recordset  ' AIR 20190725
Dim lrstVto As Recordset         ' AIR 20231215

Dim i As Long
Dim j As Long
Dim lbolEncontre As Boolean
Dim llngCuenta As Long
Dim sigo As Integer
Dim ldblImporte_Base As Double
Dim llngTipo_Entrega As Long
Dim auxSumaImporteMP As Double      ' AIR 20190503
Dim auxSumaImporteCheques As Double ' AIR 20190503
Dim lblnEsEfactura  As Boolean      ' AIR 20221003

    lblnEsEfactura = False
    If gGuardando_Documento Then
        MsgBox "Aun Esta Procesando el Documento Anterior", vbExclamation, MsgTit
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If

    Controlar_Datos_Ingresados_Antes_de_Guardar = True
    gGuardando_Documento = True
    DoEvents
    
    If Not Valido_Permiso_de_Usuario_Sobre_el_Documento(val(txtCodDoc.text), gNro_Usuario, sspOperacion.Caption) Then
        MsgBox "EL USUARIO ACTIVO NO TIENE PERMISOS SOBRE EL DOCUMENTO. Verifique por Favor", vbExclamation + vbOKOnly
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
    
    If Not Control_Ingreso_Datos_Formulario(Me) Then
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        txtCodProv.SetFocus
        Exit Function
    End If
    
    If Not Valido_Redondeo Then
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        txtCodProv.SetFocus
        Exit Function
    End If
    
    If ConfPuntoVta_Controla_Fecha_Facturacion Then     'SS 20180906
        If CDate(txtFec_Doc.text) <> date Then
            If MsgBox("ATENCION.... La Fecha del Documento  " & txtFec_Doc.text & Chr(13) & "Difiere de la Fecha del Día  " & date & Chr(13) & "Continua?", vbQuestion + vbYesNo + vbDefaultButton2) = vbNo Then
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                txtCodProv.SetFocus
                Exit Function
            End If
        End If
    End If
    
    If val(txtImporte.text) < 0 Then                    'SS 20181207
        If esEFactura(val(txtCodDoc.text)) Then
            MsgBox "ATENCION.... El Total del Documento es Negativo. " & Chr(13) & "Verifique por Favor", vbExclamation + vbOKOnly
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            txtCodProv.SetFocus
            Exit Function
        Else
            If MsgBox("ATENCION.... El Total del Documento es Negativo. " & Chr(13) & "Continua?", vbQuestion + vbYesNo + vbDefaultButton2) = vbNo Then
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                txtCodProv.SetFocus
                Exit Function
            End If
        End If
    End If
    
    If ConfPuntoVta_Tope_Maximo_Importe_Doc_En_Pesos > 0 Then
    
        ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, txtImporte.text)
    
        If ldblImporte_Base > ConfPuntoVta_Tope_Maximo_Importe_Doc_En_Pesos Then
            If MsgBox("ATENCION.... Esta ingresando una Factura con un Valor Superior al Tope." & Chr(13) & "Continua?", vbQuestion + vbYesNo + vbDefaultButton2) = vbNo Then
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                txtCodProv.SetFocus
                Exit Function
            End If
        End If
    
    End If
    
    'GarciaLopez, al grabar la factura, pregunta si se desea generar en PREVENTA para dejarla en espera y facturarla luego.
    'If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER" Or ConfFormato_Factura = "CENTROSUR") And UCase(Trim(sspOperacion.Caption)) = "A" Then
    
    'AIR 20211215 se pasa la condicion a una variable de configuracion para que pueda ser utilizado por otras empresas.
    'If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER") And UCase(Trim(sspOperacion.Caption)) = "A" Then 'Sacamos CENTROSUR  SS 20181109
    If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER" Or ConfPuntoVta_Permite_Guardar_Como_Preventa) And _
        UCase(Trim(sspOperacion.Caption)) = "A" And val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And Not gPtoVenta_Robot Then
        sigo = MsgBox("Desea Guardar Como PreVenta?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
        If sigo = vbYes Then
            txtCodDoc.text = ConfDoc_Ingreso_PreVenta_Cli
            If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                MsgBox "ERROR al Generar la PreVenta", vbCritical + vbOKOnly
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                Exit Function
            End If
        End If
    End If
    
    ' Chequeo Forma de Pago
    ' Si es una forma de Pago que se cancela automaticamente.. no puede ser un Documento de Credito.
    
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
    
        'AIR 20250307
        If D!signo = 1 And CDbl(txtCambio.text) <> 0 Then
            MsgBox "ATENCION.... Las devoluciones no permite cambio. Verifique...", vbCritical, MsgTit
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            vsfMedios_Pagos.SetFocus
            Exit Function
        
        End If
    
        If Trim(UCase(D!clase)) = "CONTADO" Then
            If Buscar_Forma_Pago(val(txtForma_Pago.text), FP) Then
                If Trim(UCase(FP!cancela_documento)) = "N" Then
                    MsgBox "ATENCION.... Esta ingresando una Forma de Pago para Crédito en un Documento Contado", vbCritical + vbOKOnly
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
        End If
        If Trim(UCase(D!clase)) = "CREDITO" Or Trim(UCase(D!clase)) = "CONTADO PENDIENTE" Then
            If Buscar_Forma_Pago(val(txtForma_Pago.text), FP) Then
                If Trim(UCase(FP!cancela_documento)) = "S" Then
                    MsgBox "ATENCION.... Esta ingresando una Forma de Pago para Contado en un Documento Contado Pendiente o Crédito", vbCritical + vbOKOnly
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
        End If
        'ATU 20180626 - Si se activa la variable, el sistema pide observacion obligatoria al momento de facturar, solo para CREDITOS.
        If ConfPuntoVta_Pide_Observacion = True And Trim(UCase(D!clase)) = "CREDITO" Then
            If Trim(txtObs.text) = "" Then
                MsgBox "ATENCION.... Debe Ingresar Observacion para Creditos.", vbCritical, MsgTit
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    txtObs.SetFocus
                    Exit Function
            End If
        
        End If
    Else
        MsgBox "Documento No Existe en el Sistema. Verifique", vbCritical, MsgTit
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
            
    If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then      ' resguardos        SS 20160408
        If Buscar_Proveedor(txtCodProv.text, lrstProveedores) Then
            If Trim(UCase(lrstProveedores!Activo)) = "N" Then
                MsgBox "El Proveedor Esta Inactivo", vbInformation, MsgTit
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                gGuardando_Documento = False
                Exit Function
            End If
        Else
            MsgBox "Proveedor Inexistente", vbInformation, MsgTit
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            gGuardando_Documento = False
            Exit Function
        End If
    Else
        If Buscar_Cliente(txtCodProv.text, C) = True Then
            'Vemos si el cliente esta activo
            
            ' Chequeo si el Documento Acepta Clientes Genericos
            If Trim(UCase(C!generico)) = "S" Then
                If Trim(UCase(D!permite_titular_generico)) = "N" Then
                    MsgBox "El Documento No Acepta Clientes Genericos", vbInformation, MsgTit
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
            
            'AIR 20250428
            If Trim(UCase(C!ruc_cli)) <> "" And Trim(TxtRuc.text) = "" Then
                If MsgBox("ATENCION.... El cliente tiene RUT registrado." & Chr(13) & "¿Continua la Factura sin RUT?  " & "?", vbQuestion + vbYesNo + vbDefaultButton2) = vbNo Then
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    gGuardando_Documento = False
                    Exit Function
                End If
            End If
            
            If Trim(UCase(C!Activo)) = "N" Then
                MsgBox "El Cliente Esta Inactivo", vbInformation, MsgTit
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                gGuardando_Documento = False
                Exit Function
            End If
            
            If (Trim(UCase(C!estado_credito)) <> "H" And Trim(UCase(D!tipo_estado_cta)) = "C" And Trim(UCase(D!clase)) <> "CONTADO" And Trim(UCase(D!clase)) <> "CONTADO PENDIENTE") Or (Trim(UCase(C!estado_credito)) <> "H" And Trim(UCase(D!clase)) = "PEDIDO") Then
                If Trim(UCase(D!controlar_saldo_cliente_facturador)) = "S" Or Trim(UCase(D!controlar_saldo_cliente_facturador)) = "G" Then
                    gbolESC = True
                    MsgBox "Crédito Inhabilitado. Solo Puede Comprar Contado", vbInformation, MsgTit
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    gGuardando_Documento = False
                    Exit Function
                Else
                    'gbolESC = True                                     Si el documento no controla saldo cliente, no debe dar error    SS 20171108
                    'MsgBox "Crédito Inhabilitado. Solo Puede Comprar Contado", vbInformation, MsgTit
                    'Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    'gGuardando_Documento = False
                    'Exit Function
                End If
            End If
            
        Else
            MsgBox "Cliente Inexistente", vbInformation, MsgTit
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            gGuardando_Documento = False
            Exit Function
        End If
    End If
    Select Case val(txtTipo_Doc_Identidad.text)
    
        Case 2  ' RUT Uruguay
        
            If val(TxtRuc.text) <> 0 Then
                If Not Validar_RUT(TxtRuc.text) Then
                    gbolESC = True
                    MsgBox "ERROR: EL RUT Ingresado No es Válido. Verifique...", vbCritical + vbOKOnly
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    gGuardando_Documento = False
                    Exit Function
                End If
            End If
    
        Case 3, 4 ' CI Uruguay
                
            If (Trim(TxtCFinal.text) = "X") And D!exportacion <> "S" Then
                ' Consumidor FINAL
                ldblImporte_Total = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, CDbl(NullToZero(txtImporte.text)))
                
                If ldblImporte_Total >= ConfPuntoVta_Importe_Minimo_Cliente_Sin_RUT_CI_Valida Then
                    
                    If Not Validar_CI_Uruguay(TxtRuc.text) And val(txtTipo_Doc_Identidad.text) = 3 And D!tipo_doc = "E" Then
                        gbolESC = True
                        MsgBox "ERROR: El Documento Tiene Un Importe Mayor a $U " & ConfPuntoVta_Importe_Minimo_Cliente_Sin_RUT_CI_Valida & ". Debe Ingresar la Cédula de Identidad del Cliente o Verifique porque no es Válida....", vbCritical + vbOKOnly
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        gGuardando_Documento = False
                        Exit Function
                    Else
                        If Trim(TxtRuc.text) = "" And D!tipo_doc = "E" Then
                            gbolESC = True
                            MsgBox "ERROR: El Documento Tiene Un Importe Mayor a $U " & ConfPuntoVta_Importe_Minimo_Cliente_Sin_RUT_CI_Valida & ". Debe Ingresar la Identificacion del Cliente. Verifique ....", vbCritical + vbOKOnly
                            Controlar_Datos_Ingresados_Antes_de_Guardar = False
                            gGuardando_Documento = False
                            Exit Function
                        End If
                    End If
                Else
                    If Trim(TxtRuc.text) <> "" And val(txtTipo_Doc_Identidad.text) = 3 And D!tipo_doc = "E" Then
                        ' Ingrese una CI, entonces la valido
                        If Not Validar_CI_Uruguay(TxtRuc.text) Then
                            gbolESC = True
                            MsgBox "ERROR: Debe Ingresar la Cédula de Identidad del Cliente o Verifique porque no es Válida....", vbCritical + vbOKOnly
                            Controlar_Datos_Ingresados_Antes_de_Guardar = False
                            gGuardando_Documento = False
                            Exit Function
                        End If
                    End If
                End If
            End If
        
    End Select
    
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
    End If
       
    'AIR 20191212 se agrega control de que la sucursal sea valida para cliente
    If D!tipo_doc <> "G" Then
        If val(TxtCodSuc.text) <> 0 Then    'Solo se controla para sucursal <> 0    SS 20200212
            If Not Buscar_Sucursal(txtCodProv.text, val(TxtCodSuc.text), R) Then
                MsgBox "La Sucursal ingresada no es correcta. Verifique...", vbCritical, MsgTit
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                TxtCodSuc.SetFocus
                Exit Function
            End If
        End If
    End If
   
    If esEFactura(val(txtCodDoc.text)) Then
        lblnEsEfactura = True
    End If
    If Trim(D!mueve_merca_serv) = "M" Then
    
        For j = 1 To vsfLineas_Mercaderia.Rows - 1
            If Trim(UCase(ConfPuntoVta_Permite_Venta_Precio_Cero)) = "N" Then
                If D!tipo_precio = "0" Then
                    ' El documento esta configurado para que el precio se inicialize en 0 (cero)
                Else
                        
                    Call Calcular_Importes_de_la_Linea_Mercaderia(j, False, pbolHabilitar_Boton_Guardar)
                    If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_IMPORTE)) <= 0 Then
                        MsgBox "Error: Hay Articulos con Precio Cero. Facturador esta Configurar para que No Permita Facturar Lineas con Importe Cero. Verifique...", vbCritical, MsgTit
                        gGuardando_Documento = False
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        Exit Function
                    End If
                    
                    If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_UNIDADES)) = 0 Then
                        MsgBox "Error: Hay Articulos con Precio Cero. Facturador esta Configurar para que No Permita Facturar Lineas con Importe Cero. Verifique...", vbCritical, MsgTit
                        gGuardando_Documento = False
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        Exit Function
                    End If
                End If
            End If
        
            'AIR 20191121 se verifica la descripcion respecto de caracteres que generan errores en el envio a E-factura
            
            vsfLineas_Mercaderia.TextMatrix(j, CGL_DESCRIPCION) = Trim(f_Ins_String(vsfLineas_Mercaderia.TextMatrix(j, CGL_DESCRIPCION)))
                       
            ' AIR 20171213
            If Not ConfPuntoVta_Permite_Unidades_Fraccionadas And val(Trim(vsfLineas_Mercaderia.TextMatrix(j, CGL_UNIDADES))) <> Format(Trim(vsfLineas_Mercaderia.TextMatrix(j, CGL_UNIDADES)), "0") Then
                MsgBox "Las Unidades de Venta deben ser un Número ENTERO. Verifique...", vbInformation, MsgTit
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                Exit Function
               
            End If
            
            ' AIR 20190909 Se agrega el control en el boton guardar de
            ' Documentos parciales: Control de ingreso de lineas nuevas, se permite si el documento lo acepta  SS 20160209
            If ConfControla_Saldo_Cantidad_Por_Documento Then
                If gbln_Cargo_Datos_Desde_F10 = True Then
                    If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_COD_DOC_REF)) = 0 And val(vsfLineas_Mercaderia.TextMatrix(j, CGL_NRO_DOC_REF)) = 0 Then        ' el ingreso de este articulo es manual, no viene de un doc pendiente
                        
                        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                            If D!permite_agregar_lineas_detalle = "N" Then
                                MsgBox "Error: El Documento NO admite agregar Nuevos Articulos. Verifique por favor....", vbCritical, MsgTit
                                gGuardando_Documento = False
                                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                                Exit Function
                            End If
                        End If
                    End If
                End If
            End If
            
            ' AIR 20221003 se traslado codigo para aqui que estaba mas abajo y repetia el For
            Call Calcular_Importes_de_la_Linea_Mercaderia(j, False, pbolHabilitar_Boton_Guardar)
           
            If lblnEsEfactura Then
                If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_IMPORTE)) < 0 And Not confPermite_Lineas_Negativas_FE Then
                    MsgBox "EFACTURA no permite lineas en NEGATIVO ", vbCritical + vbOKOnly
                    'MousePointer = 1
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
                
                If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_UNIDADES)) = 0 Then
                    MsgBox "EFACTURA no permite cantidad en CERO ", vbCritical + vbOKOnly
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
        Next j
            
        If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
            If Trim(UCase(D!pide_datos_entrega)) = "S" Then
                For i = 1 To vsfLineas_Mercaderia.Rows - 1
                    llngTipo_Entrega = 0
                    If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIPO_ENTREGA)), TE) Then
                        llngTipo_Entrega = TE!codigo
                    End If
                    
                    If llngTipo_Entrega = 0 Then
                        MsgBox "Error: Hay Articulos que No tiene Asingada el Tipo de Entrega de la Mercaderia. Verifique...", vbCritical, MsgTit
                        gGuardando_Documento = False
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        Exit Function
                    End If
                Next
            End If
        End If
        
    End If
    
    'If (ConfFormato_Factura = "HERTZ") Then
    If Trim(UCase(D!pide_contrato)) = "E" Then      'SS 20180903
        If Trim(TxtContrato_Externo.text) = "" Then
        
            MsgBox "Error: Debe Ingresar el Número de Contrato. Verifique...", vbCritical, MsgTit
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
        
        'AIR 20160619
        
'        If Trim(txtObs.Text) = "" Then
'                MsgBox "Error: Debe Ingresar el Número de Contrato en la Observacion. Verifique...", vbCritical, MsgTit
'                gGuardando_Documento = False
'                Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                Exit Function
'        End If
    
    End If

    lActualizar_Pedido = False
    
    If Trim(D!mueve_merca_serv) = "M" Then
        If vsfLineas_Mercaderia.Rows < 2 Then
            MsgBox "Error, No Hay Articulos en el Documento. Verifique", vbCritical, MsgTit
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
    
    If Trim(D!mueve_merca_serv) = "S" Then
        If dbgLineas_Servicios.Rows < 1 Then
            MsgBox "Error, No Hay Lineas en el Documento. Verifique", vbCritical, MsgTit
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
            
    If Trim(UCase(D!clase)) = "CREDITO" Then
        If val(txtCambio.text) <> 0 Then
            MsgBox "Error: El Documento es de Tipo CREDITO y Tiene un 'Cambio'. Verifique", vbCritical, MsgTit
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
        
    'Controlamos los cheques
    '################################
     For i = 1 To vsfCheques.Rows - 1
        If Trim(vsfCheques.TextMatrix(i, CGCH_BANCO)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_IMPORTE)) <> "" And Trim(vsfCheques.TextMatrix(i, CGCH_MONEDA)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)) <> "" And Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> "" Then
               
            'AIR 20190503 se agregan los tipos de documentos 690 y 694 que se usan para transfernecia y los permite ingresar en la grilla pero luego aqui daba error.
             
            If Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> 730 And Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> 735 And Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> 701 And Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> 690 And Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) <> 694 Then
                MsgBox "Error en el Documento Vinculado al Cheque, Verifique...", vbCritical, MsgTit
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                Exit Function
            End If
            
            If Not IsDate(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO)) Then
                MsgBox "Error en la Fecha Vinculada al Cheque, Verifique...", vbCritical, MsgTit
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                Exit Function
            End If
            
            Select Case val(txtMoneda.text)
                Case gMoneda_Base
                    llngCuenta = gCuenta_Base
                Case gMoneda_Referencia
                    llngCuenta = gCuenta_Referencia
            End Select
            
            If Trim(UCase(sspOperacion.Caption)) = "A" Then
                
                ' Chequeo si es una ALTA del Documento
                If Busco_Movimiento_Bancario(val(txtEmpresa.text), val(vsfCheques.TextMatrix(i, CGCH_BANCO)), llngCuenta, val(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)), val(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)), "", ch) Then
                    MsgBox "ERROR: Cheque " & Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) & "/" & Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)) & " Ingresado Ya Existe en el Sistema.Verifique...", vbCritical, MsgTit
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
                
                
                'Buscamos por cartera
                
                If Busco_Movimiento_Bancario(val(txtEmpresa.text), gBanco_Empresa, llngCuenta, val(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)), val(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)), "", ch) Then
                    MsgBox "ERROR: Cheque " & Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) & "/" & Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)) & " Ingresado Ya Existe en el Sistema.Verifique...", vbCritical, MsgTit
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
'Comentado por JGiriboni 12/07/2016
'                For j = 1 To vsfMedios_Pagos.Rows - 1
'                    If Val(vsfMedios_Pagos.TextMatrix(j, CGMP_MONEDA)) <> Val(vsfCheques.TextMatrix(i, CGCH_MONEDA)) And CDbl(vsfMedios_Pagos.TextMatrix(j, CGMP_IMPORTE)) <> 0 Then
'                        MsgBox "Error en la Moneda Vinculada al Cheque, Verifique...", vbCritical, MsgTit
'                        gGuardando_Documento = False
'                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                        Exit Function
'                    End If
'                Next j
            End If
            
            ' AIR 20231215
            If Buscar_Asiento_Chq_Tansf_x_Vencimiento(val(txtEmpresa.text), Trim(vsfCheques.TextMatrix(i, CGCH_BANCO)), val(vsfCheques.TextMatrix(i, CGCH_CUENTA)), Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)), Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)), lrstVto) Then
                If MsgBox("El Cheque ó Transferencia " & val(vsfCheques.TextMatrix(i, CGCH_BANCO)) & "/" & Trim(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)) & "/" & Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)) & "  tiene asiento generado por Vencimiento al " & Format(lrstVto!fec_venc_mb, "dd/mm/yyyy") & ". Desea Continuar? ", vbQuestion + vbYesNo + vbDefaultButton2, MsgTit) = vbNo Then
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
        End If
      Next i
      

    'Agregado por JGiriboni 12/07/2016
    'Se controla que la suma de los importes de los cheques en su respectiva
    'moneda coincidan con el valor agregado en la grilla de Medios de Pago
    
    'Se agrega excepcion para CASINO JUSTICIA   SS 20160817
    ' AIR 20190503 Se modifica el control porque no estaba contemplando la posibillidad de que existiera mas de un medio de pago de tipo cheque
    
'    If ConfFormato_Factura <> "CASINO-POS" And ConfFormato_Factura <> "CASINO" Then
'        For j = 1 To vsfMedios_Pagos.Rows - 1
'          Call Busco_Medios_Pago(Val(vsfMedios_Pagos.TextMatrix(j, CGMP_MEDIO_PAGO)), MP)
'          If MP!es_cheque = "S" Then
'              For i = 1 To vsfCheques.Rows - 1
'                  If Val(vsfCheques.TextMatrix(i, CGCH_MONEDA)) = MP!moneda Then
'                      auxSumaImporteCheques = auxSumaImporteCheques + CDbl(vsfCheques.TextMatrix(i, CGCH_IMPORTE))
'                  End If
'              Next i
'              If auxSumaImporteCheques > 0 Then
'                  If Val(vsfMedios_Pagos.TextMatrix(j, CGMP_IMPORTE)) <> auxSumaImporteCheques Then
'                      MsgBox "Error. No coinciden los importes de los cheques con los ingresado en medios de pago.", vbCritical, MsgTit
'                      gGuardando_Documento = False
'                      Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                      Exit Function
'                  End If
'              End If
'              auxSumaImporteCheques = 0
'          End If
'        Next j
'    End If

    auxSumaImporteMP = 0
    auxSumaImporteCheques = 0
    
    If ConfFormato_Factura <> "CASINO-POS" And ConfFormato_Factura <> "CASINO" Then
       
       SQL = "Select * from Monedas "
       Set RstMoneda = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
       
       Do While Not RstMoneda.EOF
       
            For j = 1 To vsfMedios_Pagos.Rows - 1
            
                If val(vsfMedios_Pagos.TextMatrix(j, CGMP_MONEDA)) = RstMoneda!codigo Then
                    Call Busco_Medios_Pago(val(vsfMedios_Pagos.TextMatrix(j, CGMP_MEDIO_PAGO)), MP)
                    If MP!es_cheque = "S" Then
                      auxSumaImporteMP = auxSumaImporteMP + CDbl(vsfMedios_Pagos.TextMatrix(j, CGMP_IMPORTE))
                    End If
                End If
            Next j
        
            For i = 1 To vsfCheques.Rows - 1
                  
                If val(vsfCheques.TextMatrix(i, CGCH_MONEDA)) = RstMoneda!codigo Then
                    SQL = "Select * from Documentos where cod_doc = " & val(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO))
                    Set rstDocum = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
                    If rstDocum!tipo_doc = "C" Then
                        auxSumaImporteCheques = auxSumaImporteCheques + CDbl(vsfCheques.TextMatrix(i, CGCH_IMPORTE))
                    End If
                End If
             Next i
            
            ' AIR 20190618 se agrega control de mayor a 0, para que no exija siempre ingresar cheques al usar el medio de pago cheque- hay varios clientes que no manejand el ignreso de los datos del cheque
            If auxSumaImporteCheques > 0 Then
                If auxSumaImporteCheques <> auxSumaImporteMP Then
                    MsgBox "Error. No coinciden los importes de los cheques con los ingresado en medios de pago Cheque.", vbCritical, MsgTit
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
            auxSumaImporteMP = 0
            auxSumaImporteCheques = 0
            
            RstMoneda.MoveNext
            DoEvents
        
        Loop
    End If
    
    'Controlamos que se ingrese el medio de pago
    If Not Controlar_Ingreso_Medios_Pago Then
        MsgBox "El Detalle de los Medios de Pago no es Correcto, Verifique", vbCritical + vbOKOnly
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
        
'    'GarciaLopez, al grabar la factura, pregunta si se desea generar en PREVENTA para dejarla en espera y facturarla luego.
'    'If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER" Or ConfFormato_Factura = "CENTROSUR") And UCase(Trim(sspOperacion.Caption)) = "A" Then
'    'If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER") And UCase(Trim(sspOperacion.Caption)) = "A" Then 'Sacamos CENTROSUR  SS 20181109
'    'AIR 20211215 se pasa la condicion a una variable de configuracion.
'    If (ConfFormato_Factura = "GARCIALOPEZ" Or ConfFormato_Factura = "STAUDINGER" Or ConfPuntoVta_Permite_Guardar_Como_Preventa) And _
'        UCase(Trim(sspOperacion.Caption)) = "A" Then
'        sigo = MsgBox("Desea Guardar Como PreVenta?", vbYesNo + vbInformation + vbDefaultButton2, MsgTit)
'        If sigo = vbYes Then
'            txtCodDoc.text = ConfDoc_Ingreso_PreVenta_Cli
'            If Not Buscar_Tipo_Documento(Val(txtCodDoc.text), D) Then
'                MsgBox "ERROR al Generar la PreVenta", vbCritical + vbOKOnly
'                gGuardando_Documento = False
'                Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                Exit Function
'            End If
'        End If
'    End If
    
    If ConfPuntoVta_Controla_Vendedor Then
        ' JE 20240819   /   Se agrega aqui de nuevo el control, porque se estan dando caso que queda sin Vendedor el documento
        If val(txtVendedor.text) = 0 Then
            gGuardando_Documento = False
            MsgBox "El Vendedor es Obligatorio Ingresarlo. Verifique por favor...", vbCritical + vbOKOnly
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
    
    'Electronacho, control del vendedor
    If (ConfFormato_Factura = "ELECTRONACHO" Or ConfFormato_Factura = "VEICUER") And UCase(Trim(sspOperacion.Caption)) = "A" Then
        If val(txtVendedor.text) = 0 Then
            MsgBox "El Vendedor NO ES VALIDO", vbCritical + vbOKOnly
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
    
    If Not Buscar_Vendedor(txtVendedor.text, R) Then
        MsgBox "El Vendedor NO ES VALIDO", vbCritical + vbOKOnly
        txtVendedor.SetFocus
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    Else
        If R!Activo = "N" Then
            MsgBox "El Vendedor NO ESTA ACTIVO", vbCritical + vbOKOnly
            gGuardando_Documento = False
            Controlar_Datos_Ingresados_Antes_de_Guardar = False
            Exit Function
        End If
    End If
    
    If Trim(D!mueve_merca_serv) = "S" Then
        dbgLineas_Servicios.MoveFirst
        For i = 0 To dbgLineas_Servicios.Rows - 1
            If dbgLineas_Servicios.Columns("codigo").text <> "" Then    'AIR 20200421
                dbgLineas_Servicios.Columns("descripcion").text = Trim(f_Ins_String(dbgLineas_Servicios.Columns("descripcion").text))
                
                If pstrTipo_Ingreso_Documentos = "S" And D!tipo_doc = "G" Then      'N al ser resguardo es un importe sin impuestos SS 20180813
                    Call Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar, "N", True)
                Else
                    Call Calcular_Importes_de_la_Linea_Servicios(pbolHabilitar_Boton_Guardar, "", False)
                End If
                
                If esEFactura(val(txtCodDoc.text)) Then
                    If D!tipo_doc <> "G" Then               'En los resguardos permitimos lineas con importe negativo   SS 20181207
                        If val(dbgLineas_Servicios.Columns("importe").text) < 0 Then
                            MsgBox "EFACTURA no permite lineas en NEGATIVO", vbCritical + vbOKOnly
                            gGuardando_Documento = False
                            Controlar_Datos_Ingresados_Antes_de_Guardar = False
                            Exit Function
                        End If
                        If val(dbgLineas_Servicios.Columns("importe").text) = 0 And val(dbgLineas_Servicios.Columns("precio").text) <> 0 Then   'Ajuste control SS 20190318
                            MsgBox "EFACTURA no permite lineas con Total = 0 y Precio Unitario diferente a 0", vbCritical + vbOKOnly
                            gGuardando_Documento = False
                            Controlar_Datos_Ingresados_Antes_de_Guardar = False
                            Exit Function
                        End If
                    End If
                    
                    If val(dbgLineas_Servicios.Columns("unidades").text) = 0 Then
                        MsgBox "EFACTURA no permite cantidad en CERO", vbCritical + vbOKOnly
                        'MousePointer = 1
                        gGuardando_Documento = False
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        Exit Function
                    End If
                End If
                
                If Busco_Insumo_Servicio(dbgLineas_Servicios.Columns("codigo").text, M) Then
                    If M!Activo = "N" Then
                        MsgBox "El Insumo y/o Servicio:  " & dbgLineas_Servicios.Columns("codigo").text & " NO esta Activo. Verifique", vbInformation, MsgTit
                        gGuardando_Documento = False
                        Controlar_Datos_Ingresados_Antes_de_Guardar = False
                        Exit Function
                    End If
                End If
            End If
            dbgLineas_Servicios.MoveNext
        Next i
    Else
    
    'AIR 20221003 se traslada para mas arriba en el codigo
'        For j = 1 To vsfLineas_Mercaderia.Rows - 1
'            Call Calcular_Importes_de_la_Linea_Mercaderia(j, False, pbolHabilitar_Boton_Guardar)
'            If esEFactura(val(txtCodDoc.text)) Then
'                If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_IMPORTE)) < 0 Then
'                    MsgBox "EFACTURA no permite lineas en NEGATIVO ", vbCritical + vbOKOnly
'                    'MousePointer = 1
'                    gGuardando_Documento = False
'                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                    Exit Function
'                End If
'
'                If val(vsfLineas_Mercaderia.TextMatrix(j, CGL_UNIDADES)) = 0 Then
'                    MsgBox "EFACTURA no permite cantidad en CERO ", vbCritical + vbOKOnly
'                    gGuardando_Documento = False
'                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
'                    Exit Function
'                End If
'
'            End If
'        Next j
    End If
    
    If Not Controlo_Ingreso_Detalle_Tarjetas Then
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
        
    If esEFactura(val(txtCodDoc.text)) Then
        'Controlamos las simulaciones
        If sspOperacion.Caption = "U" Then
            If UCase(TxtAutorizado.text) = "AUTORIZADO" Then
                MsgBox "ATENCION!, Documento AUTORIZADO y EMITIDO, No se Permite Autorizar ", vbInformation
                'MousePointer = 1
                gGuardando_Documento = False
                Controlar_Datos_Ingresados_Antes_de_Guardar = False
                Exit Function
            Else
                sigo = MsgBox("ATENCION!, al AUTORIZAR va a GENERAR UN CFE, Desea Continuar? ", vbInformation + vbYesNo)
                If sigo = vbNo Then
                    'MousePointer = 1
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
            End If
        End If
        'Controlamos el tipo de documento
        
        Select Case val(txtTipo_Doc_Identidad.text)
            
            Case 2  ' RUT Uruguay valido
                If Trim(TxtRuc.text) = "" Or Not Validar_RUT(TxtRuc.text) Then
                    MsgBox "ATENCION: El RUT no es Valido", vbCritical + vbOKOnly
                    'MousePointer = 1
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
                
            Case 3  ' CI Uruguay valido
                If Trim(TxtRuc.text) <> "" And Not Validar_CI_Uruguay(TxtRuc.text) Then
                    MsgBox "ATENCION: El RUT no es Valido", vbCritical + vbOKOnly
                    'MousePointer = 1
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
                
            Case 5, 6 ' Pasaporte o DNI
                If Trim(TxtRuc.text) = "" Then
                    MsgBox "ATENCION: El Documento NO Puede ser Vacio", vbCritical + vbOKOnly
                    'MousePointer = 1
                    gGuardando_Documento = False
                    Controlar_Datos_Ingresados_Antes_de_Guardar = False
                    Exit Function
                End If
        End Select
        
    End If
    
    If Not IsDate(txtFec_Vencimiento.text) Then
        MsgBox "Error en Fecha de Vencimiento. Verique por favor...", vbExclamation, MsgTit
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
    
    If CDate(txtFec_Vencimiento.text) < CDate(txtFec_Doc.text) Then
        MsgBox "Fecha de Vencimiento Menor a la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
    
    'AIR se cambia y agrega variable de cofiguracion para el control de la cantidad maxima de meses para el vencimiento de la factura
    'If CDate(txtFec_Vencimiento.text) >= DateAdd("yyyy", 1, CDate(txtFec_Doc.text)) Then
        'MsgBox "Fecha de Vencimiento Mayor a un Año de la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
    If CDate(txtFec_Vencimiento.text) > DateAdd("m", ConfPuntoVta_Tope_Max_Meses_Vencimiento_Factura, CDate(txtFec_Doc.text)) Then
        MsgBox "Fecha de Vencimiento Mayor a " & ConfPuntoVta_Tope_Max_Meses_Vencimiento_Factura & " meses de la Fecha del Documento. Verique por favor...", vbExclamation, MsgTit
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
    
    ' AIR 20190725 control para que no se afecten facturas que son en cuotas ya que el punto de venta no genera movim. en la faccmp_cuotas que cierre la cancelacion.
    ' hay que hacerlo con un recibo enla cobranza de cuotas
    If Buscar_Documento_Cuota(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), lrstDoc_Cuotas) Then
        MsgBox "Documento en Cuotas No Cumple las Condiciones para ser Afectado. Verifique....", vbExclamation + vbOKOnly, MsgTit
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    End If
    
    'AIR 20210604 se agrega control para el deposito
    If Not Busco_Stk_Deposito(Trim(txtDeposito.text), R) Then
        MsgBox "El Deposito Ingrasado no es valido.", vbExclamation, MsgTit
        R.Close
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        txtDeposito.SetFocus
        Exit Function
    End If
     
Exit Function
Errores:
'Resume
        gGuardando_Documento = False
        Controlar_Datos_Ingresados_Antes_de_Guardar = False
        Exit Function
    
End Function

Function Controlar_Ingreso_Medios_Pago() As Boolean
Dim lbolEncontre As Boolean
Dim MP As Recordset
Dim i As Long
Dim j As Long

    Controlar_Ingreso_Medios_Pago = True
    
    
    
    
    ' Reviso si hay datos en la Grilla de Medios de Pago
    lbolEncontre = False
    For i = 1 To vsfMedios_Pagos.Rows - 1
        If val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Then
            lbolEncontre = True
        End If
    Next
    'jch 20250108 se quito el control
    'If Not Control_Interface_Tarjetas Then
    '    Controlar_Ingreso_Medios_Pago = False
    '    Exit Function
    'End If
   
    If Not lbolEncontre And val(txtTotal_Calculado.text) <> 0 Then
        Controlar_Ingreso_Medios_Pago = False
        Exit Function
    End If
    
    If Trim(txtCambio.text) <> "" Then
        If CDbl(txtCambio.text) >= 0 Then
            
            Select Case ConfFormato_Factura
                Case "GARCIALOPEZ", "DUBER", "BARATILLO", "TATOREPRESENTACIONES", "ENET", "MMARTINEZ", "STAUDINGER", "JAGUILAR"
                    If CDbl(txtCambio.text) > 0 Then
                        Controlar_Ingreso_Medios_Pago = False
                        Exit Function
                    Else
                        Controlar_Ingreso_Medios_Pago = True
                        Exit Function
                    End If
                Case Else
                    Controlar_Ingreso_Medios_Pago = True
                    Exit Function
            End Select
        Else
            Controlar_Ingreso_Medios_Pago = False
            Exit Function
        End If
    Else
        Controlar_Ingreso_Medios_Pago = False
        Exit Function
    End If
    
   

End Function


Function Controlo_Ingreso_Detalle_Tarjetas() As Boolean
Dim i As Long
Dim j As Long
Dim lbolEncontre As Boolean
Dim MP As Recordset

    ' Controlo si alguno de los Medio de Pago es de Tipo Tarjeta y solicita tener detalle de la tarjeta
    
    Controlo_Ingreso_Detalle_Tarjetas = True
    
    For i = 1 To vsfMedios_Pagos.Rows - 1
        If val(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Then
            If Busco_Medios_Pago(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)), MP) Then
                If Trim(UCase(MP!tipo_medio_pago)) = "T" And Trim(UCase(MP!pide_detalle_tarjetas)) = "S" Then
                    
                    ' Recorro la Grilla para Controlar si esta ingresado una tarjeta con este medio de Pago
                    lbolEncontre = False
                    For j = 1 To vsfTarjetas_Credito.Rows - 1
                        If val(vsfTarjetas_Credito.TextMatrix(j, CGTA_MEDIO_PAGO)) = val(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)) Then
                            lbolEncontre = True
                        End If
                    Next j
                    
                    If Not lbolEncontre Then
                        MsgBox "ERROR: Se ingreso un medio de Pago de Tarjeta (" & MP!Descripcion & "), y no existe el Detalle del mismo. Verfique...", vbCritical + vbOKOnly
                        Controlo_Ingreso_Detalle_Tarjetas = False
                        Exit Function
                    End If
                End If
            End If
        End If
    Next
    
End Function

Function Actualizar_Precios_Venta() As Boolean

Dim lbolActualizar_Precios As Boolean
Dim llngCantidad_Registros_Actualizado_Precio As Long
Dim L As Recordset
Dim PV As Recordset
Dim i As Long
Dim ldblPrecio As Double
Dim SQL As String
Dim lstrObservacion As String
Dim ldblPVenta_Nuevo As Double
Dim ldblPVenta_Base As Double
Dim ldblCosto As Double
Dim ldblIndice As Double
Dim ldblTipo_Cambio As Double

On Error GoTo Errores

    Actualizar_Precios_Venta = True
    
    If ConfPuntoVta_Actualiza_Lista_PVenta And UCase(Trim(sspOperacion.Caption)) = "A" Then
    Else
        Exit Function
    End If
    
    ' SE ACTUALIZA LA LISTA DE PRECIOS DE VENTA CON LOS DATOS DIFERENTES DE CADA LINEA FACTURADA

    lbolActualizar_Precios = True   'Se agrega      SS 20200212
    
    If Trim(UCase(ConfPuntoVta_Permite_Actualizar_Precios_Lista_1)) = "N" Then
        If val(txtLista.text) = 1 Then
            lbolActualizar_Precios = False
        End If
    End If

    If lbolActualizar_Precios Then
        
        If Busco_Lista_Precio(val(txtLista.text), "V", L) Then
        End If
    
        llngCantidad_Registros_Actualizado_Precio = 0
    
        If Trim(UCase(L!autogenerada)) = "N" Then
        
            ' Lista de Ingreso Manual
            
            For i = 1 To vsfLineas_Mercaderia.Rows - 1
                If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
                
                    ldblPrecio = Busco_Precio_Emision(val(txtEmpresa.text), vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO), val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                                       
                    If ldblPrecio <> vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO) Then
                        ' Doy de Alta el Precio de Venta
                        
                        SQL = "DELETE FROM Precio_Vta "
                        SQL = SQL & " WHERE cod_prod = " & vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)
                        SQL = SQL & " AND nro_lista = " & txtLista.text
                        SQL = SQL & " AND fec_vig = " & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base)
                        Dbs.Execute SQL
                        
                        lstrObservacion = "PRECIO AUTOMATICO DEL FACTURADOR DOC: " & val(txtCodDoc.text) & "/" & val(txtDoc.text) & " del Cliente " & txtCodProv & " Precio Anterior: " & ldblPrecio
                        
                        lstrObservacion = Left(lstrObservacion, 100)
                        
                        SQL = "INSERT INTO Precio_Vta "
                        SQL = SQL & " VALUES ("
                        SQL = SQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
                        SQL = SQL & vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO) & ","
                        SQL = SQL & txtLista.text & ","
                        SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)) & ","
                        SQL = SQL & "0" & ","
                        SQL = SQL & ldblPrecio & "," & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
                        SQL = SQL & Trim(UCase(gUsuario)) & "','"
                        SQL = SQL & Trim(f_Ins_String(lstrObservacion)) & "',"
                        SQL = SQL & val(txtMoneda.text) & ")"
                
                        Dbs.Execute SQL
                        
                        llngCantidad_Registros_Actualizado_Precio = llngCantidad_Registros_Actualizado_Precio + 1
                        
                        Call Actualizar_Tabla_Articulos_Pendientes_Emision_Etiqueta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "A")
                        Call Actualizar_Tabla_MOVIL_Precios_Venta(val(txtLista.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "N", "M", 0, True)
                        Call Actualizar_Tabla_WEB_Precios_Venta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "S")
                        
                        Call Actualizar_Tabla_Articulos_Pendientes_Emision_Etiqueta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "A")
                        
                    End If
                    
                End If
            Next
        Else
            ' Lista Autogenerada
            
            If Trim(UCase(L!usar_porcentaje_x_articulo)) = "S" Then
                ' Lista Autogenerada y por porcentaje
            
                For i = 1 To vsfLineas_Mercaderia.Rows - 1
                    If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
                    
                        ldblPrecio = Busco_Precio_Emision(val(txtEmpresa.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), val(txtCodProv.text), val(txtCodDoc.text), txtLista.text, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                                           
                        If ldblPrecio = 0 Then
                            ' Parche para Distribuidora de Envases
                            ' ---------------------------------------------------------------------------------------
                            
                            ' busco Precio de Venta de la lista 1 (lista base de todas las listas)
                            ldblPrecio = Busco_Precio_Emision(val(txtEmpresa.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), val(txtCodProv.text), val(txtCodDoc.text), 1, txtMoneda.text, txtTipo_Cambio.text, CDate(txtFec_Doc.text), ConfPuntoVta_Controla_PMinimo, PV)
                            
                            ' ---------------------------------------------------------------------------------------
                        
                        End If
                                            
                        ldblPVenta_Nuevo = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO))
                        
                        If ldblPrecio <> ldblPVenta_Nuevo Then
                            ' Doy de Alta el Porcentaje de Venta
            
                            If Trim(UCase(L!autogenerada_tipo_lista_base)) = "V" Then
                                ldblPVenta_Base = Busco_Precio_Emision(val(txtEmpresa.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), 0, 0, L!autogenerada_lista_base, L!moneda, 0, date, ConfPuntoVta_Controla_PMinimo, PV)
                            End If
                            
                            If Trim(UCase(L!autogenerada_tipo_lista_base)) = "C" Then
                                If Not Busco_Costo_x_Moneda(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), Format(date, "dd/mm/yyyy"), L!autogenerada_lista_base, L!moneda, ldblCosto) Then
                                    ldblPVenta_Base = 0
                                End If
                                ldblPVenta_Base = ldblCosto
                            End If
                            
                            If L!moneda <> val(txtMoneda.text) Then     'la moneda de la lista es <> moneda de la factura   SS 20160803
                                If ConfPuntoVta_Convertir_TCambio = True Then
                                    ldblTipo_Cambio = val(txtTipo_Cambio.text)
                                    If ldblTipo_Cambio = 0 Then
                                        ldblTipo_Cambio = 1
                                    End If
                                    If val(txtMoneda.text) <> gMoneda_Base Then
                                        ldblPVenta_Base = Format(ldblPVenta_Base / ldblTipo_Cambio, "0.00")     ' llevo el precio lista base a precio segun moneda vta
                                    Else
                                        ldblTipo_Cambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(plngCod_Emp, val(txtMoneda.text), CDate(txtFec_Doc.text), "P")
                                        ldblPVenta_Base = Format(ldblPVenta_Base * ldblTipo_Cambio, "0.00")
                                    End If
                                Else
                                    ldblPVenta_Base = 0
                                End If
                            End If
                            
                            
                            If ldblPVenta_Base <> 0 Then
                                ldblIndice = ((ldblPVenta_Nuevo / ldblPVenta_Base) - 1) * 100
                            Else
                                ldblIndice = 0
                            End If
            
                            SQL = "DELETE FROM ma_Porcentajes_x_Lista_x_Articulos "
                            SQL = SQL & " WHERE nro_lista = " & val(txtLista.text)
                            SQL = SQL & " AND fec_vigencia = " & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base)
                            SQL = SQL & " AND cod_prod = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                            
                            If confUsa_Moneda_Porcentaje_Lista_x_Articulo Then
                                SQL = SQL & " And moneda = " & val(txtMoneda.text)
                            End If
                           
                            Dbs.Execute SQL
                            
                            SQL = "INSERT INTO ma_Porcentajes_x_Lista_x_Articulos "
                            SQL = SQL & " VALUES ("
                            SQL = SQL & val(txtLista.text) & ","
                            SQL = SQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ","
                            SQL = SQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
                            SQL = SQL & Round(ldblIndice, 2) & ","
                            SQL = SQL & "0" & ","
                            SQL = SQL & "0" & ","
                            SQL = SQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
                            SQL = SQL & Trim(UCase(gUsuario)) & "',"
                            ' JCH 20240808 se agrega al insert la moneda campo nuevo que falto aqui
                            If confUsa_Moneda_Porcentaje_Lista_x_Articulo Then
                                SQL = SQL & val(txtMoneda.text) & ")"
                            Else
                                SQL = SQL & gMoneda_Base & ")"
                            End If
                            
                            Dbs.Execute SQL
                                                    
                            llngCantidad_Registros_Actualizado_Precio = llngCantidad_Registros_Actualizado_Precio + 1
                            
                            Call Actualizar_Tabla_Articulos_Pendientes_Emision_Etiqueta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "A")
                            Call Actualizar_Tabla_MOVIL_Precios_Venta(val(txtLista.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "N", "M", 0, True)
                            Call Actualizar_Tabla_WEB_Precios_Venta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "S")
                            
                            Call Actualizar_Tabla_Articulos_Pendientes_Emision_Etiqueta(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), "A")
                                                    
                        End If
                    End If
                Next
            End If
        End If
    End If
    
    'If llngCantidad_Registros_Actualizado_Precio > 0 Then
       'se elimina el mensaje porque porque los usuario podrias no presionar el boton y bloqueaba todo el sistema
       ' MsgBox "SE ACTUALIZARON " & llngCantidad_Registros_Actualizado_Precio & " ARTICULOS CON PRECIOS DIFERENTES EN EL SISTEMA", vbInformation, MsgTit
       
    'End If

Exit Function

Errores:
    Call FErrores
    Actualizar_Precios_Venta = False
   
End Function

Sub Cargar_Datos_Cabezal_Auxiliar(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long)
Dim lstrSQL As String
Dim C As Recordset
Dim R As Recordset

    lstrSQL = "SELECT * FROM Faccmp_Cabezal_Auxiliar"
    lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
    lstrSQL = lstrSQL & " AND cod_doc = " & plngCod_Doc
    lstrSQL = lstrSQL & " AND nro_doc = " & plngNro_Doc
    
    Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    If Not R.EOF Then
        txtDoc_Afectado.text = R!cod_doc_afectado
        txtNro_Doc_Afectado.text = R!nro_doc_afectado
        txtTipo_Doc_Identidad.text = R!tipo_doc_identidad
        txtDoc_Remito.text = R!cod_doc_pedido
        txtRemito.text = R!nro_doc_pedido
        txtDeposito.text = Trim(UCase(R!Deposito))
        txtContrato.text = R!contrato
        TxtContrato_Externo.text = R!contrato
        
         'AIR 20160617 agregue Val a Contrato
        If Busco_Contrato_Servicio(plngCod_Emp, val(R!contrato), C) Then
            txtDescripcion_Contrato.text = Trim(UCase(C!Descripcion))
        Else
            txtDescripcion_Contrato.text = ""
        End If
    
        'AIR 20171123 Orden de Compra
        TxtNroIdCompra.text = IIf(IsNull(R!NroIdCompra), 0, R!NroIdCompra)
        
        ' JE 20180502   / Se agregan los campos Tarea_Cod_Doc y Tarea_Nro_doc
        
        If R!tarea_cod_doc <> 0 Then
            txtTarea_Codigo_Documento.text = R!tarea_cod_doc
        Else
            txtTarea_Codigo_Documento.text = ""
        End If
        
        If R!tarea_nro_doc <> 0 Then
            txtTarea_Numero.text = R!tarea_nro_doc
        Else
            txtTarea_Numero.text = ""
        End If
        
        glngTipo_Documento_Identidad = R!tipo_doc_identidad
        gstrDireccion = Trim(UCase(R!direccion))
        gstrTelefonos = Trim(UCase(R!telefono))
        glngCod_Pais = R!cod_pais
        glngCod_Departamento = R!cod_departamento
        glngCod_Ciudad = R!cod_ciudad
        
    End If
    
End Sub

Function Calcular_Monto_Gravado() As Double
Dim i As Long

    Calcular_Monto_Gravado = 0
    
    For i = 1 To vsfImpuestos.Rows - 1
        If vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA) <> 0 Then
            Calcular_Monto_Gravado = Calcular_Monto_Gravado + vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)
        End If
    Next i

End Function


Function Calcular_Monto_IVA() As Double
Dim i As Long

    Calcular_Monto_IVA = 0
    
    For i = 1 To vsfImpuestos.Rows - 1
        If vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA) <> 0 Then
            Calcular_Monto_IVA = Calcular_Monto_IVA + vsfImpuestos.TextMatrix(i, CGI_IVA)
        End If
    Next i

End Function

Private Sub vsfTarjetas_Credito_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
    vsfTarjetas_Credito.Cell(flexcpFontBold, OldRow, OldCol, OldRow, OldCol) = False
    vsfTarjetas_Credito.Cell(flexcpFontBold, NewRow, NewCol, NewRow, NewCol) = True
End Sub

Private Sub vsfTarjetas_Credito_EnterCell()

    If vsfTarjetas_Credito.Col = CGTA_IMPORTE Or _
        vsfTarjetas_Credito.Col = CGTA_MONEDA Or _
        vsfTarjetas_Credito.Col = CGTA_MEDIO_PAGO Or _
        vsfTarjetas_Credito.Col = CGTA_NUMERO Or _
        vsfTarjetas_Credito.Col = CGTA_FECHA_VTO Or _
        vsfTarjetas_Credito.Col = CGTA_NOMBRE_TITULAR Or _
        vsfTarjetas_Credito.Col = CGTA_CODIGO_VERIFICACION Or _
        vsfTarjetas_Credito.Col = CGTA_CUOTAS Or _
        vsfTarjetas_Credito.Col = CGTA_AUTORIZACION Or _
        vsfTarjetas_Credito.Col = CGTA_LOTE Then
        vsfTarjetas_Credito.AutoSearch = flexSearchNone
        vsfTarjetas_Credito.Editable = flexEDKbdMouse
    Else
        vsfTarjetas_Credito.AutoSearch = flexSearchFromTop
        vsfTarjetas_Credito.Editable = flexEDNone
    End If

End Sub

Private Sub vsfTarjetas_Credito_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Detalle de Tarjetas / F12 - Finaliza "
End Sub

Private Sub vsfTarjetas_Credito_KeyDown(KeyCode As Integer, Shift As Integer)
Dim R As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyF12 Or KeyCode = vbKeyEnd Then
        sstDetalle_Pagos.Tab = 0
        vsfMedios_Pagos.SetFocus
        
        Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
             Case "DESCRIPCION"
                 vsfMedios_Pagos.Col = CGMP_DESCRIPCION
             Case Else
                 vsfMedios_Pagos.Col = CGMP_IMPORTE
         End Select
        
        vsfMedios_Pagos.Row = 1
    End If
    If KeyCode = vbKeyEsc Then
        vsfTarjetas_Credito.SetFocus
    End If
    
    If KeyCode = vbKeyF1 Then
        Select Case vsfTarjetas_Credito.Col
            Case CGTA_MEDIO_PAGO
                GForm = Me.Name
                GCampoBusqueda = "GRILLA_TARJETAS"
                whereSelCamG = "Medios_Pago.tipo_medio_pago = 'T'"
                GTipoBusc = "Medios_Pago"
                GNro_Fila = vsfTarjetas_Credito.Row
                gbolESC = True
                frmBusquedas.Show 1
            Case CGTA_MONEDA
                GForm = Me.Name
                GCampoBusqueda = "GRILLA_TARJETAS"
                whereSelCamG = ""
                GTipoBusc = "Monedas"
                GNro_Fila = vsfTarjetas_Credito.Row
                gbolESC = True
                frmBusquedas.Show 1
        End Select
    End If
    
    'AIR 20171027
     
     
'     If KeyCode = vbKeyReturn Then
'         Select Case vsfTarjetas_Credito.Col
'                Case CGTA_MEDIO_PAGO
'                    vsfTarjetas_Credito.Select vsfTarjetas_Credito.Row, CGTA_NUMERO
'
'        End Select
'     End If
     
    'AIR 20171013 se agrega el delete de la linea de la tarjeta
    If KeyCode = vbKeyDelete Then
        If vsfTarjetas_Credito.Row > 0 Then
            If MsgBox("Confirma la Eliminacion de la linea de tarjeta?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                vsfTarjetas_Credito.RemoveItem (vsfTarjetas_Credito.Row)
            End If
        End If
    End If


End Sub


Private Sub vsfTarjetas_Credito_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
On Error GoTo Errores
Dim R As Recordset
Dim M As Recordset
Dim lstrFecha As String

    
    Select Case Col

        Case CGTA_MEDIO_PAGO
            If Trim(vsfTarjetas_Credito.EditText) = "" Then
                Cancel = False

            Else
                If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                    MsgBox "El Código del Medio de Pago debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                Else
                    If Not Busco_Medios_Pago(vsfTarjetas_Credito.EditText, R) Then
                        MsgBox "Medio de Pago Inexistente", vbCritical, MsgTit
                        Cancel = True
                    Else
                        If Trim(UCase(R!tipo_medio_pago)) <> "T" Then
                            MsgBox "Medio de Pago No Definido como Tarjeta. Verifique la definición del mismo...", vbCritical, MsgTit
                            Cancel = True
                        Else
                            vsfTarjetas_Credito.TextMatrix(Row, CGTA_DESCRIPCION) = Trim(R!Descripcion)
                            vsfTarjetas_Credito.Select Row, CGTA_NUMERO
                        End If
                    End If
                End If

            End If

        Case CGTA_NUMERO
            If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                MsgBox "El Número de la Tarjeta debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.Select Row, CGTA_FECHA_VTO
            End If


        Case CGTA_FECHA_VTO

            vsfTarjetas_Credito.EditText = f_ArmoFecha(vsfTarjetas_Credito.EditText)
            If Not IsDate(vsfTarjetas_Credito.EditText) Then
                MsgBox "La Fecha Debe Ingresarse en Formato dd/mm/yyyy", vbCritical, MsgTit
            Else
                vsfTarjetas_Credito.EditText = Format(vsfTarjetas_Credito.EditText, "dd/mm/yyyy")
                vsfTarjetas_Credito.Select Row, CGTA_NOMBRE_TITULAR
            End If


        Case CGTA_NOMBRE_TITULAR
            If Trim(vsfTarjetas_Credito.EditText) = "" Then
                MsgBox "El Titular de la Tarjeta no puede estar Vacio", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.EditText = Trim(UCase(vsfTarjetas_Credito.EditText))
                vsfTarjetas_Credito.Select Row, CGTA_CODIGO_VERIFICACION
            End If


        Case CGTA_CODIGO_VERIFICACION
            If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                MsgBox "El Código de Verificacion de la Tarjeta debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.Select Row, CGTA_CUOTAS
            End If


        Case CGTA_CUOTAS
            If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                MsgBox "El Número de Cuotas debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.Select Row, CGTA_AUTORIZACION
            End If


        Case CGTA_AUTORIZACION
            If Trim(vsfTarjetas_Credito.EditText) = "" Then
                MsgBox "El Código de Autorización de la Tarjeta no puede estar Vacio", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.Select Row, CGTA_LOTE
            End If

        Case CGTA_LOTE
            If Trim(vsfTarjetas_Credito.EditText) = "" Then
                MsgBox "El Código de Lote de la Tarjeta no puede estar Vacio", vbCritical, MsgTit
                Cancel = True
            Else
                vsfTarjetas_Credito.Select Row, CGTA_MONEDA
            End If


        Case CGTA_MONEDA

            If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                MsgBox "El Código de la Moneda debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                If Not Buscar_Moneda(vsfTarjetas_Credito.EditText, M) Then
                    MsgBox "Moneda Inexistente", vbCritical, MsgTit
                    Cancel = True
                Else
                    vsfTarjetas_Credito.TextMatrix(Row, CGTA_SIMBOLO) = Trim(M!simbolo)
                    vsfTarjetas_Credito.Select Row, CGTA_IMPORTE
                End If
            End If

        Case CGTA_IMPORTE
            If Not IsNumeric(vsfTarjetas_Credito.EditText) Then
                MsgBox "El Importe de la Tarjeta debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                'AIR 20171013 agregue validacion al final de la linea porque si pasan con la flecha no se estan validando algunos datos
                If val(vsfTarjetas_Credito.EditText) = 0 Or _
                    (vsfTarjetas_Credito.TextMatrix(Row, CGTA_LOTE)) = "" Or _
                    (vsfTarjetas_Credito.TextMatrix(Row, CGTA_CUOTAS)) = "" Or _
                    (vsfTarjetas_Credito.TextMatrix(Row, CGTA_MEDIO_PAGO)) = "" Then

                    MsgBox "Faltan ingresar datos en la tarjeta (Tarjeta o Lote o Cuotas o Importe)", vbCritical, MsgTit
                    Cancel = True

                Else
                    If vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Row + 1 Then      ' SS 20160204

                        vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Rows + 1
                        vsfTarjetas_Credito.Row = vsfTarjetas_Credito.Row + 1
                    End If
                End If
                'vsfTarjetas_Credito.Rows = vsfTarjetas_Credito.Rows + 1
                vsfTarjetas_Credito.Select vsfTarjetas_Credito.Row, CGTA_MEDIO_PAGO
            End If

    End Select

Exit Sub

Errores:
    MsgBox "Ha ocurrido un error, Verifique", vbInformation, MsgTit
    Exit Sub

End Sub

Public Function Alta_Tarjetas_Ingresadas() As Boolean
Dim lstrSQL As String
Dim i As Long
Dim lstrNombre_PC As String

On Error GoTo Errores

    Alta_Tarjetas_Ingresadas = True
 
    For i = 1 To vsfTarjetas_Credito.Rows - 1

        If Trim(vsfTarjetas_Credito.TextMatrix(i, CGTA_MEDIO_PAGO)) <> "" Then
        
           lstrNombre_PC = Left(Trim(NombrePC()), Len(Trim(NombrePC)) - 1)
        
           lstrSQL = "INSERT INTO Faccmp_Baucher_TCredito "
           lstrSQL = Trim(lstrSQL) & " (cod_emp,cod_doc,nro_doc,cod_prov,linea,caja,nro_rollo,usuario,fec_reg,hora,cod_mpago,"
           lstrSQL = Trim(lstrSQL) & " importe,moneda,tipo_operacion,tipo_autorizacion,tipo_lectura,descripcion_tarjeta,nro_tarjeta,"
           lstrSQL = Trim(lstrSQL) & " titular,fec_vencimiento,nro_plan,cuotas,autorizacion,lote,nro_ticket,id_comercio,id_terminal,nro_doc_original,"
           lstrSQL = Trim(lstrSQL) & " MontoImp,DevIVATexto,MontoImpTexto,ModoLecturaTexto,TipoCuenta,NumeroCuenta,EMVApNombre,"
           lstrSQL = Trim(lstrSQL) & " TextoAdicional,ImpTitular)"
           lstrSQL = Trim(lstrSQL) & " VALUES ("
           lstrSQL = Trim(lstrSQL) & val(txtEmpresa.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtCodDoc.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtDoc.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtCodProv.text) & ","
           lstrSQL = Trim(lstrSQL) & i & ","
           lstrSQL = Trim(lstrSQL) & ConfPuntoVta_Nro_Caja & ","
           lstrSQL = Trim(lstrSQL) & 0 & ",'"
           lstrSQL = Trim(lstrSQL) & Trim(UCase(gUsuario)) & "',"
           lstrSQL = Trim(lstrSQL) & f_Fecha_Base(date, Conf_Motor_Base) & ","
           lstrSQL = Trim(lstrSQL) & f_Hora_Base(time, Conf_Motor_Base) & ","
           lstrSQL = Trim(lstrSQL) & vsfTarjetas_Credito.TextMatrix(i, CGTA_MEDIO_PAGO) & ","
           lstrSQL = Trim(lstrSQL) & CDbl(NullToZero(vsfTarjetas_Credito.TextMatrix(i, CGTA_IMPORTE))) & ","
           lstrSQL = Trim(lstrSQL) & vsfTarjetas_Credito.TextMatrix(i, CGTA_MONEDA) & ","
           lstrSQL = Trim(lstrSQL) & "0" & ",'"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & Left(Trim(vsfTarjetas_Credito.TextMatrix(i, CGTA_DESCRIPCION)), 50) & "','"
           lstrSQL = Trim(lstrSQL) & Left(Trim(vsfTarjetas_Credito.TextMatrix(i, CGTA_NUMERO)), 50) & "','"
           lstrSQL = Trim(lstrSQL) & Left(Trim(vsfTarjetas_Credito.TextMatrix(i, CGTA_NOMBRE_TITULAR)), 50) & "','"
           lstrSQL = Trim(lstrSQL) & vsfTarjetas_Credito.TextMatrix(i, CGTA_FECHA_VTO) & "',"
           lstrSQL = Trim(lstrSQL) & "0" & ","
           lstrSQL = Trim(lstrSQL) & val(vsfTarjetas_Credito.TextMatrix(i, CGTA_CUOTAS)) & ",'"
           lstrSQL = Trim(lstrSQL) & Left(Trim(vsfTarjetas_Credito.TextMatrix(i, CGTA_AUTORIZACION)), 50) & "',"
           lstrSQL = Trim(lstrSQL) & val(vsfTarjetas_Credito.TextMatrix(i, CGTA_LOTE)) & ","
           lstrSQL = Trim(lstrSQL) & val(txtDoc.text) & ",'"
           lstrSQL = Trim(lstrSQL) & val(txtEmpresa.text) & "','"
           lstrSQL = Trim(lstrSQL) & lstrNombre_PC & "',"
           lstrSQL = Trim(lstrSQL) & "0" & ","
           lstrSQL = Trim(lstrSQL) & "0" & ",'"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "','"
           lstrSQL = Trim(lstrSQL) & "" & "')"
            
           Dbs.Execute lstrSQL
        End If
    Next i

Exit Function

Errores:
    Call FErrores
    Alta_Tarjetas_Ingresadas = False

End Function

Function Guardar_Lineas_Pendientes(ltxtTipo As String, lSignoDocumento As Long) As Boolean

Dim lrstFactPend As Recordset

Dim lstrSQL As String
Dim i As Long
Dim lintLinea As Integer
Dim lintLinOrig As Integer
Dim lintLinRef As Integer
Dim llngCodDocRef As Long
Dim llngNroDocRef As Long
Dim ldblCantidad As Double

On Error GoTo Errores

Guardar_Lineas_Pendientes = True

' ltxtTipo = O  ORIGINAL
' ltxtTipo = R  REFERENCIA
' ltxtTipo = N  NOTA DE CREDITO REFERENCIADA A FACTURA PERTENECIENTE AL CIRCUITO DE PENDIENTES (pero, no se ingreso por F10)

lintLinea = 0
For i = 1 To vsfLineas_Mercaderia.Rows - 1
    If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
 
        lintLinea = lintLinea + 1
        
        If ltxtTipo = "O" Then
            'Graba documento original
            lintLinOrig = lintLinea
            llngCodDocRef = CLng(txtCodDoc.text)
            llngNroDocRef = CLng(txtDoc.text)
            lintLinRef = lintLinea
            If confUsaEquivalenciaMagnitudes Then
                ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES_MAGNITUD))
            Else
                ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES))
            End If
        Else
            If ltxtTipo = "R" Then
                'Graba documento referencia
                lintLinOrig = lintLinea
                llngCodDocRef = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_COD_DOC_REF))
                llngNroDocRef = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_DOC_REF))
                lintLinRef = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_LINEA_REF))
                If confUsaEquivalenciaMagnitudes Then
                    ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES_MAGNITUD)) * lSignoDocumento
                Else
                    ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) * lSignoDocumento
                End If
                
            Else
            
                'Veo si la factura de referencia y el articulo, esta en el circuito de pendientes y si tiene saldo  'SS 20180725
                SQL = "SELECT sum(cant_prod) AS TotCant FROM FaccmpLineas_Pendientes "
                SQL = SQL & " INNER JOIN Faccmp ON Faccmp.cod_emp = FaccmpLineas_Pendientes.cod_emp "
                SQL = SQL & " AND faccmp.cod_doc = FaccmpLineas_Pendientes.cod_doc "
                SQL = SQL & " AND faccmp.nro_doc = FaccmpLineas_Pendientes.nro_doc "
                SQL = SQL & " AND faccmp.cod_prov = FaccmpLineas_Pendientes.cod_prov "
                SQL = SQL & " WHERE cod_doca = " & val(txtDoc_Afectado.text)
                SQL = SQL & " AND   nro_doca = " & val(txtNro_Doc_Afectado.text)
                SQL = SQL & " AND   cod_prova = " & val(txtCodProv.text)
                SQL = SQL & " AND   nro_lineaa = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_LINEA))
                SQL = SQL & " AND   cod_proda = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                SQL = SQL & " AND   faccmp.autorizado = 'S'"
                
                Set lrstFactPend = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                If NullToZero(lrstFactPend!TotCant) <> 0 Then
                    
                    'Tiene saldo, se graba movimiento en pendientes
                    lintLinOrig = lintLinea
                    llngCodDocRef = val(txtDoc_Afectado.text)
                    llngNroDocRef = val(txtNro_Doc_Afectado.text)
                    lintLinRef = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_LINEA))
                    If CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) > lrstFactPend!TotCant Then   'resta como maximo lo que tiene pendiente (saldo)
                        ldblCantidad = lrstFactPend!TotCant * lSignoDocumento
                    Else
                        ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) * lSignoDocumento
                    End If
                Else
                    llngCodDocRef = 0
                End If
                
               'AIR 20211206 este seria el caso de una nota de credito que afecta una factura que afecta otro doc por el circuito de F10
                ' esto ya se analizo varias veces y no se puede hacer automaticamente poraqui porque podemos estar levantando entregas que ya fueron liquidadas
                ' y la razon por la que se hace n.c. es por temas financieron, dsctos etc y no porque la mercaderia no se haya entregado.
                '
                
'               If llngCodDocRef = 0 Then
'                  '  Veo si la factura de referencia y el articulo, esta en el circuito de pendientes para el documento original (el 1ero del circuito)
'                    SQL = "SELECT * FROM FaccmpLineas_Pendientes "
'                    SQL = SQL & " WHERE cod_doc = " & Val(txtDoc_Afectado.text)
'                    SQL = SQL & " AND   nro_doca = " & Val(txtNro_Doc_Afectado.text)
'                    SQL = SQL & " AND   cod_prova = " & Val(txtCodProv.text)
'                    SQL = SQL & " AND   cod_proda = " & Val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
'                    SQL = SQL & " AND   cod_doc = cod_doca AND nro_doc = nro_doca"
'
'                    Set lrstFactPend = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
'                    If Not lrstFactPend.EOF Then
'
'                  '      Graba documento referencia, viene del ingreso de una nota de credito que referencio a factura
'                        lintLinOrig = lintLinea
'                        llngCodDocRef = lrstFactPend!cod_doca
'                        llngNroDocRef = lrstFactPend!nro_doca
'                        lintLinRef = lrstFactPend!nro_lineaa
'                        ldblCantidad = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) * lSignoDocumento
'                    Else
'                        llngCodDocRef = 0
'                    End If
'                End If
                
            End If
        End If
        
        If llngCodDocRef <> 0 Then
            lstrSQL = "INSERT INTO FaccmpLineas_Pendientes (cod_emp, cod_doc, nro_doc, cod_prov, nro_linea, cod_prod, "
            lstrSQL = lstrSQL & " cod_doca, nro_doca, cod_prova, nro_lineaa, cod_proda, cant_prod, fec_reg, usuario)"
            lstrSQL = lstrSQL & " VALUES ("
            lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","                                         ' cod_emp
            lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","                                          ' cod_doc
            lstrSQL = lstrSQL & CLng(txtDoc.text) & ","                                             ' nro_doc
            lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","                                         ' cod_prov
            lstrSQL = lstrSQL & lintLinOrig & ","                                                   ' nro_linea
            lstrSQL = lstrSQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ","           ' cod_prod
            lstrSQL = lstrSQL & llngCodDocRef & ","                                                 ' cod_doca
            lstrSQL = lstrSQL & llngNroDocRef & ","                                                 ' nro_doca
            lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","                                         ' cod_prova
            lstrSQL = lstrSQL & lintLinRef & ","                                                    ' nro_lineaa
            lstrSQL = lstrSQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ","           ' cod_proda
            lstrSQL = lstrSQL & ldblCantidad & ","                                                  ' cant_prod
            lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fec_reg
            lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "')"                                        ' usuario
            Dbs.Execute lstrSQL
        End If
    End If
Next
 
Exit Function

Errores:
    Guardar_Lineas_Pendientes = False
    Exit Function

End Function

Function Guardar_Acopio_Relacionado() As Boolean

Dim lrstFactPend As Recordset
Dim D As Recordset      ' AIR 20250411
Dim A As Recordset      ' AIR 20250411
Dim lrstDocsPend  As Recordset

Dim lstrSQL As String
Dim i As Long
Dim lintLinea As Integer
Dim lintLinOrig As Integer
Dim lintLinRef As Integer
Dim llngCodDocRef As Long
Dim llngNroDocRef As Long
Dim ldblCantidad As Double
Dim lstrlista_campos As String

On Error GoTo Errores

'AIR 20250414
Guardar_Acopio_Relacionado = True

If Not ConfControla_Saldo_Cantidad_Por_Documento Then
    Exit Function
End If
            
lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
lstrSQL = lstrSQL & " WHERE cod_doc_valido =" & CLng(txtCodDoc.text)
lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)

If Not lrstDocsPend.EOF Then
    ' ALTA el documento original no corresponde este proceso
    Exit Function
End If

            
'AIR 20250409 / AIR 20250411
If txtAcopio.text <> "" Then
    '  Veo si la factura de referencia y el articulo, esta en el circuito de pendientes para el documento original (el 1ero del circuito)
    
    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        If D!cod_doc_aso <> 0 Then
            If Buscar_Documento(CLng(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), A) Then
                                  
                lstrlista_campos = "cod_emp,cod_doc,nro_doc,cod_prov,nro_int,fec_reg,fec_doc,fec_valor,fec_ent,iva_bas,iva_min,fec_venc,importe," & _
                "dto_global,redondeo,fec_trans,usuario,con_sin_iva,cod_suc,observa,cofisbas,cofismin,cofisexento,autorizado,lleva_cofis,nom_cli,ruc,forma_pago," & _
                "seccion,moneda,tipo_cambio,importe_base,importe_ref,redondeo_base,redondeo_ref,nro_rollo,hora,nro_ven,caja,importe_calculado_x_sistema"
                
                SQL = "INSERT INTO FACCMP ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM FACCMP "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                
                lstrlista_campos = "Cod_Emp,cod_doc,nro_doc,Cod_Prov,direccion,telefono,Tecnico,fecha_recepcion,hora_recepcion,hora_entrega,detalle,fec_reg,usuario,hora_recepcion_string,"
                lstrlista_campos = lstrlista_campos & "hora_entrega_string,Turno,cod_doc_afectado,nro_doc_afectado,tipo_doc_identidad,cod_doc_pedido,nro_doc_pedido,deposito,deposito_destino,"
                lstrlista_campos = lstrlista_campos & "cod_banco,sucursal,tipo_cuenta,moneda,numero_cuenta,contrato,cod_pais,cod_departamento,cod_ciudad,cierre_vendedor,cierre_general,"
                lstrlista_campos = lstrlista_campos & "version_movil,latitud,longitud,LugarDestEntRecep,NroIdCompra,tarea_cod_doc,tarea_nro_doc,nro_proceso,clauvta,viatransporte,pais"
                
                SQL = "INSERT INTO Faccmp_Cabezal_Auxiliar ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, ",cod_doc,", "," & D!cod_doc_aso & ",")
                lstrlista_campos = Replace(lstrlista_campos, ",cod_doc_afectado,", "," & "0,")
                lstrlista_campos = Replace(lstrlista_campos, ",nro_doc_afectado,", "," & "0,")
                
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM Faccmp_Cabezal_Auxiliar "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                                    
                 
                lstrlista_campos = " cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_prod,cant_prod,precio,descuento1,descuento2,nom_prod_aux,cajas,descuento3,seccion," & _
                " moneda,tipo_cambio,precio_base,precio_ref,tipo_linea,forma_pago,tipo_entrega"
                
                SQL = "INSERT INTO FaccmpLineas  ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM FaccmpLineas "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                 
                 
                lstrlista_campos = " cod_emp,cod_doc,nro_doc,cod_prov,cod_tipo_impuesto,cod_impuesto,imp_sin_impuestos,porcentaje,importe,moneda,tipo_cambio,importe_simp_base,importe_simp_ref,importe_base,importe_ref "
                
                SQL = "INSERT INTO Faccmpimpuestos  ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM Faccmpimpuestos "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                
                
                lstrlista_campos = " cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general"
                SQL = "INSERT INTO Faccmpmpagos  ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM Faccmpmpagos "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                
                lstrlista_campos = "cod_emp,cod_doc,nro_doc,cod_prov,cod_acopio,fec_reg,usuario,ci_persona_autorizada"
                SQL = "INSERT INTO Faccmp_Acopios ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM Faccmp_Acopios "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                         
                         
                lstrlista_campos = "cod_emp, cod_doc, nro_doc, cod_prov, nro_linea, cod_prod,cod_doca, nro_doca, cod_prova, nro_lineaa, cod_proda, cant_prod, fec_reg, usuario "
                SQL = "INSERT INTO FaccmpLineas_Pendientes  ("
                SQL = SQL & lstrlista_campos & ")"
                lstrlista_campos = Replace(lstrlista_campos, "cod_doc,", D!cod_doc_aso & ",")
                lstrlista_campos = Replace(lstrlista_campos, "cod_doca,", D!cod_doc_aso & ",")
                lstrlista_campos = Replace(lstrlista_campos, "nro_doca,", txtDoc.text & ",")
                lstrlista_campos = Replace(lstrlista_campos, "cant_prod,", " cant_prod* (-1),")
                
                SQL = SQL & " SELECT " & lstrlista_campos
                SQL = SQL & " FROM FaccmpLineas_Pendientes "
                SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc  = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                Dbs.Execute SQL
                                
                
                Call Alta_Documento_Relacionado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), D!cod_doc_aso, val(txtDoc.text), val(txtCodProv.text), False)
            
            End If
        End If
    End If
End If
        
Exit Function

Errores:
    Guardar_Acopio_Relacionado = False
    Exit Function

Resume
End Function


Sub Buscar_Lineas_Pendientes(pcod_Emp As Long, pCod_Doc As Long, pNro_Doc As Long, pCod_Prov As Long, pnro_linea As Long, _
            pCod_Prod As Long, ByRef pCod_Doc_Ref As Long, ByRef pNro_Doc_Ref As Long, ByRef pNro_Linea_Ref As Long, _
            ByRef pCantidad_Saldo As Double, ByRef pCantidad_Entregada As Double)
            
Dim lstrSQL As String
Dim lrstLinPendientes As Recordset

On Error GoTo Errores

    lstrSQL = "SELECT cod_doca, nro_doca, nro_lineaa, cant_prod FROM FaccmpLineas_Pendientes "
    lstrSQL = lstrSQL & " WHERE cod_emp = " & pcod_Emp
    lstrSQL = lstrSQL & " AND   cod_doc = " & pCod_Doc
    lstrSQL = lstrSQL & " AND   nro_doc = " & pNro_Doc
    lstrSQL = lstrSQL & " AND   cod_prov = " & pCod_Prov
    lstrSQL = lstrSQL & " AND   nro_linea = " & pnro_linea
    lstrSQL = lstrSQL & " AND   cod_prod = " & pCod_Prod
    lstrSQL = lstrSQL & " AND   cod_doc <> cod_doca AND nro_doc <> nro_doca"

    Set lrstLinPendientes = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    If Not lrstLinPendientes.EOF Then
        pCod_Doc_Ref = lrstLinPendientes!cod_doca
        pNro_Doc_Ref = lrstLinPendientes!nro_doca
        pNro_Linea_Ref = lrstLinPendientes!nro_lineaa
        pCantidad_Saldo = Abs(lrstLinPendientes!Cant_Prod)
        pCantidad_Entregada = 0
    Else
        pCod_Doc_Ref = 0
        pNro_Doc_Ref = 0
        pNro_Linea_Ref = 0
        pCantidad_Saldo = 0
        pCantidad_Entregada = 0
    End If
    
    lrstLinPendientes.Close

Exit Sub

Errores:
    Exit Sub

End Sub

Function Listar_Solo_Cabezales_con_Seccion(pstrTipo_Reporte As String, pstrCon_RUT As String, pstrCon_Control_Redondeo As String, pstrTitulo As String)

    Dim lParametro As String
    Dim lrst_cab As Recordset
    Dim lrst_lin As Recordset
    Dim lrst_det As Recordset
    Dim D As Recordset
    Dim lLineas As Long
    Dim pSigno_Documento As Integer
    Dim ldblTotalDetalleServicio As Double
    
    ' Seteo los Campos para los Filtros
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Documento"
    gfiltros_nombre_campo(3) = "Tipo Documento (M-ercadería  S-ervicio)"
    gfiltros_nombre_campo(4) = "Número"
    gfiltros_nombre_campo(5) = "Cliente"
    gfiltros_nombre_campo(6) = "Fecha Documento"
    gfiltros_nombre_campo(7) = "Fecha Cble."
    gfiltros_nombre_campo(8) = "Fecha Entrega"
    gfiltros_nombre_campo(9) = "Sección"
    gfiltros_nombre_campo(10) = "Forma de Pago"
    gfiltros_nombre_campo(11) = "Moneda"
    gfiltros_nombre_campo(12) = "Observacion"
    gfiltros_nombre_campo(13) = "Autorizado"
    gfiltros_nombre_campo(14) = "Redondeo"
    gfiltros_nombre_campo(15) = "Importe"
    gfiltros_nombre_campo(16) = "Guía"
    gfiltros_nombre_campo(17) = "Fecha Registro"
    gfiltros_nombre_campo(18) = "Usuario"
    gfiltros_nombre_campo(19) = "Sección en Detalle Servicio"


    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_doc"
    gfiltros_campo(3) = "Documentos.mueve_merca_serv"
    gfiltros_campo(4) = "Faccmp.nro_doc"
    gfiltros_campo(5) = "Faccmp.cod_prov"
    gfiltros_campo(6) = "Faccmp.fec_doc"
    gfiltros_campo(7) = "Faccmp.fec_valor"
    gfiltros_campo(8) = "Faccmp.fec_ent"
    gfiltros_campo(9) = "Faccmp.seccion"
    gfiltros_campo(10) = "Faccmp.forma_pago"
    gfiltros_campo(11) = "Faccmp.moneda"
    gfiltros_campo(12) = "Faccmp.observa"
    gfiltros_campo(13) = "Faccmp.autorizado"
    gfiltros_campo(14) = "Faccmp.redondeo"
    gfiltros_campo(15) = "Faccmp.importe"
    gfiltros_campo(16) = "Faccmp.cofisexento"
    gfiltros_campo(17) = "Faccmp.fec_reg"
    gfiltros_campo(18) = "Faccmp.usuario"
    gfiltros_campo(19) = "Detalle.seccion"


    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "C"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "N"
    gfiltros_tipo_campo(6) = "F"
    gfiltros_tipo_campo(7) = "F"
    gfiltros_tipo_campo(8) = "F"
    gfiltros_tipo_campo(9) = "N"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "N"
    gfiltros_tipo_campo(12) = "C"
    gfiltros_tipo_campo(13) = "C"
    gfiltros_tipo_campo(14) = "N"
    gfiltros_tipo_campo(15) = "N"
    gfiltros_tipo_campo(16) = "N"
    gfiltros_tipo_campo(17) = "F"
    gfiltros_tipo_campo(18) = "C"
    If pstrTipo_Reporte = "SD" Then
        gfiltros_tipo_campo(19) = "N"
    End If

    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    ' Seteo los Defectos del Orden a Listar
    
    
        gelejir_orden_descripcion(1) = "Documento"
        gelejir_orden_descripcion(2) = "Número"
        gelejir_orden_descripcion(3) = "Cliente"
        gelejir_orden_descripcion(4) = "Fecha Documento"
        gelejir_orden_descripcion(5) = "Fecha Cble."
        gelejir_orden_descripcion(6) = "Fecha Entrega"
        gelejir_orden_descripcion(7) = "Sección"
        gelejir_orden_descripcion(8) = "Forma Pago"
        gelejir_orden_descripcion(9) = "Redondeo"
        gelejir_orden_descripcion(10) = "Importe"
        gelejir_orden_descripcion(11) = "Fecha Registro"
        gelejir_orden_descripcion(12) = "Usuario"
        
        gelejir_orden_campo(1) = "zT_Inf_Docs_Digitados_R.cod_doc"
        gelejir_orden_campo(2) = "zT_Inf_Docs_Digitados_R.nro_doc"
        gelejir_orden_campo(3) = "zT_Inf_Docs_Digitados_R.cod_prov"
        gelejir_orden_campo(4) = "zT_Inf_Docs_Digitados_R.fec_doc"
        gelejir_orden_campo(5) = "zT_Inf_Docs_Digitados_R.fec_asiento"
        gelejir_orden_campo(6) = "zT_Inf_Docs_Digitados_R.fec_ent"
        gelejir_orden_campo(7) = "zT_Inf_Docs_Digitados_R.seccion"
        gelejir_orden_campo(8) = "zT_Inf_Docs_Digitados_R.forma_pago"
        gelejir_orden_campo(9) = "zT_Inf_Docs_Digitados_R.redondeo"
        gelejir_orden_campo(10) = "zT_Inf_Docs_Digitados_R.importe"
        gelejir_orden_campo(11) = "zT_Inf_Docs_Digitados_R.fec_reg"
        gelejir_orden_campo(12) = "zT_Inf_Docs_Digitados_R.usuario"
        
        gelejir_orden_orden(1) = 1
        gelejir_orden_orden(2) = 2
        gelejir_orden_orden(3) = 3
        
        gelejir_orden_tipo(1) = "A"
        gelejir_orden_tipo(2) = "A"
        gelejir_orden_tipo(3) = "A"
    
        frmElejir_Orden_para_Listar.Show (1)
        lbolCancelar_Listado = frmElejir_Orden_para_Listar.pbolCancelar_Listado
    
        DoEvents
        
        
        If frmElejir_Orden_para_Listar.pbolCancelar_Listado Then
            Exit Function
        End If

        'If lbolCancelar_Listado Then
        '    Exit Function
        'End If
    
    
     If Elejir_Tipo_Moneda_del_Reporte("O") Then
        Exit Function
    End If
    
    
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    ' Tabla Temporal del Reporte
    gNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
    
    Call Borra_Tabla_Temporal(gNombre_Tabla_Temporal)
    
    
    ' Creo Tabla Temporal Base
    SQL = "Select * Into " & Trim(gNombre_Tabla_Temporal) & " From zT_Inf_Docs_Digitados_R where 1=0"
    Dbs.Execute SQL
 
    SQL = "Create index id1" & Trim(gNombre_Tabla_Temporal) & " on " & Trim(gNombre_Tabla_Temporal) & " (cod_emp,cod_doc,nro_doc,cod_prov)"
    Dbs.Execute SQL
'
'     SQL = "SELECT Faccmp.* FROM Faccmp,documentos,vista_titulares "
'    'SQL = SQL & " ,FaccmpServicios Detalle "
'     SQL = SQL & " WHERE Faccmp.cod_doc = documentos.cod_doc"
'     SQL = SQL & " AND Faccmp.cod_prov = vista_titulares.codigo"
'  '  SQL = SQL & " AND Detalle.cod_emp = Faccmp.cod_emp "
'  '  SQL = SQL & " AND Detalle.cod_doc = Faccmp.cod_doc "
' '   SQL = SQL & " AND Detalle.nro_doc = Faccmp.nro_doc "
'  '  SQL = SQL & " AND Detalle.cod_prov = Faccmp.cod_prov "
'
    ' AIR 20171010 se descomentaron las lineas que aparecieron comentadas porque este reporte se usaba para Hertz para que sacaran el detallado de ventas de servicio por seccion en la linea.
    ' aparecieron comentadas estas lineas al parecer quisieron incluir las lineas de la faccmplineas pero como tienen distinta estructura que la faccmpservicios daba error mas adelante la generacion
    
    SQL = "SELECT Faccmp.* FROM Faccmp,documentos,vista_titulares "
    If pstrTipo_Reporte = "SD" Then
        SQL = SQL & " , FaccmpServicios Detalle "
    End If
    SQL = SQL & " WHERE Faccmp.cod_doc = documentos.cod_doc"
    SQL = SQL & " AND Faccmp.cod_prov = vista_titulares.codigo"
    
    If pstrTipo_Reporte = "SD" Then
        SQL = SQL & " AND Detalle.cod_emp = Faccmp.cod_emp "
        SQL = SQL & " AND Detalle.cod_doc = Faccmp.cod_doc "
        SQL = SQL & " AND Detalle.nro_doc = Faccmp.nro_doc "
        SQL = SQL & " AND Detalle.cod_prov = Faccmp.cod_prov "
    End If
    
    SQL = SQL & " AND (documentos.tipo_doc IN ('E','R','I') Or (documentos.tipo_doc = 'P' And documentos.signo = 1)) and vista_titulares.tipo='C'"
    
    If Trim(UCase(pstrCon_Control_Redondeo)) = "S" Then
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & " AND ABS(redondeo_base) >= " & confRedondeo_Tope
            Case "R"
                SQL = SQL & " AND ABS(redondeo_ref) >= " & confRedondeo_Tope
            Case "O"
                SQL = SQL & " AND ABS(Redondeo) >= " & confRedondeo_Tope
        End Select
    End If
    
    If pstrTipo_Reporte = "SD" Then
        SQL = SQL & " AND documentos.mueve_merca_serv='S'"
    End If
    If Trim(lstrFiltros) <> "" Then
        SQL = Trim(SQL) & "  and " & Trim(lstrFiltros)
    End If
    
    Set lrst_cab = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not lrst_cab.EOF
    DoEvents
    
      If Buscar_Tipo_Documento(lrst_cab!cod_doc, D) Then
        pSigno_Documento = D!signo
        
        SQL = "Select count(*) as lineas From  " & IIf(D!mueve_merca_serv = "S", "FaccmpServicios ", "FaccmpLineas ")
        SQL = SQL & " Where cod_emp = " & lrst_cab!Cod_Emp
        SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
        SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
        SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
        SQL = SQL & " Group by cod_emp,cod_doc,nro_doc,cod_prov"
        
        Set lrst_lin = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If lrst_lin.EOF Then
            lLineas = 0
        Else
            lLineas = IIf(IsNull(lrst_lin!Lineas), 0, lrst_lin!Lineas)
        End If
                        
        If pstrTipo_Reporte = "SD" Then
            ldblTotalDetalleServicio = 0
            
            SQL = "Select Detalle.* From  " & IIf(D!mueve_merca_serv = "S", "FaccmpServicios ", "FaccmpLineas ")
            SQL = SQL & " Detalle, Faccmp Where Detalle.cod_emp = " & lrst_cab!Cod_Emp
            SQL = SQL & " AND Detalle.cod_doc = " & lrst_cab!cod_doc
            SQL = SQL & " AND Detalle.nro_doc = " & lrst_cab!nro_doc
            SQL = SQL & " AND Detalle.cod_prov = " & lrst_cab!Cod_Prov
            SQL = SQL & " AND Detalle.cod_emp = Faccmp.cod_emp "
            SQL = SQL & " AND Detalle.cod_doc = Faccmp.cod_doc "
            SQL = SQL & " AND Detalle.nro_doc = Faccmp.nro_doc "
            SQL = SQL & " AND Detalle.cod_prov = Faccmp.cod_prov "
            If Trim(lstrFiltros) <> "" Then
                SQL = Trim(SQL) & "  AND " & Trim(lstrFiltros)
            End If
            SQL = SQL & " ORDER BY Detalle.nro_linea "
            
            Set lrst_det = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            Do While Not lrst_det.EOF
        
                SQL = "Insert into " & gNombre_Tabla_Temporal
                SQL = SQL & " values ("
                SQL = SQL & lrst_cab!Cod_Emp & ","
                SQL = SQL & lrst_cab!cod_doc & ","
                SQL = SQL & lrst_cab!nro_doc & ","
                SQL = SQL & lrst_cab!Cod_Prov & ","
                SQL = SQL & lrst_det!nro_linea & ","
                SQL = SQL & f_Fecha_Base(lrst_cab!fec_doc, Conf_Motor_Base) & ","
                SQL = SQL & f_Fecha_Base(lrst_cab!fec_valor, Conf_Motor_Base) & ","
                SQL = SQL & f_Fecha_Base(lrst_cab!fec_ent, Conf_Motor_Base) & ","
                SQL = SQL & pSigno_Documento * Importe_Neto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, lrst_det!tiva, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) & ","
                SQL = SQL & "0,"
                SQL = SQL & pSigno_Documento * Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 2, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) & ","
                SQL = SQL & "0,"
                SQL = SQL & pSigno_Documento * Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 3, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) & ","
                SQL = SQL & 0 & ","
                SQL = SQL & 0 & ","
                SQL = SQL & 0 & ","
                SQL = SQL & IIf(IsNull(lrst_cab!dto_global), 0, lrst_cab!dto_global) & ","
                
                Select Case gTipo_Moneda
                    Case "B"
                        SQL = SQL & "0" & ","
                    Case "R"
                        SQL = SQL & "0" & ","
                    Case "O"
                        SQL = SQL & "0" & ","
                End Select
                
                
                SQL = SQL & (Importe_Neto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, lrst_det!tiva, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) _
                 + Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 2, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) _
                 + Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 3, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) _
                 + Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 5, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda)) * pSigno_Documento & ","
                'Select Case gTipo_Moneda
                '    Case "B"
                '        SQL = SQL & lrst_cab!Importe_Base * pSigno_Documento & ","
                '    Case "R"
                '        SQL = SQL & lrst_cab!importe_ref * pSigno_Documento & ","
                '    Case "O"
                '        SQL = SQL & lrst_cab!importe * pSigno_Documento & ","
                'End Select
                
                SQL = SQL & IIf(IsNull(lrst_cab!forma_pago), 0, lrst_cab!forma_pago) & ","
                SQL = SQL & IIf(IsNull(lrst_det!seccion), 0, lrst_det!seccion) & ","
                SQL = SQL & f_Fecha_Base(lrst_cab!fec_reg, Conf_Motor_Base) & ",'"
                SQL = SQL & lrst_cab!usuario & "',"
                SQL = SQL & "0,"
                SQL = SQL & pSigno_Documento * Importe_X_Impuesto_Linea_Servicios(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, lrst_det!nro_linea, 2, lrst_cab!con_Sin_iva, lrst_cab!fec_doc, gTipo_Moneda) & ","
                SQL = SQL & lrst_cab!moneda & ",0,"
                SQL = SQL & "'" & Mid(Trim(lrst_cab!observa), 1, 99) & "',0,0,'"
                SQL = SQL & lrst_cab!nom_cli & "',"
                SQL = SQL & "0,'S')"                    ' agrega campo de dscto en tabla para reporte    SS 20150817
                                                        ' AIR 20171010 faltaba el ultimo campo supongo que es un campo nuevo en la temporal
                Dbs.Execute SQL
                lrst_det.MoveNext
            Loop
            lrst_det.Close
        Else
        
        End If
        lrst_lin.Close
        
        lrst_cab.MoveNext
      End If
    Wend
    lrst_cab.Close
    
    Call esperar_segundos(4)
    
    Call Inicializo_Control_Crystal(CrystalReport1)
    
    Select Case pstrTipo_Reporte
    
        Case "S", "SD" ' x SECCION
                
            If gTipo_Moneda = "B" Or gTipo_Moneda = "R" Then
        
                CrystalReport1.sqlQuery = " SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.nro_doc, zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.lineas, zT_Inf_Docs_Digitados_R.fec_doc, "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.fec_asiento, zT_Inf_Docs_Digitados_R.fec_ent, zT_Inf_Docs_Digitados_R.neto_exento, zT_Inf_Docs_Digitados_R.iva_min, zT_Inf_Docs_Digitados_R.iva_bas,"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cofis_exento, zT_Inf_Docs_Digitados_R.cofis_min, zT_Inf_Docs_Digitados_R.cofis_bas, "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.dto_global, zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe,zT_Inf_Docs_Digitados_R.seccion, zT_Inf_Docs_Digitados_R.iva_vac,"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Clientes.rsocial_cli,Empresas.descripcion, Secciones.descripcion, Moneda_Base.descripcion "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "From  ((((" & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN  Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo) "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Secciones ON zT_Inf_Docs_Digitados_R.seccion = Secciones.codigo) "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Referencia ON Empresas.moneda_referencia = Moneda_Referencia.codigo)"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Monedas Moneda_Base ON Empresas.moneda = Moneda_Base.codigo)"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Clientes ON zT_Inf_Docs_Digitados_R.cod_prov = clientes.nro_cli "
                'CrystalReport1.SQLQuery = CrystalReport1.SQLQuery & " Order By zT_Inf_Docs_Digitados_R.cod_emp ASC,zT_Inf_Docs_Digitados_R.seccion ASC"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By zT_Inf_Docs_Digitados_R.seccion ASC"
            
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & _
                                                "," & Trim(gString_Orden)
                End If
                                                     
                lParametro = "parUsuario;" & gUsuario & ";TRUE"
                CrystalReport1.ParameterFields(0) = lParametro
            
                lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
                CrystalReport1.ParameterFields(1) = lParametro
            
                lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
                CrystalReport1.ParameterFields(2) = lParametro
                
                lParametro = "parMoneda;" & Trim(gTipo_Moneda) & ";TRUE"
                CrystalReport1.ParameterFields(3) = lParametro
                                    
                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Digitados_Resumido_X_Seccion_Clientes.rpt"
                CrystalReport1.Destination = 0
                lresult = CrystalReport1.PrintReport
        
            End If
            
            If gTipo_Moneda = "O" Then
        
                CrystalReport1.sqlQuery = " SELECT zT_Inf_Docs_Digitados_R.cod_emp, zT_Inf_Docs_Digitados_R.cod_doc, zT_Inf_Docs_Digitados_R.nro_doc, zT_Inf_Docs_Digitados_R.cod_prov, zT_Inf_Docs_Digitados_R.lineas, zT_Inf_Docs_Digitados_R.fec_doc, "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.fec_asiento, zT_Inf_Docs_Digitados_R.fec_ent, zT_Inf_Docs_Digitados_R.neto_exento, zT_Inf_Docs_Digitados_R.iva_min, zT_Inf_Docs_Digitados_R.iva_bas,"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.cofis_exento, zT_Inf_Docs_Digitados_R.cofis_min, zT_Inf_Docs_Digitados_R.cofis_bas, "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "zT_Inf_Docs_Digitados_R.dto_global, zT_Inf_Docs_Digitados_R.redondeo, zT_Inf_Docs_Digitados_R.importe,zT_Inf_Docs_Digitados_R.seccion, zT_Inf_Docs_Digitados_R.iva_vac,"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "Clientes.rsocial_cli,Empresas.descripcion, Secciones.descripcion, monedas.descripcion "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & "From  (((" & Trim(gNombre_Tabla_Temporal) & " zT_Inf_Docs_Digitados_R "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN  Empresas ON zT_Inf_Docs_Digitados_R.cod_emp = Empresas.codigo) "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Secciones ON zT_Inf_Docs_Digitados_R.seccion = Secciones.codigo) "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN monedas ON zT_Inf_Docs_Digitados_R.moneda = monedas.codigo) "
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Clientes ON zT_Inf_Docs_Digitados_R.cod_prov = Clientes.nro_cli "
'                CrystalReport1.SQLQuery = CrystalReport1.SQLQuery & " Order By zT_Inf_Docs_Digitados_R.cod_emp ASC,zT_Inf_Docs_Digitados_R.moneda ASC,zT_Inf_Docs_Digitados_R.seccion ASC"
                CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By zT_Inf_Docs_Digitados_R.moneda ASC,zT_Inf_Docs_Digitados_R.seccion ASC"
            
                If Trim(gString_Orden) <> "" Then
                    CrystalReport1.sqlQuery = Trim(CrystalReport1.sqlQuery) & _
                                                "," & Trim(gString_Orden)
                End If
                                                     
                lParametro = "parUsuario;" & gUsuario & ";TRUE"
                CrystalReport1.ParameterFields(0) = lParametro
            
                lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
                CrystalReport1.ParameterFields(1) = lParametro
            
                lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
                CrystalReport1.ParameterFields(2) = lParametro
                
                CrystalReport1.ReportFileName = ConfCamarchReportes & "Inf_Documentos_Digitados_Resumido_X_Seccion_Clientes_MO.rpt"
                'Inf_Documentos_Digitados_Resumido_X_Seccion_Clientes_MO.rpt
                CrystalReport1.Destination = 0
                lresult = CrystalReport1.PrintReport
        
            End If
        
    
    End Select
        
    Unload frmMensaje_Esperar

End Function

Sub Muestro_Documento_Que_Afecta(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long)
Dim lstrSQL As String
Dim R1 As Recordset
Dim R2 As Recordset

    txtDoc_Afectado.text = ""
    txtNro_Doc_Afectado.text = ""

    lstrSQL = "SELECT MAX(fec_doca) AS fec_doca FROM FaccmpPagos "
    lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
    lstrSQL = lstrSQL & " AND cod_doca = " & plngCod_Doc
    lstrSQL = lstrSQL & " AND nro_doca = " & plngNro_Doc
    lstrSQL = lstrSQL & " AND cod_prova = " & plngCod_Prov
    
    Set R1 = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    If Not R1.EOF Then
    
        lstrSQL = "SELECT MAX(cod_doc) AS cod_doc ,MAX(nro_doc) AS nro_doc "
        lstrSQL = lstrSQL & " FROM FaccmpPagos"
        lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
        lstrSQL = lstrSQL & " AND cod_doca = " & plngCod_Doc
        lstrSQL = lstrSQL & " AND nro_doca = " & plngNro_Doc
        lstrSQL = lstrSQL & " AND cod_prov = " & plngCod_Prov
        lstrSQL = lstrSQL & " AND fec_doca = " & f_Fecha_Base(R1!fec_doca, Conf_Motor_Base)
        
        Set R2 = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
        If Not R2.EOF Then
            txtDoc_Afectado.text = R2!cod_doc
            txtNro_Doc_Afectado.text = R2!nro_doc
        End If
    End If

End Sub

Function Buscar_Limite_Credito(plngCod_Emp As Long, plngCod_Doc As Long, plngCod_Prov As Long, plngMoneda As Long, pdatFecha As Date, pdblImpDocActual As Double, pdblTipoCambio As Double, pMuestroMensaje As Boolean) As Boolean
Dim lrstDocumentos As Recordset
Dim lrstClientes As Recordset
Dim lrstMonedas As Recordset
Dim lrstEmp As Recordset

Dim llngMonedaMostrar As Long
Dim ldblLimite_Credito_MBase As Double
Dim ldblLimite_Credito_MReferencia As Double
Dim ldblDeuda_Estado_Cuenta As Double
Dim ldblSaldo_Estado_Cuenta As Double
Dim ldblTipoCambio_Usar As Double
Dim lstrMsjDeuda As String

Dim ldblDeuda_Estado_Cuenta_Base As Double
Dim ldblDeuda_Estado_Cuenta_Ref As Double
Dim ldblDeuda_Estado_Cuenta_Origen As Double


    ldblDeuda_Estado_Cuenta_Base = 0
    ldblDeuda_Estado_Cuenta_Ref = 0
    ldblDeuda_Estado_Cuenta_Origen = 0

    
    ' Controlo el Limite en Moneda Base y Moneda Referencia, muestra el limite de credito segun moneda del documento    SS 20170711
    Buscar_Limite_Credito = False
    
    If ConfPuntoVta_Controla_Limite_Credito_Moneda = "BASE" Then       'siempre muestra el limite en moneda base
        llngMonedaMostrar = gMoneda_Base
    Else
        If ConfPuntoVta_Controla_Limite_Credito_Moneda = "REFERENCIA" Then   'siempre muestra el limite en moneda referencia
            llngMonedaMostrar = gMoneda_Referencia
        Else
            ' JE 20240703   /   Se ingresa nuevo formato para que muestre el Limite que esta en la ficha
            If ConfPuntoVta_Controla_Limite_Credito_Moneda = "ORIGINAL" Then   'siempre muestra el limite en moneda que esta en la ficha del cliente
                If Buscar_Cliente(plngCod_Prov, lrstClientes) Then
                    llngMonedaMostrar = lrstClientes!limite_credito_moneda
                Else
                    llngMonedaMostrar = plngMoneda  'muestra el limite en la moneda del documento que se esta emitiendo "MONEDA"
                End If
            Else
                llngMonedaMostrar = plngMoneda  'muestra el limite en la moneda del documento que se esta emitiendo "MONEDA"
            End If
        End If
    End If
    
    If pdblTipoCambio = 1 Then
        ldblTipoCambio_Usar = 0
    Else
        ldblTipoCambio_Usar = pdblTipoCambio
    End If
    
    If llngMonedaMostrar <> 0 Then
    
        If Buscar_Tipo_Documento(plngCod_Doc, lrstDocumentos) Then
        
            If Buscar_Cliente(plngCod_Prov, lrstClientes) Then
            
                ldblLimite_Credito_MBase = 0
                ldblLimite_Credito_MReferencia = 0
                
                If lrstClientes!limite_credito_moneda = gMoneda_Base Then       'limite en $
                    ldblLimite_Credito_MBase = lrstClientes!cre_cli
                    ldblLimite_Credito_MReferencia = Importe_Referencia(gMoneda_Base, ldblTipoCambio_Usar, txtFec_Doc.text, lrstClientes!cre_cli)
                End If
                
                If lrstClientes!limite_credito_moneda = gMoneda_Referencia Then 'limite en U$
                    ldblLimite_Credito_MBase = Importe_Base(gMoneda_Referencia, ldblTipoCambio_Usar, txtFec_Doc.text, lrstClientes!cre_cli)
                    ldblLimite_Credito_MReferencia = lrstClientes!cre_cli
                End If
                
                If Buscar_Moneda(val(llngMonedaMostrar), lrstMonedas) Then      'Busca simbolo de la moneda que se quiera mostrar segun configuracion
                    labTope_Credito_Moneda.Caption = Trim(UCase(lrstMonedas!simbolo))
                    labSaldo_Credito_Moneda.Caption = Trim(UCase(lrstMonedas!simbolo))
                End If
                
                If llngMonedaMostrar = gMoneda_Base Then
                    labTope_Credito.Caption = Format(ldblLimite_Credito_MBase, "#,##0.00")
                Else
                    labTope_Credito.Caption = Format(ldblLimite_Credito_MReferencia, "#,##0.00")
                End If
                
                ' **** Calcula el saldo del estado de cuenta en la moneda origen de los documentos del estado de cuenta y lo convierte a la moneda (llngMonedaMostrar) del Documento Actual al tipo de Cambio Actual *********
                ' con el metodo anterior la diferencia de cambio entre la factura y el recibo de cobranza generan saldos a favor ficticios en el estado de cuenta.
                ' AIR 20181114
                
                'ldblDeuda_Estado_Cuenta_Base = Saldo_Titular_Estado_Cuenta("C", plngCod_Emp, plngCod_Prov, "0", "0", pdatFecha, "D", 0, "O", gMoneda_Base, "NETO", "")
                'ldblDeuda_Estado_Cuenta_Ref = Saldo_Titular_Estado_Cuenta("C", plngCod_Emp, plngCod_Prov, "0", "0", pdatFecha, "D", 0, "O", gMoneda_Referencia, "NETO", "")
                
                SQL = "Select * from Monedas "
                Set R = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                If Buscar_Empresa_Consolidada(plngCod_Emp, lrstEmp) Then
                    plngCod_Emp = lrstEmp!cod_emp_central
                End If
                               
                Do While Not R.EOF
                    ldblDeuda_Estado_Cuenta_Origen = 0
                   
                    ldblDeuda_Estado_Cuenta_Origen = Saldo_Titular_Estado_Cuenta("C", plngCod_Emp, plngCod_Prov, "0", "0", pdatFecha, "D", 0, "O", R!codigo, "NETO", "")
                    If ldblDeuda_Estado_Cuenta_Origen <> 0 Then
                        If R!codigo = gMoneda_Base Then
                            ldblDeuda_Estado_Cuenta_Base = ldblDeuda_Estado_Cuenta_Base + Importe_Base(R!codigo, ldblTipoCambio_Usar, pdatFecha, ldblDeuda_Estado_Cuenta_Origen)
                        Else
                            If R!codigo = gMoneda_Base Or R!codigo = gMoneda_Referencia Then
                                ldblDeuda_Estado_Cuenta_Ref = ldblDeuda_Estado_Cuenta_Ref + Importe_Referencia(R!codigo, ldblTipoCambio_Usar, pdatFecha, ldblDeuda_Estado_Cuenta_Origen)
                            Else
                                ldblDeuda_Estado_Cuenta_Base = ldblDeuda_Estado_Cuenta_Base + Importe_Base(R!codigo, 0, pdatFecha, ldblDeuda_Estado_Cuenta_Origen)
                                ldblDeuda_Estado_Cuenta_Ref = ldblDeuda_Estado_Cuenta_Ref + Importe_Referencia(R!codigo, 0, pdatFecha, ldblDeuda_Estado_Cuenta_Origen)
                            End If
                        End If
                    End If
                    
                   R.MoveNext
                Loop
                R.Close
                '*************
                                
                ' Controlo el Limite de Credito.. Si en el Cliente esta Definido el TOPE solo para Ventas
                If llngMonedaMostrar = gMoneda_Base Then
                    ' AIR 20181114 comentado
                   ' ldblDeuda_Estado_Cuenta = Saldo_Titular_Estado_Cuenta("C", plngCod_Emp, plngCod_Prov, "0", "0", pdatFecha, "D", 0, "B", 0, "NETO", "")
                    
                    ' AIR 20181114
                    ldblDeuda_Estado_Cuenta = ldblDeuda_Estado_Cuenta_Base + Importe_Base(gMoneda_Referencia, ldblTipoCambio_Usar, pdatFecha, ldblDeuda_Estado_Cuenta_Ref)
                                                            
                    If plngMoneda = gMoneda_Base Then   'pasar a $
                        ldblTotal_Documento_Actual = pdblImpDocActual
                    Else
                        ldblTotal_Documento_Actual = Importe_Base(gMoneda_Referencia, ldblTipoCambio_Usar, pdatFecha, pdblImpDocActual)
                    End If
                    ldblSaldo_Estado_Cuenta = ldblLimite_Credito_MBase - ldblDeuda_Estado_Cuenta - ldblTotal_Documento_Actual
                    labSaldo_Credito.Caption = Format(ldblSaldo_Estado_Cuenta, "#,##0.00")
                    
                Else
                    ' AIR 20181114 comentado
                    ' ldblDeuda_Estado_Cuenta = Saldo_Titular_Estado_Cuenta("C", plngCod_Emp, plngCod_Prov, "0", "0", pdatFecha, "D", 0, "R", 0, "NETO", "")
                    
                    ' AIR 20181114
                    ldblDeuda_Estado_Cuenta = ldblDeuda_Estado_Cuenta_Ref + Importe_Referencia(gMoneda_Base, ldblTipoCambio_Usar, pdatFecha, ldblDeuda_Estado_Cuenta_Base)
                    
                    If plngMoneda = gMoneda_Referencia Then   'pasar a U$S
                        ldblTotal_Documento_Actual = pdblImpDocActual
                    Else
                        ldblTotal_Documento_Actual = Importe_Referencia(gMoneda_Base, ldblTipoCambio_Usar, pdatFecha, pdblImpDocActual)
                    End If
                    ldblSaldo_Estado_Cuenta = ldblLimite_Credito_MReferencia - ldblDeuda_Estado_Cuenta - ldblTotal_Documento_Actual
                    labSaldo_Credito.Caption = Format(ldblSaldo_Estado_Cuenta, "#,##0.00")
                End If
                
                'ATU 20170505 se emite solamente aviso cuando tiene dinero a favor. Para veicuer, pero generico
                If pMuestroMensaje Then
                    ' Controla limite de credito
                    If ldblSaldo_Estado_Cuenta < 0 And lrstDocumentos!signo = -1 And Trim(lrstDocumentos!clase) = "CREDITO" Then
                        'If Not gPtoVenta_Robot Then
                            If pdblImpDocActual = 0 Then
                                lstrMsjDeuda = "Deuda del Cliente:  "
                            Else
                                lstrMsjDeuda = "Deuda del Cliente + Documento Actual:  "
                            End If
                        
                            If llngMonedaMostrar = gMoneda_Base Then
                                MsgBox lstrMsjDeuda & Trim(UCase(lrstMonedas!simbolo)) & " " & Format((ldblDeuda_Estado_Cuenta + ldblTotal_Documento_Actual), "#,##0.00") & "  Supera el Tope de Crédito de " & Trim(UCase(lrstMonedas!simbolo)) & " " & Format(ldblLimite_Credito_MBase, "#,##0.00"), vbCritical, MsgTit
                            Else
                                MsgBox lstrMsjDeuda & Trim(UCase(lrstMonedas!simbolo)) & " " & Format((ldblDeuda_Estado_Cuenta + ldblTotal_Documento_Actual), "#,##0.00") & "  Supera el Tope de Crédito de " & Trim(UCase(lrstMonedas!simbolo)) & " " & Format(ldblLimite_Credito_MReferencia, "#,##0.00"), vbCritical, MsgTit
                            End If
                            If ConfPuntoVta_Utilizar_Autorizacion = "S" And Not gPtoVenta_Robot Then
                               'ATU 20180619 , se implementa que con la autorizacion de un nivel 3, se pueda proseguir.
                               If Not Autorizacion_Supervision(36, 3, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                                   Exit Function
                               End If
                            Else
                               Exit Function
                            End If
                        'Else
                        '    Exit Function
                        'End If
                    'End If
                    Else
                        'Saldo negativo, a favor, en la cuenta corriente, solo avisa. Agrego el total del documento     SS 20181220
                        If ConfPuntoVta_Mostrar_Aviso_Saldo_A_Favor And (ldblDeuda_Estado_Cuenta + ldblTotal_Documento_Actual) < 0 Then
                            MsgBox "Atencion!, El Cliente Tiene Saldo a Favor", vbInformation, MsgTit
                            Buscar_Limite_Credito = True
                            Exit Function
                        End If
                    End If
                    
                End If
            End If
        End If
    End If
    
    Buscar_Limite_Credito = True
    
End Function

Function Controlar_Saldo_Cliente_al_Guardar(plngEmpresa As Long, plngCliente As Long, plngCod_Doc As Long, pstrFecha As String, plngMoneda As Long, pdblTc As Double, pdblImporte As Double) As Boolean
Dim C As Recordset
Dim D As Recordset
Dim ldblLimite_Credito_MBase As Double

    Controlar_Saldo_Cliente_al_Guardar = True
    
    If Not Buscar_Cliente(plngCliente, C) Then
        Controlar_Saldo_Cliente_al_Guardar = False
        MsgBox "ERROR: Cliente " & plngCliente & " No existe en la Base de Datos. Verifique por favor...", vbCritical + vbOKOnly
        Exit Function
    End If
    
    If Not Buscar_Tipo_Documento(plngCod_Doc, D) Then
        Controlar_Saldo_Cliente_al_Guardar = False
        MsgBox "ERROR: Tipo de Documento " & plngCod_Doc & " No existe en la Base de Datos. Verifique por favor...", vbCritical + vbOKOnly
        Exit Function
    End If
    
    If C!cre_cli <> 0 Then
        
        ' Controlo el Limite de Credito.. Si en el Cliente esta Definido el TOPE
        If Not Buscar_Limite_Credito(plngEmpresa, plngCod_Doc, plngCliente, plngMoneda, CDate(txtFec_Doc.text), CDbl(NullToZero(txtImporte.text)), pdblTc, True) Then
            Controlar_Saldo_Cliente_al_Guardar = False
            Exit Function
        End If
        
        'ldblLimite_Credito_MBase = 0
        'If C!limite_credito_moneda = gMoneda_Base Then
        '    ldblLimite_Credito_MBase = C!cre_cli
        'End If
        'If C!limite_credito_moneda = gMoneda_Referencia Then
        '    ldblLimite_Credito_MBase = Importe_Base(gMoneda_Referencia, 0, CDate(pstrFecha), C!cre_cli)
        'End If
        'ldblSaldo_Estado_Cuenta = Saldo_Titular_Estado_Cuenta("C", plngEmpresa, plngCliente, "0", "0", CDate(pstrFecha), "D", 0, "B", 0, "NETO", "")
        'ldblTotal_Documento_Actual = Importe_Base(plngMoneda, pdblTC, CDate(pstrFecha), pdblImporte)
        'ldblSaldo_Estado_Cuenta_Con_Importe_Documento = ldblSaldo_Estado_Cuenta + ldblTotal_Documento_Actual
        'If ldblSaldo_Estado_Cuenta_Con_Importe_Documento > ldblLimite_Credito_MBase And D!signo = -1 And Trim(D!clase) = "CREDITO" Then
        '    Controlar_Saldo_Cliente_al_Guardar = False
        '    MsgBox "El Saldo Total Del Documento Supera el Tope de Crédito ", vbInformation, MsgTit
        '    Exit Function
        'End If
    End If

End Function

Function Genero_Temporal()

    gNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
    
    Call Borra_Tabla_Temporal(gNombre_Tabla_Temporal)
    
    SQL = "Select * Into " & Trim(gNombre_Tabla_Temporal) & " From zT_Inf_Docs_Digitados_R"
    Dbs.Execute SQL
 
    SQL = "Create index id1" & Trim(gNombre_Tabla_Temporal) & " on " & Trim(gNombre_Tabla_Temporal) & " (cod_emp,cod_doc,nro_doc,cod_prov)"
    Dbs.Execute SQL
    
    SQL = "SELECT DISTINCT faccmp.*,documentos.signo"
    SQL = SQL & " FROM Faccmp,documentos,faccmpmpagos, clientes"
    SQL = SQL & " WHERE faccmp.cod_doc = documentos.cod_doc AND faccmp.cod_prov=clientes.nro_cli "
    SQL = SQL & " AND documentos.cod_doc in( " & ConfDoc_Ingreso_Pedido_Cli & "," & ConfDoc_Ingreso_PreVenta_Cli & "," & ConfDoc_Ingreso_Presupuesto_Cli & "," & ConfDoc_Ingreso_Pedido_Cli_API & " )"  ' AIR 20250725
    SQL = SQL & " AND faccmp.cod_doc > 90 "
    SQL = SQL & " AND faccmp.cod_emp=faccmpmpagos.cod_emp"
    SQL = SQL & " AND faccmp.cod_doc=faccmpmpagos.cod_doc"
    SQL = SQL & " AND faccmp.nro_doc=faccmpmpagos.nro_doc"
    SQL = SQL & " AND faccmp.cod_prov=faccmpmpagos.cod_prov "
    
    If Trim(lstrFiltros) <> "" Then
        SQL = Trim(SQL) & " and " & Trim(lstrFiltros)
    End If
    

    Set lrst_cab = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    While Not lrst_cab.EOF
        DoEvents
        
        SQL = "SELECT count(*) as lineas "
        SQL = SQL & " FROM FaccmpLineas "
        SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
        SQL = SQL & " AND cod_doc = " & lrst_cab!cod_doc
        SQL = SQL & " AND nro_doc = " & lrst_cab!nro_doc
        SQL = SQL & " AND cod_prov = " & lrst_cab!Cod_Prov
        SQL = SQL & " Group by cod_emp,cod_doc,nro_doc,cod_prov"
        
        Set lrst_lin = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
        If lrst_lin.EOF Then
            lLineas_Servicios = 0
        Else
            lLineas_Servicios = IIf(IsNull(lrst_lin!Lineas), 0, lrst_lin!Lineas)
        End If
        
        lLineas = lLineas_Mercaderia + lLineas_Servicios
        
        ldblSaldo = 0
        ldblAjuste_INAC = 0
 
        
' Busco el Saldo Sin Cancelar del Documento
            
            SQL = "SELECT sum(importe) as importe "
            SQL = SQL & " FROM FaccmpPagos "
            SQL = SQL & " WHERE cod_emp = " & lrst_cab!Cod_Emp
            SQL = SQL & " AND cod_doca = " & lrst_cab!cod_doc
            SQL = SQL & " AND nro_doca = " & lrst_cab!nro_doc
            SQL = SQL & " AND cod_prova = " & lrst_cab!Cod_Prov
            
            Set lrst_Pagos = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            
            If lrst_Pagos.EOF Then
                ldblSaldo = lrst_cab!Importe
            Else
                If IsNull(lrst_Pagos!Importe) Then
                    ldblSaldo = lrst_cab!Importe
                Else
                    If lrst_Pagos!Importe >= lrst_cab!Importe Then
                        ldblSaldo = 0
                    Else
                        ldblSaldo = lrst_cab!Importe - lrst_Pagos!Importe
                    End If
                End If
            End If
                        
        ldblDtos_Total = 0
        ldblSubTotal = 0
        
        SQL = "Insert into " & gNombre_Tabla_Temporal & " values ("
        SQL = SQL & lrst_cab!Cod_Emp & ","
        SQL = SQL & lrst_cab!cod_doc & ","
        SQL = SQL & lrst_cab!nro_doc & ","
        SQL = SQL & lrst_cab!Cod_Prov & ","
        SQL = SQL & lLineas & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_doc, Conf_Motor_Base) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_valor, Conf_Motor_Base) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_ent, Conf_Motor_Base) & ","
        
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 1, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 2, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 2, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 3, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 3, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
                
        SQL = SQL & lCofis1 * (lrst_cab!signo * -1) & ","
        SQL = SQL & lCofis2 * (lrst_cab!signo * -1) & ","
        SQL = SQL & lCofis3 * (lrst_cab!signo * -1) & ","
        SQL = SQL & IIf(IsNull(lrst_cab!dto_global), 0, lrst_cab!dto_global) & ","
        
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & lrst_cab!redondeo_base & ","
            Case "R"
                SQL = SQL & lrst_cab!redondeo_ref & ","
            Case "O"
                SQL = SQL & lrst_cab!redondeo & ","
        End Select
        
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & lrst_cab!Importe_Base * (lrst_cab!signo * -1) & ","
            Case "R"
                SQL = SQL & lrst_cab!importe_ref * (lrst_cab!signo * -1) & ","
            Case "O"
                SQL = SQL & lrst_cab!Importe * (lrst_cab!signo * -1) & ","
        End Select
        
        SQL = SQL & IIf(IsNull(lrst_cab!forma_pago), 0, lrst_cab!forma_pago) & ","
        SQL = SQL & IIf(IsNull(lrst_cab!seccion), 0, lrst_cab!seccion) & ","
        SQL = SQL & f_Fecha_Base(lrst_cab!fec_reg, Conf_Motor_Base) & ",'"
        SQL = SQL & lrst_cab!usuario & "',"
        
        SQL = SQL & Importe_Neto_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 5, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
        SQL = SQL & Importe_X_Impuesto(lrst_cab!Cod_Emp, lrst_cab!cod_doc, lrst_cab!nro_doc, lrst_cab!Cod_Prov, "IVA", 5, gTipo_Moneda) * (lrst_cab!signo * -1) & ","
                
        Select Case gTipo_Moneda
            Case "B"
                SQL = SQL & gMoneda_Base & ","
            Case "R"
                SQL = SQL & gMoneda_Referencia & ","
            Case "O"
                SQL = SQL & lrst_cab!moneda & ","
        End Select
        
        SQL = SQL & lrst_cab!cod_suc & ","
        SQL = SQL & "'" & Mid(Trim(lrst_cab!observa), 1, 100) & "',"
        SQL = SQL & ldblSaldo * (lrst_cab!signo * -1) & ","
        SQL = SQL & ldblAjuste_INAC & ",'"
        SQL = SQL & lrst_cab!nom_cli & "',"
        SQL = SQL & ldblDtos_Total & ",'"                ' se agrega campo para dsctos en tabla de reporte    SS 20150730
        SQL = SQL & lrst_cab!Autorizado & "')"           ' se agrega campo autorizado en tabla de reporte     LC 20170125
       
        Dbs.Execute SQL
                
        lrst_lin.Close
        
        lrst_cab.MoveNext
    Wend
    lrst_cab.Close
End Function

Private Sub Generar_Archivo(ByVal argTabla As String, ByVal argfiltros As String)
   
    Dim varTalles() As Variant
    Dim RST As Recordset
    Dim Lineas As Integer
    Dim strColTalles As String
    Dim strColSum As String
    Dim nomCol As String
    Dim Filenum As Integer
    Dim primeravez As Boolean



    On Error GoTo Errores:
    
     
    'Generando la configuracion de columnas dinamicas
    psql = " SELECT distinct productos.codigo_talle,ma_talles.descripcion  From " & Trim(argTabla) & " zT_Informe_Pedidos_Pendientes_x_Articulo"
    psql = psql & " INNER JOIN productos ON zT_Informe_Pedidos_Pendientes_x_Articulo.cod_prod = productos.cod_prod"
    psql = psql & " INNER JOIN ma_talles ON productos.codigo_talle = ma_talles.codigo_talle"
    psql = psql & " order by ma_talles.descripcion"
        
    
     Set RST = Dbs.OpenRecordset(psql, dbOpenSnapshot)
     
     Lineas = -1
     strColTalles = ""
     strColSum = ""
    
     While Not RST.EOF
              
         Lineas = Lineas + 1
         ReDim Preserve varTalles(2, Lineas)
         varTalles(0, Lineas) = RST!codigo_talle
         varTalles(1, Lineas) = RST!Descripcion
         
         If Lineas <> 0 Then
             strColTalles = strColTalles & vbTab
             strColSum = strColSum & ","
         End If
         strColTalles = strColTalles & RST!Descripcion
         strColSum = strColSum & "sum(case when productos.codigo_talle=" & Trim(RST!codigo_talle) & " then zT_Informe_Pedidos_Pendientes_x_Articulo.cant_prod else 0 end) as col" & Trim(Lineas)
         RST.MoveNext
     Wend
     
    
     psql = "SELECT clientes.nro_cli, clientes.rsocial_cli, clientes.nombre_fantasia,ma_sucursales_clientes.cod_suc, ma_sucursales_clientes.nombre,ma_SB_Familias.codigo_SB_Familia, ma_SB_Familias.descripcion,"
     psql = psql & "ma_colores.ref_color , ma_colores.descripcion nom_color," & Trim(strColSum)
     psql = psql & " From ((((((" & Trim(argTabla) & " zT_Informe_Pedidos_Pendientes_x_Articulo"
     psql = psql & " INNER JOIN productos ON zT_Informe_Pedidos_Pendientes_x_Articulo.cod_prod = productos.cod_prod)"
     psql = psql & " INNER JOIN Empresas ON zT_Informe_Pedidos_Pendientes_x_Articulo.cod_emp = Empresas.codigo)"
     psql = psql & " INNER JOIN ma_sucursales_clientes ON zT_Informe_Pedidos_Pendientes_x_Articulo.nro_cli = ma_sucursales_clientes.nro_cli AND zT_Informe_Pedidos_Pendientes_x_Articulo.cod_suc = ma_sucursales_clientes.cod_suc)"
     psql = psql & " INNER JOIN clientes ON zT_Informe_Pedidos_Pendientes_x_Articulo.nro_cli = clientes.nro_cli)"
     psql = psql & " INNER JOIN ma_colores ON productos.codigo_color = ma_colores.codigo_color)"
     psql = psql & " INNER JOIN ma_talles ON productos.codigo_talle = ma_talles.codigo_talle)"
     psql = psql & " LEFT OUTER JOIN ma_SB_Familias ON productos.codigo_SP_Familia = ma_SB_Familias.codigo_SP_Familia"
     psql = psql & " AND productos.codigo_Familia = ma_SB_Familias.codigo_Familia AND productos.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia"
     psql = psql & " Group by clientes.nro_cli, clientes.rsocial_cli, clientes.nombre_fantasia,ma_sucursales_clientes.cod_suc, ma_sucursales_clientes.nombre,ma_SB_Familias.codigo_SB_Familia, ma_SB_Familias.descripcion,"
     psql = psql & " ma_colores.ref_color , ma_colores.descripcion"
     psql = psql & " Order By  clientes.rsocial_cli,ma_sucursales_clientes.cod_suc, ma_sucursales_clientes.nombre,ma_SB_Familias.codigo_SB_Familia,ma_colores.ref_color"
    
    
    
     Set RST = Dbs.OpenRecordset(psql, dbOpenSnapshot)
     
     
     primeravez = False
    
     While Not RST.EOF
     
         If Not primeravez Then
         
             Filenum = FreeFile()
             
             Nomarch = Trim(f_str_Escritorio) & "\reporte_articulos_pendientes_x_cliente_" & Trim(Format(Now, "yyyyMMddHHmmss")) & ".xls"
             
            
             Open Trim(Nomarch) For Append As #Filenum  'Binary Access Write Lock Read Write As #FileNum
         
             strlineas = "REPORTE ARTICULOS PENDIENTES POR CLIENTE"
             Print #Filenum, strlineas
             Print #Filenum, ""
             
             strlineas = "Filtros : " & Trim(argfiltros)
             Print #Filenum, strlineas
             Print #Filenum, ""
             
             strlineas = "Usuario : " & Trim(gUsuario)
             Print #Filenum, strlineas
             strlineas = "Generado el  : " & Format(Now, "dd/MM/yyyy HH:mm:ss")
             Print #Filenum, strlineas
             Print #Filenum, ""
         
         
             strlineas = "Cod.Cliente" & vbTab & "Razon Social" & vbTab & "Sucursal" & vbTab & "Articulo" & vbTab & "Nombre Articulo" & vbTab & "Color" & vbTab & "Descripcion" & vbTab & Trim(strColTalles)
             Print #Filenum, strlineas
             Print #Filenum, ""
             
             primeravez = True
         End If
     
         strlineas = Trim(RST!nro_cli) & vbTab & Trim(RST!rsocial_cli) & vbTab & Trim(RST!cod_suc) & vbTab & Trim(RST!codigo_SB_Familia) & vbTab & Trim(RST!Descripcion) & vbTab & Trim(RST!ref_color) & vbTab & Trim(RST!nom_color)
     
         For i = 0 To UBound(varTalles, 2)
              nomCol = "col" & Trim(i)
              
              If Trim(RST.Fields(nomCol)) = "" Then
                  strlineas = strlineas & vbTab & "0"
              Else
                  strlineas = strlineas & vbTab & RST.Fields(nomCol)
              End If
         Next
         
         Print #Filenum, strlineas
         
         RST.MoveNext
     
     Wend
     
      Close #Filenum
      
     
      MsgBox "Archivo Generado Correctamente " & Chr(13) & (Nomarch), vbInformation + vbSystemModal, MsgTit
     
      
      
    
    
    
    Exit Sub
    
   
    
Errores:
    

End Sub

Function Control_Necesita_Documento_Asociado() As Boolean
Dim ExisteReferencia As Boolean

ExisteReferencia = False
Control_Necesita_Documento_Asociado = True

If ConfControla_Saldo_Cantidad_Por_Documento Then
            
    SQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
    SQL = SQL & " WHERE cod_doc =" & CLng(txtCodDoc.text)
    SQL = SQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
    
    ' Veo si el documento dado de alta, es un documento que tengo que controlar saldos (restando)
    Set lrstDocsPend = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    If Not lrstDocsPend.EOF Then
        If Trim(UCase(lrstDocsPend!antecede_Obligatorio)) = "S" Then
            
            For i = 1 To vsfLineas_Mercaderia.Rows - 1 Step 1
                If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
                    If val(vsfLineas_Mercaderia.TextMatrix(i, CGL_COD_DOC_REF)) <> 0 Then     'AIR 20180314 If Val(vsfLineas_Mercaderia.TextMatrix(i, CGL_COD_DOC_REF)) = 0 Then
                        ExisteReferencia = True
                        
                        'AIR 20180314 si existe una linea con referencia ya es valido.
'                        MsgBox "Operación no valida sin un documento de referecia asociado valido", vbInformation, MsgTit
'                        Control_Necesita_Documento_Asociado = False
'                        Exit Function
                    End If
                End If
            Next
            
            If Not ExisteReferencia Then
                MsgBox "Operación no valida sin un documento de referecia asociado valido", vbInformation, MsgTit
                Control_Necesita_Documento_Asociado = False
                Exit Function
            End If
        End If
    End If
        
    lrstDocsPend.Close
End If
        
If Control_Necesita_Documento_Asociado = True Then
    'AIR 20180314  para controlar si hay documetos obligatorios a referenciar con este doc
    
    SQL = " SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
    SQL = SQL & " WHERE cod_doc = " & CLng(txtCodDoc.text)
    SQL = SQL & " AND   utilizar_en_control_pendientes = 'N' "
    SQL = SQL & " AND   antecede_Obligatorio = 'S' "
    
    Set lrstDocsPend = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    If Not lrstDocsPend.EOF Then
         If txtDoc_Afectado.text = "" Or txtNro_Doc_Afectado.text = "" Then
            MsgBox "Operación no valida sin un documento de referecia asociado valido", vbInformation, MsgTit
            Control_Necesita_Documento_Asociado = False
            
            Exit Function
         End If
    End If

End If

End Function

Public Function Alta_Cabezal_Documento(plngNumero_Pedido As Long, pdblImporte_Base As Double, pdblImporte_Referencia As Double, pdblRedondeo_Base As Double, pdblRedondeo_Referencia As Double) As Boolean
Dim lstrSQL As String
Dim lstrAutorizado As String
Dim e As Recordset
Dim D As Recordset

On Error GoTo Errores

    Alta_Cabezal_Documento = True

    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Alta_Cabezal_Documento = False
        Exit Function
    End If

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Cabezal_Documento = False
        Exit Function
    End If

    lstrSQL = "INSERT INTO Faccmp (cod_emp,cod_doc,nro_doc,cod_prov,nro_int,fec_reg,fec_doc,"
    lstrSQL = lstrSQL & "fec_valor,fec_ent, iva_bas,iva_min,fec_venc,importe,"
    lstrSQL = lstrSQL & "dto_global,redondeo,fec_trans,usuario,con_sin_iva,cod_suc,"
    lstrSQL = lstrSQL & "observa,cofisbas,cofismin,cofisexento,autorizado,"
    lstrSQL = lstrSQL & "lleva_cofis,nom_cli,ruc,forma_pago,seccion,moneda,"
    lstrSQL = lstrSQL & "tipo_cambio,importe_base,importe_ref,redondeo_base,redondeo_ref,nro_rollo,"
    lstrSQL = lstrSQL & "hora,nro_ven,caja,importe_calculado_x_sistema) "
    lstrSQL = lstrSQL & "VALUES("
    lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                                      ' cod_emp
    lstrSQL = lstrSQL & val(txtCodDoc.text) & ","                                                       ' cod_doc
    lstrSQL = lstrSQL & val(txtDoc.text) & ","                                                          ' nro_doc
    lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                                      ' cod_prov
    lstrSQL = lstrSQL & IIf(IsNull(plngNumero_Pedido), 0, plngNumero_Pedido) & ","                      ' nro_int
    lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ","                 ' fec_reg
    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","                            ' fec_doc
    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","                            ' fec_valor
    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & "" & ","                       ' fec_ent
    lstrSQL = lstrSQL & "0" & ","                                                                       ' iva_bas
    lstrSQL = lstrSQL & "0" & ","                                                                       ' iva_min
    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","                    ' fec_venc
    lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","                                                     ' importe
    lstrSQL = lstrSQL & CDbl(txtDtoGlobal.text) & ","                                                   ' dto_global
    lstrSQL = lstrSQL & CDbl(txtRedondeo.text)                                                          ' redondeo

    If D!setrans Then
        ' Documento que se puede transferir - Grabo nulo en el campo fec_trans
        lstrSQL = lstrSQL & ",NULL,'"                                                                   ' fec_trans
    Else
        ' Documento que No se transfiere - Grabo la Fecha Actual en el campo fec_trans
        lstrSQL = lstrSQL & "," & f_Fecha_Base(TxtFecReg.text, Conf_Motor_Base) & ",'"                  ' fec_trans
    End If

    lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "','"                               ' usuario
    lstrSQL = lstrSQL & Trim(UCase(e!imp_inc_facturador)) & "',"                    ' con_sin_iva
    lstrSQL = lstrSQL & val(TxtCodSuc.text) & ",'"                                  ' cod_suc
    lstrSQL = lstrSQL & UCase(Left(f_Ins_String(Trim(txtObs.text)), 100)) & "',"    ' observa
    lstrSQL = lstrSQL & val(txtTasa_Bromatologica.text) & ","                       ' cofisbas      - utilizado para grabar el Tipo de Tasa Bromatologica utilizada
    lstrSQL = lstrSQL & val(txtRemito.text) & ","                                   ' cofismin      - utilizado para grabar ahora nro. remito
    lstrSQL = lstrSQL & val(txtGuia.text) & ",'"                                    ' cofisexento   - utilizado para grabar la guia para INAC
       
    If D!Autorizar = "N" Then
        lstrAutorizado = "S"
    Else
        If UCase(Trim(sspOperacion.Caption)) = "U" Then
            lstrAutorizado = "S"
        ElseIf UCase(Trim(sspOperacion.Caption)) = "M" And D!Autorizar = "A" Then
            lstrAutorizado = gValorAutorizar
        Else
            lstrAutorizado = "N"
        End If
    End If
    
    lstrSQL = lstrSQL & Trim(lstrAutorizado) & "','"                                ' autorizado
    lstrSQL = lstrSQL & UCase(Trim(TxtTCofis.text)) & "','"                         ' lleva_cofis
    lstrSQL = lstrSQL & Trim(UCase(Mid(f_Ins_String(txtNomCli.text), 1, 255))) & "','"            ' nom_cli
  
    If Trim(TxtRuc.text) <> "" Then
        lstrSQL = lstrSQL & Trim(UCase(Mid(TxtRuc.text, 1, 19))) & "',"             ' ruc
    Else
        lstrSQL = lstrSQL & "X" & "',"                                              ' ruc
    End If
  
    lstrSQL = lstrSQL & val(txtForma_Pago.text) & ","                               ' forma_pago
    lstrSQL = lstrSQL & "0" & ","                                                   ' seccion
    lstrSQL = lstrSQL & val(txtMoneda.text) & ","                                   ' moneda
    lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","                              ' tipo_cambio
    lstrSQL = lstrSQL & pdblImporte_Base & ","                                      ' importe_base
    lstrSQL = lstrSQL & pdblImporte_Referencia & ","                                ' importe_ref
    lstrSQL = lstrSQL & pdblRedondeo_Base & ","                                     ' redondeo_base
    lstrSQL = lstrSQL & pdblRedondeo_Referencia & ","                               ' redondeo_ref
    lstrSQL = lstrSQL & CLng(txtLista.text) & ",'"                                  ' nro_rollo
    lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "',"                             ' hora
    lstrSQL = lstrSQL & val(txtVendedor.text) & ","                                 ' nro_ven
    lstrSQL = lstrSQL & val(txtCaja.text) & ","                                     ' caja          SS 20170201
    lstrSQL = lstrSQL & CDbl(txtTotal_Calculado.text) & ")"                         ' importe_calculado_x_sistema  AIR 20170904
  
    Dbs.Execute lstrSQL

Exit Function

Errores:

    Call FErrores
    Alta_Cabezal_Documento = False

End Function

Public Function Alta_Cabezal_Documento_Datos_Presupuesto() As Boolean
Dim lstrSQL As String
Dim lstrAutorizado As String
Dim llngEstado_Presupuesto_Codigo As Long
Dim e As Recordset
Dim D As Recordset
Dim C As Recordset

On Error GoTo Errores

    Alta_Cabezal_Documento_Datos_Presupuesto = True

    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Alta_Cabezal_Documento_Datos_Presupuesto = False
        Exit Function
    End If

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Cabezal_Documento_Datos_Presupuesto = False
        Exit Function
    End If

    If D!tipo_doc <> "A" Then
        Alta_Cabezal_Documento_Datos_Presupuesto = True
        Exit Function
    End If
    
    If Not Buscar_Cliente(val(txtCodProv.text), C) Then
        Alta_Cabezal_Documento_Datos_Presupuesto = False
        Exit Function
    End If

    llngEstado_Presupuesto_Codigo = 0

    SQL = "INSERT INTO Faccmp_Presupuestos (cod_emp,cod_doc,nro_doc,cod_prov,rsocial_cli,dir_cli,zona,tipo_doc_identidad,"
    SQL = SQL & "doc_identidad,contacto,telefonos,email,nro_cli_padre,tipo_lista_mercaderia,lista_mercaderia,tipo_lista_servicios,"
    SQL = SQL & "lista_servicios,moneda,tipo_cambio,tipo_presupuesto,validez,validez_descripcion,forma_pago,forma_pago_descripcion,"
    SQL = SQL & "plazo_entrega,plazo_entrega_descripcion,tipo_entrega_mercaderia,tipo_garantia,observacion_fija,fec_reg,usuario,"
    SQL = SQL & "estado,estado_fecha_reg,estado_usuario,origen,imprimir_con_impuestos_incluidos,horario,nro_puerta,apartamento,"
    SQL = SQL & "enviar_contacto,enviar_direccion,enviar_telefonos,enviar_email,enviar_copiar_a,enviar_copiar_a_email,equipos_a_entregar,solicitante,"
    SQL = SQL & "direccion_entre_esquina,porcentaje_sobre_mercaderia,porcentaje_sobre_servicios,programar_visita,importe_analisis_potabilidad,aceptado_con_analisis_potabilidad)"
    SQL = SQL & "VALUES("
    SQL = SQL & val(txtEmpresa.text) & ","                                                  ' cod_emp
    SQL = SQL & val(txtCodDoc.text) & ","                                                   ' cod_doc
    SQL = SQL & val(txtDoc.text) & ","                                                      ' nro_doc
    SQL = SQL & val(txtCodProv.text) & ",'"                                                 ' cod_prov
    SQL = SQL & UCase(f_Ins_String(Trim(txtNomCli.text))) & "','"                           ' rsocial_cli
    SQL = SQL & C!dir_cli & "',"                                                            ' dir_cli
    SQL = SQL & C!nro_zon & ","                                                             ' zona
    SQL = SQL & val(txtTipo_Doc_Identidad.text) & ",'"                                      ' tipo_doc_identidad
    SQL = SQL & UCase(f_Ins_String(Trim(TxtRuc.text))) & "','"                              ' doc_identidad
    SQL = SQL & "" & "','"                                                                  ' contacto
    SQL = SQL & "" & "','"                                                                  ' telefonos
    SQL = SQL & C!email_cli & "',"                                                          ' email
    SQL = SQL & "0" & ",'"                                                                  ' nro_cli_padre
    SQL = SQL & Trim(UCase(D!tipo_lista_x_defecto)) & "',"                                  ' tipo_lista_mercaderia
    SQL = SQL & val(txtLista.text) & ",'"                                                   ' lista_mercaderia
    SQL = SQL & Trim(UCase(D!tipo_lista_servicios_x_defecto)) & "',"                        ' tipo_lista_servicios
    SQL = SQL & val(txtLista.text) & ","                                                    ' lista_servicios
    SQL = SQL & val(txtMoneda.text) & ","                                                   ' moneda
    SQL = SQL & val(txtTipo_Cambio.text) & ","                                              ' tipo_cambio
    SQL = SQL & "0" & ","                                                                   ' tipo_presupuesto
    SQL = SQL & "0" & ",'"                                                                  ' validez
    SQL = SQL & "" & "',"                                                                   ' validez_descripcion
    SQL = SQL & val(txtForma_Pago.text) & ",'"                                              ' forma_pago
    SQL = SQL & Trim(txtDes_Forma_Pago.text) & "',"                                         ' forma_pago_descripcion
    SQL = SQL & "0" & ",'"                                                                  ' plazo_entrega
    SQL = SQL & "" & "',"                                                                   ' plazo_entrega_descripcion
    SQL = SQL & "0" & ","                                                                   ' tipo_entrega_mercaderia
    SQL = SQL & "0" & ",'"                                                                  ' tipo_garantia
    SQL = SQL & "" & "',"                                                                   ' observacion_fija
    SQL = SQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"            ' fec_reg
    SQL = SQL & UCase(Trim(gUsuario)) & "',"                                                ' usuario
    SQL = SQL & llngEstado_Presupuesto_Codigo & ","                                         ' estado
    SQL = SQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"                                  ' estado_fecha_reg
    SQL = SQL & "" & "',"                                                                   ' estado_usuario
    SQL = SQL & "0" & ",'"                                                                  ' origen
    SQL = SQL & "S" & "','"                                                                 ' imprimir_con_impuestos_incluidos
    SQL = SQL & "" & "','"                                                                  ' horario
    SQL = SQL & "" & "','"                                                                  ' nro_puerta
    SQL = SQL & "" & "','"                                                                  ' apartamento
    SQL = SQL & "" & "','"                                                                  ' enviar_contacto
    SQL = SQL & "" & "','"                                                                  ' enviar_direccion
    SQL = SQL & "" & "','"                                                                  ' enviar_telefonos
    SQL = SQL & "" & "','"                                                                  ' enviar_email
    SQL = SQL & "" & "','"                                                                  ' enviar_copiar_a
    SQL = SQL & "" & "','"                                                                  ' enviar_copiar_a_email
    SQL = SQL & "" & "','"                                                                  ' equipos_a_entregar
    SQL = SQL & "" & "','"                                                                  ' solicitante
    SQL = SQL & "" & "',"                                                                   ' direccion_entre_esquina
    SQL = SQL & "0" & ","                                                                   ' porcentaje_sobre_mercaderia
    SQL = SQL & "0" & ",'"                                                                  ' porcentaje_sobre_servicios
    SQL = SQL & "N" & "',"                                                                  ' programar_visita
    SQL = SQL & "0" & ",'"                                                                  ' importe_analisis_potabilidad
    SQL = SQL & "S" & "')"                                                                  ' aceptado_con_analisis_potabilidad

    Dbs.Execute SQL
        

Exit Function

Errores:

    Call FErrores
    Alta_Cabezal_Documento_Datos_Presupuesto = False

End Function


Public Function Alta_Entrega_Cuenta() As Boolean
Dim lstrSQL As String
Dim lstrAutorizado As String
Dim e As Recordset
Dim D As Recordset
Dim EC As Recordset
Dim P As Recordset
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim lintLinea As Integer
Dim llngNroDoc As Long
Dim llngCodDoc As Long
    

On Error GoTo Errores

    Alta_Entrega_Cuenta = True
    
    
    
    If Not confUsa_Sesion_Pago_Tarjetas Then
         Exit Function
    End If
    
    If ConfTRANSACT_Habilitado = "S" Then
        lstrSQL = "select c.cod_prov,d.rsocial_prov,d.ruc_prov,c.cod_doc,c.cod_insumo,a.cod_mpago,sum(a.importe) importe "
        lstrSQL = lstrSQL & " from faccmp_baucher_tcredito a inner join medios_pago b on a.cod_mpago=b.codigo and a.tarjeta_tipo=b.transact_tipo_tarjeta "
        lstrSQL = lstrSQL & " inner join ma_sesion_pagos_tarjeta c on b.transact_id_tarjeta=c.tarjeta_id and b.transact_tipo_tarjeta=c.tarjeta_tipo "
        lstrSQL = lstrSQL & " and a.moneda=c.moneda and a.nro_plan=c.planid"
        lstrSQL = lstrSQL & " inner join proveedores d on c.cod_prov=d.nro_prov"
        lstrSQL = lstrSQL & " where cod_emp=" & val(txtEmpresa.text)
        lstrSQL = lstrSQL & " and a.cod_doc = " & val(txtCodDoc.text)
        lstrSQL = lstrSQL & " and a.nro_doc = " & val(txtDoc.text)
        lstrSQL = lstrSQL & " and a.cod_prov = " & val(txtCodProv.text)
        lstrSQL = lstrSQL & " and c.cod_prov<>0"
        lstrSQL = lstrSQL & " Group by c.cod_prov,d.rsocial_prov,d.ruc_prov,c.cod_doc,c.cod_insumo,a.cod_mpago "
    End If
    
    If ConfPosLink_Habilitado = "S" Then
        lstrSQL = "select c.cod_prov,d.rsocial_prov,d.ruc_prov,c.cod_doc,c.cod_insumo,a.cod_mpago,sum(a.importe) importe "
        lstrSQL = lstrSQL & " from faccmp_baucher_tcredito a inner join medios_pago b on a.cod_mpago=b.codigo and a.tarjeta_tipo=b.poslink_tipo_tarjeta "
        lstrSQL = lstrSQL & " inner join ma_sesion_pagos_tarjeta c on b.poslink_id_tarjeta=c.tarjeta_id and b.poslink_tipo_tarjeta=c.tarjeta_tipo "
        lstrSQL = lstrSQL & " and a.moneda=c.moneda and a.cod_mayorista=c.planid"
        lstrSQL = lstrSQL & " inner join proveedores d on c.cod_prov=d.nro_prov"
        lstrSQL = lstrSQL & " where cod_emp=" & val(txtEmpresa.text)
        lstrSQL = lstrSQL & " and a.cod_doc = " & val(txtCodDoc.text)
        lstrSQL = lstrSQL & " and a.nro_doc = " & val(txtDoc.text)
        lstrSQL = lstrSQL & " and a.cod_prov = " & val(txtCodProv.text)
        lstrSQL = lstrSQL & " and c.cod_prov<>0"
        lstrSQL = lstrSQL & " Group by c.cod_prov,d.rsocial_prov,d.ruc_prov,c.cod_doc,c.cod_insumo,a.cod_mpago "
    End If
    
    If Trim(lstrSQL) = "" Then
        Exit Function
    End If
    
    
    
    Set EC = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
    
    If EC.EOF And EC.BOF Then
        Exit Function
    End If
    
    
    
    
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Alta_Entrega_Cuenta = False
        Exit Function
    End If
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Entrega_Cuenta = False
        Exit Function
    End If
    
      
    
        
    llngNroDoc = 0
    lintLinea = 0
    
    While Not EC.EOF
         If D!signo = -1 Then
              llngCodDoc = EC!cod_doc
         Else
              llngCodDoc = confSesion_Pago_Doc_Devolucion
         End If
    
         If Not Buscar_Tipo_Documento(llngCodDoc, D) Then
              Alta_Entrega_Cuenta = False
              Exit Function
         End If
    
    
         If llngNroDoc = 0 Then
              llngNroDoc = Tomo_Nuevo_Numero_Contador_Documentos(val(txtEmpresa.text), llngCodDoc, "D", True)
         End If
         lintLinea = lintLinea + 1
         
        
         ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, EC!Importe)
         ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, EC!Importe)
    
         lstrSQL = "INSERT INTO Faccmp (cod_emp,cod_doc,nro_doc,cod_prov,nro_int,fec_reg,fec_doc,"
         lstrSQL = lstrSQL & "fec_valor,fec_ent, iva_bas,iva_min,fec_venc,importe,"
         lstrSQL = lstrSQL & "dto_global,redondeo,fec_trans,usuario,con_sin_iva,cod_suc,"
         lstrSQL = lstrSQL & "observa,cofisbas,cofismin,cofisexento,autorizado,"
         lstrSQL = lstrSQL & "lleva_cofis,nom_cli,ruc,forma_pago,seccion,moneda,"
         lstrSQL = lstrSQL & "tipo_cambio,importe_base,importe_ref,redondeo_base,redondeo_ref,nro_rollo,"
         lstrSQL = lstrSQL & "hora,nro_ven,caja,importe_calculado_x_sistema) "
         lstrSQL = lstrSQL & "VALUES("
         lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                                      ' cod_emp
         lstrSQL = lstrSQL & val(llngCodDoc) & ","                                                       ' cod_doc
         lstrSQL = lstrSQL & Trim(llngNroDoc) & ","                                                          ' nro_doc
         lstrSQL = lstrSQL & val(EC!Cod_Prov) & ","                                                      ' cod_prov
         lstrSQL = lstrSQL & "0,"                      ' nro_int
         lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ","                 ' fec_reg
         lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","                            ' fec_doc
         lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","                            ' fec_valor
         lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & "" & ","                       ' fec_ent
         lstrSQL = lstrSQL & "0" & ","                                                                       ' iva_bas
         lstrSQL = lstrSQL & "0" & ","                                                                       ' iva_min
         lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","                    ' fec_venc
         lstrSQL = lstrSQL & CDbl(EC!Importe) & ","                                                     ' importe
         lstrSQL = lstrSQL & CDbl(0) & ","                                                   ' dto_global
         lstrSQL = lstrSQL & CDbl(0)                                                          ' redondeo

    
         ' Documento que No se transfiere - Grabo la Fecha Actual en el campo fec_trans
         lstrSQL = lstrSQL & "," & f_Fecha_Base(TxtFecReg.text, Conf_Motor_Base) & ",'"                  ' fec_trans
    

         lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "','"                               ' usuario
         lstrSQL = lstrSQL & Trim(UCase(e!imp_inc_facturador)) & "',"                    ' con_sin_iva
         lstrSQL = lstrSQL & val(0) & ","                                  ' cod_suc
         lstrSQL = lstrSQL & "'Generado en el Doc " & Trim(txtCodDoc.text) & "/" & Trim(txtDoc.text) & "-" & Trim(txtCodProv.text) & "',"    ' observa
         lstrSQL = lstrSQL & val(0) & ","                       ' cofisbas      - utilizado para grabar el Tipo de Tasa Bromatologica utilizada
         lstrSQL = lstrSQL & val(0) & ","                                   ' cofismin      - utilizado para grabar ahora nro. remito
         lstrSQL = lstrSQL & val(0) & ",'"                                    ' cofisexento   - utilizado para grabar la guia para INAC
       
         If D!Autorizar = "N" Then
            lstrAutorizado = "S"
         Else
            If UCase(Trim(sspOperacion.Caption)) = "U" Then
                lstrAutorizado = "S"
            ElseIf UCase(Trim(sspOperacion.Caption)) = "M" And D!Autorizar = "A" Then
                lstrAutorizado = gValorAutorizar
            Else
                lstrAutorizado = "N"
            End If
         End If
    
         lstrSQL = lstrSQL & Trim(lstrAutorizado) & "','"                                ' autorizado
         lstrSQL = lstrSQL & UCase(Trim("S")) & "','"                         ' lleva_cofis
         lstrSQL = lstrSQL & Trim(UCase(Mid(f_Ins_String(EC!rsocial_prov), 1, 255))) & "','"            ' nom_cli
  
         If Trim(EC!ruc_prov) <> "" Then
            lstrSQL = lstrSQL & Trim(UCase(Mid(EC!ruc_prov, 1, 19))) & "',"             ' ruc
         Else
            lstrSQL = lstrSQL & "X" & "',"                                              ' ruc
         End If
  
         lstrSQL = lstrSQL & val(0) & ","                               ' forma_pago
         lstrSQL = lstrSQL & "0" & ","                                                   ' seccion
         lstrSQL = lstrSQL & val(txtMoneda.text) & ","                                   ' moneda
         lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","                              ' tipo_cambio
         lstrSQL = lstrSQL & ldblImporte_Base & ","                                      ' importe_base
         lstrSQL = lstrSQL & ldblImporte_Referencia & ","                                ' importe_ref
         lstrSQL = lstrSQL & "0,"                                     ' redondeo_base
         lstrSQL = lstrSQL & "0,"                               ' redondeo_ref
         lstrSQL = lstrSQL & CLng(txtLista.text) & ",'"                                  ' nro_rollo
         lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "',"                             ' hora
         lstrSQL = lstrSQL & "0,"                                 ' nro_ven
         lstrSQL = lstrSQL & val(txtCaja.text) & ","                                     ' caja          SS 20170201
         lstrSQL = lstrSQL & CDbl(EC!Importe) & ")"                         ' importe_calculado_x_sistema  AIR 20170904
  
         Dbs.Execute lstrSQL
         
         
         
         lstrSQL = "insert into faccmprelaciones(cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,nro_doca,cod_prova,fec_reg,usuario)"
         lstrSQL = lstrSQL & " values ("
         lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
         lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
         lstrSQL = lstrSQL & Trim(txtDoc.text) & ","
         lstrSQL = lstrSQL & val(txtCodProv.text) & ","
         lstrSQL = lstrSQL & val(lintLinea) & ","
         lstrSQL = lstrSQL & val(llngCodDoc) & ","
         lstrSQL = lstrSQL & Trim(llngNroDoc) & ","
         lstrSQL = lstrSQL & val(EC!Cod_Prov) & ","
         lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"
         lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "')"
         
         Dbs.Execute lstrSQL
         
         
         
         
         lstrHora_Recepcion = Format(time, "HH:MM")
         lstrHora_Entrega = Format(time, "HH:MM")

         lstrSQL = "INSERT INTO Faccmp_Cabezal_Auxiliar (cod_emp,cod_doc,nro_doc,cod_prov,direccion,telefono,tecnico,fecha_recepcion,hora_recepcion,hora_entrega,detalle,fec_reg,usuario,hora_recepcion_string,"
         lstrSQL = lstrSQL & "hora_entrega_string,turno,cod_doc_afectado,nro_doc_afectado,tipo_doc_identidad,cod_doc_pedido,nro_doc_pedido,deposito,deposito_destino,cod_banco,sucursal,tipo_cuenta,moneda,"
         lstrSQL = lstrSQL & "numero_cuenta,contrato,cod_pais,cod_departamento,cod_ciudad,cierre_vendedor,cierre_general,version_movil,latitud,longitud,LugarDestEntRecep,NroIdCompra,"
         lstrSQL = lstrSQL & "tarea_cod_doc,tarea_nro_doc,nro_proceso,clauvta,viatransporte,pais)"
         lstrSQL = lstrSQL & " VALUES("
         lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                                      ' cod_emp
         lstrSQL = lstrSQL & val(llngCodDoc) & ","                                                       ' cod_doc
         lstrSQL = lstrSQL & Trim(llngNroDoc) & ","                                                          ' nro_doc
         lstrSQL = lstrSQL & val(EC!Cod_Prov) & ","
         lstrSQL = lstrSQL & "'','',"                      ' direccion y telefono
         lstrSQL = lstrSQL & "0" & ","                                                           ' tecnico
         lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fecha_recepcion
         lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "','"                                    ' hora_recepcion
         lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "','"                                    ' hora_entrega
         lstrSQL = lstrSQL & "" & "',"                                                           ' detalle
         lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fec_reg
         lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "','"                                       ' usuario
         lstrSQL = lstrSQL & "" & "','"                                                          ' hora_recepcion_string
         lstrSQL = lstrSQL & "" & "','"                                                          ' hora_entrega_string
         lstrSQL = lstrSQL & "" & "',"                                                           ' turno
         lstrSQL = lstrSQL & val(0) & ","                                     ' cod_doc_afectado
         lstrSQL = lstrSQL & val(0) & ","                                 ' nro_doc_afectado
         lstrSQL = lstrSQL & val(0) & ","                                  ' tipo_doc_identidad
         lstrSQL = lstrSQL & val(0) & ","                                       ' cod_doc_pedido
         lstrSQL = lstrSQL & val(0) & ",'"                                          ' nro_doc_pedido
         lstrSQL = lstrSQL & Trim(UCase(txtDeposito.text)) & "','"                               ' deposito
         lstrSQL = lstrSQL & Trim(UCase(txtDeposito.text)) & "',"                                ' deposito_destino
         lstrSQL = lstrSQL & "0" & ","                                                           ' cod_banco
         lstrSQL = lstrSQL & "0" & ",'"                                                          ' sucursal
         lstrSQL = lstrSQL & "" & "',"                                                           ' tipo_cuenta
         lstrSQL = lstrSQL & "0" & ",'"                                                          ' moneda
         lstrSQL = lstrSQL & "" & "','"                                                          ' numero_cuenta
         lstrSQL = lstrSQL & UCase(Left(f_Ins_String(Trim("")), 50)) & "',"            ' contrato   AIR 20160617 agregue comillas ahora es varchar
         lstrSQL = lstrSQL & "0,"                                                  ' cod_pais
         lstrSQL = lstrSQL & "0,"                                          ' cod_departamento
         lstrSQL = lstrSQL & "0,"                                                ' cod_ciudad
         lstrSQL = lstrSQL & "0,"                                                           ' cierre_vendedor           LC 20170201
         lstrSQL = lstrSQL & "0,"                                                           ' cierre_general            LC 20170201
         lstrSQL = lstrSQL & "''" & ","                                                          ' version_movil             LC 20170228
         lstrSQL = lstrSQL & "0,"                                                           ' latitud                   LC 20170208
         lstrSQL = lstrSQL & "0,'','',"                                                          ' longitud                  LC 20170208
         lstrSQL = lstrSQL & val(0) & ","                           ' tarea_cod_doc             JE 20180205
         lstrSQL = lstrSQL & val(0) & ","                                     ' tarea_nro_doc             JE 20180205
         lstrSQL = lstrSQL & Trim(0) & ","                                                                ' nro proceso               JCH 20221025
         lstrSQL = lstrSQL & "'','',0)"                                                         ' campos de exportacion jch 20250613
         
         Dbs.Execute lstrSQL


         lstrSQL = "INSERT INTO FaccmpMpagos (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,"
         lstrSQL = lstrSQL & "importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general)"
         lstrSQL = lstrSQL & " VALUES("
         lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                                      ' cod_emp
         lstrSQL = lstrSQL & val(llngCodDoc) & ","                                                       ' cod_doc
         lstrSQL = lstrSQL & Trim(llngNroDoc) & ","                                                          ' nro_doc
         lstrSQL = lstrSQL & val(EC!Cod_Prov) & ","
         lstrSQL = lstrSQL & CLng(EC!cod_mpago) & ","
         lstrSQL = lstrSQL & EC!Importe & ","
         lstrSQL = lstrSQL & val(txtMoneda.text) & ","
         lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
         lstrSQL = lstrSQL & ldblImporte_Base & ","
         lstrSQL = lstrSQL & ldblImporte_Referencia & ","
         lstrSQL = lstrSQL & EC!Importe & ","
         lstrSQL = lstrSQL & val(txtMoneda.text) & ","
         lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
         lstrSQL = lstrSQL & ldblImporte_Base & ","
         lstrSQL = lstrSQL & ldblImporte_Referencia & ","
         lstrSQL = lstrSQL & CDbl(EC!Importe) & ",'',"
         lstrSQL = lstrSQL & "0" & ","                                      ' cierre vendedor
         lstrSQL = lstrSQL & "0" & ")"                                      ' cierre general
         

         Dbs.Execute lstrSQL
         
         If Busco_Insumo_Servicio(EC!cod_insumo, P) Then
         End If
         
         lstrSQL = "INSERT INTO FaccmpServicios (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,unidades,"
         lstrSQL = lstrSQL & "descripcion,tcofis,tiva,precio,importe,seccion,"
         lstrSQL = lstrSQL & "moneda,tipo_cambio,precio_base,precio_ref,importe_base,importe_ref,codigo,tasa_resguardo, "
         lstrSQL = lstrSQL & "descuento1,descuento2,descuento3) "
         lstrSQL = lstrSQL & " VALUES("
         lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                                      ' cod_emp
         lstrSQL = lstrSQL & val(llngCodDoc) & ","                                                       ' cod_doc
         lstrSQL = lstrSQL & Trim(llngNroDoc) & ","                                                          ' nro_doc
         lstrSQL = lstrSQL & val(EC!Cod_Prov) & ","
         lstrSQL = lstrSQL & "1,1,'" & Trim(P!Descripcion) & "',"                                                        ' nro_linea
         lstrSQL = lstrSQL & val(0) & ","               ' tcofis
         lstrSQL = lstrSQL & val(1) & ","                 ' tiva
         lstrSQL = lstrSQL & CDbl(EC!Importe) & ","              ' precio
         lstrSQL = lstrSQL & CDbl(EC!Importe) & ","             ' importe
         lstrSQL = lstrSQL & CLng(0) & ","             ' seccion
         lstrSQL = lstrSQL & val(txtMoneda.text) & ","                                           ' moneda
         lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","                                      ' tipo_cambio
         lstrSQL = lstrSQL & ldblImporte_Base & ","
         lstrSQL = lstrSQL & ldblImporte_Referencia & ","
         lstrSQL = lstrSQL & ldblImporte_Base & ","                                              ' importe_base
         lstrSQL = lstrSQL & ldblImporte_Referencia & ","                                        ' importe_ref
         lstrSQL = lstrSQL & val(P!codigo) & ","               ' codigo
         lstrSQL = lstrSQL & val(0) & ","       ' tasa_resguardo
         lstrSQL = lstrSQL & "0" & ","                                                           ' descuento1
         lstrSQL = lstrSQL & "0" & ","                                                           ' descuento2
         lstrSQL = lstrSQL & "0" & ")"                                                           ' descuento3

         Dbs.Execute lstrSQL

                  
         EC.MoveNext
         
         llngNroDoc = 0
    
    
    Wend
    
    If llngNroDoc <> llngNroDocIni Then
    
    
    End If
    
    
    

Exit Function

Errores:

    Call FErrores
    Alta_Entrega_Cuenta = False
       
End Function





Public Function Alta_Temporal_Datos_Pedidos() As Boolean
Dim D As Recordset
Dim RP As Recordset
Dim lstrTabla As String
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Temporal_Datos_Pedidos = True
    
    If UCase(Trim(sspOperacion.Caption)) = "M" Or UCase(Trim(sspOperacion.Caption)) = "U" Then
    Else
        Exit Function
    End If

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Temporal_Datos_Pedidos = False
        Exit Function
    End If

    If D!signo = -1 Then
        lstrTabla = "FaccmpPedidos"
    Else
        lstrTabla = "FaccmpDevoluciones"
    End If
    
    'Hacemos este proceso previo a eliminar ya que puede que el documento haya venido a raiz de un pedido o preventa y debemos volver
    ' a afectarlo como estaba
    If Trim(lNombre_Tabla_Temporal) <> "" Then
        'si existe la tabla, significa que no es necesario crearla porque se agrego otro pedido
        lstrSQL = "SELECT * FROM " & lstrTabla
        lstrSQL = lstrSQL & " WHERE cod_emp=" & CLng(txtEmpresa.text)
        lstrSQL = lstrSQL & " AND cod_doc = " & CLng(txtCodDoc.text)
        lstrSQL = lstrSQL & " AND nro_doc = " & CLng(txtDoc.text)
        lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
        lstrSQL = lstrSQL & " ORDER BY cod_doc, nro_doc"
        
        Set RP = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        lLinea = 0
        Do While Not RP.EOF
            lstrSQL = "INSERT INTO " & lNombre_Tabla_Temporal
            lstrSQL = lstrSQL & " VALUES(" & RP!cod_doca & ","
            lstrSQL = lstrSQL & RP!nro_doca & ","
            lstrSQL = lstrSQL & f_Fecha_Base(RP!fec_doca, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & f_Fecha_Base(RP!fec_venca, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & "0" & ")"
            
            Dbs.Execute lstrSQL
            
            Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(RP!cod_doca, RP!nro_doca, RP!Cod_Prova)
                                            
            RP.MoveNext
        Loop
        RP.Close
    Else
            
'        'Si no existe, la creamos
'        lNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
'
'        Call Borra_Tabla_Temporal(lNombre_Tabla_Temporal)
'        Call creo_Temporal_Remitos(lNombre_Tabla_Temporal)
       
        lstrSQL = "SELECT * FROM " & lstrTabla
        lstrSQL = lstrSQL & " WHERE cod_emp=" & CLng(txtEmpresa.text)
        lstrSQL = lstrSQL & " AND cod_doc = " & CLng(txtCodDoc.text)
        lstrSQL = lstrSQL & " AND nro_doc = " & CLng(txtDoc.text)
        lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
        lstrSQL = lstrSQL & " ORDER BY cod_doc, nro_doc"
        
        Set RP = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
        'AIR 2019 si no hay informacion en la tabla pedidos ni devoluciones en lstrtabla no hay que crear la tabla temporal,
        '         luego generaba error al tratar de insertar porque no preguntaba por RP.EOF
        
        If Not RP.EOF Then
            'Si no existe, la creamos
            lNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
            
            Call Borra_Tabla_Temporal(lNombre_Tabla_Temporal)
            Call creo_Temporal_Remitos(lNombre_Tabla_Temporal)
             
            lLinea = 0
            Do While Not RP.EOF
                lstrSQL = "INSERT INTO " & lNombre_Tabla_Temporal
                lstrSQL = lstrSQL & " VALUES(" & RP!cod_doca & ","
                lstrSQL = lstrSQL & RP!nro_doca & ","
                lstrSQL = lstrSQL & f_Fecha_Base(RP!fec_doca, Conf_Motor_Base) & ","
                lstrSQL = lstrSQL & f_Fecha_Base(RP!fec_venca, Conf_Motor_Base) & ","
                lstrSQL = lstrSQL & "0" & ")"
                
                Dbs.Execute lstrSQL
                
                Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(RP!cod_doca, RP!nro_doca, RP!Cod_Prova)
                                        
                RP.MoveNext
            Loop
        Else
            lNombre_Tabla_Temporal = ""
        End If
        RP.Close
    End If
    
    'Eliminacion EFECTIVA luego del proceso anterior solo ante una modificacion!
    '######################################
    Call Eliminar_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))

Exit Function

Errores:
    Call FErrores
    Alta_Temporal_Datos_Pedidos = False

End Function

Public Function Alta_Pedidos(ByRef plngNumero_Pedido As Long) As Boolean
Dim lbolHay_Pedido_Afectado As Boolean
Dim lstrTabla As String
Dim lstrSQL As String
Dim D As Recordset
Dim RP As Recordset
Dim RD As Recordset
Dim lrstDocsPend As Recordset
Dim llngLinea As Long

On Error GoTo Errores

    Alta_Pedidos = True

    'Afectamos el PEDIDOS Al DOCUMENTO si es necesario solo si no es el pedido
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Pedidos = False
        Exit Function
    End If
    
    plngNumero_Pedido = 0
    lbolHay_Pedido_Afectado = False
    'AIR 20230725 se agrega el pedido Web
    'AIR 20250725 se agrega el pedido API
    'If val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli Or ConfControla_Saldo_Cantidad_Por_Documento Then  ' SS 20160128
    If (val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli_Web) Or ConfControla_Saldo_Cantidad_Por_Documento Then   ' SS 20160128
        If Trim(lNombre_Tabla_Temporal) <> "" And nro_doc_Wis = "" Then
                
            ' El Documento Se Genero desde un Pedido o Remito
            
            If D!signo = -1 Then
                lstrTabla = "FaccmpPedidos"
            Else
                lstrTabla = "FaccmpDevoluciones"
            End If
            
            lstrSQL = " SELECT * FROM " & lNombre_Tabla_Temporal & " ORDER BY cod_doc, nro_doc"
            Set RP = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            
            llngLinea = 0
            Do While Not RP.EOF
                
                lbolHay_Pedido_Afectado = True
                
                'Se cancela el pedido en la tabla de interfase WIS.
                If ConfWIS_INTERFASE_PEDIDOS And RP!cod_doc = ConfDoc_Ingreso_Pedido_Cli Then
                    If D!signo = -1 Then
                        lstrSQL = "SELECT max(nro_linea) as maximo FROM faccmppedidos "
                        lstrSQL = lstrSQL & " WHERE nro_doca = " & RP!nro_doc
                        lstrSQL = lstrSQL & " AND cod_prova = " & CLng(txtCodProv.text)
                        lstrSQL = lstrSQL & " AND cod_emp=" & CLng(txtEmpresa.text)
                        Set MAX = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                        If Not MAX.EOF Then
                            If IsNull(MAX!Maximo) Then
                                llngLinea = llngLinea + 1
                            Else
                                llngLinea = MAX!Maximo + 1
                            End If
                        End If
                        MAX.Close
                        
                        plngNumero_Pedido = RP!nro_doc
                        lstrSQL = "INSERT INTO " & lstrTabla & " (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
                        lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
                        lstrSQL = lstrSQL & " VALUES("
                        lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                        lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                        lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                        lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                        lstrSQL = lstrSQL & llngLinea & ","
                        lstrSQL = lstrSQL & RP!cod_doc & ","
                        lstrSQL = lstrSQL & RP!nro_doc & ","
                        lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                        lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
                        lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","
                        lstrSQL = lstrSQL & "1" & ","
                        lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
                        lstrSQL = lstrSQL & CLng(txtMoneda.text) & ")"
            
                        Dbs.Execute lstrSQL

                        lstrSQL = "UPDATE wis_pedidos_clientes "
                        lstrSQL = lstrSQL & " SET usuarioa = '" & Trim(gUsuario) & "',"
                        lstrSQL = lstrSQL & " fec_rega = " & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base)
                        lstrSQL = lstrSQL & " WHERE nro_doc = " & RP!nro_doc
                        'AIR 20231013 de futuro van a poder llegar otros codigos.
                        lstrSQL = lstrSQL & " AND cod_doc = " & RP!cod_doc
                        lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
                        lstrSQL = lstrSQL & " AND usuarioa is null "
                        lstrSQL = lstrSQL & " AND fec_rega is null"
                        
                        Dbs.Execute lstrSQL
                        
                        'Se actualiza el cod_doca por si es uno que vuelve
                        lstrSQL = "UPDATE faccmppedidos "
                        lstrSQL = lstrSQL & " SET cod_doca = " & ConfDoc_Ingreso_Pedido_Cli
                        lstrSQL = lstrSQL & " WHERE cod_doca is null "
                        lstrSQL = lstrSQL & " AND nro_doca = " & RP!nro_doc
                        lstrSQL = lstrSQL & " AND cod_prova=" & CLng(txtCodProv.text)
                        
                        Dbs.Execute lstrSQL

                        Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(RP!cod_doc, RP!nro_doc, txtCodProv.text)
                                                
                    End If
                Else
                    
                    llngLinea = llngLinea + 1
                    plngNumero_Pedido = RP!nro_doc
                    
                    lstrSQL = "INSERT INTO " & lstrTabla & " (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
                    lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
                    lstrSQL = lstrSQL & " VALUES("
                    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & llngLinea & ","
                    lstrSQL = lstrSQL & RP!cod_doc & ","
                    lstrSQL = lstrSQL & RP!nro_doc & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & "1" & ","
                    lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
                    lstrSQL = lstrSQL & CLng(txtMoneda.text) & ")"
        
                    Dbs.Execute lstrSQL
                    
                    'Para matar las cuotas pendientes al hacer nota de credito
                    If lstrTabla = "FaccmpDevoluciones" Then
                        
                        lstrSQL = "DELETE FROM faccmp_cuotas "
                        lstrSQL = lstrSQL & " WHERE cod_doc = " & RP!cod_doc
                        lstrSQL = lstrSQL & " AND nro_doc = " & RP!nro_doc
                        lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
                        lstrSQL = lstrSQL & " AND cod_emp=" & CLng(txtEmpresa.text)
                        
                        Dbs.Execute lstrSQL
                        
                    End If
                    
                    Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(RP!cod_doc, RP!nro_doc, txtCodProv.text)
                                                                
                End If
                
                If Buscar_Tipo_Documento(RP!cod_doc, RD) Then
                    If RD!cod_doc_contrasiento <> 0 Then
                        ' Genero el Documento por la Diferencia de lo Ingresado en el Documento
                        Call Generar_Documento_Contrasiento_x_la_Diferencia(val(txtEmpresa.text), RP!cod_doc, RP!nro_doc, txtCodProv.text, TxtCodSuc.text, sspOperacion.Caption, vsfLineas_Mercaderia, CGL_CODIGO, CGL_UNIDADES)
                    End If
                End If
                
                RP.MoveNext
                
            Loop
            
'            ' Veo si el documento dado de alta controla saldos y Grabo en FaccmpLineas_Pendientes       SS 20160201
'            If ConfControla_Saldo_Cantidad_Por_Documento Then
'
'                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
'                lstrSQL = lstrSQL & " WHERE cod_doc =" & CLng(txtCodDoc.text)
'                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
'
'                ' AFECTANDO, REFERENCIANDO a un documento original
'                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
'                If Not lrstDocsPend.EOF Then
'
'                    If Not Guardar_Lineas_Pendientes("R", lrstDocsPend!signo_en_control_pendientes) Then
'                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
'                    End If
'
'                End If
'                lrstDocsPend.Close
'
'                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
'                lstrSQL = lstrSQL & " WHERE cod_doc_valido =" & CLng(txtCodDoc.text)
'                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
'
'                ' DANDO DE ALTA el documento original
'                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
'                If Not lrstDocsPend.EOF Then
'
'                    If Not Guardar_Lineas_Pendientes("O", lrstDocsPend!signo_en_control_pendientes) Then
'                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
'                    End If
'
'                End If
'                lrstDocsPend.Close
'
'            End If ' ---------------------------------------------------------------------------------------------------
            
            
            If Not lbolHay_Pedido_Afectado Then
            
                If val(txtDoc_Remito.text) <> 0 And val(txtRemito.text) <> 0 Then
                
                    llngLinea = llngLinea + 1
                    
                    lstrSQL = "INSERT INTO FaccmpPedidos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
                    lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
                    lstrSQL = lstrSQL & " VALUES("
                    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & llngLinea & ","
                    lstrSQL = lstrSQL & val(txtDoc_Remito.text) & ","
                    lstrSQL = lstrSQL & val(txtRemito.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & "1" & ","
                    lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
                    lstrSQL = lstrSQL & CLng(txtMoneda.text) & ")"
        
                    Dbs.Execute lstrSQL
                                
                    Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(val(txtDoc_Remito.text), val(txtRemito.text), val(txtCodProv.text))
                                                                
                End If
            
            End If
        Else
             ' AIR 20190909 comentado aqui y se saca de fuera del if este procedimiento.
'            ' --------------------------------------------------------------------------------------------------
'            ' Grabacion en FaccmpLineas_Pendientes, del documento pendiente         SS 20160201
'
'            If ConfControla_Saldo_Cantidad_Por_Documento Then
'
'                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
'                lstrSQL = lstrSQL & " WHERE cod_doc_valido =" & CLng(txtCodDoc.text)
'                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
'
'                '  DANDO DE ALTA el documento original
'                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
'                If Not lrstDocsPend.EOF Then
'
'                    If Not Guardar_Lineas_Pendientes("O", lrstDocsPend!signo_en_control_pendientes) Then
'                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
'                    End If
'
'                End If
'                lrstDocsPend.Close
'
'                ' Caso de notas de credito/devolucion referenciadas a facturas, no ingresadas por F10
'                If Val(txtDoc_Afectado.text) <> 0 And Val(txtNro_Doc_Afectado.text) <> 0 Then
'
'                    lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
'                    lstrSQL = lstrSQL & " WHERE cod_doc =" & CLng(txtCodDoc.text)
'                    lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "
'
'                    ' AFECTANDO, REFERENCIANDO a un documento original
'                    Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
'                    If Not lrstDocsPend.EOF Then
'
'                        If Not Guardar_Lineas_Pendientes("N", lrstDocsPend!signo_en_control_pendientes) Then
'                            MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
'                        End If
'                    End If
'                    lrstDocsPend.Close
'
'                End If
'            End If
                    
        End If
        
        ' AIR 20190909 se saca del (if Trim(lNombre_Tabla_Temporal) <> "" And nro_doc_Wis = "" ), la evaluacion del F10 y se indepediza de la var lNombre_Tabla_Temporal que inducia a errores
        If gbln_Cargo_Datos_Desde_F10 = True Then
            
            If ConfControla_Saldo_Cantidad_Por_Documento Then
            
                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
                lstrSQL = lstrSQL & " WHERE cod_doc =" & CLng(txtCodDoc.text)
                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112

                ' AFECTANDO, REFERENCIANDO a un documento original
                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                If Not lrstDocsPend.EOF Then
                
                    If Not Guardar_Lineas_Pendientes("R", lrstDocsPend!signo_en_control_pendientes) Then
                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
                    End If
                
                End If
                lrstDocsPend.Close
                
                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
                lstrSQL = lstrSQL & " WHERE cod_doc_valido =" & CLng(txtCodDoc.text)
                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
                
                ' DANDO DE ALTA el documento original
                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                If Not lrstDocsPend.EOF Then
                
                    If Not Guardar_Lineas_Pendientes("O", lrstDocsPend!signo_en_control_pendientes) Then
                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
                    End If
                    
                End If
                lrstDocsPend.Close
                
            End If ' ---------------------------------------------------------------------------------------------------
        
        Else
            ' --------------------------------------------------------------------------------------------------
            ' Grabacion en FaccmpLineas_Pendientes, del documento pendiente         SS 20160201
            
            If ConfControla_Saldo_Cantidad_Por_Documento Then
            
                lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
                lstrSQL = lstrSQL & " WHERE cod_doc_valido =" & CLng(txtCodDoc.text)
                lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "  'solo para las definiciones para control de cantidades pendientes (F10) SS 20180112
                
                '  DANDO DE ALTA el documento original
                Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                
                If Not lrstDocsPend.EOF Then
                
                    If Not Guardar_Lineas_Pendientes("O", lrstDocsPend!signo_en_control_pendientes) Then
                        MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
                    End If
                    
                End If
                lrstDocsPend.Close
                
                ' Caso de notas de credito/devolucion referenciadas a facturas, no ingresadas por F10
                If val(txtDoc_Afectado.text) <> 0 And val(txtNro_Doc_Afectado.text) <> 0 Then
                
                    lstrSQL = "SELECT * FROM ma_Tipos_Docs_Pendientes_Validos "
                    lstrSQL = lstrSQL & " WHERE cod_doc =" & CLng(txtCodDoc.text)
                    lstrSQL = lstrSQL & " AND   utilizar_en_control_pendientes = 'S' "
    
                    ' AFECTANDO, REFERENCIANDO a un documento original
                    Set lrstDocsPend = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                    If Not lrstDocsPend.EOF Then
                        
                        If Not Guardar_Lineas_Pendientes("N", lrstDocsPend!signo_en_control_pendientes) Then
                            MsgBox "ERROR: Al grabar documentos pendientes. Verifique por favor...", vbCritical + vbOKOnly
                        End If
                        
                        'AIR 20251215
                        If D!mueve_merca_serv = "S" And D!signo = 1 Then
                            lstrSQL = "SELECT * FROM FaccmpPedidos "
                            lstrSQL = lstrSQL & " WHERE cod_emp  =" & val(txtEmpresa.text)
                            lstrSQL = lstrSQL & " AND   cod_doc =" & val(txtDoc_Afectado.text)
                            lstrSQL = lstrSQL & " AND   nro_doc = " & val(txtNro_Doc_Afectado)
                            lstrSQL = lstrSQL & " AND   cod_prov = " & val(txtCodProv)
                            Set RP = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                            
                            If Not RP.EOF Then
                                lstrSQL = "DELETE FROM FaccmpPedidos "
                                lstrSQL = lstrSQL & "WHERE "
                                lstrSQL = lstrSQL & " cod_emp = " & CLng(txtEmpresa.text)
                                lstrSQL = lstrSQL & " AND cod_doc = " & val(txtDoc_Afectado.text)
                                lstrSQL = lstrSQL & " AND nro_doc = " & val(txtNro_Doc_Afectado.text)
                                lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
                    
                                Dbs.Execute lstrSQL
                                Call Cargo_Logtrans("PUNTOVTA Baja Factura FaccmpPedidos x Devolucion:" & Trim(txtCodDoc.text) & "-" & Trim(txtDoc.text) & "-" & Trim(txtCodProv.text) & "/Rto: " & Trim(RP!cod_doca) & " - " & Trim(RP!nro_doca))
                            End If
                        
                        End If
                    End If
                    lrstDocsPend.Close
                
                End If
            End If
        End If
        
        '--------------------------------------------------------------------------
        
    Else
    
        If val(txtDoc_Remito.text) <> 0 And val(txtRemito.text) <> 0 Then
        
            llngLinea = llngLinea + 1
            
            lstrSQL = "INSERT INTO FaccmpPedidos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
            lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
            lstrSQL = lstrSQL & " VALUES("
            lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
            lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
            lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
            lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
            lstrSQL = lstrSQL & llngLinea & ","
            lstrSQL = lstrSQL & val(txtDoc_Remito.text) & ","
            lstrSQL = lstrSQL & val(txtRemito.text) & ","
            lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
            lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & "1" & ","
            lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
            lstrSQL = lstrSQL & CLng(txtMoneda.text) & ")"

            Dbs.Execute lstrSQL
                        
            Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(val(txtDoc_Remito.text), val(txtRemito.text), val(txtCodProv.text))
        End If
    End If

Exit Function

Errores:
'Resume
    Call FErrores
    Alta_Pedidos = False
   
End Function


Function ValorEncontrado(ByRef vector() As Long, ByVal valor1 As Long, valor2 As Long) As Boolean
    Dim encontrado As Boolean
  
    Dim i As Integer
    encontrado = False

    i = 1
    Do While Not encontrado And i = UBound(vector)
        If vector(i, 1) = valor1 And vector(i, 2) = valor2 Then
            encontrado = True
        Else
            If vector(i, 1) = 0 And vector(i, 2) = 0 Then
                Exit Do
            End If
        End If
        i = i + 1
    Loop
    ValorEncontrado = encontrado
    
End Function

Public Function Actualizar_Pedidos_F10_en_Moviles()

Dim lrstFactPend As Recordset
Dim lvecpedidos_afectados(500, 2) As Long


On Error GoTo Errores

    If gbln_Cargo_Datos_Desde_F10 = True Then
        
        If ConfControla_Saldo_Cantidad_Por_Documento Then
                    
            ' AIR 20200702 se agrega la actualizacion de los documentos de pedidos si fueron levantados en el movil
            ' AIR 20200720 se agrega que recorra la grilla de las lineas de mercaderia para verificar cada documento afectado si queda con saldo en 0 para darlos por procesados en el movil
            ' CGL_COD_DOC_REF
            ' CGL_NRO_DOC_REF
                
            For i = 1 To vsfLineas_Mercaderia.Rows - 1
                
                If Not ValorEncontrado(lvecpedidos_afectados, val(vsfLineas_Mercaderia.TextMatrix(i, CGL_COD_DOC_REF)), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_DOC_REF))) Then
                    lvecpedidos_afectados(i, 1) = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_COD_DOC_REF))
                    lvecpedidos_afectados(i, 2) = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_NRO_DOC_REF))
                End If
            Next
            
            If val(lvecpedidos_afectados(1, 1)) <> 0 Then
                For i = 1 To UBound(lvecpedidos_afectados)
                    If val(lvecpedidos_afectados(i, 1)) <> 0 Then
                        'Veo si el pedido de referencia , esta en el circuito de pendientes y si ya no hay pendientes se da por completo el pedido en el movil
                        
                        SQL = "SELECT isnull(sum(cant_prod),0) AS TotCant FROM FaccmpLineas_Pendientes "
                        SQL = SQL & " INNER JOIN Faccmp ON Faccmp.cod_emp = FaccmpLineas_Pendientes.cod_emp "
                        SQL = SQL & " AND faccmp.cod_doc = FaccmpLineas_Pendientes.cod_doc "
                        SQL = SQL & " AND faccmp.nro_doc = FaccmpLineas_Pendientes.nro_doc "
                        SQL = SQL & " AND faccmp.cod_prov = FaccmpLineas_Pendientes.cod_prov "
                        SQL = SQL & " WHERE  FaccmpLineas_Pendientes.cod_emp  = " & val(txtEmpresa.text)
                        SQL = SQL & " AND   cod_doca = " & lvecpedidos_afectados(i, 1)
                        SQL = SQL & " AND   nro_doca = " & lvecpedidos_afectados(i, 2)
                        SQL = SQL & " AND   cod_prova = " & val(txtCodProv.text)
                        SQL = SQL & " AND   faccmp.autorizado = 'S'"
                        SQL = SQL & " GROUP BY FaccmpLineas_Pendientes.cod_emp,cod_doca,nro_doca,cod_prova"
                        
                        Set lrstFactPend = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                                                                
                        If Not (lrstFactPend.EOF And lrstFactPend.BOF) Then
                           If NullToZero(lrstFactPend!TotCant) = 0 Then
                               Call Actualizar_Tabla_MOVIL_Documentos_Cabezal(val(lvecpedidos_afectados(i, 1)), val(lvecpedidos_afectados(i, 2)), val(txtCodProv.text))
                           End If
                        End If
                    Else
                        Exit For
                    End If
                Next i
            End If
    
        End If ' ---------------------------------------------------------------------------------------------------
    End If
    Actualizar_Pedidos_F10_en_Moviles = True
    
Exit Function

Errores:

    Call FErrores
    Actualizar_Pedidos_F10_en_Moviles = False
   
End Function


Public Function Alta_Cuenta_Madre(pdblImporte_Base As Double, pdblImporte_Referencia As Double, pdblRedondeo_Base As Double, pdblRedondeo_Referencia As Double) As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Cuenta_Madre = True

    If val(txtCta_Madre.text) <> 0 Then
        
        lstrSQL = "INSERT INTO Faccmp_Cuentas_Madres (cod_emp,cod_doc,nro_doc,cod_prov,cuenta_madre,fec_reg,usuario)"
        lstrSQL = lstrSQL & " VALUES("
        lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
        lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
        lstrSQL = lstrSQL & val(txtDoc.text) & ","
        lstrSQL = lstrSQL & val(txtCodProv.text) & ","
        lstrSQL = lstrSQL & val(txtCta_Madre.text) & ","
        lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ",'"
        lstrSQL = lstrSQL & Trim(UCase(gUsuario)) & "')"
        
        Dbs.Execute lstrSQL
        
        If Not Alta_Documento_Cuenta_Madre(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCta_Madre.text), txtFec_Doc.text, txtFec_Vencimiento.text, txtObs.text, val(txtForma_Pago.text), val(txtLista.text), val(txtVendedor.text), val(txtMoneda.text), val(txtTipo_Cambio.text), pdblImporte_Base, pdblImporte_Referencia, pdblRedondeo_Base, pdblRedondeo_Referencia) Then
            MsgBox "ERROR: Al Dar de Alta el Cabezal del Documento de la Cuenta Madre. Verifique por favor...", vbCritical + vbOKOnly
            Alta_Cuenta_Madre = False
            Exit Function
        End If
 
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Cuenta_Madre = False

End Function

Public Function Alta_Acopio() As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Acopio = True

    If val(txtAcopio.text) <> 0 Then
        
        lstrSQL = "INSERT INTO Faccmp_Acopios (cod_emp,cod_doc,nro_doc,cod_prov,cod_acopio,fec_reg,usuario,ci_persona_autorizada)"
        lstrSQL = lstrSQL & " VALUES("
        lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
        lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
        lstrSQL = lstrSQL & val(txtDoc.text) & ","
        lstrSQL = lstrSQL & val(txtCodProv.text) & ","
        lstrSQL = lstrSQL & val(txtAcopio.text) & ","
        lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ",'"
        lstrSQL = lstrSQL & Trim(UCase(gUsuario)) & "','"
        lstrSQL = lstrSQL & Trim(txtCI_Persona_Autorizada.text) & "')"
        
        Dbs.Execute lstrSQL
         
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Acopio = False

End Function


Public Function Alta_Cabezal_Auxiliar() As Boolean
Dim CA As Recordset         'AIR 20171114
Dim SU As Recordset         'AIR 20171114
Dim e As Recordset
Dim T As Recordset
Dim DC As Recordset
Dim S As Recordset
Dim D As Recordset

Dim lstrContrato As String
Dim lstrLugarDestEntRecep As String
Dim lstrHora_Recepcion As String
Dim lstrHora_Entrega As String
Dim lstrSQL As String
Dim llngAnio_Mes As Long
Dim llngDia As Long

On Error GoTo Errores

    Alta_Cabezal_Auxiliar = True

    If txtContrato.text <> "" Then
        lstrContrato = txtContrato.text
    Else
        lstrContrato = TxtContrato_Externo.text
    End If
    
    'AIR 20171114 si el cliente esta asociado a ASU se busca el codigo del LugarDestEntRecep en la Sucursal
    
    lstrLugarDestEntRecep = ""
    If Buscar_Empresa(val(txtEmpresa.text), CA) Then
        If CA!Asociado_ASU = "S" Then
            If Buscar_Sucursal(val(txtCodProv.text), val(TxtCodSuc.text), SU) Then
                lstrLugarDestEntRecep = SU!LugarDestEntRecep
            End If
        End If
    End If
    
    lstrHora_Recepcion = Format(time, "HH:MM")
    lstrHora_Entrega = Format(time, "HH:MM")
    
    lstrSQL = "INSERT INTO Faccmp_Cabezal_Auxiliar (cod_emp,cod_doc,nro_doc,cod_prov,direccion,telefono,tecnico,fecha_recepcion,hora_recepcion,hora_entrega,detalle,fec_reg,usuario,hora_recepcion_string,"
    lstrSQL = lstrSQL & "hora_entrega_string,turno,cod_doc_afectado,nro_doc_afectado,tipo_doc_identidad,cod_doc_pedido,nro_doc_pedido,deposito,deposito_destino,cod_banco,sucursal,tipo_cuenta,moneda,"
    lstrSQL = lstrSQL & "numero_cuenta,contrato,cod_pais,cod_departamento,cod_ciudad,cierre_vendedor,cierre_general,version_movil,latitud,longitud,LugarDestEntRecep,NroIdCompra,tarea_cod_doc,"
    lstrSQL = lstrSQL & "tarea_nro_doc,nro_proceso,clauvta,viatransporte,pais)"
    lstrSQL = lstrSQL & " VALUES("
    lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                          ' cod_emp
    lstrSQL = lstrSQL & val(txtCodDoc.text) & ","                                           ' cod_doc
    lstrSQL = lstrSQL & val(txtDoc.text) & ","                                              ' nro_doc
    lstrSQL = lstrSQL & val(txtCodProv.text) & ",'"                                         ' cod_prov
    lstrSQL = lstrSQL & Left(f_Ins_String(gstrDireccion), 100) & "','"                      ' direccion
    lstrSQL = lstrSQL & Left(f_Ins_String(gstrTelefonos), 100) & "',"                       ' telefono
    lstrSQL = lstrSQL & "0" & ","                                                           ' tecnico
    lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fecha_recepcion
    lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "','"                                    ' hora_recepcion
    lstrSQL = lstrSQL & Format(time, "HH:MM:SS") & "','"                                    ' hora_entrega
    lstrSQL = lstrSQL & "" & "',"                                                           ' detalle
    lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fec_reg
    lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "','"                                       ' usuario
    lstrSQL = lstrSQL & "" & "','"                                                          ' hora_recepcion_string
    lstrSQL = lstrSQL & "" & "','"                                                          ' hora_entrega_string
    lstrSQL = lstrSQL & "" & "',"                                                           ' turno
    lstrSQL = lstrSQL & val(txtDoc_Afectado.text) & ","                                     ' cod_doc_afectado
    lstrSQL = lstrSQL & val(txtNro_Doc_Afectado.text) & ","                                 ' nro_doc_afectado
    lstrSQL = lstrSQL & glngTipo_Documento_Identidad & ","                                  ' tipo_doc_identidad
    lstrSQL = lstrSQL & val(txtDoc_Remito.text) & ","                                       ' cod_doc_pedido
    lstrSQL = lstrSQL & val(txtRemito.text) & ",'"                                          ' nro_doc_pedido
    lstrSQL = lstrSQL & Trim(UCase(txtDeposito.text)) & "','"                               ' deposito
    lstrSQL = lstrSQL & Trim(UCase(txtDeposito.text)) & "',"                                ' deposito_destino
    lstrSQL = lstrSQL & "0" & ","                                                           ' cod_banco
    lstrSQL = lstrSQL & "0" & ",'"                                                          ' sucursal
    lstrSQL = lstrSQL & "" & "',"                                                           ' tipo_cuenta
    lstrSQL = lstrSQL & "0" & ",'"                                                          ' moneda
    lstrSQL = lstrSQL & "" & "','"                                                          ' numero_cuenta
    lstrSQL = lstrSQL & UCase(Left(f_Ins_String(Trim(lstrContrato)), 50)) & "',"            ' contrato   AIR 20160617 agregue comillas ahora es varchar
    lstrSQL = lstrSQL & glngCod_Pais & ","                                                  ' cod_pais
    lstrSQL = lstrSQL & glngCod_Departamento & ","                                          ' cod_departamento
    lstrSQL = lstrSQL & glngCod_Ciudad & ","                                                ' cod_ciudad
    lstrSQL = lstrSQL & "0" & ","                                                           ' cierre_vendedor           LC 20170201
    lstrSQL = lstrSQL & "0" & ","                                                           ' cierre_general            LC 20170201
    lstrSQL = lstrSQL & "''" & ","                                                          ' version_movil             LC 20170228
    lstrSQL = lstrSQL & "0" & ","                                                           ' latitud                   LC 20170208
    lstrSQL = lstrSQL & "0" & ",'"                                                          ' longitud                  LC 20170208
    lstrSQL = lstrSQL & lstrLugarDestEntRecep & "','"                                       ' LugarDestEntRecep         AIR 20171114
    lstrSQL = lstrSQL & UCase(Left(f_Ins_String(Trim(TxtNroIdCompra.text)), 50)) & "',"     ' NroIdCompra               AIR 20171114                                                     ' NroIdCompra       AIR 20171114
    lstrSQL = lstrSQL & val(txtTarea_Codigo_Documento.text) & ","                           ' tarea_cod_doc             JE 20180205
    lstrSQL = lstrSQL & val(txtTarea_Numero.text) & ","                                     ' tarea_nro_doc             JE 20180205
    lstrSQL = lstrSQL & Trim(gNroProceso) & ","                                             ' nro proceso               JCH 20221025
    
    
     'Se guarda el vinculo con el CAE
     
    If Buscar_Tipo_Documento(txtCodDoc.text, D) Then
    End If
     
    If Trim(D!exportacion) = "S" Then
        lstrSQL = lstrSQL & "'" & Trim(txtClauVta.text) & "',"
        lstrSQL = lstrSQL & "'" & Trim(txtViaTransporte.text) & "',"
        lstrSQL = lstrSQL & val(Mid(txtPais.text, 1, 3)) & ")"
    Else
        lstrSQL = lstrSQL & "'','',0)"
    End If
             
              
    Dbs.Execute lstrSQL
    
    If val(txtTarea_Codigo_Documento.text) <> 0 And val(txtTarea_Numero.text) <> 0 Then
        
        ' JE 20181123   /   Si se agrego una tarea asociada paso esta al estado FACTURADO
        
        If Busco_Estado_Tarea_Segun_Tipo("F", e) Then
        
            If Buscar_Cabezal_Documento_Tarea(val(txtEmpresa.text), val(txtTarea_Codigo_Documento.text), val(txtTarea_Numero.text), T) Then
            
                lstrSQL = "UPDATE Faccmp_Tareas"
                lstrSQL = lstrSQL & " SET estado = " & e!codigo
                lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                lstrSQL = lstrSQL & " AND cod_doc = " & val(txtTarea_Codigo_Documento.text)
                lstrSQL = lstrSQL & " AND nro_doc = " & val(txtTarea_Numero.text)
                
                Dbs.Execute lstrSQL
        
                If Buscar_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtTarea_Codigo_Documento.text), val(txtTarea_Numero.text), DC) Then
                
                    llngAnio_Mes = (Year(DC!fec_doc) * 100) + Month(DC!fec_doc)
                    llngDia = Day(DC!fec_doc)
                
                    If Buscar_Seguimiento_Tarea_Servicio(val(txtEmpresa.text), val(txtTarea_Codigo_Documento.text), val(txtTarea_Numero.text), llngAnio_Mes, llngDia, 0, S) Then
        
                        Call Cargo_Log_Cambios_Seguimiento_Tareas(val(txtEmpresa.text), val(txtTarea_Codigo_Documento.text), val(txtTarea_Numero.text), llngAnio_Mes, llngDia, 0, S!prioridad, e!codigo, S!conformidad_cod_doc, S!conformidad_nro_doc, S!conformidad_cod_prov, S!fecha_programada)
                    End If
                End If
            End If
        End If
    End If
    
Exit Function

Errores:
    Call FErrores
    Alta_Cabezal_Auxiliar = False

End Function

Public Function Alta_Tablas_WIS() As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Tablas_WIS = True
    
    If ConfProceso_Datos_WIS = True And ConfProceso_Productos_WIS = "CLON" Then
    
        lstrSQL = "UPDATE wis_facturaciones "
        lstrSQL = lstrSQL & " SET cod_doca = " & val(txtCodDoc.text) & ","
        lstrSQL = lstrSQL & " nro_doca = " & val(txtDoc.text) & ","
        lstrSQL = lstrSQL & " cod_prova = " & txtCodProv.text & ","
        lstrSQL = lstrSQL & " fec_rega = " & f_Fecha_Base(date, Conf_Motor_Base) & ","
        lstrSQL = lstrSQL & " usuarioa = '" & gUsuario & "'"
        lstrSQL = lstrSQL & " WHERE nro_pedido = '" & nro_doc_Wis & "'"
        lstrSQL = lstrSQL & " AND camion = '" & camion_Wis & "'"
        
        Dbs.Execute lstrSQL
        
        Call Cargo_Logtrans("FACTURACION DESDE WIS " & Trim(txtCodDoc.text) & " - " & Trim(txtDoc.text) & Trim(txtCodProv.text) & " WIS: " & nro_doc_Wis)
    
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Tablas_WIS = False

End Function

Public Function Alta_Ficha_Viaje() As Boolean
Dim i As Long
Dim llngLinea As Long
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Ficha_Viaje = True

    If pstrTipo_Ingreso_Documentos = "S" And ConfFicha_Viaje_Cod_Doc_x_Defecto <> 0 Then
    Else
        Exit Function
    End If

    llngLinea = 0

    dbgLineas_Servicios.MoveFirst
    For i = 0 To dbgLineas_Servicios.Rows
                     
        If Trim(dbgLineas_Servicios.Columns("unidades").text) <> "" And Not dbgLineas_Servicios.Columns("eliminada").Value And NullToZero(dbgLineas_Servicios.Columns("ficha_viaje").text) <> 0 Then
            llngLinea = llngLinea + 1
            
            'Actualiza el codigo y numero de factura en la ficha de cliente
            lstrSQL = "UPDATE ma_Fichas_Viaje_Doc_Clientes "
            lstrSQL = lstrSQL & " SET cod_doc_cliente = " & val(txtCodDoc.text)
            lstrSQL = lstrSQL & " , nro_doc_cliente = " & val(txtDoc.text)
            lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
            lstrSQL = lstrSQL & " AND   numero = " & val(dbgLineas_Servicios.Columns("ficha_viaje").text)
            lstrSQL = lstrSQL & " AND   linea = " & val(dbgLineas_Servicios.Columns("ficha_viaje_linea").text)
            
            Dbs.Execute lstrSQL
          
            'Graba la relacion
            lstrSQL = "INSERT INTO FaccmpRelaciones "
            lstrSQL = lstrSQL & " VALUES (" & val(txtEmpresa.text) & ","                            ' cod_emp
            lstrSQL = lstrSQL & val(txtCodDoc.text) & ","                                           ' cod_doc
            lstrSQL = lstrSQL & val(txtDoc.text) & ","                                              ' nro_doc
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                          ' cod_prov
            lstrSQL = lstrSQL & llngLinea & ","                                                     ' nro_linea
            lstrSQL = lstrSQL & ConfFicha_Viaje_Cod_Doc_x_Defecto & ","                             ' cod_doca
            lstrSQL = lstrSQL & val(dbgLineas_Servicios.Columns("ficha_viaje").text) & ","          ' nro_doca
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                          ' cod_prova
            lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fec_reg
            lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "')"                                        ' usuario
            
            Dbs.Execute lstrSQL
          
        End If
        dbgLineas_Servicios.MoveNext
    Next
    dbgLineas_Servicios.MoveFirst

Exit Function

Errores:
    Call FErrores
    Alta_Ficha_Viaje = False

End Function

Public Sub Cargar_Impuestos_Actuales()
Dim lrstImpuesto As Recordset
Dim ldblPorcentaje As Double
    
    SQL = "Select * From Impuestos Where cod_tipo_impuesto = 'IVA' Order by cod_tipo_impuesto,cod_impuesto"
    Set lrstImpuesto = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
    
    ' Inicializo la Coleccion de Impuestos Actuales
    Set gcolImpuestos_Actuales = Nothing
    
    While Not lrstImpuesto.EOF
        ldblPorcentaje = Porcentaje_Impuesto_Vigente(lrstImpuesto!cod_tipo_impuesto, lrstImpuesto!cod_impuesto, date)
        gcolImpuestos_Actuales.Add lrstImpuesto!cod_tipo_impuesto, lrstImpuesto!cod_impuesto, ldblPorcentaje, 0
        
        lrstImpuesto.MoveNext
    Wend
    lrstImpuesto.Close
    
End Sub

Sub Ingreso_Modifico_Datos_Auxiliares_de_la_Linea(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, plngLinea As Long)

On Error Resume Next
    
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.plngCod_Emp = plngCod_Emp
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.plngCod_Doc = plngCod_Doc
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.plngNro_Doc = plngNro_Doc
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.plngCod_Prov = plngCod_Prov
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.plngLinea = plngLinea
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.pstrNombre_Tabla_Temporal = lNombre_Tabla_Lineas_Auxiliar_Temporal
    
    frmIngreso_Documentos_Datos_Auxiliares_x_Linea.Show vbModal
    
End Sub

Sub Crear_Temporal_Datos_Auxiliares_de_las_Lineas(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long)

    If Trim(lNombre_Tabla_Lineas_Auxiliar_Temporal) = "" Then
        lNombre_Tabla_Lineas_Auxiliar_Temporal = f_Nombre_Tabla_Temporal
        Call Borra_Tabla_Temporal(lNombre_Tabla_Lineas_Auxiliar_Temporal)
        Call Cargo_Tabla_Datos_Auxiliares_de_la_Linea(plngCod_Emp, plngCod_Doc, plngNro_Doc, plngCod_Prov, lNombre_Tabla_Lineas_Auxiliar_Temporal)
    End If

End Sub

Sub Cargo_Tabla_Datos_Auxiliares_de_la_Linea(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long, pstrTabla_Temporal As String)
Dim lstrSQL As String

    lstrSQL = "SELECT * INTO " & Trim(pstrTabla_Temporal) & " FROM zT_FaccmpLineas_Auxiliar WHERE 1=0"
    Dbs.Execute lstrSQL
    
    lstrSQL = "INSERT INTO " & Trim(pstrTabla_Temporal)
    lstrSQL = lstrSQL & " SELECT * FROM FaccmpLineas_Auxiliar"
    lstrSQL = lstrSQL & " WHERE cod_emp = " & plngCod_Emp
    lstrSQL = lstrSQL & " AND cod_doc = " & plngCod_Doc
    lstrSQL = lstrSQL & " AND nro_doc = " & plngNro_Doc
    lstrSQL = lstrSQL & " AND cod_prov = " & plngCod_Prov
    
    Dbs.Execute lstrSQL

End Sub

Public Sub Proceso_Modificacion(PLlamadoExterno As Boolean, pEmpresa As Long, pCodDoc As Long, pNroDoc As Long, pCodProv As Long)

'AIR 20170503 se cambio el codigo del metodo mmodificacion a este proceso para llamarlo externamente

Dim e As Recordset

' AIR 20230414
On Error GoTo Errores

    gBolTodosLosDescuentos = False
    lNombre_Tabla_Lineas_Auxiliar_Temporal = ""
    nro_doc_Wis = ""
    camion_Wis = ""
    gGuardando_Documento = False
    yaAutorizado = False
    lNombre_Tabla_Temporal = ""
    gstrUltimo_Nro_Autorizacion_Tarjeta = ""
    gbolProceso_Tarjeta = False        'SS 20181224
    
    sspCantidad_Lineas.Caption = "0"
    gbolCargo_Desde_WIS = False
    gbolCargo_Desde_Preventa = False
    
    sspOperacion.visible = True
    sspOperacion.Caption = "M"
    
    sstSecciones.Tab = 0
    sstDetalle_Pagos.Tab = 0
    
    txtLista.Locked = False
    Call Habilitar_Deshabilitar_Controles(Me, True)
    
    cmdEntrega.Enabled = False
    
    Call Limpiar_Controles(Me)
    
    ' Inicializo la Coleccion de Series
    Set gcolSeries_Articulos = Nothing
    
    
    labTope_Credito_Moneda.Caption = ""
    labTope_Credito.Caption = ""
    labSaldo_Credito_Moneda.Caption = ""
    labSaldo_Credito.Caption = ""
    
    labTope_Credito_Moneda.BackColor = &HE0E0E0
    labTope_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.BackColor = &HE0E0E0
    labSaldo_Credito.BackColor = &HE0E0E0
    labSaldo_Credito_Moneda.FontBold = False
    labSaldo_Credito.FontBold = False
    
    lbDisplay.Caption = ""
    
    txtFec_Doc.text = Format(date, "dd/mm/yyyy")
    If Buscar_Empresa(gCodigo_Empresa, e) Then
        txtEmpresa.text = gCodigo_Empresa
        txtNom_Empresa.text = Trim(e!Descripcion)
        Select Case Trim(UCase(e!mod_fecha_facturador))
            Case "S"
                txtFec_Doc.Locked = False
            Case "N"
                txtFec_Doc.Locked = True
            Case "C"
                txtFec_Doc.Locked = False
                txtFec_Doc.text = Format(gdteFecha_Documento, "dd/mm/yyyy")
        End Select
    Else
        MsgBox "Error en la Configuracion de Empresas", vbCritical, MsgTit
        Call Limpiar_Controles(Me)
        lbDisplay.Caption = ""
    End If
    
    sspTiene_Remitos_Pendientes.visible = False
    frameVencimientos_Cuotas.visible = False
    Imagen_Producto.visible = True
    
     gAutorizacionUnificada = False


    'txtNro_Fanfold.Text = Obtener_Nro_Fanfold(txtEmpresa.Text, txtEmpresa.Text, ConfPuntoVta_Nro_Caja)
    
    ' AIR 20160620
    
    If Inicializar_Valores_x_Campos_Programa_Empresa(gCodigo_Empresa, plngCod_Programa, 0, lcolCampos) Then
    End If
    
    Call Visualizar_Campos_Formulario
    
    Call Bloquear_Campos_Formulario

    ' FIN AIR
        
    Call Posiciono_en_Pantalla

    If PLlamadoExterno Then
        txtEmpresa.text = pEmpresa
        txtCodDoc.text = pCodDoc
        txtDoc.text = pNroDoc
        txtCodProv.text = pCodProv
            
        ' AIR 20230414
        frmPunto_Venta.Enabled = False
        
        Call txtCodDoc_GotFocus
        ' AIR 20230414
        'DoEvents
        Call txtCodDoc_LostFocus
        DoEvents
        Call txtDoc_GotFocus
        ' AIR 20230414
        'DoEvents
        Call txtDoc_LostFocus
        ' AIR 20230414
       ' DoEvents
        Call txtCodProv_LostFocus
        DoEvents
        Call txtMoneda_LostFocus
        DoEvents
        frmPunto_Venta.Enabled = True
        
        ' AIR 20230414 comentado porque provoca el disparo de la carga de la grilla 2 veces
        If ConfFormato_Factura <> "LURANCO" Then
            Sendkeys "{ENTER}"
            Sendkeys "{ENTER}"
        Else
            txtObs.SetFocus
        End If
        DoEvents
 
'        Call Lock_UnLock_Controles(Me, False)
'        DoEvents
    End If
    gbln_Cargo_Datos_Desde_F10 = False
    gbln_Articulo_de_F10 = False
  'AIR 20250218
    txtAcopio.text = 0
    txtDescripcion_Acopio = "SIN ACOPIO ASIGNADO"
    
Exit Sub
Errores:
    Call FErrores
    frmPunto_Venta.Enabled = True
End Sub

Function Controlar_Precio_Venta_Menor_Costo() As Boolean
Dim C As Recordset
Dim D As Recordset
Dim e As Recordset
Dim lrstIva As Recordset

Dim i As Long
Dim ldblCosto As Double
Dim ldblCosto_Base As Double
Dim ldblPVenta As Double
Dim ldblPVenta_Base As Double
Dim ldblTCambio As Double

    Controlar_Precio_Venta_Menor_Costo = True

    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Controlar_Precio_Venta_Menor_Costo = False
        Exit Function
    End If
      
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Controlar_Precio_Venta_Menor_Costo = False
        Exit Function
    End If
    

    For i = 1 To vsfLineas_Mercaderia.Rows - 1
    
        If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
    
            If D!tipo_precio <> "0" Then
                ' El Precio Unitario No se Inicializa en 0 (cero)
            
                If Busco_Costo_Lista(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), txtFec_Doc.text, e!nro_lista_costos, C) Then
                    
                    'AIR 20190102 se debe sacar el iva al costo para comparar con el precio de venta para los clientes con config sin impuestos en el precio de venta
                    
                    ldblCosto = C!precio_cto
                    If Trim(UCase(e!imp_inc_facturador)) = "N" Then
                        If Busco_Vista_IVA(C!cod_iva_compras, lrstIva) Then
                            ldblCosto = ldblCosto / (1 + lrstIva!porcentaje / 100)
                        End If
                    End If
                    
                    ' JE 20200604   /   Se cambio la funcion de busqueda del Importe Base segun la cotizacion de la Empresa
                    ldblCosto_Base = Importe_Base_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), C!moneda, 0, CDate(txtFec_Doc.text), ldblCosto)
                    
                    ' AIR 20190731 se busca el tipo de cambio de conversion de costos porque cuando esta en USD el costo y la factura en pesos no convertia bien a pesos
                    'ldblTCambio = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(Val(txtEmpresa.text), C!moneda, txtFec_Doc.text, "CC")
                    ' ldblCosto_Base = Importe_Base(C!moneda, 0, txtFec_Doc.text, C!precio_cto)
                    'ldblCosto_Base = Importe_Base(C!moneda, ldblTCambio, txtFec_Doc.text, ldblCosto)
                    'AIR 20190102 se deben restar los dsctos al precio de venta para verificar con el costo
                    
                    ldblPVenta = val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO))
                    
                    ldblPVenta = ldblPVenta - (ldblPVenta * val(txtDtoGlobal.text) / 100)
                    ldblPVenta = ldblPVenta - (ldblPVenta * val(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1)) / 100)
                    ldblPVenta = ldblPVenta - (ldblPVenta * val(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2)) / 100)
                    ldblPVenta = ldblPVenta - (ldblPVenta * val(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3)) / 100)
                    
                    ' JE 20200604   /   Se cambio la funcion de busqueda del Importe Base segun la cotizacion de la Empresa
                    ldblPVenta_Base = Importe_Base_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(txtMoneda.text), 0, CDate(txtFec_Doc.text), ldblPVenta)
                    'ldblPVenta_Base = Importe_Base(Val(txtMoneda.text), 0, txtFec_Doc.text, ldblPVenta)
                    ' ldblPVenta_Base = Importe_Base(Val(txtMoneda.text), 0, txtFec_Doc.text, Val(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)))
                       
                    If ldblPVenta_Base < ldblCosto_Base Then
                        MsgBox "ATENCION: El Articulo " & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & " - " & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCRIPCION)) & " Tiene Precio de Venta Menor al Costo Base --> " & Round(ldblCosto_Base, 5), vbCritical + vbOKOnly
                        Controlar_Precio_Venta_Menor_Costo = False
                        Exit Function
                        
                    End If
                End If
            
            End If
        
        End If
    
    Next i

End Function

Public Function Alta_Puntos_Fidelizacion(pdblImporte_Base As Double) As Boolean
Dim lstrSQL As String
Dim lPuntos As Double

On Error GoTo Errores

    Alta_Puntos_Fidelizacion = True

    ' Dar de Alta los Puntos si tiene
    If sumaPuntos > 0 Then
     
        lPuntos = 0
        
        lPuntos = f_Calculo_Puntos(sumaPuntos, pdblImporte_Base, Format(txtFec_Doc.text, "dd/mm/yyyy"))
        
        lstrSQL = "INSERT INTO FaccmpPuntos (cod_emp,cod_doc,nro_doc,cod_prov,cod_promo,puntos,fec_doc)"
        lstrSQL = lstrSQL & " VALUES("
        lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
        lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
        lstrSQL = lstrSQL & val(txtDoc.text) & ","
        lstrSQL = lstrSQL & val(txtCodProv.text) & ","
        lstrSQL = lstrSQL & "1" & ","
        lstrSQL = lstrSQL & lPuntos & ","
        lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ")"
        
        Dbs.Execute lstrSQL
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Puntos_Fidelizacion = False

End Function

Public Function Alta_Medios_Pago() As Boolean
Dim i As Long
Dim ldblCambio As Double
Dim ldblTipo_Cambio_Rec As Double
Dim ldblImporte_X_Medio As Double
Dim ldblImporte_X_Medio_Rec As Double
Dim lbolMedio_X_Defecto As Boolean
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim ldblImporte_Base_Rec As Double
Dim ldblImporte_Referencia_Rec As Double
Dim lstrSQL As String
Dim D As Recordset

On Error GoTo Errores

    Alta_Medios_Pago = True

    'IMPORTANTE!!!!!!!!
    '#########################################################
    'Buscamos el medio de pago x defecto para restar el cambio y de esa forma que nos de exacto.
    'Los medios de pago se graban con la moneda de la factura, no con la del medio de pago. Esto es para que cierren los reportes.
    'El Reporte de Cierre de Cajas abre por la moneda del medio de pago para saber que se tiene.

    'AIR 20250929 importante
    ' se habilita la posibilidad de devolver cambio en diferente moneda a la moneda del documento, por lo cual puede existir cambio en la moneda del medio de pago.


    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Medios_Pago = False
        Exit Function
    End If

    ' Dar de Alta los Medios de Pago, el importe base y referencia es en la moneda ingresada como medio de pago
    ldblCambio = CDbl(txtCambio.text)
    lbolMedio_X_Defecto = False
    
    For i = 1 To vsfMedios_Pagos.Rows - 1
    
       lbolMedio_X_Defecto = False
       
       If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Base And val(txtMoneda.text) = gMoneda_Base Then
           lbolMedio_X_Defecto = True
       End If
       If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Referencia And val(txtMoneda.text) = gMoneda_Referencia Then
           lbolMedio_X_Defecto = True
       End If
       
        If (CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Or (CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) = 0 And lbolMedio_X_Defecto)) And Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> "" Then
           ldblImporte_X_Medio = 0
           If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TC)) = "" Then
               ldblTipo_Cambio_Rec = val(txtTipo_Cambio.text)
           Else
               ldblTipo_Cambio_Rec = val(vsfMedios_Pagos.TextMatrix(i, CGMP_TC))
           End If
           
           '#####################################################
           'Si la moneda de la factura es DIFERENTE a la moneda recibida
           
           If val(txtMoneda.text) <> val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
               'Si la Factura es en $
               If val(txtTipo_Cambio.text) = 1 Then
                   ''Tomamos el tipo de cambio de la moneda recibida
                   If ldblTipo_Cambio_Rec = 0 Then
                       ldblTipo_Cambio_Rec = 1
                   End If
                   ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) * ldblTipo_Cambio_Rec
               Else
                   ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) / ldblTipo_Cambio_Rec
               End If
           
               'A esta altura en ldblTipo_Cambio_Rec tengo el importe recibido en el medio de pago llevado a la moneda de la factura
               'De ahi en adelante grabo los datos sacando los demas importes de referencia siempre en base a la moneda factura.
               'En los campos auxiliares grabamos tal como se recibio.
    
               'Ahora le resto el cambio para grabar lo cobrado realmente. Ademas si estoy llevando el importe recibido a la moneda de la factura
               'Hago lo mismo con el cambio
               If lbolMedio_X_Defecto = True Then
                   ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                   'Importe x medio en moneda recibida
                   If val(txtTipo_Cambio.text) = 1 Then
                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio / ldblTipo_Cambio_Rec)
                   Else
                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio * ldblTipo_Cambio_Rec)
                   End If
               Else
                   ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
               End If
           Else
               'Restamos el cambio a la medio x defecto
               ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                   If lbolMedio_X_Defecto = True Then
                       'Importe x medio en moneda factura
                       ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                       'Importe x medio en moneda recibida
                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - ldblCambio
                   Else
                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                   End If
           End If
           
           'Grabamos
           ldblImporte_Base = Importe_Base(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
           ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
           
           ldblImporte_Referencia = Importe_Referencia(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
           ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
           
           ldblImporte_Base_Rec = Importe_Base(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
           ldblImporte_Base_Rec = Format(ldblImporte_Base_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
           
           ldblImporte_Referencia_Rec = Importe_Referencia(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
           ldblImporte_Referencia_Rec = Format(ldblImporte_Referencia_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
    
           If ldblImporte_Base <> 0 Or ldblImporte_Referencia <> 0 Or ldblImporte_Base_Rec <> 0 Or ldblImporte_Referencia_Rec <> 0 Then
                lstrSQL = "INSERT INTO FaccmpMpagos (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general)"
                lstrSQL = lstrSQL & " VALUES("
                lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
                lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
                lstrSQL = lstrSQL & val(txtDoc.text) & ","
                lstrSQL = lstrSQL & val(txtCodProv.text) & ","
                lstrSQL = lstrSQL & CLng(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)) & ","
                lstrSQL = lstrSQL & ldblImporte_X_Medio & ","
                lstrSQL = lstrSQL & val(txtMoneda.text) & ","
                lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
                lstrSQL = lstrSQL & ldblImporte_Base & ","
                lstrSQL = lstrSQL & ldblImporte_Referencia & ","
                lstrSQL = lstrSQL & ldblImporte_X_Medio_Rec & ","
                lstrSQL = lstrSQL & val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) & ","
                lstrSQL = lstrSQL & ldblTipo_Cambio_Rec & ","
                lstrSQL = lstrSQL & ldblImporte_Base_Rec & ","
                lstrSQL = lstrSQL & ldblImporte_Referencia_Rec & ","
                lstrSQL = lstrSQL & CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) & ",'"
                lstrSQL = lstrSQL & f_Ins_String(Left(Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_REFERENCIA)), 50)) & "',"
                lstrSQL = lstrSQL & "0" & ","                                      ' cierre vendedor
                lstrSQL = lstrSQL & "0" & ")"                                      ' cierre general
                
                Dbs.Execute lstrSQL
            End If
           
           ' AIR 20180309
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       VALES A GENERAR        ============================================================================
        
           If D!clase = "CONTADO" And D!signo = 1 And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) = "V" Then
               'Call Alta_Vale(Val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))
                If Not Alta_Vale(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) Then
                    Call MsgBox("ERROR al Grabar los Vales", (vbExclamation + vbOKOnly))
                    Alta_Medios_Pago = False
                    Exit Function
                End If
           End If
        
           ' AIR 20181104
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       SEÑA A GENERAR        ============================================================================
        
           If vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) = "S" Then
               'Call Alta_Seña(vsfMedios_Pagos, Val(i))
               If Not Alta_Seña(vsfMedios_Pagos, val(i)) Then
                    Call MsgBox("ERROR al Grabar la Seña", (vbExclamation + vbOKOnly))
                    Alta_Medios_Pago = False
                    Exit Function
               End If
           End If
        
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       CUOTAS        =====================================================================================
       
           'Call Alta_Cuotas(i, D!signo)
           If Not Alta_Cuotas(i, D!signo) Then
                Call MsgBox("ERROR al Grabar las Cuotas", (vbExclamation + vbOKOnly))
                Alta_Medios_Pago = False
                Exit Function
           End If
           
        End If
    Next

Exit Function

Errores:
    Call FErrores
    Alta_Medios_Pago = False

End Function

Public Function Alta_Medios_Pago_T4(argNroDocIni As Long) As Boolean
Dim i As Long
Dim ldblCambio As Double
Dim ldblTipo_Cambio_Rec As Double
Dim ldblImporte_X_Medio As Double
Dim ldblImporte_X_Medio_Rec As Double
Dim lbolMedio_X_Defecto As Boolean
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim ldblImporte_Base_Rec As Double
Dim ldblImporte_Referencia_Rec As Double
Dim lstrSQL As String
Dim D As Recordset

Dim lrstBaucher As Recordset
Dim llngNro_Doc_Provisorio As Long

On Error GoTo Errores

    Alta_Medios_Pago_T4 = True

    'IMPORTANTE!!!!!!!!
    '#########################################################
    'Buscamos el medio de pago x defecto para restar el cambio y de esa forma que nos de exacto.
    'Los medios de pago se graban con la moneda de la factura, no con la del medio de pago. Esto es para que cierren los reportes.
    'El Reporte de Cierre de Cajas abre por la moneda del medio de pago para saber que se tiene.

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Medios_Pago_T4 = False
        Exit Function
    End If

    ' Dar de Alta los Medios de Pago, el importe base y referencia es en la moneda ingresada como medio de pago
    ldblCambio = CDbl(txtCambio.text)
    lbolMedio_X_Defecto = False
    
    For i = 1 To vsfMedios_Pagos.Rows - 1
    
       lbolMedio_X_Defecto = False
       
              
       If ((ConfTRANSACT_Habilitado = "S" And ConfTRANSACT_Version >= 4) Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S" Or ConfCASHDRO_Habilitado = "S") Then
           If CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Then
               If EsMedioPagoInterfaceTarjeta(CLng(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO))) Then
                   GoTo NoIngresa
               End If
           End If
       End If
       
       ' AIR 20250929
'       If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Base And val(txtMoneda.text) = gMoneda_Base Then
'           lbolMedio_X_Defecto = True
'       End If
'       If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Referencia And val(txtMoneda.text) = gMoneda_Referencia Then
'           lbolMedio_X_Defecto = True
'       End If
    
       If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Base And val(txtMoneda.text) = gMoneda_Base Then
           lbolMedio_X_Defecto = True
       End If
       
       If ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas = False Then 'AIR 20250929
            If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Referencia And val(txtMoneda.text) = gMoneda_Referencia Then
                lbolMedio_X_Defecto = True
            End If
       Else
            If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Referencia Then
                lbolMedio_X_Defecto = True
            End If
            
            If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_DEV_CAMBIO)) = "CAMBIO" And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gMoneda_Base Then
                lbolMedio_X_Defecto = True
            End If
            
       End If
       
       If (CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> 0 Or (CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) = 0 And lbolMedio_X_Defecto)) And Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)) <> "" Then
           ldblImporte_X_Medio = 0
           If Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_TC)) = "" Then
               ldblTipo_Cambio_Rec = val(txtTipo_Cambio.text)
           Else
               ldblTipo_Cambio_Rec = val(vsfMedios_Pagos.TextMatrix(i, CGMP_TC))
           End If
           
           '#####################################################
           'Si la moneda de la factura es DIFERENTE a la moneda recibida
           
           If val(txtMoneda.text) <> val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) Then
               'Si la Factura es en $
               If val(txtTipo_Cambio.text) = 1 Then
                   ''Tomamos el tipo de cambio de la moneda recibida
                   If ldblTipo_Cambio_Rec = 0 Then
                       ldblTipo_Cambio_Rec = 1
                   End If
                   ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) * ldblTipo_Cambio_Rec
               Else
                   ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) / ldblTipo_Cambio_Rec
               End If
           
               'A esta altura en ldblTipo_Cambio_Rec tengo el importe recibido en el medio de pago llevado a la moneda de la factura
               'De ahi en adelante grabo los datos sacando los demas importes de referencia siempre en base a la moneda factura.
               'En los campos auxiliares grabamos tal como se recibio.
    
               'Ahora le resto el cambio para grabar lo cobrado realmente. Ademas si estoy llevando el importe recibido a la moneda de la factura
               'Hago lo mismo con el cambio
               If lbolMedio_X_Defecto = True Then
'                   ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
'                   'Importe x medio en moneda recibida
'                   If val(txtTipo_Cambio.text) = 1 Then
'                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio / ldblTipo_Cambio_Rec)
'                   Else
'                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio * ldblTipo_Cambio_Rec)
'                   End If
                    
                    ldblImporte_X_Medio_Rec = 0         ' AIR 20260108
                    'AIR 20250929
                    If ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas = False Then
                        ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                        'Importe x medio en moneda recibida
                        If val(txtTipo_Cambio.text) = 1 Then
                            ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio / ldblTipo_Cambio_Rec)
                        Else
                            ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio * ldblTipo_Cambio_Rec)
                        End If
                    Else
                        'AIR 20250929    ***************
                        For j = 1 To UBound(gVecCambio)
                            'CGC_MONEDA As Long = 3
                            'CGC_TC As Long = 4
                            'CGC_IMPORTE As Long = 7
                            
                            If gVecCambio(j, 7) <> 0 And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = gVecCambio(j, 3) Then
                                ldblImporte_X_Medio = ldblImporte_X_Medio - gVecCambio(j, 7)
                                ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - gVecCambio(j, 7)
                                ldblTipo_Cambio_Rec = gVecCambio(j, 4)
                                ldblCambio = gVecCambio(j, 7)
                                
                              ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                              'Importe x medio en moneda recibida
                              If val(txtTipo_Cambio.text) = 1 Then
                                  'ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio * ldblTipo_Cambio_Rec)
                                   ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio * ldblTipo_Cambio_Rec)
                              Else
                                  'ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio / ldblTipo_Cambio_Rec)
                                  ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - (ldblCambio / ldblTipo_Cambio_Rec)
                              End If
                            End If
                        Next j
                    End If
                         
                Else
                   ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                End If
           Else
               'Restamos el cambio a la medio x defecto
               ldblImporte_X_Medio = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                   If lbolMedio_X_Defecto = True Then

'                       'Importe x medio en moneda factura
'                       ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
'                       'Importe x medio en moneda recibida
'                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - ldblCambio
                
                     'AIR 20250929
                      If ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas = False Then
                         'Importe x medio en moneda factura
                         ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                         'Importe x medio en moneda recibida
                         ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - ldblCambio
                     Else
                         'AIR 20250929
                         For j = 1 To UBound(gVecCambio)
                             'CGC_MONEDA As Long = 3
                             'CGC_TC As Long = 4
                             'CGC_IMPORTE As Long = 7
                             
                             If gVecCambio(j, 7) <> 0 And val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) = val(gVecCambio(j, 3)) Then
                                 ldblImporte_X_Medio = ldblImporte_X_Medio - gVecCambio(j, 7)
                                 ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) - gVecCambio(j, 7)
                                 ldblTipo_Cambio_Rec = gVecCambio(j, 4)
                                 ldblCambio = 0 - gVecCambio(j, 7)
                             
                             End If
                         Next j
                     End If
                   
                   Else
                       ldblImporte_X_Medio_Rec = CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))))
                   End If
           End If
               
            'AIR 20250929
            If ConfPuntoVta_Habilita_Cambio_en_Dist_Monedas = False Then
               
               'Grabamos
               ldblImporte_Base = Importe_Base(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
               ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
               
               ldblImporte_Referencia = Importe_Referencia(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
               ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
               
               ldblImporte_Base_Rec = Importe_Base(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
               ldblImporte_Base_Rec = Format(ldblImporte_Base_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
               
               ldblImporte_Referencia_Rec = Importe_Referencia(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
               ldblImporte_Referencia_Rec = Format(ldblImporte_Referencia_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
        
               If ldblImporte_Base <> 0 Or ldblImporte_Referencia <> 0 Or ldblImporte_Base_Rec <> 0 Or ldblImporte_Referencia_Rec <> 0 Then
                    lstrSQL = "INSERT INTO FaccmpMpagos (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general)"
                    lstrSQL = lstrSQL & " VALUES("
                    lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
                    lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & val(txtDoc.text) & ","
                    lstrSQL = lstrSQL & val(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & CLng(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)) & ","
                    lstrSQL = lstrSQL & ldblImporte_X_Medio & ","
                    lstrSQL = lstrSQL & val(txtMoneda.text) & ","
                    lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
                    lstrSQL = lstrSQL & ldblImporte_Base & ","
                    lstrSQL = lstrSQL & ldblImporte_Referencia & ","
                    lstrSQL = lstrSQL & ldblImporte_X_Medio_Rec & ","
                    lstrSQL = lstrSQL & val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) & ","
                    lstrSQL = lstrSQL & ldblTipo_Cambio_Rec & ","
                    lstrSQL = lstrSQL & ldblImporte_Base_Rec & ","
                    lstrSQL = lstrSQL & ldblImporte_Referencia_Rec & ","
                    lstrSQL = lstrSQL & CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) & ",'"
                    lstrSQL = lstrSQL & f_Ins_String(Left(Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_REFERENCIA)), 50)) & "',"
                    lstrSQL = lstrSQL & "0" & ","                                      ' cierre vendedor
                    lstrSQL = lstrSQL & "0" & ")"                                      ' cierre general
                    
                    Dbs.Execute lstrSQL
                End If
            Else
               ' If lbolMedio_X_Defecto = True Then
                   'Grabamos
                   ldblImporte_Base = Importe_Base(val(txtMoneda.text), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio)
                   ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                   
                   ldblImporte_Referencia = Importe_Referencia(val(txtMoneda.text), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio)
                   ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                   
                   ldblImporte_Base_Rec = Importe_Base(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
                   ldblImporte_Base_Rec = Format(ldblImporte_Base_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                   
                   ldblImporte_Referencia_Rec = Importe_Referencia(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
                   ldblImporte_Referencia_Rec = Format(ldblImporte_Referencia_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
            
                   If ldblImporte_Base <> 0 Or ldblImporte_Referencia <> 0 Or ldblImporte_Base_Rec <> 0 Or ldblImporte_Referencia_Rec <> 0 Then
                        lstrSQL = "INSERT INTO FaccmpMpagos (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general)"
                        lstrSQL = lstrSQL & " VALUES("
                        lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
                        lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
                        lstrSQL = lstrSQL & val(txtDoc.text) & ","
                        lstrSQL = lstrSQL & val(txtCodProv.text) & ","
                        lstrSQL = lstrSQL & CLng(vsfMedios_Pagos.TextMatrix(i, CGMP_MEDIO_PAGO)) & ","
                        lstrSQL = lstrSQL & ldblImporte_X_Medio & ","
                        lstrSQL = lstrSQL & val(txtMoneda.text) & ","
                        lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
                        lstrSQL = lstrSQL & ldblImporte_Base & ","
                        lstrSQL = lstrSQL & ldblImporte_Referencia & ","
                        lstrSQL = lstrSQL & ldblImporte_X_Medio_Rec & ","
                        lstrSQL = lstrSQL & val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)) & ","
                        lstrSQL = lstrSQL & ldblTipo_Cambio_Rec & ","
                        lstrSQL = lstrSQL & ldblImporte_Base_Rec & ","
                        lstrSQL = lstrSQL & ldblImporte_Referencia_Rec & ","
                        lstrSQL = lstrSQL & CDbl(IIf(Trim(CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) = "", 0, CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))) & ",'"
                        lstrSQL = lstrSQL & f_Ins_String(Left(Trim(vsfMedios_Pagos.TextMatrix(i, CGMP_REFERENCIA)), 50)) & "',"
                        lstrSQL = lstrSQL & "0" & ","                                      ' cierre vendedor
                        lstrSQL = lstrSQL & "0" & ")"                                      ' cierre general

                        Dbs.Execute lstrSQL
                    End If
                    
              '  End If
            End If

           ' AIR 20180309
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       VALES A GENERAR        ============================================================================
        
           If D!clase = "CONTADO" And D!signo = 1 And vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) = "V" Then
               'Call Alta_Vale(Val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE)))
                If Not Alta_Vale(val(vsfMedios_Pagos.TextMatrix(i, CGMP_MONEDA)), CDbl(vsfMedios_Pagos.TextMatrix(i, CGMP_IMPORTE))) Then
                    Call MsgBox("ERROR al Grabar los Vales", (vbExclamation + vbOKOnly))
                    Alta_Medios_Pago_T4 = False
                    Exit Function
                End If
           End If
        
           ' AIR 20181104
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       SEÑA A GENERAR        ============================================================================
        
           If vsfMedios_Pagos.TextMatrix(i, CGMP_TIPO_MPAGO) = "S" Then
               'Call Alta_Seña(vsfMedios_Pagos, Val(i))
               If Not Alta_Seña(vsfMedios_Pagos, val(i)) Then
                    Call MsgBox("ERROR al Grabar la Seña", (vbExclamation + vbOKOnly))
                    Alta_Medios_Pago_T4 = False
                    Exit Function
               End If
           End If
        
           ' ------------------------------------------------------------------------------------------------------------------------------------
           ' ==========================       CUOTAS        =====================================================================================
       
           'Call Alta_Cuotas(i, D!signo)
           If Not Alta_Cuotas(i, D!signo) Then
                Call MsgBox("ERROR al Grabar las Cuotas", (vbExclamation + vbOKOnly))
                Alta_Medios_Pago_T4 = False
                Exit Function
           End If
           
       End If

NoIngresa:
        
        
    Next
    
    lbolMedio_X_Defecto = False
    
    If ((ConfTRANSACT_Habilitado = "S" And ConfTRANSACT_Version >= 4) Or ConfFISERV_Habilitado = "S" Or ConfPosLink_Habilitado = "S" Or ConfSarea_Habilitado = "S") Then
    
        ldblTipo_Cambio_Rec = val(txtTipo_Cambio.text)
         'llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_Caja * ConfMultiplo_caja) + val(argNroDocIni)
        ' AIR 20250505
        llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_SubCaja * ConfMultiplo_caja) + val(argNroDocIni)
        
        
        If Obtener_Lista_Baucher(val(txtEmpresa.text), val(txtCodDoc.text), llngNro_Doc_Provisorio, val(txtCodProv.text), 0, lrstBaucher, -2) Then
            
            While Not lrstBaucher.EOF
                '#####################################################
                'Si la moneda de la factura es DIFERENTE a la moneda recibida
           
                If CInt(txtMoneda.text) <> lrstBaucher!moneda Then
                    'Si la Factura es en $
                    If val(txtTipo_Cambio.text) = 1 Then
                        ''Tomamos el tipo de cambio de la moneda recibida
                        If ldblTipo_Cambio_Rec = 0 Then
                            ldblTipo_Cambio_Rec = 1
                        End If
                        ldblImporte_X_Medio = lrstBaucher!Importe * ldblTipo_Cambio_Rec
                    Else
                        ldblImporte_X_Medio = lrstBaucher!Importe / ldblTipo_Cambio_Rec
                    End If
           
                    'A esta altura en ldblTipo_Cambio_Rec tengo el importe recibido en el medio de pago llevado a la moneda de la factura
                    'De ahi en adelante grabo los datos sacando los demas importes de referencia siempre en base a la moneda factura.
                    'En los campos auxiliares grabamos tal como se recibio.
    
                    'Ahora le resto el cambio para grabar lo cobrado realmente. Ademas si estoy llevando el importe recibido a la moneda de la factura
                    'Hago lo mismo con el cambio
                    If lbolMedio_X_Defecto = True Then
                        ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                        'Importe x medio en moneda recibida
                        If val(txtTipo_Cambio.text) = 1 Then
                            ldblImporte_X_Medio_Rec = lrstBaucher!Importe - (ldblCambio / ldblTipo_Cambio_Rec)
                        Else
                            ldblImporte_X_Medio_Rec = lrstBaucher!Importe - (ldblCambio * ldblTipo_Cambio_Rec)
                        End If
                    Else
                        ldblImporte_X_Medio_Rec = lrstBaucher!Importe
                    End If
                Else
                    'Restamos el cambio a la medio x defecto
                    ldblImporte_X_Medio = lrstBaucher!Importe
                    If lbolMedio_X_Defecto = True Then
                        'Importe x medio en moneda factura
                        ldblImporte_X_Medio = ldblImporte_X_Medio - ldblCambio
                        'Importe x medio en moneda recibida
                        ldblImporte_X_Medio_Rec = lrstBaucher!Importe - ldblCambio
                    Else
                        ldblImporte_X_Medio_Rec = lrstBaucher!Importe
                    End If
                End If
           
                'Grabamos
                ldblImporte_Base = Importe_Base(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
                ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
           
                ldblImporte_Referencia = Importe_Referencia(val(txtMoneda.text), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_X_Medio)
                ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
           
                ldblImporte_Base_Rec = Importe_Base(lrstBaucher!moneda, ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
                ldblImporte_Base_Rec = Format(ldblImporte_Base_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
           
                ldblImporte_Referencia_Rec = Importe_Referencia(val(lrstBaucher!moneda), ldblTipo_Cambio_Rec, txtFec_Doc.text, ldblImporte_X_Medio_Rec)
                ldblImporte_Referencia_Rec = Format(ldblImporte_Referencia_Rec, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
    
                If ldblImporte_Base <> 0 Or ldblImporte_Referencia <> 0 Or ldblImporte_Base_Rec <> 0 Or ldblImporte_Referencia_Rec <> 0 Then
                    lstrSQL = "INSERT INTO FaccmpMpagos (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,importe,moneda,tipo_cambio,importe_base,importe_ref,"
                    lstrSQL = lstrSQL & "           importe_rec,moneda_rec,tipo_cambio_rec,importe_base_rec,importe_ref_rec,importe_digitado,referencia,cierre_vendedor,cierre_general)"
                    lstrSQL = lstrSQL & " VALUES("
                    lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
                    lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & val(txtDoc.text) & ","
                    lstrSQL = lstrSQL & val(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & CLng(lrstBaucher!cod_mpago) & ","
                    lstrSQL = lstrSQL & ldblImporte_X_Medio & ","
                    lstrSQL = lstrSQL & val(txtMoneda.text) & ","
                    lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
                    lstrSQL = lstrSQL & ldblImporte_Base & ","
                    lstrSQL = lstrSQL & ldblImporte_Referencia & ","
                    lstrSQL = lstrSQL & ldblImporte_X_Medio_Rec & ","
                    lstrSQL = lstrSQL & val(lrstBaucher!moneda) & ","
                    lstrSQL = lstrSQL & ldblTipo_Cambio_Rec & ","
                    lstrSQL = lstrSQL & ldblImporte_Base_Rec & ","
                    lstrSQL = lstrSQL & ldblImporte_Referencia_Rec & ","
                    lstrSQL = lstrSQL & val(lrstBaucher!Importe) & ",'',"
                    lstrSQL = lstrSQL & "0" & ","                                      ' cierre vendedor
                    lstrSQL = lstrSQL & "0" & ")"                                      ' cierre general
                    
                                
                    Dbs.Execute lstrSQL
                End If
           
                lrstBaucher.MoveNext
            Wend
        
        
        End If
    
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Medios_Pago_T4 = False

End Function





Public Function Alta_Impuestos() As Boolean
Dim ldblCofis As Double
Dim i As Long
Dim ldblImp_SImp_Base As Double
Dim ldblImp_SImp_Referencia As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Impuestos = True

    ldblCofis = 0
    
    For i = 1 To vsfImpuestos.Rows - 1
    
        If Trim(vsfImpuestos.TextMatrix(i, CGI_COFIS)) <> "" Then
    
            ldblImp_SImp_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)))
            ldblImp_SImp_Base = Format(ldblImp_SImp_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            
            ldblImp_SImp_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)))
            ldblImp_SImp_Referencia = Format(ldblImp_SImp_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
            
            ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfImpuestos.TextMatrix(i, CGI_COFIS))
            ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            
            ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfImpuestos.TextMatrix(i, CGI_COFIS))
            ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
    
            lstrSQL = "INSERT INTO FaccmpImpuestos (cod_emp,cod_doc,nro_doc,cod_prov,cod_tipo_impuesto,cod_impuesto,imp_sin_impuestos,porcentaje,importe,moneda,tipo_cambio,importe_simp_base,importe_simp_ref,importe_base,importe_ref)"
            lstrSQL = lstrSQL & " VALUES("
            lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
            lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
            lstrSQL = lstrSQL & val(txtDoc.text) & ","
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","
            lstrSQL = lstrSQL & "'COFIS_TIVA'" & " ,"
            lstrSQL = lstrSQL & val(vsfImpuestos.TextMatrix(i, CGI_CODIGO_IVA)) & ","
            lstrSQL = lstrSQL & CDbl(IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS))) & ","
            lstrSQL = lstrSQL & CDbl(IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_COFIS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_COFIS))) & ","
            lstrSQL = lstrSQL & CDbl(vsfImpuestos.TextMatrix(i, CGI_COFIS)) & ","
            lstrSQL = lstrSQL & val(txtMoneda.text) & ","
            lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
            lstrSQL = lstrSQL & ldblImp_SImp_Base & ","
            lstrSQL = lstrSQL & ldblImp_SImp_Referencia & ","
            lstrSQL = lstrSQL & ldblImporte_Base & ","
            lstrSQL = lstrSQL & ldblImporte_Referencia & ")"
            
            Dbs.Execute lstrSQL
    
            ldblCofis = ldblCofis + CDbl(vsfImpuestos.TextMatrix(i, CGI_COFIS))
        End If
    
        If Trim(vsfImpuestos.TextMatrix(i, CGI_IVA)) <> "" Then
    
            ldblImp_SImp_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)))
            ldblImp_SImp_Base = Format(ldblImp_SImp_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            
            ldblImp_SImp_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)))
            ldblImp_SImp_Referencia = Format(ldblImp_SImp_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
            
            ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfImpuestos.TextMatrix(i, CGI_IVA))
            ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            
            ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfImpuestos.TextMatrix(i, CGI_IVA))
            ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
    
            lstrSQL = "INSERT INTO FaccmpImpuestos (cod_emp,cod_doc,nro_doc,cod_prov,cod_tipo_impuesto,cod_impuesto,imp_sin_impuestos,porcentaje,importe,moneda,tipo_cambio,importe_simp_base,importe_simp_ref,importe_base,importe_ref)"
            lstrSQL = lstrSQL & " VALUES("
            lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
            lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
            lstrSQL = lstrSQL & val(txtDoc.text) & ","
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","
            lstrSQL = lstrSQL & "'IVA'" & ","
            lstrSQL = lstrSQL & val(vsfImpuestos.TextMatrix(i, CGI_CODIGO_IVA)) & ","
            lstrSQL = lstrSQL & CDbl(IIf(Trim(vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS)) = "", 0, vsfImpuestos.TextMatrix(i, CGI_IMPORTE_SIN_IMPUESTOS))) & ","
            lstrSQL = lstrSQL & CDbl(IIf(vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA) = "", 0, vsfImpuestos.TextMatrix(i, CGI_PORCENTAJE_IVA))) & ","
            lstrSQL = lstrSQL & CDbl(vsfImpuestos.TextMatrix(i, CGI_IVA)) & ","
            lstrSQL = lstrSQL & val(txtMoneda.text) & ","
            lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","
            lstrSQL = lstrSQL & ldblImp_SImp_Base & ","
            lstrSQL = lstrSQL & ldblImp_SImp_Referencia & ","
            lstrSQL = lstrSQL & ldblImporte_Base & ","
            lstrSQL = lstrSQL & ldblImporte_Referencia & ")"
            
            Dbs.Execute lstrSQL
    
        End If
    Next

Exit Function

Errores:
    Call FErrores
    Alta_Impuestos = False

End Function



Public Sub Controla_y_Espera_Datos_Baucher_Tarjeta(plstrDocIni As String)
Dim lrstTarjeta As Recordset

Dim llngNro_Doc_Provisorio As Long
Dim lbolSigo As Boolean
Dim llngIntentos As Long

    'llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_Caja * ConfMultiplo_caja) + val(plstrDocIni)
    ' AIR 20250505
    
    llngNro_Doc_Provisorio = (ConfPuntoVta_Nro_SubCaja * ConfMultiplo_caja) + val(plstrDocIni)
    
    
    ' Agrego sleep  SS 20190225
    If Not Existe_Tarjeta_para_Documento(val(txtEmpresa.text), val(txtCodDoc.text), llngNro_Doc_Provisorio, val(txtCodProv.text), lrstTarjeta) Then
    
        Call f_esperar(8)
        Sleep 8000
        Unload frmMensaje_Esperar
    
    End If
   
'    lbolSigo = True
'    llngIntentos = 0
'
'    Call f_esperar(8)
'
'    While lbolSigo
'
'        'Busco si hay registros ingresados de tarjetas con el POS  (F9)
'        If Existe_Tarjeta_para_Documento(Val(txtEmpresa.text), Val(txtCodDoc.text), llngNro_Doc_Provisorio, Val(txtCodProv.text), lrstTarjeta) Then
'
'            lbolSigo = False
'        Else
'            llngIntentos = llngIntentos + 1
'
'            DoEvents        ' SS 20190214
'
'            If llngIntentos > 12 Then
'                lbolSigo = False
'                Call Cargo_Logtrans("NO se grabo en Faccmp_Baucher_TCredito " & Trim(txtCodDoc.text) & "-" & llngNro_Doc_Provisorio & "-" & Trim(txtCodProv.text))
'            Else
'                Call Cargo_Logtrans("NO encuentra Faccmp_Baucher_TCredito " & Trim(txtCodDoc.text) & "-" & llngNro_Doc_Provisorio & "-" & Trim(txtCodProv.text) & " Intento " & llngIntentos)
'                Sleep 5000
'            End If
'
'        End If
'    Wend
'
'    Unload frmMensaje_Esperar
    
End Sub

Public Function Alta_Lineas_de_Servicios() As Boolean
Dim i As Long
Dim llngLinea As Long
Dim ldblPrecio_Base As Double
Dim ldblPrecio_Referencia As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim lstrSQL As String
Dim D As Recordset
Dim e As Recordset

On Error GoTo Errores

    Alta_Lineas_de_Servicios = True
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Lineas_de_Servicios = False
        Exit Function
    End If
    
    If Not Buscar_Empresa(val(txtEmpresa.text), e) Then
        Alta_Lineas_de_Servicios = False
        Exit Function
    End If
    
    If Trim(UCase(D!mueve_merca_serv)) <> "S" Then
        Exit Function
    End If
      
    llngLinea = 0
    dbgLineas_Servicios.MoveFirst
    'AIR 20231012 se agrega el -1 porque estas grillas cuentan desde la row 0
    'For i = 0 To dbgLineas_Servicios.Rows
    For i = 0 To dbgLineas_Servicios.Rows - 1
                     
        If Trim(dbgLineas_Servicios.Columns("unidades").text) <> "" And Not dbgLineas_Servicios.Columns("eliminada").Value Then
            llngLinea = llngLinea + 1
          
            ldblPrecio_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("precio").text)
            ldblPrecio_Base = Format(ldblPrecio_Base, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            ldblPrecio_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("precio").text)
            ldblPrecio_Referencia = Format(ldblPrecio_Referencia, f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
           'AIR 20191218 para las facturas de servicio no se estaba considerando esta configuracion de la empresa la cual luego generaba errores en la generacion del asiento
            If e!imp_inc_facturador = "S" Then
                ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("importe").text)
                ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("importe").text)
                ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            Else
                ldblImporte_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("importe_sin_iva").text)
                ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
                
                ldblImporte_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, dbgLineas_Servicios.Columns("importe_sin_iva").text)
                ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_Importe_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            End If
            
            lstrSQL = "INSERT INTO FaccmpServicios (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,unidades,"
            lstrSQL = lstrSQL & "descripcion,tcofis,tiva,precio,importe,seccion,"
            lstrSQL = lstrSQL & "moneda,tipo_cambio,precio_base,precio_ref,importe_base,importe_ref,codigo,tasa_resguardo, "
            lstrSQL = lstrSQL & "descuento1,descuento2,descuento3) "
            lstrSQL = lstrSQL & " VALUES("
            lstrSQL = lstrSQL & val(txtEmpresa.text) & ","                                          ' cod_emp
            lstrSQL = lstrSQL & val(txtCodDoc.text) & ","                                           ' cod_doc
            lstrSQL = lstrSQL & val(txtDoc.text) & ","                                              ' nro_doc
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                          ' cod_prov
            lstrSQL = lstrSQL & llngLinea & ","                                                        ' nro_linea
            lstrSQL = lstrSQL & CDbl(dbgLineas_Servicios.Columns("unidades").text) & ",'"           ' unidades
            lstrSQL = lstrSQL & UCase(Trim(dbgLineas_Servicios.Columns("descripcion").text)) & "'," ' descripcion
            lstrSQL = lstrSQL & val(dbgLineas_Servicios.Columns("tcofis").text) & ","               ' tcofis
            lstrSQL = lstrSQL & val(dbgLineas_Servicios.Columns("tiva").text) & ","                 ' tiva
            lstrSQL = lstrSQL & CDbl(dbgLineas_Servicios.Columns("precio").text) & ","              ' precio
            
            If e!imp_inc_facturador = "S" Then
                lstrSQL = lstrSQL & CDbl(dbgLineas_Servicios.Columns("importe").text) & ","             ' importe
            Else
                lstrSQL = lstrSQL & CDbl(dbgLineas_Servicios.Columns("importe_sin_iva").text) & ","     ' importe
            End If
            
            lstrSQL = lstrSQL & CLng(dbgLineas_Servicios.Columns("seccion").text) & ","             ' seccion
            lstrSQL = lstrSQL & val(txtMoneda.text) & ","                                           ' moneda
            lstrSQL = lstrSQL & val(txtTipo_Cambio.text) & ","                                      ' tipo_cambio
            lstrSQL = lstrSQL & ldblPrecio_Base & ","                                               ' precio_base
            lstrSQL = lstrSQL & ldblPrecio_Referencia & ","                                         ' precio_ref
            lstrSQL = lstrSQL & ldblImporte_Base & ","                                              ' importe_base
            lstrSQL = lstrSQL & ldblImporte_Referencia & ","                                        ' importe_ref
            lstrSQL = lstrSQL & val(dbgLineas_Servicios.Columns("codigo").text) & ","               ' codigo
            lstrSQL = lstrSQL & val(dbgLineas_Servicios.Columns("tasa_resguardo").text) & ","       ' tasa_resguardo
            lstrSQL = lstrSQL & "0" & ","                                                           ' descuento1
            lstrSQL = lstrSQL & "0" & ","                                                           ' descuento2
            lstrSQL = lstrSQL & "0" & ")"                                                           ' descuento3
            
            Dbs.Execute lstrSQL
            
            'AIR 20200828 se agrega el insert de la relacion del resguardo con las facturas que involucra
            If D!tipo_doc = "G" And D!signo = -1 And CLng(NullToZero(dbgLineas_Servicios.Columns("nro_doc").text)) <> 0 Then

                'Graba la relacion
                 lstrSQL = "INSERT INTO FaccmpResguardos "
                 lstrSQL = lstrSQL & " VALUES (" & val(txtEmpresa.text) & ","                            ' cod_emp
                 lstrSQL = lstrSQL & val(txtCodDoc.text) & ","                                           ' cod_doc
                 lstrSQL = lstrSQL & val(txtDoc.text) & ","                                              ' nro_doc
                 lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                          ' cod_prov
                 lstrSQL = lstrSQL & llngLinea & ","                                                     ' nro_linea
                 lstrSQL = lstrSQL & CLng(NullToZero(dbgLineas_Servicios.Columns("cod_doc").text)) & ","  ' cod_doca
                 lstrSQL = lstrSQL & CLng(NullToZero(dbgLineas_Servicios.Columns("nro_doc").text)) & ","  ' nro_doca
                 lstrSQL = lstrSQL & val(txtCodProv.text) & ","                                          ' cod_prova
                 lstrSQL = lstrSQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"    ' fec_reg
                 lstrSQL = lstrSQL & UCase(Trim(gUsuario)) & "')"                                        ' usuario
            
                Dbs.Execute lstrSQL
            End If
        End If
        dbgLineas_Servicios.MoveNext
    Next
    dbgLineas_Servicios.MoveFirst
    dbgLineas_Servicios.visible = True

Exit Function

Errores:

    Call FErrores
    Alta_Lineas_de_Servicios = False

End Function

Public Function Alta_Lineas_de_Mercaderia(pstrId As String) As Boolean
Dim lLinea As Long
Dim lEstructura As Boolean
Dim lLinea_Estructura As Integer
Dim llngCodIva As Long
Dim llngTipo_Entrega As Long
Dim llngCod_Doc_Estructura As Long
Dim llngNro_Doc_Estructura As Long
Dim ldblUnidades_Estructura As Double
Dim ldblPrecio_Linea As Double
Dim ldblPrecio_Base As Double
Dim ldblPrecio_Referencia As Double
Dim D As Recordset
Dim e As Recordset
Dim TE As Recordset
Dim lrstEstructura As Recordset
Dim lrstLinArtCod As Recordset
Dim lrstLinMercaderia As Recordset
Dim lstrId As Double

On Error GoTo Errores

    Alta_Lineas_de_Mercaderia = True
    
    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Lineas_de_Mercaderia = False
        Exit Function
    End If
    
    If Trim(UCase(D!mueve_merca_serv)) <> "M" Then
        Exit Function
    End If
    
    ' AIR 20201014 se guardan las lineas en tabla temporal para enviar a Efactura desde tabla en vez de la grilla
    ' y asi poder enviar sumarizado productos iguales si asi lo quiere la empresa.
    
    lLinea = 0
    lEstructura = False
    lLinea_Estructura = 0
    
    For i = 1 To vsfLineas_Mercaderia.Rows - 1
        If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) <> "" Then
            lLinea = lLinea + 1
            
            ldblPrecio_Linea = Format(CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO)), f_Mascara_Decimales_Precios_para_Format_Segun_Configuracion_Monedas(val(txtCodDoc.text), val(txtMoneda.text)))
            
            ldblPrecio_Base = Importe_Base(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO))
            ldblPrecio_Base = Format(ldblPrecio_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Precio_Pesos_Decimales))
            
            'AIR 20240527 esta mal el calculo cuando la moneda es diferente a dolares y pesos, se cambia la rutina
            'ldblPrecio_Referencia = Importe_Referencia(txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO))
            ldblPrecio_Referencia = Importe_Referencia_Segun_Tipo_Cotizacion_Empresa(CLng(txtEmpresa.text), txtMoneda.text, txtTipo_Cambio.text, txtFec_Doc.text, vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO), "F")
            ldblPrecio_Referencia = Format(ldblPrecio_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Precio_Otras_Monedas_Decimales))
            
            If Busco_Producto(val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))) Then
               llngCodIva = rstProd!cod_iva
               
               'Para ver si grabamos la descripcion auxiliar
               If Trim(rstProd!nom_prod) <> Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCRIPCION)) Or Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CAJAS)) <> "" Or Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_PROCEDENCIA)) <> "" Then
                   
                    SQL = "INSERT INTO FaccmpDescripciones (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_prod,descripcion,cantidad_cajas,procedencia) "
                    SQL = SQL & " VALUES ("
                    SQL = SQL & val(txtEmpresa.text) & ","
                    SQL = SQL & val(txtCodDoc.text) & ","
                    SQL = SQL & val(txtDoc.text) & ","
                    SQL = SQL & val(txtCodProv.text) & ","
                    SQL = SQL & lLinea & ","
                    SQL = SQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ",'"
                    SQL = SQL & Trim(Mid(vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCRIPCION), 1, 100)) & "',"
                    SQL = SQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CAJAS)) & ",'"
                    SQL = SQL & Trim(Mid(vsfLineas_Mercaderia.TextMatrix(i, CGL_PROCEDENCIA), 1, 40)) & "')"
                    
                    Dbs.Execute SQL
                   
                End If
            End If
            
            SQL = "INSERT INTO FaccmpLineas (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_prod,"
            SQL = SQL & "cant_prod,precio,descuento1,descuento2,nom_prod_aux,cajas,descuento3,seccion,"
            SQL = SQL & "moneda,tipo_cambio,precio_base,precio_ref,tipo_linea,forma_pago,tipo_entrega)"
            SQL = SQL & " VALUES("
            SQL = SQL & val(txtEmpresa.text) & ","
            SQL = SQL & val(txtCodDoc.text) & ","
            SQL = SQL & val(txtDoc.text) & ","
            SQL = SQL & val(txtCodProv.text) & ","
            SQL = SQL & lLinea & ","
            SQL = SQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ","
            SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) & ","
            SQL = SQL & ldblPrecio_Linea & ","
            SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1)) & ","
            SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2)) & ","
            SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)) & ","   ' llngCodIva   AIR 20210318
            SQL = SQL & "1" & ","
            SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3)) & ","
            SQL = SQL & val(txtSeccion.text) & ","
            SQL = SQL & val(txtMoneda.text) & ","
            SQL = SQL & val(txtTipo_Cambio.text) & ","
            SQL = SQL & ldblPrecio_Base & ","
            SQL = SQL & ldblPrecio_Referencia & ",'"
            SQL = SQL & "M" & "',"
            SQL = SQL & CLng(vsfLineas_Mercaderia.TextMatrix(i, CGL_FORMA_PAGO)) & ","
            
            llngTipo_Entrega = 0
            If Busco_Tipo_Entrega_Mercaderia_Descripcion_Corta(Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIPO_ENTREGA)), TE) Then
                llngTipo_Entrega = TE!codigo
            End If
            SQL = SQL & llngTipo_Entrega & ")"
            
            Dbs.Execute SQL
            
            ' AIR 20171005 si el documento tiene habilitado deposito por lineas
            If D!Facturador_Ver_Columna_Deposito = "S" Or confUsaEquivalenciaMagnitudes Then
                 SQL = "INSERT INTO FaccmpLineas_Datos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,deposito,cant_prod_magnitud,precio_magnitud,"
                 SQL = SQL & "magnitud,importe_descuento,cod_iadic,porc_iadic,importe_iadic)"
                 SQL = SQL & " VALUES("
                 SQL = SQL & val(txtEmpresa.text) & ","
                 SQL = SQL & val(txtCodDoc.text) & ","
                 SQL = SQL & val(txtDoc.text) & ","
                 SQL = SQL & val(txtCodProv.text) & ","
                 SQL = SQL & lLinea & ",'"
                 
                 'JCH 20220530 se agrego todo la carga de magnitudes
                    
                 If D!Facturador_Ver_Columna_Deposito <> "S" Then
                     SQL = SQL & "',"
                 Else
                     If Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DEPOSITO)) = "" Then
                         SQL = SQL & Trim(txtDeposito.text) & "',"
                     Else
                         SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DEPOSITO)) & "',"   'deposito de la linea
                     End If
                 End If
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES_MAGNITUD)) & ","
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD)) & ","
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD)) & ",0,"
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_IADIC)) & ","
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIADIC)) & ","
                 SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE_IADIC)) & ")"
                    
                 Dbs.Execute SQL
            End If
            
            ' SS 20171229 Alta en tabla de articulos codificados, requerimientos de ASU
            If Buscar_Empresa(gCodigo_Empresa, e) Then
                If e!Asociado_ASU = "S" Then
                    
                    SQL = "SELECT * FROM ma_Articulos_Codificacion"
                    SQL = SQL & " WHERE Cod_Prod = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                    
                    Set lrstLinArtCod = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                    
                    Do Until lrstLinArtCod.EOF
                    
                        SQL = "INSERT INTO FaccmpLineas_Articulos_Codificacion (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,codTipo,codItem)"
                        SQL = SQL & " VALUES("
                        SQL = SQL & val(txtEmpresa.text) & ","          ' cod_emp
                        SQL = SQL & val(txtCodDoc.text) & ","           ' cod_doc
                        SQL = SQL & val(txtDoc.text) & ","              ' nro_doc
                        SQL = SQL & val(txtCodProv.text) & ","          ' cod_prov
                        SQL = SQL & lLinea & ",'"                       ' nro_linea
                        SQL = SQL & Trim(lrstLinArtCod!codtipo) & "','" ' codTipo
                        SQL = SQL & Trim(lrstLinArtCod!codItem) & "')"  ' codItem
                        
                        Dbs.Execute SQL
                        
                        lrstLinArtCod.MoveNext
                    Loop
                End If
            End If
            
            'Si el Documento Mueve stock actualizo stock en línea
            If D!stock Then
               
                If D!signo = -1 Then
                    llngCod_Doc_Estructura = gCod_Doc_Venta_x_Estructura
                Else
                    llngCod_Doc_Estructura = gCod_Doc_Devolucion_Venta_x_Estructura
                End If
                
                If Busco_Padre_Estructura("P", val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), lrstEstructura) Then      'mueve stock si la estructura lo tiene indicado   SS 20161026
                   
                   If lrstEstructura!mueve_stock_hijo = "S" Then
                 
                       llngNro_Doc_Estructura = val(Trim(txtCodDoc.text) & Trim(txtDoc.text))
                       ldblUnidades_Estructura = CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES))
                 
                       Call Genero_Stock_x_Estructura(val(txtEmpresa.text), llngCod_Doc_Estructura, llngNro_Doc_Estructura, val(txtCodProv.text), val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)), ldblUnidades_Estructura, txtFec_Doc.text, txtFec_Doc.text, lEstructura, lLinea_Estructura, Trim(UCase(txtDeposito.text)), Trim(UCase(txtDeposito.text)))
                   
                       If Alta_Documento_Relacionado(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), llngCod_Doc_Estructura, llngNro_Doc_Estructura, val(txtCodProv.text), True) Then
                       End If
                   End If
                End If
            End If
            
            ' AIR 20201014 se guardan las lineas en tabla temporal para enviar a Efactura desde tabla temporal en vez de la grilla
            ' para poder enviar sumarizado por producto si asi lo quiere la empresa.
            'AIR 20240425 solo si es documento de factura electronica es necesario utilizar la tabla temporal
            If esEFactura(val(txtCodDoc.text)) Then
                SQL = "SELECT * FROM " & gstrTabla_Temporal_Lineas_Mercaderia
                SQL = SQL & " WHERE Cod_Prod = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                SQL = SQL & " AND punitario = " & ldblPrecio_Linea
                SQL = SQL & " AND dto1 = " & vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1)
                SQL = SQL & " AND dto2 = " & vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2)
                SQL = SQL & " AND dto3 = " & vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3)
                SQL = SQL & " AND descripcion ='" & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCRIPCION)) & "'"
                SQL = SQL & " AND tipo_entrega = " & llngTipo_Entrega
                SQL = SQL & " AND cod_emp = " & val(txtEmpresa.text)
                SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                SQL = SQL & " AND nro_doc = " & val(txtDoc.text)
                SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                SQL = SQL & " AND magnitud = " & vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD)
                
                Set lrstLinMercaderia = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
                
                If lrstLinMercaderia.EOF Or Not ConfPuntoVta_Enviar_Articulo_Agrupado_EFactura Then
                    
                    SQL = "INSERT INTO " & gstrTabla_Temporal_Lineas_Mercaderia & " (Id,cod_emp,cod_doc,nro_doc,cod_prov,linea,cod_prod,"
                    SQL = SQL & "descripcion,codigo_santerior,tipo_entrega,deposito,importe,tiva,iva,unidades,"
                    SQL = SQL & "punitario,punitariosimp,importe_sin_iva,punitariosimp_con_dto,punitarios_con_dto,dto1,dto2,dto3,magnitud,"
                    SQL = SQL & "tasa_iadic,porc_iadic,importe_iadic)"
                    SQL = SQL & " VALUES("
                    SQL = SQL & CDbl(pstrId) & ","
                    SQL = SQL & val(txtEmpresa.text) & ","
                    SQL = SQL & val(txtCodDoc.text) & ","
                    SQL = SQL & val(txtDoc.text) & ","
                    SQL = SQL & val(txtCodProv.text) & ","
                    SQL = SQL & lLinea & ","
                    SQL = SQL & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO)) & ",'"
                    SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DESCRIPCION)) & "','"
                    SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO_SANTERIOR)) & "',"
                    SQL = SQL & llngTipo_Entrega & ",'"
                    SQL = SQL & Trim(vsfLineas_Mercaderia.TextMatrix(i, CGL_DEPOSITO)) & "',"
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIVA)) & ","    ' llngCodIva   'AIR 20210318 se corrige porque el codigo podria ser otro al del producto si el cliente no lleva iva. Ej zonafranca
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IVA)) & ","
                    If Not confUsaEquivalenciaMagnitudes Then
                        SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES)) & ","
                        SQL = SQL & ldblPrecio_Linea & ","
                    Else
                        SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES_MAGNITUD)) & ","
                        SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD)) & ","
                    End If
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE_SIN_IVA)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIOSIMP_CON_DTO)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_CON_DTO)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3)) & ","
                    SQL = SQL & CLng(vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD)) & ","
                    SQL = SQL & CLng(vsfLineas_Mercaderia.TextMatrix(i, CGL_IADIC)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_TIADIC)) & ","
                    SQL = SQL & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE_IADIC)) & ")"
                
                    Dbs.Execute SQL
                
                Else  ' ConfPuntoVta_Enviar_Articulo_Agrupado_EFactura
                
                    SQL = "UPDATE " & Trim(gstrTabla_Temporal_Lineas_Mercaderia)
                    SQL = SQL & " SET "
                    SQL = SQL & " importe = importe + " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE)) & ","
                    SQL = SQL & " importe_sin_iva = importe_sin_iva + " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_IMPORTE_SIN_IVA)) & ","
                    If Not confUsaEquivalenciaMagnitudes Then
                        SQL = SQL & " Unidades = Unidades + " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES))
                    Else
                        SQL = SQL & " Unidades = Unidades + " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES_MAGNITUD))
                    End If
                    SQL = SQL & " WHERE Cod_Prod = " & val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CODIGO))
                    SQL = SQL & " AND dto1 = " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO1))
                    SQL = SQL & " AND dto2 = " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO2))
                    SQL = SQL & " AND dto3 = " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_DTO3))
                    SQL = SQL & " AND tipo_entrega = " & llngTipo_Entrega
                    SQL = SQL & " AND cod_emp = " & val(txtEmpresa.text)
                    SQL = SQL & " AND cod_doc = " & val(txtCodDoc.text)
                    SQL = SQL & " AND nro_doc = " & val(txtDoc.text)
                    SQL = SQL & " AND cod_prov = " & val(txtCodProv.text)
                    SQL = SQL & " AND linea = " & lrstLinMercaderia!linea
                    SQL = SQL & " AND magnitud = " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_MAGNITUD))
                    If Not confUsaEquivalenciaMagnitudes Then
                        SQL = SQL & " AND punitario = " & ldblPrecio_Linea
                    Else
                        SQL = SQL & " AND punitario = " & CDbl(vsfLineas_Mercaderia.TextMatrix(i, CGL_PUNITARIO_MAGNITUD))
                    End If
                    
                    Dbs.Execute SQL
                    
                End If
            End If
        End If
    Next
 
Exit Function

Errores:
    Call FErrores
    Alta_Lineas_de_Mercaderia = False
 
End Function

Public Function Alta_Lineas_Datos_Auxiliares_x_Linea(pstrNombre_Tabla_Lineas_Auxiliar_Temporal As String, pstrDocIni As String) As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Lineas_Datos_Auxiliares_x_Linea = True
    
    ' Dar Alta las Lineas de Datos Auxiliares de las Lineas del Documento
    
    If Trim(pstrNombre_Tabla_Lineas_Auxiliar_Temporal) <> "" Then
    
        ' AIR 20171025 se actualiza el numero de documento antes de insertar por si cambio en este proceso
        If UCase(Trim(sspOperacion.Caption)) = "A" Then
            lstrSQL = "UPDATE " & Trim(pstrNombre_Tabla_Lineas_Auxiliar_Temporal)
            lstrSQL = lstrSQL & " SET nro_doc = " & val(txtDoc.text)
            lstrSQL = lstrSQL & " WHERE nro_doc = " & val(pstrDocIni)
            
            Dbs.Execute lstrSQL
        End If
                                        
        lstrSQL = "INSERT INTO FaccmpLineas_Auxiliar"
        lstrSQL = lstrSQL & " SELECT * FROM " & Trim(pstrNombre_Tabla_Lineas_Auxiliar_Temporal)
        lstrSQL = lstrSQL & " ORDER BY linea"
        
        Dbs.Execute lstrSQL
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Lineas_Datos_Auxiliares_x_Linea = False

End Function


Public Function Alta_Lineas_Datos_Cotizaciones_x_Linea(pstrNombre_Tabla_Temporal_Lineas_Cotizacion As String, plngEmpresa As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long) As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Lineas_Datos_Cotizaciones_x_Linea = True
    
    ' Dar Alta las Lineas de Datos desde la Tabla Temporal
    
    If Trim(pstrNombre_Tabla_Temporal_Lineas_Cotizacion) <> "" Then
    
        lstrSQL = "INSERT INTO FaccmpLineas_Cotizaciones"
        lstrSQL = lstrSQL & " SELECT " & plngEmpresa & ","
        lstrSQL = lstrSQL & plngCod_Doc & ","
        lstrSQL = lstrSQL & plngNro_Doc & ","
        lstrSQL = lstrSQL & plngCod_Prov & ","
        
        lstrSQL = lstrSQL & "nro_linea" & ","
        lstrSQL = lstrSQL & "cod_prod" & ","
        lstrSQL = lstrSQL & "unidades" & ","
        lstrSQL = lstrSQL & "estructura_padre" & ","
        lstrSQL = lstrSQL & "estructura_cantidad" & ","
        lstrSQL = lstrSQL & "precio_venta_moneda" & ","
        lstrSQL = lstrSQL & "precio_venta_porcentaje_sobre_venta" & ","
        lstrSQL = lstrSQL & "precio_venta_civa" & ","
        lstrSQL = lstrSQL & "venta_descuento" & ","
        lstrSQL = lstrSQL & "venta_importe_linea_civa" & ","
        lstrSQL = lstrSQL & "precio_lista_prov_moneda" & ","
        lstrSQL = lstrSQL & "precio_lista_prov_civa" & ","
        lstrSQL = lstrSQL & "factor_conversion float" & ","
        lstrSQL = lstrSQL & "precio_lista_prov_x_factor_civa" & ","
        lstrSQL = lstrSQL & "porcentaje_aumento_descuento" & ","
        lstrSQL = lstrSQL & "costo_moneda" & ","
        lstrSQL = lstrSQL & "costo_civa" & ","
        lstrSQL = lstrSQL & "descuento_1" & ","
        lstrSQL = lstrSQL & "descuento_2" & ","
        lstrSQL = lstrSQL & "descuento_3" & ","
        lstrSQL = lstrSQL & "descuento_finaciero" & ","
        lstrSQL = lstrSQL & "margen float" & ","
        lstrSQL = lstrSQL & "costo_final_civa,"
        lstrSQL = lstrSQL & "descripcion"
        
        lstrSQL = lstrSQL & " FROM " & Trim(pstrNombre_Tabla_Temporal_Lineas_Cotizacion)
        lstrSQL = lstrSQL & " ORDER BY nro_linea"
        
        Dbs.Execute lstrSQL
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Lineas_Datos_Cotizaciones_x_Linea = False

End Function

Public Function Cancelar_Documentos_Afectados() As Boolean
Dim C As Recordset
Dim D As Recordset
Dim R As Recordset
Dim lstrSQL As String
Dim ldblSaldo_a_Cancelar As Double
Dim lLinea As Long

On Error GoTo Errores

    Cancelar_Documentos_Afectados = True
    
    If Trim(txtDoc_Afectado.text) <> "" And Trim(txtNro_Doc_Afectado.text) <> "" Then
           
       
       ' Se ingreso una Factura para Afectar
       
       If IsNumeric(txtDoc_Afectado.text) And IsNumeric(txtNro_Doc_Afectado.text) Then
    
           ' Chequeo si existe el documento
           
           If Buscar_Cabezal_Documento_Emision(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), C) Then
               
                If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
                    Cancelar_Documentos_Afectados = False
                    Exit Function
                End If
               
               
                If Not Buscar_Tipo_Documento(val(txtDoc_Afectado.text), R) Then
                    Cancelar_Documentos_Afectados = False
                    Exit Function
                
                End If
                
                ' AIR 20250717 si el tipo de documento es Presupuesto no se debe afectar , paso en Arocena
                 If R!tipo_doc = "A" And D!signo = -1 And D!tipo_doc = "E" Then
                    Exit Function
                 End If
                
                ' Verifico si tiene saldo a cancelar
               
                ldblSaldo_a_Cancelar = Saldo_A_Cancelar_de_un_Documento(val(txtEmpresa.text), val(txtDoc_Afectado.text), val(txtNro_Doc_Afectado.text), val(txtCodProv.text), val(txtMoneda.text))
                       
                If ldblSaldo_a_Cancelar < CDbl(txtImporte.text) Then
                   MsgBox "El Saldo a Cancelar del Documento " & Trim(txtDoc_Afectado.text) & "/" & Trim(txtNro_Doc_Afectado.text) & " es de " & ldblSaldo_a_Cancelar & ". No se Afectara con esta Nota de Crédito.. ", vbExclamation + vbOKOnly
                               
                Else
                   ' Cancelo el Documento Afectado
                   
                   lLinea = 1
                   ' AIR 19/04/2016 modificado el signo del registro en FaccmpPagos, estaba invertido
                   lstrSQL = "INSERT INTO FaccmpPagos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
                   lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
                   lstrSQL = lstrSQL & " VALUES("
                   lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                   lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                   lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                   lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                   lstrSQL = lstrSQL & lLinea & ","
                   lstrSQL = lstrSQL & CLng(txtDoc_Afectado.text) & ","
                   lstrSQL = lstrSQL & CLng(txtNro_Doc_Afectado.text) & ","
                   lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                   lstrSQL = lstrSQL & f_Fecha_Base(C!fec_doc, Conf_Motor_Base) & ","
                   lstrSQL = lstrSQL & f_Fecha_Base(C!fec_venc, Conf_Motor_Base) & ","
                   lstrSQL = lstrSQL & R!signo * -1 & ","
                   lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
                   lstrSQL = lstrSQL & txtMoneda.text & ")"
                   
                   Dbs.Execute lstrSQL
                   
                    
                    ' Cancelo la propia Nota de Credito
                    lLinea = 2
                    
                    lstrSQL = "INSERT INTO FaccmpPagos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
                    lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
                    lstrSQL = lstrSQL & " VALUES("
                    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & lLinea & ","
                    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(C!fec_doc, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & f_Fecha_Base(C!fec_venc, Conf_Motor_Base) & ","
                    lstrSQL = lstrSQL & D!signo * -1 & ","
                    lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
                    lstrSQL = lstrSQL & txtMoneda.text & ")"
                    
                    Dbs.Execute lstrSQL
        
                End If
            
                'AIR 20200831 si el documento afectado es de tipo resguardo hay que desafectar los documentos sobre los que se realizo el resguardo
                If D!tipo_doc = "G" And D!signo = 1 Then     ' 165
                    lstrSQL = "DELETE FROM FaccmpResguardos "
                    lstrSQL = lstrSQL & " WHERE cod_emp = " & CLng(txtEmpresa.text)
                    lstrSQL = lstrSQL & " AND cod_doc = " & CLng(txtDoc_Afectado.text)
                    lstrSQL = lstrSQL & " AND nro_doc = " & CLng(txtNro_Doc_Afectado.text)
                    lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
                    Dbs.Execute lstrSQL
                End If
            End If
        End If
    End If

Exit Function

Errores:
    Call FErrores
    Cancelar_Documentos_Afectados = False

End Function


Public Function Alta_Series_Articulos()
Dim lclsSerie_Articulo As clsSerie_Articulo
Dim lstrSQL As String

On Error GoTo Errores

    Alta_Series_Articulos = True

    For Each lclsSerie_Articulo In gcolSeries_Articulos
    
        If Trim(lclsSerie_Articulo.serie) <> "" Then
            
            lstrSQL = "INSERT INTO FaccmpLineas_Series"
            lstrSQL = lstrSQL & " VALUES ("
            lstrSQL = lstrSQL & val(txtEmpresa.text) & ","
            lstrSQL = lstrSQL & val(txtCodDoc.text) & ","
            lstrSQL = lstrSQL & val(txtDoc.text) & ","
            lstrSQL = lstrSQL & val(txtCodProv.text) & ","
            lstrSQL = lstrSQL & lclsSerie_Articulo.linea & ","
            lstrSQL = lstrSQL & lclsSerie_Articulo.Cod_Prod & ",'"
            lstrSQL = lstrSQL & Trim(f_Ins_String(lclsSerie_Articulo.serie)) & "',"
            lstrSQL = lstrSQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
            lstrSQL = lstrSQL & Trim(gUsuario) & "','"
            lstrSQL = lstrSQL & Trim(f_Ins_String(lclsSerie_Articulo.serie_sin_control_compra)) & "')"
        
            Dbs.Execute lstrSQL
            
        End If
    Next
    
Exit Function

Errores:
    Call FErrores
    Alta_Series_Articulos = False

End Function

Public Sub Impresion_Tradicional_Segun_Configuracion()
Dim sigo As Integer
Dim D As Recordset

    If Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        ' AIR 20221209 Se agrega opcion que solo es para eFactura valoR P(PDF) -obtienen PDF
        If (frmPunto_Venta.sspOperacion = "U" And Trim(UCase(D!se_Imprime)) <> "A") Then
             Exit Sub
        Else
            If Trim(UCase(D!se_Imprime)) = "N" Or Trim(UCase(D!se_Imprime)) = "P" Or (frmPunto_Venta.sspOperacion <> "U" And Trim(UCase(D!se_Imprime)) = "A") Then
                Exit Sub
            End If
        End If
    End If

    If val(txtCodDoc.text) <> ConfDoc_Ingreso_Pedido_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_PreVenta_Cli And val(txtCodDoc.text) <> ConfDoc_Ingreso_Presupuesto_Cli And val(txtCodDoc.text) <> ConfDoc_Ruptura Then
        If Trim(UCase(sspOperacion.Caption)) = "A" Then
            If gNumerar = True Then
                If Not Abrir_Cajon_Dinero And (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "EL_PALENQUE") Then
                    MsgBox "Error al Abrir el Cajon de Dinero", vbCritical, MsgTit
                End If
                
                Call Imprimir_Factura("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
            End If
        End If
    Else
            
        Select Case val(txtCodDoc.text)
            
            Case ConfDoc_Ingreso_Pedido_Cli
                sigo = MsgBox("Desea Imprimir el Pedido?", vbYesNo + vbInformation, MsgTit)
                If sigo = vbYes Then
                    Call Imprimir_Pedido("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                End If
            Case ConfDoc_Ingreso_Presupuesto_Cli
                sigo = MsgBox("Desea Imprimir el Presupuesto?", vbYesNo + vbInformation, MsgTit)
                If sigo = vbYes Then
                    Call Imprimir_Pedido("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                End If
            Case ConfDoc_Ingreso_PreVenta_Cli
                If ConfFormato_Factura <> "DUBER" And ConfFormato_Factura <> "GARCIALOPEZ" And ConfFormato_Factura <> "STAUDINGER" And ConfFormato_Factura <> "JAGUILAR" And ConfFormato_Factura <> "TATOREPRESENTACIONES" And ConfFormato_Factura <> "ENET" And ConfFormato_Factura <> "BARATILLO" And ConfFormato_Factura <> "MMARTINEZ" And ConfFormato_Factura <> "MILY" And ConfFormato_Factura <> "MAVIM" And ConfFormato_Factura <> "CARLITOS" And ConfFormato_Factura <> "COPISER" And ConfFormato_Factura <> "MERCADO" Then
                    sigo = MsgBox("Desea Imprimir la Pre-Venta?", vbYesNo + vbInformation, MsgTit)
                    If sigo = vbYes Then
                        Call Imprimir_PreVenta("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                    End If
                End If
            Case ConfDoc_Ruptura
                sigo = MsgBox("Desea Imprimir?", vbYesNo + vbInformation, MsgTit)
                If sigo = vbYes Then
                    Call Imprimir_Ruptura("D", val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text), Trim(txtFec_Doc.text), Trim(txtFec_Vencimiento.text), val(txtMoneda.text), val(TxtCodSuc.text), val(txtForma_Pago.text), val(txtVendedor.text), txtGuia.text, txtObs.text, val(txtNro_Fanfold.text), val(txtCta_Madre.text), cryImpresion_Factura_Laser)
                End If
        End Select
    End If

End Sub


Public Function Enviar_Documento_a_eFactura_UY(pstrId As String) As Boolean
Dim D As Recordset
Dim lrstTarjeta As Recordset
Dim lbolImprimir As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Enviar_Documento_a_eFactura_UY = True

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Enviar_Documento_a_eFactura_UY = False
        Exit Function
    End If
    
    lbolImprimir = False
    
    
    Call Cargo_Clase_CFE_UY(D, pstrId)
    
    If Trim(D!Autorizar) = "S" And Trim(UCase(sspOperacion.Caption)) <> "U" Then
        ' JE 20170703   /   Es un documento que hay que autorizar por lo tanto es de SIMULACION
        '                No Controlo si esta el CAE en 0 porque viene sin CAE
        '                   Y no estoy en la operacion de Autorizacion
    
        If Not envioCFE_Simulacion(lCfe, val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
            'Si hay error, no se guarda nada y se descarta el CAE
            Err.Raise 9999, "Enviar_Documento_a_eFactura_UY", "Error al Enviar Documento de SIMULACION a eFactura"
        End If
    Else
        If lCfe.cae.numero = 0 Then
            'Si hay error, el CAE viene en 0 y no se guarda nada, se descarta el CAE
            Err.Raise 9999, "Enviar_Documento_a_eFactura_UY", "Error al Obtener CAE"
        End If
        
        If Not envioCFE_UY(lCfe, val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
            'Si hay error, no se guarda nada y se descarta el CAE
            Err.Raise 9999, "Enviar_Documento_a_eFactura_UY", "Error al Enviar Documento a eFactura"
        End If
    End If
    
    
    'Se guarda el vinculo con el CAE
    If Trim(D!exportacion) = "S" Then
        lClauVta = Trim(txtClauVta.text)
        lViaTransporte = Trim(txtViaTransporte.text)
        lPais = val(Mid(txtPais.text, 1, 3))
    Else
        lClauVta = ""
        lViaTransporte = ""
        lPais = 0
    End If
  
    lstrSQL = "INSERT INTO FaccmpEfactura (cod_emp,cod_doc,nro_doc,cod_prov,idInterno,numero,numeroAutorizacion,serie,fec_reg,usuario,"
    lstrSQL = lstrSQL & "clauvta,viatransporte,pais,tipoCAE,tipo_doc_identidad)"
    lstrSQL = lstrSQL & " VALUES("
    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
    lstrSQL = lstrSQL & lCfe.cae.idInterno & ","
    lstrSQL = lstrSQL & lCfe.cae.numero & ",'"
    lstrSQL = lstrSQL & lCfe.cae.numeroAutorizacion & "','"
    lstrSQL = lstrSQL & lCfe.cae.serie & "',"
    lstrSQL = lstrSQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
    lstrSQL = lstrSQL & Trim(gUsuario) & "','"
    lstrSQL = lstrSQL & lClauVta & "','"
    lstrSQL = lstrSQL & lViaTransporte & "',"
    lstrSQL = lstrSQL & lPais & ",'"
    lstrSQL = lstrSQL & lCfe.cae.Tipo & "',"
    lstrSQL = lstrSQL & Trim(txtTipo_Doc_Identidad.text) & ")"
    
    Dbs.Execute lstrSQL

Exit Function

Errores:
    Call FErrores
    Enviar_Documento_a_eFactura_UY = False

End Function


Public Function Enviar_Documento_a_eFactura_CL(pstrId As String) As Boolean
Dim D As Recordset
Dim lrstTarjeta As Recordset
Dim lbolImprimir As Boolean
Dim lstrSQL As String

On Error GoTo Errores

    Enviar_Documento_a_eFactura_CL = True

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Enviar_Documento_a_eFactura_CL = False
        Exit Function
    End If
    
    lbolImprimir = False
    'chile comenatado  Call Cargo_Clase_CFE_CL(D, pstrId)
    
    
    If lefCL.IdDoc.Folio = "-1" Then
            'Si hay error, el CAE viene en 0 y no se guarda nada, se descarta el CAE
            Err.Raise 9999, "Enviar_Documento_a_eFactura_CL", "Error al Obtener CAE"
    End If
        
    'chile comenatado
    'If Not envioCFE_CL(lefCL, val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text)) Then
            'Si hay error, no se guarda nada y se descarta el CAE
    '        Err.Raise 9999, "Enviar_Documento_a_eFactura_CL", "Error al Enviar Documento a eFactura"
    'End If
    
    
    
    'Se guarda el vinculo con el CAE
    If Trim(D!exportacion) = "S" Then
        lClauVta = Trim(txtClauVta.text)
        lViaTransporte = Trim(txtViaTransporte.text)
        lPais = val(Mid(txtPais.text, 1, 3))
    Else
        lClauVta = ""
        lViaTransporte = ""
        lPais = 0
    End If
  
    lstrSQL = "INSERT INTO FaccmpEfactura (cod_emp,cod_doc,nro_doc,cod_prov,idInterno,numero,numeroAutorizacion,serie,fec_reg,usuario,"
    lstrSQL = lstrSQL & "clauvta,viatransporte,pais,tipoCAE,tipo_doc_identidad)"
    lstrSQL = lstrSQL & " VALUES("
    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
    lstrSQL = lstrSQL & "0,"
    lstrSQL = lstrSQL & Trim(lefCL.IdDoc.Folio) & ",'0','',"
    lstrSQL = lstrSQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
    lstrSQL = lstrSQL & Trim(gUsuario) & "','"
    lstrSQL = lstrSQL & lClauVta & "','"
    lstrSQL = lstrSQL & lViaTransporte & "',"
    lstrSQL = lstrSQL & lPais & ",'"
    lstrSQL = lstrSQL & lefCL.IdDoc.TipoDte & "',"
    lstrSQL = lstrSQL & Trim(txtTipo_Doc_Identidad.text) & ")"
    
    Dbs.Execute lstrSQL
    
    
    lstrSQL = "insert into faccmp_Cabezal_Adicional_CL values("
    lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
    lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
    lstrSQL = lstrSQL & gDAdicFE.TpoTranVenta & ","
    lstrSQL = lstrSQL & gDAdicFE.IndServicio & ","
    lstrSQL = lstrSQL & gDAdicFE.TipoDespacho & ","
    lstrSQL = lstrSQL & gDAdicFE.IndTraslado & ",'"
    lstrSQL = lstrSQL & Trim(gDAdicFE.Patente) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.RutTransportista) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.RutChofer) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.NombreChofer) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.DireccionDestino) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.ComunaDestino) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.CiudadDestino) & "','"
    lstrSQL = lstrSQL & Trim(gDAdicFE.RutMandante) & "',"
    lstrSQL = lstrSQL & gDAdicFE.IVATerc & ")"
        
    Dbs.Execute lstrSQL
        
    
    
    

Exit Function

Errores:
    Call FErrores
    Enviar_Documento_a_eFactura_CL = False

End Function



Public Sub Impresion_eFactura()
Dim D As Recordset
Dim lrstTarjeta As Recordset
Dim vou As Integer

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Exit Sub
    End If

    ' JE 20160428 / Se utiliza ahora el parametro del Documento
    If Trim(UCase(D!eFactura_Imprimir_Local)) = "S" Then
    
        If Trim(UCase(D!se_Imprime)) = "S" Then
            Select Case Trim(UCase(confPais))
               Case "UY"
                   Call Imprimir_eTicket_o_Cupon("comp", Trim(lCfe.cae.idInterno), lCfe.impresora, lCfe.formatoFactura, Trim(lCfe.vias))
               Case "CL"
                  'chile comenatado
                  ' Call Imprimir_eTicket_CL(CLng(txtEmpresa.text), CLng(lefCL.IdDoc.TipoDte), lefCL.IdDoc.Folio, lCfe.impresora, IIf(lefCL.IdDoc.FmaPago = 2, "TRUE", "FALSE"), Trim(lCfe.vias))
            
            End Select
            'ordenar la impresion
            Sleep 2000
        Else
            If Trim(UCase(D!se_Imprime)) = "C" Then
               sigo = MsgBox("Desea Imprimir el Documento?", vbYesNo + vbInformation, MsgTit)
               If sigo = vbYes Then
                    Select Case Trim(UCase(confPais))
                         Case "UY"
                             Call Imprimir_eTicket_o_Cupon("comp", Trim(lCfe.cae.idInterno), lCfe.impresora, lCfe.formatoFactura, Trim(lCfe.vias))
                         Case "CL"
                             'chile comenatado
                             'Call Imprimir_eTicket_CL(CLng(txtEmpresa.text), CLng(lefCL.IdDoc.TipoDte), lefCL.IdDoc.Folio, lCfe.impresora, IIf(lefCL.IdDoc.FmaPago = 2, "TRUE", "FALSE"), Trim(lCfe.vias))
            
                    End Select
                     
                    
                    'Para ordenar la impresion
                    Sleep 2000
               End If
            End If
        End If
        
        
        If Existe_Tarjeta_para_Documento(CLng(txtEmpresa.text), CLng(txtCodDoc.text), CLng(txtDoc.text), CLng(txtCodProv.text), lrstTarjeta) Then
         'JCH 08.11.2021 modificacion del llamado de impresion de voucher de tarjetas
            Call Cargo_Logtrans("IMPRESION Faccmp_Baucher_TCredito " & Trim(txtCodDoc.text) & "-" & Trim(txtDoc.text) & "-" & Trim(txtCodProv.text) & " Autoriz." & Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) & " Tipo." & Trim(lrstTarjeta!tipo_autorizacion))
        
            If Trim(ConfFormatoVoucherTarjetaRpt) = "S" Then
                If Imprimir_Voucher_Tarjeta(Me.txtEmpresa.text, Me.txtCodDoc.text, val(Me.txtDoc.text), Me.txtCodProv.text, Me.txtCaja.text, Me.CrystalReport1) Then
                End If
            Else
                While Not lrstTarjeta.EOF
                   For vou = 1 To ConfImprimirVoucherSisNet
                        Sleep 2000
                        'UCase("TikCupAnNorImp")
                        Call envioCUPON(CLng(txtEmpresa.text), lCfe.impresora, UCase(ConfFormatoTicketVoucher), lrstTarjeta, txtDes_Moneda.text)
                   Next
                   lrstTarjeta.MoveNext
                Wend
            End If
        Else
            If Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) <> "" Then     'Indica que se ingresaron tarjetas a traves del POS
                Call Cargo_Logtrans("IMPRESION con ERROR Faccmp_Baucher_TCredito " & Trim(txtCodDoc.text) & "-" & Trim(txtDoc.text) & "-" & Trim(txtCodProv.text) & " Autoriz." & Trim(gstrUltimo_Nro_Autorizacion_Tarjeta) & " NO encuentra Documento")
            End If
        End If

    Else
        ' AIR 20221209 Se agrega opcion que solo es para eFactura valor P(PDF) - obtiene PDF
        If Trim(UCase(D!se_Imprime)) = "P" Then
            'Call PDF_Click
            Call obtengoYMuestroPDF(val(txtEmpresa.text), lCfe.cae.idInterno, lCfe.formatoFactura, lCfe.cae.Tipo, Trim(lCfe.cae.serie), val(lCfe.cae.numero))
        
        End If
        
    End If
  
    If Not Abrir_Cajon_Dinero And (ConfFormato_Factura = "CASINO-POS" Or ConfFormato_Factura = "DUBER" Or ConfFormato_Factura = "EL_PALENQUE") Then
        MsgBox "Error al Abrir el Cajon de Dinero", vbCritical, MsgTit
    End If

End Sub


Public Function Cancelar_Pedidos_Afectados() As Boolean
Dim lrstEntrega  As Recordset
Dim lstrSQL As String
Dim C As Recordset
Dim RP As Recordset
Dim lLinea As Long
Dim llngNumero_Pedido As Long
Dim llngCod_Prov_Afectado As Long

On Error GoTo Errores

    Cancelar_Pedidos_Afectados = True
    
    ' JE 20240703   /   Verifico si el cleinte es distinto el que tiene el documento de PREVENTA AFECTADO, es porque seguramente
    '                   fue un codigo de cliente generico y se cambio con el documento final
    
    llngCod_Prov_Afectado = val(txtCodProv.text)
    
    If glngCod_Cliente_Preventa <> 0 Then
        If glngCod_Cliente_Preventa <> val(txtCodProv.text) Then
            If Buscar_Cliente(glngCod_Cliente_Preventa, C) Then
                If Trim(UCase(C!generico)) = "S" Then
                    llngCod_Prov_Afectado = glngCod_Cliente_Preventa
                End If
            End If
        End If
    End If
    
    ' Chequeo si existe una tabla de carga de los Datos desde una Temporal de Preventa para insert en la faccmppedidos los datos
    If Trim(gstrTabla_Temporal_Preventa) <> "" Then
    
        lstrSQL = " SELECT * FROM " & gstrTabla_Temporal_Preventa & " ORDER BY cod_doc, nro_doc"
        Set RP = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
        lLinea = 0
        Do While Not RP.EOF
    
            lLinea = lLinea + 1
            llngNumero_Pedido = RP!nro_doc
            lstrSQL = "INSERT INTO FaccmpPedidos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
            lstrSQL = lstrSQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
            lstrSQL = lstrSQL & " VALUES("
            lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
            lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
            lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
            lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
            lstrSQL = lstrSQL & lLinea & ","
            lstrSQL = lstrSQL & RP!cod_doc & ","
            lstrSQL = lstrSQL & RP!nro_doc & ","
            
            ' JE 202400703  /   Aqui utilizo la variable llngCod_Prov_Afectado segun queda configurado arriba por el manejo de cuando
            '                   se cambia el Cleinte cuando el original es Generico
            'lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
            lstrSQL = lstrSQL & llngCod_Prov_Afectado & ","
            
            lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & f_Fecha_Base(txtFec_Vencimiento.text, Conf_Motor_Base) & ","
            lstrSQL = lstrSQL & "1" & ","
            lstrSQL = lstrSQL & CDbl(txtImporte.text) & ","
            lstrSQL = lstrSQL & CLng(txtMoneda.text) & ")"
    
            Dbs.Execute lstrSQL
            
            RP.MoveNext
        Loop
        
        ' AIR 20191104 para SGIMENEZ se agrega que se traslade del Pedido del Movil a la factura la informacion de los Datos de Entrega
        
       
        RP.MoveFirst   'AIR 20240205
        If Not RP.EOF Then
         'RP.MoveFirst
            lstrSQL = " SELECT * FROM faccmp_Entrega_Mercaderia_Cabezal E"
            lstrSQL = lstrSQL & " WHERE cod_emp =  " & CLng(txtEmpresa.text)
            lstrSQL = lstrSQL & " AND cod_doc = " & RP!cod_doc
            lstrSQL = lstrSQL & " AND nro_doc =  " & RP!nro_doc
            
            
            Set lrstEntrega = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
            
            If Not lrstEntrega.EOF Then

                lstrSQL = "INSERT INTO faccmp_Entrega_Mercaderia_Cabezal"
                lstrSQL = lstrSQL & " VALUES ("
                lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                lstrSQL = lstrSQL & lrstEntrega!tipo_entrega & ",'"
                lstrSQL = lstrSQL & lrstEntrega!direccion_entrega & "','"
                lstrSQL = lstrSQL & lrstEntrega!zona_entrega & "',"
                lstrSQL = lstrSQL & lrstEntrega!ciudad_entrega & ","
                lstrSQL = lstrSQL & lrstEntrega!departamento_entrega & ","
                lstrSQL = lstrSQL & f_Fecha_Base(lrstEntrega!fecha_entrega, Conf_Motor_Base) & ","
                lstrSQL = lstrSQL & f_Fecha_Base(lrstEntrega!fecha_pedido_proveedor, Conf_Motor_Base) & ",'"
                lstrSQL = lstrSQL & lrstEntrega!telefono_contacto_entrega & "','"
                lstrSQL = lstrSQL & lrstEntrega!horario_entrega & "','"
                lstrSQL = lstrSQL & lrstEntrega!contacto_entrega & "','"
                lstrSQL = lstrSQL & lrstEntrega!aplicar_a_todos_los_articulos & "',"
                lstrSQL = lstrSQL & f_Fecha_Base(lrstEntrega!fec_reg, Conf_Motor_Base) & ",'"
                lstrSQL = lstrSQL & lrstEntrega!usuario & "','"
                lstrSQL = lstrSQL & lrstEntrega!agencia_envios_entrega & "','"
                lstrSQL = lstrSQL & lrstEntrega!entre_calles & "','"
                lstrSQL = lstrSQL & lrstEntrega!referencia_lugar & "','"
                lstrSQL = lstrSQL & lrstEntrega!cargo_persona_recibe & "','"
                lstrSQL = lstrSQL & lrstEntrega!observacion & "','"
                lstrSQL = lstrSQL & lrstEntrega!cliente_retira_agencia & "','"          'AIR 20241028 faltaba este campo
                lstrSQL = lstrSQL & lrstEntrega!referencia & "')"                       'JE 20240819

                Dbs.Execute lstrSQL

         
                lstrSQL = "INSERT INTO faccmp_Entrega_Mercaderia_Lineas"
                lstrSQL = lstrSQL & " SELECT "
                lstrSQL = lstrSQL & CLng(txtEmpresa.text) & ","
                lstrSQL = lstrSQL & CLng(txtCodDoc.text) & ","
                lstrSQL = lstrSQL & CLng(txtDoc.text) & ","
                lstrSQL = lstrSQL & CLng(txtCodProv.text) & ","
                lstrSQL = lstrSQL & "nro_linea,"
                lstrSQL = lstrSQL & "cod_prod,"
                lstrSQL = lstrSQL & "cant_prod,"
                lstrSQL = lstrSQL & "tipo_entrega,"
                lstrSQL = lstrSQL & "direccion_entrega,"
                lstrSQL = lstrSQL & "zona_entrega,"
                lstrSQL = lstrSQL & "ciudad_entrega,"
                lstrSQL = lstrSQL & "departamento_entrega,"
                lstrSQL = lstrSQL & "fecha_entrega,"
                lstrSQL = lstrSQL & "fecha_pedido_proveedor,"
                lstrSQL = lstrSQL & "telefono_contacto_entrega,"
                lstrSQL = lstrSQL & "horario_entrega,"
                lstrSQL = lstrSQL & "contacto_entrega,"
                lstrSQL = lstrSQL & "fec_reg,"
                lstrSQL = lstrSQL & "usuario,"
                lstrSQL = lstrSQL & "cod_doca,"
                lstrSQL = lstrSQL & "nro_doca,"
                lstrSQL = lstrSQL & "agencia_envios_entrega,"
                lstrSQL = lstrSQL & "entre_calles,"
                lstrSQL = lstrSQL & "referencia_lugar,"
                lstrSQL = lstrSQL & "cargo_persona_recibe,"
                lstrSQL = lstrSQL & "observacion,"
                lstrSQL = lstrSQL & "nom_prod_ajustado"
                lstrSQL = lstrSQL & " FROM faccmp_Entrega_Mercaderia_Lineas"
                lstrSQL = lstrSQL & " WHERE cod_emp =  " & CLng(txtEmpresa.text)
                lstrSQL = lstrSQL & " AND cod_doc = " & lrstEntrega!cod_doc
                lstrSQL = lstrSQL & " AND nro_doc =  " & lrstEntrega!nro_doc
                lstrSQL = lstrSQL & " AND cod_prov =  " & lrstEntrega!Cod_Prov
                
                Dbs.Execute lstrSQL
                
            End If
        End If
    End If
    
    gstrTabla_Temporal_Preventa = ""

Exit Function

Errores:
    Call FErrores
    Cancelar_Pedidos_Afectados = False
Exit Function
Resume

End Function


Public Function Alta_Cheques_Ingresados() As Boolean
Dim lLinea As Integer
Dim i As Long
Dim SQL As String
Dim ldblTipo_Cambio_Rec As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim R As Recordset

On Error GoTo Errores

    Alta_Cheques_Ingresados = True
    
    'Grabamos los cheques de la factura, los calculos son con los datos recibidos
 
    lLinea = 0
    
        

    For i = 1 To vsfCheques.Rows - 1
        If Trim(vsfCheques.TextMatrix(i, CGCH_BANCO)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_IMPORTE)) <> "" And Trim(vsfCheques.TextMatrix(i, CGCH_MONEDA)) <> "" And _
            Trim(vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE)) <> "" Then
            
            If Buscar_Tipo_Documento(val(vsfCheques.TextMatrix(i, CGCH_DOCUMENTO)), R) Then
            End If
            
             'AIR 20220705 no se estaba considerando que si el documento es autonumerado hay que tomar numero
            If R!ndor_doc <> 0 And UCase(Trim(sspOperacion.Caption)) = "A" Then
                ' Pido Nuevamente un nuevo numero por si otro usuario ya lo tomo
                vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE) = Tomo_Nuevo_Numero_Contador_Documentos(CLng(txtEmpresa.text), R!ndor_doc, "D", True)
            End If
                       
            
            lLinea = lLinea + 1
            
            'Grabamos
    
            ldblTipo_Cambio_Rec = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(vsfCheques.TextMatrix(i, CGCH_MONEDA)), Format(txtFec_Doc.text, "dd/mm/yyyy"), "F")
            
            'AIR 20180326 si la factura es en DOLARES toma el manual comprador
            If val(vsfCheques.TextMatrix(i, CGCH_MONEDA)) <> gMoneda_Base And ConfFormato_Factura = "VEICUER" And val(txtEmpresa.text) = 1 Then
                ldblTipo_Cambio_Rec = Tipo_Cambio_Segun_Tipo_Cotizacion_Empresa(val(txtEmpresa.text), val(vsfCheques.TextMatrix(i, CGCH_MONEDA)), Format(txtFec_Doc.text, "dd/mm/yyyy"), "PP")
            End If
            
            ldblImporte_Base = Importe_Base(val(vsfCheques.TextMatrix(i, CGCH_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, CDbl(vsfCheques.TextMatrix(i, CGCH_IMPORTE)))
            ldblImporte_Base = Format(ldblImporte_Base, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
            
            ldblImporte_Referencia = Importe_Referencia(val(vsfCheques.TextMatrix(i, CGCH_MONEDA)), ldblTipo_Cambio_Rec, txtFec_Doc.text, CDbl(vsfCheques.TextMatrix(i, CGCH_IMPORTE)))
            ldblImporte_Referencia = Format(ldblImporte_Referencia, f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
            
            SQL = "INSERT INTO FaccmpCheques (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_banco,nro_cheque,"
            SQL = SQL & "fec_ven,moneda,tipo_cambio,importe,importe_base,importe_ref,cod_doc_cheque,estado,cuenta,"
            SQL = SQL & "cuenta_librador,titular_librador,serie,fec_emision)"
            SQL = SQL & " VALUES("
            SQL = SQL & val(txtEmpresa.text) & ","
            SQL = SQL & val(txtCodDoc.text) & ","
            SQL = SQL & val(txtDoc.text) & ","
            SQL = SQL & val(txtCodProv.text) & ","
            SQL = SQL & lLinea & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_BANCO) & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE) & ","
            SQL = SQL & f_Fecha_Base(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO), Conf_Motor_Base) & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_MONEDA) & ","
            SQL = SQL & ldblTipo_Cambio_Rec & ","
            SQL = SQL & CDbl(NullToZero(vsfCheques.TextMatrix(i, CGCH_IMPORTE))) & ","    ' AIR 20190507 se formate el importe porque estaba dando error la coma separadora de miles en el insert
            SQL = SQL & ldblImporte_Base & ","
            SQL = SQL & ldblImporte_Referencia & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_DOCUMENTO) & ","
            SQL = SQL & "'C'" & ","                                                      ' estado
            
            'AIR 20220106 si se ingresó cuenta en el caso de las transferencias hay que tomar la cuenta bancaria ingresada no tiene que ir a la cuenta cartera
            If val(vsfCheques.TextMatrix(i, CGCH_CUENTA)) = 0 Then
                Select Case val(vsfCheques.TextMatrix(i, CGCH_MONEDA))
                    Case gMoneda_Base
                        SQL = SQL & gCuenta_Base & ",'"                                             ' cuenta
                    Case gMoneda_Referencia
                        SQL = SQL & gCuenta_Referencia & ",'"                                       ' cuenta
                End Select
                
            Else
                SQL = SQL & val(vsfCheques.TextMatrix(i, CGCH_CUENTA)) & ",'"                      ' cuenta
            End If
            
            SQL = SQL & Trim(vsfCheques.TextMatrix(i, CGCH_CUENTA_LIBRADOR)) & "','"            ' cuenta_librador
            SQL = SQL & Trim(vsfCheques.TextMatrix(i, CGCH_TITULAR_LIBRADOR)) & "','"           ' titular_librador
            SQL = SQL & Trim(vsfCheques.TextMatrix(i, CGCH_SERIE)) & "',"                       ' serie
            SQL = SQL & f_Fecha_Base(vsfCheques.TextMatrix(i, CGCH_FECHA_EMISION), Conf_Motor_Base) & ")"    ' fec_emision
            
            Dbs.Execute SQL
     
            'Grabamos en los movimientos bancarios como en cartera
            'Optimizacion en la empresa colocar el banco y cuenta con la que se trabaja en Moneda base y Referencia para parametrizar
                    
            SQL = "INSERT INTO Mov_Bancarios (cod_emp,cod_banco,nro_cuenta,cod_doc,nro_doc,estado,fec_doc,"
            SQL = SQL & "fec_venc,cod_moneda,tipo_cambio,importe,importe_base,importe_ref,cod_doca,nro_doca,cod_prova,"
            SQL = SQL & "observacion,fec_reg,usuario,cod_banco_emi,fec_banco,nro_int,cod_doca_dep,nro_doca_dep,cuenta_librador,titular_librador,serie) "
            SQL = SQL & " VALUES("
            SQL = SQL & val(txtEmpresa.text) & ","
            
            ' JC 202205  cuando es transferencia se debe otmar el banco ingresado en la grilla
            SQL = SQL & IIf(UCase(Trim(R!tipo_cheque)) = "TXBANCO_DIA" Or UCase(Trim(R!tipo_cheque)) = "TXBANCO_DIFERIDO", Trim(vsfCheques.TextMatrix(i, CGCH_BANCO)), Trim(gBanco_Empresa)) & ","
            
            'AIR 20220106 si se ingresó cuenta en el caso de las transferencias hay que tomar la cuenta bancaria ingresada no tiene que ir a la cuenta cartera
            If val(vsfCheques.TextMatrix(i, CGCH_CUENTA)) = 0 Then
            
                Select Case val(vsfCheques.TextMatrix(i, CGCH_MONEDA))
                    Case gMoneda_Base
                        SQL = SQL & gCuenta_Base & ","
                    Case gMoneda_Referencia
                        SQL = SQL & gCuenta_Referencia & ","
                End Select
            Else
                SQL = SQL & val(vsfCheques.TextMatrix(i, CGCH_CUENTA)) & ","                      ' cuenta
            End If
            
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_DOCUMENTO) & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_NUMERO_CHEQUE) & ","
            SQL = SQL & "'C',"
            SQL = SQL & f_Fecha_Base(txtFec_Doc.text, Conf_Motor_Base) & ","
            SQL = SQL & f_Fecha_Base(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO), Conf_Motor_Base) & ","
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_MONEDA) & ","
            SQL = SQL & ldblTipo_Cambio_Rec & ","
            SQL = SQL & CDbl(NullToZero(vsfCheques.TextMatrix(i, CGCH_IMPORTE))) & ","  ' AIR 20190507 se formate el importe porque estaba dando error la coma separadora de miles en el insert
            SQL = SQL & ldblImporte_Base & ","
            SQL = SQL & ldblImporte_Referencia & ","
            SQL = SQL & val(txtCodDoc.text) & ","
            SQL = SQL & val(txtDoc.text) & ","
            SQL = SQL & val(txtCodProv.text) & ","
            SQL = SQL & "'',"
            SQL = SQL & f_Fecha_Base(date, Conf_Motor_Base) & ",'"
            SQL = SQL & Trim(UCase(gUsuario)) & "',"
            SQL = SQL & vsfCheques.TextMatrix(i, CGCH_BANCO) & ","
            SQL = SQL & f_Fecha_Base(vsfCheques.TextMatrix(i, CGCH_FECHA_VTO), Conf_Motor_Base) & ","
            SQL = SQL & "0" & ","
            SQL = SQL & "0" & ","
            SQL = SQL & "0" & ",'','','')"

            
            Dbs.Execute SQL
        End If
    Next
 
Exit Function

Errores:
    Call FErrores
    Alta_Cheques_Ingresados = False

End Function

Public Function Alta_Cuotas(plngFila As Long, pintSigno As Integer) As Boolean
Dim M As Recordset
Dim ldblImporte_Cuota As Double
Dim ldblImporte_Base As Double
Dim ldblImporte_Referencia As Double
Dim ldteFecha_Vencimiento As Date
Dim j As Long
Dim ldblDiferencia As Double

On Error GoTo Errores

    Alta_Cuotas = True
    ldblDiferencia = 0
    
    If Busco_Medios_Pago(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MEDIO_PAGO)), M) And pintSigno = -1 Then
        If M!cuotas > 0 And CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) > 0 Then
            ' El Medio de Pago se Divide en Cuotas
            
            If ConfFormato_Factura = "BARATILLO" Then
            
                If CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) / M!cuotas > Int(CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) / M!cuotas) Then
                    ldblImporte_Cuota = Int((CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) / M!cuotas) + 1)
                Else
                    ldblImporte_Cuota = Int(CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) / M!cuotas)
                End If
                'AIR 20190913 se calcula la diferencia entre el total de la factura y la sumatoria de las cuotas llevadas a Int()
                ldblDiferencia = CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) - ldblImporte_Cuota * M!cuotas
            
            Else
                ldblImporte_Cuota = Round(CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) / M!cuotas, 2)
                ldblDiferencia = Round(CDbl(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_IMPORTE)) - ldblImporte_Cuota * M!cuotas, 2)
            End If
            
            ldblImporte_Base = Importe_Base(val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_Cuota)
            
            'AIR 20240527 esta mal el calculo cuando la moneda es diferente a dolares y pesos, se cambia la rutina
            'ldblImporte_Referencia = Importe_Referencia(val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_Cuota)
            ldblImporte_Referencia = Importe_Referencia_Segun_Tipo_Cotizacion_Empresa(CLng(txtEmpresa.text), val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, ldblImporte_Cuota, "F")
            ldblImporte_Base = Round(ldblImporte_Base, 2)
            ldblImporte_Referencia = Round(ldblImporte_Referencia, 2)
            
            
            For j = 1 To M!cuotas
                
                If Calcular_Fecha_Vencimiento_Cuota(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MEDIO_PAGO)), j, CDate(txtFec_Doc.text), ldteFecha_Vencimiento) Then
                    'Actualizamos la fecha de vencimiento del cabezal con la de la primer cuota
                    If j = 1 Then
                        SQL = "UPDATE faccmp SET fec_venc = " & f_Fecha_Base(ldteFecha_Vencimiento, Conf_Motor_Base)
                        SQL = SQL & " WHERE cod_emp = " & val(txtEmpresa.text)
                        SQL = SQL & " AND " & " cod_doc = " & val(txtCodDoc.text)
                        SQL = SQL & " AND " & " nro_doc = " & val(txtDoc.text)
                        SQL = SQL & " AND " & " cod_prov = " & val(txtCodProv.text)
                        Dbs.Execute SQL
                    End If
                Else
                    ldteFecha_Vencimiento = CDate(txtFec_Doc.text)
                End If
                            
                SQL = "INSERT INTO Faccmp_Cuotas (cod_emp,cod_doc,nro_doc,cod_prov,cod_mpago,cuota,cod_doca,nro_doca,cod_prova,fec_doc,fec_venc,signo,moneda,tipo_cambio,importe_original,importe_original_base,importe_original_ref,fec_reg,usuario,saldo,saldo_base,saldo_ref,intereses,intereses_base,intereses_ref,importe_afectado,importe_afectado_base,importe_afectado_ref,fec_reg_afectado,usuario_afectado)"
                SQL = SQL & " VALUES("
                SQL = SQL & val(txtEmpresa.text) & ","
                SQL = SQL & val(txtCodDoc.text) & ","
                SQL = SQL & val(txtDoc.text) & ","
                SQL = SQL & val(txtCodProv.text) & ","
                SQL = SQL & CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MEDIO_PAGO)) & ","
                SQL = SQL & j & ","
                SQL = SQL & val(txtCodDoc.text) & ","
                SQL = SQL & val(txtDoc.text) & ","
                SQL = SQL & val(txtCodProv.text) & ","
                SQL = SQL & f_Fecha_Base(Format(txtFec_Doc.text, "dd/mm/yyyy"), Conf_Motor_Base) & ","
                SQL = SQL & f_Fecha_Base(ldteFecha_Vencimiento, Conf_Motor_Base) & ","
                SQL = SQL & pintSigno & ","
                SQL = SQL & CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA)) & ","
                SQL = SQL & val(txtTipo_Cambio.text) & ","
                
                ' AIR se agrega la diferencia en la ultima cuota para que la suma de las cuotas de igual que el total de la factura.
                
                If j = M!cuotas And ldblDiferencia <> 0 Then
                    ldblImporte_Cuota = ldblImporte_Cuota + ldblDiferencia
                    ldblImporte_Base = Importe_Base(val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, (ldblImporte_Cuota + ldblDiferencia))
                    
                    'AIR 20240514 esta mal el calculo cuando la moneda es diferente a dolares y pesos, se cambia la rutina
                    'ldblImporte_Referencia = Importe_Referencia(val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, (ldblImporte_Cuota + ldblDiferencia))
                    ldblImporte_Referencia = Importe_Referencia_Segun_Tipo_Cotizacion_Empresa(CLng(txtEmpresa.text), val(CLng(vsfMedios_Pagos.TextMatrix(plngFila, CGMP_MONEDA))), val(txtTipo_Cambio.text), txtFec_Doc.text, (ldblImporte_Cuota + ldblDiferencia))
                
                End If
                
                SQL = SQL & ldblImporte_Cuota & ","
                SQL = SQL & ldblImporte_Base & ","
                SQL = SQL & ldblImporte_Referencia & ","
                SQL = SQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"
                SQL = SQL & UCase(Trim(gUsuario)) & "',"
                SQL = SQL & ldblImporte_Cuota & ","
                SQL = SQL & ldblImporte_Base & ","
                SQL = SQL & ldblImporte_Referencia & ","
                SQL = SQL & "0" & ","
                SQL = SQL & "0" & ","
                SQL = SQL & "0" & ","
                SQL = SQL & ldblImporte_Cuota & ","
                SQL = SQL & ldblImporte_Base & ","
                SQL = SQL & ldblImporte_Referencia & ","
                SQL = SQL & f_Fecha_Base(Format(date, "dd/mm/yyyy"), Conf_Motor_Base) & ",'"
                SQL = SQL & UCase(Trim(gUsuario)) & "')"
                                
                Dbs.Execute SQL
            
            Next j
            
        End If
    End If

Exit Function

Errores:
    Call FErrores
    Alta_Cuotas = False

End Function

Public Function Alta_Vale(plngMoneda As Long, pdblImporte As Double) As Boolean
Dim R As Recordset
Dim SQL As String
Dim ldteFecVto As Date

On Error GoTo Errores

    Alta_Vale = True
    
    lstrSQL = "SELECT Medios_pago.* "
    lstrSQL = lstrSQL & " FROM Medios_pago "
    lstrSQL = lstrSQL & " WHERE Medios_pago.tipo_medio_pago = 'V' AND "
    lstrSQL = lstrSQL & " Medios_pago.moneda = " & plngMoneda
    
    Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
                
    If Not IsNull(R!dias_cobrar) Then
        ldteFecVto = date + R!dias_cobrar
    Else
        MsgBox "No se han asignado los dias de Vencimiento para el Medio de Pago Vale. Se consideran 30 dias.", vbInformation, MsgTit
        ldteFecVto = date + 30
    End If
    
    SQL = "INSERT INTO Faccmp_Vales "
    SQL = Trim(SQL) & " (cod_emp,cod_doc,nro_doc,cod_prov,cod_doca,nro_doca,cod_prova,"
    SQL = Trim(SQL) & " moneda,importe,tipo_doc_identidad,doc_identidad,fec_venc)"
    SQL = Trim(SQL) & " VALUES ("
    SQL = Trim(SQL) & val(txtEmpresa.text) & ","
    SQL = Trim(SQL) & val(txtCodDoc.text) & ","
    SQL = Trim(SQL) & val(txtDoc.text) & ","
    SQL = Trim(SQL) & val(txtCodProv.text) & ","
    SQL = Trim(SQL) & val(txtCodDoc.text) & ","
    SQL = Trim(SQL) & val(txtDoc.text) & ","
    SQL = Trim(SQL) & val(txtCodProv.text) & ","
    SQL = Trim(SQL) & plngMoneda & ","
    SQL = Trim(SQL) & pdblImporte & ","
    SQL = Trim(SQL) & val(txtTipo_Doc_Identidad) & ",'"
    SQL = Trim(SQL) & val(TxtRuc.text) & "',"
    SQL = Trim(SQL) & f_Fecha_Base(ldteFecVto, Conf_Motor_Base) & ")"
    
    Dbs.Execute SQL

Exit Function

Errores:
    Call FErrores
    Alta_Vale = False
   
End Function

Private Sub TxtNroIdCompra_Celick()

    If lcolCampos.Count > 10 Then
        lcolCampos("TxtNroIdCompra").solicitar_datos = "S"
    End If

End Sub

Private Sub TxtNroIdCompra_GotFocus()
    
    If Trim(TxtNroIdCompra.text) = "" Then
        TxtNroIdCompra.text = ""
    End If
    
    If Not gbolESC And lcolCampos.Count > 10 Then
        If lcolCampos("TxtNroIdCompra").solicitar_datos = "N" And Not lbolPide_Dato_Manual Then
            Sendkeys "{ENTER}"
            Exit Sub
        End If
    End If
    
    stbAyuda.Panels(1).text = "Ingrese el Número de Orden de Compra"
    Call Color_Control_Seleccionado(Me, TxtNroIdCompra)
    Call MarcarTexto(TxtNroIdCompra)
       
End Sub

Private Sub TxtNroIdCompra_KeyDown(KeyCode As Integer, Shift As Integer)
    
    gbolESC = False
    
    If KeyCode = vbKeyUp Then
        txtDtoGlobal.SetFocus
    End If
    
    If KeyCode = vbKeyEscape Then
    
        If Trim(UCase(ConfPuntOVta_Controla_Salida_Con_Lineas_Ingresadas_Alta)) = "S" And Trim(UCase(sspOperacion.Caption)) = "A" Then
            If vsfLineas_Mercaderia.Rows > 1 Then
                MsgBox "ATENCION: Tiene lineas ingresadas no se puede reiniciar la operacion hasta que no de Guardar", vbCritical, MsgTit
                Exit Sub
            End If
        End If

        If Not lbolCerrar_Documento_Sin_Preguntar Then
            If MsgBox("Desea Salir del Documento?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                gbolESC = True
                Call Habilitar_Deshabilitar_Controles(Me, False)
                DoEvents
            End If
        Else
            Unload Me
        End If
    End If
    
    If KeyCode = vbKeyReturn Then
        If txtTarea_Codigo_Documento.visible And txtTarea_Codigo_Documento.Enabled Then  'agrega if por visible  SS 20180321
            txtTarea_Codigo_Documento.SetFocus
        Else
            ' AIR 20250428
            If txtAcopio.visible And txtAcopio.Enabled Then
                txtAcopio.SetFocus
            Else
                txtObs.SetFocus
            End If
            
            DoEvents
        End If
    End If

    If KeyCode = vbKeyF4 Then
        If ConfPuntoVta_Utilizar_Autorizacion = "S" Then
            If lcolCampos("TxtNroIdCompra").pide_autorizacion = "S" Then
                If Autorizacion_Supervision(4, 2, txtEmpresa.text, txtCodDoc.text, txtDoc.text, txtCodProv.text) Then
                    TxtNroIdCompra.Locked = False
                End If
            'ATU 2070505 se agrega manejo avanzado para que si usa autorizacion y no tiene la configuracion de pedirla no obligue
            'intervenir al supervisor
            Else
                TxtNroIdCompra.Locked = False
            End If
        End If
    End If

End Sub

Sub Inicializo_Grilla_Vales()
Dim i As Integer


    Screen.MousePointer = vbHourglass
                                                  
    vsfVales.Rows = 1
    vsfVales.Rows = vsfVales.FixedRows
    vsfVales.FixedAlignment(-1) = flexAlignCenterCenter
    vsfVales.Cols = CGVA_SALDO + 1
    vsfVales.FixedCols = 1
    vsfVales.ColWidth(0) = 0
    
    vsfVales.ColAlignment(CGVA_CODDOC) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_CODDOC) = "Doc."
    vsfVales.ColDataType(CGVA_CODDOC) = flexDTLong
    vsfVales.ColWidth(CGVA_CODDOC) = 800
      
    vsfVales.ColAlignment(CGVA_NRODOC) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_NRODOC) = "Número"
    vsfVales.ColDataType(CGVA_NRODOC) = flexDTLong
    vsfVales.ColWidth(CGVA_NRODOC) = 1500
  
    vsfVales.ColAlignment(CGVA_CODPROV) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_CODPROV) = "Cliente"
    vsfVales.ColDataType(CGVA_CODPROV) = flexDTLong
    vsfVales.ColWidth(CGVA_CODPROV) = 900
    
    vsfVales.ColAlignment(CGVA_DOCID) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_DOCID) = "Doc.Id."
    vsfVales.ColDataType(CGVA_DOCID) = flexDTLong
    vsfVales.ColWidth(CGVA_DOCID) = 1000
    
    vsfVales.ColAlignment(CGVA_MONEDA) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_MONEDA) = "Mon."
    vsfVales.ColDataType(CGVA_MONEDA) = flexDTLong
    vsfVales.ColWidth(CGVA_MONEDA) = 400
    
    vsfVales.ColAlignment(CGVA_SIMBOLO) = flexAlignCenterBottom
    vsfVales.TextMatrix(0, CGVA_SIMBOLO) = ""
    vsfVales.ColDataType(CGVA_SIMBOLO) = flexDTString
    vsfVales.ColWidth(CGVA_SIMBOLO) = 600
    
    vsfVales.ColAlignment(CGVA_IMPORTE) = flexAlignRightBottom
    vsfVales.TextMatrix(0, CGVA_IMPORTE) = "Importe"
    vsfVales.ColDataType(CGVA_IMPORTE) = flexDTDouble
    vsfVales.ColWidth(CGVA_IMPORTE) = 1500

    vsfVales.ColHidden(CGVA_SALDO) = True
    vsfVales.ColHidden(CGVA_FEC_VENC) = True
    
    vsfVales.Rows = vsfVales.Rows + 1
            
    Screen.MousePointer = vbDefault
    
    
End Sub

Private Sub vsfVales_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
    
    Call Calculo_Importe_Grilla_x_Moneda(vsfVales, CGVA_IMPORTE, "V")
   
    
End Sub

Private Sub vsfVales_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
    vsfVales.Cell(flexcpFontBold, OldRow, OldCol, OldRow, OldCol) = False
    vsfVales.Cell(flexcpFontBold, NewRow, NewCol, NewRow, NewCol) = True
End Sub

Private Sub vsfVales_EnterCell()

    If vsfVales.Col = CGVA_IMPORTE Or _
        vsfVales.Col = CGVA_CODDOC Or _
        vsfVales.Col = CGVA_NRODOC Or _
        vsfVales.Col = CGVA_CODPROV _
        Then
        vsfVales.AutoSearch = flexSearchNone
        vsfVales.Editable = flexEDKbdMouse
    Else
        vsfVales.AutoSearch = flexSearchFromTop
        vsfVales.Editable = flexEDNone
    End If

End Sub

Private Sub vsfVales_GotFocus()
    stbAyuda.Panels(1).text = "Ingrese el Detalle del Vale / F12 - Finaliza "
End Sub

Private Sub vsfVales_KeyDown(KeyCode As Integer, Shift As Integer)
Dim R As Recordset

    gbolESC = False
    
    If KeyCode = vbKeyF12 Or KeyCode = vbKeyEnd Then
        sstDetalle_Pagos.Tab = 0
        vsfMedios_Pagos.SetFocus
        
        Select Case Trim(UCase(ConfPuntoVta_Grilla_MPago_Foco))
             Case "DESCRIPCION"
                 vsfMedios_Pagos.Col = CGMP_DESCRIPCION
             Case Else
                 vsfMedios_Pagos.Col = CGMP_IMPORTE
         End Select
        
        vsfMedios_Pagos.Row = 1
    End If
    If KeyCode = vbKeyEsc Then
        vsfVales.SetFocus
    End If
    
    If KeyCode = vbKeyF1 Then
        Select Case vsfVales.Col
            Case CGVA_CODDOC
                GForm = Me.Name
                GCampoBusqueda = "GRILLA_VALES"
                whereSelCamG = ""
                GTipoBusc = "Documentos"
                GNro_Fila = vsfVales.Row
                gbolESC = True
                frmBusquedas.Show 1
        End Select
    End If
    
    If KeyCode = vbKeyDelete Then
        If vsfVales.Row > 0 Then
            If MsgBox("Confirma la Eliminacion de los Vales?", vbYesNo + vbDefaultButton2 + vbInformation, MsgTit) = vbYes Then
                vsfVales.RemoveItem (vsfVales.Row)
            End If
        End If
    End If

End Sub

Private Sub vsfVales_LostFocus()
    Call Calculo_Importe_Grilla_x_Moneda(vsfVales, CGVA_IMPORTE, "V")
End Sub

Private Sub vsfVales_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
On Error GoTo Errores
Dim R As Recordset
Dim M As Recordset
Dim lstrFecha As String

    Select Case Col

        Case CGVA_CODDOC
            If Trim(vsfVales.EditText) = "" Then
                Cancel = False
            Else
                If Not IsNumeric(vsfVales.EditText) Then
                    MsgBox "El Código del Documento debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                Else
                    If Not Busco_Tipo_Documento(vsfVales.EditText, gTipo_Documento) Then
                        MsgBox "Tipo Documento Inexistente", vbCritical, MsgTit
                        Cancel = True
                    Else
                        vsfVales.Select Row, CGVA_NRODOC
                        Cancel = False
                    End If
                End If

            End If
        
        Case CGVA_NRODOC
            If Trim(vsfVales.EditText) = "" Then
                Cancel = False
            Else
                If Not IsNumeric(vsfVales.EditText) Then
                    MsgBox "El Nro. Documento debe ser un Número Válido", vbCritical, MsgTit
                    Cancel = True
                Else
                    ldblSaldo_Vale = 0
                    If Not Buscar_Vale(val(txtEmpresa.text), val(vsfVales.TextMatrix(Row, CGVA_CODDOC)), val(vsfVales.EditText), R) Then
                        MsgBox "Vale Inexistente", vbCritical, MsgTit
                        Cancel = True
                    Else
                        vsfVales.TextMatrix(Row, CGVA_CODPROV) = R!Cod_Prov
                        vsfVales.TextMatrix(Row, CGVA_MONEDA) = R!moneda
                        vsfVales.TextMatrix(Row, CGVA_DOCID) = NullToZero(R!doc_identidad)
                        vsfVales.TextMatrix(Row, CGVA_IMPORTE) = NullToZero(R!saldo)
                        vsfVales.TextMatrix(Row, CGVA_SALDO) = NullToZero(R!saldo)
                        vsfVales.TextMatrix(Row, CGVA_FEC_VENC) = NullToZero(R!fec_venc)
                        
                        vsfVales.TextMatrix(Row, CGVA_SIMBOLO) = ""
                        If Buscar_Moneda(val(vsfVales.TextMatrix(Row, CGVA_MONEDA)), M) Then
                            vsfVales.TextMatrix(Row, CGVA_SIMBOLO) = Trim(M!simbolo)
                        End If
                        
                        If R!fec_venc < CDate(txtFec_Doc.text) Then
                            MsgBox "El Vale indicado Venció el :" & R!fec_venc & " Verifique.", vbCritical, MsgTit
                            Cancel = True
                        Else
                            If CDbl(vsfVales.TextMatrix(Row, CGVA_SALDO)) = 0 Then
                                MsgBox "El Vale indicado no tiene Saldo Disponible. Verifique. ", vbInformation, MsgTit
                            End If
                            Cancel = False
                            vsfVales.Select Row, CGVA_IMPORTE
                        End If
                    End If
                End If
            End If


        Case CGVA_MONEDA

            If Not IsNumeric(vsfVales.EditText) Then
                MsgBox "El Código de la Moneda debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                If Not Buscar_Moneda(vsfVales.EditText, M) Then
                    MsgBox "Moneda Inexistente", vbCritical, MsgTit
                    Cancel = True
                Else
                    vsfVales.TextMatrix(Row, CGVA_SIMBOLO) = Trim(M!simbolo)
                    vsfVales.Select Row, CGVA_IMPORTE
                End If
            End If

        Case CGVA_IMPORTE
        
            If Not IsNumeric(vsfVales.EditText) Then
                MsgBox "El Importe del Vale debe ser un Número Válido", vbCritical, MsgTit
                Cancel = True
            Else
                If CDbl(vsfVales.TextMatrix(Row, CGVA_SALDO)) < CDbl(vsfVales.EditText) Then
                    MsgBox "El Monto ingresado supera el Saldo Disponible del Vale. Verifique...: " & vsfVales.TextMatrix(Row, CGVA_SALDO), vbInformation, MsgTit
                    vsfVales.EditText = vsfVales.TextMatrix(Row, CGVA_SALDO)
                End If
                If val(vsfVales.EditText) <> 0 And ( _
                    (vsfVales.TextMatrix(Row, CGVA_CODDOC)) = "" Or _
                    (vsfVales.TextMatrix(Row, CGVA_NRODOC)) = "" Or _
                    (vsfVales.EditText) = "") Then

                    MsgBox "Faltan ingresar datos del Vale ", vbCritical, MsgTit
                    Cancel = True
                Else
                    If vsfVales.Rows = vsfVales.Row + 1 Then
                        vsfVales.Rows = vsfVales.Rows + 1
                        vsfVales.Row = vsfVales.Row + 1
                    Else
                        vsfVales.Row = vsfVales.Row + 1
                    End If
                End If
                vsfVales.Select vsfVales.Row, CGVA_CODDOC
            End If
            
    End Select
    
Exit Sub

Errores:

    MsgBox "Ha ocurrido un error, Verifique", vbInformation, MsgTit
    Exit Sub

End Sub

Private Function Calculo_Importe_Grilla_x_Moneda(lGrilla As VSFlexGrid, lColumna As Long, PstrTipo_MPago As String) As Double
Dim ldblImporte As Double
Dim i As Integer
Dim j As Integer
Dim larrVale(5, 1) As Double
Dim lblnexiste As Boolean
Dim llngFila As Long
Dim llngCol As Long

On Error GoTo Errores

    ldblImporte = 0
    lblnexiste = False
    
    Calculo_Importe_Total_Grilla = 0
    llngFila = lGrilla.Row
    llngCol = lGrilla.Col
    
    For i = 1 To lGrilla.Rows - 1
        If lGrilla.TextMatrix(i, CGVA_MONEDA) <> "" And lGrilla.TextMatrix(i, lColumna) <> "" Then
            larrVale(val(lGrilla.TextMatrix(i, CGVA_MONEDA)), 1) = larrVale(val(lGrilla.TextMatrix(i, CGVA_MONEDA)), 1) + CDbl(lGrilla.TextMatrix(i, lColumna))
        Else
            larrVale(val(lGrilla.TextMatrix(i, CGVA_MONEDA)), 1) = ldblImporte
        End If
    Next i
        
    ' recorro array para cargar en el medio de pago el total de los vales
    
    For i = 1 To 5
        lblnexiste = False
        For j = 1 To vsfMedios_Pagos.Rows - 1
            If val(vsfMedios_Pagos.TextMatrix(j, CGMP_MONEDA)) = i And Trim(vsfMedios_Pagos.TextMatrix(j, CGMP_TIPO_MPAGO)) = Trim(PstrTipo_MPago) Then
            
                If val(txtMoneda.text) <> gMoneda_Base Then     'Cambio formato segun configuracion SS 20180411
                    vsfMedios_Pagos.TextMatrix(j, CGMP_IMPORTE) = Format(larrVale(i, 1), f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Otras_Monedas_Decimales))
                Else
                    vsfMedios_Pagos.TextMatrix(j, CGMP_IMPORTE) = Format(larrVale(i, 1), f_Mascara_Decimales_para_Format(ConfPuntoVta_Importe_Pesos_Decimales))
                End If
                lblnexiste = True
                        
            End If
        Next j
        
        If lblnexiste = False And larrVale(i, 1) <> 0 Then
            MsgBox "No se encontro el Medio de Pago para la Moneda " & str(i) & ", correspondiente a la Grilla. Verifique... ", vbExclamation, MsgTit
        End If
    Next i
    
    lGrilla.Select llngFila, llngCol
    
    Call Calculo_Total_Medios_Pago(True)
Exit Function

Errores:
    MsgBox "No fue posible asignar el importe a el Medio de Pago correspondiente . Verifique... ", vbExclamation, MsgTit
End Function

Public Function Alta_Vales_Ingresados() As Boolean
Dim lstrSQL As String
Dim i As Long
Dim D As Recordset

On Error GoTo Errores

    Alta_Vales_Ingresados = True

    If Not Buscar_Tipo_Documento(val(txtCodDoc.text), D) Then
        Alta_Vales_Ingresados = False
        Exit Function
    End If

    For i = 1 To vsfVales.Rows - 1
    
        If Trim(vsfVales.TextMatrix(i, CGVA_IMPORTE)) <> "" Then
    
           lstrSQL = "INSERT INTO Faccmp_Vales "
           lstrSQL = Trim(lstrSQL) & " (cod_emp,cod_doc,nro_doc,cod_prov,cod_doca,nro_doca,cod_prova,"
           lstrSQL = Trim(lstrSQL) & " moneda,importe,tipo_doc_identidad,doc_identidad,fec_venc)"
           lstrSQL = Trim(lstrSQL) & " VALUES ("
           lstrSQL = Trim(lstrSQL) & val(txtEmpresa.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtCodDoc.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtDoc.text) & ","
           lstrSQL = Trim(lstrSQL) & val(txtCodProv.text) & ","
           lstrSQL = Trim(lstrSQL) & val(vsfVales.TextMatrix(i, CGVA_CODDOC)) & ","
           lstrSQL = Trim(lstrSQL) & val(vsfVales.TextMatrix(i, CGVA_NRODOC)) & ","
           lstrSQL = Trim(lstrSQL) & val(vsfVales.TextMatrix(i, CGVA_CODPROV)) & ","
           lstrSQL = Trim(lstrSQL) & val(vsfVales.TextMatrix(i, CGVA_MONEDA)) & ","
           lstrSQL = Trim(lstrSQL) & CDbl(vsfVales.TextMatrix(i, CGVA_IMPORTE) * D!signo) & ","
           lstrSQL = Trim(lstrSQL) & val(txtTipo_Doc_Identidad) & ",'"
           lstrSQL = Trim(lstrSQL) & vsfVales.TextMatrix(i, CGVA_DOCID) & "',"
           lstrSQL = Trim(lstrSQL) & f_Fecha_Base(CDate(vsfVales.TextMatrix(i, CGVA_FEC_VENC)), Conf_Motor_Base) & ")"
            
           Dbs.Execute lstrSQL
        End If
    Next i

Exit Function

Errores:
    Call FErrores
    Alta_Vales_Ingresados = False

End Function


Sub Cargo_Coleccion_Series(plngCod_Emp As Long, plngCod_Doc As Long, plngNro_Doc As Long, plngCod_Prov As Long)
Dim SQL As String
Dim lrstLineas_Series As Recordset
Dim lstrClave_Colecccion_Series As String

    SQL = "SELECT * FROM FaccmpLineas_Series"
    SQL = SQL & " WHERE cod_emp = " & plngCod_Emp
    SQL = SQL & " AND cod_doc = " & plngCod_Doc
    SQL = SQL & " AND nro_doc = " & plngNro_Doc
    SQL = SQL & " AND cod_prov = " & plngCod_Prov

    Set lrstLineas_Series = Dbs.OpenRecordset(SQL, dbOpenSnapshot)
            
    Do While Not lrstLineas_Series.EOF
    
        lstrClave_Colecccion_Series = Trim(str(lrstLineas_Series!nro_linea)) & "-" & Trim(str(lrstLineas_Series!Cod_Prod)) & "-" & Trim(lrstLineas_Series!serie)
        gcolSeries_Articulos.Add lrstLineas_Series!nro_linea, lrstLineas_Series!Cod_Prod, Trim(lrstLineas_Series!serie), Trim(lrstLineas_Series!serie_sin_control_compra), Trim(lstrClave_Colecccion_Series)
        lrstLineas_Series.MoveNext
    
    Loop

End Sub


Sub Inicializo_Grilla_Series_Articulos()
    
    Screen.MousePointer = vbHourglass
                                                  
    vsfSeries_Articulos.Rows = 1
    vsfSeries_Articulos.Rows = vsfSeries_Articulos.FixedRows

    vsfSeries_Articulos.Cols = CGSA_SERIE_SIN_CONTROL_COMPRA + 1
    vsfSeries_Articulos.FixedCols = 1
    vsfSeries_Articulos.ColWidth(0) = 0
    
    vsfSeries_Articulos.TextMatrix(0, CGSA_CODIGO_PROD) = "Código"
    vsfSeries_Articulos.ColAlignment(CGSA_CODIGO_PROD) = flexAlignCenterBottom
    vsfSeries_Articulos.ColDataType(CGSA_CODIGO_PROD) = flexDTLong
    vsfSeries_Articulos.ColWidth(CGSA_CODIGO_PROD) = 1500
    
    vsfSeries_Articulos.TextMatrix(0, CGSA_CODIGO_PROD_ANTERIOR) = "Código Anterior"
    vsfSeries_Articulos.ColAlignment(CGSA_CODIGO_PROD_ANTERIOR) = flexAlignCenterBottom
    vsfSeries_Articulos.ColDataType(CGSA_CODIGO_PROD_ANTERIOR) = flexDTString
    vsfSeries_Articulos.ColWidth(CGSA_CODIGO_PROD_ANTERIOR) = 2000
    
    vsfSeries_Articulos.TextMatrix(0, CGSA_DESCRIPCION) = "Descripción"
    vsfSeries_Articulos.ColAlignment(CGSA_DESCRIPCION) = flexAlignLeftBottom
    vsfSeries_Articulos.ColDataType(CGSA_DESCRIPCION) = flexDTString
    vsfSeries_Articulos.ColWidth(CGSA_DESCRIPCION) = 5300
    
    vsfSeries_Articulos.TextMatrix(0, CGSA_SERIE) = "Serie"
    vsfSeries_Articulos.ColAlignment(CGSA_SERIE) = flexAlignCenterBottom
    vsfSeries_Articulos.ColDataType(CGSA_SERIE) = flexDTString
    vsfSeries_Articulos.ColWidth(CGSA_SERIE) = 3000
    
    vsfSeries_Articulos.TextMatrix(0, CGSA_SERIE_SIN_CONTROL_COMPRA) = "Sin Control Compra"
    vsfSeries_Articulos.ColAlignment(CGSA_SERIE_SIN_CONTROL_COMPRA) = flexAlignCenterBottom
    vsfSeries_Articulos.ColDataType(CGSA_SERIE_SIN_CONTROL_COMPRA) = flexDTString
    vsfSeries_Articulos.ColWidth(CGSA_SERIE_SIN_CONTROL_COMPRA) = 1500
    
    Screen.MousePointer = vbDefault
    
End Sub


Public Sub Pido_Serie_x_Articulo(plngCod_Prod As Long, plngNro_Linea As Long, pstrIngreso_Obligatorio As String)
Dim P As Recordset

    If plngCod_Prod <> 0 And val(vsfLineas_Mercaderia.TextMatrix(plngNro_Linea, CGL_UNIDADES)) <> 0 Then
    
        If Buscar_Articulo(plngCod_Prod, P) Then
    
            If Trim(UCase(pstrIngreso_Obligatorio)) <> "S" Then
                
                If Articulo_Con_Series_en_Stock(val(txtEmpresa.text), plngCod_Prod) Then
        
                    frmPunto_Venta_Seleccion_Series.plngCod_Emp = val(txtEmpresa.text)
                    frmPunto_Venta_Seleccion_Series.plngCod_Doc = val(txtCodDoc.text)
                    frmPunto_Venta_Seleccion_Series.plngNro_Doc = val(txtDoc.text)
                    frmPunto_Venta_Seleccion_Series.plngCod_Prov = val(txtCodProv.text)
                    frmPunto_Venta_Seleccion_Series.plngNro_Linea = val(vsfLineas_Mercaderia.TextMatrix(plngNro_Linea, CGL_NRO_LINEA))
                    frmPunto_Venta_Seleccion_Series.plngCod_Prod = plngCod_Prod
                    frmPunto_Venta_Seleccion_Series.plngUnidades = val(vsfLineas_Mercaderia.TextMatrix(plngNro_Linea, CGL_UNIDADES))
                    frmPunto_Venta_Seleccion_Series.pstrOperacion = Trim(UCase(sspOperacion.Caption))
                    
                    Set frmPunto_Venta_Seleccion_Series.pcolSeries_Articulos = gcolSeries_Articulos
                    
                    frmPunto_Venta_Seleccion_Series.Show vbModal
                    
                    Call Cargo_Grilla_Series
                
                End If
            Else
                frmPunto_Venta_Seleccion_Series.plngCod_Emp = val(txtEmpresa.text)
                frmPunto_Venta_Seleccion_Series.plngCod_Doc = val(txtCodDoc.text)
                frmPunto_Venta_Seleccion_Series.plngNro_Doc = val(txtDoc.text)
                frmPunto_Venta_Seleccion_Series.plngCod_Prov = val(txtCodProv.text)
                frmPunto_Venta_Seleccion_Series.plngNro_Linea = val(vsfLineas_Mercaderia.TextMatrix(plngNro_Linea, CGL_NRO_LINEA))
                frmPunto_Venta_Seleccion_Series.plngCod_Prod = plngCod_Prod
                frmPunto_Venta_Seleccion_Series.plngUnidades = val(vsfLineas_Mercaderia.TextMatrix(plngNro_Linea, CGL_UNIDADES))
                frmPunto_Venta_Seleccion_Series.pstrOperacion = Trim(UCase(sspOperacion.Caption))
                
                Set frmPunto_Venta_Seleccion_Series.pcolSeries_Articulos = gcolSeries_Articulos
                
                frmPunto_Venta_Seleccion_Series.Show vbModal
                
                Call Cargo_Grilla_Series
            End If
        Else
            MsgBox "ERROR: Debe ingresar primero un Código de Artículo Válido", vbCritical
        End If
    Else
        MsgBox "ERROR: Debe ingresar primero un Código de Artículo Válido", vbCritical
    End If

End Sub



Function Listar_Pedidos_Formato_Matriz(pstrTitulo As String)

On Error GoTo Errores
    
Dim lrstEmpresa As Recordset
Dim lParametro As String
Dim llngCodListaPrecioDefecto As Long
    
    ' Seteo los Campos para los Filtros
    
    Call Limpio_Vectores_Filtros_Orden
    
    gfiltros_nombre_campo(1) = "Empresa"
    gfiltros_nombre_campo(2) = "Documento"
    gfiltros_nombre_campo(3) = "Número"
    gfiltros_nombre_campo(4) = "Cliente"
    gfiltros_nombre_campo(5) = "Fecha Documento"
    gfiltros_nombre_campo(6) = "Fecha Valor"
    gfiltros_nombre_campo(7) = "Validos"
    gfiltros_nombre_campo(8) = "Moneda"
    gfiltros_nombre_campo(9) = "Fecha Registro"
    gfiltros_nombre_campo(10) = "Usuario"
    gfiltros_nombre_campo(11) = "Observacion"
    
    gfiltros_campo(1) = "Faccmp.cod_emp"
    gfiltros_campo(2) = "Faccmp.cod_doc"
    gfiltros_campo(3) = "Faccmp.nro_doc"
    gfiltros_campo(4) = "Faccmp.cod_prov"
    gfiltros_campo(5) = "Faccmp.fec_doc"
    gfiltros_campo(6) = "Faccmp.fec_valor"
    gfiltros_campo(7) = "Faccmp.autorizado"
    gfiltros_campo(8) = "Faccmp.moneda"
    gfiltros_campo(9) = "Faccmp.fec_reg"
    gfiltros_campo(10) = "Faccmp.usuario"
    gfiltros_campo(11) = "Faccmp.observa"
            
    gfiltros_tipo_campo(1) = "N"
    gfiltros_tipo_campo(2) = "N"
    gfiltros_tipo_campo(3) = "N"
    gfiltros_tipo_campo(4) = "N"
    gfiltros_tipo_campo(5) = "F"
    gfiltros_tipo_campo(6) = "F"
    gfiltros_tipo_campo(7) = "C"
    gfiltros_tipo_campo(8) = "N"
    
    gfiltros_tipo_campo(9) = "F"
    gfiltros_tipo_campo(10) = "N"
    gfiltros_tipo_campo(11) = "C"
    
    frmFiltros_de_campos_para_Listar.pstrTitulo = pstrTitulo
    frmFiltros_de_campos_para_Listar.Show (1)
    
    lstrFiltros = frmFiltros_de_campos_para_Listar.pstrFiltros
    lstrDescripcion_Filtros = frmFiltros_de_campos_para_Listar.pstrDescripcion_Filtros
    lbolCancelar_Listado = frmFiltros_de_campos_para_Listar.pbolCancelar_Listado
    
    DoEvents
    
    If lbolCancelar_Listado Then
        Exit Function
    End If
    
    
    If pbolagrupado Then
        ' Seteo los Defectos del Orden a Listar
        gelejir_orden_descripcion(1) = "Empresa"
        gelejir_orden_descripcion(2) = "Moneda"
        gelejir_orden_descripcion(3) = "Documento"
        gelejir_orden_descripcion(4) = "Número"
        gelejir_orden_descripcion(5) = "Cliente"
        gelejir_orden_descripcion(6) = "Fecha Documento"
    
        gelejir_orden_campo(1) = "faccmp.cod_emp"
        gelejir_orden_campo(2) = "faccmp.moneda"
        gelejir_orden_campo(3) = "faccmp.cod_doc"
        gelejir_orden_campo(4) = "faccmp.nro_doc"
        gelejir_orden_campo(5) = "faccmp.cod_prov"
        gelejir_orden_campo(6) = "faccmp.fec_doc"
                
        gelejir_orden_orden(2) = 1
        gelejir_orden_tipo(2) = "A"
    
        frmElejir_Orden_para_Listar.Show (1)
        lbolCancelar_Listado = frmElejir_Orden_para_Listar.pbolCancelar_Listado
    
        DoEvents
            
        If lbolCancelar_Listado Then
            Exit Function
        End If
    End If
    
'    If Elejir_Tipo_Moneda_del_Reporte("O") Then
'        Exit Function
'    End If
    
    
'COMIENZA EL LISTADO
'**********************

    Call f_esperar(2)
    
    If Buscar_Empresa(gCodigo_Empresa, lrstEmpresa) Then
        llngCodListaPrecioDefecto = lrstEmpresa!nro_lista
        
    End If
    
    ReDim ListaFormatoImpresion(1)
    ListaFormatoImpresion(0) = "Informe Pedidos_x_Cliente_Familia"
    ListaFormatoImpresion(1) = "Informe Pedidos_x_Cliente_Familia para Excel "
    
    
    
     FrmSalidaImpresion.Show vbModal
    
    If FormatoImpresionSeleccionado < 0 Then
        Exit Function
    End If
    
    
    
    
    
    If FormatoImpresionSeleccionado = 0 Then
        CrystalReport1.sqlQuery = " SELECT "
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Precio_Vta.precio_vta, FaccmpLineas.nro_doc, FaccmpLineas.cod_prov, FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.descuento1, FaccmpLineas.descuento2, FaccmpLineas.cajas, FaccmpLineas.descuento3,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_Familia, productos.codigo_SB_Familia,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Faccmp.cod_emp, Faccmp.cod_doc, Faccmp.nro_doc, Faccmp.cod_prov, Faccmp.fec_doc, Faccmp.importe, Faccmp.dto_global,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " clientes.rsocial_cli,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Empresas.descripcion,  Empresas.nro_lista,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ma_Familias.descripcion,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ma_colores.ref_color, ma_colores.descripcion,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ma_SB_Familias.descripcion, ma_talles.descripcion,productos.codigo_talle"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " From"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " ( ((((((((( FaccmpLineas FaccmpLineas INNER JOIN Faccmp Faccmp ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_emp = Faccmp.cod_emp AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_doc = Faccmp.cod_doc AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.nro_doc = Faccmp.nro_doc AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_prov = Faccmp.cod_prov AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.forma_pago = Faccmp.forma_pago AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.seccion = Faccmp.seccion AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.moneda = Faccmp.moneda AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.tipo_cambio = Faccmp.tipo_cambio)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN clientes clientes ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_prov = clientes.nro_cli)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN Empresas Empresas ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Faccmp.cod_emp = Empresas.codigo)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN productos productos ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_prod = productos.cod_prod)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_colores ma_colores ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_color = ma_colores.codigo_color)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_Familias ma_Familias ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_SP_Familia = ma_Familias.codigo_SP_Familia AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_Familia = ma_Familias.codigo_Familia)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " INNER JOIN ma_talles ma_talles ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_talle = ma_talles.codigo_talle)"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN ma_SB_Familias ma_SB_Familias ON"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia )"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN listas_precios listas_precios on faccmp.nro_rollo = listas_precios.codigo AND"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " listas_precios.tipo_lista = 'V')"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN vista_IVA on vista_IVA.cod_impuesto = cast(FaccmpLineas.nom_prod_aux as int))"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " LEFT OUTER JOIN  Precio_Vta Precio_Vta On Precio_Vta.cod_prod = FaccmpLineas.cod_prod  "
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND precio_vta.nro_lista = Empresas.nro_lista "   ' & llngCodListaPrecioDefecto & " AND faccmp.fec_doc >= " 'lrstEmpresa!nro_lista
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND faccmp.fec_doc >= (SELECT MAX(Precio_Vta.fec_vig) FROM Precio_Vta WHERE precio_vta.nro_lista =  Empresas.nro_lista " '& llngCodListaPrecioDefecto
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " AND FaccmpLineas.cod_prod = Precio_Vta.cod_prod )"
    
        If Trim(lstrFiltros) <> "" Then
           CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Where " & Trim(lstrFiltros)
        End If
    
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " Order By"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_emp ASC,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_doc ASC,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.cod_prov ASC,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " FaccmpLineas.nro_doc ASC,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_Familia Asc,"
        CrystalReport1.sqlQuery = CrystalReport1.sqlQuery & " productos.codigo_SB_Familia Asc"
    Else
        lstrNombre_Tabla_Temporal = f_Nombre_Tabla_Temporal
        Call Borra_Tabla_Temporal(lstrNombre_Tabla_Temporal)
        
        If Trim(lstrFiltros) = "" Then
           lstrFiltros = "1=1"
        End If
        
        
        lstrSQL = " SELECT "
        lstrSQL = lstrSQL & " Precio_Vta.precio_vta,FaccmpLineas.cant_prod, FaccmpLineas.precio, FaccmpLineas.descuento1,FaccmpLineas.descuento2, FaccmpLineas.cajas,"
        lstrSQL = lstrSQL & "  FaccmpLineas.descuento3,productos.codigo_Familia, productos.codigo_SB_Familia,Faccmp.cod_emp, Faccmp.cod_doc,Faccmp.nro_doc, Faccmp.cod_prov,"
        lstrSQL = lstrSQL & " Faccmp.fec_doc, Faccmp.importe, Faccmp.dto_global,clientes.rsocial_cli,Empresas.descripcion,  Empresas.nro_lista,ma_Familias.descripcion familia,"
        lstrSQL = lstrSQL & " ma_colores.ref_color, ma_colores.descripcion color ,ma_SB_Familias.descripcion SB_Familia, ma_talles.descripcion talles,productos.codigo_talle,"
        lstrSQL = lstrSQL & " productos.codigo_color,faccmplineas.cod_prod,cod_impuesto into " & lstrNombre_Tabla_Temporal
        lstrSQL = lstrSQL & " From (((((((((( FaccmpLineas FaccmpLineas INNER JOIN Faccmp Faccmp ON"
        lstrSQL = lstrSQL & " FaccmpLineas.cod_emp = Faccmp.cod_emp AND"
        lstrSQL = lstrSQL & " FaccmpLineas.cod_doc = Faccmp.cod_doc AND"
        lstrSQL = lstrSQL & " FaccmpLineas.nro_doc = Faccmp.nro_doc AND"
        lstrSQL = lstrSQL & " FaccmpLineas.cod_prov = Faccmp.cod_prov AND"
        lstrSQL = lstrSQL & " FaccmpLineas.forma_pago = Faccmp.forma_pago AND"
        lstrSQL = lstrSQL & " FaccmpLineas.seccion = Faccmp.seccion AND"
        lstrSQL = lstrSQL & " FaccmpLineas.moneda = Faccmp.moneda AND"
        lstrSQL = lstrSQL & " FaccmpLineas.tipo_cambio = Faccmp.tipo_cambio)"
        lstrSQL = lstrSQL & " INNER JOIN clientes clientes ON"
        lstrSQL = lstrSQL & " FaccmpLineas.cod_prov = clientes.nro_cli)"
        lstrSQL = lstrSQL & " INNER JOIN Empresas Empresas ON"
        lstrSQL = lstrSQL & " Faccmp.cod_emp = Empresas.codigo)"
        lstrSQL = lstrSQL & " INNER JOIN productos productos ON"
        lstrSQL = lstrSQL & " FaccmpLineas.cod_prod = productos.cod_prod)"
        lstrSQL = lstrSQL & " INNER JOIN ma_colores ma_colores ON"
        lstrSQL = lstrSQL & " productos.codigo_color = ma_colores.codigo_color)"
        lstrSQL = lstrSQL & " INNER JOIN ma_Familias ma_Familias ON"
        lstrSQL = lstrSQL & " productos.codigo_SP_Familia = ma_Familias.codigo_SP_Familia AND"
        lstrSQL = lstrSQL & " productos.codigo_Familia = ma_Familias.codigo_Familia)"
        lstrSQL = lstrSQL & " INNER JOIN ma_talles ma_talles ON"
        lstrSQL = lstrSQL & " productos.codigo_talle = ma_talles.codigo_talle)"
        lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_SB_Familias ma_SB_Familias ON"
        lstrSQL = lstrSQL & " productos.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia )"
        lstrSQL = lstrSQL & " LEFT OUTER JOIN listas_precios listas_precios on faccmp.nro_rollo = listas_precios.codigo AND"
        lstrSQL = lstrSQL & " listas_precios.tipo_lista = 'V')"
        lstrSQL = lstrSQL & " LEFT OUTER JOIN vista_IVA on vista_IVA.cod_impuesto = cast(FaccmpLineas.nom_prod_aux as int))"
        lstrSQL = lstrSQL & " LEFT OUTER JOIN  Precio_Vta Precio_Vta On Precio_Vta.cod_prod = FaccmpLineas.cod_prod  "
        lstrSQL = lstrSQL & " AND precio_vta.nro_lista = Empresas.nro_lista "   ' & llngCodListaPrecioDefecto & " AND faccmp.fec_doc >= " 'lrstEmpresa!nro_lista
        lstrSQL = lstrSQL & " AND faccmp.fec_doc >= (SELECT MAX(Precio_Vta.fec_vig) FROM Precio_Vta WHERE precio_vta.nro_lista =  Empresas.nro_lista " '& llngCodListaPrecioDefecto
        lstrSQL = lstrSQL & " AND FaccmpLineas.cod_prod = Precio_Vta.cod_prod )"
        lstrSQL = lstrSQL & " Where " & Trim(lstrFiltros)
        
        Dbs.Execute lstrSQL
        
        
        lstrSQL = " insert into " & lstrNombre_Tabla_Temporal
        lstrSQL = lstrSQL & " select distinct 0,0,0,0,0,0,0,a.codigo_Familia, a.codigo_SB_Familia,z.cod_emp,z.cod_doc,z.nro_doc,z.cod_prov, z.fec_doc,0, 0,z.rsocial_cli,"
        lstrSQL = lstrSQL & " z.descripcion,z.nro_lista,ma_Familias.descripcion,ma_colores.ref_color, ma_colores.descripcion ,ma_SB_Familias.descripcion ,"
        lstrSQL = lstrSQL & " ma_talles.descripcion talles,a.codigo_talle,a.codigo_color,a.cod_prod,a.cod_iva"
        lstrSQL = lstrSQL & " from productos a inner join " & lstrNombre_Tabla_Temporal & " z on a.codigo_SB_Familia=z.codigo_SB_Familia"
        lstrSQL = lstrSQL & " INNER JOIN ma_colores ma_colores ON a.codigo_color = ma_colores.codigo_color"
        lstrSQL = lstrSQL & " INNER JOIN ma_Familias ma_Familias ON a.codigo_SP_Familia = ma_Familias.codigo_SP_Familia AND a.codigo_Familia = ma_Familias.codigo_Familia"
        lstrSQL = lstrSQL & " INNER JOIN ma_talles ma_talles ON a.codigo_talle = ma_talles.codigo_talle"
        lstrSQL = lstrSQL & " LEFT OUTER JOIN ma_SB_Familias ma_SB_Familias ON a.codigo_SB_Familia = ma_SB_Familias.codigo_SB_Familia"
        lstrSQL = lstrSQL & " where a.codigo_color not in (select codigo_color from " & lstrNombre_Tabla_Temporal & " b where a.codigo_SB_Familia=b.codigo_SB_Familia and a.codigo_color=b.codigo_color and a.codigo_talle=b.codigo_talle)"
        lstrSQL = lstrSQL & " and a.codigo_talle not in (select codigo_talle from " & lstrNombre_Tabla_Temporal & " c where a.codigo_SB_Familia=c.codigo_SB_Familia and a.codigo_color=c.codigo_color and a.codigo_talle=c.codigo_talle)"
        
        Dbs.Execute lstrSQL
        
        CrystalReport1.sqlQuery = "select precio_vta,cant_prod,precio,descuento1,descuento2,cajas,descuento3,codigo_Familia,codigo_SB_Familia,cod_emp" & _
                                  ",cod_doc,nro_doc,cod_prov,fec_doc,importe,dto_global,rsocial_cli,descripcion,nro_lista,familia,ref_color,color,SB_Familia" & _
                                  ",talles,codigo_talle,codigo_color,cod_prod,cod_impuesto From " & Trim(lstrNombre_Tabla_Temporal) & " zt_Informe_Pedidos_x_Cliente_Familia " & _
                                  " ORDER BY cod_prov ASC,nro_doc ASC,codigo_Familia ASC"
        
    End If

    lParametro = "parCodListaPrecioSugerido;" & llngCodListaPrecioDefecto & ";TRUE"
    CrystalReport1.ParameterFields(0) = lParametro
    
    lParametro = "parTitulo;" & "PEDIDO DE CLIENTE" & ";TRUE"
    CrystalReport1.ParameterFields(1) = lParametro
    
    lParametro = "parUsuario;" & gUsuario & ";TRUE"
    CrystalReport1.ParameterFields(2) = lParametro
    
    lParametro = "parOrden;" & gDescripcion_Orden & ";TRUE"
    CrystalReport1.ParameterFields(3) = lParametro
    
    lParametro = "parFiltros;" & lstrDescripcion_Filtros & ";TRUE"
    CrystalReport1.ParameterFields(4) = lParametro
    
    
    If FormatoImpresionSeleccionado = 0 Then
        CrystalReport1.ReportFileName = ConfCamarchReportes & "Informe_Pedidos_x_Cliente_Familia.rpt"
    Else
        CrystalReport1.ReportFileName = ConfCamarchReportes & "Informe_Pedidos_x_Cliente_Familia_Excel.rpt"
    End If
            
    CrystalReport1.PrintFileType = crptExcel50
    CrystalReport1.Destination = crptToWindow
   
   
        
    lresult = CrystalReport1.PrintReport

    Unload frmMensaje_Esperar

Exit Function

Errores:
    Call FErrores
    'Resume
End Function


Sub Total_Unidades()
Dim i As Long
Dim ldblTotal As Double

    txtTotal_Unidades.text = ""
    
    If txtTotal_Unidades.visible Then
    
        ldblTotal = 0
        
        For i = 1 To vsfLineas_Mercaderia.Rows - 1
'            ldblTotal = ldblTotal + Val(vsfLineas_Mercaderia.TextMatrix(i, CGL_CAJAS)) * Val(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES))
'           JE 20190326     /   Se utilizan el campo de unidades que es la cantidad real de unidaes de la linea (el campo caja es solo a efectos ingreso)
            ldblTotal = ldblTotal + val(vsfLineas_Mercaderia.TextMatrix(i, CGL_UNIDADES))
        Next
        
        txtTotal_Unidades.text = "T.U.: " & Format(ldblTotal, "0.00")
        
    End If
    
End Sub


Public Function Alta_Seña(pvsfMedios_Pagos As VSFlexGrid, pindice As Integer) As Boolean
Dim R As Recordset

On Error GoTo Errores

    Alta_Seña = True

    lstrSQL = "SELECT FACCMP.* "
    lstrSQL = lstrSQL & " FROM FACCMP "
    lstrSQL = lstrSQL & " WHERE cod_emp = " & val(txtEmpresa.text)
    lstrSQL = lstrSQL & " AND cod_doc = " & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_CODDOC)
    lstrSQL = lstrSQL & " AND nro_doc = " & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_NRODOC)
    lstrSQL = lstrSQL & " AND cod_prov = " & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_CODPROV)
    
    Set R = Dbs.OpenRecordset(lstrSQL, dbOpenSnapshot)
        
    If Not R.EOF Then
    
        SQL = "INSERT INTO FaccmpPagos (cod_emp,cod_doc,nro_doc,cod_prov,nro_linea,cod_doca,"
        SQL = SQL & "nro_doca,cod_prova,fec_doca,fec_venca,signo,importe,moneda)"
        SQL = SQL & " VALUES(" & val(txtEmpresa.text) & ","                                             ' cod_emp
        
        SQL = SQL & val(txtCodDoc.text) & ","                                                           ' cod_doc
        SQL = SQL & val(txtDoc.text) & ","                                                              ' nro_doc
        SQL = SQL & val(txtCodProv.text) & ","                                                          ' cod_prov
        SQL = SQL & "1" & ","                                                                           ' nro_linea
        SQL = SQL & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_CODDOC) & ","                             ' cod_doca
        SQL = SQL & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_NRODOC) & ","                             ' nro_doca
        SQL = SQL & pvsfMedios_Pagos.TextMatrix(pindice, CGMP_CODPROV) & ","                            ' cod_prova
        SQL = SQL & f_Fecha_Base(R!fec_doc, Conf_Motor_Base) & ","                                      ' fec_doca
        SQL = SQL & f_Fecha_Base(R!fec_venc, Conf_Motor_Base) & ","                                     ' fec_venca
        SQL = SQL & "1" & ","                                                                           ' signo
        SQL = SQL & CDbl(pvsfMedios_Pagos.TextMatrix(pindice, CGMP_IMPORTE)) & ","                      ' importe
        SQL = SQL & CInt(txtMoneda.text) & ")"                                                          ' moneda
        
        Dbs.Execute SQL
    End If
    
Exit Function

Errores:
    Call FErrores
    Alta_Seña = False

End Function

Sub Cargo_Clase_CFE_Adendas_Configurables(ByRef D As Recordset, ByRef lrstClientes As Recordset, ByRef lrstFuncionarios As Recordset, ByRef lrstAgencias As Recordset)

Dim lrstZona As Recordset
Dim lrstContrato As Recordset       'AIR 20221125
Dim lstrAgenciaEnvio As String
Dim llngCod_AgenciaEnvio As Long
Dim ldblSaldo_Estado_CuentaMonBase As Double
Dim ldblSaldo_Estado_CuentaMonRef As Double
Dim lintOrdenAdenda As Integer
Dim lstrFuncionario As String
Dim lstrZonaCliente As String
Dim lstrObsCont As String                   'AIR 20221128
Dim lrstObservacion As Recordset            ' AIR 20240607
Dim llngOrden As Long                       ' AIR 20240607
Dim llngEmpresa As Long
Dim llngCod_Doc As Long
Dim llngNro_Doc As Long
Dim llngTitular As Long


        ' Se cargan las adendas definidas en la configuracion       SS 20180302
        If ConfPuntoVta_Imprime_EFactura_Adenda_Caja > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Caja < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Caja
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Caja
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Caja       " & Trim(txtCaja.text)
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Vendedor > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Vendedor < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Vendedor
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Vendedor
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Vendedor   " & Trim(txtVendedor.text) & " - " & Trim(TxtNomVen.text)
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Hora > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Hora < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Hora
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Hora
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Hora       " & Format(time, "hh:mm:ss")
        End If
            
        If ConfPuntoVta_Imprime_EFactura_Adenda_Dscto_Global > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Dscto_Global < 100 Then
            If val(txtDtoGlobal.text) <> 0 Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Dscto_Global
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Dscto_Global
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = "Descuento Incluido " & Trim(txtDtoGlobal.text) & " %"
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Usuario > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Usuario < 100 Then
            If Busco_Usuario_x_Nombre_Caja(Trim(txtUsuario.text), lrstFuncionarios) Then
                lstrFuncionario = lrstFuncionarios!nombre_iman
            Else
                lstrFuncionario = ""
            End If
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Usuario
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Usuario
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Usuario    " & Trim(txtUsuario.text) '  & " - " & Trim(lstrFuncionario)
        End If
        
        ' AIR 20191008 cambiamos la forma por el medio de pago y agregamos la forma de pago
        If ConfPuntoVta_Imprime_EFactura_Adenda_Medio_Pago > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Medio_Pago < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Medio_Pago
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Medio_Pago
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Medios Pago " & Medios_Pago_x_Documento_Importe(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
        End If
        
        ' AIR 20191008 agregamos la forma de pago
        If ConfPuntoVta_Imprime_EFactura_Adenda_Forma_Pago > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Forma_Pago < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Forma_Pago
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Forma_Pago
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Forma Pago " & Trim(txtDes_Forma_Pago.text)
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Agencia_Envio > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Agencia_Envio < 100 Then     ' SS 20180320
            If lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then 'Documentos no pueden ser resguardo
                If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
                    llngCod_AgenciaEnvio = val(lrstClientes!cod_agencia_envio)
                Else
                    llngCod_AgenciaEnvio = 0
                End If

                lstrAgenciaEnvio = ""
                If llngCod_AgenciaEnvio <> 0 Then
                    If Busco_Agencia_Envio(llngCod_AgenciaEnvio, lrstAgencias) Then
                        lstrAgenciaEnvio = lrstAgencias!nombre_fantasia
                    End If
                End If
                If lstrAgenciaEnvio <> "" Then
                    lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Agencia_Envio
                    lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Agencia_Envio
                    lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                    lCfe.adendas(lintOrdenAdenda).valor = "Agencia    " & Trim(lstrAgenciaEnvio)
                End If
            End If
        End If
            
        If ConfPuntoVta_Imprime_EFactura_Adenda_Horario_Cliente > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Horario_Cliente < 100 Then
            If lstrTipoDoc <> "RESGUARDO" And lstrTipoDoc <> "ANULA RESGUARDO" Then 'Documentos no pueden ser resguardo
                If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
                    lstrHorarioCliente = Trim(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(lrstClientes!horario_cobro))
                Else
                    lstrHorarioCliente = ""
                End If
                If lstrHorarioCliente <> "" Then
                    lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Horario_Cliente
                    lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Horario_Cliente
                    lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                    lCfe.adendas(lintOrdenAdenda).valor = "Horario    " & lstrHorarioCliente
                End If
            End If
        End If
        
        'AIR 20191029 se agrega la impresion del saldo del cliente en la Adenda
        If ConfPuntoVta_Imprime_EFactura_Adenda_Saldo_Cliente > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Saldo_Cliente < 100 And Trim(D!clase) = "CREDITO" Then

            ldblSaldo_Estado_CuentaMonBase = 0
            ldblSaldo_Estado_CuentaMonRef = 0
            
            ldblSaldo_Estado_CuentaMonBase = Saldo_Titular_Estado_Cuenta("C", val(txtEmpresa.text), val(txtCodProv.text), "0", "0", txtFec_Doc.text, "D", 0, "O", gMoneda_Base, "NETO", "")
            ldblSaldo_Estado_CuentaMonRef = Saldo_Titular_Estado_Cuenta("C", val(txtEmpresa.text), val(txtCodProv.text), "0", "0", txtFec_Doc.text, "D", 0, "O", gMoneda_Referencia, "NETO", "")
                     
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Saldo_Cliente
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Saldo_Cliente
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Saldo    $ " & Format(ldblSaldo_Estado_CuentaMonBase, "0.00")
            
            If ldblSaldo_Estado_CuentaMonRef <> 0 Then
                lCfe.adendas(lintOrdenAdenda).valor = lCfe.adendas(lintOrdenAdenda).valor & "  Saldo    U$S " & Format(ldblSaldo_Estado_CuentaMonRef, "0.00")
            End If
        End If
        
        'AIR 20221125 se agrega la impresion de observaciones del contrato en la Adenda
        If Not IsNull(ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Contrato) And val(txtContrato.text) <> 0 Then
            If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Contrato > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Contrato < 100 Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Contrato
                pcfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Contrato
                pcfe.adendas(lintOrdenAdenda).etiqueta = " "
                'ma_Contratos_Servicios
                
                If Busco_Contrato_Servicio(plngCod_Emp, val(DCabezal_Auxiliar!contrato), lrstContrato) Then
                    lstrObsCont = Trim(lrstContrato!observaciones)
                End If
                pcfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(lstrObsCont)))
            End If
        End If
                    
          
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija1_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija1_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija1_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija1_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir)))
            End If
        End If
            
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija2_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija2_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir_continuacion) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija2_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija2_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir_continuacion)))
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija3_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija3_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir_L3) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija3_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija3_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir_L3)))
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija4_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija4_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir_L4) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija4_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija4_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir_L4)))
            End If
        End If
            
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija5_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija5_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir_L5) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija5_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija5_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir_L5)))
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija6_Doc > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija6_Doc < 100 Then
            If Trim(D!observacion_fija_imprimir_L6) <> "" Then
                lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija6_Doc
                lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Obs_Fija6_Doc
                lCfe.adendas(lintOrdenAdenda).etiqueta = " "
                lCfe.adendas(lintOrdenAdenda).valor = Trim(f_Ins_String_Sin_Menor_Mayor(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(D!observacion_fija_imprimir_L6)))
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Docs_Referencia_F10 > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Docs_Referencia_F10 < 100 Then 'SS 20180423
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Docs_Referencia_F10
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Docs_Referencia_F10
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            lCfe.adendas(lintOrdenAdenda).valor = "Docs Ref      " & Docs_Referencia_x_Documento(val(txtEmpresa.text), val(txtCodDoc.text), val(txtDoc.text), val(txtCodProv.text))
        End If
        
        
        
        If Buscar_Cliente(val(txtCodProv.text), lrstClientes) Then
        End If
        
        'AIR 20220627 Se agrega la impresion de la zona del cliente
        If ConfPuntoVta_Imprime_EFactura_Adenda_Zona_Cliente > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Zona_Cliente < 100 Then 'AIR 20220627
            
            lstrZonaCliente = ""
            If Buscar_Zona(lrstClientes!nro_zon, lrstZona) Then
                lstrZonaCliente = Trim(f_Ins_String_Con_TILDE_ENTER_y_LINEFEED(lrstZona!nom_zon))
            
            End If
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Zona_Cliente
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Zona_Cliente
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            If lstrZonaCliente <> "" Then
                lCfe.adendas(lintOrdenAdenda).valor = "Zona          " & lstrZonaCliente
            
            Else
                lCfe.adendas(lintOrdenAdenda).valor = ""
            End If
        End If
        
        If ConfPuntoVta_Imprime_EFactura_Adenda_Nro_Ruteo > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Nro_Ruteo < 100 Then 'JCH 20221110
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Zona_Cliente
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Nro_Ruteo
            lCfe.adendas(lintOrdenAdenda).etiqueta = " "
            If Not IsNull(lrstClientes!orden_entrega) And Trim(lrstClientes!orden_entrega) <> "" Then
                lCfe.adendas(lintOrdenAdenda).valor = "Nro Ruteo  " & Trim(lrstClientes!orden_entrega)
            
            Else
                lCfe.adendas(lintOrdenAdenda).valor = ""
            End If
        End If
        
        'AIR 20230613
        'AIR 20230615
        If ChkLink_pago.Value = Checked And ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago < 100 Then  'AIR 20230608
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago
            lCfe.adendas(lintOrdenAdenda).etiqueta = Trim(ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago_Etiqueta) ' "Plexo"
            lCfe.adendas(lintOrdenAdenda).valor = "ClienteID:" & Trim(ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago_ClientId) & ";" & "ClientSecret:" & Trim(ConfPuntoVta_Imprime_EFactura_Adenda_Link_Pago_ClientSecret)
        End If
        
        ' JE 20240819   /   Adenda para imprimir un codigo de barra del documento a los efectos de poder escanear este codigo y levantar el documento
        If ConfPuntoVta_Imprime_EFactura_Adenda_Codigo_Barra_Documento > 9 And ConfPuntoVta_Imprime_EFactura_Adenda_Codigo_Barra_Documento < 100 Then
            lintOrdenAdenda = ConfPuntoVta_Imprime_EFactura_Adenda_Codigo_Barra_Documento
            lCfe.adendas(lintOrdenAdenda).orden = ConfPuntoVta_Imprime_EFactura_Adenda_Codigo_Barra_Documento
            lCfe.adendas(lintOrdenAdenda).etiqueta = "CODIGOBARRASA"
            
            ' Obtengo cada valor para pasarlo a al parametro del reporte
        
            llngEmpresa = val(txtEmpresa.text)              ' Empresa   2 digitos
            llngCod_Doc = val(txtCodDoc.text)               ' Documento 3 digitos
            llngNro_Doc = val(txtDoc.text)                  ' Numero    8 digitos
            llngTitular = val(txtCodProv.text)              ' Titular   8 digitos
            
            lCfe.adendas(lintOrdenAdenda).valor = Format(ConfVerificar_Articulos_En_Doc_Prefijo_CBarra, "00") & Format(llngEmpresa, "00") & Format(llngCod_Doc, "000") & Format(llngNro_Doc, "00000000") & Format(llngTitular, "00000000")
        End If

End Sub

Sub Borrar_Lineas_Temporal(pstrId As String)
On Error Resume Next

    'AIR 20201113
    If Trim(gstrTabla_Temporal_Lineas_Mercaderia) <> "" And Trim(pstrId) <> "" Then
         lstrSQL = "DELETE FROM " & gstrTabla_Temporal_Lineas_Mercaderia
         lstrSQL = lstrSQL & " WHERE Id = " & CDbl(pstrId)
         lstrSQL = lstrSQL & " AND cod_emp = " & CLng(txtEmpresa.text)
         lstrSQL = lstrSQL & " AND cod_doc = " & CLng(txtCodDoc.text)
         lstrSQL = lstrSQL & " AND nro_doc = " & CLng(txtDoc.text)
         lstrSQL = lstrSQL & " AND cod_prov = " & CLng(txtCodProv.text)
         
         Dbs.Execute lstrSQL
    
     End If

End Sub
